<div id="Misc">
<div class="head">
<h1>Theory Misc</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous Mathematics›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Misc 
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="../../HOL/HOL-Analysis/Multivariate_Analysis.html">HOL-Analysis.Multivariate_Analysis</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:misc}›</span></span>

<span class="keyword1" id="Misc-sum_UNIV"><span class="command">lemma</span></span> sum_UNIV<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> complete<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∉</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> sum <span class="free">f</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> complete <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="free">S</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">f</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">f</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.subset_diff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-cInf_mono"><span class="command">lemma</span></span> cInf_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>conditionally_complete_lattice set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">≤</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">≤</span> Inf <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ne<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> bin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> lower <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ain bounded <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> le
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-max_distrib"><span class="command">lemma</span></span> max_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> max <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> max <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max.absorb1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-mult_div_mono_left"><span class="command">lemma</span></span> mult_div_mono_left<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nzc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nnc inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> inverse <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>mult.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nzc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-mult_div_mono_right"><span class="command">lemma</span></span> mult_div_mono_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nzc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nzc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> inverse <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> "</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnc inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">*</span> inverse <span class="free">c</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>mult.assoc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-min_distrib"><span class="command">lemma</span></span> min_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> min <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> min <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-finite_set_least"><span class="command">lemma</span></span> finite_set_least<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="bound">x'</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> zin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> zmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> ne <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-cSup_add"><span class="command">lemma</span></span> cSup_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">+</span> <span class="free">c</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ne bS <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> Sup <span class="free">S</span> <span class="main">+</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cSup_least add_right_mono cSup_upper bdd_aboveI<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">-</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least ne<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> bS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> xin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_upper<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">-</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">+</span> <span class="free">c</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="free">c</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-cSup_mult"><span class="command">lemma</span></span> cSup_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> Sup <span class="free">S</span> <span class="main">=</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> cnz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bS <span class="keyword1"><span class="command">have</span></span> baS<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_above <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> ne nnc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> Sup <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cSup_least mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cSup_upper<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least ne<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bS nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cSup_upper bdd_aboveI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inverse <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="free">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> cnz <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> Sup <span class="free">S</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="free">c</span> <span class="main">*</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> cnz <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> Sup <span class="free">S</span> <span class="main">≤</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-closure_contains_Sup"><span class="command">lemma</span></span> closure_contains_Sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">∈</span> closure <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?T</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> neS <span class="keyword1"><span class="command">have</span></span> neT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bS <span class="keyword1"><span class="command">have</span></span> bT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?T</span><span class="main">.</span> <span class="main">-</span><span class="free">B</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bbT<span class="main">:</span> <span class="quoted"><span class="quoted">"bdd_below <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">=</span> <span class="main">-</span> Inf <span class="var">?T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> neT bbT
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> Inf <span class="main">(</span>uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span><span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_lower<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="main">-</span><span class="main">1</span> <span class="main">*</span> <span class="main">-</span><span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">*</span> Inf <span class="main">(</span>uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_left_mono_neg<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> lenInf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span> Inf <span class="main">(</span>uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> neS bS <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">≤</span> <span class="main">-</span> Inf <span class="var">?T</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Sup <span class="free">S</span> <span class="main">≤</span> Inf <span class="var">?T</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> neT<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> uminus <span class="main">`</span> <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rwx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> yin bS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> Sup <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">*</span> Sup <span class="free">S</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult_left_mono_neg<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rwx <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Sup <span class="free">S</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="main">1</span> <span class="main">*</span> Inf <span class="var">?T</span> <span class="main">≤</span> <span class="main">-</span><span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">-</span> Sup <span class="free">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult_left_mono_neg<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Inf <span class="var">?T</span> <span class="main">≤</span> Sup <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> neT bbT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="var">?T</span> <span class="main">∈</span> closure <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> closure_contains_Inf<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Inf <span class="var">?T</span> <span class="main">∈</span> uminus <span class="main">`</span> closure <span class="var">?T</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"linear uminus"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>linearI<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> closure <span class="var">?T</span> <span class="main">⊆</span> closure <span class="main">(</span>uminus <span class="main">`</span> <span class="var">?T</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> closure_linear_image_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="var">?T</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"closure <span class="main">(</span>uminus <span class="main">`</span> <span class="var">?T</span><span class="main">)</span> <span class="main">⊆</span> closure <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> closure_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup <span class="free">S</span> <span class="main">∈</span> closure <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-tendsto_min"><span class="command">lemma</span></span> tendsto_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⇢</span> <span class="free">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> tb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⇢</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span><span class="free">a</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span> min <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> LIMSEQ_I<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> pe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> ta pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">noa</span></span> <span class="keyword2"><span class="keyword">where</span></span> balla<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">noa</span><span class="main">.</span> abs <span class="main">(</span><span class="free">a</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>LIMSEQ_D<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> tb pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">nob</span></span> <span class="keyword2"><span class="keyword">where</span></span> ballb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="skolem">nob</span><span class="main">.</span> abs <span class="main">(</span><span class="free">b</span> <span class="bound">n</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>LIMSEQ_D<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"max <span class="skolem">noa</span> <span class="skolem">nob</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> gea<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">noa</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> geb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nob</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> min <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">b</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> rwmin<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="skolem">n</span> <span class="main">≤</span> min <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> gea balla <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> rwmin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">a</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">b</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rwmin<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="skolem">n</span> <span class="main">≤</span> min <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> geb ballb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> rwmin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> min <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="free">y</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> rwmin<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> gea balla <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">a</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> rwmin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> rwmin<span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> geb ballb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">b</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> rwmin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span>min <span class="main">(</span><span class="free">a</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">no</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">no</span><span class="main">.</span> <span class="main">¦</span>min <span class="main">(</span><span class="free">a</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="bound">n</span><span class="main">)</span> <span class="main">-</span> min <span class="free">x</span> <span class="free">y</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> set"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">supp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dist_remove</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dist_remove</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Misc-supp_dist_remove"><span class="command">lemma</span></span> supp_dist_remove<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> supp <span class="main">(</span>dist_remove <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>dist_remove_def supp_def<span class="main">)</span>

<span class="keyword1" id="Misc-supp_empty"><span class="command">lemma</span></span> supp_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="free">f</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>

<span class="keyword1" id="Misc-nsupp_zero"><span class="command">lemma</span></span> nsupp_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> supp <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>

<span class="keyword1" id="Misc-sum_supp"><span class="command">lemma</span></span> sum_supp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>finite <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>supp <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> UNIV"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>UNIV <span class="main">-</span> supp <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="main">(</span>supp <span class="free">f</span><span class="main">)</span> <span class="main">=</span> sum <span class="free">f</span> <span class="main">(</span>UNIV <span class="main">-</span> supp <span class="free">f</span><span class="main">)</span> <span class="main">+</span> sum <span class="free">f</span> <span class="main">(</span>supp <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sum <span class="free">f</span> UNIV"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum.subset_diff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Truncated Subtraction›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:trunc_sub}›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">tminus</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span> real"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊖</span>"</span> 60<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⊖</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> max <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Misc-minus_le_tminus"><span class="command">lemma</span></span> minus_le_tminus<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_cancel_1"><span class="command">lemma</span></span> tminus_cancel_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_zero_imp_le"><span class="command">lemma</span></span> tminus_zero_imp_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊖</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>

<span class="keyword1" id="Misc-tminus_zero"><span class="command">lemma</span></span> tminus_zero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊖</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>

<span class="keyword1" id="Misc-tminus_left_mono"><span class="command">lemma</span></span> tminus_left_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⊖</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">c</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_less"><span class="command">lemma</span></span> tminus_less<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_left_distrib"><span class="command">lemma</span></span> tminus_left_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">⊖</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> max <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max.absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> nna le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> max <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max.absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> max <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>max.absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> nna le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">*</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">b</span> <span class="main">-</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">-</span> <span class="free">a</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max.absorb1 <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-tminus_le"><span class="command">lemma</span></span> tminus_le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">-</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_le_alt"><span class="command">lemma</span></span> tminus_le_alt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>

<span class="keyword1" id="Misc-tminus_nle"><span class="command">lemma</span></span> tminus_nle<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_add_mono"><span class="command">lemma</span></span> tminus_add_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">(</span><span class="free">c</span><span class="main">+</span><span class="free">d</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span><span class="main">⊖</span><span class="free">c</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span><span class="main">⊖</span><span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">-</span> <span class="free">c</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> pac <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> pbd <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> pac <span class="keyword2"><span class="keyword">and</span></span> pbd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> pac <span class="keyword2"><span class="keyword">and</span></span> pbd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> pac <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nac <span class="main">=</span> this
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">-</span> <span class="free">d</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> nac <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">+</span> <span class="free">d</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nbd <span class="main">=</span> this
    <span class="keyword1"><span class="command">with</span></span> nac <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="free">c</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nac <span class="keyword2"><span class="keyword">and</span></span> nbd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-tminus_sum_mono"><span class="command">lemma</span></span> tminus_sum_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">S</span> <span class="main">⊖</span> sum <span class="free">g</span> <span class="free">S</span> <span class="main">≤</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊖</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="free">S</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">S</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fS <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span>
  <span class="keyword3"><span class="command">assume</span></span> fF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xniF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">⊖</span> <span class="free">g</span> <span class="skolem">x</span> <span class="main">+</span> sum <span class="free">g</span> <span class="skolem">F</span> <span class="main">≤</span>
        <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">⊖</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>sum <span class="free">f</span> <span class="skolem">F</span> <span class="main">⊖</span> sum <span class="free">g</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span> <span class="main">⊖</span> <span class="free">g</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊖</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum.insert<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fF xniF<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-tminus_nneg"><span class="command">lemma</span></span> tminus_nneg<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Misc-tminus_right_antimono"><span class="command">lemma</span></span> tminus_right_antimono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> clb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊖</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⊖</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="free">a</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> clb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> clb
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Misc-min_tminus_distrib"><span class="command">lemma</span></span> min_tminus_distrib<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min <span class="free">a</span> <span class="free">b</span> <span class="main">⊖</span> <span class="free">c</span> <span class="main">=</span> min <span class="main">(</span><span class="free">a</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Expectations">
<div class="head">
<h1>Theory Expectations</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Expectations"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Expectations <span class="keyword2"><span class="keyword">imports</span></span> <a href="Misc.html">Misc</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:expectations}›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> expect <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Expectations are a real-valued generalisation of boolean predicates: An expectation on state
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. A predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is embedded as an
expectation by mapping <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 1 and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">False</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 0.  Under this embedding, implication
becomes comparison, as the truth tables demonstrate:
\begin{center}
\begin{tabular}{ccc|ccc}
$a$ &amp; $b$ &amp; $a \rightarrow b$ &amp; $x$ &amp; $y$ &amp; $x \le y$ \\
 F  &amp;  F  &amp;  T                &amp;  0  &amp;  0  &amp;  T \\
 F  &amp;  T  &amp;  T                &amp;  0  &amp;  1  &amp;  T \\
 T  &amp;  F  &amp;  F                &amp;  1  &amp;  0  &amp;  F \\
 T  &amp;  T  &amp;  T                &amp;  1  &amp;  1  &amp;  T
\end{tabular}
\end{center}

\begin{figure}
\begin{center}
\mbox{
\xymatrix{
*++[o][F=]{b} &amp; &amp; *++[o][F=]{c} \\
  &amp; *++[o][F-]{a} \ar[ul]^{0.7} \ar[ur]_{0.3} \\
  &amp; \ar[u]
}
}
\end{center}
\caption{\label{f:automaton_1}A probabilistic automaton}
\end{figure}

For probabilistic automata, an expectation gives the current expected value of some expression, if
it were to be evaluated in the final state. For example, consider the automaton of
\autoref{f:automaton_1}, with transition probabilities affixed to edges. Let $P\ b = 2.0$ and $P\ c
= 3.0$. Both states $b$ and $c$ are final (accepting) states, and thus the `final expected value' of
$P$ in state $b$ is $2.0$ and in state $c$ is $3.0$. The expected value from state $a$ is the
weighted sum of these, or $0.7 \times 2.0 + 0.3 \times 3.0 = 2.3$.

All expectations must be non-negative and bounded i.e. $\forall s.~0 \le P\ s$ and $\exists b.
\forall s. P\ s \le b$. Note that although every expectation must have a bound, there is no bound on
all expectations; In particular, the following series has no global bound, although each element is
clearly bounded:
\begin{displaymath}
P_i = \lambda s.\ i\quad\text{where}\ i \in \mathbb{N}
\end{displaymath}
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bounded Functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounded_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">bounded_by</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By instantiating the classical reasoner, both establishing and appealing to boundedness
is largely automatic.›</span></span>

<span class="keyword1" id="Expectations-bounded_byI"><span class="command">lemma</span></span> bounded_byI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bounded_by_def<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_byI2"><span class="command">lemma</span></span> bounded_byI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_byD"><span class="command">lemma</span></span> bounded_byD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bounded_by_def<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_byD2"><span class="command">lemma</span></span> bounded_byD2<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A function is bounded if there exists at least one upper bound on it.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bounded</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">bounded</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the reals, if there exists any upper bound, then there must exist a least upper bound.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bound_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> real"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">bound_of</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> Sup <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">`</span> UNIV<span class="main">)</span>"</span></span>

<span class="keyword1" id="Expectations-bounded_bdd_above"><span class="command">lemma</span></span> bounded_bdd_above<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>range <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> bP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> Inf <span class="main">{</span><span class="bound">b</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="free">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> bounded_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The least upper bound has the usual properties:›</span></span>
<span class="keyword1" id="Expectations-bound_of_least"><span class="command">lemma</span></span> bound_of_least<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="free">P</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bound_of_def
  <span class="keyword1"><span class="command">using</span></span> bP <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_bound_of"><span class="command">lemma</span></span> bounded_by_bound_of<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bound_of_def
  <span class="keyword1"><span class="command">using</span></span> bP <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bounded_byI cSup_upper bounded_bdd_above<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bound_of_greater"><span class="command">lemma</span></span> bound_of_greater<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>bounded_byD<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_mono"><span class="command">lemma</span></span> bounded_by_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded_by <span class="free">a</span> <span class="free">P</span><span class="main">;</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounded_by_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_imp_bounded"><span class="command">lemma</span></span> bounded_by_imp_bounded<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">P</span> <span class="main">⟹</span> bounded <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bounded_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is occasionally easier to apply:›</span></span>

<span class="keyword1" id="Expectations-bounded_by_bound_of_alt"><span class="command">lemma</span></span> bounded_by_bound_of_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded <span class="free">P</span><span class="main">;</span> bound_of <span class="free">P</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">a</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_const"><span class="command">lemma</span></span> bounded_const<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_const"><span class="command">lemma</span></span> bounded_by_const<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_mono_alt"><span class="command">lemma</span></span> bounded_by_mono_alt<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded_by <span class="free">b</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>

<span class="keyword1" id="Expectations-bound_of_const"><span class="command">lemma</span></span> bound_of_const<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bound_of_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> antisym cSup_least cSup_upper bounded_bdd_above bounded_const<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bound_of_leI"><span class="command">lemma</span></span> bound_of_leI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">c</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="free">P</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bound_of_def
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-bound_of_mono"><span class="command">lemma</span></span> bound_of_mono<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Q</span><span class="main">;</span> bounded <span class="free">P</span><span class="main">;</span> bounded <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> bound_of <span class="free">P</span> <span class="main">≤</span> bound_of <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_o"><span class="command">lemma</span></span> bounded_by_o<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="free">P</span> <span class="main">⟹</span> bounded_by <span class="bound">b</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-le_bound_of"><span class="command">lemma</span></span> le_bound_of<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> bounded <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> bound_of <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Non-Negative Functions.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definitions for non-negative functions are analogous to those for bounded functions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nneg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>zero<span class="main">,</span>order<span class="main">}</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nneg</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Expectations-nnegI"><span class="command">lemma</span></span> nnegI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nneg_def<span class="main">)</span>

<span class="keyword1" id="Expectations-nnegI2"><span class="command">lemma</span></span> nnegI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">P</span> <span class="main">⟹</span> nneg <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>

<span class="keyword1" id="Expectations-nnegD"><span class="command">lemma</span></span> nnegD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="free">P</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nneg_def<span class="main">)</span>

<span class="keyword1" id="Expectations-nnegD2"><span class="command">lemma</span></span> nnegD2<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>

<span class="keyword1" id="Expectations-nneg_bdd_below"><span class="command">lemma</span></span> nneg_bdd_below<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="free">P</span> <span class="main">⟹</span> bdd_below <span class="main">(</span>range <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-nneg_const"><span class="command">lemma</span></span> nneg_const<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nneg_def<span class="main">)</span>

<span class="keyword1" id="Expectations-nneg_o"><span class="command">lemma</span></span> nneg_o<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="free">P</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-nneg_bound_nneg"><span class="command">lemma</span></span> nneg_bound_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1" id="Expectations-nneg_bounded_by_nneg"><span class="command">lemma</span></span> nneg_bounded_by_nneg<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">b</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_nneg"><span class="command">lemma</span></span> bounded_by_nneg<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sound Expectations›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sound</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sound</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> bounded <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> nneg <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combining <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">nneg</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">bounded</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we have <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sound</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expectations. We set up
the classical reasoner and the simplifier, such that showing soundess, or deriving a simple
consequence (e.g. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"sound <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⟹</span></span> <span class="main"><span class="main">0</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) will usually follow by blast, force or simp.›</span></span>

<span class="keyword1" id="Expectations-soundI"><span class="command">lemma</span></span> soundI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sound_def<span class="main">)</span>

<span class="keyword1" id="Expectations-soundI2"><span class="command">lemma</span></span> soundI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>soundI<span class="main">)</span>

<span class="keyword1" id="Expectations-sound_bounded"><span class="command">lemma</span></span> sound_bounded<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="free">P</span> <span class="main">⟹</span> bounded <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sound_def<span class="main">)</span>

<span class="keyword1" id="Expectations-sound_nneg"><span class="command">lemma</span></span> sound_nneg<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="free">P</span> <span class="main">⟹</span> nneg <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sound_def<span class="main">)</span>

<span class="keyword1" id="Expectations-bound_of_sound"><span class="command">lemma</span></span> bound_of_sound<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This proof demonstrates the use of the classical reasoner (specifically blast), to both
introduce and eliminate soundness terms.›</span></span>

<span class="keyword1" id="Expectations-sound_sum"><span class="command">lemma</span></span> sound_sum<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span> <span class="main">+</span> bound_of <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span> <span class="main">+</span> bound_of <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>add_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-mult_sound"><span class="command">lemma</span></span> mult_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span> <span class="main">*</span> bound_of <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> sQ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span> <span class="main">*</span> bound_of <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> sQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-div_sound"><span class="command">lemma</span></span> div_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> cpos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">/</span> <span class="free">c</span> <span class="main">≤</span> bound_of <span class="free">P</span> <span class="main">/</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>divide_right_mono less_imp_le<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">/</span> <span class="free">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>divide_nonneg_pos<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-tminus_sound"><span class="command">lemma</span></span> tminus_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="free">c</span> <span class="main">≤</span> bound_of <span class="free">P</span> <span class="main">⊖</span> <span class="free">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_left_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-const_sound"><span class="command">lemma</span></span> const_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-sound_o"><span class="command">lemma</span></span> sound_o<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="free">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-sc_bounded_by"><span class="command">lemma</span></span> sc_bounded_by<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sound <span class="free">P</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="main">(</span><span class="free">c</span> <span class="main">*</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>

<span class="keyword1" id="Expectations-sc_bounded"><span class="command">lemma</span></span> sc_bounded<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span>  <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-sc_bound"><span class="command">lemma</span></span> sc_bound<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cnn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> bound_of <span class="free">P</span> <span class="main">=</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> cnn <span class="keyword1"><span class="command">have</span></span> cpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> cnn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">≤</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_bound_of<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> cpos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_div_mono_right<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="free">P</span> <span class="main">≤</span> inverse <span class="free">c</span> <span class="main">*</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> cpos <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> bound_of <span class="free">P</span> <span class="main">≤</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_div_mono_left<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> cpos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> bound_of <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono less_imp_le<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> bound_of <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-sc_sound"><span class="command">lemma</span></span> sc_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sound <span class="free">P</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_mult"><span class="command">lemma</span></span> bounded_by_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">a</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_mono<span class="main">)</span>

<span class="keyword1" id="Expectations-bounded_by_add"><span class="command">lemma</span></span> bounded_by_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">a</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span><span class="free">a</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono<span class="main">)</span>

<span class="keyword1" id="Expectations-sound_unit"><span class="command">lemma</span></span> sound_unit<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unit_mult"><span class="command">lemma</span></span> unit_mult<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>bounded_by_mult<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-sum_sound"><span class="command">lemma</span></span> sum_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> sound <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> soundI2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> bound_of <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum_nonneg<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unitary expectations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A unitary expectation is a sound expectation that is additionally bounded by one.  This
is the domain on which the \emph{liberal} (partial correctness) semantics operates.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unitary</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unitary</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⟷</span> sound <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> bounded_by <span class="main">1</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span>"</span></span>

<span class="keyword1" id="Expectations-unitaryI"><span class="command">lemma</span></span> unitaryI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sound <span class="free">P</span><span class="main">;</span> bounded_by <span class="main">1</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unitary_def<span class="main">)</span>

<span class="keyword1" id="Expectations-unitaryI2"><span class="command">lemma</span></span> unitaryI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nneg <span class="free">P</span><span class="main">;</span> bounded_by <span class="main">1</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_sound"><span class="command">lemma</span></span> unitary_sound<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="free">P</span> <span class="main">⟹</span> sound <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unitary_def<span class="main">)</span>
  
<span class="keyword1" id="Expectations-unitary_bound"><span class="command">lemma</span></span> unitary_bound<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="free">P</span> <span class="main">⟹</span> bounded_by <span class="main">1</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>unitary_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Standard Expectations›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:standard}›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">embed_bool</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">«</span> _ <span class="keyword1">»</span>"</span> 1000<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">«</span></span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">»</span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard expectations are the embeddings of boolean predicates, mapping <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">False</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 0
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">True</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to 1. We write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">»</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> rather than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">[</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">]</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (the syntax employed by
\citet{McIver_M_04}) for boolean embedding to avoid clashing with the HOL syntax for lists.›</span></span>

<span class="keyword1" id="Expectations-embed_bool_nneg"><span class="command">lemma</span></span> embed_bool_nneg<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_bool_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-embed_bool_bounded_by_1"><span class="command">lemma</span></span> embed_bool_bounded_by_1<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_bool_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-embed_bool_bounded"><span class="command">lemma</span></span> embed_bool_bounded<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Standard expectations have a number of convenient properties, which mostly follow from
boolean algebra.›</span></span>

<span class="keyword1" id="Expectations-embed_bool_idem"><span class="command">lemma</span></span> embed_bool_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-eval_embed_true"><span class="command">lemma</span></span> eval_embed_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-eval_embed_false"><span class="command">lemma</span></span> eval_embed_false<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-embed_ge_0"><span class="command">lemma</span></span> embed_ge_0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-embed_le_1"><span class="command">lemma</span></span> embed_le_1<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-embed_le_1_alt"><span class="command">lemma</span></span> embed_le_1_alt<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> add_le_cancel_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">«</span></span></span><span class="free"><span class="free"><span class="free">G</span></span></span><span class="main"><span class="main"><span class="main">»</span></span></span> <span class="free"><span class="free"><span class="free">s</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-expect_1_I"><span class="command">lemma</span></span> expect_1_I<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-standard_sound"><span class="command">lemma</span></span> standard_sound<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-embed_o"><span class="command">lemma</span></span> embed_o<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_bool_def o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Negating a predicate has the expected effect in its
embedding as an expectation:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">negate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">𝒩</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">negate</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Expectations-negateI"><span class="command">lemma</span></span> negateI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="keyword1">𝒩</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-embed_split"><span class="command">lemma</span></span> embed_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="free">f</span> <span class="free">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_def embed_bool_def<span class="main">)</span>

<span class="keyword1" id="Expectations-negate_embed"><span class="command">lemma</span></span> negate_embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-eval_nembed_true"><span class="command">lemma</span></span> eval_nembed_true<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-eval_nembed_false"><span class="command">lemma</span></span> eval_nembed_false<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="free">s</span> <span class="main">⟹</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-negate_Not"><span class="command">lemma</span></span> negate_Not<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩</span> Not <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-negate_negate"><span class="command">lemma</span></span> negate_negate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="keyword1">𝒩</span> <span class="main">(</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_def<span class="main">)</span>

<span class="keyword1" id="Expectations-embed_bool_cancel"><span class="command">lemma</span></span> embed_bool_cancel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Entailment›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:entailment}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Entailment on expectations is a generalisation of that on predicates, and is defined by
pointwise comparison:›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">entails</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⊩</span> _"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main"><span class="free">⊩</span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1" id="Expectations-entailsI"><span class="command">lemma</span></span> entailsI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>

<span class="keyword1" id="Expectations-entailsD"><span class="command">lemma</span></span> entailsD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">Q</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>

<span class="keyword1" id="Expectations-eq_entails"><span class="command">lemma</span></span> eq_entails<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Expectations-entails_trans"><span class="command">lemma</span></span> entails_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For standard expectations, both notions of entailment coincide. This result justifies the
above claim that our definition generalises predicate entailment:›</span></span>

<span class="keyword1" id="Expectations-implies_entails"><span class="command">lemma</span></span> implies_entails<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">⊩</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> entailsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Expectations-entails_implies"><span class="command">lemma</span></span> entails_implies<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">⊩</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span><span class="main">;</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> s<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">s</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> entailsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Expectation Conjunction›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pconj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> real <span class="main">⇒</span>  real"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">.&amp;</span>"</span> 71<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">.&amp;</span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">exp_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">&amp;&amp;</span>"</span> 71<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main"><span class="free">&amp;&amp;</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">s</span> <span class="main">.&amp;</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Expectation conjunction likewise generalises (boolean) predicate conjunction. We show that
the expected properties are preserved, and instantiate both the classical reasoner, and the
simplifier (in the case of associativity and commutativity).›</span></span>

<span class="keyword1" id="Expectations-pconj_lzero"><span class="command">lemma</span></span> pconj_lzero<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">.&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def tminus_def<span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_rzero"><span class="command">lemma</span></span> pconj_rzero<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">.&amp;</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def tminus_def<span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_lone"><span class="command">lemma</span></span> pconj_lone<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">.&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def tminus_def<span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_rone"><span class="command">lemma</span></span> pconj_rone<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">.&amp;</span> <span class="main">1</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def tminus_def<span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_bconj"><span class="command">lemma</span></span> pconj_bconj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">a</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> <span class="main">«</span><span class="free">b</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">a</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">b</span> <span class="bound">s</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> embed_bool_def pconj_def tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_comm"><span class="command">lemma</span></span> pconj_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">.&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">.&amp;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_assoc"><span class="command">lemma</span></span> pconj_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span><span class="main">;</span> <span class="free">a</span> <span class="main">≤</span> <span class="main">1</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="free">b</span> <span class="main">≤</span> <span class="main">1</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">a</span> <span class="main">.&amp;</span> <span class="main">(</span><span class="free">b</span> <span class="main">.&amp;</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">.&amp;</span> <span class="free">b</span><span class="main">)</span> <span class="main">.&amp;</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_mono"><span class="command">lemma</span></span> pconj_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">.&amp;</span> <span class="free">c</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">.&amp;</span> <span class="free">d</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_nneg"><span class="command">lemma</span></span> pconj_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">.&amp;</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-min_pconj"><span class="command">lemma</span></span> min_pconj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>min <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">.&amp;</span> <span class="main">(</span>min <span class="free">c</span> <span class="free">d</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">a</span> <span class="main">.&amp;</span> <span class="free">c</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="main">.&amp;</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min.absorb1 min.absorb2 pconj_mono<span class="main">)</span><span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="free">d</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min.absorb1 min.absorb2 pconj_mono<span class="main">)</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_less_one"><span class="command">lemma</span></span> pconj_less_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">.&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_ge_one"><span class="command">lemma</span></span> pconj_ge_one<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">.&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-pconj_idem"><span class="command">lemma</span></span> pconj_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rules Involving Conjunction.›</span></span>

<span class="keyword1" id="Expectations-exp_conj_mono_left"><span class="command">lemma</span></span> exp_conj_mono_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="main">&amp;&amp;</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def pconj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_left_mono add_right_mono<span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_mono_right"><span class="command">lemma</span></span> exp_conj_mono_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def pconj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_left_mono add_left_mono<span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_comm"><span class="command">lemma</span></span> exp_conj_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">&amp;&amp;</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">&amp;&amp;</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_bounded_by"><span class="command">lemma</span></span> exp_conj_bounded_by<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">Q</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="main">+</span> <span class="free">Q</span> <span class="skolem">x</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-exp_conj_o_distrib"><span class="command">lemma</span></span> exp_conj_o_distrib<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_assoc"><span class="command">lemma</span></span> exp_conj_assoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="free">Q</span> <span class="main">&amp;&amp;</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="main">(</span><span class="free">Q</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="free">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">.&amp;</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-exp_conj_top_left"><span class="command">lemma</span></span> exp_conj_top_left<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="free">P</span> <span class="main">⟹</span> <span class="main">«</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_top_right"><span class="command">lemma</span></span> exp_conj_top_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sound <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">»</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_idem"><span class="command">lemma</span></span> exp_conj_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_nneg"><span class="command">lemma</span></span> exp_conj_nneg<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_sound"><span class="command">lemma</span></span> exp_conj_sound<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s_P<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s_P <span class="keyword2"><span class="keyword">and</span></span> s_Q <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_less<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">...</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="free">P</span> <span class="main">+</span> bound_of <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span> <span class="main">+</span> bound_of <span class="free">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pconj_def tminus_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-exp_conj_rzero"><span class="command">lemma</span></span> exp_conj_rzero<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Expectations-exp_conj_1_right"><span class="command">lemma</span></span> exp_conj_1_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def pconj_def tminus_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> nn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">A</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span><span class="free">A</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">0</span> <span class="main">=</span> <span class="free">A</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-exp_conj_std_split"><span class="command">lemma</span></span> exp_conj_std_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def embed_bool_def pconj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rules Involving Entailment and Conjunction Together›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Meta-conjunction distributes over expectaton entailment,
becoming expectation conjunction:›</span></span>
<span class="keyword1" id="Expectations-entails_frame"><span class="command">lemma</span></span> entails_frame<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ePR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eQS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">R</span> <span class="main">&amp;&amp;</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> ePR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> eQS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_left_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="free">R</span> <span class="main">&amp;&amp;</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def pconj_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This rule allows something very much akin to a case distinction
on the pre-expectation.›</span></span>
<span class="keyword1" id="Expectations-pentails_cases"><span class="command">lemma</span></span> pentails_cases<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> PQe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="bound">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> exhaust<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> framed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">&amp;&amp;</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">&amp;&amp;</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sS<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> bounded_by <span class="main">1</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊩</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> exhaust <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> P_xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">x</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> PQe <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">Q</span> <span class="skolem">x</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bQ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> le_funD<span class="main">[</span><span class="operator">OF</span> framed<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-unitary_bot"><span class="command">lemma</span></span> unitary_bot<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_top"><span class="command">lemma</span></span> unitary_top<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_embed"><span class="command">lemma</span></span> unitary_embed<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="main">«</span><span class="free">P</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_const"><span class="command">lemma</span></span> unitary_const<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span><span class="main">;</span> <span class="free">c</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_mult"><span class="command">lemma</span></span> unitary_mult<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uA<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uB<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">A</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">B</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> nnA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">A</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">B</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">A</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">B</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nnB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">B</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> mult_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">B</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Expectations-exp_conj_unitary"><span class="command">lemma</span></span> exp_conj_unitary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> unitary <span class="free">P</span><span class="main">;</span> unitary <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Expectations-unitary_comp"><span class="command">lemma</span></span> unitary_comp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"unitary <span class="free">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> unitary_intros <span class="main">=</span>
  unitary_bot unitary_top unitary_embed unitary_mult exp_conj_unitary
  unitary_comp unitary_const

<span class="keyword1"><span class="command">lemmas</span></span> sound_intros <span class="main">=</span>
  mult_sound div_sound const_sound sound_o sound_sum
  tminus_sound sc_sound exp_conj_sound sum_sound

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Transformers">
<div class="head">
<h1>Theory Transformers</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Expectation Transformers"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Transformers <span class="keyword2"><span class="keyword">imports</span></span> <a href="Expectations.html">Expectations</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:transformers}›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> trans <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transformers are functions from expectations to expectations i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span>
real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. 

The set of \emph{healthy} transformers is the universe into which we place our semantic
interpretation of pGCL programs. In its standard presentation, the healthiness condition for pGCL
programs is \emph{sublinearity}, for demonic programs, and \emph{superlinearity} for angelic
programs. We extract a minimal core property, consisting of monotonicity, feasibility and scaling to
form our healthiness property, which holds across all programs. The additional components of
sublinearity are broken out separately, and shown later. The two reasons for this are firstly to
avoid the effort of establishing sub-(super-)linearity globally, and to allow us to define
primitives whose sublinearity, and indeed healthiness, depend on context.

Consider again the automaton of \autoref{f:automaton_1}. Here, the effect of executing the automaton
from its initial state ($a$) until it reaches some final state ($b$ or $c$) is to \emph{transform}
the expectation on final states ($P$), into one on initial states, giving the \emph{expected} value
of the function on termination. Here, the transformation is linear: $P_\text{prior}(a) = 0.7 *
P_\text{post}(b) + 0.3 * P_\text{post}(c)$, but this need not be the case.

\begin{figure}
\begin{center}
\mbox{
\xymatrix{
*++[o][F=]{b} &amp; &amp; *++[o][F=]{c} \\
 *++[o][F-]{a} \ar[u]^{0.7} \ar[urr]_(0.25){0.3}  &amp; &amp; *++[o][F-]{d} \ar[ull]^(0.25){0.5} \ar[u]_{0.5}\\
  &amp; *++[o][F-]{e}\ar[ul] \ar[ur] \\
  &amp; \ar[u]
}
}
\end{center}
\caption{\label{f:automaton_2}A nondeterministic-probabilistic automaton.}
\end{figure}

Consider the automaton of \autoref{f:automaton_2}. Here, we have extended that of
\autoref{f:automaton_1} with two additional states, $d$ and $e$, and a pair of silent (unlabelled)
transitions. From the initial state, $e$, this automaton is free to transition either to the
original starting state ($a$), and thence behave exactly as the previous automaton did, or to $d$,
which has the same set of available transitions, now with different probabilities. Where previously
we could state that the automaton would terminate in state $b$ with probability 0.7 (and in $c$ with
probability 0.3), this now depends on the outcome of the \emph{nondeterministic} transition from $e$
to either $a$ or $d$. The most we can now say is that we must reach $b$ with probability \emph{at
least} 0.5 (the minimum from either $a$ or $d$) and $c$ with at least probability 0.3. Note that
these probabilities do not sum to one (although the sum will still always be less than one). The
associated expectation transformer is now \emph{sub-}linear: $P_\text{prior}(e) = 0.5 *
P_\text{post}(b) + 0.3 * P_\text{post}(c)$.›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹
\begin{figure}
\begin{center}
\mbox{
\xymatrix{
*++[o][F=]{b} &amp; &amp; *++[o][F=]{c} \\
      *++[o][F-]{a} \ar@(dl,ul)[] \ar[u]^{0.5} \ar[urr]_{0.3}
  &amp; &amp; *++[o][F-]{d} \ar@(dr,ur)[] \\
  &amp; *++[o][F-]{e}\ar[ul]^{0.5} \ar[ur]_{0.5} \\
  &amp; \ar[u]
}
}
\end{center}
\caption{\label{f:automaton_3}A diverging automaton.}
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Finally, \autoref{f:automaton_3} shows the other way in which strict sublinearity arises:
divergence.  This automaton transitions with probability 0.5 to state $d$, from which it never
escapes.  Once there, the probability of reaching any terminating state is zero, and thus the
probabilty of terminating from the initial state ($e$) is no higher than 0.5.  If it instead
takes the edge to state $a$, we again see a self loop, and thus in theory an infinite trace.  In
this case, however, every time the automaton reaches state $a$, with probability $0.5 + 0.3 = 0.8$,
it transitions to a terminating state.  An infinite trace of transitions $a \rightarrow a
\rightarrow \ldots$ thus has probability 0, and the automaton terminates with probability 1.  We
formalise such probabilistic termination arguments in \autoref{s:termination}.

Having reached $a$, the automaton will proceed to $b$ with probability $0.5 * (1 / (0.5 + 0.3)) =
0.625$, and to $c$ with probability $0.375$.  As $a$ is in turn reached half the time, the final
probability of ending in $b$ is $0.3125$, and in $c$, $0.1875$, which sum to only $0.5$.  The
remaining probability is that the automaton diverges via $d$.  We view nondeterminism and
divergence demonically: we take the \emph{least} probability of reaching a given final state, and
use it to calculate the expectation.  Thus for this automaton, $P_\text{prior}(e) = 0.3125 *
P_\text{post}(b) + 0.1875 * P_\text{post}(c)$.  The end result is the same as for nondeterminism:
a sublinear transformation (the weights sum to less than one).  The two outcomes are thus unified
in the semantic interpretation, although as we will establish in \autoref{s:prog_determ}, the two
have slightly different algebraic properties.

This pattern holds for all pGCL programs: probabilistic choices are always linear, while struct
sublinearity is introduced both nondeterminism and divergence.

Healthiness, again, is the combination of three properties: feasibility, monotonicity and
scaling. Feasibility requires that a transformer take non-negative expectations to non-negative
expectations, and preserve bounds. Thus, starting with an expectation bounded between 0 and some
bound, $b$, after applying any number of feasible transformers, the result will still be bounded
between 0 and $b$. This closure property allows us to treat expectations almost as a complete
lattice. Specifically, for any $b$, the set of expectations bounded by $b$ is a complete lattice
($\bot = (\lambda s. 0)$, $\top = (\lambda s. b)$), and is closed under the action of feasible
transformers, including $\sqcap$ and $\sqcup$, which are themselves feasible. We are thus able to
define both least and greatest fixed points on this set, and thus give semantics to recursive
programs built from feasible components.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Comparing Transformers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transformers are compared pointwise, but only on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">sound</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expectations. From the
preorder so generated, we define equivalence by antisymmetry, giving a partial order.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">le_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_trans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">P</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We also need to define relations restricted to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">unitary</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> transformers, for the
liberal (wlp) semantics.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">le_utrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">le_utrans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">P</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-le_transI"><span class="command">lemma</span></span> le_transI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">u</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_trans_def<span class="main">)</span>

<span class="keyword1" id="Transformers-le_utransI"><span class="command">lemma</span></span> le_utransI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">u</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_utrans_def<span class="main">)</span>

<span class="keyword1" id="Transformers-le_transD"><span class="command">lemma</span></span>  le_transD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_trans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_trans_def<span class="main">)</span>
  
<span class="keyword1" id="Transformers-le_utransD"><span class="command">lemma</span></span> le_utransD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_utrans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">u</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_utrans_def<span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_trans"><span class="command">lemma</span></span> le_trans_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_trans <span class="free">x</span> <span class="free">y</span><span class="main">;</span> le_trans <span class="free">y</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>
  
<span class="keyword1" id="Transformers-le_utrans_trans"><span class="command">lemma</span></span> le_utrans_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_utrans <span class="free">x</span> <span class="free">y</span><span class="main">;</span> le_utrans <span class="free">y</span> <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_refl"><span class="command">lemma</span></span> le_trans_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"le_trans <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_trans_def<span class="main">)</span>
  
<span class="keyword1" id="Transformers-le_utrans_refl"><span class="command">lemma</span></span> le_utrans_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"le_utrans <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>le_utrans_def<span class="main">)</span>
  
<span class="keyword1" id="Transformers-le_trans_le_utrans"><span class="command">lemma</span></span> le_trans_le_utrans<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"le_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> le_trans_def le_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">l_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">l_trans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> le_trans <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> <span class="main">¬</span> le_trans <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transformer equivalence is induced by comparison:›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">equiv_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equiv_trans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> le_trans <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> le_trans <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">equiv_utrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">equiv_utrans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">⟷</span> le_utrans <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">∧</span> le_utrans <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Transformers-equiv_transI"><span class="command">lemma</span></span> equiv_transI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">=</span> <span class="free">u</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> equiv_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_utransI"><span class="command">lemma</span></span> equiv_utransI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">=</span> <span class="free">u</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> equiv_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_transD"><span class="command">lemma</span></span> equiv_transD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv_trans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">=</span> <span class="free">u</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym<span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_utransD"><span class="command">lemma</span></span> equiv_utransD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv_utrans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">=</span> <span class="free">u</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym<span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_trans_refl"><span class="command">lemma</span></span> equiv_trans_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_utrans_refl"><span class="command">lemma</span></span> equiv_utrans_refl<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_antisym"><span class="command">lemma</span></span> le_trans_antisym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_trans <span class="free">x</span> <span class="free">y</span><span class="main">;</span> le_trans <span class="free">y</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> equiv_trans <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-le_utrans_antisym"><span class="command">lemma</span></span> le_utrans_antisym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_utrans <span class="free">x</span> <span class="free">y</span><span class="main">;</span> le_utrans <span class="free">y</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> equiv_utrans <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_trans_comm"><span class="command">lemma</span></span> equiv_trans_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟷</span> equiv_trans <span class="free">u</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_utrans_comm"><span class="command">lemma</span></span> equiv_utrans_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">u</span> <span class="main">⟷</span> equiv_utrans <span class="free">u</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_imp_le"><span class="command">lemma</span></span> equiv_imp_le<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equivu_imp_le"><span class="command">lemma</span></span> equivu_imp_le<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_imp_le_alt"><span class="command">lemma</span></span> equiv_imp_le_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_trans <span class="free">u</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_uimp_le_alt"><span class="command">lemma</span></span> equiv_uimp_le_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_utrans <span class="free">u</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_equiv_rsp"><span class="command">lemma</span></span> le_trans_equiv_rsp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="free">v</span> <span class="main">⟷</span> le_trans <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_trans_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-le_utrans_equiv_rsp"><span class="command">lemma</span></span> le_utrans_equiv_rsp<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">v</span> <span class="main">⟷</span> le_utrans <span class="free">u</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_utrans_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_trans_le_trans"><span class="command">lemma</span></span> equiv_trans_le_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv_trans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> le_trans <span class="free">u</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_utrans_le_utrans"><span class="command">lemma</span></span> equiv_utrans_le_utrans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv_utrans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> le_utrans <span class="free">u</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_equiv_rsp_right"><span class="command">lemma</span></span> le_trans_equiv_rsp_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_trans <span class="free">v</span> <span class="free">t</span> <span class="main">⟷</span> le_trans <span class="free">v</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_trans_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-le_utrans_equiv_rsp_right"><span class="command">lemma</span></span> le_utrans_equiv_rsp_right<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> le_utrans <span class="free">v</span> <span class="free">t</span> <span class="main">⟷</span> le_utrans <span class="free">v</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> equiv_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_utrans_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_equiv_trans"><span class="command">lemma</span></span> le_trans_equiv_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_trans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> equiv_trans <span class="free">u</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-le_utrans_equiv_utrans"><span class="command">lemma</span></span> le_utrans_equiv_utrans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_utrans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> equiv_utrans <span class="free">u</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_trans_trans"><span class="command">lemma</span></span> equiv_trans_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_trans_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> yz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">y</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">x</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> yz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">z</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="free">z</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-equiv_utrans_trans"><span class="command">lemma</span></span> equiv_utrans_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">x</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="free">x</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_utrans_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> yz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">y</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">x</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> yz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">z</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">y</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">z</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-equiv_trans_equiv_utrans"><span class="command">lemma</span></span> equiv_trans_equiv_utrans<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> equiv_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Healthy Transformers›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Feasibility›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">feasible</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">feasible</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">b</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="bound">P</span> <span class="main">∧</span> nneg <span class="bound">P</span> <span class="main">⟶</span>
                               bounded_by <span class="bound">b</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span><span class="main">)</span> <span class="main">∧</span> nneg <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">feasible</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> transformer preserves non-negativity, and bounds. A <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">feasible</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
transformer always takes its argument `closer to 0' (or leaves it where it is). Note that any
particular value of the expectation may increase, but no element of the new expectation may exceed
any bound on the old. This is thus a relatively weak condition.›</span></span>

<span class="keyword1" id="Transformers-feasibleI"><span class="command">lemma</span></span> feasibleI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">b</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> bounded_by <span class="bound">b</span> <span class="bound">P</span><span class="main">;</span> nneg <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="bound">b</span> <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">b</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> bounded_by <span class="bound">b</span> <span class="bound">P</span><span class="main">;</span> nneg <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> feasible <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>feasible_def<span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_boundedD"><span class="command">lemma</span></span> feasible_boundedD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> feasible <span class="free">t</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>feasible_def<span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_nnegD"><span class="command">lemma</span></span> feasible_nnegD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> feasible <span class="free">t</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>feasible_def<span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_sound"><span class="command">lemma</span></span> feasible_sound<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> feasible <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> sound_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_pr_0"><span class="command">lemma</span></span> feasible_pr_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">0</span> <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-feasible_id"><span class="command">lemma</span></span> feasible_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"feasible <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> feasible_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_bounded_by"><span class="command">lemma</span></span> feasible_bounded_by<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> feasible <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_fixes_top"><span class="command">lemma</span></span> feasible_fixes_top<span class="main">:</span>
  <span class="quoted"><span class="quoted">"feasible <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">drule</span> bounded_byD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> feasible_bounded_by<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Transformers-feasible_fixes_bot"><span class="command">lemma</span></span> feasible_fixes_bot<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sb<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">thm</span></span> bound_of_const
  <span class="keyword1"><span class="command">from</span></span> sb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bound_of_const<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">0</span> <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-feasible_unitaryD"><span class="command">lemma</span></span> feasible_unitaryD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> unitaryI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">mono_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mono_trans</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span>sound <span class="bound">P</span> <span class="main">∧</span> sound <span class="bound">Q</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Monotonicity allows us to compose transformers, and thus model sequential computation.
Recall the definition of predicate entailment (\autoref{s:entailment}) as less-than-or-equal. The
statement <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> means that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is everywhere below <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. For standard
expectations (\autoref{s:standard}), this simply means that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \emph{implies} <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
the \emph{weakest precondition} of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

Given another, monotonic, transformer <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we have that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or that the
weakest precondition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">u</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> entails that of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">R</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> under the composition
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">u</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">t</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  If we additionally know that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">u</span></span> <span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, then by transitivity we have
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  We thus derive a probabilistic form of the standard rule for sequential
composition: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⟦</span></span> mono_trans <span class="free"><span class="free">t</span></span><span class="main"><span class="main">;</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">u</span></span> <span class="free"><span class="free">Q</span></span><span class="main"><span class="main">;</span></span> <span class="free"><span class="free">Q</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span> <span class="main"><span class="main">⟧</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">⊩</span></span> <span class="free"><span class="free">u</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span> <span class="free"><span class="free">R</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1" id="Transformers-mono_transI"><span class="command">lemma</span></span> mono_transI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>  <span class="free">t</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> mono_trans <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mono_trans_def<span class="main">)</span>

<span class="keyword1" id="Transformers-mono_transD"><span class="command">lemma</span></span> mono_transD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> mono_trans <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> sound <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mono_trans_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Scaling›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:scaling}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A healthy transformer commutes with scaling by a non-negative constant.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">scaling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scaling</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟶</span> <span class="bound">c</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">scaling</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and feasibility properties together allow us to treat transformers as a
complete lattice, when operating on bounded expectations. The action of a transformer on such a
bounded expectation is completely determined by its action on \emph{unitary} expectations (those
bounded by 1): <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> bound_of <span class="free"><span class="free">P</span></span> <span class="main"><span class="main">*</span></span> <span class="free"><span class="free">t</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">/</span></span> bound_of <span class="free"><span class="free">P</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Feasibility in turn
ensures that the lattice of unitary expectations is closed under the action of a healthy
transformer. We take advantage of this fact in \autoref{s:induction}, in order to define the fixed
points of healthy transformers.›</span></span>

<span class="keyword1" id="Transformers-scalingI"><span class="command">lemma</span></span> scalingI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">c</span> <span class="bound">x</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">c</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span> <span class="main">⟧</span> <span class="main">⟹</span> scaling <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scaling_def<span class="main">)</span>

<span class="keyword1" id="Transformers-scalingD"><span class="command">lemma</span></span> scalingD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> scaling <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scaling_def<span class="main">)</span>

<span class="keyword1" id="Transformers-right_scalingD"><span class="command">lemma</span></span> right_scalingD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"scaling <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">s</span> <span class="main">*</span> <span class="free">c</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">s</span> <span class="main">*</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Healthiness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Healthy transformers are feasible and monotonic, and respect scaling›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">healthy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">healthy</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> feasible <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> mono_trans <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> scaling <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Transformers-healthyI"><span class="command">lemma</span></span> healthyI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> feasible <span class="free">t</span><span class="main">;</span> mono_trans <span class="free">t</span><span class="main">;</span> scaling <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> healthy <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> healthy_parts <span class="main">=</span> healthyI<span class="main">[</span><span class="operator">OF</span> feasibleI mono_transI scalingI<span class="main">]</span>

<span class="keyword1" id="Transformers-healthy_monoD"><span class="command">lemma</span></span> healthy_monoD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> mono_trans <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> healthy_monoD2 <span class="main">=</span> mono_transD<span class="main">[</span><span class="operator">OF</span> healthy_monoD<span class="main">]</span>

<span class="keyword1" id="Transformers-healthy_feasibleD"><span class="command">lemma</span></span> healthy_feasibleD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> feasible <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_def<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_scalingD"><span class="command">lemma</span></span> healthy_scalingD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> scaling <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_def<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_bounded_byD"><span class="command">lemma</span></span> healthy_bounded_byD<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_bounded_byD2"><span class="command">lemma</span></span> healthy_bounded_byD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_boundedD"><span class="command">lemma</span></span> healthy_boundedD<span class="main">[</span><span class="operator">dest</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> bounded <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_nnegD"><span class="command">lemma</span></span> healthy_nnegD<span class="main">[</span><span class="operator">dest</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>feasible_nnegD<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_nnegD2"><span class="command">lemma</span></span> healthy_nnegD2<span class="main">[</span><span class="operator">dest</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> nneg <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_sound"><span class="command">lemma</span></span> healthy_sound<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>feasible_nnegD<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_unitary"><span class="command">lemma</span></span> healthy_unitary<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="free">t</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>unitaryI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>unitary_bound healthy_bounded_byD<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_id"><span class="command">lemma</span></span> healthy_id<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy id"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthyI feasibleI mono_transI scalingI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> healthy_fixes_bot <span class="main">=</span> feasible_fixes_bot<span class="main">[</span><span class="operator">OF</span> healthy_feasibleD<span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Some additional results on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">le_trans</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, specific to
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">healthy</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> transformers.›</span></span>

<span class="keyword1" id="Transformers-le_trans_bot"><span class="command">lemma</span></span> le_trans_bot<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>

<span class="keyword1" id="Transformers-le_trans_top"><span class="command">lemma</span></span> le_trans_top<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> le_trans <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_funI<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_pr_bot"><span class="command">lemma</span></span> healthy_pr_bot<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>feasible_pr_0<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first significant result is that healthiness is preserved by equivalence:›</span></span>

<span class="keyword1" id="Transformers-healthy_equivI"><span class="command">lemma</span></span> healthy_equivI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> equiv<span class="main">:</span>   <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> healthy<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> le_t_u<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="free">t</span> <span class="free">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="free">u</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_imp_le <span class="dynamic"><span class="dynamic">ac_simps</span></span> equiv<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> equiv <span class="keyword1"><span class="command">have</span></span> eq_u_t<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">u</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"feasible <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> le_t_u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">...</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">u</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> le_u_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">u</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> healthy <span class="keyword2"><span class="keyword">and</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono_trans <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> le_u_t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> sQ <span class="keyword2"><span class="keyword">and</span></span> le <span class="keyword2"><span class="keyword">and</span></span> healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword2"><span class="keyword">and</span></span> le_t_u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="free">u</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="free">u</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"scaling <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_left_mono <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sc_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword2"><span class="keyword">and</span></span> pos <span class="keyword1"><span class="command">have</span></span> sc_nneg<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg less_imp_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> sc_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="free">u</span> <span class="skolem">P</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="free">u</span> <span class="skolem">P</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq_u_t<span class="main"><span class="main">]</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> healthy <span class="keyword2"><span class="keyword">and</span></span> sound <span class="keyword2"><span class="keyword">and</span></span> pos
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> scalingD<span class="main">)</span>

      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sc_sound <span class="keyword2"><span class="keyword">and</span></span> equiv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>fun_cong<span class="main">)</span>

      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-healthy_equiv"><span class="command">lemma</span></span> healthy_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span> <span class="main">⟹</span> healthy <span class="free">t</span> <span class="main">⟷</span> healthy <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> healthy_equivI<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_equivI <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_scale"><span class="command">lemma</span></span> healthy_scale<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nnP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> ht nnP bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> nnP <span class="keyword2"><span class="keyword">and</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_right_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> ht nnP bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_nonneg_nonneg<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"scaling <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>scalingD healthy_scalingD ht<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-healthy_top"><span class="command">lemma</span></span> healthy_top<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_parts<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_bot"><span class="command">lemma</span></span> healthy_bot<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_parts<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This weaker healthiness condition is for the liberal (wlp) semantics. We only insist that
the transformer preserves \emph{unitarity} (bounded by 1), and drop scaling (it is unnecessary in
establishing the lattice structure here, unlike for the strict semantics).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">nearly_healthy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nearly_healthy</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                        <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="bound">Q</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-nearly_healthyI"><span class="command">lemma</span></span> nearly_healthyI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> nearly_healthy <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nearly_healthy_def<span class="main">)</span>

<span class="keyword1" id="Transformers-nearly_healthy_monoD"><span class="command">lemma</span></span> nearly_healthy_monoD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nearly_healthy <span class="free">t</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span><span class="main">;</span> unitary <span class="free">P</span><span class="main">;</span> unitary <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nearly_healthy_def<span class="main">)</span>

<span class="keyword1" id="Transformers-nearly_healthy_unitaryD"><span class="command">lemma</span></span> nearly_healthy_unitaryD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> nearly_healthy <span class="free">t</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nearly_healthy_def<span class="main">)</span>

<span class="keyword1" id="Transformers-healthy_nearly_healthy"><span class="command">lemma</span></span> healthy_nearly_healthy<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ht<span class="main"><span class="main">]</span></span> ht<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> nearly_healthy_id<span class="main">[</span><span class="operator">iff</span><span class="main">]</span> <span class="main">=</span>
  healthy_nearly_healthy<span class="main">[</span><span class="operator">OF</span> healthy_id<span class="main">,</span> <span class="operator">unfolded</span> id_def<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As already mentioned, the core healthiness property (aside from feasibility and continuity)
for transformers is \emph{sublinearity}: The transformation of a quasi-linear combination of sound
expectations is greater than the same combination applied to the transformation of the expectations
themselves. The term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⊖</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> represents \emph{truncated subtraction} i.e. <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"max <span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">-</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span>
<span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (see \autoref{s:trunc_sub}).›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sublinear</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sublinear</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>sound <span class="bound">P</span> <span class="main">∧</span> sound <span class="bound">Q</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">b</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟶</span>
                  <span class="bound">a</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="bound">c</span>
                  <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">Q</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-sublinearI"><span class="command">lemma</span></span> sublinearI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">a</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">b</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟧</span> <span class="main">⟹</span>
     <span class="bound">a</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="free">t</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="bound">c</span> <span class="main">≤</span>
     <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">a</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">Q</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="bound">c</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> sublinear <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sublinear_def<span class="main">)</span>

<span class="keyword1" id="Transformers-sublinearD"><span class="command">lemma</span></span> sublinearD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sublinear <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> sound <span class="free">Q</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">a</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">b</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">a</span> <span class="main">*</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> <span class="free">t</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">⊖</span> <span class="free">c</span> <span class="main">≤</span>
   <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">a</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="free">b</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="free">c</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sublinear_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is easier to see the relevance of sublinearity by breaking it into several component
properties, as in the following sections.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-additivity›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:subadd}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sub_add</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_add</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span>sound <span class="bound">P</span> <span class="main">∧</span> sound <span class="bound">Q</span><span class="main">)</span> <span class="main">⟶</span>
                <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="bound">Q</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\begin{figure}
\begin{center}
\begin{displaymath}
\begin{xy}
0;&lt;1cm,0cm&gt;:
(-0.25,0); (10,0) **\dir{-} *\dir{&gt;},
(0,-0.25); (0,6) **\dir{-} *\dir{&gt;},
(0.1,5.5)="Ps";  (9.9,1.5)="Pe"  **\dir{-} ?(0.1)+&lt;0em,1em&gt; *{P},
(0.1,4.0)="tPs"; (9.9,1.0)="tPe" **\dir{} ?(0.1)+&lt;0em,1em&gt; *{tP},
(0.1,0.5)="uPs"; (9.9,5.0)="uPe" **\dir{} ?(0.9)+&lt;0em,1em&gt; *{uP}
?!{"tPs";"tPe"}="inter";
    "tPs" **\dir{--}, "uPe" **\dir{--},
    "tPe" **\dir{-}, "uPs" **\dir{-} ?(0.5)+&lt;0em,1.5em&gt; *{Q=tP \sqcap uP},
(1,0)="x"; "x"-&lt;0em,1em&gt;*{x};
"x"; (1,6) **{}, ?!{"uPs";"uPe"}="uPx" *{\bullet} -&lt;0em,1em&gt;*{Q(x)},
(9,0)="y"; "y"-&lt;0em,1em&gt;*{y};
"y"; (9,6) **{}, ?!{"tPs";"tPe"}="tPy" *{\bullet} -&lt;0em,1em&gt;*{Q(y)},
"uPx"; "tPy" **\dir{.},
(5,0)="xy"; (5,6) **{},
    ?!{"tPs";"tPe"}="tPxy" *{\bullet} -&lt;0em,1.5em&gt;*{Q(\frac{x+y}{2})},
    ?!{"uPx";"tPy"}="tPuP" *{\bullet} -&lt;0em,1em&gt;*{\frac{Q(x)+Q(y)}{2}},
\end{xy}
\end{displaymath}
\end{center}
\caption{\label{f:subadd_plot}A graphical depiction of sub-additivity as convexity.}
\end{figure}
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sub-additivity, together with scaling (\autoref{s:scaling}) gives the \emph{linear} portion
of sublinearity. Together, these two properties are equivalent to \emph{convexity}, as
\autoref{f:subadd_plot} illustrates by analogy.

Here $P$ is an affine function (expectation) <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"real <span class="main"><span class="main">⇒</span></span> real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, restricted to some finite
interval. In practice the state space (the left-hand type) is typically discrete and
multi-dimensional, but on the reals we have a convenient geometrical intuition. The lines $tP$ and
$uP$ represent the effect of two healthy transformers (again affine). Neither monotonicity nor
scaling are represented, but both are feasible: Both lines are bounded above by the greatest value
of $P$.

The curve $Q$ is the pointwise minimum of $tP$ and $tQ$, written $tP \sqcap tQ$.  This is, not
coincidentally, the syntax for a binary nondeterministic choice in pGCL: The probability that some
property is established by the choice between programs $a$ and $b$ cannot be guaranteed to be any
higher than either the probability under $a$, or that under $b$.

The original curve, $P$, is trivially convex---it is linear.  Also, both $t$ and $u$, and the
operator $\sqcap$ preserve convexity.  A probabilistic choice will also preserve it.  The
preservation of convexity is a property of sub-additive transformers that respect scaling.  Note
the form of the definition of convexity:
\begin{displaymath}
\forall x,y. \frac{Q(x) + Q(y)}{2} \le Q(\frac{x+y}{2})
\end{displaymath}
Were we to replace $Q$ by some sub-additive transformer $v$, and $x$ and $y$ by expectations $R$
and $S$, the equivalent expression:
\begin{displaymath}
\frac{vR + vS}{2} \le v(\frac{R+S}{2})
\end{displaymath}
Can be rewritten, using scaling, to:
\begin{displaymath}
\frac{1}{2}(vR + vS) \le \frac{1}{2}v(R+S)
\end{displaymath}
Which holds everywhere exactly when $v$ is sub-additive i.e.:
\begin{displaymath}
vR + vS \le v(R+S)
\end{displaymath}
›</span></span>

<span class="keyword1" id="Transformers-sub_addI"><span class="command">lemma</span></span> sub_addI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
             <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">t</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="bound">Q</span> <span class="bound">s'</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> sub_add <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_add_def<span class="main">)</span>

<span class="keyword1" id="Transformers-sub_addI2"><span class="command">lemma</span></span> sub_addI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
          <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">t</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span>
   sub_add <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Transformers-sub_addD"><span class="command">lemma</span></span> sub_addD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sub_add <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> sound <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s'</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_add_def<span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_sub_add"><span class="command">lemma</span></span> equiv_sub_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sa<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_add <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">u</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP sQ sa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">u</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity and feasibility imply sub-additivity.›</span></span>
<span class="keyword1" id="Transformers-sublinear_subadd"><span class="command">lemma</span></span> sublinear_subadd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slt<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ft<span class="main">:</span>  <span class="quoted"><span class="quoted">"feasible <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">...</span><span class="main">⊖</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP sQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sublinearD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> slt<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A few properties following from sub-additivity:›</span></span>
<span class="keyword1" id="Transformers-standard_negate"><span class="command">lemma</span></span> standard_negate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> sat <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-sub_add_sum"><span class="command">lemma</span></span> sub_add_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> sound <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"infinite <span class="free">S</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>ht<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fS le_funI le_funI<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">from</span></span> ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
           <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sat sP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">xa</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sub_addD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sat<span class="main"><span class="main">]</span></span> sum_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
          <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">xa</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">x</span> <span class="bound">xa</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">xa</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Transformers-sub_add_guard_split"><span class="command">lemma</span></span> sub_add_guard_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span><span class="main">::</span>finite trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span>  <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span> <span class="main">+</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.union_disjoint<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">=</span> UNIV"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span><span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> healthy_scalingD<span class="main">[</span><span class="operator">OF</span> ht<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sat ht sP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span>
          <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> sub_add_sum sound_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span>
          <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> rw1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext <span class="main"><span class="main">[</span></span><span class="operator">OF</span> sum.cong<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'s</span> set<span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>sum.delta<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> leP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="bound">x</span> <span class="main">⊩</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 bounded_byI nnegI sum_nonneg ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
      <span class="keyword1"><span class="command">from</span></span> leP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">y</span> <span class="main">*</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">»</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sP <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ht<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-distributivity›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sub_distrib</span> <span class="main">::</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_distrib</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-sub_distribI"><span class="command">lemma</span></span> sub_distribI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> sub_distrib <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_distrib_def<span class="main">)</span>
  
<span class="keyword1" id="Transformers-sub_distribI2"><span class="command">lemma</span></span> sub_distribI2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sub_distrib <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Transformers-sub_distribD"><span class="command">lemma</span></span> sub_distribD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sub_distrib <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="free">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_distrib_def<span class="main">)</span>

<span class="keyword1" id="Transformers-equiv_sub_distrib"><span class="command">lemma</span></span> equiv_sub_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sd<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib <span class="free">u</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP sd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD tminus_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity implies sub-distributivity:›</span></span>
<span class="keyword1" id="Transformers-sublinear_sub_distrib"><span class="command">lemma</span></span> sublinear_sub_distrib<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slt<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sublinearD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> slt<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Healthiness, sub-additivity and sub-distributivity imply
  sublinearity.  This is how we usually show sublinearity.›</span></span>
<span class="keyword1" id="Transformers-sd_sa_sublinear"><span class="command">lemma</span></span> sd_sa_sublinear<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdt<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> ht sP sQ nna nnb
  <span class="keyword1"><span class="command">have</span></span> saP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> staP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> sbQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> stbQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sc_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> sabPQ<span class="main">:</span>  <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> stabPQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_sum<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ht sP sQ nna nnb
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD healthy_scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> saP sbQ sat
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> notm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> z <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> stabPQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sabPQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>z notm<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> nz <span class="main">=</span> this
    <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword2"><span class="keyword">and</span></span> nnc <span class="keyword1"><span class="command">have</span></span> nni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inverse <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">=</span>
              inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sabPQ <span class="keyword2"><span class="keyword">and</span></span> nni
    <span class="keyword1"><span class="command">have</span></span> si<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sc_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sim<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> nz
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">=</span>
          <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> inverse <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
          <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> inverse <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>distrib_left tminus_left_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">=</span>
                   inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">divide_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nni <span class="keyword2"><span class="keyword">and</span></span> notm
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
            inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nni ht sabPQ
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ht<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
            <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> sdt si
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
              <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span>
            <span class="skolem">c</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> nnc <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnc ht sim
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>
          <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD healthy_scalingD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">+</span>
                       <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>distrib_left tminus_left_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> inverse <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span>
                            <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> inverse <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s'</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s'</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s'</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nz <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-conjunctivity›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sub_conj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_conj</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span>sound <span class="bound">P</span> <span class="main">∧</span> sound <span class="bound">Q</span><span class="main">)</span> <span class="main">⟶</span>
                       <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span> <span class="main">⊩</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-sub_conjI"><span class="command">lemma</span></span> sub_conjI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
           <span class="free">t</span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="free">t</span> <span class="bound">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sub_conj <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-sub_conjD"><span class="command">lemma</span></span> sub_conjD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sub_conj <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> sound <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Transformers-sub_conj_wp_twice"><span class="command">lemma</span></span> sub_conj_wp_twice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> all<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> sub_conj <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_conj <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="free">f</span> <span class="skolem">s</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> all <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sub_conj <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="skolem">s</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="free">f</span> <span class="skolem">s</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity implies sub-conjunctivity:›</span></span>
<span class="keyword1" id="Transformers-sublinear_sub_conj"><span class="command">lemma</span></span> sublinear_sub_conj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slt<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_conj <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span><span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sublinearD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> slt<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> b<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity under equivalence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity is preserved by equivalence.›</span></span>
<span class="keyword1" id="Transformers-equiv_sublinear"><span class="command">lemma</span></span> equiv_sublinear<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> equiv_trans <span class="free">t</span> <span class="free">u</span><span class="main">;</span> sublinear <span class="free">t</span><span class="main">;</span> healthy <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> sublinear <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sd_sa_sublinear healthy_equivI
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>equiv_sub_distrib equiv_sub_add
                  sublinear_sub_distrib sublinear_subadd
                  healthy_feasibleD<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Determinism›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Transformers which are both additive, and maximal among those that
satisfy feasibility are \emph{deterministic}, and will turn out to be maximal
in the refinement order.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additivity›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Full additivity is not generally satisfied.  It holds for
  (sub-)probabilistic transformers however.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">additive</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">additive</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span>sound <span class="bound">P</span> <span class="main">∧</span> sound <span class="bound">Q</span><span class="main">)</span> <span class="main">⟶</span>
                      <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-additiveD"><span class="command">lemma</span></span> additiveD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> additive <span class="free">t</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> sound <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">t</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">t</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>additive_def<span class="main">)</span>

<span class="keyword1" id="Transformers-additiveI"><span class="command">lemma</span></span> additiveI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> sound <span class="bound">P</span><span class="main">;</span> sound <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="free">t</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span>
   additive <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> additive_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Additivity is strictly stronger than sub-additivity.›</span></span>
<span class="keyword1" id="Transformers-additive_sub_add"><span class="command">lemma</span></span> additive_sub_add<span class="main">:</span>
  <span class="quoted"><span class="quoted">"additive <span class="free">t</span> <span class="main">⟹</span> sub_add <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sub_addI additiveD<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The additivity property extends to finite summation.›</span></span>
<span class="keyword1" id="Transformers-additive_sum"><span class="command">lemma</span></span> additive_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> additive<span class="main">:</span> <span class="quoted"><span class="quoted">"additive <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> healthy<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> finite<span class="main">:</span>   <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sPz<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> sound <span class="main">(</span><span class="free">P</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">T</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> finT<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">T</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> additive sPz
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">z</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">z</span><span class="main">)</span> <span class="bound">x</span> <span class="main">+</span>  <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum_sound additiveD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IH
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">z</span><span class="main">)</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">z</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">z</span><span class="main">)</span> <span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="skolem">T</span><span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="free">P</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹An additive transformer (over a finite state space) is linear: it is
  simply the weighted sum of final expectation values, the weights being the
  probability of reaching a given final state.  This is useful for reasoning
  using the forward, or ``gambling game'' interpretation.›</span></span>
<span class="keyword1" id="Transformers-additive_delta_split"><span class="command">lemma</span></span> additive_delta_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>finite <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> additive<span class="main">:</span> <span class="quoted"><span class="quoted">"additive <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum.cong<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">...</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum.delta<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> sound <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free">P</span> <span class="bound">z</span> <span class="main">*</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">za</span><span class="main">.</span> <span class="bound">za</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">»</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> additive_sum<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="bound">x</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ht<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span> <span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can group the states in the linear form, to split on the value
  of a predicate (guard).›</span></span>
<span class="keyword1" id="Transformers-additive_guard_split"><span class="command">lemma</span></span> additive_guard_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">::</span>finite <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> additive<span class="main">:</span> <span class="quoted"><span class="quoted">"additive <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span>   <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span>
                 <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> additive_delta_split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"UNIV <span class="main">=</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>UNIV<span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
           <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span>   <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span><span class="main">{</span><span class="bound">s</span><span class="main">.</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span><span class="main">}</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">»</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum.union_disjoint<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Maximality›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">maximal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">maximal</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">c</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Transformers-maximalI"><span class="command">lemma</span></span> maximalI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">c</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">c</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> maximal <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximal_def<span class="main">)</span>

<span class="keyword1" id="Transformers-maximalD"><span class="command">lemma</span></span> maximalD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maximal <span class="free">t</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟧</span>  <span class="main">⟹</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximal_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A transformer that is both additive and maximal is deterministic:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">determ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">determ</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> additive <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> maximal <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Transformers-determI"><span class="command">lemma</span></span> determI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> additive <span class="free">t</span><span class="main">;</span> maximal <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> determ <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>determ_def<span class="main">)</span>

<span class="keyword1" id="Transformers-determ_additiveD"><span class="command">lemma</span></span> determ_additiveD<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="free">t</span> <span class="main">⟹</span> additive <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>determ_def<span class="main">)</span>

<span class="keyword1" id="Transformers-determ_maximalD"><span class="command">lemma</span></span> determ_maximalD<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="free">t</span> <span class="main">⟹</span> maximal <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>determ_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For a fully-deterministic transformer, a transformed standard
  expectation, and its transformed negation are complementary.›</span></span>
<span class="keyword1" id="Transformers-determ_negate"><span class="command">lemma</span></span> determ_negate<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> determ<span class="main">:</span>  <span class="quoted"><span class="quoted">"determ <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="free">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="bound">s</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>additiveD determ determ_additiveD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="improper">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">P</span><span class="main">»</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD determ determ_maximalD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Modular Reasoning›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The emphasis of a mechanised logic is on automation, and letting
  the computer tackle the large, uninteresting problems.  However, as
  terms generally grow exponentially in the size of a program, it is
  still essential to break up a proof and reason in a modular fashion.

  The following rules allow proof decomposition, and later will be
  incorporated into a verification condition generator.›</span></span>

<span class="keyword1" id="Transformers-entails_combine"><span class="command">lemma</span></span> entails_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sc<span class="main">:</span>  <span class="quoted"><span class="quoted">"sub_conj <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span>  <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sS<span class="main">:</span>  <span class="quoted"><span class="quoted">"sound <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="free">R</span> <span class="main">&amp;&amp;</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wp1 <span class="keyword2"><span class="keyword">and</span></span> wp2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span> <span class="main">&amp;&amp;</span> <span class="free">t</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_frame<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sc <span class="keyword2"><span class="keyword">and</span></span> sR <span class="keyword2"><span class="keyword">and</span></span> sS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="free">R</span> <span class="main">&amp;&amp;</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_conjD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These allow mismatched results to be composed›</span></span>

<span class="keyword1" id="Transformers-entails_strengthen_post"><span class="command">lemma</span></span> entails_strengthen_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">Q</span><span class="main">;</span> healthy <span class="free">t</span><span class="main">;</span> sound <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">R</span><span class="main">;</span> sound <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_trans<span class="main">)</span>

<span class="keyword1" id="Transformers-entails_weaken_pre"><span class="command">lemma</span></span> entails_weaken_pre<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_trans<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This rule is unique to pGCL.  Use it to scale the post-expectation
        of a rule to 'fit under' the precondition you need to satisfy.›</span></span>
<span class="keyword1" id="Transformers-entails_scale"><span class="command">lemma</span></span> entails_scale<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword2"><span class="keyword">and</span></span> wp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">*</span> <span class="free">t</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sQ pos h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD healthy_scalingD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Transforming Standard Expectations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning with \emph{standard} expectations, those obtained
  by embedding a predicate, is often easier, as the analogues of
  many familiar boolean rules hold in modified form.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One may use a standard pre-expectation as an assumption:›</span></span>
<span class="keyword1" id="Transformers-use_premise"><span class="command">lemma</span></span> use_premise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> entailsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> wP <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> h <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The other direction works too.›</span></span>
<span class="keyword1" id="Transformers-fold_premise"><span class="command">lemma</span></span> fold_premise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> wp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Predicate conjunction behaves as expected:›</span></span>
<span class="keyword1" id="Transformers-conj_post"><span class="command">lemma</span></span> conj_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">∧</span> <span class="free">R</span> <span class="bound">s</span><span class="main">»</span><span class="main">;</span> healthy <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_strengthen_post implies_entails<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Similar to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> use_premise<span class="antiquote"><span class="antiquote">}</span></span></span></span>, but more general.›</span></span>
<span class="keyword1" id="Transformers-entails_pconj_assumption"><span class="command">lemma</span></span> entails_pconj_assumption<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">R</span> <span class="bound">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> entailsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_lone wP<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Induction">
<div class="head">
<h1>Theory Induction</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Induction"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Induction
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Expectations.html">Expectations</a> <a href="Transformers.html">Transformers</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:induction}›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Lattice of Expectations›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:exp_induct}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Defining recursive (or iterative) programs requires us to reason about
fixed points on the semantic objects, in this case expectations.  The
complication here, compared to the standard Knaster-Tarski theorem (for example,
as shown in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../../HOL/HOL/Inductive.html"></a><a href="../../HOL/HOL/Inductive.html">HOL.Inductive</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>), is that we do not have a complete lattice.

Finding a lower bound is easy (it's <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), but as we do not insist
on any global bound on expectations (and work directly in HOL's real type, rather
than extending it with a point at infinity), there is no top element.  We solve
the problem by defining the least (greatest) fixed point, restricted to an
internally-bounded set, allowing us to substitute this bound for the top element.
This works as long as the set contains at least one fixed point, which appears
as an extra assumption in all the theorems.

This also works semantically, thanks to the definition of healthiness.  Given a
healthy transformer parameterised by some sound expectation:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span><span class="main"><span class="main">::</span></span><span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⇒</span></span> <span class="main"><span class="main">(</span></span><span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real<span class="main"><span class="main">)</span></span> <span class="main"><span class="main">⇒</span></span> <span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  Imagine that we wish to find
the least fixed point of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  In practice, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is generally
doubly healthy, that is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">.</span></span> sound <span class="bound"><span class="bound">P</span></span> <span class="main"><span class="main">⟶</span></span> healthy <span class="main"><span class="main">(</span></span><span class="free"><span class="free">t</span></span> <span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">Q</span></span><span class="main"><span class="main">.</span></span> sound <span class="bound"><span class="bound">Q</span></span> <span class="main"><span class="main">⟶</span></span> healthy <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">t</span></span> <span class="bound"><span class="bound">P</span></span> <span class="bound"><span class="bound">Q</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  Thus by feasibility, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
must be bounded by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.  Thus, as by definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">t</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
for any fixed point, all must lie in the
set of sound expectations bounded above by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> bound_of <span class="free"><span class="free">P</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inf_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect set <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inf_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Inf <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Induction-Inf_exp_lower"><span class="command">lemma</span></span> Inf_exp_lower<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> nneg <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> Inf_exp <span class="free">S</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_exp_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_funI cInf_lower bdd_belowI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Induction-Inf_exp_greatest"><span class="command">lemma</span></span> Inf_exp_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">Q</span> <span class="main">≤</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">≤</span> Inf_exp <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_exp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_funI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cInf_greatest<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sup_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect set <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sup_exp</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Induction-Sup_exp_upper"><span class="command">lemma</span></span> Sup_exp_upper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> bounded_by <span class="free">b</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> Sup_exp <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_exp_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> le_funI cSup_upper bdd_aboveI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Induction-Sup_exp_least"><span class="command">lemma</span></span> Sup_exp_least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">Q</span><span class="main">;</span> nneg <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> Sup_exp <span class="free">S</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_exp_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_funI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cSup_least<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Induction-Sup_exp_sound"><span class="command">lemma</span></span> Sup_exp_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> sound <span class="bound">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> bounded_by <span class="free">b</span> <span class="bound">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_exp <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">intro</span> soundI2 bounded_byI2 nnegI2<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> Pin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sS bS <span class="keyword1"><span class="command">have</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> bS nb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="free">S</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_least<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Pin bS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> Sup_exp <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_exp <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lfp_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lfp_exp</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Inf_exp <span class="main">{</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">P</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Induction-lfp_exp_lowerbound"><span class="command">lemma</span></span> lfp_exp_lowerbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">P</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> lfp_exp <span class="free">t</span> <span class="main">≤</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lfp_exp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Inf_exp_lower<span class="main">)</span>

<span class="keyword1" id="Induction-lfp_exp_greatest"><span class="command">lemma</span></span> lfp_exp_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">≤</span> <span class="bound">P</span><span class="main">;</span> sound <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">≤</span> <span class="bound">P</span><span class="main">;</span> sound <span class="free">Q</span><span class="main">;</span> <span class="free">t</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">R</span><span class="main">;</span> sound <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">≤</span> lfp_exp <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lfp_exp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Inf_exp_greatest<span class="main">)</span>

<span class="keyword1" id="Induction-feasible_lfp_exp_sound"><span class="command">lemma</span></span> feasible_lfp_exp_sound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"feasible <span class="free">t</span> <span class="main">⟹</span> sound <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 bounded_byI2 nnegI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound lfp_exp_greatest<span class="main">)</span>

<span class="keyword1" id="Induction-lfp_exp_sound"><span class="command">lemma</span></span> lfp_exp_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fR sR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="free">t</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">R</span><span class="main">)</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fR sR <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_exp_bound"><span class="command">lemma</span></span> lfp_exp_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> bounded_by <span class="main">1</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound<span class="main">)</span>

<span class="keyword1" id="Induction-lfp_exp_unitary"><span class="command">lemma</span></span> lfp_exp_unitary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> unitary <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_exp_sound lfp_exp_bound<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_exp_lemma2"><span class="command">lemma</span></span> lfp_exp_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> lfp_exp <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_greatest<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ fR sR<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fR sR <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_sound st<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> fP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="free">t</span> <span class="main">⊩</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fP sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span> <span class="main">⊩</span> <span class="free">t</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mt<span class="main"><span class="main">]</span></span> lfp_exp_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> fP
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span> <span class="main">⊩</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_exp_lemma3"><span class="command">lemma</span></span> lfp_exp_lemma3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="free">t</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound lfp_exp_sound lfp_exp_lemma2 assms
                   mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mt<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Induction-lfp_exp_unfold"><span class="command">lemma</span></span> lfp_exp_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">R</span> <span class="main">⊩</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="free">t</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span>lfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym lfp_exp_lemma2 lfp_exp_lemma3 assms<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gfp_exp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gfp_exp</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Sup_exp <span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="bound">P</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Induction-gfp_exp_upperbound"><span class="command">lemma</span></span> gfp_exp_upperbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="free">P</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">≤</span> gfp_exp <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>gfp_exp_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_upper<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_exp_least"><span class="command">lemma</span></span> gfp_exp_least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">≤</span> <span class="free">Q</span><span class="main">;</span> unitary <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> gfp_exp <span class="free">t</span> <span class="main">≤</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_exp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_least<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_exp_bound"><span class="command">lemma</span></span> gfp_exp_bound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> bounded_by <span class="main">1</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_exp_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_exp_least<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Induction-gfp_exp_nneg"><span class="command">lemma</span></span> gfp_exp_nneg<span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nnegI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>gfp_exp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_exp <span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>empty Sup_exp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Qin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Qin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> Sup_exp <span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_exp <span class="main">{</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">∧</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-gfp_exp_unitary"><span class="command">lemma</span></span> gfp_exp_unitary<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> unitary <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_nneg gfp_exp_bound unitaryI2<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_exp_lemma2"><span class="command">lemma</span></span> gfp_exp_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="free">t</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_least<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_unitary ft<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
  <span class="keyword3"><span class="command">assume</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≤</span> gfp_exp <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_upperbound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP gfp_exp_unitary ft
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mt<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fp <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-gfp_exp_lemma3"><span class="command">lemma</span></span> gfp_exp_lemma3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span> <span class="main">≤</span> gfp_exp <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_upperbound unitary_sound
                   gfp_exp_unitary gfp_exp_lemma2 assms<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_exp_unfold"><span class="command">lemma</span></span> gfp_exp_unfold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟹</span>
   gfp_exp <span class="free">t</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span>gfp_exp <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym gfp_exp_lemma2 gfp_exp_lemma3<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Lattice of Transformers›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:trans_induct}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In addition to fixed points on expectations, we also need
to reason about fixed points on expectation transformers.  The
interpretation of a recursive program in pGCL is as a fixed
point of a function from transformers to transformers.  In contrast
to the case of expectations, \emph{healthy} transformers do form
a complete lattice, where the bottom element is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
and the top element is the greatest allowed by feasibility:
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="main"><span class="bound"><span class="main"><span class="bound">_</span></span></span></span><span class="main"><span class="main">.</span></span> bound_of <span class="bound"><span class="bound">P</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inf_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans set <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inf_trans</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> Inf_exp <span class="main">{</span><span class="bound">t</span> <span class="bound">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Induction-Inf_trans_lower"><span class="command">lemma</span></span> Inf_trans_lower<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span>Inf_trans <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_trans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Inf_exp_lower<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Induction-Inf_trans_greatest"><span class="command">lemma</span></span> Inf_trans_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> le_trans <span class="free">u</span> <span class="bound">t</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">u</span> <span class="main">(</span>Inf_trans <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Inf_exp_greatest<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Sup_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans set <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sup_trans</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span><span class="main">.</span> Sup_exp <span class="main">{</span><span class="bound">t</span> <span class="bound">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Induction-Sup_trans_upper"><span class="command">lemma</span></span> Sup_trans_upper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="main">(</span>Sup_trans <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_utransI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_exp_upper<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>unitary_bound<span class="main">)</span>

<span class="keyword1" id="Induction-Sup_trans_upper2"><span class="command">lemma</span></span> Sup_trans_upper2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>nneg <span class="bound">P</span> <span class="main">∧</span> bounded_by <span class="free">b</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     nneg <span class="free">P</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="free">P</span> <span class="main">⊩</span> Sup_trans <span class="free">S</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_upper<span class="main">)</span>

<span class="keyword1" id="Induction-Sup_trans_least"><span class="command">lemma</span></span> Sup_trans_least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> le_utrans <span class="bound">t</span> <span class="free">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span>Sup_trans <span class="free">S</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_nneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> unitary_sound<span class="main"><span class="main">]</span></span> le_utransI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_exp_least<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Induction-Sup_trans_least2"><span class="command">lemma</span></span> Sup_trans_least2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> nneg <span class="bound">P</span> <span class="main">⟶</span> bounded_by <span class="free">b</span> <span class="bound">P</span> <span class="main">⟶</span> <span class="bound">t</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">u</span> <span class="bound">P</span><span class="main">;</span>
     <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>nneg <span class="bound">P</span> <span class="main">∧</span> bounded_by <span class="free">b</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     nneg <span class="free">P</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="free">P</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> nneg <span class="bound">P</span><span class="main">;</span> bounded_by <span class="free">b</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> nneg <span class="main">(</span><span class="free">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> Sup_trans <span class="free">S</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">u</span> <span class="free">P</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>Sup_exp_least<span class="main">)</span>

<span class="keyword1" id="Induction-feasible_Sup_trans"><span class="command">lemma</span></span> feasible_Sup_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> feasible <span class="bound">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>Sup_trans <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def Sup_exp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> feasibleI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> neS <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> tin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fS <span class="keyword1"><span class="command">have</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bP nP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bP nP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> tin fS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="skolem">P</span> <span class="main">⊩</span> Sup_trans <span class="free">S</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>Sup_trans_upper2<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>Sup_trans <span class="free">S</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> fS bP nP
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>Sup_trans <span class="free">S</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>bounded_byI2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_least2<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lfp_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lfp_trans</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> Inf_trans <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> le_trans <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="bound">t</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Induction-lfp_trans_lowerbound"><span class="command">lemma</span></span> lfp_trans_lowerbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="free">t</span><span class="main">)</span> <span class="free">t</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lfp_trans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Inf_trans_lower<span class="main">)</span>

<span class="keyword1" id="Induction-lfp_trans_greatest"><span class="command">lemma</span></span> lfp_trans_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="bound">t</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="free">u</span> <span class="bound">t</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span>
   le_trans <span class="free">u</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lfp_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> Inf_trans_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Induction-lfp_trans_sound"><span class="command">lemma</span></span> lfp_trans_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 bounded_byI2 nnegI2<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> fv sv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_trans_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">v</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sv sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">v</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="main">(</span><span class="free">v</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="main">(</span><span class="free">v</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> lfp_trans_greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="bound">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">v</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sv<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> fv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> lfp_trans <span class="free">T</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_trans_unitary"><span class="command">lemma</span></span> lfp_trans_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fT<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> unitaryI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uP<span class="main">]</span> fv sv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_trans_sound<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI2<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fT <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lfp_trans_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_trans_lemma2"><span class="command">lemma</span></span> lfp_trans_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> sound <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span>   <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_trans_greatest<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> T<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">T</span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> v<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_trans_lowerbound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ft st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mono lfp_trans_sound fv sv<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> ft
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_trans_lemma3"><span class="command">lemma</span></span> lfp_trans_lemma3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> sound <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span>   <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_trans_lowerbound<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_trans_sound fv sv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword1"><span class="command">have</span></span> n2<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_trans_sound fv sv sT<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> n1 sP <span class="keyword3"><span class="command">show</span></span> n3<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sT<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_trans_lemma2<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assms lfp_trans_sound<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_trans_unfold"><span class="command">lemma</span></span> lfp_trans_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> sound <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span>   <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_trans_antisym<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> lfp_trans_lemma3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> lfp_trans_lemma2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gfp_trans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gfp_trans</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> Sup_trans <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> le_utrans <span class="bound">t</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Induction-gfp_trans_upperbound"><span class="command">lemma</span></span> gfp_trans_upperbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> le_utrans <span class="free">t</span> <span class="main">(</span><span class="free">T</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_trans_upper<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_trans_least"><span class="command">lemma</span></span> gfp_trans_least<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="bound">t</span> <span class="free">u</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   le_utrans <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span> <span class="free">u</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_trans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_trans_least<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_trans_unitary"><span class="command">lemma</span></span> gfp_trans_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>gfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI2 bounded_byI2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_trans_def Sup_trans_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Sup_exp_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="free">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?S</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span> <span class="free">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> le_utrans <span class="bound">t</span> <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> gfp_trans <span class="free">T</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gfp_trans_def Sup_trans_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_exp <span class="var">?S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>empty Sup_exp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> Qin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">∈</span> <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> uP Qin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> Sup_exp <span class="var">?S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> Sup_exp_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="skolem">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_exp <span class="var">?S</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-gfp_trans_lemma2"><span class="command">lemma</span></span> gfp_trans_lemma2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> unitary <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_trans_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>hT gfp_trans_unitary<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
  <span class="keyword3"><span class="command">assume</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="main">(</span><span class="free">T</span> <span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> fp
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> fp ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span>"</span></span><span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gfp_trans_upperbound<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> ht gfp_trans_unitary
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span><span class="free">T</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-gfp_trans_lemma3"><span class="command">lemma</span></span> gfp_trans_lemma3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> unitary <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mono gfp_trans_unitary gfp_trans_upperbound gfp_trans_lemma2 mono hT<span class="main">)</span>

<span class="keyword1" id="Induction-gfp_trans_unfold"><span class="command">lemma</span></span> gfp_trans_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                         <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> unitary <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_utrans_antisym gfp_trans_lemma2 gfp_trans_lemma3<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Tail Recursion›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:tail}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The least (greatest) fixed point of a tail-recursive expression on transformers is
equivalent (given appropriate side conditions) to the least (greatest) fixed point on
expectations.›</span></span>

<span class="keyword1" id="Induction-gfp_pulldown"><span class="command">lemma</span></span> gfp_pulldown<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tailcall<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> <span class="free">T</span> <span class="bound">u</span> <span class="bound">P</span> <span class="main">=</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fT<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> unitary <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ft<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> unitary <span class="bound">R</span><span class="main">;</span> <span class="bound">Q</span> <span class="main">⊩</span> <span class="bound">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="bound">P</span> <span class="bound">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span>        <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> monoT<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                              <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">=</span> gfp_exp <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">P</span> <span class="main">=</span> <span class="var">?Y</span> <span class="free">P</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">P</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_upperbound<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> monoT fT uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_utransD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gfp_trans_lemma2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span> <span class="main">(</span>gfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="free">t</span> <span class="free">P</span> <span class="main">(</span>gfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tailcall<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">P</span> <span class="main">(</span>gfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP gfp_trans_unitary <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>gfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="free">P</span> <span class="main">≤</span> <span class="var">?X</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_utransD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gfp_trans_upperbound<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_utransI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> unitary <span class="bound">R</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span> <span class="bound">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> mt<span class="main">[</span><span class="operator">OF</span> uQ<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span> <span class="skolem">Q</span> <span class="main">(</span>gfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_unfold<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tailcall<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">≤</span> <span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> gfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> unitary <span class="bound">R</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span> <span class="bound">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>gfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_unitary<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Induction-lfp_pulldown"><span class="command">lemma</span></span> lfp_pulldown<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">T</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tailcall<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">T</span> <span class="bound">u</span> <span class="bound">P</span> <span class="main">=</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> mt<span class="main">:</span>        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> mono_trans <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> monoT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nT<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">Q</span><span class="main">)</span><span class="main">;</span> sound <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">T</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fv<span class="main">:</span>   <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="free">v</span><span class="main">)</span> <span class="free">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sv<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span>   <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="free">T</span> <span class="free">P</span> <span class="main">=</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">P</span> <span class="main">=</span> <span class="var">?Y</span> <span class="free">P</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="free">P</span> <span class="main">≤</span> <span class="var">?X</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tailcall<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">T</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="main">≤</span> <span class="main">(</span>lfp_trans <span class="free">T</span><span class="main">)</span> <span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_trans_lemma2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> monoT<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="free">P</span> <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span> <span class="main">≤</span> lfp_trans <span class="free">T</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_trans <span class="free">T</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_trans_sound assms<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">v</span> <span class="bound">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tailcall<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="main">...</span> <span class="bound">P</span> <span class="main">⊩</span> <span class="free">v</span> <span class="bound">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fv<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> fvP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⊩</span> <span class="free">v</span> <span class="bound">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> svP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">v</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sv<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">P</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_trans_lowerbound<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ _ sP<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>

      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">=</span> <span class="free">t</span> <span class="skolem">P</span> <span class="main">(</span>lfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tailcall<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">(</span>lfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lfp_exp_unfold<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sP st mt fvP svP<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fvP svP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_exp <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Inf_utrans</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans set <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inf_utrans</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="keyword1">else</span> Inf_trans <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Induction-Inf_utrans_lower"><span class="command">lemma</span></span> Inf_utrans_lower<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">t</span> <span class="main">∈</span> <span class="free">S</span><span class="main">;</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span>Inf_utrans <span class="free">S</span><span class="main">)</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_utrans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_utransI Inf_exp_lower sound_nneg unitary_sound
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Inf_trans_def<span class="main">)</span>

<span class="keyword1" id="Induction-Inf_utrans_greatest"><span class="command">lemma</span></span> Inf_utrans_greatest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> le_utrans <span class="free">t</span> <span class="bound">u</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="free">t</span> <span class="main">(</span>Inf_utrans <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Inf_utrans_def Inf_trans_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_utransI Inf_exp_greatest<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Embedding">
<div class="head">
<h1>Theory Embedding</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"A Shallow Embedding of pGCL in HOL"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Embedding <span class="keyword2"><span class="keyword">imports</span></span> <a href="Misc.html">Misc</a> <a href="Induction.html">Induction</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Core Primitives and Syntax›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:syntax}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A pGCL program is embedded directly as its strict or liberal transformer.  This is
achieved with an additional parameter, specifying which semantics should be obeyed.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'s</span> prog <span class="main">=</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Abort</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> either always fails, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">P</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or always succeeds,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">P</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">1</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Abort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Abort</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">ab</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">1</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Skip</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> does nothing at all.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Skip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Skip</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">P</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Apply</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> lifts a state transformer into the space of programs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Apply</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Seq</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is sequential composition.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
                 <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;;</span>"</span> 59<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Seq</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">ab</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ab</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">PC</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{probabilistic} choice between programs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
                 <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⇘</span>_<span class="keyword1">⇙⊕</span> _"</span> <span class="main">[</span>58<span class="main">,</span>57<span class="main">,</span>57<span class="main">]</span> 57<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">PC</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span>"</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">DC</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{demonic} choice between programs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⨅</span> _"</span> <span class="main">[</span>58<span class="main">,</span>57<span class="main">]</span> 57<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">DC</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> min <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">AC</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{angelic} choice between programs.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">AC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">⨆</span> _"</span> <span class="main">[</span>58<span class="main">,</span>57<span class="main">]</span> 57<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">AC</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> max <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">ab</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Embed</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> allows any expectation transformer to be treated
  syntactically as a program, by ignoring the failure flag.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Embed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Embed</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Mu</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the recursive primitive, and is either then
  least or greatest fixed point.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Mu</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">binder</span></span> <span class="quoted">"<span class="keyword1">μ</span>"</span> 50<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="free">Mu</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span><span class="main">)</span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">ab</span> <span class="keyword1">then</span> lfp_trans <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>Embed <span class="bound">t</span><span class="main">)</span> <span class="bound">ab</span><span class="main">)</span>
                               <span class="keyword1">else</span> gfp_trans <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>Embed <span class="bound">t</span><span class="main">)</span> <span class="bound">ab</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">repeat</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> expresses finite repetition›</span></span>
<span class="keyword1"><span class="command">primrec</span></span>
  <span class="entity">repeat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> prog <span class="main">⇒</span> <span class="tfree">'a</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> Skip"</span></span> <span class="main">|</span>
  <span class="quoted"><span class="quoted">"<span class="free">repeat</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">;;</span> <span class="free">repeat</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">SetDC</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is demonic choice between a set of alternatives,
  which may depend on the state.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">SetDC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">SetDC</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_SetDC"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword1">⨅</span>_<span class="keyword1">∈</span>_<span class="keyword1">.</span><span class="keyword3">/ </span>_"</span> 100<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="main">⨅</span><span class="free">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">p</span>"</span> <span class="main">==</span> <span class="quoted">"<span class="keyword1">CONST</span> SetDC <span class="main">(</span><span class="main">%</span><span class="free">x</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span> <span class="free">S</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The above syntax allows us to write <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⨅</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">∈</span></span><span class="free"><span class="free">S</span></span><span class="main"><span class="main">.</span></span> Apply <span class="free"><span class="free">f</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">SetPC</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is \emph{probabilistic} choice from a set.  Note that this is only
meaningful for distributions of finite support.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">SetPC</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">SetPC</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Bind</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> allows us to name an expression in the current state, and re-use it later.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">Bind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">Bind</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">ab</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="free"><span class="bound"><span class="entity">ab</span></span></span> <span class="bound">P</span> <span class="bound">s</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This gives us something like let syntax›</span></span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_Bind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span>
       <span class="main">(</span><span class="quoted">"_ <span class="keyword1">is</span> _ <span class="keyword1">in</span> _"</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span>55<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="free">x</span> <span class="keyword1">is</span> <span class="free">f</span> <span class="keyword1">in</span> <span class="free">a</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="keyword1">CONST</span> Bind <span class="free">f</span> <span class="main">(</span><span class="main">%</span><span class="free">x</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">flip</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span> <span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following pair of translations introduce let-style syntax
  for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SetPC</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">SetDC</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, respectively.›</span></span>
<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_PBind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> real<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword1">bind</span> _ <span class="keyword1">at</span> _ <span class="keyword1">in</span> _"</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span>55<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">bind</span> <span class="free">x</span> <span class="keyword1">at</span> <span class="free">p</span> <span class="keyword1">in</span> <span class="free">a</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="keyword1">CONST</span> SetPC <span class="main">(</span><span class="main">%</span><span class="free">x</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">CONST</span> flip <span class="main">(</span><span class="main">%</span><span class="free">x</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span>

<span class="keyword1"><span class="command">syntax</span></span> <span class="quoted">"_DBind"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"pttrn <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span>
                   <span class="main">(</span><span class="quoted">"<span class="keyword1">bind</span> _ <span class="keyword1">from</span> _ <span class="keyword1">in</span> _"</span> <span class="main">[</span>55<span class="main">,</span>55<span class="main">,</span>55<span class="main">]</span>55<span class="main">)</span>
<span class="keyword1"><span class="command">translations</span></span> <span class="quoted">"<span class="keyword1">bind</span> <span class="free">x</span> <span class="keyword1">from</span> <span class="free">S</span> <span class="keyword1">in</span> <span class="free">a</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"<span class="keyword1">CONST</span> SetDC <span class="main">(</span><span class="main">%</span><span class="free">x</span><span class="main">.</span> <span class="free">a</span><span class="main">)</span> <span class="free">S</span>"</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following syntax translations are for convenience when
  using a record as the state type.›</span></span>
<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_assign"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:=</span> _"</span> <span class="main">[</span>1000<span class="main">,</span>900<span class="main">]</span>900<span class="main">)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">assign_tr</span> <span class="main">_</span> <span class="main">[</span>Const <span class="main">(</span><span class="entity">name</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">arg</span><span class="main">]</span> <span class="main">=</span>
      Const <span class="main">(</span><span class="inner_quoted">"Embedding.Apply"</span><span class="main">,</span> dummyT<span class="main">)</span> $
      Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span>
           Syntax.const <span class="main">(</span>suffix <span class="entity">Record.updateN</span> <span class="entity">name</span><span class="main">)</span> $
           Abs <span class="main">(</span>Name.uu_<span class="main">,</span> dummyT<span class="main">,</span> <span class="entity">arg</span> $ Bound <span class="inner_numeral">1</span><span class="main">)</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span>
    <span class="main">|</span> <span class="entity">assign_tr</span> <span class="main">_</span> <span class="entity">ts</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"assign_tr"</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span>
›</span>
<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_assign"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">assign_tr</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_SetPC"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> <span class="main">=&gt;</span> real<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span>
              <span class="main">(</span><span class="quoted">"<span class="keyword1">choose</span> _ <span class="keyword1">at</span> _"</span> <span class="main">[</span>66<span class="main">,</span>66<span class="main">]</span>66<span class="main">)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_pc_tr</span> <span class="main">_</span> <span class="main">[</span>Const <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">P</span><span class="main">]</span> <span class="main">=</span>
      Const <span class="main">(</span><span class="inner_quoted">"SetPC"</span><span class="main">,</span> dummyT<span class="main">)</span> $
      Abs <span class="main">(</span><span class="inner_quoted">"v"</span><span class="main">,</span> dummyT<span class="main">,</span>
           <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Embedding.Apply"</span><span class="main">,</span> dummyT<span class="main">)</span> $
            Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span>
                 Syntax.const <span class="main">(</span>suffix <span class="entity">Record.updateN</span> <span class="entity">f</span><span class="main">)</span> $
                 Abs <span class="main">(</span>Name.uu_<span class="main">,</span> dummyT<span class="main">,</span> Bound <span class="inner_numeral">2</span><span class="main">)</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> $
      <span class="entity">P</span>
    <span class="main">|</span> <span class="entity">set_pc_tr</span> <span class="main">_</span> <span class="entity">ts</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"set_pc_tr"</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span>
›</span>
<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_SetPC"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">set_pc_tr</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_set_dc"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">=&gt;</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">=&gt;</span> <span class="tfree">'a</span> set<span class="main">)</span> <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="quoted">"_ <span class="keyword1">:∈</span> _"</span> <span class="main">[</span>66<span class="main">,</span>66<span class="main">]</span>66<span class="main">)</span>
<span class="keyword1"><span class="command">ML</span></span> <span class="quoted">‹
  <span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">set_dc_tr</span> <span class="main">_</span> <span class="main">[</span>Const <span class="main">(</span><span class="entity">f</span><span class="main">,</span><span class="main">_</span><span class="main">)</span><span class="main">,</span> <span class="entity">S</span><span class="main">]</span> <span class="main">=</span>
      Const <span class="main">(</span><span class="inner_quoted">"SetDC"</span><span class="main">,</span> dummyT<span class="main">)</span> $
      Abs <span class="main">(</span><span class="inner_quoted">"v"</span><span class="main">,</span> dummyT<span class="main">,</span>
           <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Embedding.Apply"</span><span class="main">,</span> dummyT<span class="main">)</span> $
            Abs <span class="main">(</span><span class="inner_quoted">"s"</span><span class="main">,</span> dummyT<span class="main">,</span>
                 Syntax.const <span class="main">(</span>suffix <span class="entity">Record.updateN</span> <span class="entity">f</span><span class="main">)</span> $
                 Abs <span class="main">(</span>Name.uu_<span class="main">,</span> dummyT<span class="main">,</span> Bound <span class="inner_numeral">2</span><span class="main">)</span> $ Bound <span class="inner_numeral">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> $
      <span class="entity">S</span>
    <span class="main">|</span> <span class="entity">set_dc_tr</span> <span class="main">_</span> <span class="entity">ts</span> <span class="main">=</span> <span class="keyword3"><span class="keyword">raise</span></span> TERM <span class="main">(</span><span class="inner_quoted">"set_dc_tr"</span><span class="main">,</span> <span class="entity">ts</span><span class="main">)</span>
›</span>
<span class="keyword1"><span class="command">parse_translation</span></span> <span class="quoted">‹<span class="main">[</span><span class="main">(</span><span class="antiquoted"><span class="antiquote">@{</span><span class="operator">syntax_const</span> "_set_dc"<span class="antiquote">}</span></span><span class="main">,</span> <span class="entity">set_dc_tr</span><span class="main">)</span><span class="main">]</span>›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These definitions instantiate the embedding as either
        weakest precondition (True) or weakest liberal precondition
        (False).›</span></span>

<span class="keyword1"><span class="command">syntax</span></span>
  <span class="quoted">"_set_dc_UNIV"</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ident <span class="main">=&gt;</span> <span class="tfree">'s</span> prog"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">any</span> _"</span> <span class="main">[</span>66<span class="main">]</span>66<span class="main">)</span>

<span class="keyword1"><span class="command">translations</span></span>
  <span class="quoted">"_set_dc_UNIV <span class="free">x</span>"</span> <span class="main">=&gt;</span> <span class="quoted">"_set_dc <span class="free">x</span> <span class="main">(</span><span class="main">%</span><span class="main">_</span><span class="main">.</span> <span class="keyword1">CONST</span> UNIV<span class="main">)</span>"</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wp</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> True"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wlp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wlp</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">pr</span></span></span> False"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If-Then-Else as a degenerate probabilistic choice.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span><span class="main">(</span>input<span class="main">)</span>
  <span class="entity">if_then_else</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">,</span> <span class="tfree">'s</span> prog<span class="main">,</span> <span class="tfree">'s</span> prog<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
      <span class="main">(</span><span class="quoted">"<span class="keyword1">If</span> _ <span class="keyword1">Then</span> _ <span class="keyword1">Else</span> _"</span> 58<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">If</span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1"><span class="free">Then</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1"><span class="free">Else</span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">==</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="hidden">⇘</span><sub><span class="main">«</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">»</span></sub><span class="hidden">⇙</span>⊕ <span class="free"><span class="bound"><span class="entity">b</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Syntax for loops›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span>
  <span class="entity">do_while</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">,</span> <span class="tfree">'s</span> prog<span class="main">]</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
              <span class="main">(</span><span class="quoted">"<span class="keyword1">do</span> _ <span class="keyword1">⟶</span><span class="keyword3">//</span> <span class="keyword3">(4</span> _<span class="keyword3">)</span> <span class="keyword3">//</span><span class="keyword1">od</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">do_while</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">If</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="keyword1">Then</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">;;</span> <span class="bound">x</span> <span class="keyword1">Else</span> Skip"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unfolding rules for non-recursive primitives›</span></span>

<span class="keyword1" id="Embedding-eval_wp_Abort"><span class="command">lemma</span></span> eval_wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp Abort <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Abort_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Abort"><span class="command">lemma</span></span> eval_wlp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp Abort <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Abort_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Skip"><span class="command">lemma</span></span> eval_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp Skip <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Skip_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Skip"><span class="command">lemma</span></span> eval_wlp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp Skip <span class="free">P</span> <span class="main">=</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Skip_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Apply"><span class="command">lemma</span></span> eval_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Apply_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Apply"><span class="command">lemma</span></span> eval_wlp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="free">P</span> <span class="keyword1">o</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Apply_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Seq"><span class="command">lemma</span></span> eval_wp_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> wp <span class="free">b</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Seq_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Seq"><span class="command">lemma</span></span> eval_wlp_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span>wlp <span class="free">a</span> <span class="keyword1">o</span> wlp <span class="free">b</span><span class="main">)</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Seq_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_PC"><span class="command">lemma</span></span> eval_wp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">Q</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def PC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_PC"><span class="command">lemma</span></span> eval_wlp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">Q</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def PC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_DC"><span class="command">lemma</span></span> eval_wp_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def DC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_DC"><span class="command">lemma</span></span> eval_wlp_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wlp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def DC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_AC"><span class="command">lemma</span></span> eval_wp_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> max <span class="main">(</span>wp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def AC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_AC"><span class="command">lemma</span></span> eval_wlp_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> max <span class="main">(</span>wlp <span class="free">a</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def AC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Embed"><span class="command">lemma</span></span> eval_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Embed_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Embed"><span class="command">lemma</span></span> eval_wlp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Embed_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_SetDC"><span class="command">lemma</span></span> eval_wp_SetDC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="free">R</span> <span class="free">s</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def SetDC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_SetDC"><span class="command">lemma</span></span> eval_wlp_SetDC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="free">R</span> <span class="free">s</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="free">R</span> <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def SetDC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_SetPC"><span class="command">lemma</span></span> eval_wp_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def SetPC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_SetPC"><span class="command">lemma</span></span> eval_wlp_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def SetPC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Mu"><span class="command">lemma</span></span> eval_wp_Mu<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">t</span><span class="main">.</span> <span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> lfp_trans <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> wp <span class="main">(</span><span class="free">T</span> <span class="main">(</span>Embed <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Mu_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Mu"><span class="command">lemma</span></span> eval_wlp_Mu<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">t</span><span class="main">.</span> <span class="free">T</span> <span class="bound">t</span><span class="main">)</span> <span class="main">=</span> gfp_trans <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">T</span> <span class="main">(</span>Embed <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Mu_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wp_Bind"><span class="command">lemma</span></span> eval_wp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>Bind <span class="free">g</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> wp <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Bind_def wp_def Let_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Embedding-eval_wlp_Bind"><span class="command">lemma</span></span> eval_wlp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>Bind <span class="free">g</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Bind_def wlp_def Let_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use simp add:wp\_eval to fully unfold a program fragment›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> wp_eval <span class="main">=</span> eval_wp_Abort eval_wlp_Abort eval_wp_Skip eval_wlp_Skip
                 eval_wp_Apply eval_wlp_Apply eval_wp_Seq eval_wlp_Seq
                 eval_wp_PC eval_wlp_PC eval_wp_DC eval_wlp_DC
                 eval_wp_AC eval_wlp_AC
                 eval_wp_Embed eval_wlp_Embed eval_wp_SetDC eval_wlp_SetDC
                 eval_wp_SetPC eval_wlp_SetPC eval_wp_Mu eval_wlp_Mu
                 eval_wp_Bind eval_wlp_Bind

<span class="keyword1" id="Embedding-Skip_Seq"><span class="command">lemma</span></span> Skip_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Skip <span class="main">;;</span> <span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Skip_def Seq_def o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1" id="Embedding-Seq_Skip"><span class="command">lemma</span></span> Seq_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">;;</span> Skip <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Skip_def Seq_def o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use these as simp rules to clear out Skips›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> skip_simps <span class="main">=</span> Skip_Seq Seq_Skip

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Healthiness">
<div class="head">
<h1>Theory Healthiness</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Healthiness›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Healthiness <span class="keyword2"><span class="keyword">imports</span></span> <a href="Embedding.html">Embedding</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Healthiness of the Embedding›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Healthiness is mostly derived by structural induction using
  the simplifier.  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abort</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Skip</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Apply</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  form base cases.›</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_Abort"><span class="command">lemma</span></span> healthy_wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp Abort<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> healthy_parts<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp Abort <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp Abort <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> expect"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp Abort <span class="skolem">P</span> <span class="main">⊩</span> wp Abort <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> wp Abort <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span> wp Abort <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Abort"><span class="command">lemma</span></span> nearly_healthy_wlp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp Abort<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nearly_healthyI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp Abort <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wlp Abort <span class="skolem">P</span> <span class="main">⊩</span> wlp Abort <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_Skip"><span class="command">lemma</span></span> healthy_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_parts <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Skip"><span class="command">lemma</span></span> nearly_healthy_wlp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Healthiness-healthy_wp_Seq"><span class="command">lemma</span></span> healthy_wp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hu<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">t</span> <span class="main">;;</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> healthy_parts<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">u</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">u</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword2"><span class="keyword">and</span></span> hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> wp <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="free">u</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> hu <span class="keyword2"><span class="keyword">and</span></span> pos <span class="keyword2"><span class="keyword">and</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> wp <span class="free">t</span> <span class="main">(</span>wp <span class="free">u</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Seq"><span class="command">lemma</span></span> nearly_healthy_wlp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">u</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hu<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">t</span> <span class="main">;;</span> <span class="free">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nearly_healthyI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">t</span> <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">u</span> <span class="skolem">P</span> <span class="main">⊩</span> wlp <span class="free">u</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">t</span> <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">t</span> <span class="main">(</span>wlp <span class="free">u</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_PC"><span class="command">lemma</span></span> healthy_wp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Non-negative:›</span></span>
  <span class="keyword1"><span class="command">from</span></span> nQ <span class="keyword2"><span class="keyword">and</span></span> bQ <span class="keyword2"><span class="keyword">and</span></span> hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> nQ <span class="keyword2"><span class="keyword">and</span></span> bQ <span class="keyword2"><span class="keyword">and</span></span> hg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">...</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> healthy_nnegD2 mult_nonneg_nonneg nneg_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_nonneg_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Bounded:›</span></span>
  <span class="keyword1"><span class="command">from</span></span> nQ bQ hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP nQ bQ hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> nQ bQ hg uP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> nQ bQ hg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mult_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
                   <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Monotonic:›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sQ sR le hg
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
                   <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Scaling:›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
        <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span>  <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hf hg sQ pos
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_PC"><span class="command">lemma</span></span> nearly_healthy_wlp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">g</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">f</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 nnegI bounded_byI le_funI<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ hf hg <span class="keyword1"><span class="command">have</span></span> utQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> nnP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> utQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> utQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nnP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> nnP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uQ uR le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hg<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nnP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
                   <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">f</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">g</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_DC"><span class="command">lemma</span></span> healthy_wp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="main">⨅</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nP bP assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> mf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mg<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> mf<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> mg<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"scaling <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"scaling <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                 min <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> pos
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> min <span class="main">(</span>wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf<span class="main"><span class="main">]</span></span> scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                min <span class="main">(</span>wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_DC"><span class="command">lemma</span></span> nearly_healthy_wlp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">f</span> <span class="main">⨅</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI bounded_byI nnegI le_funI unitaryI2<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hf hg <span class="keyword1"><span class="command">have</span></span> utP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> utP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uP uQ le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uP uQ le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_AC"><span class="command">lemma</span></span> healthy_wp_AC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="main">⨆</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bP nP hg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nP bP assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> mf<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mg<span class="main">:</span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> mf<span class="main"><span class="main">]</span></span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> mg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sf<span class="main">:</span> <span class="quoted"><span class="quoted">"scaling <span class="main">(</span>wp <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sg<span class="main">:</span> <span class="quoted"><span class="quoted">"scaling <span class="main">(</span>wp <span class="free">g</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                 max <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> pos
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sf<span class="main"><span class="main">]</span></span> scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> max <span class="main">(</span>wp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                max <span class="main">(</span>wp <span class="free">f</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">g</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_AC"><span class="command">lemma</span></span> nearly_healthy_wlp_AC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hf<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hg<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">f</span> <span class="main">⨆</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI bounded_byI nnegI unitaryI2 le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uP hg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> uP hf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> max <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hf<span class="main"><span class="main">]</span></span>
                  le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hg<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">(</span>wlp <span class="free">f</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">g</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_Embed"><span class="command">lemma</span></span> healthy_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="free">t</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_def Embed_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Embed"><span class="command">lemma</span></span> nearly_healthy_wlp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nearly_healthy <span class="free">t</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wlp_def Embed_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Healthiness-healthy_wp_repeat"><span class="command">lemma</span></span> healthy_wp_repeat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h_a<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_wp_Seq h_a<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_repeat"><span class="command">lemma</span></span> nearly_healthy_wlp_repeat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h_a<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nearly_healthy_wlp_Seq h_a<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_SetDC"><span class="command">lemma</span></span> healthy_wp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prog</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> healthy<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">prog</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"healthy <span class="var">?T</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> healthy
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword2"><span class="keyword">and</span></span> healthy <span class="keyword2"><span class="keyword">and</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword2"><span class="keyword">and</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> healthy
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> healthy
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bexI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword2"><span class="keyword">and</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> sQ <span class="keyword2"><span class="keyword">and</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ain <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
        Inf <span class="main">(</span><span class="main">(*)</span> <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">=</span> <span class="var">?V</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?U</span> <span class="main">≤</span> <span class="var">?V</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cInf_greatest<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(*)</span> <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(*)</span> <span class="skolem">c</span> <span class="main">`</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rwx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower<span class="main"><span class="main">[</span></span><span class="operator">OF</span> yin<span class="main"><span class="main">]</span></span> bdd_belowI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> zin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>healthy<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> pos rwx <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?V</span> <span class="main">≤</span> <span class="var">?U</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> cz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">xa</span><span class="main">∈</span><span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">xa</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>image_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">a</span><span class="main">∈</span><span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> cINF_greatest<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_below <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bdd_belowI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rwz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> healthy<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> pos <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rwz <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_nonneg_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">INF</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> cINF_lower<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">prog</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_div_mono_left pos<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span> <span class="main">*</span> <span class="var">?V</span> <span class="main">≤</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="var">?U</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="var">?V</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="var">?U</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult.assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> pos <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span>image_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_SetDC"><span class="command">lemma</span></span> nearly_healthy_wlp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">prog</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> healthy<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>SetDC <span class="free">prog</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="var">?T</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP healthy
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> unitary <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin healthy uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">from</span></span> xin uP healthy
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>unitary_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_unitaryD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ uP<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
             <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP healthy
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> unitary <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bexI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP uQ le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> healthy<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> ain<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ain <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">prog</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_SetPC"><span class="command">lemma</span></span> healthy_wp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> healthy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sound <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sub_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"healthy <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> bP <span class="keyword2"><span class="keyword">and</span></span> healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>healthy_bounded_byD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bP <span class="keyword2"><span class="keyword">and</span></span> nP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> sub_dist <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sum_nonneg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_nonneg_nonneg<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> healthy
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> s_P<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> s_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_distrib_left <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword2"><span class="keyword">and</span></span> pos <span class="keyword2"><span class="keyword">and</span></span> healthy
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_SetPC"><span class="command">lemma</span></span> nearly_healthy_wlp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> healthy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sound <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sub_dist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 bounded_byI nnegI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> uP healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> unitary <span class="main">(</span>wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sound <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> sub_dist
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sum_nonneg <span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_nonneg_nonneg<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> uP healthy
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sound <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
                   <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-healthy_wp_Apply"><span class="command">lemma</span></span> healthy_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Apply_def wp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Apply"><span class="command">lemma</span></span> nearly_healthy_wlp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>o_def wp_eval<span class="main">)</span>

<span class="keyword1" id="Healthiness-healthy_wp_Bind"><span class="command">lemma</span></span> healthy_wp_Bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hsub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts nnegI bounded_byI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hsub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bP nP hsub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hsub<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hsub<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_Bind"><span class="command">lemma</span></span> nearly_healthy_wlp_Bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hsub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 nnegI bounded_byI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hsub <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hsub<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Healthiness for Loops›</span></span>

<span class="keyword1" id="Healthiness-wp_loop_step_mono"><span class="command">lemma</span></span> wp_loop_step_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="free">t</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> le_transI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="free">u</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP ht hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-wlp_loop_step_mono"><span class="command">lemma</span></span> wlp_loop_step_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mb<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="free">t</span> <span class="free">u</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>
                   <span class="main">(</span>wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> le_utransI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="free">u</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uP ht hu <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mb<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For each sound expectation, we have a pre fixed point of the loop body.
This lets us use the relevant fixed-point lemmas.›</span></span>
<span class="keyword1" id="Healthiness-lfp_loop_fp"><span class="command">lemma</span></span> lfp_loop_fp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span>
                   <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> bound_of <span class="free">P</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> bound_of <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span> negate_embed<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-lfp_loop_greatest"><span class="command">lemma</span></span> lfp_loop_greatest<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="bound">R</span> <span class="main">⟹</span> sound <span class="bound">R</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="bound">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sP <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_exp_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lb sQ<span class="main"><span class="main">]</span></span> sP lfp_loop_fp hb<span class="main">)</span>

<span class="keyword1" id="Healthiness-lfp_loop_sound"><span class="command">lemma</span></span> lfp_loop_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_exp_sound lfp_loop_fp<span class="main">)</span>

<span class="keyword1" id="Healthiness-wlp_loop_step_unitary"><span class="command">lemma</span></span> wlp_loop_step_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> ht uP <span class="keyword1"><span class="command">have</span></span> utP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ht uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> utP hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-wp_loop_step_sound"><span class="command">lemma</span></span> wp_loop_step_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="free">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="free">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> ht sP <span class="keyword1"><span class="command">have</span></span> stP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> ht sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span>
                max <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="main">(</span><span class="free">t</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This gives the equivalence with the alternative definition for
  loops\citep[\S7, p.~198, footnote 23]{McIver_M_04}.›</span></span>

<span class="keyword1" id="Healthiness-wlp_Loop1"><span class="command">lemma</span></span> wlp_Loop1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unitary<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> healthy<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
   gfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> gfp_exp <span class="main">(</span><span class="var">?Y</span> <span class="free">P</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="free">u</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> gfp_pulldown assms le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">=</span> <span class="var">?Y</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval negate_embed<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wlp_loop_step_unitary<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">a</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> healthy uQ
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">body</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> healthy uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span>wlp <span class="free">body</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> nearly_healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
          <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>wlp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>wlp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wlp_loop_step_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-wp_loop_sound"><span class="command">lemma</span></span> wp_loop_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> lfp_trans_sound sP<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="var">?v</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="var">?v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval lfp_loop_fp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> negate_embed<span class="main"><span class="main">]</span></span> hb<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="var">?v</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Likewise, we can rewrite strict loops.›</span></span>
<span class="keyword1" id="Healthiness-wp_Loop1"><span class="command">lemma</span></span> wp_Loop1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> healthy<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
   lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> lfp_exp <span class="main">(</span><span class="var">?Y</span> <span class="free">P</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="free">u</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> lfp_pulldown assms le_funI sP mono_transI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">u</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">=</span> <span class="var">?Y</span> <span class="skolem">P</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval negate_embed<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_loop_step_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">a</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 nnegI bounded_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
                       <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">+</span>
                       <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span> negate_embed<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> max <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ healthy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
          <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> healthy <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>wp <span class="main">(</span><span class="var">?Z</span> <span class="skolem">u</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_loop_step_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> healthy <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="var">?Z</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval lfp_loop_fp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> negate_embed<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Healthiness-nearly_healthy_wlp_loop"><span class="command">lemma</span></span> nearly_healthy_wlp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> nearly_healthyI unitaryI2 nnegI2 bounded_byI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_Loop1 hb<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">R</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">R</span> <span class="bound">s</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_upperbound<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_funI add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">::</span>real<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_least<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword3"><span class="command">assume</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊩</span> <span class="var">?X</span> <span class="skolem">P</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="var">?X</span> <span class="skolem">Q</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono le_funI<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊩</span> gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> uR <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_upperbound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>gfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_unitary<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword3"><span class="command">assume</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> ubP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">body</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> ubP uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show healthiness by appealing to the properties of expectation fixed points, applied
to the alternative loop definition.›</span></span>
<span class="keyword1" id="Healthiness-healthy_wp_loop"><span class="command">lemma</span></span> healthy_wp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">P</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> healthy_parts bounded_byI2 nnegI2<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_Loop1 hb soundI2 sound_intros<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> antisym<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_greatest fp<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> onesided<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">c</span><span class="main">.</span> <span class="bound">c</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">c</span> <span class="main">⟹</span> sound <span class="bound">P</span> <span class="main">⟹</span>
            <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">c</span> <span class="main">*</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊩</span>
                    lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="main">(</span><span class="bound">c</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
        <span class="keyword3"><span class="command">assume</span></span> cnz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword1"><span class="command">have</span></span> cpos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> nnic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inverse <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊩</span>
              lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_greatest<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
             <span class="keyword2"><span class="keyword">and</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> nnic
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                     inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">*</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span>
                     inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span>
                     inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cnz scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb sQ nnic<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊩</span>
                 <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nnic sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⊩</span>
                           <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_lowerbound<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> nnc
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span>
                     <span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span>inverse <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> cnz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">...</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">a</span> <span class="bound">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">b</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">b</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> hb sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_sound lfp_loop_fp<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> hb sP nnc
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span>
                    <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_loop_fp sound_intros<span class="main">)</span>

          <span class="keyword1"><span class="command">from</span></span> sP nnc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">assume</span></span> nzc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">s</span> <span class="main">=</span> <span class="var">?Y</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> nzc nnc sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="main">⊩</span> <span class="var">?Y</span> <span class="skolem">P</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> onesided<span class="main">)</span>

        <span class="keyword1"><span class="command">from</span></span> nzc <span class="keyword1"><span class="command">have</span></span> nzic<span class="main">:</span> <span class="quoted"><span class="quoted">"inverse <span class="skolem">c</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nnc <span class="keyword1"><span class="command">have</span></span> nnic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> inverse <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nnc sP <span class="keyword1"><span class="command">have</span></span> scP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span> <span class="main">⊩</span> <span class="var">?Y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> onesided<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="var">?X</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span> <span class="bound">s</span> <span class="main">⊩</span>
                       <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="var">?Y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>inverse <span class="skolem">c</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> nzc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="skolem">P</span> <span class="skolem">c</span> <span class="main">⊩</span> <span class="var">?X</span> <span class="skolem">P</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> lfp_exp_lowerbound le_funI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> bP nP hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">from</span></span> bP nP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> hb bP nP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_nneg <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_loop_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="var">?X</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_greatest<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span>
         <span class="keyword2"><span class="keyword">and</span></span> fp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊩</span>
                    <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI add_left_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> fp
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">R</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sR <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">from</span></span> hb sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">R</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_loop_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> hb sQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span>  <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_loop_fp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use 'simp add:healthy\_intros' or 'blast intro:healthy\_intros' as
        appropriate to discharge healthiness side-contitions for primitive
        programs automatically.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> healthy_intros <span class="main">=</span>
  healthy_wp_Abort nearly_healthy_wlp_Abort healthy_wp_Skip   nearly_healthy_wlp_Skip
  healthy_wp_Seq   nearly_healthy_wlp_Seq   healthy_wp_PC     nearly_healthy_wlp_PC
  healthy_wp_DC    nearly_healthy_wlp_DC    healthy_wp_AC     nearly_healthy_wlp_AC
  healthy_wp_Embed nearly_healthy_wlp_Embed healthy_wp_Apply  nearly_healthy_wlp_Apply
  healthy_wp_SetDC nearly_healthy_wlp_SetDC healthy_wp_SetPC  nearly_healthy_wlp_SetPC
  healthy_wp_Bind  nearly_healthy_wlp_Bind  healthy_wp_repeat nearly_healthy_wlp_repeat
  healthy_wp_loop  nearly_healthy_wlp_loop

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Continuity">
<div class="head">
<h1>Theory Continuity</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Continuity›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Continuity <span class="keyword2"><span class="keyword">imports</span></span> <a href="Healthiness.html">Healthiness</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We rely on one additional healthiness property, continuity, which is shown here seperately,
as its proof relies, in general, on healthiness.  It is only relevant when a program appears
in an inductive context i.e.~inside a loop.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A continuous transformer preserves limits (or the suprema of ascending chains).›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bd_cts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bd_cts</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="bound">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> sound <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                       <span class="main">(</span><span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                       <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="bound">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">o</span> <span class="bound">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuity-bd_ctsD"><span class="command">lemma</span></span> bd_ctsD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bd_cts <span class="free">t</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="free">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">t</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="free">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free">t</span> <span class="keyword1">o</span> <span class="free">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bd_cts_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Continuity-bd_ctsI"><span class="command">lemma</span></span> bd_ctsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">b</span> <span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="bound">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="bound">b</span> <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
         <span class="free">t</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="bound">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free">t</span> <span class="keyword1">o</span> <span class="bound">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> bd_cts <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bd_cts_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A generalised property for transformers of transformers.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bd_cts_tr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> trans <span class="main">⇒</span> <span class="tfree">'s</span> trans<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bd_cts_tr</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> le_trans <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> feasible <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                          equiv_trans <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="bound">M</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="keyword1">o</span> <span class="bound">M</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Continuity-bd_cts_trD"><span class="command">lemma</span></span> bd_cts_trD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> bd_cts_tr <span class="free">T</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> le_trans <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> feasible <span class="main">(</span><span class="free">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   equiv_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="free">M</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="main">(</span><span class="free">T</span> <span class="keyword1">o</span> <span class="free">M</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bd_cts_tr_def<span class="main">)</span>

<span class="keyword1" id="Continuity-bd_cts_trI"><span class="command">lemma</span></span> bd_cts_trI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">M</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> le_trans <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="bound">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> feasible <span class="main">(</span><span class="bound">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
         equiv_trans <span class="main">(</span><span class="free">T</span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="bound">M</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span><span class="main">(</span><span class="free">T</span> <span class="keyword1">o</span> <span class="bound">M</span><span class="main">)</span> <span class="main">`</span> UNIV<span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> bd_cts_tr <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bd_cts_tr_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Continuity of Primitives›</span></span>

<span class="keyword1" id="Continuity-cts_wp_Abort"><span class="command">lemma</span></span> cts_wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Abort<span class="main">::</span><span class="tfree">'s</span> prog<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def Sup_exp_def X<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_Skip"><span class="command">lemma</span></span> cts_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def Skip_def o_def<span class="main">)</span>

<span class="keyword1" id="Continuity-cts_wp_Apply"><span class="command">lemma</span></span> cts_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">M</span> <span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">P</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> range <span class="bound">M</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">P</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">M</span> <span class="bound">i</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bd_ctsI ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def Sup_exp_def X<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_Bind"><span class="command">lemma</span></span> cts_wp_Bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> bd_ctsD<span class="main">[</span><span class="operator">OF</span> ca<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">fa</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">fa</span><span class="main">.</span> <span class="bound">fa</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
                      <span class="main">{</span><span class="bound">fa</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">fa</span><span class="main">.</span> <span class="bound">fa</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                   Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def Sup_exp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first nontrivial proof.  We transform the suprema into limits, and appeal to the
continuity of the underlying operation (here infimum).  This is typical of the remainder of the
nonrecursive elements.›</span></span>
<span class="keyword1" id="Continuity-cts_wp_DC"><span class="command">lemma</span></span> cts_wp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> ha hb <span class="keyword1"><span class="command">have</span></span> hab<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> healthy_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> bM <span class="keyword1"><span class="command">have</span></span> leSup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sM bM <span class="keyword1"><span class="command">have</span></span> sSup<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_sound<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Sup_exp_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">from</span></span> mono_transD<span class="main">[</span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hab<span class="main"><span class="main">]</span></span><span class="main">]</span> leSup sM sSup
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> hab sSup <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> sM bM ha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> baM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sM bM hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> bbM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">from</span></span> bd_ctsD<span class="main">[</span><span class="operator">OF</span> ca<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">,</span> <span class="operator">OF</span> chain sM bM<span class="main">]</span> bd_ctsD<span class="main">[</span><span class="operator">OF</span> cb<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">M</span></span><span class="main">,</span> <span class="operator">OF</span> chain sM bM<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
          min <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
            min <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> increasing_LIMSEQ<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">from</span></span> mono_transD<span class="main">[</span><span class="operator">OF</span> healthy_monoD<span class="main">,</span> <span class="operator">OF</span> ha<span class="main">]</span> sM chain
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> pe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword1"><span class="command">have</span></span> cSup<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> closure <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>closure_contains_Sup<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
                          <span class="keyword2"><span class="keyword">and</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> closure_approachable<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> yin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> dy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_real_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> increasing_LIMSEQ<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword1"><span class="command">from</span></span> mono_transD<span class="main">[</span><span class="operator">OF</span> healthy_monoD<span class="main">,</span> <span class="operator">OF</span> hb<span class="main">]</span> sM chain
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> bbM <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> pe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> bbM <span class="keyword1"><span class="command">have</span></span> cSup<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> closure <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>closure_contains_Sup<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
                          <span class="keyword2"><span class="keyword">and</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> closure_approachable<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> yin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> dy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bbM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_real_def<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⇢</span>
                       min <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tendsto_min<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bdd_above <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">from</span></span> ha sM bM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>  <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>LIMSEQ_le_const2 cSup_upper min.mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> baM bbM<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_exp_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
                  Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_Seq"><span class="command">lemma</span></span> cts_wp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cb<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sM hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> chain sM
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sM bM hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span><span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                     Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ca<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_PC"><span class="command">lemma</span></span> cts_wp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>PC <span class="free">a</span> <span class="free">p</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> sM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> nneg <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bM <span class="keyword1"><span class="command">have</span></span> nc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> chain sM bM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ca<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">a</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup <span class="main">{</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cSup_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> up <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> sM bM ha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
           Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> chain sM bM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cb<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="free">b</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                  <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup <span class="main">{</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cSup_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> up <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> sM bM hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
            range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
             Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                  Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
        Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bM sM ha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> up nc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> baM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> lima<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> increasing_LIMSEQ<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">from</span></span> sM chain healthy_monoD<span class="main">[</span><span class="operator">OF</span> ha<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> up <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span>
      <span class="keyword3"><span class="command">assume</span></span> pe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
                     closure <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>closure_contains_Sup<span class="main">)</span>
      <span class="keyword1"><span class="command">thm</span></span> closure_approachable
      <span class="keyword1"><span class="command">with</span></span> pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
                         <span class="keyword2"><span class="keyword">and</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> closure_approachable<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> yin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> dy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> baM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_real_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> bM sM hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">c</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> bbM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> limb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> increasing_LIMSEQ<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword1"><span class="command">from</span></span> sM chain healthy_monoD<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> bbM <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">n</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span><span class="main">::</span><span class="quoted">real</span>
      <span class="keyword3"><span class="command">assume</span></span> pe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> bbM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
                     closure <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>closure_contains_Sup<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> pe <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
                         <span class="keyword2"><span class="keyword">and</span></span> dy<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> closure_approachable<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> yin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> dy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
                         <span class="main">(</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bbM
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_real_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> lima limb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span>
      Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tendsto_add<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> add_mono<span class="main">[</span><span class="operator">OF</span> baM bbM<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                       Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                     Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
                     Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LIMSEQ_le_const2<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
          <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_exp_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_exp_least<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">from</span></span> bM <span class="keyword1"><span class="command">have</span></span> leSup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">i</span> <span class="main">⊩</span> Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_exp_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sM bM <span class="keyword1"><span class="command">have</span></span> sSup<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> healthy_monoD<span class="main">[</span><span class="operator">OF</span> ha<span class="main">]</span> sM
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> leSup sSup healthy_monoD<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> sM
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
          <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> sSup ha hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
                         <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="bound">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">c</span><span class="main">.</span> <span class="free">p</span> <span class="bound">c</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span> <span class="main">+</span>
                          <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">c</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="bound">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                  Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Both set-based choice operators are only continuous for finite sets (probabilistic choice
\emph{can} be extended infinitely, but we have not done so).  The proofs for both are inductive,
and rely on the above results on binary operators.›</span></span>

<span class="keyword1" id="Continuity-SetPC_Bind"><span class="command">lemma</span></span> SetPC_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SetPC <span class="free">a</span> <span class="free">p</span> <span class="main">=</span> Bind <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_def Bind_def Let_def<span class="main">)</span>

<span class="keyword1" id="Continuity-SetPC_remove"><span class="command">lemma</span></span> SetPC_remove<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fsupp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> PC <span class="main">(</span><span class="free">a</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> dist_remove <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_def PC_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> nz <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> supp <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">=</span> insert <span class="free">x</span> <span class="main">(</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>insert <span class="free">x</span> <span class="main">(</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fsupp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum.insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> n1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span> <span class="bound">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">y</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_divide_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="free">p</span> <span class="main">-</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">.</span> dist_remove <span class="free">p</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">y</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_remove_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nz n1
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
              <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="main">(</span>dist_remove <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">.</span> dist_remove <span class="free">p</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">y</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_dist_remove<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span><span class="main">.</span> <span class="free">p</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
                 <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
                 <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="main">(</span>dist_remove <span class="free">p</span> <span class="free">x</span><span class="main">)</span><span class="main">.</span> dist_remove <span class="free">p</span> <span class="free">x</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">y</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_bot"><span class="command">lemma</span></span> cts_bot<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'s</span> expect<span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'s</span> expect<span class="main">)</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">P</span><span class="main">.</span> <span class="bound">P</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def o_def X<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-wp_SetPC_nil"><span class="command">lemma</span></span> wp_SetPC_nil<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Continuity-SetPC_sgl"><span class="command">lemma</span></span> SetPC_sgl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟹</span> SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="free">x</span> <span class="main">*</span> <span class="free">a</span> <span class="free">x</span> <span class="bound">ab</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_def<span class="main">)</span>

<span class="keyword1" id="Continuity-bd_cts_scale"><span class="command">lemma</span></span> bd_cts_scale<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> bd_ctsI ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">d</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">d</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> sM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> nneg <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bM <span class="keyword1"><span class="command">have</span></span> nnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sM bM <span class="keyword1"><span class="command">have</span></span> sSup<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> healthy_scalingD<span class="main">[</span><span class="operator">OF</span> ha<span class="main">]</span> nnc
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="skolem">M</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
           <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">≤</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                   <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="free">c</span><span class="main">*</span><span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> cSup_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="free">c</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
          <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>X<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_exp_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
           <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> le_funD<span class="main">[</span><span class="operator">OF</span> chain<span class="main">]</span> nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mult_left_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sM nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bM nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="main">(</span><span class="free">c</span> <span class="main">*</span> <span class="skolem">d</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ca<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
          Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="free">a</span> <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
             Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> nnc sM
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_scalingD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> ha<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="skolem">M</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
           Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="free">c</span> <span class="main">*</span> <span class="free">a</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">x</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_SetPC_const"><span class="command">lemma</span></span> cts_wp_SetPC_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">p</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sump<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="free">p</span> <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fsupp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_empty SetPC_def wp_def cts_bot<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> nesupp<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fsupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="free">p</span> <span class="main">⟶</span> sum <span class="free">p</span> <span class="main">(</span>supp <span class="free">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟶</span> 
                   <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                   <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="free">p</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                   bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"supp <span class="free">p</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_empty wp_SetPC_nil cts_bot<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="skolem">F</span> <span class="main">=</span> supp <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> pstep<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="skolem">p</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="skolem">p</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sump<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> xni<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="skolem">F</span> <span class="main">=</span> supp <span class="bound">p</span> <span class="main">⟹</span>
                     unitary <span class="bound">p</span> <span class="main">⟶</span> sum <span class="bound">p</span> <span class="main">(</span>supp <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟶</span>
                     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="bound">p</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                     <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="bound">p</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                     bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> fF pstep <span class="keyword1"><span class="command">have</span></span> fsupp<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword1"><span class="command">have</span></span> nzp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> xy_le_sum<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> supp <span class="skolem">p</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="main">≤</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">+</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> yin yne fsupp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">y</span> <span class="main">+</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">from</span></span> xin fsupp
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> sum.insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum.cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">+</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">≤</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> n1p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> supp <span class="skolem">p</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> px1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> yin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_strict_right_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> px1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> yin yne <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">≤</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> xy_le_sum<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> sump <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> pstep <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supp <span class="skolem">p</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_sgl wp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> up ca ha xin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">x</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> bd_cts_scale<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span> 
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> neF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yinF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> xni <span class="keyword1"><span class="command">have</span></span> yne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> yinF pstep <span class="keyword1"><span class="command">have</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> supp_dist_remove<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">OF</span> nzp n1p<span class="main">,</span> <span class="operator">OF</span> yin yne<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> supp_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">⊆</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> xin ca <span class="keyword1"><span class="command">have</span></span> cax<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> xin ha <span class="keyword1"><span class="command">have</span></span> hax<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> supp_sub ha <span class="keyword1"><span class="command">have</span></span> hra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> supp_sub ca <span class="keyword1"><span class="command">have</span></span> cra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> supp_dist_remove<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">OF</span> nzp n1p<span class="main">,</span> <span class="operator">OF</span> yin yne<span class="main">]</span> pstep xni
      <span class="keyword1"><span class="command">have</span></span> Fsupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> udp<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> dist_remove <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_remove_def<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> divide_nonneg_nonneg<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"dist_remove <span class="skolem">p</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_remove_def<span class="main"><span class="keyword3">,</span></span>
              <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>supp <span class="skolem">p</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nsupp_zero<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> yne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> supp <span class="skolem">p</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">p</span> <span class="skolem">y</span> <span class="main">≤</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>xy_le_sum<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> sump
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> yin yne <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> n1p<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword1"><span class="command">have</span></span> pxn0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>supp_def<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> yin yne <span class="keyword1"><span class="command">have</span></span> pxn1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> n1p<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> pxn0 pxn1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                           sum <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>supp_dist_remove<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_remove_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_divide_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">x</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> supp <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> fsupp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">y</span><span class="main">∈</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">.</span> <span class="skolem">p</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum.insert<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> sump
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> pxn1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum <span class="skolem">p</span> <span class="main">(</span>supp <span class="skolem">p</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> sdp<span class="main">:</span> <span class="quoted"><span class="quoted">"sum <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span>dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">from</span></span> Fsupp udp sdp hra cra IH
      <span class="keyword1"><span class="command">have</span></span> cts_dr<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> dist_remove <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> up <span class="keyword1"><span class="command">have</span></span> upx<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      
      <span class="keyword1"><span class="command">from</span></span> pxn0 pxn1 fsupp hra <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_remove<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cts_wp_PC cax cts_dr hax healthy_intros
                       unitary_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> udp<span class="main"><span class="main">]</span></span> sdp upx<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_SetPC"><span class="command">lemma</span></span> cts_wp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> unitary <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sump<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sum <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fsupp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">p</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> SetPC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cts_wp_Bind cts_wp_SetPC_const<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetPC_Bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-wp_SetDC_Bind"><span class="command">lemma</span></span> wp_SetDC_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SetDC <span class="free">a</span> <span class="free">S</span> <span class="main">=</span> Bind <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetDC_def Bind_def<span class="main">)</span>

<span class="keyword1" id="Continuity-SetDC_finite_insert"><span class="command">lemma</span></span> SetDC_finite_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> insert <span class="free">x</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⨅</span> SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetDC_def DC_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp <span class="quasi_keyword">cong</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> INF_cong_simp<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> fS <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> 
           <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> neS <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> A C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                 Min <span class="main">(</span>insert <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_eq_Min<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> B D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> min <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Min <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Min_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> B D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> min <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>cInf_eq_Min<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">INF</span> <span class="bound">x</span><span class="main">∈</span>insert <span class="free">x</span> <span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
    min <span class="main">(</span><span class="free">a</span> <span class="free">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">INF</span> <span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">a</span> <span class="bound">x</span> <span class="skolem">ab</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> INF_cong_simp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-SetDC_singleton"><span class="command">lemma</span></span> SetDC_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SetDC_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> INF_cong_simp<span class="main">)</span>

<span class="keyword1" id="Continuity-cts_wp_SetDC_const"><span class="command">lemma</span></span> cts_wp_SetDC_const<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
        bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> fF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> cax<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> hax<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> haF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>SetDC_singleton cax<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> fF cax hax haF IH <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cts_wp_DC healthy_intros <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>SetDC_finite_insert<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_SetDC"><span class="command">lemma</span></span> cts_wp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ca<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span><span class="free">S</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> neS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">a</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">S</span> <span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> SetDC <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cts_wp_Bind cts_wp_SetDC_const<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_SetDC_Bind<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Continuity-cts_wp_repeat"><span class="command">lemma</span></span> cts_wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cts_wp_Skip cts_wp_Seq healthy_intros<span class="main">)</span>

<span class="keyword1" id="Continuity-cts_wp_Embed"><span class="command">lemma</span></span> cts_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bd_cts <span class="free">t</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Continuity of a Single Loop Step›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A single loop iteration is continuous, in the more general sense defined above for
transformer transformers.›</span></span>
<span class="keyword1" id="Continuity-cts_wp_loopstep"><span class="command">lemma</span></span> cts_wp_loopstep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts_tr <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bd_cts_tr <span class="var">?F</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_cts_trI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_trans_antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> le_trans <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> fM<span class="main">:</span>    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> feasible <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> fw<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="var">?F</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_least2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> fM <span class="keyword1"><span class="command">have</span></span> fSup<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>feasible_Sup_trans<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> sQ fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_trans_upper2<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ fM fSup
      <span class="keyword1"><span class="command">have</span></span> sMtP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">M</span> <span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> healthy_monoD<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?F</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">t</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="var">?F</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval mult_left_mono<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nnegI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
        <span class="keyword1"><span class="command">from</span></span> fSup sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">.</span>
            <span class="main">∀</span><span class="bound">R</span><span class="main">.</span> nneg <span class="bound">R</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="bound">R</span> <span class="main">⟶</span>
                nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword3"><span class="command">assume</span></span> nR<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bR<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fM <span class="keyword1"><span class="command">have</span></span> sMuR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> sR bR fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> sMuR hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span>
                       <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> bound_of <span class="skolem">P</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> bound_of <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">u</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?F</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="var">?F</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_eval <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="skolem">M</span><span class="main">}</span> <span class="main">=</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> wp <span class="free">body</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sP fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP chain <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> sP fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
                       Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> bd_ctsD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cb<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
               Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span>
                  <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sP fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
            <span class="main">{</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
            Sup <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> cSup_mult<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span>
               <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
              <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bound sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span>
              Sup <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> cSup_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span>
            Sup <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span>
                 <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">...</span> <span class="bound">i</span> <span class="main">≤</span>
                 Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> sP fM <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
               <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">i</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">≤</span>
            Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">}</span> <span class="main">=</span>
               Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def Sup_exp_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
                  Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LoopInduction">
<div class="head">
<h1>Theory LoopInduction</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Continuity and Induction for Loops›</span></span>

<span class="keyword1"><span class="command">theory</span></span> LoopInduction <span class="keyword2"><span class="keyword">imports</span></span> <a href="Healthiness.html">Healthiness</a> <a href="Continuity.html">Continuity</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Showing continuity for loops requires a stronger induction principle than we have used
so far, which in turn relies on the continuity of loops (inductively).  Thus, the proofs are
intertwined, and broken off from the main set of continuity proofs.  This result is also
essential in showing the sublinearity of loops.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A loop step is monotonic.›</span></span>
<span class="keyword1" id="LoopInduction-wp_loop_step_mono_trans"><span class="command">lemma</span></span> wp_loop_step_mono_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> mono_transI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="skolem">Q</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>le_funD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can therefore apply the standard fixed-point lemmas to unfold it:›</span></span>
<span class="keyword1" id="LoopInduction-lfp_wp_loop_unfold"><span class="command">lemma</span></span> lfp_wp_loop_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span>
              <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> lfp_exp_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mono_trans <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_step_mono_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_loop_fp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> wp_loop_step_sound<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wp_eval<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">folded</span> negate_embed<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LoopInduction-wp_loop_step_unitary"><span class="command">lemma</span></span> wp_loop_step_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ hb <span class="keyword1"><span class="command">have</span></span> uwQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">body</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> uP uwQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LoopInduction-lfp_loop_unitary"><span class="command">lemma</span></span> lfp_loop_unitary<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_exp_unitary wp_loop_step_unitary<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From the lattice structure on transformers, we establish a transfinite induction
  principle for loops.  We use this to show a number of properties, particularly
  subdistributivity, for loops.  This proof follows the pattern of lemma lfp\_ordinal\_induct
  in HOL/Inductive.›</span></span>
<span class="keyword1" id="LoopInduction-loop_induct"><span class="command">lemma</span></span> loop_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hwp<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwlp<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹The body must be healthy, both in strict and liberal semantics.›</span>
      <span class="keyword2"><span class="keyword">and</span></span> Limit<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span><span class="main">.</span> <span class="main">⟦</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> feasible <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span><span class="main">;</span>
                          <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> unitary <span class="main">(</span>snd <span class="bound">x</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
                    <span class="free">P</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="bound">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹The property holds at limit points.›</span>
      <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> feasible <span class="bound">t</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">Q</span><span class="main">)</span>  <span class="main">⟧</span> <span class="main">⟹</span>
                        <span class="free">P</span> <span class="main">(</span>wp  <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span>wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="comment1">― ‹The inductive step.  The property is preserved by a single loop iteration.›</span>
      <span class="keyword2"><span class="keyword">and</span></span> P_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">t'</span> <span class="bound">u</span> <span class="bound">u'</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">P</span> <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> equiv_trans <span class="bound">t</span> <span class="bound">t'</span><span class="main">;</span> equiv_utrans <span class="bound">u</span> <span class="bound">u'</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">t'</span> <span class="bound">u'</span>"</span></span>
      <span class="comment1">― ‹The property must be preserved by equivalence›</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>wlp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹The property can refer to both interpretations simultaneously.  The unifier will happily
  apply the rule to just one or the other, however.›</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">t</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="free">t</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?M</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                feasible <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
                <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> unitary <span class="main">(</span>snd <span class="bound">x</span> <span class="bound">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
                le_trans <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span> <span class="main">∧</span>
                le_utrans <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">x</span><span class="main">)</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> fSup<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> feasibleI bounded_byI2 nnegI2<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def
      <span class="keyword1"><span class="command">using</span></span> nQ bQ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>Sup_exp_least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def Sup_exp_def empty<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> ffx<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> nQ bQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> fst <span class="skolem">x</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="skolem">Q</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">intro</span> Sup_trans_upper2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> imageI _ nQ bQ<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sound_nneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> feasible_sound<span class="main"><span class="main">]</span></span> feasible_boundedD<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> uInf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span>
    <span class="keyword3"><span class="command">assume</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>empty<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Inf_utrans_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI2 bounded_byI2<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> sxin<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="var">?M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> Inf_utrans_lower<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> snd <span class="skolem">x</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> xin uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>snd <span class="skolem">x</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Inf_trans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Inf_trans_def
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Inf_exp_greatest<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> sxin <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="var">?M</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="main">{</span><span class="bound">t</span> <span class="skolem">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="var">?M</span><span class="main">}</span><span class="main">.</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="bound">P</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_trans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">=</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Inf_utrans_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> X<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> wp_loop_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_trans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                               <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_trans <span class="main">(</span><span class="var">?X</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?X</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> le_transI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> su<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> healthy_monoD<span class="main">[</span><span class="operator">OF</span> hwp<span class="main">]</span> le sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> wlp_loop_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">u</span><span class="main">.</span> <span class="main">⟦</span> le_utrans <span class="bound">t</span> <span class="bound">u</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">;</span>
                               <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">u</span> <span class="bound">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> le_utrans <span class="main">(</span><span class="var">?Y</span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="bound">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> le_utransI le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="skolem">u</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> uu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">u</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> le uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>nearly_healthy_monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hwlp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> hwp <span class="keyword1"><span class="command">have</span></span> hX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> healthy <span class="bound">t</span> <span class="main">⟹</span> healthy <span class="main">(</span><span class="var">?X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> hwlp <span class="keyword1"><span class="command">have</span></span> hY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> nearly_healthy <span class="bound">t</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span><span class="var">?Y</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>
                
  <span class="keyword1"><span class="command">have</span></span> PLimit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Limit<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> feasible_lfp_loop<span class="main">:</span>
    <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> feasibleI bounded_byI2 nnegI2<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_Loop1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> wp_eval<span class="main"><span class="main">]</span></span> soundI2 hwp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
    <span class="keyword3"><span class="command">assume</span></span> bP<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> lfp_exp_lowerbound le_funI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> bP nP <span class="keyword1"><span class="command">have</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> bP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> nnb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> hwp sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> lfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>lfp_exp_greatest lfp_loop_fp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> unitary_gfp<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span>gfp_trans <span class="var">?Y</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI2 bounded_byI2<span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_Loop1<span class="main"><span class="main">[</span></span><span class="operator">simplified</span> wp_eval<span class="main"><span class="main">]</span></span> hwlp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> gfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_upperbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_funI<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> hwlp uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>unitary_sound<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gfp_exp <span class="main">(</span><span class="main">λ</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="bound">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span> <span class="keyword1">𝒩</span> <span class="free">G</span> <span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_exp_least<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fX<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> feasible <span class="bound">t</span> <span class="main">⟹</span> feasible <span class="main">(</span><span class="var">?X</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> feasibleI nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="skolem">b</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> stQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> hwp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> bQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
                     <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> nQ stQ hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> uY<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">P</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="bound">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="var">?Y</span> <span class="bound">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> unitaryI2 nnegI bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> ut<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> utP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hwlp <span class="keyword1"><span class="command">have</span></span> ubtP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> uP ubtP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> fw_lfp<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> feasible_nnegD<span class="main">[</span><span class="operator">OF</span> feasible_lfp_loop<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_least2<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_mono feasible_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fSup<span class="main"><span class="main">]</span></span>
                  feasible_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> feasible_lfp_loop<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">...</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equiv_trans_comm<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lfp_trans_unfold<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_mono<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="var">?X</span> <span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> soundI2 bounded_byI nnegI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
      <span class="keyword1"><span class="command">from</span></span> sP st hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg mult_nonneg_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> sP st <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> sP st hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP st hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP st hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
                       <span class="main">1</span> <span class="main">*</span> bound_of <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">*</span> bound_of <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?fp</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">R</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">R</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?X</span> <span class="var">?fp</span><span class="main">)</span> <span class="var">?fp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros hwp<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="var">?fp</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le_lfp<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">have</span></span> fw_gfp<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Inf_utrans_greatest unitary_gfp<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>gfp_trans_unfold wlp_loop_mono uY<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fw_gfp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wlp_loop_mono uInf unitary_gfp<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ge_gfp<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> PLimit fX uY fSup uInf <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>IH<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> fSup <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> fX<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>uY uInf<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> le_lfp ge_gfp
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> pair_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pair_in<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">fst</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?X</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_upper2<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="var"><span class="var">?X</span></span> <span class="main"><span class="main">(</span></span>Sup_trans <span class="main"><span class="main">(</span></span>fst <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?M</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span>"</span></span></span>
                                             <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> S<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"fst <span class="main"><span class="main">`</span></span> <span class="var"><span class="var">?M</span></span>"</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> nneg <span class="bound">Q</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="bound">Q</span> <span class="main">⟶</span>
                                   nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_trans_lowerbound feasible_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fSup<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fw_lfp <span class="keyword1"><span class="command">have</span></span> eqt<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_trans_antisym<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> imageI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pair_in<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">snd</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?Y</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> Inf_utrans_lower<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"le_utrans <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>gfp_trans_upperbound uInf<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> fw_gfp <span class="keyword1"><span class="command">have</span></span> equ<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="var">?M</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_utrans_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> PLimit eqt equ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span> <span class="main">(</span>gfp_trans <span class="var">?Y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> P_equiv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Limit of Iterates›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The iterates of a loop are its sequence of finite unrollings.  We show shortly that this
converges on the least fixed point.  This is enormously useful, as we can appeal to various
properties of the finite iterates (which will follow by finite induction), which we can then
transfer to the limit.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iterates</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'s</span> trans"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">iterates</span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">^^</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="LoopInduction-iterates_0"><span class="command">lemma</span></span> iterates_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>iterates_def<span class="main">)</span>

<span class="keyword1" id="LoopInduction-iterates_Suc"><span class="command">lemma</span></span> iterates_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span><span class="free">G</span><span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>iterates_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹All iterates are healthy.›</span></span>
<span class="keyword1" id="LoopInduction-iterates_healthy"><span class="command">lemma</span></span> iterates_healthy<span class="main">:</span>
  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span> <span class="main">⟹</span> healthy <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The iterates are an ascending chain.›</span></span>
<span class="keyword1" id="LoopInduction-iterates_increasing"><span class="command">lemma</span></span> iterates_increasing<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>iterates_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_transI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wp_loop_step_sound<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>
                    <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">...</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_step_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb IH<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">...</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="LoopInduction-wp_loop_step_bounded"><span class="command">lemma</span></span> wp_loop_step_bounded<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword1"><span class="command">from</span></span> nQ bQ <span class="keyword1"><span class="command">have</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bQ ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="free">b</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> bQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
         <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="free">b</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="free">t</span> <span class="free">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is the key result: The loop is equivalent to the supremum of its iterates.  This
proof follows the pattern of lemma continuous\_lfp in HOL/Library/Continuity.›</span></span>
<span class="keyword1" id="LoopInduction-lfp_iterates"><span class="command">lemma</span></span> lfp_iterates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="var">?X</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_trans_antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?F</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?bot</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">P</span><span class="main">::</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real"</span></span>

  <span class="keyword1"><span class="command">have</span></span> HF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> healthy <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="bound">i</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?thesis</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> feasible <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> fSup<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>feasible_Sup_trans<span class="main">)</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="main">0</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span> <span class="var">?X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> le_transI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> hb healthy_wp_loop
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">body</span> <span class="main">;;</span> <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">body</span> <span class="main">;;</span> <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span> <span class="var">?X</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span> <span class="main">(</span><span class="var">?F</span> <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">...</span> <span class="main">(</span><span class="var">?F</span> <span class="var">?X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_loop_step_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb IH<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> hb healthy_wp_loop
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">μ</span> <span class="bound">x</span><span class="main">.</span> <span class="free">body</span> <span class="main">;;</span> <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="skolem">i</span><span class="main">)</span> <span class="var">?bot</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> healthy_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> HF<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>
                                 <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lfp_loop_fp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> negate_embed<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span><span class="var">?F</span> <span class="var">?X</span><span class="main">)</span> <span class="var">?X</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> iffD1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> equiv_trans_comm<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> lfp_trans_unfold<span class="main"><span class="main">]</span></span>
                 wp_loop_step_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span> wp_loop_step_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span><span class="main"><span class="keyword3">|</span></span><span class="operator">rule</span> X<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="main">(</span><span class="var">?F</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="var">?bot</span><span class="main">)</span> <span class="var">?X</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>iterates_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="var">?Y</span> <span class="var">?X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_transI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_least2<span class="main"><span class="main">]</span></span> sound_nneg
                   healthy_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterates_healthy<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span>
                   healthy_bounded_byD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterates_healthy<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span>
                   healthy_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_wp_loop<span class="main"><span class="main">]</span></span> hb<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="var">?X</span> <span class="var">?Y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> lfp_trans_lowerbound<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hb cb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bd_cts_tr <span class="var">?F</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cts_wp_loopstep<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iterates_increasing<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span><span class="var">?F</span> <span class="var">?Y</span><span class="main">)</span> <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="var">?F</span> <span class="keyword1">o</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> healthy_feasibleD bd_cts_trD <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> image_cong_simp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="var">?F</span> <span class="keyword1">o</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?Y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_transI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span><span class="var">?F</span> <span class="keyword1">o</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="var">?Y</span> <span class="skolem">P</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Sup_trans_least2<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="bound">x</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="main">∘</span> iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">.</span>
              <span class="main">∀</span><span class="bound">R</span><span class="main">.</span> nneg <span class="bound">R</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="bound">R</span> <span class="main">⟶</span>
                  nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">i</span>
          <span class="keyword3"><span class="command">assume</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="bound">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> hb
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_step_sound<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> nQ bQ iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> hb
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_loop_step_bounded<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
        <span class="keyword3"><span class="command">assume</span></span> nQ<span class="main">:</span> <span class="quoted"><span class="quoted">"nneg <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bQ<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> fSup <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span>
              Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Sup_trans_upper2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ nQ bQ<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">u</span><span class="main">∈</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">.</span>
                <span class="main">∀</span><span class="bound">R</span><span class="main">.</span> nneg <span class="bound">R</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="bound">R</span> <span class="main">⟶</span>
                     nneg <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span> <span class="main">∧</span> bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="bound">u</span> <span class="bound">R</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="main">=</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="main">∈</span>
                        range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span><span class="var">?F</span> <span class="var">?Y</span><span class="main">)</span> <span class="var">?Y</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> fSup <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="var">?Y</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Therefore, evaluated at a given point (state), the sequence of iterates gives a sequence
of real values that converges on that of the loop itself.›</span></span>
<span class="keyword1"><span class="command">corollary</span></span> loop_iterates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="free">P</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="free">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="free">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> closure_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup <span class="var">?X</span> <span class="main">∈</span> closure <span class="var">?X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> closure_contains_Sup<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="free">P</span> <span class="free">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>    
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="free">P</span> <span class="free">s</span><span class="main">)</span> <span class="main">⇢</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="free">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="free">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> LIMSEQ_I<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword3"><span class="command">assume</span></span> posr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> closure_Sup <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="var">?X</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ey<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">y</span> <span class="main">(</span>Sup <span class="var">?X</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>closure_approachable<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> yin <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> yit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="free">P</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">⟶</span> le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
        <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟶</span> le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
           <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Suc <span class="skolem">k</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≠</span> Suc <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> iterates_increasing<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">with</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="free">P</span> <span class="free">s</span> <span class="main">≤</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> bounded_by <span class="main">(</span>bound_of <span class="free">P</span><span class="main">)</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span> <span class="free">s</span> <span class="main">≤</span> bound_of <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span> <span class="free">s</span> <span class="main">≤</span> Sup <span class="var">?X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span>
                           norm <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">j</span> <span class="free">P</span> <span class="free">s</span> <span class="main">-</span> Sup <span class="var">?X</span><span class="main">)</span> <span class="main">≤</span>
                           norm <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="free">P</span> <span class="free">s</span> <span class="main">-</span> Sup <span class="var">?X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ey yit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"norm <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="free">P</span> <span class="free">s</span> <span class="main">-</span> Sup <span class="var">?X</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dist_real_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">no</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">≥</span><span class="bound">no</span><span class="main">.</span> norm <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">n</span> <span class="free">P</span> <span class="free">s</span> <span class="main">-</span>
                                    Sup <span class="main">{</span><span class="bound">f</span> <span class="free">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="free">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">}</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> hb cb sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="free">P</span> <span class="free">s</span> <span class="main">=</span> Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_iterates<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="free">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">t</span> <span class="free">P</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def Sup_exp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The iterates themselves are all continuous.›</span></span>
<span class="keyword1" id="LoopInduction-cts_iterates"><span class="command">lemma</span></span> cts_iterates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">::</span>real<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="main">(</span><span class="bound">s</span><span class="main">::</span><span class="tfree">'s</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> bd_ctsI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def Sup_exp_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cts_wp_PC cts_wp_Seq cts_wp_Embed cts_wp_Skip
                   healthy_intros iterates_healthy cb hb<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Therefore so is the loop itself.›</span></span>
<span class="keyword1" id="LoopInduction-cts_wp_loop"><span class="command">lemma</span></span> cts_wp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bd_ctsI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span><span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> chain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">M</span> <span class="bound">i</span> <span class="main">⊩</span> <span class="skolem">M</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> sM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> sound <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> bM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">b</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> sM bM iterates_healthy<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">i</span><span class="main">.</span> bounded_by <span class="skolem">b</span> <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> iB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j</span> <span class="bound">i</span> <span class="bound">s</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> sM bM <span class="keyword1"><span class="command">have</span></span> sSup<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_exp_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> lfp_iterates<span class="main">[</span><span class="operator">OF</span> hb cb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> chain sM bM
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Sup_exp <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>bd_ctsD cts_iterates<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb cb<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">t</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
           <span class="main">{</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="bound">t</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sym<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
           Sup_exp <span class="main">{</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="bound">t</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="bound">t</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
                           <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
          range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="var">?X</span> <span class="bound">s</span> <span class="main">=</span> <span class="var">?Y</span> <span class="bound">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> antisym subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> rwx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="skolem">t</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> rwx <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span> <span class="skolem">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
                     range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Y</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
            range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="skolem">s</span> <span class="main">∧</span>
                <span class="main">(</span><span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="bound">t</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
                     <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>A B C<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">{</span>Sup_exp <span class="main">(</span>range <span class="main">(</span><span class="bound">t</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> 
           <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_exp_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">::</span><span class="quoted">nat</span>
      <span class="keyword1"><span class="command">from</span></span> iB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> iB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper cSup_least bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                    Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cSup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>iB<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="main">.</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">=</span> <span class="var">?Y</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> cSup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>iB<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="var">?Y</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cSup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">::</span><span class="quoted">nat</span>
      <span class="keyword1"><span class="command">from</span></span> iB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> iB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cSup_upper cSup_least bdd_aboveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cSup_least<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"iterates <span class="free">body</span> <span class="free">G</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                    Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="bound">P</span> <span class="main">∧</span>
               <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="var">?X</span> <span class="bound">s</span> <span class="main">=</span> <span class="var">?Y</span> <span class="bound">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> antisym subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> rwx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span>
              range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span>
                           <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="bound">P</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> o_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Y</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">x</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?Y</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> rwx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
                      <span class="keyword2"><span class="keyword">and</span></span> Pin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">∈</span> range <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span>
                            <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="bound">P</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">∘</span> <span class="skolem">M</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span>
                                                 <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span>
                  range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">{</span><span class="bound">f</span> <span class="bound">s</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="main">∃</span><span class="bound">t</span><span class="main">.</span> <span class="bound">f</span> <span class="main">=</span> <span class="bound">t</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">∈</span> range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="skolem">j</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>rwx<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?X</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">j</span> <span class="main">.</span>Sup <span class="main">(</span>range <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="skolem">M</span> <span class="bound">j</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          Sup_exp <span class="main">(</span>range <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_exp_def Sup_trans_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> SUP_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_exp <span class="main">(</span>range <span class="main">(</span>Sup_trans <span class="main">(</span>range <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
             Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def equiv_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lfp_iterates<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb cb<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> sM<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span>Sup_exp <span class="main">(</span>range <span class="skolem">M</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
                Sup_exp <span class="main">(</span>range <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="keyword1">o</span> <span class="skolem">M</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> cts_intros <span class="main">=</span>
  cts_wp_Abort  cts_wp_Skip
  cts_wp_Seq    cts_wp_PC
  cts_wp_DC     cts_wp_Embed
  cts_wp_Apply  cts_wp_SetDC
  cts_wp_SetPC  cts_wp_Bind
  cts_wp_repeat

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sublinearity">
<div class="head">
<h1>Theory Sublinearity</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sublinearity <span class="keyword2"><span class="keyword">imports</span></span> <a href="Embedding.html">Embedding</a> <a href="Healthiness.html">Healthiness</a> <a href="LoopInduction.html">LoopInduction</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nonrecursive Primitives›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity of non-recursive programs is generally straightforward, and follows from the
alebraic properties of the underlying operations, together with healthiness.›</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Skip"><span class="command">lemma</span></span> sublinear_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Abort"><span class="command">lemma</span></span> sublinear_wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp Abort<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Apply"><span class="command">lemma</span></span> sublinear_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Seq"><span class="command">lemma</span></span> sublinear_wp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slx<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sly<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hx<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">x</span><span class="main">)</span>"</span></span>   <span class="keyword2"><span class="keyword">and</span></span> hy<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">x</span> <span class="main">;;</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> slx hy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
                    wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sublinearD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>      
    <span class="keyword1"><span class="command">from</span></span> sP sQ nna nnb nnc sly
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
              wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sublinearD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP sQ hy
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> nna nnb nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_intros tminus_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP sQ nna nnb nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sound_intros tminus_sound<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> hy <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
          wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> hx<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
                wp <span class="free">x</span> <span class="main">(</span>wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_PC"><span class="command">lemma</span></span> sublinear_wp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slx<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sly<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">y</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">x</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">=</span>
        <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
              <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
              <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span>
              <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">c</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span>
              <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span>
             <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span>  <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_left_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sQ sR nna nnb nnc slx
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
          wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> sQ sR nna nnb nnc sly
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
          wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span>  <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span>
          <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
         <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
         <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
         <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_DC"><span class="command">lemma</span></span> sublinear_wp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slx<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sly<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">x</span> <span class="main">⨅</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> nna nnb
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="skolem">b</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">=</span>
        min <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        min <span class="main">(</span><span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> min <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span>
                  <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>tminus_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> min <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>
                  <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> min_tminus_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> slx sQ sR nna nnb nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
          wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> sly sQ sR nna nnb nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
          wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span>
              <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span>
          min <span class="main">(</span>wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
              <span class="main">(</span>wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">x</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                <span class="skolem">b</span> <span class="main">*</span> min <span class="main">(</span>wp <span class="free">x</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">y</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
               min <span class="main">(</span>wp <span class="free">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>
                   <span class="main">(</span>wp <span class="free">y</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As for continuity, we insist on a finite support.›</span></span>
<span class="keyword1" id="Sublinearity-sublinear_wp_SetPC"><span class="command">lemma</span></span> sublinear_wp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">p</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sR<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span> sum_distrib_left sum.distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊖</span>
             <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> tminus_right_antimono<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sum_distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sum <span class="keyword2"><span class="keyword">and</span></span> nnc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_sum_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nnP tminus_left_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> slp sQ sR nna nnb nnc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a'</span><span class="main">.</span> <span class="bound">a'</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
                                    wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nnP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="skolem">b</span> <span class="main">*</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">a'</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a'</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_SetDC"><span class="command">lemma</span></span> sublinear_wp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> slp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hp<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cInf_greatest<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> nna<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">pr</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">pr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">assume</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">pr</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">pr</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rwy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> xin hp sP nna
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cInf_lower<span class="main"><span class="main">]</span></span> bdd_belowI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> xin hp sQ nnb
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> mult_left_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> cInf_lower<span class="main"><span class="main">]</span></span> bdd_belowI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
        <span class="skolem">b</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span>
        <span class="skolem">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="skolem">c</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_left_mono add_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin slp sP sQ nna nnb nnc
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">a</span> <span class="main">*</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">*</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>rwy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Embed"><span class="command">lemma</span></span> sublinear_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Sublinearity-sublinear_wp_repeat"><span class="command">lemma</span></span> sublinear_wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sublinear <span class="main">(</span>wp <span class="free">p</span><span class="main">)</span><span class="main">;</span> healthy <span class="main">(</span>wp <span class="free">p</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sublinear_wp_Seq sublinear_wp_Skip healthy_wp_repeat<span class="main">)</span>

<span class="keyword1" id="Sublinearity-sublinear_wp_Bind"><span class="command">lemma</span></span> sublinear_wp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sublinear <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sublinearI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sublinearity for Loops›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We break the proof of sublinearity loops into separate proofs of sub-distributivity and
sub-additivity.  The first follows by transfinite induction.›</span></span>
<span class="keyword1" id="Sublinearity-sub_distrib_wp_loop"><span class="command">lemma</span></span> sub_distrib_wp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdb<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hb<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nhb<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> 
                          wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> loop_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hb nhb<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> trans <span class="main">×</span> <span class="tfree">'s</span> trans<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> saS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> fst <span class="bound">x</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> fS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> feasible <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> sPm<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> nnSup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def Sup_exp_def<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fS sPm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> fst <span class="skolem">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin fS sPm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_upper2<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> fst <span class="bound">x</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">(</span>fst <span class="bound">x</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> saS sP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span> <span class="main">⟹</span> <span class="main">(</span>fst <span class="bound">x</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> fst <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span> <span class="main">⟹</span> fst <span class="bound">x</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span>
                                   Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> add_right_mono le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_upper2<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> fst <span class="bound">x</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nnSup <span class="keyword1"><span class="command">have</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_nonneg_nonneg<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> leSup<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Sup_trans_def
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_exp_least<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nnSup<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> leSup <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span>
                       Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">1</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">a</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="skolem">t</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>

     <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>
     <span class="keyword1"><span class="command">with</span></span> ft <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">from</span></span> sP ft <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command">hence</span></span> s3<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
          wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">a</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span>
            <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                        <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_add_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_left_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> ft sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sub_distribD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sdb<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword1"><span class="command">from</span></span> IH sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> sP ft s2 s3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span>
                      <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_right_mono mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
                    <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">t'</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> <span class="skolem">t</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">a</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv_trans <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">t</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">t'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sub_distribI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For sub-additivity, we again use the limit-of-iterates characterisation.  Firstly, all
iterates are sublinear:›</span></span>
<span class="keyword1" id="Sublinearity-sublinear_iterates"><span class="command">lemma</span></span> sublinear_iterates<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sb<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>iterates <span class="free">body</span> <span class="free">G</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sublinear_wp_PC sublinear_wp_Seq sublinear_wp_Skip sublinear_wp_Embed
                           assms healthy_intros iterates_healthy<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From this, sub-additivity follows for the limit (i.e. the loop), by appealing to the
property at all steps.›</span></span>
<span class="keyword1" id="Sublinearity-sub_add_wp_loop"><span class="command">lemma</span></span> sub_add_wp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sb<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span>  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwp<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_add <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> hwp cb sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> loop_iterates<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> hwp cb sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> loop_iterates<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span>
        wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tendsto_add<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sublinear_subadd<span class="main">[</span><span class="operator">OF</span> sublinear_iterates<span class="main">,</span> <span class="operator">OF</span> hwp sb<span class="main">,</span>
                          <span class="operator">OF</span> healthy_feasibleD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> iterates_healthy<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hwp<span class="main"><span class="main">]</span></span><span class="main">]</span> sP sQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_addD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sP sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hwp cb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> iterates <span class="free">body</span> <span class="free">G</span> <span class="bound">i</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⇢</span>
                           wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>loop_iterates<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>LIMSEQ_le<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sublinearity-sublinear_wp_loop"><span class="command">lemma</span></span> sublinear_wp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hb<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nhb<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sb<span class="main">:</span>  <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> cb<span class="main">:</span>  <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> sublinear_sub_distrib<span class="main">[</span><span class="operator">OF</span> sb<span class="main">]</span> sublinear_subadd<span class="main">[</span><span class="operator">OF</span> sb<span class="main">]</span>
         hb healthy_feasibleD<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sd_sa_sublinear<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ _ healthy_wp_loop<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> hb<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
                    sub_distrib_wp_loop sub_add_wp_loop assms<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> sublinear_intros <span class="main">=</span>
  sublinear_wp_Abort
  sublinear_wp_Skip
  sublinear_wp_Apply
  sublinear_wp_Seq
  sublinear_wp_PC
  sublinear_wp_DC
  sublinear_wp_SetPC
  sublinear_wp_SetDC
  sublinear_wp_Embed
  sublinear_wp_repeat
  sublinear_wp_Bind
  sublinear_wp_loop

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="WellDefined">
<div class="head">
<h1>Theory WellDefined</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Well-Defined Programs.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> WellDefined <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Healthiness.html">Healthiness</a>
  <a href="Sublinearity.html">Sublinearity</a>
  <a href="LoopInduction.html">LoopInduction</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of a well-defined program collects the various notions of healthiness and
well-behavedness that we have so far established: healthiness of the strict and liberal
transformers, continuity and sublinearity of the strict transformers, and two new properties.
These are that the strict transformer always lies below the liberal one (i.e. that it is at least
as \emph{strict}, recalling the standard embedding of a predicate), and that expectation
conjunction is distributed between then in a particular manner, which will be crucial in
establishing the loop rules.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strict Implies Liberal›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This establishes the first connection between the strict and
  liberal interpretations (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wlp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>).›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wp_under_wlp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wp_under_wlp</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">P</span> <span class="main">⊩</span> wlp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">P</span>"</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlpI"><span class="command">lemma</span></span> wp_under_wlpI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="bound">P</span> <span class="main">⊩</span> wlp <span class="free">prog</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> wp_under_wlp <span class="free">prog</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_under_wlp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlpD"><span class="command">lemma</span></span> wp_under_wlpD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> wp_under_wlp <span class="free">prog</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">prog</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_under_wlp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_le_trans"><span class="command">lemma</span></span> wp_under_le_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">a</span> <span class="main">⟹</span> le_utrans <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Abort"><span class="command">lemma</span></span> wp_under_wlp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_under_wlp Abort"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Skip"><span class="command">lemma</span></span> wp_under_wlp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_under_wlp Skip"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Apply"><span class="command">lemma</span></span> wp_under_wlp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Seq"><span class="command">lemma</span></span> wp_under_wlp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h_wlp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_u_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_u_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> h_wp_b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> wp_u_a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> wp_u_b <span class="keyword2"><span class="keyword">and</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">P</span> <span class="main">⊩</span> wlp <span class="free">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> h_wlp_a <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b <span class="keyword2"><span class="keyword">and</span></span> h_wp_b <span class="keyword2"><span class="keyword">and</span></span> uP
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>nearly_healthy_monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> h_wlp_a<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_PC"><span class="command">lemma</span></span> wp_under_wlp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> h_wp_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_a<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_u_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_u_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span>      <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword2"><span class="keyword">and</span></span> wp_u_b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword2"><span class="keyword">and</span></span> wp_u_a <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp  <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp  <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_DC"><span class="command">lemma</span></span> wp_under_wlp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_u_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_u_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> wp_u_a uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> wp_u_b uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_SetPC"><span class="command">lemma</span></span> wp_under_wlp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_u_f<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> wp_under_wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nP<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> wp_u_f uQ nP
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_SetDC"><span class="command">lemma</span></span> wp_under_wlp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp_u_f<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> wp_under_wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hf<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nS<span class="main">:</span>      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span>SetDC <span class="free">f</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> cInf_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> nS <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xrw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> wlp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wp_u_f uQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ain <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>xrw<span class="main">)</span>

  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> yin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yrw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> hf uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="main">(</span><span class="free">f</span> <span class="skolem">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> yrw <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Embed"><span class="command">lemma</span></span> wp_under_wlp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_loop"><span class="command">lemma</span></span> wp_under_wlp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hwp<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwlp<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wp_under<span class="main">:</span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_under_wlpI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Y</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="skolem">P</span> <span class="free">s</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>hwp hwlp sP uP wp_Loop1 wlp_Loop1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gfp_exp_upperbound<span class="main">)</span>
    <span class="keyword1"><span class="command">thm</span></span> lfp_loop_fp
    <span class="keyword1"><span class="command">from</span></span> hwp sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="var">?X</span> <span class="main">=</span> <span class="var">?X</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> lfp_wp_loop_unfold<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="var">?X</span> <span class="main">⊩</span> <span class="var">?X</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> hwp uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="free">body</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_under_wlpD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wp_under<span class="main"><span class="main">]</span></span> lfp_loop_unitary<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span> <span class="main">⊩</span> <span class="var">?Y</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_exp <span class="var">?X</span> <span class="main">⊩</span> <span class="var">?Y</span> <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> hwp uP <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>lfp_exp <span class="var">?X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>lfp_loop_unitary<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wp_under_wlp_repeat"><span class="command">lemma</span></span> wp_under_wlp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span><span class="main">;</span> nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span><span class="main">;</span> wp_under_wlp <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span>
   wp_under_wlp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wp_under_wlp_Skip wp_under_wlp_Seq healthy_intros<span class="main">)</span>

<span class="keyword1" id="WellDefined-wp_under_wlp_Bind"><span class="command">lemma</span></span> wp_under_wlp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp_under_wlp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> wp_under_wlp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_under_wlp_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wp_under_wlp_intros <span class="main">=</span>
  wp_under_wlp_Abort wp_under_wlp_Skip
  wp_under_wlp_Apply wp_under_wlp_Seq
  wp_under_wlp_PC    wp_under_wlp_DC
  wp_under_wlp_SetPC wp_under_wlp_SetDC
  wp_under_wlp_Embed wp_under_wlp_loop
  wp_under_wlp_repeat wp_under_wlp_Bind

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sub-Distributivity of Conjunction›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">sub_distrib_pconj</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_distrib_pconj</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">≡</span>
   <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">P</span> <span class="main">⟶</span> unitary <span class="bound">Q</span> <span class="main">⟶</span>
         wlp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">Q</span> <span class="main">⊩</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WellDefined-sub_distrib_pconjI"><span class="command">lemma</span></span> sub_distrib_pconjI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>  wlp <span class="free">prog</span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">prog</span> <span class="bound">Q</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    sub_distrib_pconj <span class="free">prog</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_distrib_pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-sub_distrib_pconjD"><span class="command">lemma</span></span> sub_distrib_pconjD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> sub_distrib_pconj <span class="free">prog</span><span class="main">;</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
   wlp <span class="free">prog</span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">prog</span> <span class="bound">Q</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_distrib_pconj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-sdp_Abort"><span class="command">lemma</span></span> sdp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sub_distrib_pconj Abort"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>exp_conj_rzero<span class="main">)</span>

<span class="keyword1" id="WellDefined-sdp_Skip"><span class="command">lemma</span></span> sdp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sub_distrib_pconj Skip"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="WellDefined-sdp_Seq"><span class="command">lemma</span></span> sdp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp_a<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sdp_b<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> h_wp_b <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>sub_distrib_pconjD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sdp_a<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sdp_b <span class="keyword2"><span class="keyword">and</span></span> uP <span class="keyword2"><span class="keyword">and</span></span> uQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">b</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> h_wp_a h_wp_b h_wlp_b uP uQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> h_wp_a<span class="main"><span class="main">]</span></span> unitary_sound
                      unitary_intros sound_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_Apply"><span class="command">lemma</span></span> sdp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="WellDefined-sdp_DC"><span class="command">lemma</span></span> sdp_DC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp_a<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sdp_b<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        min <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> min_pconj<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> wlp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> wlp <span class="free">a</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sdp_a uP uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>sub_distrib_pconjD<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> wlp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> wlp <span class="free">b</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sdp_b uP uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
          min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        min <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_PC"><span class="command">lemma</span></span> sdp_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp_a<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sdp_b<span class="main">:</span>   <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_a<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wp_b<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h_wlp_b<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span>      <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> nnA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> nnB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uP <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> nn <span class="main">=</span> nnA nnB

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span>  wp <span class="free">a</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span>  wp <span class="free">b</span> <span class="skolem">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
         <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>  wp <span class="free">a</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span>  wp <span class="free">b</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>       <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>       <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span>
                   <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>       <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span>       <span class="main">*</span> <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>nn tminus_left_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>       <span class="main">(</span><span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
                   <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sdp_a sdp_b uQ uR
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> entailsD mult_left_mono nn sub_distrib_pconjD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span>       <span class="main">(</span><span class="main">(</span>wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
           <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="main">(</span>wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
           <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span>  wp <span class="free">a</span> <span class="skolem">R</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span>  wp <span class="free">b</span> <span class="skolem">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                <span class="free">P</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_Embed"><span class="command">lemma</span></span> sdp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="free">t</span> <span class="bound">Q</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="bound">P</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   sub_distrib_pconj <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="WellDefined-sdp_repeat"><span class="command">lemma</span></span> sdp_repeat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdpa<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwp<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> hwlp<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sdp_Skip<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> hwlpa<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
                <span class="keyword2"><span class="keyword">and</span></span> hwpa<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword2"><span class="keyword">and</span></span> hwlpa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword2"><span class="keyword">and</span></span> hwpa <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span>
          wp <span class="free">a</span> <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sdpa <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> hwlp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> healthy_intros<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> hwp uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> exp_conj_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> uP uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>exp_conj_sound<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_intros<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uP uQ IH
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span> wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span>
            wp <span class="free">a</span> <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hwp<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">&amp;&amp;</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span>
                  wp <span class="free">a</span> <span class="main">(</span>wp <span class="main">(</span>repeat <span class="skolem">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_SetPC"><span class="command">lemma</span></span> sdp_SetPC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> sub_distrib_pconj <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sum <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span>SetPC <span class="free">p</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
         <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span>  wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
        <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.distrib <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sub
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊖</span>
              <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_right_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> fin
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_sum_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_left_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> sdp uQ uR
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sub_distrib_pconjD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> nnp
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span>
          <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sum_mono mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">&amp;&amp;</span>
                 <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">R</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="skolem">s</span> <span class="bound">a</span> <span class="main">*</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_SetDC"><span class="command">lemma</span></span> sdp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> sub_distrib_pconj <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwlp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> uP hwlp
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> unitary <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> wlp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uQ hwp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span>  <span class="main">0</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> wlp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
                      wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>tminus_left_mono add_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span> <span class="main">(</span>wlp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sdp uP uQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span> <span class="main">⟹</span> <span class="main">...</span> <span class="bound">a</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="main">...</span> <span class="bound">a</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wlp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def pconj_def wp_eval
    <span class="keyword1"><span class="command">using</span></span> ne <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-sdp_Bind"><span class="command">lemma</span></span> sdp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sub_distrib_pconj <span class="main">(</span><span class="free">p</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> sub_distrib_pconj <span class="main">(</span>Bind <span class="free">f</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sub_distrib_pconj_def wp_eval exp_conj_def pconj_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For loops, we again appeal to our transfinite induction principle, this time taking
advantage of the simultaneous treatment of both strict and liberal transformers.›</span></span>
<span class="keyword1" id="WellDefined-sdp_loop"><span class="command">lemma</span></span> sdp_loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sdp_body<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="free">body</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwlp<span class="main">:</span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="free">body</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> hwp<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> loop_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hwp hwlp<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> trans <span class="main">×</span> <span class="tfree">'s</span> trans<span class="main">)</span> set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ffst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> feasible <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> usnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span> unitary <span class="main">(</span>snd <span class="bound">x</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> snd <span class="bound">x</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> fst <span class="bound">x</span> <span class="skolem">Q</span> <span class="main">⊩</span> fst <span class="bound">x</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span>
                  Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Inf_trans_def Sup_trans_def Inf_utrans_def
                  Inf_exp_def Sup_exp_def exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="free">s</span> <span class="main">-</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="free">s</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> tin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> uin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> tin ffst uP uQ <span class="keyword1"><span class="command">have</span></span> utPQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>exp_conj_unitary<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> ffst tin <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"le_utrans <span class="skolem">t</span> <span class="main">(</span>Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>Sup_trans_upper<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>exp_conj_unitary<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> nn_rhs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span><span class="main">.</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="bound">R</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">R</span> <span class="main">≤</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">R</span> <span class="main">≤</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="var">?f</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> gt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> nn_rhs <span class="keyword1"><span class="command">have</span></span> g1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="var">?f</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> g1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="var">?f</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> gt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> g1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="skolem">R</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_def<span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">finally</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">.</span> Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="bound">t</span> <span class="skolem">Q</span>  <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> tin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> xin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> xin <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">∈</span> snd <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> uP usnd <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> snd <span class="skolem">x</span> <span class="skolem">P</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_utransD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Inf_utrans_lower<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> fst <span class="skolem">x</span> <span class="skolem">Q</span> <span class="main">⊩</span> snd <span class="skolem">x</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> fst <span class="skolem">x</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_frame<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> fst <span class="skolem">x</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> xin ffst exp_conj_unitary<span class="main">[</span><span class="operator">OF</span> uP uQ<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_utransD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Sup_trans_upper<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fx<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> bt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">.</span> <span class="bound">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">=</span> Sup_exp <span class="main">{</span><span class="bound">t</span> <span class="skolem">Q</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">S</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Sup_trans_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="var">?f</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> Sup_exp_least<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> bt <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">" <span class="main">∀</span><span class="bound">R</span><span class="main">∈</span><span class="main">{</span><span class="bound">t</span> <span class="skolem">Q</span> <span class="main">|</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">S</span><span class="main">}</span><span class="main">.</span> <span class="bound">R</span> <span class="main">⊩</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> tin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> fst <span class="main">`</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> ffst uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> tin bt <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">+</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span> <span class="bound">s</span> <span class="main">-</span>
                          Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span>
                  Inf_utrans <span class="main">(</span>snd <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="var">?f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_frame<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nn_rhs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> Sup_trans <span class="main">(</span>fst <span class="main">`</span> <span class="skolem">S</span><span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> ft<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="skolem">t</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> uu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> unitary <span class="main">(</span><span class="skolem">u</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wlp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span>
        wp  <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="skolem">Q</span> <span class="main">⊩</span>
        wp  <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval exp_conj_def pconj_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">=</span>
          <span class="main">(</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
           <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span>
          <span class="main">(</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span>
           <span class="main">(</span><span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> tminus_add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>
          <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span>
           <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>tminus_left_distrib distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> uP uQ ft uu
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">&amp;&amp;</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sub_distrib_pconjD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sdp_body<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> IH unitary_sound<span class="main">[</span><span class="operator">OF</span> uP<span class="main">]</span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uQ<span class="main">]</span> ft
                   unitary_sound<span class="main">[</span><span class="operator">OF</span> uu<span class="main"><span class="main">[</span></span><span class="operator">OF</span> uP<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mono_transD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hwp<span class="main"><span class="main">]</span></span> exp_conj_sound<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
                    wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span>
             <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
             <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_right_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="main">(</span><span class="skolem">u</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⊖</span> <span class="main">1</span> <span class="main">≤</span>
          <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span>
          <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">⊖</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">u</span> <span class="skolem">u'</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
         <span class="quoted"><span class="quoted">"equiv_trans <span class="skolem">t</span> <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"equiv_utrans <span class="skolem">u</span> <span class="skolem">u'</span>"</span></span>
         <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">t</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">t</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u'</span> <span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">t'</span> <span class="skolem">Q</span> <span class="main">⊩</span> <span class="skolem">t'</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">&amp;&amp;</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>equiv_transD unitary_sound equiv_utransD exp_conj_unitary<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sdp_intros <span class="main">=</span>
  sdp_Abort  sdp_Skip  sdp_Apply
  sdp_Seq    sdp_DC    sdp_PC
  sdp_SetPC  sdp_SetDC sdp_Embed
  sdp_repeat sdp_Bind  sdp_loop

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Well-Defined Predicate.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">well_def</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">well_def</span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">≡</span> healthy <span class="main">(</span>wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">)</span> <span class="main">∧</span> nearly_healthy <span class="main">(</span>wlp <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">)</span>
                 <span class="main">∧</span> wp_under_wlp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main">∧</span> sub_distrib_pconj <span class="free"><span class="bound"><span class="entity">prog</span></span></span>
                 <span class="main">∧</span> sublinear <span class="main">(</span>wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">)</span> <span class="main">∧</span> bd_cts <span class="main">(</span>wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="WellDefined-well_defI"><span class="command">lemma</span></span> well_defI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span><span class="main">;</span> nearly_healthy <span class="main">(</span>wlp <span class="free">prog</span><span class="main">)</span><span class="main">;</span>
     wp_under_wlp <span class="free">prog</span><span class="main">;</span> sub_distrib_pconj <span class="free">prog</span><span class="main">;</span> sublinear <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span><span class="main">;</span>
     bd_cts <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   well_def <span class="free">prog</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_wp_healthy"><span class="command">lemma</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> healthy <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_wlp_nearly_healthy"><span class="command">lemma</span></span> well_def_wlp_nearly_healthy<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="free">prog</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_wp_under"><span class="command">lemma</span></span> well_def_wp_under<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> wp_under_wlp <span class="free">prog</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_sdp"><span class="command">lemma</span></span> well_def_sdp<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> sub_distrib_pconj <span class="free">prog</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_wp_sublinear"><span class="command">lemma</span></span> well_def_wp_sublinear<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> sublinear <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="WellDefined-well_def_wp_cts"><span class="command">lemma</span></span> well_def_wp_cts<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">prog</span> <span class="main">⟹</span> bd_cts <span class="main">(</span>wp <span class="free">prog</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> well_def_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wd_dests <span class="main">=</span>
  well_def_wp_healthy well_def_wlp_nearly_healthy
  well_def_wp_under well_def_sdp
  well_def_wp_sublinear well_def_wp_cts

<span class="keyword1" id="WellDefined-wd_Abort"><span class="command">lemma</span></span> wd_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def Abort"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_Abort nearly_healthy_wlp_Abort
                 wp_under_wlp_Abort sdp_Abort sublinear_wp_Abort
                 cts_wp_Abort<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_Skip"><span class="command">lemma</span></span> wd_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def Skip"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_Skip nearly_healthy_wlp_Skip
                 wp_under_wlp_Skip sdp_Skip sublinear_wp_Skip
                 cts_wp_Skip<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_Apply"><span class="command">lemma</span></span> wd_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_Apply nearly_healthy_wlp_Apply
                 wp_under_wlp_Apply sdp_Apply sublinear_wp_Apply
                 cts_wp_Apply<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_Seq"><span class="command">lemma</span></span> wd_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> well_def <span class="free">a</span><span class="main">;</span> well_def <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_Seq nearly_healthy_wlp_Seq
                 wp_under_wlp_Seq sdp_Seq sublinear_wp_Seq
                 cts_wp_Seq<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_PC"><span class="command">lemma</span></span> wd_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> well_def <span class="free">a</span><span class="main">;</span> well_def <span class="free">b</span><span class="main">;</span> unitary <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_PC nearly_healthy_wlp_PC
                 wp_under_wlp_PC sdp_PC sublinear_wp_PC
                 cts_wp_PC<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_DC"><span class="command">lemma</span></span> wd_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> well_def <span class="free">a</span><span class="main">;</span> well_def <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_DC nearly_healthy_wlp_DC
                 wp_under_wlp_DC sdp_DC sublinear_wp_DC
                 cts_wp_DC<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_SetDC"><span class="command">lemma</span></span> wd_SetDC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span><span class="free">S</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span>SetDC <span class="free">a</span> <span class="free">S</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cts_wp_SetDC ex_in_conv healthy_intros<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> healthy_intros<span class="main"><span class="main">(</span></span>18<span class="main"><span class="main">)</span></span> sdp_intros<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> sublinear_intros<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> well_def_def wp_under_wlp_intros<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1" id="WellDefined-wd_SetPC"><span class="command">lemma</span></span> wd_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> unitary <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
     <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sum <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span>SetPC <span class="free">a</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>well_defI healthy_wp_SetPC nearly_healthy_wlp_SetPC
                    wp_under_wlp_SetPC sdp_SetPC sublinear_wp_SetPC cts_wp_SetPC
             <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>wd_dests unitary_sound sound_nneg<span class="main"><span class="main">[</span></span><span class="operator">OF</span> unitary_sound<span class="main"><span class="main">]</span></span> nnegD<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_Embed"><span class="command">lemma</span></span> wd_Embed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"sublinear <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ct<span class="main">:</span> <span class="quoted"><span class="quoted">"bd_cts <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"well_def <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> well_defI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ht <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"nearly_healthy <span class="main">(</span>wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def wlp_def Embed_def healthy_nearly_healthy<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> st <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def Embed_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp_under_wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_under_wlp_def wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sub_distrib_pconjI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funI<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sublinearD<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> st<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> a<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> b<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">1</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span> c<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="main">1</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>exp_conj_def pconj_def wp_def wlp_def Embed_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ct <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bd_cts <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def Embed_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="WellDefined-wd_repeat"><span class="command">lemma</span></span> wd_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">a</span> <span class="main">⟹</span> well_def <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_repeat nearly_healthy_wlp_repeat
                 wp_under_wlp_repeat sdp_repeat sublinear_wp_repeat cts_wp_repeat<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_Bind"><span class="command">lemma</span></span> wd_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> well_def <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> well_def <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_Bind nearly_healthy_wlp_Bind
                 wp_under_wlp_Bind sdp_Bind sublinear_wp_Bind cts_wp_Bind<span class="main">)</span>

<span class="keyword1" id="WellDefined-wd_loop"><span class="command">lemma</span></span> wd_loop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">body</span> <span class="main">⟹</span> well_def <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_wp_loop nearly_healthy_wlp_loop
                 wp_under_wlp_loop sdp_loop sublinear_wp_loop cts_wp_loop<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wd_intros <span class="main">=</span>
  wd_Abort wd_Skip   wd_Apply
  wd_Embed wd_Seq    wd_PC
  wd_DC    wd_SetPC  wd_SetDC
  wd_Bind  wd_repeat wd_loop

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Algebra">
<div class="head">
<h1>Theory Algebra</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Algebra of pGCL"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Algebra <span class="keyword2"><span class="keyword">imports</span></span> <a href="WellDefined.html">WellDefined</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:Algebra}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Programs in pGCL have a rich algebraic structure, largely mirroring that for GCL. We show
that programs form a lattice under refinement, with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨅</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨆</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as the meet
and join operators, respectively. We also take advantage of the algebraic structure to establish a
framwork for the modular decomposition of proofs.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Program Refinement›</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:progref}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement in pGCL relates to refinement in GCL exactly as probabilistic entailment relates
to implication. It turns out to have a very similar algebra, the rules of which we establish
shortly.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">refines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊑</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main"><span class="free">⊑</span></span> <span class="free"><span class="bound"><span class="entity">prog'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">P</span> <span class="main">⊩</span> wp <span class="free"><span class="bound"><span class="entity">prog'</span></span></span> <span class="bound">P</span>"</span></span>

<span class="keyword1" id="Algebra-refinesI"><span class="command">lemma</span></span> refinesI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="bound">P</span> <span class="main">⊩</span> wp <span class="free">prog'</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">prog</span> <span class="main">⊑</span> <span class="free">prog'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-refinesD"><span class="command">lemma</span></span> refinesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prog</span> <span class="main">⊑</span> <span class="free">prog'</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog'</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> refines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The equivalence relation below will turn out to be that induced by refinement. It is also
the application of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">equiv_trans</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to the weakest precondition.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pequiv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≃</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="main"><span class="free">≃</span></span> <span class="free"><span class="bound"><span class="entity">prog'</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟶</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="bound">P</span> <span class="main">=</span> wp <span class="free"><span class="bound"><span class="entity">prog'</span></span></span> <span class="bound">P</span>"</span></span>

<span class="keyword1" id="Algebra-pequivI"><span class="command">lemma</span></span> pequivI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="bound">P</span> <span class="main">=</span> wp <span class="free">prog'</span> <span class="bound">P</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">prog</span> <span class="main">≃</span> <span class="free">prog'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequivD"><span class="command">lemma</span></span> pequivD<span class="main">[</span><span class="operator">dest</span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">prog</span> <span class="main">≃</span> <span class="free">prog'</span><span class="main">;</span> sound <span class="free">P</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">prog</span> <span class="free">P</span> <span class="main">=</span> wp <span class="free">prog'</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_equiv_trans"><span class="command">lemma</span></span> pequiv_equiv_trans<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≃</span> <span class="free">b</span> <span class="main">⟷</span> equiv_trans <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simple Identities›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following identities involve only the primitive operations as defined in
\autoref{s:syntax}, and refinement as defined above.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws following from the basic arithmetic of the operators seperately›</span></span>

<span class="keyword1" id="Algebra-DC_comm"><span class="command">lemma</span></span> DC_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⨅</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-DC_assoc"><span class="command">lemma</span></span> DC_assoc<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨅</span> <span class="main">(</span><span class="free">b</span> <span class="main">⨅</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">⨅</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-DC_idem"><span class="command">lemma</span></span> DC_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨅</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-AC_comm"><span class="command">lemma</span></span> AC_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="main">⨆</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> AC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-AC_assoc"><span class="command">lemma</span></span> AC_assoc<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨆</span> <span class="main">(</span><span class="free">b</span> <span class="main">⨆</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="main">⨆</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> AC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-AC_idem"><span class="command">lemma</span></span> AC_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⨆</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> AC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-PC_quasi_comm"><span class="command">lemma</span></span> PC_quasi_comm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">p</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span> <span class="main">=</span> <span class="free">b</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="bound">s</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-PC_idem"><span class="command">lemma</span></span> PC_idem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">p</span></sub><span class="hidden">⇙</span>⊕ <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PC_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-Seq_assoc"><span class="command">lemma</span></span> Seq_assoc<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">;;</span> <span class="main">(</span><span class="free">B</span> <span class="main">;;</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">;;</span> <span class="free">B</span> <span class="main">;;</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Seq_def o_def<span class="main">)</span>

<span class="keyword1" id="Algebra-Abort_refines"><span class="command">lemma</span></span> Abort_refines<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def <span class="free">a</span> <span class="main">⟹</span> Abort <span class="main">⊑</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>well_def_wp_healthy<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws relating demonic choice and refinement›</span></span>

<span class="keyword1" id="Algebra-left_refines_DC"><span class="command">lemma</span></span> left_refines_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>refinesI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Algebra-right_refines_DC"><span class="command">lemma</span></span> right_refines_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>refinesI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Algebra-DC_refines"><span class="command">lemma</span></span> DC_refines<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">b</span> <span class="main">⨅</span> <span class="free">c</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">c</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>refinesD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">b</span> <span class="main">⨅</span> <span class="free">c</span><span class="main">)</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>min.boundedI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-DC_mono"><span class="command">lemma</span></span> DC_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">b</span> <span class="main">⨅</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">c</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">d</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">c</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">d</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws relating angelic choice and refinement›</span></span>

<span class="keyword1" id="Algebra-left_refines_AC"><span class="command">lemma</span></span> left_refines_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>refinesI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Algebra-right_refines_AC"><span class="command">lemma</span></span> right_refines_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>refinesI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Algebra-AC_refines"><span class="command">lemma</span></span> AC_refines<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">c</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rbc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">c</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span>
              <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">c</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>refinesD<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">c</span> <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-AC_mono"><span class="command">lemma</span></span> AC_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> rcd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">⊑</span> <span class="free">d</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">c</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">b</span> <span class="main">⨆</span> <span class="free">d</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">c</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">d</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"max <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">c</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> max <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">d</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws depending on the arithmetic of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="hidden">⇘</span><sub><span class="free"><span class="free">p</span></span></sub><span class="hidden">⇙</span>⊕ <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨅</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
together›</span></span>

<span class="keyword1" id="Algebra-DC_refines_PC"><span class="command">lemma</span></span> DC_refines_PC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">p</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> unit <span class="keyword1"><span class="command">have</span></span> nn_p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> unit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nn_np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>min.absorb1 min.absorb2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> le <span class="main">=</span> this
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> le <span class="keyword2"><span class="keyword">and</span></span> nn_np <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> le <span class="keyword2"><span class="keyword">and</span></span> nn_p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> mult_left_mono<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
        <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_right_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws depending on the arithmetic of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="hidden">⇘</span><sub><span class="free"><span class="free">p</span></span></sub><span class="hidden">⇙</span>⊕ <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨆</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
together›</span></span>

<span class="keyword1" id="Algebra-PC_refines_AC"><span class="command">lemma</span></span> PC_refines_AC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">p</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> refinesI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sound<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> unit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> nn_np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
        max <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> leab <span class="main">=</span> this
    <span class="keyword1"><span class="command">with</span></span> unit nn_np
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
          <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> leab
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> leba <span class="main">=</span> this
    <span class="keyword1"><span class="command">with</span></span> unit nn_np
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span>
          <span class="free">p</span> <span class="skolem">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> leba
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> max <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws depending on the arithmetic of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨆</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨅</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> together
›</span></span>

<span class="keyword1" id="Algebra-DC_refines_AC"><span class="command">lemma</span></span> DC_refines_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">⊑</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>refinesI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Laws Involving Refinement and Equivalence›</span></span>

<span class="keyword1" id="Algebra-pr_trans"><span class="command">lemma</span></span> pr_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prAB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊑</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> prBC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊑</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊑</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> prAB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword2"><span class="keyword">and</span></span> prBC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="skolem">P</span> <span class="main">⊩</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-pequiv_refl"><span class="command">lemma</span></span> pequiv_refl<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">!</span></span></span></span><span class="main">,</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≃</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_comm"><span class="command">lemma</span></span> pequiv_comm<span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≃</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">≃</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_pr"><span class="command">lemma</span></span> pequiv_pr<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≃</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_trans"><span class="command">lemma</span></span> pequiv_trans<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">b</span><span class="main">;</span> <span class="free">b</span> <span class="main">≃</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>order_trans<span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_pr_trans"><span class="command">lemma</span></span> pequiv_pr_trans<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">b</span><span class="main">;</span> <span class="free">b</span> <span class="main">⊑</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def refines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algebra-pr_pequiv_trans"><span class="command">lemma</span></span> pr_pequiv_trans<span class="main">[</span><span class="operator">intro</span><span class="main">,</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span><span class="main">;</span> <span class="free">b</span> <span class="main">≃</span> <span class="free">c</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pequiv_def refines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement induces equivalence by antisymmetry:›</span></span>
<span class="keyword1" id="Algebra-pequiv_antisym"><span class="command">lemma</span></span> pequiv_antisym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span><span class="main">;</span> <span class="free">b</span> <span class="main">⊑</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>antisym<span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_DC"><span class="command">lemma</span></span> pequiv_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">c</span><span class="main">;</span> <span class="free">b</span> <span class="main">≃</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="main">≃</span> <span class="main">(</span><span class="free">c</span> <span class="main">⨅</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>DC_mono pequiv_antisym <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-pequiv_AC"><span class="command">lemma</span></span> pequiv_AC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">≃</span> <span class="free">c</span><span class="main">;</span> <span class="free">b</span> <span class="main">≃</span> <span class="free">d</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨆</span> <span class="free">b</span><span class="main">)</span> <span class="main">≃</span> <span class="main">(</span><span class="free">c</span> <span class="main">⨆</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>AC_mono pequiv_antisym <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Deterministic Programs are Maximal›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any sub-additive refinement of a deterministic program is in fact an equivalence.
Deterministic programs are thus maximal (under the refinement order) among sub-additive programs.
›</span></span>
<span class="keyword1" id="Algebra-refines_determ"><span class="command">lemma</span></span> refines_determ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≃</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Proof by contradiction.›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pequivI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> contrapos_pp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> wb <span class="keyword1"><span class="command">have</span></span> sab<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sublinear_subadd<span class="main"><span class="main">[</span></span><span class="operator">OF</span> well_def_wp_sublinear<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Assume that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are not equivalent:›</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">≠</span> wp <span class="free">b</span> <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Find a point at which they differ.  As <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⊑</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">b</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must by strictly greater than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">a</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="free"><span class="free">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    here:›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_np<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sP dr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="main">=</span> wp <span class="free">b</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Take a carefully constructed expectation:›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Pc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span> <span class="main">-</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sPc<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="var">?Pc</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">P</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="var">?Pc</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?Pc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="var">?Pc</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"nneg <span class="var">?Pc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We then show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> violates feasibility, and
    thus healthiness.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> sP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> da <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="skolem">P</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD determ_maximalD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?Pc</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> da sP sPc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">a</span> <span class="var">?Pc</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> additiveD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> determ_additiveD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sP sPc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sPc dr <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="var">?Pc</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">a</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> less <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="var">?Pc</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sab sP sPc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?Pc</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">P</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹However,›</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nneg <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">P</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>well_def_wp_healthy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Algebraic Structure of Refinement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Well-defined programs form a half-bounded semilattice under refinement, where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Abort</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is bottom, and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">a</span></span> <span class="main"><span class="main">⨅</span></span> <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">inf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. There is no unique top element, but all
fully-deterministic programs are maximal.

The type that we construct here is not especially useful, but serves as a convenient way to express
this result.›</span></span>

<span class="keyword1"><span class="command">quotient_type</span></span> <span class="tfree">'s</span> program <span class="main">=</span>
  <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="main">/</span> partial <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≃</span> <span class="bound">b</span> <span class="main">∧</span> well_def <span class="bound">a</span> <span class="main">∧</span> well_def <span class="bound">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> part_equivpI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Skip <span class="main">≃</span> Skip"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"well_def Skip"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wd_intros<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≃</span> <span class="bound">x</span> <span class="main">∧</span> well_def <span class="bound">x</span> <span class="main">∧</span> well_def <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"symp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≃</span> <span class="bound">b</span> <span class="main">∧</span> well_def <span class="bound">a</span> <span class="main">∧</span> well_def <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> sympI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>wp <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span>wp <span class="skolem">b</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pequiv_equiv_trans<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span> pequiv_equiv_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"transp <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≃</span> <span class="bound">b</span> <span class="main">∧</span> well_def <span class="bound">a</span> <span class="main">∧</span> well_def <span class="bound">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> transpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pequiv_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> program <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">semilattice_inf</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span>
  <span class="class_parameter">less_eq_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program <span class="main">⇒</span> <span class="tfree">'a</span> program <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">refines</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊑</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊑</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≃</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="comment1">(* XXX - what's up here? *)</span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  <span class="class_parameter">less_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program <span class="main">⇒</span> <span class="tfree">'a</span> program <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊑</span> <span class="bound">b</span> <span class="main">∧</span> <span class="main">¬</span> <span class="bound">b</span> <span class="main">⊑</span> <span class="bound">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊑</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊑</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≃</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">⊑</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⊑</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">c</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">d</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">≃</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">⊑</span> <span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⊑</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">d</span> <span class="main">⊑</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  <span class="class_parameter">inf_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program <span class="main">⇒</span> <span class="tfree">'a</span> program <span class="main">⇒</span> <span class="tfree">'a</span> program"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">DC</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="skolem">d</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≃</span> <span class="skolem">d</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span> <span class="main">⨅</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">≃</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">⨅</span> <span class="skolem">d</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pequiv_DC<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"well_def <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"well_def <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"well_def <span class="main">(</span><span class="skolem">a</span> <span class="main">⨅</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wd_intros<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">c</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"well_def <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"well_def <span class="skolem">c</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"well_def <span class="main">(</span><span class="skolem">a</span> <span class="main">⨅</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wd_intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> left_refines_DC<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> right_refines_DC<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>pequiv_antisym<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>pr_trans<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> inf <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>DC_refines<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> program <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">bot</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span>
  <span class="class_parameter">bot_program</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> program"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">Abort</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wd_intros<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Algebra-eq_det"><span class="command">lemma</span></span> eq_det<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">::</span><span class="tfree">'s</span> prog<span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span> <span class="main">≃</span> <span class="bound">b</span><span class="main">;</span> determ <span class="main">(</span>wp <span class="bound">a</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="bound">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> determI additiveI maximalI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
         wp <span class="skolem">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> da sP sQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="skolem">a</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="skolem">a</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>additiveD determ_additiveD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> eq sP sQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="skolem">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="skolem">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pequivD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> wp <span class="skolem">b</span> <span class="skolem">P</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="skolem">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span>
  <span class="keyword3"><span class="command">assume</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> nn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> wp <span class="skolem">a</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pequivD const_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> da nn <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>determ_maximalD maximalD<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="skolem">b</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span>
  pdeterm <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> program <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">a</span><span class="main">.</span> determ <span class="main">(</span>wp <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">safe</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">a</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_det<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≃</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≃</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> eq_det<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-determ_maximal"><span class="command">lemma</span></span> determ_maximal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pdeterm <span class="free">a</span><span class="main">;</span> <span class="free">a</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>refines_determ<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Data Refinement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A projective data refinement construction for pGCL. By projective, we mean that the abstract
state is always a function (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) of the concrete state. Refinement may be predicated (<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>) on the state.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">drefines</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> prog <span class="main">⇒</span> <span class="tfree">'b</span> prog <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drefines</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">(</span>unitary <span class="bound">P</span> <span class="main">∧</span> unitary <span class="bound">Q</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">P</span> <span class="main">⊩</span> wp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">Q</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
                            <span class="main">(</span><span class="main">«</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-drefinesD"><span class="command">lemma</span></span> drefinesD<span class="main">[</span><span class="operator">dest</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span><span class="main">;</span> unitary <span class="free">P</span><span class="main">;</span> unitary <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> drefines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can alternatively use G as an assumption:›</span></span>
<span class="keyword1" id="Algebra-drefinesD2"><span class="command">lemma</span></span> drefinesD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dr<span class="main">:</span>  <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uP<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">≤</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This additional form is sometimes useful:›</span></span>
<span class="keyword1" id="Algebra-drefinesD3"><span class="command">lemma</span></span> drefinesD3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="free">s'</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="free">Q</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ wa <span class="keyword1"><span class="command">have</span></span> sL<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uQ wa <span class="keyword1"><span class="command">have</span></span> bL<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊩</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> sL <span class="keyword2"><span class="keyword">and</span></span> bL <span class="keyword2"><span class="keyword">and</span></span> assms
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>drefinesD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dr<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="var">?L</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-drefinesI"><span class="command">lemma</span></span> drefinesI<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span>
           <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> drefines_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Use G as an assumption, when showing refinement:›</span></span>
<span class="keyword1" id="Algebra-drefinesI2"><span class="command">lemma</span></span> drefinesI2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">G</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wB<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> withAs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">P</span> <span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">P</span><span class="main">;</span> unitary <span class="bound">Q</span><span class="main">;</span>
                 <span class="free">G</span> <span class="bound">s</span><span class="main">;</span> <span class="bound">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="bound">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> withAs <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">from</span></span> uP <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wB <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_pconj_assumption<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_strengthen_guard"><span class="command">lemma</span></span> dr_strengthen_guard<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'t</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">F</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">G</span> <span class="bound">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> drab<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">F</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">F</span><span class="main">»</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">F</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>pconj_mono le_funI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> drab uP uQ wp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">F</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Probabilistic correspondence, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">pcorres</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is equality on distribution transformers,
modulo a guard. It is the analogue, for data refinement, of program equivalence for program
refinement.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">pcorres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> prog <span class="main">⇒</span> <span class="tfree">'b</span> prog <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pcorres</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">⟷</span>
   <span class="main">(</span><span class="main">∀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟶</span>  <span class="main">«</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">Q</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-pcorresI"><span class="command">lemma</span></span> pcorresI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pcorres_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Often easier to use, as it allows one to assume the precondition.›</span></span>
<span class="keyword1" id="Algebra-pcorresI2"><span class="command">lemma</span></span> pcorresI2<span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> withG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">Q</span><span class="main">;</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="free">A</span> <span class="bound">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="bound">s</span><span class="main">)</span><span class="main">=</span> wp <span class="free">B</span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wA<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wB<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pcorresI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> uQφ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> this
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wA<span class="main">]</span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">A</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> uQφ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> uQ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def withG<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> this
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wA<span class="main">]</span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> uQφ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_bounded_byD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_nneg<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-pcorresD"><span class="command">lemma</span></span> pcorresD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span><span class="main">;</span> unitary <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pcorres_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Again, easier to use if the precondition is known to hold.›</span></span>
<span class="keyword1" id="Algebra-pcorresD2"><span class="command">lemma</span></span> pcorresD2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pc<span class="main">:</span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wA<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wB<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> uQ well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wA<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">A</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> wp <span class="free">A</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> pc uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pcorresD<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> wp <span class="free">A</span> <span class="free">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def o_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> fun_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sound_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">.&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span> <span class="main">=</span> wp <span class="free">B</span> <span class="main">(</span><span class="free">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Algebra of Data Refinement›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Program refinement implies a trivial data refinement:›</span></span>
<span class="keyword1" id="Algebra-refines_drefines"><span class="command">lemma</span></span> refines_drefines<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">)</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI2 wb<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> rab sQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Data refinement is transitive:›</span></span>
<span class="keyword1" id="Algebra-dr_trans"><span class="command">lemma</span></span> dr_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">C</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> drAB<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> drBC<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ'</span> <span class="free">G'</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Gimp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">G'</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">G</span> <span class="main">(</span><span class="free">φ'</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="main">(</span><span class="free">φ</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span> <span class="free">G'</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> drefinesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">G</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">»</span> <span class="main">=</span> <span class="main">«</span><span class="free">G'</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> exp_conj_def<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">.&amp;</span> <span class="main">«</span><span class="free">G</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="skolem">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G'</span> <span class="skolem">x</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> Gimp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">G</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">with</span></span> uP
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_assoc o_assoc<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uP uQ wpA <span class="keyword2"><span class="keyword">and</span></span> drAB
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>drefinesD<span class="main">)</span>

    <span class="keyword1"><span class="command">with</span></span> drBC <span class="keyword2"><span class="keyword">and</span></span> uP uQ
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>unitary_intros drefinesD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G'</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="main">(</span><span class="free">φ</span> <span class="keyword1">o</span> <span class="free">φ'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Data refinement composes with program refinement:›</span></span>
<span class="keyword1" id="Algebra-pr_dr_trans"><span class="command">lemma</span></span> pr_dr_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prAB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊑</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> drBC<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> drefinesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> wpA
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword2"><span class="keyword">and</span></span> prAB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">A</span> <span class="skolem">Q</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> uP uQ drBC
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>drefinesD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_pr_trans"><span class="command">lemma</span></span> dr_pr_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> drAB<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> prBC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊑</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> drefinesI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span>  <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">with</span></span> drAB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>drefinesD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uQ prBC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If the projection <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> commutes with the transformer, then data refinement is
reflexive:›</span></span>
<span class="keyword1" id="Algebra-dr_refl"><span class="command">lemma</span></span> dr_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wa<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> wp <span class="free">a</span> <span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span><span class="bound">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI2 wa<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">P</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> wp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> comm uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">...</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correspondence implies data refinement›</span></span>
<span class="keyword1" id="Algebra-pcorres_drefine"><span class="command">lemma</span></span> pcorres_drefine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> corres<span class="main">:</span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wC<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span>
  <span class="keyword3"><span class="command">assume</span></span> uP<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> wpA <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span> <span class="main">⊩</span> wp <span class="free">A</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def le_fun_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> exp_conj_mono_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> corres uQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> pcorresD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> unitary_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> nn_wpC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> nn_wpC <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> this
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> nn_wpC
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">C</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any \emph{data} refinement of a deterministic program is correspondence. This is the
analogous result to that relating program refinement and equivalence.›</span></span>
<span class="keyword1" id="Algebra-drefines_determ"><span class="command">lemma</span></span> drefines_determ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> da<span class="main">:</span> <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> dr<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The proof follows exactly the same form
    as that for program refinement: Assuming that correspondence
    \emph{doesn't} hold, we show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not feasible,
    and thus not healthy, contradicting the assumption.›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pcorresI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> contrapos_pp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">note</span></span> ha <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wa<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> wb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sublinear <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> sab<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_add <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sublinear_subadd<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> uQφ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">≠</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> ne'<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span> <span class="main">≠</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹From refinement, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">»</span></span> <span class="main"><span class="main">&amp;&amp;</span></span> <span class="main"><span class="main">(</span></span>wp <span class="free"><span class="free">a</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">φ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
    lies below <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">»</span></span> <span class="main"><span class="main">&amp;&amp;</span></span> wp <span class="free"><span class="free">b</span></span> <span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">Q</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">φ</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> ha uQ
  <span class="keyword1"><span class="command">have</span></span> gle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>drefinesD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dr<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">from</span></span> gle <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> exp_conj_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>pconj_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uQ ha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>healthy_bounded_byD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uQ ha <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pconj_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹If the programs do not correspond, the terms must differ somewhere, and given the previous
  result, the second must be somewhere strictly larger than the first:›</span></span>
  <span class="keyword1"><span class="command">have</span></span> nle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_np<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ne<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">from</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">" <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>not_less<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> less_s<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The transformers themselves must differ at this point:›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> larger<span class="main">:</span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ha uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> hb uQφ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> less_s
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ha uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uQ<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> less_s
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> less_s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≠</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must also hold, as otherwise both would be zero.›</span></span>
  <span class="keyword1"><span class="command">hence</span></span> G_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_np<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> nG<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">G</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ha uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uQ<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> hb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Take a carefully constructed expectation:›</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Qc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span> <span class="main">-</span> <span class="skolem">Q</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> bQc<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="var">?Qc</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> bounded_byI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="skolem">Q</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="skolem">Q</span> <span class="main">-</span> <span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> sQc<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="var">?Qc</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> soundI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> bQc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bounded <span class="var">?Qc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"nneg <span class="var">?Qc</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> nnegI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> bound_of <span class="skolem">Q</span> <span class="main">-</span> <span class="skolem">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By the maximality of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp <span class="free"><span class="free">b</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> must violate feasibility, by mapping
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to something strictly greater than <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="skolem"><span class="skolem">Q</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> bound_of <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> da <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bound_of <span class="skolem">Q</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD determ_maximalD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="var">?Qc</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> da <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> uQ sQc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="var">?Qc</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
          wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wp <span class="free">a</span> <span class="var">?Qc</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> additiveD<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> ha <span class="keyword2"><span class="keyword">and</span></span> sQc <span class="keyword2"><span class="keyword">and</span></span> bQc
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>drefinesD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> dr<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">a</span> <span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> sQc <span class="keyword2"><span class="keyword">and</span></span> ha
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span> <span class="main">-</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="var">?Qc</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G_s <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wp <span class="free">a</span> <span class="var">?Qc</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> larger
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span>
          wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">+</span> wp <span class="free">a</span> <span class="var">?Qc</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">&lt;</span>
          wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> sab <span class="keyword2"><span class="keyword">and</span></span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uQ<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> sQc
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
        wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="var">?Qc</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> feasible <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> contrapos_pn<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> fb<span class="main">:</span> <span class="quoted"><span class="quoted">"feasible <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">(</span>bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> uQ <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>feasible_boundedD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fb<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> bound_of <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bound_of <span class="skolem">Q</span> <span class="main">&lt;</span> wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> bound_of <span class="skolem">Q</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Structural Rules for Correspondence›</span></span>

<span class="keyword1" id="Algebra-pcorres_Skip"><span class="command">lemma</span></span> pcorres_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> Skip Skip"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>pcorres_def wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Correspondence composes over sequential composition.›</span></span>
<span class="keyword1" id="Algebra-pcorres_Seq"><span class="command">lemma</span></span> pcorres_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">C</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">D</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pcAB<span class="main">:</span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> pcCD<span class="main">:</span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wA<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wB<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wC<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">C</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> wD<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p3p2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> unitary <span class="bound">Q</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="bound">Q</span> <span class="main">=</span> wp <span class="free">B</span> <span class="main">(</span><span class="main">«</span><span class="free">H</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> p1p3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">G</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">I</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"pcorres <span class="free">φ</span> <span class="free">G</span> <span class="main">(</span><span class="free">A</span><span class="main">;;</span><span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">;;</span><span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> pcorresI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> uQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> uCQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> uQ well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wD<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> uDQ<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>unitary_comp<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> p3p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">R</span> <span class="bound">S</span><span class="main">.</span> <span class="main">⟦</span> unitary <span class="bound">R</span><span class="main">;</span> unitary <span class="bound">S</span><span class="main">;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="bound">R</span> <span class="main">=</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="bound">S</span> <span class="main">⟧</span> <span class="main">⟹</span>
                    <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="bound">R</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="bound">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> a3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span> <span class="main">=</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="skolem">S</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uS<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">S</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="skolem">R</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="skolem">S</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> this
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> uS <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="skolem">S</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> p1 <span class="main">=</span> this
      <span class="keyword1"><span class="command">with</span></span> p1p3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> a3<span class="main">,</span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">.&amp;</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">1</span> <span class="main">.&amp;</span> <span class="skolem">S</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> p1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="skolem">R</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">.&amp;</span> <span class="skolem">S</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="main">(</span><span class="free">A</span><span class="main">;;</span><span class="free">C</span><span class="main">)</span> <span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="free">B</span><span class="main">;;</span><span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> uCQ pcAB <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span>
                        <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>pcorresD<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span><span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span>
               <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> p3p1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> uCQ well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>unitary_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> uDQ well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> uQ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">H</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span> <span class="free">H</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>pcorresD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pcCD<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span> <span class="free">I</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span> <span class="free">I</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>p3p2 uCQ uDQ<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">A</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∘</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Structural Rules for Data Refinement›</span></span>

<span class="keyword1" id="Algebra-dr_Skip"><span class="command">lemma</span></span> dr_Skip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> Skip Skip"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI2 wd_intros<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp Skip <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp Skip <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp Skip <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_Abort"><span class="command">lemma</span></span> dr_Abort<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> Abort Abort"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI2 wd_intros<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp Abort <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp Abort <span class="skolem">Q</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp Abort <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_Apply"><span class="command">lemma</span></span> dr_Apply<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> commutes<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">o</span> <span class="free">φ</span> <span class="main">=</span> <span class="free">φ</span> <span class="keyword1">o</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Apply <span class="free">g</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> drefinesI2 wd_intros<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>

  <span class="keyword3"><span class="command">assume</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="skolem">Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">⊩</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="free">φ</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> commutes
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="keyword1">o</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="main">(</span>Apply <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">P</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span>Apply <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Q</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_Seq"><span class="command">lemma</span></span> dr_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> drAB<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">P</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> drBC<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">Q</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wpB<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">«</span><span class="free">Q</span><span class="main">»</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wB<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">B</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wC<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wD<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">P</span> <span class="main">(</span><span class="free">A</span><span class="main">;;</span><span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">B</span><span class="main">;;</span><span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">R</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">S</span>
  <span class="keyword3"><span class="command">assume</span></span> uR<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> uS<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="skolem">S</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> wpAC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">A</span><span class="main">;;</span><span class="free">C</span><span class="main">)</span> <span class="skolem">S</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> uR
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">R</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> <span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">R</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_assoc<span class="main">)</span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span> uR uS
     <span class="keyword2"><span class="keyword">and</span></span> wpAC<span class="main">[</span><span class="operator">unfolded</span> eval_wp_Seq o_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">R</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>drefinesD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> drAB<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wpB well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span> uS
         sublinear_sub_conj<span class="main">[</span><span class="operator">OF</span> well_def_wp_sublinear<span class="main">,</span> <span class="operator">OF</span> wB<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">R</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span><span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>entails_combine <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>unitary_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> uS well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">D</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>drefinesD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> drBC<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wB<span class="main">]</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wC<span class="main">]</span>
         well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wD<span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> unitary_sound<span class="main">[</span><span class="operator">OF</span> uS<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">B</span> <span class="main">(</span><span class="main">«</span><span class="free">Q</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span>wp <span class="free">C</span> <span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">B</span> <span class="main">(</span>wp <span class="free">D</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>mono_transD<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">finally</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">P</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="skolem">R</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">B</span><span class="main">;;</span><span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="skolem">S</span> <span class="keyword1">o</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wp_eval o_def <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-dr_repeat"><span class="command">lemma</span></span> dr_repeat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dr_ab<span class="main">:</span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> Gpr<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span>    <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span>    <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"drefines <span class="free">φ</span> <span class="free">G</span> <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="main">(</span>repeat <span class="free">n</span> <span class="free">b</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">n</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>dr_Skip<span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>dr_Seq Gpr assms wd_intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="StructuredReasoning">
<div class="head">
<h1>Theory StructuredReasoning</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Structured Reasoning"</span></span>

<span class="keyword1"><span class="command">theory</span></span> StructuredReasoning <span class="keyword2"><span class="keyword">imports</span></span> <a href="Algebra.html">Algebra</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By linking the algebraic, the syntactic, and the semantic views
  of computation, we derive a set of rules for decomposing expectation
  entailment proofs, firstly over the syntactic structure of a program,
  and secondly over the refinement relation.  These rules also form the
  basis for automated reasoning.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Syntactic Decomposition›</span></span>

<span class="keyword1" id="StructuredReasoning-wp_Abort"><span class="command">lemma</span></span> wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span> <span class="main">⊩</span> wp Abort <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_Abort"><span class="command">lemma</span></span> wlp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wlp Abort <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_Skip"><span class="command">lemma</span></span> wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wp Skip <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_Skip"><span class="command">lemma</span></span> wlp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wlp Skip <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_Apply"><span class="command">lemma</span></span> wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">⊩</span> wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_Apply"><span class="command">lemma</span></span> wlp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="keyword1">o</span> <span class="free">f</span> <span class="main">⊩</span> wlp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_Seq"><span class="command">lemma</span></span> wp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ent_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ent_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s_Q<span class="main">:</span>   <span class="quoted"><span class="quoted">"sound <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> s_R<span class="main">:</span>   <span class="quoted"><span class="quoted">"sound <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ha <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wa<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ent_a
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ent_b ha hb s_Q s_R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="free">Q</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_monoD2<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StructuredReasoning-wlp_Seq"><span class="command">lemma</span></span> wlp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ent_a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ent_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> wlp <span class="free">b</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wa<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">a</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u_Q<span class="main">:</span>   <span class="quoted"><span class="quoted">"unitary <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> u_R<span class="main">:</span>   <span class="quoted"><span class="quoted">"unitary <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> ha <span class="main">=</span> well_def_wlp_nearly_healthy<span class="main">[</span><span class="operator">OF</span> wa<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wlp_nearly_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> ent_a
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ent_b ha hb u_Q u_R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="free">a</span> <span class="free">Q</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>nearly_healthy_monoD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ha<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StructuredReasoning-wp_PC"><span class="command">lemma</span></span> wp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">a</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wp <span class="free">b</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_PC"><span class="command">lemma</span></span> wlp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">a</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> wlp <span class="free">b</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A simpler rule for when the probability does not depend on the state.›</span></span>
<span class="keyword1" id="StructuredReasoning-PC_fixed"><span class="command">lemma</span></span> PC_fixed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wpa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">a</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wpb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> <span class="free">b</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> np<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> PC_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> wpa <span class="keyword2"><span class="keyword">and</span></span> np <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">*</span> <span class="free">a</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> bp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> wpb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="free">P</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span>
                   <span class="free">p</span> <span class="main">*</span> <span class="free">a</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">b</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> add_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StructuredReasoning-wp_PC_fixed"><span class="command">lemma</span></span> wp_PC_fixed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="free">R</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">p</span><span class="main">;</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def PC_fixed<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_PC_fixed"><span class="command">lemma</span></span> wlp_PC_fixed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wlp <span class="free">b</span> <span class="free">R</span><span class="main">;</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">p</span><span class="main">;</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="free">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_def PC_fixed<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_DC"><span class="command">lemma</span></span> wp_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wp <span class="free">a</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wp <span class="free">b</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_DC"><span class="command">lemma</span></span> wlp_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span>wlp <span class="free">a</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>wlp <span class="free">b</span> <span class="free">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Combining annotations for both branches:›</span></span>
<span class="keyword1" id="StructuredReasoning-DC_split"><span class="command">lemma</span></span> DC_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">b</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wpa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">a</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wpb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">⊩</span> <span class="free">b</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span> <span class="free">ab</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> DC_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> wpa wpb
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">a</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">b</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">P</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">a</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">b</span> <span class="free">ab</span> <span class="free">R</span> <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StructuredReasoning-wp_DC_split"><span class="command">lemma</span></span> wp_DC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wp <span class="free">prog'</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">prog</span> <span class="main">⨅</span> <span class="free">prog'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def DC_split<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_DC_split"><span class="command">lemma</span></span> wlp_DC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">prog</span> <span class="free">R</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wlp <span class="free">prog'</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> min <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="main">⨅</span> <span class="free">prog'</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_def DC_split<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_DC_split_same"><span class="command">lemma</span></span> wp_DC_split_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog'</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">prog</span> <span class="main">⨅</span> <span class="free">prog'</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>min.boundedI<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_DC_split_same"><span class="command">lemma</span></span> wlp_DC_split_same<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">prog</span> <span class="free">Q</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">prog'</span> <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">prog</span> <span class="main">⨅</span> <span class="free">prog'</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>min.boundedI<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-SetPC_split"><span class="command">lemma</span></span> SetPC_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'x</span> <span class="main">⇒</span> <span class="tfree">'y</span> prog"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'y</span> <span class="main">⇒</span> <span class="tfree">'x</span> <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">ab</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nnp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> nneg <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> SetPC <span class="free">f</span> <span class="free">p</span> <span class="free">ab</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> SetPC_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword1"><span class="command">from</span></span> rec <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">ab</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> nnp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">s</span> <span class="main">≤</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">ab</span> <span class="free">Q</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_left_mono<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="skolem">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="skolem">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">x</span> <span class="free">ab</span> <span class="free">Q</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> sum_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="StructuredReasoning-wp_SetPC_split"><span class="command">lemma</span></span> wp_SetPC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> nneg <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def SetPC_split<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_SetPC_split"><span class="command">lemma</span></span> wlp_SetPC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> nneg <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">∑</span><span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span> <span class="bound">s</span> <span class="bound">x</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span>SetPC <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_def SetPC_split<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_SetDC_split"><span class="command">lemma</span></span> wp_SetDC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span>SetDC <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_SetDC_split"><span class="command">lemma</span></span> wlp_SetDC_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span>
   <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span>SetDC <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_SetDC"><span class="command">lemma</span></span> wp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> sound <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span>SetDC <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_mono<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_SetDC"><span class="command">lemma</span></span> wlp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⊩</span> wlp <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> sound <span class="main">(</span><span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⊩</span> wlp <span class="main">(</span>SetDC <span class="free">f</span> <span class="free">S</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_funI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>cInf_mono<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_Embed"><span class="command">lemma</span></span> wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_def Embed_def<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_Embed"><span class="command">lemma</span></span> wlp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> <span class="free">t</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_def Embed_def<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_Bind"><span class="command">lemma</span></span> wp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_def Bind_def<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_Bind"><span class="command">lemma</span></span> wlp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">≤</span> wlp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span> <span class="bound">s</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wlp_def Bind_def<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_repeat"><span class="command">lemma</span></span> wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="free">R</span><span class="main">;</span>
     well_def <span class="free">a</span><span class="main">;</span> sound <span class="free">Q</span><span class="main">;</span> sound <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="main">(</span>repeat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wp_Seq wd_intros<span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wlp_repeat"><span class="command">lemma</span></span> wlp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="free">Q</span><span class="main">;</span> <span class="free">Q</span> <span class="main">⊩</span> wlp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span> <span class="free">R</span><span class="main">;</span>
     well_def <span class="free">a</span><span class="main">;</span> unitary <span class="free">Q</span><span class="main">;</span> unitary <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wlp <span class="main">(</span>repeat <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">a</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wlp_Seq wd_intros<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that the loop rules presented in section \autoref{s:loop_rules} are of the same form,
and would belong here, had they not already been stated.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following rules are specialisations of those for general
  transformers, and are easier for the unifier to match.›</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> wp_strengthen_post<span class="main">=</span>
  entails_strengthen_post<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"wp <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">a</span><span class="main">]</span>

<span class="keyword1" id="StructuredReasoning-wlp_strengthen_post"><span class="command">lemma</span></span> wlp_strengthen_post<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="free">Q</span> <span class="main">⟹</span> nearly_healthy <span class="main">(</span>wlp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> unitary <span class="free">R</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⊩</span> <span class="free">R</span> <span class="main">⟹</span> unitary <span class="free">Q</span> <span class="main">⟹</span>
   <span class="free">P</span> <span class="main">⊩</span> wlp <span class="free">a</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wp_weaken_pre<span class="main">=</span>
  entails_weaken_pre<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"wp <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">a</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> wlp_weaken_pre<span class="main">=</span>
  entails_weaken_pre<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"wlp <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">a</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> wp_scale<span class="main">=</span>
  entails_scale<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"wp <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">a</span><span class="main">,</span> <span class="operator">OF</span> _ well_def_wp_healthy<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Algebraic Decomposition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Refinement is a powerful tool for decomposition, belied by the simplicity of the rule.
This is an \emph{axiomatic} formulation of refinement (all annotations of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
are annotations of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>), rather than an operational version (all traces of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are
traces of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="StructuredReasoning-wp_refines"><span class="command">lemma</span></span> wp_refines<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span> <span class="main">⊑</span> <span class="free">b</span><span class="main">;</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">a</span> <span class="free">Q</span><span class="main">;</span> sound <span class="free">Q</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">b</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>entails_trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> wp_drefines <span class="main">=</span> drefinesD

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Hoare triples›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The Hoare triple, or validity predicate, is logically equivalent to the weakest-precondition
entailment form. The benefit is that it allows us to define transitivity rules for computational
(also/finally) reasoning.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wp_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span> _ <span class="keyword1">⦃</span>_<span class="keyword1">⦄p</span>"</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wp_valid</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">⊩</span> wp <span class="free"><span class="bound"><span class="entity">prog</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1" id="StructuredReasoning-wp_validI"><span class="command">lemma</span></span> wp_validI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">prog</span> <span class="main">⦃</span><span class="free">Q</span><span class="keyword1">⦄p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_valid_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-wp_validD"><span class="command">lemma</span></span> wp_validD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">prog</span> <span class="main">⦃</span><span class="free">Q</span><span class="keyword1">⦄p</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">⊩</span> wp <span class="free">prog</span> <span class="free">Q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_valid_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">assumption</span><span class="main">)</span>

<span class="keyword1" id="StructuredReasoning-valid_Seq"><span class="command">lemma</span></span> valid_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">a</span> <span class="main">⦃</span><span class="free">Q</span><span class="keyword1">⦄p</span><span class="main">;</span> <span class="main">⦃</span><span class="free">Q</span><span class="main">⦄</span> <span class="free">b</span> <span class="main">⦃</span><span class="free">R</span><span class="keyword1">⦄p</span><span class="main">;</span> well_def <span class="free">a</span><span class="main">;</span> well_def <span class="free">b</span><span class="main">;</span> sound <span class="free">Q</span><span class="main">;</span> sound <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span>
  <span class="main">⦃</span><span class="free">P</span><span class="main">⦄</span> <span class="free">a</span> <span class="main">;;</span> <span class="free">b</span> <span class="main">⦃</span><span class="free">R</span><span class="keyword1">⦄p</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_valid_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_Seq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We make it available to the computational reasoner:›</span></span>
<span class="keyword1"><span class="command">declare</span></span> valid_Seq<span class="main">[</span><span class="operator">trans</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Automation">
<div class="head">
<h1>Theory Automation</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Automated Reasoning"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Automation <span class="keyword2"><span class="keyword">imports</span></span> <a href="StructuredReasoning.html">StructuredReasoning</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This theory serves as a container for automated reasoning
  tactics for pGCL, implemented in ML.  At present, there is a basic
  verification condition generator (VCG).›</span></span>

<span class="keyword1"><span class="command">named_theorems</span></span> wd
  <span class="quoted">"theorems to automatically establish well-definedness"</span>
<span class="keyword1"><span class="command">named_theorems</span></span> pwp_core
  <span class="quoted">"core probabilistic wp rules, for evaluating primitive terms"</span>
<span class="keyword1"><span class="command">named_theorems</span></span> pwp
  <span class="quoted">"user-supplied probabilistic wp rules"</span>
<span class="keyword1"><span class="command">named_theorems</span></span> pwlp
  <span class="quoted">"user-supplied probabilistic wlp rules"</span>

<span class="keyword1"><span class="command">ML_file</span></span> <span class="quoted">‹pVCG.ML›</span>

<span class="keyword1"><span class="command">method_setup</span></span> pvcg <span class="main">=</span>
  <span class="quoted">‹Scan.succeed <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">ctxt</span> <span class="main">=&gt;</span> <span class="entity">SIMPLE_METHOD'</span> <span class="main">(</span><span class="entity">pVCG.pVCG_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>›</span>
  <span class="quoted">"Probabilistic weakest preexpectation tactic"</span>

<span class="keyword1"><span class="command">declare</span></span> wd_intros<span class="main">[</span><span class="operator">wd</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> core_wp_rules <span class="main">=</span>
  wp_Skip        wlp_Skip
  wp_Abort       wlp_Abort
  wp_Apply       wlp_Apply
  wp_Seq         wlp_Seq
  wp_DC_split    wlp_DC_split
  wp_PC_fixed    wlp_PC_fixed
  wp_SetDC       wlp_SetDC
  wp_SetPC_split wlp_SetPC_split

<span class="keyword1"><span class="command">declare</span></span> core_wp_rules<span class="main">[</span><span class="operator">pwp_core</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="files/pVCG.ML">
<div class="head">
<h1>File ‹pVCG.ML›</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="comment1">(* This file implements a simple verification condition generator
   (VCG), for probabilistic programs written in pGCL. *)</span>

<span class="keyword1"><span class="keyword">signature</span></span> <span class="entity">pVCG_sig</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">sig</span></span>
        <span class="keyword1"><span class="keyword">val</span></span> pVCG_tac<span class="main">:</span> <span class="entity">Proof.context</span> <span class="main">-&gt;</span> int <span class="main">-&gt;</span> tactic<span class="main">;</span>
<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">pVCG</span> <span class="main">=</span>
<span class="keyword2"><span class="keyword">struct</span></span>

<span class="keyword1"><span class="keyword">val</span></span> <span class="entity">pvcg_trace</span> <span class="main">=</span> <span class="entity">Attrib.setup_config_bool</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">binding</span> "trace_pvcg"<span class="antiquote">}</span></span></span> <span class="main">(</span>K false<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">str</span> <span class="main">=</span>
    <span class="keyword2"><span class="keyword">if</span></span> Config.get <span class="entity">ctxt</span> <span class="entity">pvcg_trace</span> <span class="keyword2"><span class="keyword">then</span></span> tracing <span class="main">(</span><span class="inner_quoted">"pVCG: "</span> ^ <span class="entity">str</span><span class="main">)</span> <span class="keyword2"><span class="keyword">else</span></span> <span class="main">{</span><span class="main">}</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="entity">str</span> <span class="entity">T</span> <span class="main">=</span>
    <span class="main">(</span><span class="entity">trace</span> <span class="entity">ctxt</span> <span class="entity">str</span> <span class="main">;</span> <span class="entity">T</span><span class="main">)</span>

<span class="comment1">(* Match soundness goals on non-schematic expectations *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">m_sound</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Expectations.sound"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ Var <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> false
  <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Expectations.unitary"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ Var <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> false
  <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Expectations.sound"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"Expectations.unitary"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="comment1">(* Match well-definedness goals on non-schematic expectations *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">m_wd</span> <span class="entity">t</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">case</span></span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">of</span></span>
    <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"WellDefined.well_def"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ Var <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> false
  <span class="main">|</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"Trueprop"</span><span class="antiquote">}</span></span> $ <span class="main">(</span>Const <span class="main">(</span><span class="inner_quoted">"WellDefined.well_def"</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> $ <span class="main">_</span><span class="main">)</span> <span class="main">=&gt;</span> true
  <span class="main">|</span> <span class="main">_</span> <span class="main">=&gt;</span> false

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sound_goal_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> sound_intros unitary_intros<span class="antiquote">}</span></span></span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">maybe_sound_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">g</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m_sound</span> <span class="entity">g</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="inner_quoted">"soundness goal "</span> ^
                   Pretty.string_of <span class="main">(</span>Syntax.pretty_term <span class="entity">ctxt</span> <span class="entity">g</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">(</span><span class="entity">sound_goal_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> no_tac
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sound_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="entity">maybe_sound_tac</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wd_goal_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  resolve_tac <span class="entity">ctxt</span> <span class="main">(</span>rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> wd<span class="antiquote">}</span></span><span class="main">)</span><span class="main">)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">maybe_wd_tac</span> <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">g</span><span class="main">,</span><span class="entity">i</span><span class="main">)</span> <span class="main">=</span>
  <span class="keyword2"><span class="keyword">if</span></span> <span class="entity">m_wd</span> <span class="entity">g</span>
  <span class="keyword2"><span class="keyword">then</span></span> <span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="inner_quoted">"well-definedness goal"</span> <span class="main">(</span><span class="entity">wd_goal_tac</span> <span class="entity">ctxt</span> <span class="entity">i</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">else</span></span> no_tac
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wd_tac</span> <span class="entity">ctxt</span> <span class="main">=</span> SUBGOAL <span class="main">(</span><span class="entity">maybe_wd_tac</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="comment1">(* Attempt to solve a side-condition (healthiness or soundness) *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">sidegoal_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  REPEAT_ALL_NEW <span class="main">(</span>CHANGED o <span class="main">(</span><span class="entity">wd_tac</span> <span class="entity">ctxt</span> ORELSE'
                  <span class="entity">sound_tac</span> <span class="entity">ctxt</span> ORELSE'
                  <span class="entity">asm_full_simp_tac</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wp_start</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> wp_weaken_pre<span class="antiquote">}</span></span></span> ORELSE' resolve_tac <span class="entity">ctxt</span> <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thms</span> wlp_weaken_pre<span class="antiquote">}</span></span></span><span class="main">)</span>
  THEN_ALL_NEW <span class="main">(</span><span class="main">(</span><span class="entity">sidegoal_tac</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE' <span class="main">(</span>K all_tac<span class="main">)</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">user_wp_rules</span> <span class="entity">ctxt</span> <span class="main">=</span> rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> pwp<span class="antiquote">}</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mod_user_wp_rules</span> <span class="entity">ctxt</span> <span class="main">=</span>
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> wp_strengthen_post<span class="main">[</span><span class="operator">OF</span> _ well_def_wp_healthy<span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span>
                        <span class="main">(</span><span class="entity">user_wp_rules</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">user_wlp_rules</span> <span class="entity">ctxt</span> <span class="main">=</span> rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> pwlp<span class="antiquote">}</span></span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">mod_user_wlp_rules</span> <span class="entity">ctxt</span> <span class="main">=</span>
  map <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="entity">thm</span> <span class="main">=&gt;</span> <span class="entity">thm</span> RS <span class="antiquoted"><span class="entity"><span class="antiquote">@{</span><span class="operator">thm</span> wlp_strengthen_post<span class="main">[</span><span class="operator">OF</span> _ well_def_wlp_nearly_healthy<span class="main">]</span><span class="antiquote">}</span></span></span><span class="main">)</span>
                        <span class="main">(</span><span class="entity">user_wlp_rules</span> <span class="entity">ctxt</span><span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">core_rules</span> <span class="entity">ctxt</span> <span class="main">=</span> rev <span class="main">(</span><span class="entity">Named_Theorems.get</span> <span class="entity">ctxt</span> <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">named_theorems</span> pwp_core<span class="antiquote">}</span></span><span class="main">)</span>

<span class="comment1">(* Prefer raw user rules, then lifted user rules, then core (safe) rules *)</span>
<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">wp_step</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="inner_quoted">"user WP"</span> <span class="main">(</span>resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">user_wp_rules</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> ORELSE'
   resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">mod_user_wp_rules</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
   resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">user_wlp_rules</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
   resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">mod_user_wlp_rules</span> <span class="entity">ctxt</span><span class="main">)</span> ORELSE'
   resolve_tac <span class="entity">ctxt</span> <span class="main">(</span><span class="entity">core_rules</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> THEN_ALL_NEW
  <span class="main">(</span><span class="entity">sidegoal_tac</span> <span class="entity">ctxt</span> ORELSE' K all_tac<span class="main">)</span>

<span class="keyword1"><span class="keyword">fun</span></span> <span class="entity">pVCG_tac</span> <span class="entity">ctxt</span> <span class="main">=</span>
  <span class="main">(</span><span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="inner_quoted">"start"</span> <span class="main">(</span><span class="entity">wp_start</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
   REPEAT_ALL_NEW <span class="main">(</span><span class="entity">wp_step</span> <span class="entity">ctxt</span><span class="main">)</span><span class="main">)</span> THEN_ALL_NEW
   <span class="main">(</span>TRY o <span class="entity">sidegoal_tac</span> <span class="entity">ctxt</span><span class="main">)</span> THEN'
  <span class="main">(</span><span class="keyword1"><span class="keyword">fn</span></span> <span class="main">_</span> <span class="main">=&gt;</span> <span class="entity">trace_pre</span> <span class="entity">ctxt</span> <span class="inner_quoted">"finished"</span> all_tac<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span><span class="main">;</span>

<span class="keyword1"><span class="keyword">structure</span></span> <span class="entity">pVCGInst</span> <span class="main">:</span> <span class="entity">pVCG_sig</span> <span class="main">=</span> pVCG<span class="main">;</span>
</pre>
</div><div id="Determinism">
<div class="head">
<h1>Theory Determinism</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Determinism›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Determinism <span class="keyword2"><span class="keyword">imports</span></span> <a href="WellDefined.html">WellDefined</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:prog_determ}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We provide a set of lemmas for establishing that
  appropriately restricted programs are fully additive, and
  maximal in the refinement order.  This is particularly useful
  with data refinement, as it implies correspondence.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span>  <span class="quoted"><span class="plain_text">‹Additivity›</span></span>

<span class="keyword1" id="Determinism-additive_wp_Abort"><span class="command">lemma</span></span> additive_wp_Abort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="main">(</span>Abort<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wlp Abort"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not additive.›</span></span>

<span class="keyword1" id="Determinism-additive_wp_Skip"><span class="command">lemma</span></span> additive_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="main">(</span>Skip<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-additive_wp_Apply"><span class="command">lemma</span></span> additive_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-additive_wp_Seq"><span class="command">lemma</span></span> additive_wp_Seq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">a</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adda<span class="main">:</span> <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> addb<span class="main">:</span> <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> wb<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> additiveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval o_def<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">Q</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sQ<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">Q</span>"</span></span>

  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> addb sP sQ
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">b</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> wp <span class="free">b</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>additiveD<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> adda sP sQ hb
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="skolem">Q</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span>
        wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">P</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">(</span>wp <span class="free">a</span> <span class="main">(</span>wp <span class="free">b</span> <span class="skolem">Q</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> additiveD<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Determinism-additive_wp_PC"><span class="command">lemma</span></span> additive_wp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> additive <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span><span class="main">;</span> additive <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> additive <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> additiveI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>additiveD <span class="dynamic"><span class="dynamic">field_simps</span></span> wp_eval<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">DC</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is not additive.›</span></span>

<span class="keyword1" id="Determinism-additive_wp_SetPC"><span class="command">lemma</span></span> additive_wp_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> additive <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
   additive <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> additiveI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval additiveD distrib_left sum.distrib<span class="main">)</span>

<span class="keyword1" id="Determinism-additive_wp_Bind"><span class="command">lemma</span></span> additive_wp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> additive <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> additive <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval additive_def<span class="main">)</span>

<span class="keyword1" id="Determinism-additive_wp_Embed"><span class="command">lemma</span></span> additive_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> additive <span class="free">t</span> <span class="main">⟧</span> <span class="main">⟹</span> additive <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-additive_wp_repeat"><span class="command">lemma</span></span> additive_wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"additive <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> well_def <span class="free">a</span> <span class="main">⟹</span> additive <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>additive_wp_Skip <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>additive_wp_Seq wd_intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> fa_intros <span class="main">=</span>
  additive_wp_Abort additive_wp_Skip
  additive_wp_Apply additive_wp_Seq
  additive_wp_PC    additive_wp_SetPC
  additive_wp_Bind  additive_wp_Embed
  additive_wp_repeat

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Maximality›</span></span>

<span class="keyword1" id="Determinism-max_wp_Skip"><span class="command">lemma</span></span> max_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximal_def wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_Apply"><span class="command">lemma</span></span> max_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>wp_eval o_def<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_Seq"><span class="command">lemma</span></span> max_wp_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maximal <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span><span class="main">;</span> maximal <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval maximal_def<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_PC"><span class="command">lemma</span></span> max_wp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maximal <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span><span class="main">;</span> maximal <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> maximalI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD <span class="dynamic"><span class="dynamic">field_simps</span></span> wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_DC"><span class="command">lemma</span></span> max_wp_DC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maximal <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span><span class="main">;</span> maximal <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">⨅</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> maximalI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval maximalD<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_SetPC"><span class="command">lemma</span></span> max_wp_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">∈</span>supp <span class="main">(</span><span class="free">P</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span>
  maximal <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">p</span> <span class="free">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>maximalD wp_def SetPC_def sum_distrib_right<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_SetDC"><span class="command">lemma</span></span> max_wp_SetDC<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">S</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="main">(</span>SetDC <span class="free">p</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> maximalI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'s</span></span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mp <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span>image_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> ne <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">S</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_constant_conv <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> INF_cong_simp<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> wp <span class="main">(</span><span class="free">p</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
 
<span class="keyword1" id="Determinism-max_wp_Embed"><span class="command">lemma</span></span> max_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maximal <span class="free">t</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_repeat"><span class="command">lemma</span></span> max_wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> maximal <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>max_wp_Skip max_wp_Seq<span class="main">)</span>

<span class="keyword1" id="Determinism-max_wp_Bind"><span class="command">lemma</span></span> max_wp_Bind<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> maximal <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> maximalI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ma <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">s</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> max_intros <span class="main">=</span>
  max_wp_Skip  max_wp_Apply
  max_wp_Seq   max_wp_PC
  max_wp_DC    max_wp_SetPC
  max_wp_SetDC max_wp_Embed
  max_wp_Bind  max_wp_repeat

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A healthy transformer that terminates is maximal.›</span></span>
<span class="keyword1" id="Determinism-healthy_term_max"><span class="command">lemma</span></span> healthy_term_max<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ht<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">⊩</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"maximal <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> maximalI ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">c</span><span class="main">::</span><span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> nnc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">*</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nnc healthy_scalingD<span class="main">[</span><span class="operator">OF</span> ht<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">c</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>scalingD<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> ht <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> trm <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">c</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Determinism›</span></span>

<span class="keyword1" id="Determinism-det_wp_Skip"><span class="command">lemma</span></span> det_wp_Skip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> max_intros fa_intros <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_Apply"><span class="command">lemma</span></span> det_wp_Apply<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="main">(</span>Apply <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_Seq"><span class="command">lemma</span></span> det_wp_Seq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> well_def <span class="free">b</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">;;</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_PC"><span class="command">lemma</span></span> det_wp_PC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="hidden">⇘</span><sub><span class="free">P</span></sub><span class="hidden">⇙</span>⊕ <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_SetPC"><span class="command">lemma</span></span> det_wp_SetPC<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> finite <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
   <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> sum <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span> <span class="main">(</span>supp <span class="main">(</span><span class="free">p</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
   determ <span class="main">(</span>wp <span class="main">(</span>SetPC <span class="free">a</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_Bind"><span class="command">lemma</span></span> det_wp_Bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> determ <span class="main">(</span>wp <span class="main">(</span><span class="free">a</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span>Bind <span class="free">f</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_Embed"><span class="command">lemma</span></span> det_wp_Embed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="free">t</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span>Embed <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword1" id="Determinism-det_wp_repeat"><span class="command">lemma</span></span> det_wp_repeat<span class="main">:</span>
  <span class="quoted"><span class="quoted">"determ <span class="main">(</span>wp <span class="free">a</span><span class="main">)</span> <span class="main">⟹</span> well_def <span class="free">a</span> <span class="main">⟹</span> determ <span class="main">(</span>wp <span class="main">(</span>repeat <span class="free">n</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> determI fa_intros max_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> determ_intros <span class="main">=</span>
  det_wp_Skip det_wp_Apply
  det_wp_Seq  det_wp_PC
  det_wp_SetPC det_wp_Bind
  det_wp_Embed det_wp_repeat

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Loops">
<div class="head">
<h1>Theory Loops</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The Loop Rules›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Loops <span class="keyword2"><span class="keyword">imports</span></span> <a href="WellDefined.html">WellDefined</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:loop_rules}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given a well-defined body, we can annotate a loop using an invariant, just as in the
classical setting.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Liberal and Strict Invariants.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A probabilistic invariant generalises a boolean one: it \emph{entails} itself, given
the loop guard.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wp_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wp_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Loops-wp_invI"><span class="command">lemma</span></span> wp_invI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="bound">I</span> <span class="bound">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> wp_inv <span class="free">G</span> <span class="free">body</span> <span class="bound">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_inv_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wlp_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'s</span> prog <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> real<span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wlp_inv</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span> <span class="main">≤</span> wlp <span class="free"><span class="bound"><span class="entity">body</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">s</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Loops-wlp_invI"><span class="command">lemma</span></span> wlp_invI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="bound">I</span> <span class="bound">s</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="bound">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span> wlp_inv <span class="free">G</span> <span class="free">body</span> <span class="bound">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_inv_def<span class="main">)</span>

<span class="keyword1" id="Loops-wlp_invD"><span class="command">lemma</span></span> wlp_invD<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wlp_inv <span class="free">G</span> <span class="free">body</span> <span class="free">I</span> <span class="main">⟹</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="free">I</span> <span class="free">s</span> <span class="main">≤</span> wlp <span class="free">body</span> <span class="free">I</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wlp_inv_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For standard invariants, the multiplication reduces to conjunction.›</span></span>
<span class="keyword1" id="Loops-wp_inv_stdD"><span class="command">lemma</span></span> wp_inv_stdD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"wp_inv <span class="free">G</span> <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     hb<span class="main">:</span>  <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> inv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_inv_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Correctness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partial correctness for loops\citep[Lemma 7.2.2, \S7, p.~185]{McIver_M_04}.›</span></span>
<span class="keyword1" id="Loops-wlp_Loop"><span class="command">lemma</span></span> wlp_Loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wd<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> uI<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">I</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"wlp_inv <span class="free">G</span> <span class="free">body</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> wlp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">≤</span> wlp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="var">?P</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?f</span> <span class="free">Q</span> <span class="free">s</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="free">Q</span> <span class="free">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="free">s</span> <span class="main">*</span> <span class="var">?P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊩</span> gfp_exp <span class="var">?f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> gfp_exp_upperbound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ uI<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span><span class="main">)</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span><span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_idem <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inv <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>wlp_invD <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_mono mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wlp <span class="free">body</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> uI well_def_wlp_nearly_healthy<span class="main">[</span><span class="operator">OF</span> wd<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wlp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>wlp_Loop1<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> unitary_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Total Correctness›</span></span>
<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:loop_total}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first total correctness lemma for loops which terminate with probability 1\citep[Lemma
7.3.1, \S7, p.~186]{McIver_M_04}.›</span></span>

<span class="keyword1" id="Loops-wp_Loop"><span class="command">lemma</span></span> wp_Loop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wd<span class="main">:</span>   <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span>  <span class="quoted"><span class="quoted">"wlp_inv <span class="free">G</span> <span class="free">body</span> <span class="free">I</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> unit<span class="main">:</span> <span class="quoted"><span class="quoted">"unitary <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">&amp;&amp;</span> wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">I</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">&amp;&amp;</span> <span class="var">?T</span> <span class="main">⊩</span> wp <span class="var">?loop</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We first appeal to the \emph{liberal} loop rule:›</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">&amp;&amp;</span> <span class="var">?T</span> <span class="main">⊩</span> wlp <span class="var">?loop</span> <span class="var">?X</span> <span class="main">&amp;&amp;</span> <span class="var">?T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>exp_conj_mono_left wlp_Loop<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Next, by sub-conjunctivity:›</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> wd <span class="keyword1"><span class="command">have</span></span> sdp_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"sub_distrib_pconj <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sdp_intros<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> wd unit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wlp <span class="var">?loop</span> <span class="var">?X</span> <span class="main">&amp;&amp;</span> <span class="var">?T</span> <span class="main">⊩</span> wp <span class="var">?loop</span> <span class="main">(</span><span class="var">?X</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>sub_distrib_pconjD sdp_intros unitary_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Finally, the conjunction collapses:›</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_1_right sound_intros sound_nneg unit unitary_sound<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Unfolding›</span></span>

<span class="keyword1" id="Loops-wp_loop_unfold"><span class="command">lemma</span></span> wp_loop_unfold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="free">P</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span> <span class="main">=</span>
   <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>wp <span class="main">(</span><span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> wp_eval<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="free">t</span>"</span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="free">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span>
    <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> lfp_trans_unfold<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Q</span><span class="main">.</span> sound <span class="bound">Q</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">Q</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> sP<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="var">?X</span> <span class="skolem">t</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_loop_step_sound<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">u</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> trans"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="skolem">t</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">t</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
           <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">P</span><span class="main">.</span> sound <span class="bound">P</span> <span class="main">⟹</span> sound <span class="main">(</span><span class="skolem">u</span> <span class="bound">P</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">t</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>
                          <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="skolem">u</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_loop_step_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> bound_of <span class="bound">P</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"le_trans <span class="main">(</span>wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> Embed <span class="var">?v</span> <span class="hidden">⇘</span><sub><span class="main">«</span> <span class="free">G</span> <span class="main">»</span></sub><span class="hidden">⇙</span>⊕ Skip<span class="main">)</span><span class="main">)</span> <span class="var">?v</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> le_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval lfp_loop_fp<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> negate_embed<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> expect"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sound <span class="skolem">P</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span><span class="var">?v</span> <span class="skolem">P</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"equiv_trans <span class="main">...</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">P</span> <span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="bound">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>wp <span class="main">(</span>Embed <span class="main">(</span>lfp_trans <span class="var">?X</span><span class="main">)</span><span class="main">)</span> <span class="bound">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> equiv_transI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval <span class="dynamic"><span class="dynamic">algebra_simps</span></span> negate_embed<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lfp_trans <span class="var">?X</span> <span class="free">P</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>lfp_trans <span class="var">?X</span> <span class="free">P</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sP <span class="keyword1"><span class="command">unfolding</span></span> wp_eval <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Loops-wp_loop_nguard"><span class="command">lemma</span></span> wp_loop_nguard<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> <span class="main">¬</span> <span class="free">G</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="free">P</span> <span class="free">s</span> <span class="main">=</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> wp_loop_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Loops-wp_loop_guard"><span class="command">lemma</span></span> wp_loop_guard<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> healthy <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span><span class="main">;</span> sound <span class="free">P</span><span class="main">;</span> <span class="free">G</span> <span class="free">s</span> <span class="main">⟧</span> <span class="main">⟹</span>
   wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="free">P</span> <span class="free">s</span> <span class="main">=</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="free">P</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">subst</span> wp_loop_unfold<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Termination">
<div class="head">
<h1>Theory Termination</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Authors: David Cock - David.Cock@nicta.com.au, Thomas Sewell - Thomas.Sewell@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Loop Termination"</span></span>
 
<span class="keyword1"><span class="command">theory</span></span> Termination <span class="keyword2"><span class="keyword">imports</span></span> <a href="Embedding.html">Embedding</a> <a href="StructuredReasoning.html">StructuredReasoning</a> <a href="Loops.html">Loops</a> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text_raw</span></span> <span class="quoted"><span class="plain_text">‹\label{s:termination}›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Termination for loops can be shown by classical means (using a variant, or a measure
function), or by probabilistic means: We only need that the loop terminates \emph{with probability
one}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trivial Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A maximal transformer (program) doesn't affect termination. This is
  essentially saying that such a program doesn't abort (or diverge).›</span></span>
<span class="keyword1" id="Termination-maximal_Seq_term"><span class="command">lemma</span></span> maximal_Seq_term<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">s</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mr<span class="main">:</span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">r</span> <span class="main">;;</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hs <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> ws<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> ts<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bounded_by <span class="main">1</span> <span class="main">(</span>wp <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>healthy_bounded_byD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> hs<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> mr <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval embed_bool_def maximalD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹From any state where the guard does not hold, a loop terminates
  in a single step.›</span></span>
<span class="keyword1" id="Termination-term_onestep"><span class="command">lemma</span></span> term_onestep<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_nguard hb<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>healthy_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> healthy_wp_loop<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Classical Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first non-trivial termination result is quite standard: If we can provide a
natural-number-valued measure, that decreases on every iteration, and implies termination on
reaching zero, the loop terminates.›</span></span>

<span class="keyword1" id="Termination-loop_term_nat_measure_noinv"><span class="command">lemma</span></span> loop_term_nat_measure_noinv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> guard<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> variant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="bound">n</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">n</span><span class="main">»</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> guard <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">G</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_nguard<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IH'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> fold_premise healthy_intros hb<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_funI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> wb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> term_onestep<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> G <span class="main">=</span> this
        <span class="keyword1"><span class="command">from</span></span> IH' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>use_premise healthy_intros hb<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> variant wb
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_Seq wd_intros<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hb G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_guard<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This version allows progress to depend on an invariant. Termination is then determined by
the invariant's value in the initial state.›</span></span>
<span class="keyword1" id="Termination-loop_term_nat_measure"><span class="command">lemma</span></span> loop_term_nat_measure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wb<span class="main">:</span>  <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> guard<span class="main">:</span>   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="free">G</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> variant<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="bound">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">n</span><span class="main">»</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inv<span class="main">:</span>     <span class="quoted"><span class="quoted">"wp_inv <span class="free">G</span> <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> scb <span class="main">=</span> sublinear_sub_conj<span class="main">[</span><span class="operator">OF</span> well_def_wp_sublinear<span class="main">,</span> <span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> use_premise<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> healthy_intros hb<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="improper"><span class="quoted"><span class="improper">n</span></span></span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> guard <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">G</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_nguard<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">assume</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> fold_premise healthy_intros hb le_funI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> hb <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_nguard<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">note</span></span> G <span class="main">=</span> this
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">=</span>
                <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_assoc exp_conj_unitary <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>exp_conj_idem<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>exp_conj_comm<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">from</span></span> inv hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wp_inv_stdD<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> variant
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="main">&amp;&amp;</span> <span class="main">(</span><span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span> <span class="main">⊩</span>
                  wp <span class="free">body</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> entails_frame<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> scb
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="free">body</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> wp <span class="free">body</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span>
                wp <span class="free">body</span> <span class="main">(</span><span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">I</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="main">⊩</span>
                        wp <span class="free">body</span> <span class="main">(</span><span class="main">«</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">I</span> <span class="main">»</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
            <span class="keyword1"><span class="command">from</span></span> IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>use_premise healthy_intros hb<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> <span class="skolem">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span><span class="free">I</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_std_split<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">I</span> <span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span> <span class="main">⊩</span>
                wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> wb <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wp_Seq wd_intros<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span> <span class="free">G</span> <span class="main">»</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">≤</span>
                 wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>exp_conj_std_split<span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">m</span> <span class="bound">s</span> <span class="main">=</span> Suc <span class="skolem">n</span> <span class="main">∧</span> <span class="free">I</span> <span class="bound">s</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">≤</span>
                       wp <span class="main">(</span><span class="free">body</span> <span class="main">;;</span> <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>exp_conj_def<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> hb G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_guard<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> True<span class="main">»</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probabilistic Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any loop that has a non-zero chance of terminating after each step terminates with
probability 1.›</span></span>

<span class="keyword1" id="Termination-termination_0_1"><span class="command">lemma</span></span> termination_0_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">body</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'s</span> prog"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wb<span class="main">:</span> <span class="quoted"><span class="quoted">"well_def <span class="free">body</span>"</span></span>
      <span class="comment1">― ‹The loop terminates in one step with nonzero probability›</span>
      <span class="keyword2"><span class="keyword">and</span></span> onestep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="free">body</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> nzp<span class="main">:</span>     <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">p</span>"</span></span>
      <span class="comment1">― ‹The body is maximal i.e.~it terminates absolutely.›</span>
      <span class="keyword2"><span class="keyword">and</span></span> mb<span class="main">:</span>      <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp <span class="free">body</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> hb <span class="main">=</span> well_def_wp_healthy<span class="main">[</span><span class="operator">OF</span> wb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> sb <span class="main">=</span> healthy_scalingD<span class="main">[</span><span class="operator">OF</span> hb<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> sab <span class="main">=</span> sublinear_subadd<span class="main">[</span><span class="operator">OF</span> well_def_wp_sublinear<span class="main">,</span> <span class="operator">OF</span> wb<span class="main">,</span> <span class="operator">OF</span> healthy_feasibleD<span class="main">,</span> <span class="operator">OF</span> hb<span class="main">]</span>

  <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> hloop<span class="main">:</span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> healthy_intros<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> swp<span class="main">:</span> <span class="quoted"><span class="quoted">"sound <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span><span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is no greater than $1$, by feasibility.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> onestep <span class="keyword1"><span class="command">have</span></span> onestep'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">≤</span> wp <span class="free">body</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword1"><span class="command">from</span></span> hb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"unitary <span class="main">(</span>wp <span class="free">body</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> wp <span class="free">body</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This is the crux of the proof: that given a lower bound below $1$, we can find another,
    higher one.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> new_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> le_funI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">s</span>
    <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
       <span class="keyword2"><span class="keyword">and</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> k1 <span class="keyword1"><span class="command">have</span></span> nz1k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">-</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> p1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_right_mono add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The new bound is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">p</span></span> <span class="main"><span class="main">*</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">-</span></span><span class="skolem"><span class="skolem">k</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">+</span></span> <span class="skolem"><span class="skolem">k</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="skolem">s</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By the one-step termination assumption:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> onestep' nz1k
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_right_mono ordered_comm_semiring_class.comm_mult_left_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By scaling:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> nz1k
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>right_scalingD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sb<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By the maximality (termination) of the loop body:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> mb k0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">+</span> wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>maximalD<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By sub-additivity of the loop body:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> k0 nz1k
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>add_left_mono mult_left_mono sub_addD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sab<span class="main"><span class="main">]</span></span> sound_intros<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>negate_embed <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹By monotonicity of the loop body, and that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is a lower bound:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> k0 hloop le_funD<span class="main">[</span><span class="operator">OF</span> X<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span>
      <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">iprover</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>add_left_mono mult_left_mono le_funI embed_ge_0
                       le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mono_transD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> healthy_monoD<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> hb<span class="main"><span class="main">]</span></span>
                       sound_sum standard_sound sound_intros swp<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Unrolling the loop once and simplifying:›</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span>
        <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> <span class="main">(</span><span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>distrib_left mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> embed_bool_idem embed_bool_cancel<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">...</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wp_loop_unfold<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">OF</span> hb<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="free">body</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span>
        <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span>
              wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
            <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span>
              wp <span class="free">body</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span>X<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Lastly, by folding two loop iterations:›</span></span>
    <span class="keyword1"><span class="command">also</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="skolem">s</span> <span class="main">*</span> <span class="main">(</span>wp <span class="free">body</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">«</span><span class="keyword1">𝒩</span> <span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">+</span> <span class="main">«</span><span class="free">G</span><span class="main">»</span> <span class="bound">s</span> <span class="main">*</span>
            wp <span class="free">body</span> <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">=</span>
          wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_loop_unfold<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ hb<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
                  fun_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wp_loop_unfold<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> _ hb<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span>"</span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span><span class="main">-</span><span class="skolem">k</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹If the previous bound lay in $[0,1)$, the new bound is strictly greater.  This is where
    we appeal to the fact that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is nonzero.›</span></span>
  <span class="keyword1"><span class="command">from</span></span> nzp <span class="keyword1"><span class="command">have</span></span> inc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="bound">k</span><span class="main">)</span> <span class="main">+</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>mult_pos_pos<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The result follows by contradiction.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹If the loop does not terminate everywhere, then there must exist some state
      from which the probability of termination is strictly less than one.›</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> point<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">1</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Inf <span class="main">(</span>range <span class="main">(</span>wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> hloop
    <span class="keyword1"><span class="command">have</span></span> Inflb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="var">?k</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_lower bdd_belowI<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> point <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">s</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Thus the least (infimum) probabilty of termination is strictly less than one.›</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> k1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> hloop <span class="keyword1"><span class="command">have</span></span> k0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The infimum is, naturally, a lower bound.›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Inflb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="var">?k</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We can therefore use the previous result to find a new bound, \ldots›</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?k</span><span class="main">)</span> <span class="main">+</span> <span class="var">?k</span> <span class="main">≤</span> wp <span class="keyword1">do</span> <span class="free">G</span> <span class="main">⟶</span> <span class="free">body</span> <span class="keyword1">od</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>le_funD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> new_bound<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹\ldots which is lower than the infimum, by minimality, \ldots›</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?k</span><span class="main">)</span> <span class="main">+</span> <span class="var">?k</span> <span class="main">≤</span> <span class="var">?k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>cInf_greatest<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹\ldots yet also strictly greater than it.›</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> k0 k1 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">&lt;</span> <span class="free">p</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">-</span> <span class="var">?k</span><span class="main">)</span> <span class="main">+</span> <span class="var">?k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> inc<span class="main">)</span>
    <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We thus have a contradiction.›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="pGCL">
<div class="head">
<h1>Theory pGCL</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">theory</span></span> pGCL <span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Algebra.html">Algebra</a> <a href="Automation.html">Automation</a> <a href="Determinism.html">Determinism</a> <a href="Embedding.html">Embedding</a>
  <a href="Expectations.html">Expectations</a> <a href="Healthiness.html">Healthiness</a> <a href="Induction.html">Induction</a> <a href="LoopInduction.html">LoopInduction</a>
  <a href="Loops.html">Loops</a> <a href="Misc.html">Misc</a> <a href="StructuredReasoning.html">StructuredReasoning</a> <a href="Sublinearity.html">Sublinearity</a>
  <a href="Termination.html">Termination</a> <a href="Transformers.html">Transformers</a> <a href="WellDefined.html">WellDefined</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Primitives">
<div class="head">
<h1>Theory Primitives</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Language Primitives"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Primitives <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="pGCL.html">../pGCL</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Programs in pGCL are probabilistic automata.  They can do anything a traditional program
can, plus, they may make truly probabilistic choices.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Basics›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Imagine flipping a pair of fair coins: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Using a record type for the
state allows a number of syntactic niceties, which we describe shortly:›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> coin <span class="main">=</span> Heads <span class="main">|</span> Tails

<span class="keyword1"><span class="command">record</span></span> coins <span class="main">=</span>
  a <span class="main">::</span> <span class="quoted">coin</span>
  b <span class="main">::</span> <span class="quoted">coin</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The primitive state operation is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Apply</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which takes a state transformer as an
argument, constructs the pGCL equivalent. Thus <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Apply <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">⦇</span></span> a <span class="main"><span class="main">:=</span></span> Heads <span class="main"><span class="main">⦈</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> sets the value
of coin <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Heads</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. As records are so common as state types, we introduce syntax to
make these update neater: The same program may be defined more simply as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"a <span class="main"><span class="main">:=</span></span> <span class="main"><span class="main">(</span></span><span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> Heads<span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
(note that the syntax translation involved does not apply to Latex output, and thus this lemma
appears trivial):
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"Apply <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">⦇</span> a <span class="main">:=</span> Heads <span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>a <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Heads<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can treat the record's fields as the names of \emph{variables}. Note that the right-hand
side of an assignment is always a function of the current state. Thus we may use a record accessor
directly, for example <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"a <span class="main"><span class="main">:=</span></span> b"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which updates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with the current value of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">b</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
If we wish to formally establish that the previous statement is correct i.e. that in the final
state, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">a</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> really will have whatever value <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">b</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> had in the initial state, we must first
introduce the assertion language.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Assertion and Annotation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Assertions in pGCL are real-valued functions of the state, which are often interpreted as a
probability distribution over possible outcomes. These functions are termed \emph{expectations}, for
reasons which shortly be clear. Initially, however, we need only consider \emph{standard}
expectations: those derived from a binary predicate. A predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> bool"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
embedded as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term_type</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">::</span></span><span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> bool<span class="main"><span class="main">»</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, such that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">«</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">»</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">1</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">¬</span></span> <span class="free"><span class="free">P</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">⟶</span></span> <span class="main"><span class="main">«</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">»</span></span> <span class="free"><span class="free">s</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  An annotation consists of an assertion on the initial state and one on the final state, which for
  standard expectations may be interpreted as `if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">P</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds in the initial state, then <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
  <span class="quoted"><span class="free"><span class="quoted"><span class="free">Q</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> will hold in the final state'. These are in weakest-precondition form: we assert that the
  precondition implies the \emph{weakest precondition}: the weakest assertion on the initial state,
  which implies that the postcondition must hold on the final state. So far, this is identical to
  the standard approach. Remember, however, that we are working with \emph{real-valued} assertions.
  For standard expectations, the logic is nevertheless identical, if the implication <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">∀</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> <span class="free"><span class="free">P</span></span> <span class="bound"><span class="bound">s</span></span>
  <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">Q</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is substituted with the equivalent expectation entailment <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">P</span></span><span class="main"><span class="main">»</span></span> <span class="main"><span class="main">⊩</span></span> <span class="main"><span class="main">«</span></span><span class="free"><span class="free">Q</span></span><span class="main"><span class="main">»</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>
  entails_implies<span class="antiquote"><span class="antiquote">}</span></span></span></span>. Thus a valid specification of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"a <span class="main"><span class="main">:=</span></span> b"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> b <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="main">(</span>a <span class="main">:=</span> b<span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> a <span class="bound">s</span> <span class="main">=</span> <span class="bound">x</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pvcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Any ordinary computation and its associated annotation can be expressed in this form.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probability›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we introduce the syntax <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">;;</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for the sequential composition of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and also demonstrate that one can operate directly on a real-valued (and thus
infinite) state space:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">::</span>real<span class="main">.</span> <span class="bound">s</span> <span class="main">≠</span> <span class="main">0</span><span class="main">»</span> <span class="main">⊩</span> wp <span class="main">(</span>Apply <span class="main">(</span><span class="main">(*)</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">;;</span> Apply <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">/</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">1</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pvcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹So far, we haven't done anything that required probabilities, or expectations other than 0
and 1. As an example of both, we show that a single coin toss is fair. We introduce the syntax
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="hidden">⇘</span><sub><span class="free"><span class="free">p</span></span></sub><span class="hidden">⇙</span>⊕ <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for a probabilistic choice between <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This program behaves
as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with probability <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">p</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with probability <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">-</span></span><span class="free"><span class="free">p</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The
probability may depend on the state, and is therefore of type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'s</span></span> <span class="main"><span class="main">⇒</span></span> real"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. The following
annotation states that the probability of heads is exactly 1/2:›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">flip_a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> coins prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flip_a</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> a <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Heads<span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ a <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Tails<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span>flip_a <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> a <span class="bound">s</span> <span class="main">=</span> Heads<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flip_a_def
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Sufficiently small problems can be handled by the simplifier, by symbolic evaluation.›</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Nondeterminism›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also under-specify a program, using the \emph{nondeterministic choice} operator,
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⨅</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is interpreted demonically, giving the pointwise \emph{minimum} of the
pre-expectations for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>: the chance of seeing heads, if your opponent is
allowed choose between a pair of coins, one biased 2/3 heads and one 2/3 tails, and then flips it,
is \emph{at least} 1/3, but we can make no stronger statement:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">3</span> <span class="main">⊩</span> wp <span class="main">(</span>flip_a <span class="main">(</span><span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⨅</span> flip_a <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span><span class="main">)</span> <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> a <span class="bound">s</span> <span class="main">=</span> Heads<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flip_a_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pvcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def le_funI<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Expectations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The probabilities of independent events combine as usual, by multiplying: The chance
of getting heads on two separate coins is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="main"><span class="main">/</span></span><span class="numeral"><span class="numeral">4</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">flip_b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> coins prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flip_b</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> b <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Heads<span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ b <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Tails<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">4</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span>flip_a <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">;;</span> flip_b <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span><span class="main">)</span>
                  <span class="main">«</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> a <span class="bound">s</span> <span class="main">=</span> Heads <span class="main">∧</span> b <span class="bound">s</span> <span class="main">=</span> Heads<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flip_a_def flip_b_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval o_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If, rather than two coins, we use two dice, we can make some slightly more involved
calculations.  We see that the weakest pre-expectation of the value on the face of the die after
rolling is its \emph{expected value} in the initial state, which justifies the use of the term
expectation.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> dice <span class="main">=</span>
  red  <span class="main">::</span> <span class="quoted">nat</span>
  blue <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Puniform</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> real<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Puniform</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="main">1</span> <span class="main">/</span> card <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Primitives-Puniform_in"><span class="command">lemma</span></span> Puniform_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> Puniform <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> card <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Puniform_def<span class="main">)</span>

<span class="keyword1" id="Primitives-Puniform_out"><span class="command">lemma</span></span> Puniform_out<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟹</span> Puniform <span class="free">S</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>Puniform_def<span class="main">)</span>

<span class="keyword1" id="Primitives-supp_Puniform"><span class="command">lemma</span></span> supp_Puniform<span class="main">:</span>
  <span class="quoted"><span class="quoted">"finite <span class="free">S</span> <span class="main">⟹</span> supp <span class="main">(</span>Puniform <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>Puniform_def supp_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The expected value of a roll of a six-sided die is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">7</span></span><span class="main"><span class="main">/</span></span><span class="numeral"><span class="numeral">2</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">7</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span><span class="keyword1">bind</span> <span class="bound"><span class="bound">v</span></span> <span class="keyword1">at</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Puniform <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">6</span><span class="main">}</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">in</span> red <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> red"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval supp_Puniform sum.atLeast_Suc_atMost Puniform_in<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The expectations of independent variables add:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">7</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span><span class="main">(</span><span class="keyword1">bind</span> <span class="bound"><span class="bound">v</span></span> <span class="keyword1">at</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Puniform <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">6</span><span class="main">}</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">in</span> red <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">;;</span>
                 <span class="main">(</span><span class="keyword1">bind</span> <span class="bound"><span class="bound">v</span></span> <span class="keyword1">at</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> Puniform <span class="main">{</span><span class="main">1</span><span class="main">..</span><span class="numeral">6</span><span class="main">}</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">in</span> blue <span class="main">:=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
                <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> red <span class="bound">s</span> <span class="main">+</span> blue <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval supp_Puniform sum.atLeast_Suc_atMost Puniform_in<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="LoopExamples">
<div class="head">
<h1>Theory LoopExamples</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Loops"</span></span>

<span class="keyword1"><span class="command">theory</span></span> LoopExamples <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="pGCL.html">../pGCL</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reasoning about loops in pGCL is mostly familiar, in particular in the use of invariants.
Proving termination for truly probabilistic loops is slightly different: We appeal to a 0--1 law
to show that the loop terminates \emph{with probability 1}.  In our semantic model, terminating
with certainty and with probability 1 are exactly equivalent.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Guaranteed Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We start with a completely classical loop, to show that standard techniques apply. Here, we
have a program that simply decrements a counter until it hits zero:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">countdown</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">countdown</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> Apply <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Clearly, this loop will only terminate from a state where <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">0</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This is, in fact,
also a loop invariant.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">inv_count</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Read <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"wp_inv <span class="free"><span class="free">G</span></span> <span class="free"><span class="free">body</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">I</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is an invariant of the loop
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">do</span></span> <span class="free"><span class="free">G</span></span> <span class="main"><span class="main">⟶</span></span> <span class="free"><span class="free">body</span></span> <span class="keyword1"><span class="keyword1">od</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, or <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">«</span></span><span class="free"><span class="free">G</span></span><span class="main"><span class="main">»</span></span> <span class="main"><span class="main">&amp;&amp;</span></span> <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">⊩</span></span> wp <span class="free"><span class="free">body</span></span> <span class="free"><span class="free">I</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="LoopExamples-wp_inv_count"><span class="command">lemma</span></span> wp_inv_count<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wp_inv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Apply <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">«</span>inv_count<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wp_inv_def inv_count_def wp_eval o_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">int</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">»</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">int</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">»</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">x</span><span class="main">»</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This example is contrived to give us an obvious variant, or measure function: the counter
itself.›</span></span>

<span class="keyword1" id="LoopExamples-term_countdown"><span class="command">lemma</span></span> term_countdown<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span>inv_count<span class="main">»</span> <span class="main">⊩</span> wp countdown <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> countdown_def
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">intro</span> loop_term_nat_measure<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> m<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">x</span></span><span class="main"><span class="main">.</span></span> nat <span class="main"><span class="main">(</span></span>max <span class="bound"><span class="bound">x</span></span> <span class="main"><span class="main">0</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span> wp_inv_count<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Apply <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">::</span>int<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹As usual, well-definedness is trivial.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"well_def <span class="var">?p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> wd_intros<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹A measure of 0 imples termination.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> nat <span class="main">(</span>max <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹This is the meat of the proof: that the measure must decrease,
    whenever the invariant holds.  Note that the invariant is essential
    here, as if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the measure will \emph{not} decrease.

    This is the kind of proof that the VCG is good at.  It leaves a purely
    logical goal, which we can solve with auto.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nat <span class="main">(</span>max <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> Suc <span class="bound">n</span><span class="main">»</span> <span class="main">&amp;&amp;</span> <span class="main">«</span>inv_count<span class="main">»</span> <span class="main">⊩</span>
         wp <span class="var">?p</span> <span class="main">«</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> nat <span class="main">(</span>max <span class="bound">x</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inv_count_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pvcg</span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  o_def exp_conj_std_split<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
            <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> implies_entails<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Probabilistic Termination›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Loops need not terminate deterministically: it is sufficient to terminate with probability
1. Here we show the intuitively obvious result that by flipping a coin repeatedly, you will
eventually see heads.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> coin <span class="main">=</span> <span class="quoted">bool</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Heads</span> <span class="main">=</span> True"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Tails</span> <span class="main">=</span> False"</span></span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">flip</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"coin prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">flip</span> <span class="main">=</span> Apply <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Heads<span class="main">)</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ Apply <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> Tails<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can't define a measure here, as we did previously, as neither of the
  two possible states guarantee termination.›</span></span>
<span class="keyword1"><span class="command">definition</span></span>
  <span class="entity">wait_for_heads</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"coin prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wait_for_heads</span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">(</span><span class="main">(≠)</span> Heads<span class="main">)</span> <span class="main">⟶</span> flip <span class="keyword1">od</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nonetheless, we can show termination .›</span></span>
<span class="keyword1" id="LoopExamples-wait_for_heads_term"><span class="command">lemma</span></span> wait_for_heads_term<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span> <span class="main">⊩</span> wp wait_for_heads <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wait_for_heads_def
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We use one of the zero-one laws for termination, specifically that
    if, from every state there is a nonzero probability of satisfying the
    guard (and thus terminating) in a single step, then the loop terminates
    from \emph{any} state, with probability 1.›</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> termination_0_1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"well_def flip"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flip_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>wd_intros<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹We must show that the loop body is deterministic, meaning that
    it cannot diverge by itself.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maximal <span class="main">(</span>wp flip<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flip_def <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>max_intros<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹The verification condition for the loop body is one-step-termination,
    here shown to hold with probability 1/2.  As usual, this result falls to
    the VCG.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span> <span class="main">⊩</span> wp flip <span class="main">«</span><span class="keyword1">𝒩</span> <span class="main">(</span><span class="main">(≠)</span> Heads<span class="main">)</span><span class="main">»</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> flip_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">pvcg</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>o_def Heads_def Tails_def<span class="main">)</span>

  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Finally, the one-step escape probability is non-zero.›</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span>real<span class="main">)</span> <span class="main">&lt;</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Monty">
<div class="head">
<h1>Theory Monty</h1>
</div>
<pre class="source"><span class="comment1">(*
 * Copyright (C) 2014 NICTA
 * All rights reserved.
 *)</span>

<span class="comment1">(* Author: David Cock - David.Cock@nicta.com.au *)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"The Monty Hall Problem"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Monty <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="pGCL.html">../pGCL</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We now tackle a more substantial example, allowing us to demonstrate
the tools for compositional reasoning and the use of invariants in
non-recursive programs.  Our example is the well-known Monty Hall puzzle
in statistical inference \citep{Selvin_75}.

The setting is a game show:  There is a prize hidden behind one
of three doors, and the contestant is invited to choose one.  Once
the guess is made, the host than opens one of the remaining two 
doors, revealing a goat and showing that the prize is elsewhere.  The
contestent is then given the choice of switching their guess to the
other unopened door, or sticking to their first guess.

The puzzle is whether the contestant is better off switching or
staying put; or indeed whether it makes a difference at all.  Most people's
intuition suggests that it make no difference, whereas in fact,
switching raises the chance of success from 1/3 to 2/3.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The State Space›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The game state consists of the prize location, the guess,
and the clue (the door the host opens).  These are not constrained a
priori to the range <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">{</span></span><span class="main"><span class="main">1</span></span><span class="main"><span class="main">::</span></span>real<span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">2</span></span><span class="main"><span class="main">,</span></span><span class="numeral"><span class="numeral">3</span></span><span class="main"><span class="main">}</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, but are simply natural numbers:
We instead show that this is in fact an invariant.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> game <span class="main">=</span>
  prize  <span class="main">::</span> <span class="quoted">nat</span>
 <span class="quoted">"guess"</span> <span class="main">::</span> <span class="quoted">nat</span>
  clue   <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The victory condition: The player wins if they have guessed the
  correct door, when the game ends.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">player_wins</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">player_wins</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> guess <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> prize <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We prove explicitly that only valid doors are ever chosen.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_prize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_prize</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> prize <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_clue</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_clue</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> clue <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">inv_guess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_guess</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> guess <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Game›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hide the prize behind door <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hide_behind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hide_behind</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> Apply <span class="main">(</span>prize_update <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Choose door <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">guess_behind</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">guess_behind</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> Apply <span class="main">(</span>guess_update <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Open door <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and reveal what's behind.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">open_door</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">open_door</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> Apply <span class="main">(</span>clue_update <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Hide the prize behind door 1, 2 or 3, demonically i.e.~according
  to any probability distribution (or none).›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">hide_prize</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">hide_prize</span> <span class="main">≡</span> hide_behind <span class="main">1</span> <span class="main">⨅</span> hide_behind <span class="numeral">2</span> <span class="main">⨅</span> hide_behind <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Guess uniformly at random.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">make_guess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">make_guess</span> <span class="main">≡</span> guess_behind <span class="main">1</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕
                    guess_behind <span class="numeral">2</span> <span class="hidden">⇘</span><sub><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">2</span><span class="main">)</span></sub><span class="hidden">⇙</span>⊕ guess_behind <span class="numeral">3</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Open one of the two doors that \emph{doesn't} hide the prize.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reveal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reveal</span> <span class="main">≡</span> <span class="main">⨅</span><span class="bound">d</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>prize <span class="bound">s</span><span class="main">,</span> guess <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> open_door <span class="bound">d</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Switch your guess to the other unopened door.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">switch_guess</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">switch_guess</span> <span class="main">≡</span> <span class="main">⨅</span><span class="bound">d</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>clue <span class="bound">s</span><span class="main">,</span> guess <span class="bound">s</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> guess_behind <span class="bound">d</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The complete game, either with or without switching guesses.›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"bool <span class="main">⇒</span> game prog"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monty</span> <span class="free"><span class="bound"><span class="entity">switch</span></span></span> <span class="main">≡</span> hide_prize <span class="main">;;</span>
                  make_guess <span class="main">;;</span>
                  reveal <span class="main">;;</span>
                  <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">switch</span></span></span> <span class="keyword1">then</span> switch_guess <span class="keyword1">else</span> Skip<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Brute Force Solution›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For sufficiently simple programs, we can calculate the exact weakest
  pre-expectation by unfolding.›</span></span>

<span class="keyword1" id="Monty-eval_win"><span class="command">lemma</span></span> eval_win<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⟹</span> <span class="main">«</span>player_wins<span class="main">»</span> <span class="main">(</span><span class="free">s</span><span class="main">⦇</span> prize <span class="main">:=</span> <span class="free">p</span><span class="main">,</span> guess <span class="main">:=</span> <span class="free">g</span><span class="main">,</span> clue <span class="main">:=</span> <span class="free">c</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def player_wins_def<span class="main">)</span>

<span class="keyword1" id="Monty-eval_loss"><span class="command">lemma</span></span> eval_loss<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="free">g</span> <span class="main">⟹</span> <span class="main">«</span>player_wins<span class="main">»</span> <span class="main">(</span><span class="free">s</span><span class="main">⦇</span> prize <span class="main">:=</span> <span class="free">p</span><span class="main">,</span> guess <span class="main">:=</span> <span class="free">g</span><span class="main">,</span> clue <span class="main">:=</span> <span class="free">c</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def player_wins_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If they stick to their guns, the player wins with $p=1/3$.›</span></span>
<span class="keyword1" id="Monty-wp_monty_noswitch"><span class="command">lemma</span></span> wp_monty_noswitch<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span>monty False<span class="main">)</span> <span class="main">«</span>player_wins<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monty_def hide_prize_def make_guess_def reveal_def
            hide_behind_def guess_behind_def open_door_def
            switch_guess_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wp_eval insert_Diff_if o_def<span class="main">)</span>

<span class="keyword1" id="Monty-swap_upd"><span class="command">lemma</span></span> swap_upd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">⦇</span> prize <span class="main">:=</span> <span class="free">p</span><span class="main">,</span> clue <span class="main">:=</span> <span class="free">c</span><span class="main">,</span> guess <span class="main">:=</span> <span class="free">g</span> <span class="main">⦈</span> <span class="main">=</span>
   <span class="free">s</span><span class="main">⦇</span> prize <span class="main">:=</span> <span class="free">p</span><span class="main">,</span> guess <span class="main">:=</span> <span class="free">g</span><span class="main">,</span> clue <span class="main">:=</span> <span class="free">c</span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If they switch, they win with $p=2/3$.  Brute force here
  takes longer, but is still feasible.  On larger programs,
  this will rapidly become impossible, as the size of the terms
  (generally) grows exponentially with the length of the program.›</span></span>

<span class="keyword1" id="Monty-wp_monty_switch_bruteforce"><span class="command">lemma</span></span> wp_monty_switch_bruteforce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">=</span> wp <span class="main">(</span>monty True<span class="main">)</span> <span class="main">«</span>player_wins<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monty_def hide_prize_def make_guess_def reveal_def
            hide_behind_def guess_behind_def open_door_def
            switch_guess_def
  <span class="comment1">― ‹Note that this is getting slow›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wp_eval insert_Diff_if swap_upd o_def <span class="quasi_keyword">cong</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> INF_cong_simp<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹A Modular Approach›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can solve the problem more efficiently, at the cost of
  a little more user effort, by breaking up the problem and annotating
  each step of the game separately.  While this is not strictly necessary
  for this program, it will scale to larger examples, as the work in
  annotation only increases linearly with the length of the program.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Healthiness›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first establish healthiness for each step. This follows
  straightforwardly by applying the supplied rulesets.›</span></span>

<span class="keyword1" id="Monty-wd_hide_prize"><span class="command">lemma</span></span> wd_hide_prize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def hide_prize"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hide_prize_def hide_behind_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wd_intros<span class="main">)</span>

<span class="keyword1" id="Monty-wd_make_guess"><span class="command">lemma</span></span> wd_make_guess<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def make_guess"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> make_guess_def guess_behind_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wd_intros<span class="main">)</span>

<span class="keyword1" id="Monty-wd_reveal"><span class="command">lemma</span></span> wd_reveal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def reveal"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Here, we do need a subsidiary lemma: that there is always
    a `fresh' door available.  The rest of the healthiness proof follows
    as usual.›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>prize <span class="bound">s</span><span class="main">,</span> guess <span class="bound">s</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>insert_Diff_if<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> reveal_def open_door_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> wd_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Monty-wd_switch_guess"><span class="command">lemma</span></span> wd_switch_guess<span class="main">:</span>
  <span class="quoted"><span class="quoted">"well_def switch_guess"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>clue <span class="bound">s</span><span class="main">,</span> guess <span class="bound">s</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>insert_Diff_if<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> switch_guess_def guess_behind_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">intro</span> wd_intros<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> monty_healthy <span class="main">=</span>
  wd_switch_guess wd_reveal wd_make_guess wd_hide_prize

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Annotations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now annotate each step individually, and then combine them to
  produce an annotation for the entire program.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">hide_prize</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> chooses a valid door.›</span></span>
<span class="keyword1" id="Monty-wp_hide_prize"><span class="command">lemma</span></span> wp_hide_prize<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">⊩</span> wp hide_prize <span class="main">«</span>inv_prize<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> hide_prize_def hide_behind_def wp_eval o_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>embed_bool_def inv_prize_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given the prize invariant, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">make_guess</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> chooses a valid
  door, and guesses incorrectly with probability at least 2/3.›</span></span>
<span class="keyword1" id="Monty-wp_make_guess"><span class="command">lemma</span></span> wp_make_guess<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span> <span class="main">*</span> <span class="main">«</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> inv_prize <span class="bound">g</span><span class="main">»</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⊩</span>
   wp make_guess <span class="main">«</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> guess <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span> inv_prize <span class="bound">g</span> <span class="main">∧</span> inv_guess <span class="bound">g</span><span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> make_guess_def guess_behind_def wp_eval o_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>embed_bool_def inv_prize_def inv_guess_def<span class="main">)</span>

<span class="keyword1" id="Monty-last_one"><span class="command">lemma</span></span> last_one<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≠</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">::</span>nat<span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∈</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">c</span><span class="main">.</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">b</span><span class="main">,</span><span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">c</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>insert_Diff_if<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given the composed invariants, and an incorrect guess, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">reveal</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  will give a clue that is neither the prize, nor the guess.›</span></span>
<span class="keyword1" id="Monty-wp_reveal"><span class="command">lemma</span></span> wp_reveal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> guess <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span> inv_prize <span class="bound">g</span> <span class="main">∧</span> inv_guess <span class="bound">g</span><span class="main">»</span> <span class="main">⊩</span>
   wp reveal <span class="main">«</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> guess <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span>
                  clue <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span>
                  clue <span class="bound">g</span> <span class="main">≠</span> guess <span class="bound">g</span> <span class="main">∧</span>
                  inv_prize <span class="bound">g</span> <span class="main">∧</span> inv_guess <span class="bound">g</span> <span class="main">∧</span> inv_clue <span class="bound">g</span><span class="main">»</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">⊩</span> wp reveal <span class="var">?Y</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> use_premise<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> well_def_wp_healthy<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wd_reveal<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"guess <span class="skolem">s</span> <span class="main">≠</span> prize <span class="skolem">s</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_prize <span class="skolem">s</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_guess <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Suc <span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span> <span class="main">-</span>  <span class="main">{</span>prize <span class="skolem">s</span><span class="main">,</span> guess <span class="skolem">s</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">c</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> prize <span class="skolem">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≠</span> guess <span class="skolem">s</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> inv_prize_def inv_guess_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>last_one <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>ex1E<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> wp reveal <span class="var">?Y</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>reveal_def open_door_def wp_eval singleton o_def
                embed_bool_def inv_prize_def inv_guess_def inv_clue_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Showing that the three doors are all district is a largeish
  first-order problem, for which sledgehammer gives us a reasonable
  script.›</span></span>
<span class="keyword1" id="Monty-distinct_game"><span class="command">lemma</span></span> distinct_game<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> guess <span class="free">g</span> <span class="main">≠</span> prize <span class="free">g</span><span class="main">;</span> clue <span class="free">g</span> <span class="main">≠</span> prize <span class="free">g</span><span class="main">;</span> clue <span class="free">g</span> <span class="main">≠</span> guess <span class="free">g</span><span class="main">;</span>
     inv_prize <span class="free">g</span><span class="main">;</span> inv_guess <span class="free">g</span><span class="main">;</span> inv_clue <span class="free">g</span> <span class="main">⟧</span> <span class="main">⟹</span> 
   <span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span>guess <span class="free">g</span><span class="main">,</span> prize <span class="free">g</span><span class="main">,</span> clue <span class="free">g</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inv_prize_def inv_guess_def inv_clue_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">metis</span> insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given the invariants, switching from the wrong guess gives
  the right one.›</span></span>
<span class="keyword1" id="Monty-wp_switch_guess"><span class="command">lemma</span></span> wp_switch_guess<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">«</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> guess <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span> clue <span class="bound">g</span> <span class="main">≠</span> prize <span class="bound">g</span> <span class="main">∧</span> clue <span class="bound">g</span> <span class="main">≠</span> guess <span class="bound">g</span> <span class="main">∧</span>
        inv_prize <span class="bound">g</span> <span class="main">∧</span> inv_guess <span class="bound">g</span> <span class="main">∧</span> inv_clue <span class="bound">g</span><span class="main">»</span> <span class="main">⊩</span>
   wp switch_guess <span class="main">«</span>player_wins<span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> use_premise<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> wd_switch_guess <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"healthy <span class="main">(</span>wp switch_guess<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"guess <span class="skolem">s</span> <span class="main">≠</span> prize <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"clue <span class="skolem">s</span> <span class="main">≠</span> prize <span class="skolem">s</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"clue <span class="skolem">s</span> <span class="main">≠</span> guess <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_prize <span class="skolem">s</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_guess <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"inv_clue <span class="skolem">s</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> state <span class="main">=</span> this
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">«</span> player_wins <span class="main">»</span> <span class="main">(</span><span class="skolem">s</span><span class="main">⦇</span>guess <span class="main">:=</span> <span class="bound">a</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
    <span class="main">(</span><span class="main">{</span>guess <span class="skolem">s</span><span class="main">,</span> prize <span class="skolem">s</span><span class="main">,</span> clue <span class="skolem">s</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>clue <span class="skolem">s</span><span class="main">,</span> guess <span class="skolem">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>insert_Diff_if player_wins_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> state
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Inf <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">«</span> player_wins <span class="main">»</span> <span class="main">(</span><span class="skolem">s</span><span class="main">⦇</span>guess <span class="main">:=</span> <span class="bound">a</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span>
                  <span class="main">(</span><span class="main">{</span><span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">,</span> <span class="numeral">3</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>clue <span class="skolem">s</span><span class="main">,</span> guess <span class="skolem">s</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>distinct_game<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> wp switch_guess <span class="main">«</span>player_wins<span class="main">»</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>switch_guess_def guess_behind_def wp_eval o_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> wp switch_guess <span class="main">«</span> player_wins <span class="main">»</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Given componentwise specifications, we can glue them together
with calculational reasoning to get our result.›</span></span>
<span class="keyword1" id="Monty-wp_monty_switch_modular"><span class="command">lemma</span></span> wp_monty_switch_modular<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span>monty True<span class="main">)</span> <span class="main">«</span>player_wins<span class="main">»</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">rule</span> wp_validD<span class="main">)</span>  <span class="comment1">― ‹Work in probabilistic Hoare triples›</span>
  <span class="keyword1"><span class="command">note</span></span> wp_validI<span class="main">[</span><span class="operator">OF</span> wp_scale<span class="main">,</span> <span class="operator">OF</span> wp_hide_prize<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
    <span class="comment1">― ‹Here we apply scaling to match our pre-expectation›</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> wp_validI<span class="main">[</span><span class="operator">OF</span> wp_make_guess<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> wp_validI<span class="main">[</span><span class="operator">OF</span> wp_reveal<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> wp_validI<span class="main">[</span><span class="operator">OF</span> wp_switch_guess<span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">⦄</span> monty True <span class="main">⦃</span><span class="main">«</span>player_wins<span class="main">»</span><span class="keyword1">⦄p</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> monty_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>wd_intros sound_intros monty_healthy<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Using the VCG›</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> scaled_hide <span class="main">=</span> wp_scale<span class="main">[</span><span class="operator">OF</span> wp_hide_prize<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> scaled_hide<span class="main">[</span><span class="operator">pwp</span><span class="main">]</span> wp_make_guess<span class="main">[</span><span class="operator">pwp</span><span class="main">]</span> wp_reveal<span class="main">[</span><span class="operator">pwp</span><span class="main">]</span> wp_switch_guess<span class="main">[</span><span class="operator">pwp</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> wd_hide_prize<span class="main">[</span><span class="operator">wd</span><span class="main">]</span> wd_make_guess<span class="main">[</span><span class="operator">wd</span><span class="main">]</span> wd_reveal<span class="main">[</span><span class="operator">wd</span><span class="main">]</span> wd_switch_guess<span class="main">[</span><span class="operator">wd</span><span class="main">]</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Alternatively, the VCG will get this using the same annotations.›</span></span>
<span class="keyword1" id="Monty-wp_monty_switch_vcg"><span class="command">lemma</span></span> wp_monty_switch_vcg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="numeral">2</span><span class="main">/</span><span class="numeral">3</span><span class="main">)</span> <span class="main">⊩</span> wp <span class="main">(</span>monty True<span class="main">)</span> <span class="main">«</span>player_wins<span class="main">»</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monty_def
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">pvcg</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>