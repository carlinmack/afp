<div id="Digraph_Basic">
<div class="head">
<h1>Theory Digraph_Basic</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Relations interpreted as Directed Graphs›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Digraph_Basic
<span class="keyword2"><span class="keyword">imports</span></span>   
  <span class="quoted">"<a href="../Automatic_Refinement/Misc.html">Automatic_Refinement.Misc</a>"</span>
  <span class="quoted">"<a href="../Automatic_Refinement/Refine_Util.html">Automatic_Refinement.Refine_Util</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Omega_Words_Fun.html">HOL-Library.Omega_Words_Fun</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory contains some basic graph theory on directed graphs which are 
  modeled as a relation between nodes. 

  The theory here is very fundamental, and 
  also used by non-directly graph-related applications like the theory of 
  tail-recursion in the Refinement Framework. Thus, we decided to put it 
  in the basic theories of the refinement framework.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Directed graphs are modeled as a relation on nodes›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'v</span> digraph <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> digraph <span class="main">=</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> digraph"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Paths›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Path are modeled as list of nodes, the last node of a path is not included
  into the list. This formalization allows for nice concatenation and splitting
  of paths.›</span></span>
<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">path</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> digraph <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> list <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">E</span> <span class="keyword2"><span class="keyword">where</span></span>
  path0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">path</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span>"</span></span>
<span class="main">|</span> path_prepend<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">;</span> <span class="free">path</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">path</span> <span class="free">E</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span>"</span></span>

<span class="keyword1" id="Digraph_Basic-path1"><span class="command">lemma</span></span> path1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">⟹</span> path <span class="free">E</span> <span class="free">u</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_empty_conv"><span class="command">lemma</span></span> path_empty_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">[]</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">u</span><span class="main">=</span><span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path0 <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path.cases<span class="main">)</span>

<span class="keyword1"><span class="command">inductive_cases</span></span> path_uncons<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">u'</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">inductive_simps</span></span> path_cons_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">u'</span><span class="main">#</span><span class="free">l</span><span class="main">)</span> <span class="free">w</span>"</span></span>

<span class="keyword1" id="Digraph_Basic-path_no_edges"><span class="command">lemma</span></span> path_no_edges<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">{}</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">u</span><span class="main">=</span><span class="free">v</span> <span class="main">∧</span> <span class="free">p</span><span class="main">=</span><span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_conc"><span class="command">lemma</span></span> path_conc<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">la</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">lb</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">la</span><span class="main">@</span><span class="free">lb</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P1 P2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros<span class="main">)</span>
  
<span class="keyword1" id="Digraph_Basic-path_append"><span class="command">lemma</span></span> path_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> path <span class="free">E</span> <span class="free">u</span> <span class="free">l</span> <span class="free">v</span><span class="main">;</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">⟧</span> <span class="main">⟹</span> path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">l</span><span class="main">@</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> path_conc<span class="main">[</span><span class="operator">OF</span> _ path1<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Digraph_Basic-path_unconc"><span class="command">lemma</span></span> path_unconc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">la</span><span class="main">@</span><span class="free">lb</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">v</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">la</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">lb</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">thm</span></span> path.induct
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="quoted">"<span class="free">la</span><span class="main">@</span><span class="free">lb</span>"</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">la</span></span> <span class="quoted"><span class="free">lb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path.intros <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_Cons_eq_append_cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_conc_conv"><span class="command">lemma</span></span> path_conc_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">la</span><span class="main">@</span><span class="free">lb</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">.</span> path <span class="free">E</span> <span class="free">u</span> <span class="free">la</span> <span class="bound">v</span> <span class="main">∧</span> path <span class="free">E</span> <span class="bound">v</span> <span class="free">lb</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_conc <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path_unconc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> -<span class="main">)</span> path_append_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span> <span class="free">w</span> <span class="main">⟷</span> <span class="main">(</span>path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">∧</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv path_conc_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> path_simps <span class="main">=</span> path_empty_conv path_cons_conv path_conc_conv


<span class="keyword1"><span class="command">lemmas</span></span> path_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span> <span class="main">=</span> path_prepend path_conc path_append
<span class="keyword1" id="Digraph_Basic-path_from_edges"><span class="command">lemma</span></span> path_from_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">;</span> <span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">⟧</span> <span class="main">⟹</span> path <span class="free">E</span> <span class="free">u</span> <span class="main">[</span><span class="free">u</span><span class="main">]</span> <span class="free">v</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>


<span class="keyword1" id="Digraph_Basic-path_edge_cases"><span class="command">lemma</span></span> path_edge_cases<span class="main">[</span><span class="operator">case_names</span> no_use split<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>insert <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> 
    <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span> 
  <span class="main">|</span> <span class="free">p1</span> <span class="free">p2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">p1</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>insert <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="free">v</span> <span class="free">p2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> path_simps path_cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_edge_rev_cases"><span class="command">lemma</span></span> path_edge_rev_cases<span class="main">[</span><span class="operator">case_names</span> no_use split<span class="main">]</span><span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>insert <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> 
    <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span> 
  <span class="main">|</span> <span class="free">p1</span> <span class="free">p2</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>insert <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="free">E</span><span class="main">)</span> <span class="free">w</span> <span class="free">p1</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">p2</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv path_conc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> path_simps path_append_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1" id="Digraph_Basic-path_mono"><span class="command">lemma</span></span> path_mono<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">⊆</span><span class="free">E'</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E'</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">using</span></span> S
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_is_rtrancl"><span class="command">lemma</span></span> path_is_rtrancl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">l</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-rtrancl_is_path"><span class="command">lemma</span></span> rtrancl_is_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">l</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path0 path_append<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_is_trancl"><span class="command">lemma</span></span> path_is_trancl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">l</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induct</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">l</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-trancl_is_path"><span class="command">lemma</span></span> trancl_is_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">l</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">l</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induct</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path0 path_append<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_nth_conv"><span class="command">lemma</span></span> path_nth_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">p'</span><span class="main">=</span><span class="free">p</span><span class="main">@</span><span class="main">[</span><span class="free">v</span><span class="main">]</span> <span class="keyword1">in</span>
  <span class="free">u</span><span class="main">=</span><span class="bound">p'</span><span class="main">!</span><span class="main">0</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="bound">p'</span> <span class="main">-</span> <span class="main">1</span><span class="main">.</span> <span class="main">(</span><span class="bound">p'</span><span class="main">!</span><span class="bound">i</span><span class="main">,</span><span class="bound">p'</span><span class="main">!</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_conc_conv path_cons_conv nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_mapI"><span class="command">lemma</span></span> path_mapI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>pairself <span class="free">f</span> <span class="main">`</span> <span class="free">E</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">)</span> <span class="main">(</span>map <span class="free">f</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_restrict"><span class="command">lemma</span></span> path_restrict<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">E</span> <span class="main">∩</span> set <span class="free">p</span> <span class="main">×</span> insert <span class="free">v</span> <span class="main">(</span>set <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">induction</span>
  <span class="keyword1"><span class="command">print_cases</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path_prepend <span class="skolem">u</span> <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> path_prepend.IH <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">E</span> <span class="main">∩</span> set <span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">p</span><span class="main">)</span> <span class="main">×</span> insert <span class="skolem">w</span> <span class="main">(</span>set <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">p</span> <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> path_mono<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-path_restrict_closed"><span class="command">lemma</span></span> path_restrict_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CLOSED<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">D</span> <span class="main">⊆</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">p</span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">D</span><span class="main">×</span><span class="free">D</span><span class="main">)</span> <span class="free">v</span> <span class="free">p</span> <span class="free">v'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P CLOSED I
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>


<span class="keyword1" id="Digraph_Basic-path_set_induct"><span class="command">lemma</span></span> path_set_induct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∈</span><span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">p</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-path_nodes_reachable"><span class="command">lemma</span></span> path_nodes_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟹</span> insert <span class="free">v</span> <span class="main">(</span>set <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">u</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_decomp path_cons_conv path_conc_conv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> path_is_rtrancl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path_nodes_edges"><span class="command">lemma</span></span> path_nodes_edges<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟹</span> set <span class="free">p</span> <span class="main">⊆</span> fst<span class="main">`</span><span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-path_tl_nodes_edges"><span class="command">lemma</span></span> path_tl_nodes_edges<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> fst<span class="main">`</span><span class="free">E</span> <span class="main">∩</span> snd<span class="main">`</span><span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> path_nodes_edges<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> fst<span class="main">`</span><span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span> <span class="main">⊆</span> snd<span class="main">`</span><span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> path_set_induct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"snd<span class="main">`</span><span class="free">E</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-path_loop_shift"><span class="command">lemma</span></span> path_loop_shift<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="free">p</span> <span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span>set <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">p'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="free">p'</span> <span class="main">=</span> set <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">p'</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> S <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="skolem">p1</span><span class="main">@</span><span class="free">v</span><span class="main">#</span><span class="skolem">p2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_decomp<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> P <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">u</span> <span class="skolem">p1</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="skolem">v'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="skolem">v'</span> <span class="skolem">p2</span> <span class="free">u</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="main">(</span><span class="free">v</span><span class="main">#</span><span class="skolem">p2</span><span class="main">@</span><span class="skolem">p1</span><span class="main">)</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> that<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">#</span><span class="skolem">p2</span><span class="main">@</span><span class="skolem">p1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-path_hd"><span class="command">lemma</span></span> path_hd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">p</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"hd <span class="free">p</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv neq_Nil_conv<span class="main">)</span>


<span class="keyword1" id="Digraph_Basic-path_last_is_edge"><span class="command">lemma</span></span> path_last_is_edge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">x</span> <span class="free">p</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>last <span class="free">p</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_rev_conv path_simps<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_member_reach_end"><span class="command">lemma</span></span> path_member_reach_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">x</span> <span class="free">p</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> path_is_trancl <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_decomp path_simps<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-path_tl_induct"><span class="command">lemma</span></span> path_tl_induct<span class="main">[</span><span class="operator">consumes</span> 2<span class="main">,</span> <span class="operator">case_names</span> single step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">x</span> <span class="free">p</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> NE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> ST<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="main">⟦</span><span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span><span class="main">;</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main">;</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">u</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span> <span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="free">p</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> P NE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> P
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_nonempty_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">u</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">u</span> <span class="skolem">us</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">x</span> <span class="skolem">us</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc path_is_trancl <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="skolem">us</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">v</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> set <span class="main">(</span>tl <span class="main">(</span><span class="skolem">us</span><span class="main">@</span><span class="main">[</span><span class="skolem">u</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="free">x</span> <span class="bound">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ST<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Digraph_Basic-path_restrict_tl"><span class="command">lemma</span></span> path_restrict_tl<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">u</span><span class="main">∉</span><span class="free">R</span><span class="main">;</span> path <span class="main">(</span><span class="free">E</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">-</span><span class="free">R</span><span class="main">)</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> path <span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps rel_restrict_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-path1_restr_conv"><span class="command">lemma</span></span> path1_restr_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span><span class="free">E</span><span class="main">∩</span>UNIV <span class="main">×</span> <span class="main">-</span><span class="free">R</span><span class="main">)</span> <span class="free">u</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="free">v</span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">∉</span><span class="free">R</span> <span class="main">∧</span> <span class="free">x</span><span class="main">=</span><span class="free">u</span> <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">w</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span> <span class="main">∧</span> path <span class="main">(</span>rel_restrict <span class="free">E</span> <span class="free">R</span><span class="main">)</span> <span class="bound">w</span> <span class="free">xs</span> <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_restrict <span class="free">E</span> <span class="free">R</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="main">-</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_restrict_def<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> path_restrict_tl path_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>



<span class="keyword1" id="Digraph_Basic-dropWhileNot_path"><span class="command">lemma</span></span> dropWhileNot_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"dropWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">v</span> <span class="free">c</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">p</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="free">v</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> dropWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="skolem">y</span> <span class="skolem">ps</span> <span class="free">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> path_uncons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons.prems False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-takeWhileNot_path"><span class="command">lemma</span></span> takeWhileNot_path<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">v</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="free">w</span> <span class="free">c</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">p</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">=</span><span class="free">v</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> cons <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">c'</span> <span class="main">=</span> takeWhile <span class="main">(</span><span class="main">(≠)</span> <span class="free">v</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="skolem">p</span><span class="main">#</span><span class="skolem">c'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="skolem">y</span> <span class="skolem">ps</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> path_uncons <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> cons.prems False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> set <span class="skolem">ps</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="skolem">y</span> <span class="skolem">c'</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons.IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">w</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite Paths›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ipath</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'q</span> digraph <span class="main">⇒</span> <span class="tfree">'q</span> word <span class="main">⇒</span> bool"</span></span>
  <span class="comment1">― ‹Predicate for an infinite path in a digraph›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ipath</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>


<span class="keyword1" id="Digraph_Basic-ipath_conc_conv"><span class="command">lemma</span></span> ipath_conc_conv<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="main">(</span><span class="free">u</span> <span class="main">⌢</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">.</span> path <span class="free">E</span> <span class="bound">a</span> <span class="free">u</span> <span class="main">(</span><span class="free">v</span> <span class="main">0</span><span class="main">)</span> <span class="main">∧</span> ipath <span class="free">E</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> conc_def ipath_def path_nth_conv nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_Suc_right diff_add_inverse not_add_less1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc diff_Suc_Suc not_less_eq<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-ipath_iter_conv"><span class="command">lemma</span></span> ipath_iter_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">≠</span><span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="main">(</span><span class="free">p</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>path <span class="free">E</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">u</span> <span class="skolem">p'</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> PLEN<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="main">(</span>iter <span class="main">(</span><span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>iter <span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="bound">i</span><span class="main">,</span> iter <span class="main">(</span><span class="free">p</span><span class="main">)</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>length <span class="free">p</span><span class="main">.</span> <span class="main">(</span><span class="free">p</span><span class="main">!</span><span class="bound">i</span><span class="main">,</span><span class="main">(</span><span class="free">p</span><span class="main">@</span><span class="main">[</span>hd <span class="free">p</span><span class="main">]</span><span class="main">)</span><span class="main">!</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"Suc <span class="improper">i</span> <span class="main">=</span> length <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_nth_conv Cons nth_append nth_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span>hd <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="main">(</span>iter <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_nth_conv ipath_def assms Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">i</span> <span class="keyword1">mod</span> length <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append assms <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> less_not_refl mod_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> PLEN diff_self_eq_0 mod_Suc nth_Cons_0 mod_less_divisor<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-ipath_to_rtrancl"><span class="command">lemma</span></span> ipath_to_rtrancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i1</span><span class="main">≤</span><span class="free">i2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="free">i1</span><span class="main">,</span><span class="free">r</span> <span class="free">i2</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> I
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i2</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i1</span><span class="main">=</span>Suc <span class="skolem">i2</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i1</span><span class="main">≠</span>Suc <span class="skolem">i2</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Suc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="free">i1</span><span class="main">,</span><span class="free">r</span> <span class="skolem">i2</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="skolem">i2</span><span class="main">,</span><span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">i2</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
    
<span class="keyword1" id="Digraph_Basic-ipath_to_trancl"><span class="command">lemma</span></span> ipath_to_trancl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i1</span><span class="main">&lt;</span><span class="free">i2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="free">i1</span><span class="main">,</span><span class="free">r</span> <span class="free">i2</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="free">i1</span><span class="main">,</span><span class="free">r</span> <span class="main">(</span>Suc <span class="free">i1</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="free">i1</span><span class="main">)</span><span class="main">,</span><span class="free">r</span> <span class="free">i2</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ipath_to_rtrancl<span class="main">[</span><span class="operator">OF</span> R<span class="main">,</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i1</span>"</span></span> <span class="quoted"><span class="free">i2</span></span><span class="main">]</span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>rtrancl_into_trancl2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-run_limit_two_connectedI"><span class="command">lemma</span></span> run_limit_two_connectedI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> limit <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span>limit <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>+</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">}</span> <span class="main">⊆</span> limit <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ipath_to_trancl two_in_limit_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Digraph_Basic-ipath_subpath"><span class="command">lemma</span></span> ipath_subpath<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> LE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span><span class="main">≤</span><span class="free">u</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path <span class="free">E</span> <span class="main">(</span><span class="free">r</span> <span class="free">l</span><span class="main">)</span> <span class="main">(</span>map <span class="free">r</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">u</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">r</span> <span class="free">u</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LE
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">-</span><span class="free">l</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH<span class="main">=</span>Suc.hyps<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">u</span><span class="main">-</span><span class="skolem">l</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span><span class="main">≤</span><span class="skolem">u</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">=</span>Suc <span class="skolem">u'</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">=</span><span class="skolem">u'</span><span class="main">-</span><span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">u'</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">u</span></span><span class="main">)</span> <span class="operator">auto</span>
    
  <span class="keyword1"><span class="command">note</span></span> IH<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="skolem">u'</span><span class="main">,</span><span class="free">r</span> <span class="skolem">u</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_def<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">u'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_Suc_append<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>  

<span class="keyword1" id="Digraph_Basic-ipath_restrict_eq"><span class="command">lemma</span></span> ipath_restrict_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="main">(</span><span class="free">E</span> <span class="main">∩</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">r</span> <span class="main">0</span><span class="main">}</span> <span class="main">×</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">r</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span> <span class="main">⟷</span> ipath <span class="free">E</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ipath_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> relpow_fun_conv rtrancl_power<span class="main">)</span>
<span class="keyword1" id="Digraph_Basic-ipath_restrict"><span class="command">lemma</span></span> ipath_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span> <span class="main">⟹</span> ipath <span class="main">(</span><span class="free">E</span> <span class="main">∩</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">r</span> <span class="main">0</span><span class="main">}</span> <span class="main">×</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">{</span><span class="free">r</span> <span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ipath_restrict_eq<span class="main">)</span>


<span class="keyword1" id="Digraph_Basic-ipathI"><span class="command">lemma</span></span> ipathI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main"><span class="main">?</span></span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main">⟧</span> <span class="main">⟹</span> ipath <span class="free">E</span> <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-ipathD"><span class="command">lemma</span></span> ipathD<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">,</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-ipath_in_Domain"><span class="command">lemma</span></span> ipath_in_Domain<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="free">i</span> <span class="main">∈</span> Domain <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-ipath_in_Range"><span class="command">lemma</span></span> ipath_in_Range<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>ipath <span class="free">E</span> <span class="free">r</span><span class="main">;</span> <span class="free">i</span><span class="main">≠</span><span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="free">r</span> <span class="free">i</span> <span class="main">∈</span> Range <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-ipath_suffix"><span class="command">lemma</span></span> ipath_suffix<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath <span class="free">E</span> <span class="free">r</span> <span class="main">⟹</span> ipath <span class="free">E</span> <span class="main">(</span>suffix <span class="free">i</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> suffix_def ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Strongly Connected Components›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A strongly connected component is a maximal mutually connected set 
  of nodes›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_scc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'q</span> digraph <span class="main">⇒</span> <span class="tfree">'q</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_scc</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">×</span><span class="free"><span class="bound"><span class="entity">U</span></span></span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">V</span><span class="main">.</span> <span class="bound">V</span><span class="main">⊃</span><span class="free"><span class="bound"><span class="entity">U</span></span></span> <span class="main">⟶</span> <span class="main">¬</span> <span class="main">(</span><span class="bound">V</span><span class="main">×</span><span class="bound">V</span><span class="main">⊆</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Basic-scc_non_empty"><span class="command">lemma</span></span> scc_non_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_scc <span class="free">E</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-scc_non_empty'"><span class="command">lemma</span></span> scc_non_empty'<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span> <span class="main">⟹</span> <span class="free">U</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Basic-is_scc_closed"><span class="command">lemma</span></span> is_scc_closed<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MEM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">x</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">U</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> SCC MEM P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">y</span> <span class="free">U</span> <span class="main">×</span> insert <span class="free">y</span> <span class="free">U</span> <span class="main">⊆</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_mono mem_Sigma_iff rtrancl_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> disjE1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> in_mono mem_Sigma_iff rtrancl_trans<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">with</span></span> SCC <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-is_scc_connected"><span class="command">lemma</span></span> is_scc_connected<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> MEM<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following, we play around with alternative characterizations, and
  prove them all equivalent .›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A common characterization is to define an equivalence relation 
  ,,mutually connected'' on nodes, and characterize the SCCs as its 
  equivalence classes:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mconn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span>
  <span class="comment1">― ‹Mutually connected relation on nodes›</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mconn</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∩</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">¯</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1" id="Digraph_Basic-mconn_pointwise"><span class="command">lemma</span></span> mconn_pointwise<span class="main">:</span>
   <span class="quoted"><span class="quoted">"mconn <span class="free">E</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mconn_def rtrancl_converse<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mconn›</span></span></span></span> is an equivalence relation:›</span></span>
<span class="keyword1" id="Digraph_Basic-mconn_refl"><span class="command">lemma</span></span> mconn_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Id<span class="main">⊆</span>mconn <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mconn_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_sym"><span class="command">lemma</span></span> mconn_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"mconn <span class="free">E</span> <span class="main">=</span> <span class="main">(</span>mconn <span class="free">E</span><span class="main">)</span><span class="main">¯</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mconn_pointwise<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_trans"><span class="command">lemma</span></span> mconn_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"mconn <span class="free">E</span> <span class="keyword1">O</span> mconn <span class="free">E</span> <span class="main">=</span> mconn <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mconn_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_refl'"><span class="command">lemma</span></span> mconn_refl'<span class="main">:</span> <span class="quoted"><span class="quoted">"refl <span class="main">(</span>mconn <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl_onI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mconn_pointwise<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_sym'"><span class="command">lemma</span></span> mconn_sym'<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>mconn <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mconn_pointwise<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_trans'"><span class="command">lemma</span></span> mconn_trans'<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>mconn <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mconn_def trans_Int trans_rtrancl<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-mconn_equiv"><span class="command">lemma</span></span> mconn_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"equiv UNIV <span class="main">(</span>mconn <span class="free">E</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mconn_refl' mconn_sym' mconn_trans'
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> equivI<span class="main">)</span>


<span class="keyword1" id="Digraph_Basic-is_scc_mconn_eqclasses"><span class="command">lemma</span></span> is_scc_mconn_eqclasses<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span> <span class="main">⟷</span> <span class="free">U</span> <span class="main">∈</span> UNIV <span class="main">//</span> mconn <span class="free">E</span>"</span></span>
  <span class="comment1">― ‹The strongly connected components are the equivalence classes of the 
    mutually-connected relation on nodes›</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">U</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">=</span> mconn <span class="free">E</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A
    <span class="keyword1"><span class="command">unfolding</span></span> mconn_pointwise is_scc_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> A is_scc_closed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> UNIV <span class="main">//</span> mconn <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> quotient_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">∈</span> UNIV <span class="main">//</span> mconn <span class="free">E</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_scc_def mconn_pointwise quotient_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(* For presentation in the paper *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span> <span class="main">⟷</span> <span class="free">U</span> <span class="main">∈</span> UNIV <span class="main">//</span> <span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∩</span> <span class="main">(</span><span class="free">E</span><span class="main">¯</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_mconn_eqclasses mconn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can also restrict the notion of "reachability" to nodes
  inside the SCC
›</span></span>

<span class="keyword1" id="Digraph_Basic-find_outside_node"><span class="command">lemma</span></span> find_outside_node<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∉</span><span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">U</span><span class="main">×</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∈</span><span class="free">U</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">u'</span><span class="main">.</span> <span class="bound">u'</span><span class="main">∉</span><span class="free">U</span> <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">u'</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> IntI mem_Sigma_iff rtrancl.simps<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-is_scc_restrict1"><span class="command">lemma</span></span> is_scc_restrict1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span><span class="main">×</span><span class="free">U</span><span class="main">⊆</span><span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">U</span><span class="main">×</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> find_outside_node<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_scc_closed<span class="main"><span class="main">[</span></span><span class="operator">OF</span> SCC<span class="main"><span class="main">]</span></span> mem_Sigma_iff rtrancl_trans subsetD<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-is_scc_restrict2"><span class="command">lemma</span></span> is_scc_restrict2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span><span class="main">⊃</span><span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">V</span><span class="main">×</span><span class="free">V</span><span class="main">⊆</span><span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">V</span><span class="main">×</span><span class="free">V</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command">using</span></span> rtrancl_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">×</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-is_scc_restrict3"><span class="command">lemma</span></span> is_scc_restrict3<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">(</span><span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">U</span><span class="main">)</span> <span class="main">-</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms is_scc_closed is_scc_connected rtrancl_trans<span class="main">)</span>
  
<span class="keyword1" id="Digraph_Basic-is_scc_alt_restrict_path"><span class="command">lemma</span></span> is_scc_alt_restrict_path<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span> <span class="main">⟷</span> <span class="free">U</span><span class="main">≠</span><span class="main">{}</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">U</span><span class="main">×</span><span class="free">U</span> <span class="main">⊆</span> <span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">U</span><span class="main">×</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="main">(</span><span class="main">(</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span><span class="free">U</span><span class="main">)</span> <span class="main">-</span> <span class="free">U</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="free">U</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_scc_restrict1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> is_scc_restrict3<span class="main">)</span>
  
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> Int_lower1 in_mono mem_Sigma_iff rtrancl_mono_mp<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Basic-is_scc_pointwise"><span class="command">lemma</span></span> is_scc_pointwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">U</span> <span class="main">⟷</span> 
    <span class="free">U</span><span class="main">≠</span><span class="main">{}</span>
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">E</span><span class="main">∩</span><span class="free">U</span><span class="main">×</span><span class="free">U</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> 
  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">∀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">∉</span><span class="free">U</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">u'</span><span class="main">∈</span><span class="free">U</span><span class="main">.</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">u'</span><span class="main">)</span><span class="main">∉</span><span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="comment1">― ‹Alternative, pointwise characterization›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_alt_restrict_path
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>  

<span class="keyword1" id="Digraph_Basic-is_scc_unique"><span class="command">lemma</span></span> is_scc_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SCC<span class="main">:</span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">scc</span>"</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="free">scc'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">scc</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">scc'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">scc</span> <span class="main">=</span> <span class="free">scc'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> SCC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">scc</span> <span class="main">=</span> <span class="free">scc'</span> <span class="main">∨</span> <span class="free">scc</span> <span class="main">∩</span> <span class="free">scc'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> quotient_disj<span class="main">[</span><span class="operator">OF</span> mconn_equiv<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_scc_mconn_eqclasses<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-is_scc_ex1"><span class="command">lemma</span></span> is_scc_ex1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">scc</span><span class="main">.</span> is_scc <span class="free">E</span> <span class="bound">scc</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∈</span> <span class="bound">scc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?scc</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mconn <span class="free">E</span> <span class="main">``</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?scc</span> <span class="main">∈</span> UNIV <span class="main">//</span> mconn <span class="free">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> quotientI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="var">?scc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_scc_mconn_eqclasses<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="var">?scc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mconn_refl'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">scc</span><span class="main">.</span> is_scc <span class="free">E</span> <span class="bound">scc</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∈</span> <span class="bound">scc</span> <span class="main">⟹</span> <span class="bound">scc</span> <span class="main">=</span> <span class="var">?scc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_scc_unique<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Digraph_Basic-is_scc_ex"><span class="command">lemma</span></span> is_scc_ex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">scc</span><span class="main">.</span> is_scc <span class="free">E</span> <span class="bound">scc</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∈</span> <span class="bound">scc</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_scc_ex1<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-is_scc_connected'"><span class="command">lemma</span></span> is_scc_connected'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_scc <span class="free">E</span> <span class="free">scc</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">scc</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">scc</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>Restr <span class="free">E</span> <span class="free">scc</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> is_scc_pointwise
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">scc_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">scc_of</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">scc</span><span class="main">.</span> is_scc <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="bound">scc</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">∈</span> <span class="bound">scc</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Basic-scc_of_is_scc"><span class="command">lemma</span></span> scc_of_is_scc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="main">(</span>scc_of <span class="free">E</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_scc_ex1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> theI' <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scc_of_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-node_in_scc_of_node"><span class="command">lemma</span></span> node_in_scc_of_node<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> scc_of <span class="free">E</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_scc_ex1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">E</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> theI' <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> scc_of_def<span class="main">)</span>

<span class="keyword1" id="Digraph_Basic-scc_of_unique"><span class="command">lemma</span></span> scc_of_unique<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> scc_of <span class="free">E</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"scc_of <span class="free">E</span> <span class="free">v</span> <span class="main">=</span> scc_of <span class="free">E</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="main">(</span>scc_of <span class="free">E</span> <span class="free">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> assms
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_scc <span class="free">E</span> <span class="main">(</span>scc_of <span class="free">E</span> <span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> scc_of <span class="free">E</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_scc_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Digraph">
<div class="head">
<h1>Theory Digraph</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Directed Graphs›</span></span>
<span class="comment1">(* Author: Peter Lammich *)</span>
<span class="keyword1"><span class="command">theory</span></span> Digraph
  <span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../CAVA_Base/CAVA_Base.html">CAVA_Base.CAVA_Base</a>
  <a href="Digraph_Basic.html">Digraph_Basic</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Directed Graphs with Explicit Node Set and Set of Initial Nodes"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'v</span> graph_rec <span class="main">=</span> 
  g_V <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set"</span></span>
  g_E <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> digraph"</span></span>  
  g_V0 <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">graph_restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme <span class="main">⇒</span> <span class="tfree">'v</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">graph_restrict</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span>
  <span class="main">⦇</span>
    g_V <span class="main">=</span> g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span>
    g_E <span class="main">=</span> rel_restrict <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,</span>
    g_V0 <span class="main">=</span> g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> graph_rec.more <span class="free"><span class="bound"><span class="entity">G</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1" id="Digraph-graph_restrict_simps"><span class="command">lemma</span></span> graph_restrict_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"g_V <span class="main">(</span>graph_restrict <span class="free">G</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> g_V <span class="free">G</span>"</span></span>
  <span class="quoted"><span class="quoted">"g_E <span class="main">(</span>graph_restrict <span class="free">G</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> rel_restrict <span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"g_V0 <span class="main">(</span>graph_restrict <span class="free">G</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> g_V0 <span class="free">G</span> <span class="main">-</span> <span class="free">R</span>"</span></span>
  <span class="quoted"><span class="quoted">"graph_rec.more <span class="main">(</span>graph_restrict <span class="free">G</span> <span class="free">R</span><span class="main">)</span> <span class="main">=</span> graph_rec.more <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> graph_restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph-graph_restrict_trivial"><span class="command">lemma</span></span> graph_restrict_trivial<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"graph_restrict <span class="free">G</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">locale</span></span> graph_defs <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">≡</span> g_V <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≡</span> g_E <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">V0</span> <span class="main">≡</span> g_V0 <span class="free">G</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">reachable</span> <span class="main">≡</span> E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> V0"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> E <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Digraph-finite_V0"><span class="command">lemma</span></span> finite_V0<span class="main">:</span> <span class="quoted"><span class="quoted">"finite reachable <span class="main">⟹</span> finite V0"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_run</span>
    <span class="comment1">― ‹Infinite run, i.e., a rooted infinite path›</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_run</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">0</span> <span class="main">∈</span> V0 <span class="main">∧</span> ipath E <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

  <span class="keyword1" id="Digraph-run_ipath"><span class="command">lemma</span></span> run_ipath<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span> <span class="main">⟹</span> ipath E <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Digraph-run_V0"><span class="command">lemma</span></span> run_V0<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> is_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Digraph-run_reachable"><span class="command">lemma</span></span> run_reachable<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span> <span class="main">⟹</span> range <span class="free">r</span> <span class="main">⊆</span> reachable"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_run_def <span class="keyword1"><span class="command">using</span></span> ipath_to_rtrancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> graph <span class="main">=</span>
  graph_defs <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V0_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"V0 <span class="main">⊆</span> V"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> E_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="main">⊆</span> V <span class="main">×</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Digraph-reachable_V"><span class="command">lemma</span></span> reachable_V<span class="main">:</span> <span class="quoted"><span class="quoted">"reachable <span class="main">⊆</span> V"</span></span> <span class="keyword1"><span class="command">using</span></span> V0_ss E_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>

  <span class="keyword1" id="Digraph-finite_E"><span class="command">lemma</span></span> finite_E<span class="main">:</span> <span class="quoted"><span class="quoted">"finite V <span class="main">⟹</span> finite E"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset E_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(* TODO: finite reachability is handled using loose assumptions, while finitely branching
  graphs are captured using a locale. it may be advantageous to unify this. *)</span>
<span class="keyword1"><span class="command">locale</span></span> fb_graph <span class="main">=</span>
  graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_V0<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite V0"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finitely_branching<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> reachable <span class="main">⟹</span> finite <span class="main">(</span>succ <span class="free">v</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Digraph-fb_graph_subset"><span class="command">lemma</span></span> fb_graph_subset<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"g_V <span class="free">G'</span> <span class="main">=</span> V"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"g_E <span class="free">G'</span> <span class="main">⊆</span> E"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V0 <span class="free">G'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"g_V0 <span class="free">G'</span> <span class="main">⊆</span> reachable"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fb_graph <span class="free">G'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_V0 <span class="free">G'</span> <span class="main">⊆</span> g_V <span class="free">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reachable_V assms<span class="main">(</span>1<span class="main">,</span> 4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_E <span class="free">G'</span> <span class="main">⊆</span> g_V <span class="free">G'</span> <span class="main">×</span> g_V <span class="free">G'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> E_ss assms<span class="main">(</span>1<span class="main">,</span> 2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V0 <span class="free">G'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">(</span>g_E <span class="free">G'</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> g_V0 <span class="free">G'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>g_E <span class="free">G'</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> reachable"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rtrancl_mono assms<span class="main">(</span>2<span class="main">,</span> 4<span class="main">)</span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> reachable"</span></span> <span class="keyword1"><span class="command">using</span></span> rtrancl_image_advance_rtrancl 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> 5<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>E <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">have</span></span> 6<span class="main">:</span> <span class="quoted"><span class="quoted">"g_E <span class="free">G'</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="main">⊆</span> E <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_E <span class="free">G'</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset 5 6 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Digraph-fb_graph_restrict"><span class="command">lemma</span></span> fb_graph_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"fb_graph <span class="main">(</span>graph_restrict <span class="free">G</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fb_graph_subset<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rel_restrict_sub<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> fb_graphI_fr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite reachable"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fb_graph <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite V0"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> reachable"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"succ <span class="skolem">v</span> <span class="main">⊆</span> reachable"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Image_singleton_iff rtrancl_image_advance subsetI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>succ <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rename_E</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">u</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">E</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fr_rename_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> 
    g_V <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
    g_E <span class="main">=</span> rename_E <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>   
    g_V0 <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span>g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>
  <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> g_rename_precond <span class="main">=</span>
  graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'u</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ecnv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'u</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> graph_rec_scheme <span class="main">⇒</span> <span class="tfree">'more'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G'</span> <span class="main">≡</span> fr_rename_ext <span class="free">ecnv</span> <span class="free">f</span> <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Digraph-G'_fields"><span class="command">lemma</span></span> G'_fields<span class="main">:</span>
    <span class="quoted"><span class="quoted">"g_V G' <span class="main">=</span> <span class="free">f</span><span class="main">`</span>V"</span></span>
    <span class="quoted"><span class="quoted">"g_V0 G' <span class="main">=</span> <span class="free">f</span><span class="main">`</span>V0"</span></span>
    <span class="quoted"><span class="quoted">"g_E G' <span class="main">=</span> rename_E <span class="free">f</span> E"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fr_rename_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fi</span> <span class="main">≡</span> the_inv_into V <span class="free">f</span>"</span></span>

  <span class="keyword1" id="Digraph-fi_f"><span class="command">lemma</span></span> 
    fi_f<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>V <span class="main">⟹</span> fi <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    f_fi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span>V <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>fi <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    fi_f_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span>V<span class="main">⟧</span> <span class="main">⟹</span> fi <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fi_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_f_f f_the_inv_into_f the_inv_into_f_eq INJ<span class="main">)</span>

  <span class="keyword1" id="Digraph-E'_to_E"><span class="command">lemma</span></span> E'_to_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span> <span class="main">∈</span> g_E G' <span class="main">⟹</span> <span class="main">(</span>fi <span class="free">u</span><span class="main">,</span> fi <span class="free">v</span><span class="main">)</span><span class="main">∈</span>E"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E_ss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fi_f G'_fields<span class="main">)</span>

  <span class="keyword1" id="Digraph-V0'_to_V0"><span class="command">lemma</span></span> V0'_to_V0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span>g_V0 G' <span class="main">⟹</span> fi <span class="free">v</span> <span class="main">∈</span> V0"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V0_ss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fi_f G'_fields<span class="main">)</span>


  <span class="keyword1" id="Digraph-rtrancl_E'_sim"><span class="command">lemma</span></span> rtrancl_E'_sim<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="free">u</span><span class="main">,</span><span class="free">v'</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>g_E G'<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span><span class="main">∈</span>V"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="free">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span><span class="main">∈</span>V <span class="main">∧</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">u</span>"</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>rtrancl_into_rtrancl <span class="skolem">v'</span> <span class="skolem">w'</span> <span class="skolem">u</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span><span class="main">∈</span>E"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>V"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>V"</span></span> <span class="keyword1"><span class="command">using</span></span> E_ss <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rtrancl_into_rtrancl <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">vv</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span><span class="main">∈</span>V"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">vv</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">v</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>V›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">vv</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">vv</span><span class="main">∈</span>V›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">vv</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> INJ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inj_on_contraD<span class="main">)</span>

    <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">vv</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>›</span></span><span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">v</span><span class="main">,</span><span class="skolem">w</span><span class="main">)</span><span class="main">∈</span>E›</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w'</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">w</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">w</span><span class="main">∈</span>V›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
    
  <span class="keyword1" id="Digraph-rtrancl_E'_to_E"><span class="command">lemma</span></span> rtrancl_E'_to_E<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>g_E G'<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fi <span class="free">u</span><span class="main">,</span> fi <span class="free">v</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">induction</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> E'_to_E rtrancl_into_rtrancl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

  <span class="keyword1" id="Digraph-G'_invar"><span class="command">lemma</span></span> G'_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"graph G'"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_V0 G' <span class="main">⊆</span> g_V G'"</span></span>
      <span class="keyword1"><span class="command">using</span></span> V0_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_E G' <span class="main">⊆</span> g_V G' <span class="main">×</span> g_V G'"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> G'<span class="main">:</span> graph <span class="quoted">G'</span> <span class="keyword1"><span class="command">using</span></span> G'_invar <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Digraph-G'_finite_reachable"><span class="command">lemma</span></span> G'_finite_reachable<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E G'<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 G'<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>g_E G'<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 G' <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span>V0<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> rtrancl_E'_sim<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> V0_ss <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Digraph-V'_to_V"><span class="command">lemma</span></span> V'_to_V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> G'.V <span class="main">⟹</span> fi <span class="free">v</span> <span class="main">∈</span> V"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fi_f G'_fields<span class="main">)</span>

  <span class="keyword1" id="Digraph-ipath_sim1"><span class="command">lemma</span></span> ipath_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath E <span class="free">r</span> <span class="main">⟹</span> ipath G'.E <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span>

  <span class="keyword1" id="Digraph-ipath_sim2"><span class="command">lemma</span></span> ipath_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath G'.E <span class="free">r</span> <span class="main">⟹</span> ipath E <span class="main">(</span>fi <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> ipath_def 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="improper">i</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> E_ss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fi_f<span class="main">)</span>

  <span class="keyword1" id="Digraph-run_sim1"><span class="command">lemma</span></span> run_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span> <span class="main">⟹</span> G'.is_run <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_run_def G'.is_run_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_fields<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_sim1<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Digraph-run_sim2"><span class="command">lemma</span></span> run_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"G'.is_run <span class="free">r</span> <span class="main">⟹</span> is_run <span class="main">(</span>fi <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_run_def G'.is_run_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_sim2 V0'_to_V0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Automata">
<div class="head">
<h1>Theory Automata</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Automata›</span></span>
<span class="comment1">(* Author: Peter Lammich *)</span>
<span class="keyword1"><span class="command">theory</span></span> Automata
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Digraph.html">Digraph</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
    In this theory, we define Generalized Buchi Automata and Buchi Automata 
    based on directed graphs
›</span></span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> prod
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Generalized Buchi Graphs"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A generalized Buchi graph is a graph where each node belongs to a set of
  acceptance classes. An infinite run on this graph is accepted, iff
  it visits nodes from each acceptance class infinitely often.

  The standard encoding of acceptance classes is as a set of sets of nodes,
  each inner set representing one acceptance class.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'Q</span> gb_graph_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> graph_rec"</span></span> <span class="main">+</span>
  gbg_F <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> set set"</span></span>


<span class="keyword1"><span class="command">locale</span></span> gb_graph <span class="main">=</span>
  graph <span class="quoted"><span class="free">G</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> gb_graph_rec_scheme"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_F<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main"><span class="main">!</span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>gbg_F <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"gbg_F <span class="free">G</span> <span class="main">⊆</span> Pow V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> gbg_F <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_gb_graph"><span class="command">lemma</span></span> is_gb_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"gb_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


  <span class="keyword1"><span class="command">definition</span></span> 
    <span class="entity">is_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc_run</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> is_run <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> is_acc <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

  <span class="comment1">(* For presentation in paper *)</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span> <span class="main">≡</span> is_run <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def is_acc_def <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Automata-acc_run_run"><span class="command">lemma</span></span> acc_run_run<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span> <span class="main">⟹</span> is_run <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">lemmas</span></span> acc_run_reachable <span class="main">=</span> run_reachable<span class="main">[</span><span class="operator">OF</span> acc_run_run<span class="main">]</span>


  <span class="keyword1" id="Automata-acc_eq_limit"><span class="command">lemma</span></span> acc_eq_limit<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> limit_inter_INF<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FIN <span class="keyword1"><span class="command">have</span></span> FIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> finite <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> range <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> AUX<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> range <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> range <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> bspec<span class="main"><span class="main">[</span></span><span class="operator">OF</span> AUX<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> fin_ex_inf_eq_limit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FIN'<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-is_acc_run_limit_alt"><span class="command">lemma</span></span> is_acc_run_limit_alt<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> V0<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span> <span class="main">⟷</span> is_run <span class="free">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms acc_eq_limit<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> run_reachable finite_subset<span class="main">)</span>

  <span class="keyword1" id="Automata-is_acc_suffix"><span class="command">lemma</span></span> is_acc_suffix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc <span class="main">(</span>suffix <span class="free">i</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> is_acc <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def suffix_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> trans_less_add2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_lessD1 less_imp_add_positive nat_add_left_cancel_less<span class="main">)</span>

  <span class="keyword1" id="Automata-finite_V_Fe"><span class="command">lemma</span></span> finite_V_Fe<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite V"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> F"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pow_iff infinite_super rev_subsetD F_ss<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gb_rename_ecnv</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
  gbg_F <span class="main">=</span> <span class="main">{</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>gbg_F <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">}</span><span class="main">,</span> <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>
<span class="main">⦈</span>"</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gb_rename_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> fr_rename_ext <span class="main">(</span>gb_rename_ecnv <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>


<span class="keyword1"><span class="command">locale</span></span> gb_rename_precond <span class="main">=</span>
  gb_graph <span class="quoted"><span class="free">G</span></span> <span class="main">+</span>
  g_rename_precond <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"gb_rename_ecnv <span class="free">ecnv</span> <span class="free">f</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'u</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> gb_graph_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ecnv</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Automata-G'_gb_fields"><span class="command">lemma</span></span> G'_gb_fields<span class="main">:</span> <span class="quoted"><span class="quoted">"gbg_F G' <span class="main">=</span> <span class="main">{</span> <span class="free">f</span><span class="main">`</span><span class="bound">A</span> <span class="main">|</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span>F <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gb_rename_ecnv_def fr_rename_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">sublocale</span></span> G'<span class="main">:</span> gb_graph <span class="quoted">G'</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G'_fields G'_gb_fields<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> F_ss 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Automata-acc_sim1"><span class="command">lemma</span></span> acc_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span> <span class="main">⟹</span> G'.is_acc <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def G'.is_acc_def G'_gb_fields
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> imageI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>

  <span class="keyword1" id="Automata-acc_sim2"><span class="command">lemma</span></span> acc_sim2<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"G'.is_acc <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="main">(</span>fi <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> gbg_F <span class="free">G</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="bound">m</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="bound">A</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G'.is_acc_def G'_gb_fields
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>

    <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">m</span> 
      <span class="keyword3"><span class="command">assume</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> gbg_F <span class="free">G</span>"</span></span>  
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span><span class="main">&gt;</span><span class="skolem">m</span><span class="main">.</span> fi <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F_ss
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pow_iff 2 fi_f in_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-acc_run_sim1"><span class="command">lemma</span></span> acc_run_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span> <span class="main">⟹</span> G'.is_acc_run <span class="main">(</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> acc_sim1 run_sim1 <span class="keyword1"><span class="command">unfolding</span></span> G'.is_acc_run_def is_acc_run_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Automata-acc_run_sim2"><span class="command">lemma</span></span> acc_run_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"G'.is_acc_run <span class="free">r</span> <span class="main">⟹</span> is_acc_run <span class="main">(</span>fi <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> acc_sim2 run_sim2 <span class="keyword1"><span class="command">unfolding</span></span> G'.is_acc_run_def is_acc_run_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Generalized Buchi Automata"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A GBA is obtained from a GBG by adding a labeling function, that associates
  each state with a set of labels. A word is accepted if there is an
  accepting run that can be labeld with this word.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">)</span> gba_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> gb_graph_rec"</span></span> <span class="main">+</span>
  gba_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> <span class="tfree">'L</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">locale</span></span> gba <span class="main">=</span>
  gb_graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> gba_rec_scheme"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"gba_L <span class="free">G</span> <span class="free">q</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≡</span> gba_L <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_gba"><span class="command">lemma</span></span> is_gba<span class="main">:</span> <span class="quoted"><span class="quoted">"gba <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> is_acc_run <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1" id="Automata-acceptI"><span class="command">lemma</span></span> acceptI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_acc_run <span class="free">r</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="bound">i</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> accept <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> accept_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">≡</span> Collect <span class="main">(</span>accept<span class="main">)</span>"</span></span>
  <span class="keyword1" id="Automata-langI"><span class="command">lemma</span></span> langI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"accept <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">∈</span>lang"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_def<span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_rename_ecnv</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
  gba_L <span class="main">=</span> <span class="main">λ</span><span class="bound">q</span> <span class="bound">l</span><span class="main">.</span> 
    <span class="keyword1">if</span> <span class="bound">q</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="keyword1">then</span> 
      gba_L <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">(</span>the_inv_into <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">q</span><span class="main">)</span> <span class="bound">l</span>
    <span class="keyword1">else</span>
      False<span class="main">,</span> 
  <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span>
<span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_rename_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> gb_rename_ext <span class="main">(</span>gba_rename_ecnv <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> gba_rename_precond <span class="main">=</span>  
  gb_rename_precond <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"gba_rename_ecnv <span class="free">ecnv</span> <span class="free">f</span>"</span></span> <span class="main">+</span> gba <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'u</span><span class="main">,</span><span class="tfree">'L</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> gba_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'u</span> <span class="main">⇒</span> <span class="tfree">'v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ecnv</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1" id="Automata-G'_gba_fields"><span class="command">lemma</span></span> G'_gba_fields<span class="main">:</span> <span class="quoted"><span class="quoted">"gba_L G' <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="bound">l</span><span class="main">.</span> 
    <span class="keyword1">if</span> <span class="bound">q</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span>V <span class="keyword1">then</span> L <span class="main">(</span>fi <span class="bound">q</span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">else</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gb_rename_ecnv_def gba_rename_ecnv_def fr_rename_ext_def fi_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">sublocale</span></span> G'<span class="main">:</span> gba <span class="quoted">G'</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G'_gba_fields G'_fields <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-L_sim1"><span class="command">lemma</span></span> L_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>range <span class="free">r</span> <span class="main">⊆</span> V<span class="main">;</span> L <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="free">l</span><span class="main">⟧</span> <span class="main">⟹</span> G'.L <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_gba_fields fi_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fi_f 
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rangeI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1" id="Automata-L_sim2"><span class="command">lemma</span></span> L_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> range <span class="free">r</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span>V<span class="main">;</span> G'.L <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="free">l</span> <span class="main">⟧</span> <span class="main">⟹</span> L <span class="main">(</span>fi <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> G'_gba_fields fi_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> f_fi
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> rev_subsetD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rangeI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    
  <span class="keyword1" id="Automata-accept_eq"><span class="command">lemma</span></span> accept_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G'.accept <span class="main">=</span> accept"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept_def G'.accept_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"G'.is_acc_run <span class="skolem">r</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> G'.L <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> RAN<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="skolem">r</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span>V"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G'.run_reachable<span class="main">[</span><span class="operator">OF</span> G'.acc_run_run<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span><span class="main">]</span> G'.reachable_V
      <span class="keyword1"><span class="command">unfolding</span></span> G'_fields
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> L <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> is_acc_run <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> acc_run_sim2<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> L_sim2<span class="main">[</span><span class="operator">OF</span> RAN<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="skolem">r</span>"</span></span> 
    <span class="keyword3"><span class="command">assume</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="skolem">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> RAN<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="skolem">r</span> <span class="main">⊆</span> V"</span></span>
      <span class="keyword1"><span class="command">using</span></span> run_reachable<span class="main">[</span><span class="operator">OF</span> acc_run_run<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span><span class="main">]</span> reachable_V <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      
    <span class="keyword1"><span class="command">from</span></span> L <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r</span><span class="main">.</span> 
        G'.is_acc_run <span class="bound">r</span> 
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> G'.L <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="skolem">w</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> acc_run_sim1<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> L_sim1<span class="main">[</span><span class="operator">OF</span> RAN<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-lang_eq"><span class="command">lemma</span></span> lang_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"G'.lang <span class="main">=</span> lang"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> G'.lang_def lang_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Automata-finite_G'_V"><span class="command">lemma</span></span> finite_G'_V<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite V"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite G'.V"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> G'_gba_fields G'_fields <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_rename</span> <span class="main">≡</span> gba_rename_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Automata-gba_rename_correct"><span class="command">lemma</span></span> gba_rename_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> gba_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gba <span class="free">G</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span>g_V <span class="free">G</span><span class="main">)</span>"</span></span> 
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">G'</span> <span class="main">≡</span> gba_rename <span class="free">f</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gba <span class="free">G'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>g_V <span class="free">G'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gba.accept <span class="free">G'</span> <span class="main">=</span> gba.accept <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"gba.lang <span class="free">G'</span> <span class="main">=</span> gba.lang <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> G'_def
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gba_rename <span class="free">f</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> gba <span class="quoted"><span class="free">G</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  
  <span class="keyword1"><span class="command">from</span></span> INJ <span class="keyword1"><span class="command">interpret</span></span> gba_rename_precond <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp_all</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gba <span class="var">?G'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> G'.is_gba<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>g_V <span class="free">G</span><span class="main">)</span> <span class="main">⟹</span> finite <span class="main">(</span>g_V <span class="var">?G'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> finite_G'_V<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"G'.accept <span class="main">=</span> accept"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"G'.lang <span class="main">=</span> lang"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Buchi Graphs"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A Buchi graph has exactly one acceptance class›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'Q</span> b_graph_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> graph_rec"</span></span> <span class="main">+</span>
  bg_F <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> b_graph <span class="main">=</span>
  graph <span class="quoted"><span class="free">G</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> b_graph_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"bg_F <span class="free">G</span> <span class="main">⊆</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">F</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> bg_F <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_b_graph"><span class="command">lemma</span></span> is_b_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gbg_ext</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> 
    <span class="main">≡</span> <span class="main">⦇</span> g_V <span class="main">=</span> V<span class="main">,</span> 
        g_E<span class="main">=</span>E<span class="main">,</span> 
        g_V0<span class="main">=</span>V0<span class="main">,</span> 
        gbg_F <span class="main">=</span> <span class="keyword1">if</span> F<span class="main">=</span>UNIV <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span>F<span class="main">}</span><span class="main">,</span> 
        <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gbg</span> <span class="main">≡</span> to_gbg_ext <span class="main">()</span>"</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> gbg<span class="main">:</span> gb_graph <span class="quoted"><span class="quoted">"to_gbg_ext <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span> 
    <span class="keyword1"><span class="command">using</span></span> V0_ss E_ss F_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> word <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span> <span class="main">∈</span> F<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_acc_run</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc_run</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> is_run <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> is_acc <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

  <span class="keyword1" id="Automata-to_gbg_alt"><span class="command">lemma</span></span> to_gbg_alt<span class="main">:</span>
    <span class="quoted"><span class="quoted">"gbg.V <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> V"</span></span>
    <span class="quoted"><span class="quoted">"gbg.E <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> E"</span></span>
    <span class="quoted"><span class="quoted">"gbg.V0 <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> V0"</span></span>
    <span class="quoted"><span class="quoted">"gbg.F <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> F<span class="main">=</span>UNIV <span class="keyword1">then</span> <span class="main">{}</span> <span class="keyword1">else</span> <span class="main">{</span>F<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"gbg.is_run <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_run"</span></span>
    <span class="quoted"><span class="quoted">"gbg.is_acc <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_acc"</span></span>
    <span class="quoted"><span class="quoted">"gbg.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_acc_run"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      is_acc_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_acc_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Buchi Automata"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Buchi automata are labeled Buchi graphs›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">)</span> ba_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> b_graph_rec"</span></span> <span class="main">+</span>
  ba_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> <span class="tfree">'L</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">locale</span></span> ba <span class="main">=</span>
  bg<span class="main">?</span><span class="main">:</span> b_graph <span class="quoted"><span class="free">G</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> ba_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"ba_L <span class="free">G</span> <span class="free">q</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">L</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">==</span> ba_L <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_ba"><span class="command">lemma</span></span> is_ba<span class="main">:</span> <span class="quoted"><span class="quoted">"ba <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gba_ext</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> to_gbg_ext <span class="main">⦇</span> gba_L <span class="main">=</span> L<span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gba</span> <span class="main">≡</span> to_gba_ext <span class="main">()</span>"</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> gba<span class="main">:</span> gba <span class="quoted"><span class="quoted">"to_gba_ext <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">unfolding</span></span> to_gbg_ext_def
    <span class="keyword1"><span class="command">using</span></span> L_ss <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-ba_acc_simps"><span class="command">lemma</span></span> ba_acc_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gba.L <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> L"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> is_acc_run <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">≡</span> Collect accept"</span></span>

  <span class="keyword1" id="Automata-to_gba_alt_accept"><span class="command">lemma</span></span> to_gba_alt_accept<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gba.accept <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> accept"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept_def gba.accept_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_alt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-to_gba_alt_lang"><span class="command">lemma</span></span> to_gba_alt_lang<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gba.lang <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> lang"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_def gba.lang_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gba_alt_accept<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> to_gba_alt <span class="main">=</span> to_gbg_alt to_gba_alt_accept to_gba_alt_lang
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Indexed acceptance classes"</span></span>
<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'Q</span> igb_graph_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> graph_rec"</span></span> <span class="main">+</span>
  igbg_num_acc <span class="main">::</span> <span class="quoted">nat</span>
  igbg_acc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> nat set"</span></span>

<span class="keyword1"><span class="command">locale</span></span> igb_graph <span class="main">=</span> 
  graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> igb_graph_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> acc_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span>range <span class="main">(</span>igbg_acc <span class="free">G</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="main">(</span>igbg_num_acc <span class="free">G</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> acc_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"igbg_acc <span class="free">G</span> <span class="free">q</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">q</span><span class="main">∈</span>V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">num_acc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">num_acc</span> <span class="main">≡</span> igbg_num_acc <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">acc</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="main">≡</span> igbg_acc <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_igb_graph"><span class="command">lemma</span></span> is_igb_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


  <span class="keyword1" id="Automata-acc_boundI"><span class="command">lemma</span></span> acc_boundI<span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span>acc <span class="free">q</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">&lt;</span>num_acc"</span></span>
    <span class="keyword1"><span class="command">using</span></span> acc_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">accn</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">q</span> <span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">∈</span>acc <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> <span class="main">{</span> accn <span class="bound">i</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>num_acc <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gbg_ext</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> 
    <span class="main">≡</span> <span class="main">⦇</span> g_V <span class="main">=</span> V<span class="main">,</span> g_E <span class="main">=</span> E<span class="main">,</span> g_V0 <span class="main">=</span> V0<span class="main">,</span> gbg_F <span class="main">=</span> F<span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> gbg<span class="main">:</span> gb_graph <span class="quoted"><span class="quoted">"to_gbg_ext <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> V0_ss E_ss acc_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def F_def accn_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-to_gbg_alt1"><span class="command">lemma</span></span> to_gbg_alt1<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gbg.E <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> E"</span></span>
    <span class="quoted"><span class="quoted">"gbg.V0 <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> V0"</span></span>
    <span class="quoted"><span class="quoted">"gbg.F <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> F"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>

  <span class="keyword1" id="Automata-F_fin"><span class="command">lemma</span></span> F_fin<span class="main">[</span><span class="operator">simp</span><span class="main">,</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">!</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite F"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> F_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> word <span class="main">⇒</span> bool"</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_acc_run</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> is_run <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> is_acc <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

  <span class="keyword1" id="Automata-is_run_gbg"><span class="command">lemma</span></span> is_run_gbg<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gbg.is_run <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_run"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
      gbg.is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>

  <span class="keyword1" id="Automata-is_acc_gbg"><span class="command">lemma</span></span> is_acc_gbg<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gbg.is_acc <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_acc"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gbg.is_acc_def is_acc_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_alt1 is_run_gbg<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> F_def accn_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INFM_mono<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-is_acc_run_gbg"><span class="command">lemma</span></span> is_acc_run_gbg<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"gbg.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_acc_run"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> gbg.is_acc_run_def is_acc_run_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_alt1 is_run_gbg is_acc_gbg<span class="main">)</span>

  <span class="keyword1"><span class="command">lemmas</span></span> to_gbg_alt <span class="main">=</span> to_gbg_alt1 is_run_gbg is_acc_gbg is_acc_run_gbg

  <span class="keyword1" id="Automata-acc_limit_alt"><span class="command">lemma</span></span> acc_limit_alt<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> accn <span class="bound">n</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> accn <span class="bound">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def accn_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> limit_inter_INF<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> FIN <span class="keyword1"><span class="command">have</span></span> FIN'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> finite <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> range <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"is_acc <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="main">(</span>accn <span class="bound">n</span> <span class="main">∩</span> range <span class="free">r</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_def accn_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fin_ex_inf_eq_limit<span class="main"><span class="main">[</span></span><span class="operator">OF</span> FIN'<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> accn <span class="bound">n</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-acc_limit_alt'"><span class="command">lemma</span></span> acc_limit_alt'<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> is_acc <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>acc <span class="main">`</span> limit <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>num_acc<span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> acc_limit_alt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> accn_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">)</span> igba_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> igb_graph_rec"</span></span> <span class="main">+</span>
  igba_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> <span class="tfree">'L</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword1"><span class="command">locale</span></span> igba <span class="main">=</span>
  igbg<span class="main">?</span><span class="main">:</span> igb_graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">,</span><span class="tfree">'more</span><span class="main">)</span> igba_rec_scheme"</span></span>
  <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> L_ss<span class="main">:</span> <span class="quoted"><span class="quoted">"igba_L <span class="free">G</span> <span class="free">q</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">∈</span> V"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">L</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≡</span> igba_L <span class="free">G</span>"</span></span>

  <span class="keyword1" id="Automata-is_igba"><span class="command">lemma</span></span> is_igba<span class="main">:</span> <span class="quoted"><span class="quoted">"igba <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>


  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">to_gba_ext</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≡</span> to_gbg_ext <span class="main">⦇</span> gba_L <span class="main">=</span> igba_L <span class="free">G</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> gba<span class="main">:</span> gba <span class="quoted"><span class="quoted">"to_gba_ext <span class="free">m</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">unfolding</span></span> to_gbg_ext_def
    <span class="keyword1"><span class="command">using</span></span> L_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Automata-to_gba_alt_L"><span class="command">lemma</span></span> to_gba_alt_L<span class="main">:</span>
    <span class="quoted"><span class="quoted">"gba.L <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> L"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> is_acc_run <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> L <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">≡</span> Collect accept"</span></span>

  <span class="keyword1" id="Automata-accept_gba_alt"><span class="command">lemma</span></span> accept_gba_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.accept <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> accept"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> accept_def gba.accept_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_alt to_gba_alt_L<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-lang_gba_alt"><span class="command">lemma</span></span> lang_gba_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"gba.lang <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> lang"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lang_def gba.lang_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> accept_gba_alt<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> to_gba_alt <span class="main">=</span> to_gbg_alt to_gba_alt_L accept_gba_alt lang_gba_alt

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Indexing Conversion›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">F_to_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> set set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'Q</span> <span class="main">⇒</span> nat set<span class="main">)</span><span class="main">)</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_to_idx</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">Flist</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">Flist</span><span class="main">.</span> distinct <span class="bound">Flist</span> <span class="main">∧</span> set <span class="bound">Flist</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">num_acc</span> <span class="main">=</span> length <span class="bound">Flist</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">acc</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">num_acc</span> <span class="main">∧</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">Flist</span><span class="main">!</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">num_acc</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata-F_to_idx_correct"><span class="command">lemma</span></span> F_to_idx_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"F_to_idx <span class="free">F</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">num_acc</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">.</span> <span class="free">F</span> <span class="main">=</span> <span class="main">{</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="bound">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">|</span> <span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span><span class="bound">num_acc</span> <span class="main">}</span> 
    <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span>range <span class="bound">acc</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">num_acc</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> F_to_idx_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sym<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> t<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">F</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> equalityI subsetI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mk_acc_impl</span> <span class="free"><span class="bound"><span class="entity">Flist</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="keyword1">let</span> <span class="bound">acc</span> <span class="main">=</span> Map.empty<span class="main">;</span>

  <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span> <span class="main">←</span> nfoldli <span class="free"><span class="bound"><span class="entity">Flist</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">A</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">acc</span> <span class="main">←</span> FOREACHi <span class="main">(</span><span class="main">λ</span><span class="bound">it</span> <span class="bound">acc'</span><span class="main">.</span> 
      <span class="bound">acc'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> 
        <span class="keyword1">if</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">A</span><span class="main">-</span><span class="bound">it</span> <span class="keyword1">then</span> 
          Some <span class="main">(</span>insert <span class="bound">i</span> <span class="main">(</span>the_default <span class="main">{}</span> <span class="main">(</span><span class="bound">acc</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> 
        <span class="keyword1">else</span> 
          <span class="bound">acc</span> <span class="bound">v</span>
      <span class="main">)</span>
    <span class="main">)</span> 
      <span class="bound">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span> <span class="bound">acc</span><span class="main">.</span> RETURN <span class="main">(</span><span class="bound">acc</span><span class="main">(</span><span class="bound">v</span><span class="main">↦</span>insert <span class="bound">i</span> <span class="main">(</span>the_default <span class="main">{}</span> <span class="main">(</span><span class="bound">acc</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">acc</span><span class="main">;</span>
    RETURN <span class="main">(</span>Suc <span class="bound">i</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span>
  <span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">;</span>
  RETURN <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> the_default <span class="main">{}</span> <span class="main">(</span><span class="bound">acc</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
<span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata-mk_acc_impl_correct"><span class="command">lemma</span></span> mk_acc_impl_correct<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Flist'</span><span class="main">,</span><span class="free">Flist</span><span class="main">)</span><span class="main">∈</span>Id"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="free">Flist</span><span class="main">.</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mk_acc_impl <span class="free">Flist'</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>RETURN <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span> <span class="main">.</span> <span class="bound">i</span><span class="main">&lt;</span>length <span class="free">Flist</span> <span class="main">∧</span> <span class="bound">v</span><span class="main">∈</span><span class="free">Flist</span><span class="main">!</span><span class="bound">i</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mk_acc_impl_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> 
    nfoldli_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
      I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">l1</span> <span class="bound">l2</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">res</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span>length <span class="bound">l1</span> 
        <span class="main">∧</span> the_default <span class="main">{}</span> <span class="keyword1">o</span> <span class="bound">res</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">j</span> <span class="main">.</span> <span class="bound">j</span><span class="main">&lt;</span><span class="bound">i</span> <span class="main">∧</span> <span class="bound">v</span><span class="main">∈</span><span class="free">Flist</span><span class="main">!</span><span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="main"><span class="main">]</span></span>
    <span class="dynamic"><span class="dynamic">refine_vcg</span></span> 
  <span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> FIN <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append nth_Cons'<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append nth_Cons' 
    fun_comp_eq_conv<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_comp_eq_conv<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">F_to_idx_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> set set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="main">(</span><span class="tfree">'Q</span> <span class="main">⇒</span> nat set<span class="main">)</span><span class="main">)</span> nres"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">F_to_idx_impl</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    <span class="bound">Flist</span> <span class="main">←</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">Flist</span><span class="main">.</span> distinct <span class="bound">Flist</span> <span class="main">∧</span> set <span class="bound">Flist</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">num_acc</span> <span class="main">=</span> length <span class="bound">Flist</span><span class="main">;</span>
    <span class="bound">acc</span> <span class="main">←</span> mk_acc_impl <span class="bound">Flist</span><span class="main">;</span>
    RETURN <span class="main">(</span><span class="bound">num_acc</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata-F_to_idx_refine"><span class="command">lemma</span></span> F_to_idx_refine<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"F_to_idx_impl <span class="free">F</span> <span class="main">≤</span> <span class="main">⇓</span>Id <span class="main">(</span>F_to_idx <span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> F_to_idx_impl_def F_to_idx_def

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> bind_Let_refine2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> mk_acc_impl_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gbg_to_idx_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> gb_graph_rec_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'more'</span><span class="main">)</span> igb_graph_rec_scheme nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gbg_to_idx_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">=</span> <span class="keyword1">do</span> <span class="main">{</span>
  <span class="main">(</span><span class="bound">num_acc</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span> <span class="main">←</span> F_to_idx_impl <span class="main">(</span>gbg_F <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">;</span> 
  RETURN <span class="main">⦇</span> 
    g_V <span class="main">=</span> g_V <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span>
    g_E <span class="main">=</span> g_E <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> 
    g_V0<span class="main">=</span>g_V0 <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> 
    igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> 
    igbg_acc <span class="main">=</span> <span class="bound">acc</span><span class="main">,</span>
    <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>
  <span class="main">⦈</span>
<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gb_graph<span class="main">)</span> gbg_to_idx_ext_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> F <span class="main">⟹</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gbg_to_idx_ext <span class="free">ecnv</span> <span class="free">G</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G'</span><span class="main">.</span> 
    igb_graph.is_acc_run <span class="bound">G'</span> <span class="main">=</span> is_acc_run 
  <span class="main">∧</span> g_V <span class="bound">G'</span> <span class="main">=</span> V
  <span class="main">∧</span> g_E <span class="bound">G'</span> <span class="main">=</span> E
  <span class="main">∧</span> g_V0 <span class="bound">G'</span> <span class="main">=</span> V0
  <span class="main">∧</span> igb_graph_rec.more <span class="bound">G'</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>
  <span class="main">∧</span> igb_graph <span class="bound">G'</span>
<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> F_to_idx_refine<span class="main">[</span><span class="operator">of</span> <span class="quoted">F</span><span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> F_to_idx_correct
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"F_to_idx_impl F
    <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">num_acc</span><span class="main">,</span> <span class="bound">acc</span><span class="main">)</span><span class="main">.</span> F <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="bound">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="bound">num_acc</span><span class="main">}</span>
      <span class="main">∧</span> <span class="main">⋃</span><span class="main">(</span>range <span class="bound">acc</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="bound">num_acc</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">have</span></span> eq_conjI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span><span class="main">.</span> <span class="main">(</span><span class="bound">b</span><span class="main">⟷</span><span class="bound">c</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">a</span><span class="main">&amp;</span><span class="bound">b</span> <span class="main">⟷</span> <span class="bound">a</span><span class="main">&amp;</span><span class="bound">c</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">num_acc</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">num_acc</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span>limit <span class="skolem">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="skolem">num_acc</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>limit <span class="skolem">r</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="skolem">acc</span> <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux1<span class="main">=</span>this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">num_acc</span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> FE<span class="main">:</span> <span class="quoted"><span class="quoted">"F <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> INR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">num_acc</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> FE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> INR <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux2<span class="main">=</span>this

  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">num_acc</span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> FE<span class="main">:</span> <span class="quoted"><span class="quoted">"F <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> INR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">acc</span> <span class="skolem">q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span><span class="skolem">acc</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> INR <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span><span class="skolem">num_acc</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span><span class="main">⋃</span>F"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> FE<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> F_ss <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span>V"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux3<span class="main">=</span>this

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> gbg_to_idx_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span> <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">clarsimp_all</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">acc</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">num_acc</span> <span class="main">::</span> <span class="quoted">nat</span>
    <span class="keyword3"><span class="command">assume</span></span> FE<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"F <span class="main">=</span> <span class="main">{</span><span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">acc</span> <span class="bound">q</span><span class="main">}</span> <span class="main">|</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> BOUND<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">acc</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="skolem">num_acc</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">⦇</span>
      g_V <span class="main">=</span> V<span class="main">,</span> 
      g_E <span class="main">=</span> E<span class="main">,</span> 
      g_V0 <span class="main">=</span> V0<span class="main">,</span> 
      igbg_num_acc <span class="main">=</span> <span class="skolem">num_acc</span><span class="main">,</span> 
      igbg_acc <span class="main">=</span> <span class="skolem">acc</span><span class="main">,</span>
      <span class="main">…</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span><span class="main">⦈</span>"</span></span>

    <span class="keyword1"><span class="command">interpret</span></span> G'<span class="main">:</span> igb_graph <span class="var"><span class="quoted"><span class="var">?G'</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> V0_ss E_ss 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> aux2 aux3 BOUND<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"igb_graph <span class="var">?G'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"G'.is_acc_run <span class="main">=</span> is_acc_run"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> G'.is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_acc_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> 
        G'.is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_run_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
        G'.is_acc_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_acc_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext eq_conjI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> INFM_mono mem_Collect_eq<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gbg_to_idx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> gb_graph_rec_scheme <span class="main">⇒</span> <span class="tfree">'q</span> igb_graph_rec nres"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gbg_to_idx</span> <span class="main">≡</span> gbg_to_idx_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ti_Lcnv</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ti_Lcnv</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⦇</span> igba_L <span class="main">=</span> gba_L <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_to_idx_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="main">≡</span> gbg_to_idx_ext <span class="main">(</span>ti_Lcnv <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_to_idx</span> <span class="main">≡</span> gba_to_idx_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gba<span class="main">)</span> gba_to_idx_ext_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> F <span class="main">⟹</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gba_to_idx_ext <span class="free">ecnv</span> <span class="free">G</span> <span class="main">≤</span> 
    SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G'</span><span class="main">.</span>
    igba.accept <span class="bound">G'</span> <span class="main">=</span> accept 
  <span class="main">∧</span> g_V <span class="bound">G'</span> <span class="main">=</span> V
  <span class="main">∧</span> g_E <span class="bound">G'</span> <span class="main">=</span> E
  <span class="main">∧</span> g_V0 <span class="bound">G'</span> <span class="main">=</span> V0
  <span class="main">∧</span> igba_rec.more <span class="bound">G'</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>
  <span class="main">∧</span> igba <span class="bound">G'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gbg_to_idx_ext_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_rule<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> conjI<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">G'</span>
  <span class="keyword3"><span class="command">assume</span></span> 
    ARUN<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph.is_acc_run <span class="skolem">G'</span> <span class="main">=</span> is_acc_run"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> MORE<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph_rec.more <span class="skolem">G'</span> <span class="main">=</span> ti_Lcnv <span class="free">ecnv</span> <span class="free">G</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> LOC<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph <span class="skolem">G'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> FIELDS<span class="main">:</span> <span class="quoted"><span class="quoted">"g_V <span class="skolem">G'</span> <span class="main">=</span> V"</span></span> <span class="quoted"><span class="quoted">"g_E <span class="skolem">G'</span> <span class="main">=</span> E"</span></span> <span class="quoted"><span class="quoted">"g_V0 <span class="skolem">G'</span> <span class="main">=</span> V0"</span></span>
  
  <span class="keyword1"><span class="command">from</span></span> LOC <span class="keyword1"><span class="command">interpret</span></span> igb<span class="main">:</span> igb_graph <span class="quoted"><span class="skolem">G'</span></span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">interpret</span></span> igb<span class="main">:</span> igba <span class="quoted"><span class="skolem">G'</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> MORE FIELDS L_ss
    <span class="keyword1"><span class="command">unfolding</span></span> ti_Lcnv_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">G'</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"igba.accept <span class="skolem">G'</span> <span class="main">=</span> accept"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"igba_rec.more <span class="skolem">G'</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ARUN MORE 
    <span class="keyword1"><span class="command">unfolding</span></span> accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> igb.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> ti_Lcnv_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">G'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span><span class="main">)</span> <span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"igba <span class="skolem">G'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">corollary</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> gba<span class="main">)</span> gba_to_idx_ext_lang_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> F <span class="main">⟹</span> finite <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gba_to_idx_ext <span class="free">ecnv</span> <span class="free">G</span> <span class="main">≤</span> 
    SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">G'</span><span class="main">.</span> igba.lang <span class="bound">G'</span> <span class="main">=</span> lang <span class="main">∧</span> igba_rec.more <span class="bound">G'</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span> <span class="main">∧</span> igba <span class="bound">G'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> gba_to_idx_ext_correct<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SPEC_rule<span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> lang_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> igba.lang_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Degeneralization›</span></span>

<span class="keyword1"><span class="command">context</span></span> igb_graph
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">degeneralize_ext</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'Q</span> <span class="main">×</span> nat<span class="main">,</span> <span class="main">_</span><span class="main">)</span> b_graph_rec_scheme"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">degeneralize_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="main">≡</span> 
      <span class="keyword1">if</span> num_acc <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">⦇</span>
        g_V <span class="main">=</span> V <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span>
        g_E <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">q'</span><span class="main">)</span><span class="main">∈</span>E<span class="main">}</span><span class="main">,</span> 
        g_V0 <span class="main">=</span> V0<span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span> 
        bg_F <span class="main">=</span> V <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span>
        <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free">G</span>
      <span class="main">⦈</span>
      <span class="keyword1">else</span> <span class="main">⦇</span>
        g_V <span class="main">=</span> V <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span>num_acc<span class="main">}</span><span class="main">,</span>
        g_E <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="bound">i'</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">i</span> <span class="bound">i'</span> <span class="bound">q</span> <span class="bound">q'</span><span class="main">.</span> 
            <span class="bound">i</span><span class="main">&lt;</span>num_acc 
          <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">q'</span><span class="main">)</span><span class="main">∈</span>E 
          <span class="main">∧</span> <span class="bound">i'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">i</span><span class="main">∈</span>acc <span class="bound">q</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">i</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="keyword1">else</span> <span class="bound">i</span><span class="main">)</span> <span class="main">}</span><span class="main">,</span>
        g_V0 <span class="main">=</span> V0 <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">,</span>
        bg_F <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">|</span> <span class="bound">q</span><span class="main">.</span> <span class="main">0</span><span class="main">∈</span>acc <span class="bound">q</span><span class="main">}</span><span class="main">,</span>
        <span class="main">…</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free">G</span>
      <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">degeneralize</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">degeneralize</span> <span class="main">≡</span> degeneralize_ext <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Automata-degen_more"><span class="command">lemma</span></span> degen_more<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph_rec.more <span class="main">(</span>degeneralize_ext <span class="free">ecnv</span><span class="main">)</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Automata-degen_invar"><span class="command">lemma</span></span> degen_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"b_graph <span class="main">(</span>degeneralize_ext <span class="free">ecnv</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degeneralize_ext <span class="free">ecnv</span>"</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_V0 <span class="var">?G'</span> <span class="main">⊆</span> g_V <span class="var">?G'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
      <span class="keyword1"><span class="command">using</span></span> V0_ss
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"g_E <span class="var">?G'</span> <span class="main">⊆</span> g_V <span class="var">?G'</span> <span class="main">×</span> g_V <span class="var">?G'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
      <span class="keyword1"><span class="command">using</span></span> E_ss
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bg_F <span class="var">?G'</span> <span class="main">⊆</span> g_V <span class="var">?G'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
      <span class="keyword1"><span class="command">using</span></span> acc_ss
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">sublocale</span></span> degen<span class="main">:</span> b_graph <span class="quoted"><span class="quoted">"degeneralize_ext <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> degen_invar <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Automata-degen_finite_reachable"><span class="command">lemma</span></span> degen_finite_reachable<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> V0<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="main">(</span>degeneralize_ext <span class="free">ecnv</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="main">(</span>degeneralize_ext <span class="free">ecnv</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?G'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"degeneralize_ext <span class="free">ecnv</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>g_E <span class="var">?G'</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="var">?G'</span><span class="main">)</span>
      <span class="main">⊆</span> E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span>V0 <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..</span>num_acc<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">n</span> <span class="skolem">q'</span> <span class="skolem">n'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">q'</span><span class="main">,</span><span class="skolem">n'</span><span class="main">)</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>g_E <span class="var">?G'</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span><span class="main">∈</span>g_V0 <span class="var">?G'</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> G1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">q'</span><span class="main">)</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="skolem">n'</span><span class="main">≤</span>num_acc"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct2<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        
        <span class="keyword1"><span class="command">from</span></span> 0 <span class="keyword1"><span class="command">have</span></span> G2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span><span class="main">∈</span>V0 <span class="main">∧</span> <span class="skolem">n</span><span class="main">≤</span>num_acc"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">note</span></span> G1 G2
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">…</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>finite_subset<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E <span class="var">?G'</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 <span class="var">?G'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_is_run_sound"><span class="command">lemma</span></span> degen_is_run_sound<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span> <span class="main">⟹</span> is_run <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-degen_path_sound"><span class="command">lemma</span></span> degen_path_sound<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="free">u</span> <span class="free">p</span> <span class="free">v</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"path E <span class="main">(</span>fst <span class="free">u</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">induction</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def path_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1" id="Automata-degen_V0_sound"><span class="command">lemma</span></span> degen_V0_sound<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> degen.V0 <span class="free">T</span> <span class="free">m</span>"</span></span> 
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">u</span> <span class="main">∈</span> V0"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def path_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>


  <span class="keyword1" id="Automata-degen_visit_acc"><span class="command">lemma</span></span> degen_visit_acc<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="free">p</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≠</span><span class="free">n'</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">qa</span><span class="main">.</span> <span class="main">(</span><span class="bound">qa</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">∈</span>set <span class="free">p</span> <span class="main">∧</span> <span class="free">n</span><span class="main">∈</span>acc <span class="bound">qa</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> path.induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>path_prepend <span class="skolem">qnh</span> <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qh</span></span> <span class="skolem"><span class="skolem">nh</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qnh</span><span class="main">=</span><span class="main">(</span><span class="skolem">qh</span><span class="main">,</span><span class="skolem">nh</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">qnh</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span><span class="main">,</span><span class="skolem">qnh</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">nh</span><span class="main">=</span><span class="free">n</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">nh</span><span class="main">=</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">∧</span> <span class="free">n</span><span class="main">∈</span>acc <span class="skolem">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">nh</span><span class="main">=</span><span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> path_prepend <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qa</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qa</span><span class="main">,</span> <span class="free">n</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> acc <span class="skolem">qa</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">nh</span><span class="main">=</span><span class="main">(</span><span class="free">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">∧</span> <span class="free">n</span><span class="main">∈</span>acc <span class="skolem">q</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Automata-degen_run_complete0"><span class="command">lemma</span></span> degen_run_complete0<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> ipath_def degeneralize_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Automata-degen_acc_run_complete0"><span class="command">lemma</span></span> degen_acc_run_complete0<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">unfolding</span></span> degen.is_acc_run_def is_acc_run_def is_acc_def degen.is_acc_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> degen_run_complete0<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
    <span class="keyword1"><span class="command">using</span></span> run_reachable<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> reachable_V
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>

  <span class="keyword1" id="Automata-degen_run_complete"><span class="command">lemma</span></span> degen_run_complete<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="bound">r'</span> <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="bound">r'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> R
    <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def is_run_def ipath_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">elim</span> conjE<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">,</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> E"</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> rec_nat
      <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span> 
      <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="bound">q</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="keyword1">else</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="main">0</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">r'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
        <span class="keyword1">let</span> 
          <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">=</span><span class="skolem">r'</span> <span class="bound">i</span> 
        <span class="keyword1">in</span> 
          <span class="main">(</span><span class="free">r</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="bound">q</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">n</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="keyword1">else</span> <span class="bound">n</span><span class="main">)</span>
      <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> r'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> R0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">0</span> <span class="main">∈</span> degen.V0 <span class="free">T</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R0
      <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> MAP<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>fst <span class="keyword1">o</span> <span class="skolem">r'</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">&lt;</span>num_acc"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted">num_acc</span><span class="main">)</span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> SND_LESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="skolem">r'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">&lt;</span> num_acc"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">r'</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">&lt;</span> num_acc"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span> 
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">have</span></span> RS'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">r'</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">r'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">r</span> <span class="skolem">i</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">from</span></span> SND_LESS<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span>num_acc"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">r'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> RS
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1"><span class="command">from</span></span> R0' RS' MAP <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> <span class="main">(</span><span class="bound">r'</span> <span class="main">0</span> <span class="main">∈</span> degen.V0 <span class="free">T</span> <span class="free">m</span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r'</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r'</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> 
      <span class="main">∧</span> <span class="free">r</span> <span class="main">=</span> fst <span class="main">∘</span> <span class="bound">r'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_run_bound"><span class="command">lemma</span></span> degen_run_bound<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">r</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> num_acc"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> R 
    <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def ipath_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span>
  
  <span class="keyword1" id="Automata-degen_acc_run_complete_aux1"><span class="command">lemma</span></span> degen_acc_run_complete_aux1<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> EXJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="free">r</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="bound">q'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">j</span><span class="main">≥</span><span class="free">i</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> RI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&lt;</span>num_acc"</span></span> <span class="keyword1"><span class="command">using</span></span> degen_run_bound<span class="main">[</span><span class="operator">OF</span> NN0 R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> EXJ <span class="keyword1"><span class="command">have</span></span> 
      <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="free">i</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="skolem">j</span><span class="main">≤</span><span class="bound">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">OF</span> EXJ<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> j_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> Least_le<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span><span class="main">&lt;</span><span class="skolem">j</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">∉</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">≥</span><span class="free">i</span> <span class="main">∧</span> <span class="bound">k</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">⟶</span> <span class="main">(</span>snd <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">≤</span><span class="skolem">j</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">r</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> less_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">k</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">=</span><span class="free">i</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> RI <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> less.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">≤</span><span class="skolem">j</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> less.IH<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> 
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def is_run_def ipath_def
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_diff_1 <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> 
              less_nat_zero_code neq0_conv<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∉</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">∉</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="skolem">k</span>›</span></span> 
              dual_order.strict_trans1 less.prems<span class="main">(</span>2<span class="main">)</span> 
              <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span> <span class="main">∈</span> local.acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span>›</span></span> 
        order_refl surjective_pairing<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
      
  <span class="keyword1" id="Automata-degen_acc_run_complete_aux1'"><span class="command">lemma</span></span> degen_acc_run_complete_aux1'<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> <span class="free">r</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="bound">q'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> RI <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&lt;</span>num_acc"</span></span> <span class="keyword1"><span class="command">using</span></span> degen_run_bound<span class="main">[</span><span class="operator">OF</span> NN0 R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ACC <span class="keyword1"><span class="command">have</span></span> EXJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> INFM_nat_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">from</span></span> degen_acc_run_complete_aux1<span class="main">[</span><span class="operator">OF</span> NN0 R EXJ RI<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_acc_run_complete_aux2"><span class="command">lemma</span></span> degen_acc_run_complete_aux2<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> OFS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ofs</span><span class="main">&lt;</span>num_acc"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">q'</span><span class="main">.</span> 
      <span class="free">r</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc<span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">n</span> <span class="main">+</span> <span class="free">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">∈</span> acc <span class="bound">q'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RI OFS
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ofs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 
    <span class="keyword1"><span class="command">from</span></span> degen_run_bound<span class="main">[</span><span class="operator">OF</span> NN0 R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>›</span></span> 
    <span class="keyword1"><span class="command">have</span></span> NLE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span>num_acc"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">with</span></span> degen_acc_run_complete_aux1'<span class="main">[</span><span class="operator">OF</span> NN0 R ACC <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">ofs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Suc.IH<span class="main">[</span><span class="operator">OF</span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Suc.prems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≥</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="skolem">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc<span class="main">)</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span><span class="main">+</span><span class="skolem">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">∈</span> acc <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degen.is_run_def is_run_def ipath_def<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> RJ A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q2</span></span> <span class="keyword2"><span class="keyword">where</span></span> RSJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q2</span><span class="main">,</span><span class="main">(</span><span class="skolem">n</span><span class="main">+</span>Suc <span class="skolem">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def <span class="dynamic"><span class="dynamic">mod_simps</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">j'</span><span class="main">.</span> <span class="skolem">i</span><span class="main">≤</span><span class="skolem">j</span> <span class="main">⟹</span> Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="bound">j'</span> <span class="main">⟹</span> <span class="skolem">i</span><span class="main">≤</span><span class="bound">j'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degen_acc_run_complete_aux1'<span class="main">[</span><span class="operator">OF</span> NN0 R ACC RSJ<span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">≥</span><span class="skolem">i</span>›</span></span> 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> aux<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_acc_run_complete"><span class="command">lemma</span></span> degen_acc_run_complete<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> AR<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">r'</span> 
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="free">r'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> fst <span class="keyword1">o</span> <span class="free">r'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True 
    <span class="keyword1"><span class="command">with</span></span> AR degen_acc_run_complete0 
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">assume</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> AR <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> degen_run_complete<span class="main">[</span><span class="operator">OF</span> NN0 R<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
      R'<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="skolem">r'</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> fst <span class="main">∘</span> <span class="skolem">r'</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> ACC <span class="keyword1"><span class="command">have</span></span> ACC'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="skolem">r'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">r'</span> <span class="bound">j</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> RI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="main">(</span>num_acc <span class="main">-</span> <span class="skolem">n</span> <span class="keyword1">mod</span> num_acc<span class="main">)</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> dvd_imp_mod_0<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> NN0 add_diff_inverse mod_0_imp_dvd
          mod_add_left_eq mod_less_divisor mod_self nat_diff_split not_gr_zero zero_less_diff<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ofs</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        OFS_LESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ofs</span><span class="main">&lt;</span>num_acc"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">n</span> <span class="main">+</span> <span class="skolem">ofs</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NN0 Nat.add_0_right diff_less neq0_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> degen_acc_run_complete_aux2<span class="main">[</span><span class="operator">OF</span> NN0 R' ACC' RI OFS_LESS<span class="main">]</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&gt;</span><span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span>acc <span class="skolem">q'</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">r'</span> <span class="bound">j</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="skolem">r'</span> <span class="bound">i</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="skolem">r'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degen.is_acc_run_def degen.is_acc_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> that<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_run_find_change"><span class="command">lemma</span></span> degen_run_find_change<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="free">q'</span><span class="main">,</span><span class="free">n'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">≠</span><span class="free">n'</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">k</span> <span class="free">qk</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&lt;</span><span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">k</span> <span class="main">=</span> <span class="main">(</span><span class="free">qk</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> acc <span class="free">qk</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> degen_run_bound<span class="main">[</span><span class="operator">OF</span> NN0 R<span class="main">]</span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&lt;</span>num_acc"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n'</span><span class="main">&lt;</span>num_acc"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> snd_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">&lt;</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">r</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> LeastI_ex A k_def leD less_linear snd_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">from</span></span> Least_le<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span><span class="main">&lt;</span><span class="bound">k</span> <span class="main">∧</span> snd <span class="main">(</span><span class="free">r</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span>"</span></span><span class="main">,</span> <span class="operator">folded</span> k_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> LEK_EQN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">k'</span> <span class="main">∧</span> <span class="bound">k'</span><span class="main">&lt;</span><span class="skolem">k</span> <span class="main">⟶</span> snd <span class="main">(</span><span class="free">r</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="free">n</span><span class="main">)</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> le_neq_implies_less not_le snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> SND_RKMO<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def ipath_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred gr_implies_not0 neq0_conv<span class="main">)</span> 
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="free">r</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">≠</span> <span class="free">n</span>›</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> degeneralize_ext_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A LEK_EQN 
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def <span class="quoted"><span class="quoted">‹snd <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> less_Suc_eq 
        less_imp_diff_less not_less_eq snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="free">thesis</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> that<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="free">r</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span><span class="main">&lt;</span><span class="skolem">k</span>›</span></span> SND_RKMO <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1" id="Automata-degen_run_find_acc_aux"><span class="command">lemma</span></span> degen_run_find_acc_aux<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> AR<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="free">i</span> <span class="main">=</span> <span class="main">(</span><span class="free">q</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> acc <span class="free">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&lt;</span>num_acc"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span> <span class="bound">qj</span><span class="main">.</span> <span class="free">i</span><span class="main">≤</span><span class="bound">j</span> <span class="main">∧</span> <span class="free">r</span> <span class="bound">j</span> <span class="main">=</span> <span class="main">(</span><span class="bound">qj</span><span class="main">,</span><span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">∈</span> acc <span class="bound">qj</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> AR <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span>
      <span class="comment1">(*and ACC: "limit r ∩ bg_F (degeneralize_ext ecnv) ≠ {}"*)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> degen.is_acc_run_def degen.is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ACC <span class="keyword1"><span class="command">have</span></span> ACC'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">j</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>
    
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">n</span><span class="main">&lt;</span>num_acc›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">qj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span><span class="main">≤</span><span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">qj</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">∈</span>acc <span class="skolem">qj</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> R <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span> <span class="skolem">j</span><span class="main">,</span> <span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> degen.E <span class="free">T</span> <span class="free">m</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> degen.is_run_def ipath_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qsj</span></span> <span class="keyword2"><span class="keyword">where</span></span> RSJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">qsj</span><span class="main">,</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">n</span><span class="main">&lt;</span>num_acc›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      
      <span class="keyword1"><span class="command">from</span></span> ACC' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">q0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> degen_run_find_change<span class="main">[</span><span class="operator">OF</span> NN0 R <span class="quoted"><span class="quoted">‹Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k</span>›</span></span> RSJ <span class="quoted"><span class="quoted">‹<span class="free">r</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="main">0</span><span class="main">)</span>›</span></span><span class="main">]</span> 
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">ql</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">l</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ql</span><span class="main">,</span> Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">n</span> <span class="main">∈</span> acc <span class="skolem">ql</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem">ql</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
      
  <span class="keyword1" id="Automata-degen_acc_run_sound"><span class="command">lemma</span></span> degen_acc_run_sound<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_run <span class="free">T</span> <span class="free">m</span> <span class="free">r</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">i</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> degen.is_acc_run_def degen.is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> degen_is_run_sound<span class="main">[</span><span class="operator">OF</span> R<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> R'<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> NN0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> False

      <span class="keyword1"><span class="command">from</span></span> ACC <span class="keyword1"><span class="command">have</span></span> ACC'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="free">r</span> <span class="bound">j</span> <span class="main">∈</span> degen.F <span class="free">T</span> <span class="free">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>

      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> allI impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">i</span>

        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">qj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">&gt;</span><span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">qj</span><span class="main">,</span><span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ACCJ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> acc <span class="main">(</span><span class="skolem">qj</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ACC' <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

        <span class="keyword3"><span class="command">assume</span></span> NLESS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&lt;</span>num_acc"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="skolem">i</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">j</span><span class="main">&gt;</span><span class="skolem">i</span>›</span></span> RJ ACCJ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>Suc <span class="skolem">n'</span><span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> degen_run_find_acc_aux<span class="main">[</span><span class="operator">OF</span> NN0 A RJ ACCJ NLESS<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">qk</span></span> <span class="keyword2"><span class="keyword">where</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">≤</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">qk</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> acc <span class="skolem">qk</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>›</span></span> dual_order.strict_trans1 fst_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃<span class="hidden">⇩</span><sub>∞</sub></span><span class="bound">i</span><span class="main">.</span> <span class="bound">n</span> <span class="main">∈</span> acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> INFM_nat<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> R' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def is_acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> True
      <span class="keyword1"><span class="command">with</span></span> R' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def is_acc_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-degen_acc_run_iff"><span class="command">lemma</span></span> degen_acc_run_iff<span class="main">:</span>
    <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> fst <span class="keyword1">o</span> <span class="bound">r'</span> <span class="main">=</span> <span class="free">r</span> <span class="main">∧</span> degen.is_acc_run <span class="free">T</span> <span class="free">m</span> <span class="bound">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> degen_acc_run_complete degen_acc_run_sound
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"System Automata"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  System automata are (finite) rooted graphs with a labeling function. They are 
  used to describe the model (system) to be checked.
›</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span><span class="tfree">'L</span><span class="main">)</span> sa_rec <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> graph_rec"</span></span> <span class="main">+</span>
  sa_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> <span class="main">⇒</span> <span class="tfree">'L</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sa <span class="main">=</span>
  g<span class="main">?</span><span class="main">:</span> graph <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Q</span><span class="main">,</span> <span class="tfree">'L</span><span class="main">,</span> <span class="tfree">'more</span><span class="main">)</span> sa_rec_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">L</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">≡</span> sa_L <span class="free">G</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> is_run <span class="bound">r</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> L <span class="keyword1">o</span> <span class="bound">r</span>"</span></span>

  <span class="keyword1" id="Automata-acceptI"><span class="command">lemma</span></span> acceptI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>is_run <span class="free">r</span><span class="main">;</span> <span class="free">w</span> <span class="main">=</span> L <span class="keyword1">o</span> <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> accept <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> accept_def<span class="main">)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">≡</span> Collect accept"</span></span>

  <span class="keyword1" id="Automata-langI"><span class="command">lemma</span></span> langI<span class="main">[</span><span class="operator">intro</span><span class="main"><span class="main"><span class="main">?</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"accept <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">∈</span>lang"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lang_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Product Construction"</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we formalize the product construction between a GBA and a system
  automaton. The result is a GBG and a projection function, such that projected 
  runs of the GBG correspond to words accepted by the GBA and the system.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> igba_sys_prod_precond <span class="main">=</span> igba<span class="main">:</span> igba <span class="quoted"><span class="free">G</span></span> <span class="main">+</span> sa<span class="main">:</span> sa <span class="quoted"><span class="free">S</span></span> <span class="keyword2"><span class="keyword">for</span></span>
  <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'moreG</span><span class="main">)</span> igba_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'moreS</span><span class="main">)</span> sa_rec_scheme"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">prod</span> <span class="main">≡</span> <span class="main">⦇</span>
    g_V <span class="main">=</span> igba.V <span class="main">×</span> sa.V<span class="main">,</span>
    g_E <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
      igba.L <span class="bound">q</span> <span class="main">(</span>sa.L <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">q'</span><span class="main">)</span> <span class="main">∈</span> igba.E <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> sa.E <span class="main">}</span><span class="main">,</span>
    g_V0 <span class="main">=</span> igba.V0 <span class="main">×</span> sa.V0<span class="main">,</span>
    igbg_num_acc <span class="main">=</span> igba.num_acc<span class="main">,</span>
    igbg_acc <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s</span><span class="main">∈</span>sa.V <span class="keyword1">then</span> igba.acc <span class="bound">q</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">)</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="Automata-prod_invar"><span class="command">lemma</span></span> prod_invar<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph prod"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1"><span class="command">using</span></span> igba.V0_ss sa.V0_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">using</span></span> igba.E_ss sa.E_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">using</span></span> igba.acc_bound
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

    <span class="keyword1"><span class="command">using</span></span> igba.acc_ss
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1"><span class="command">sublocale</span></span> prod<span class="main">:</span> igb_graph <span class="quoted">prod</span> <span class="keyword1"><span class="command">using</span></span> prod_invar <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Automata-prod_finite_reachable"><span class="command">lemma</span></span> prod_finite_reachable<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>igba.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> igba.V0<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>sa.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> sa.V0<span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>g_E prod<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 prod<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">s</span> <span class="skolem">q'</span> <span class="skolem">s'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">q'</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>g_E prod<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">q'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>igba.E<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">s'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>sa.E<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rtrancl_induct2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> gsp_reach<span class="main">=</span>this

    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span> <span class="main">∈</span> g_V0 prod <span class="main">⟷</span> <span class="bound">q</span> <span class="main">∈</span> igba.V0 <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> sa.V0"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_def<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> reachSS<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>g_E prod<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> g_V0 prod<span class="main">)</span> 
      <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>igba.E<span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> igba.V0<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>sa.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> sa.V0<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gsp_reach<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reachSS<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1" id="Automata-prod_fields"><span class="command">lemma</span></span> prod_fields<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prod.V <span class="main">=</span> igba.V <span class="main">×</span> sa.V"</span></span>
    <span class="quoted"><span class="quoted">"prod.E <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> 
      igba.L <span class="bound">q</span> <span class="main">(</span>sa.L <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">q'</span><span class="main">)</span> <span class="main">∈</span> igba.E <span class="main">∧</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">s'</span><span class="main">)</span> <span class="main">∈</span> sa.E <span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"prod.V0 <span class="main">=</span> igba.V0 <span class="main">×</span> sa.V0"</span></span>
    <span class="quoted"><span class="quoted">"prod.num_acc <span class="main">=</span> igba.num_acc"</span></span>
    <span class="quoted"><span class="quoted">"prod.acc <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s</span><span class="main">∈</span>sa.V <span class="keyword1">then</span> igba.acc <span class="bound">q</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prod_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-prod_run"><span class="command">lemma</span></span> prod_run<span class="main">:</span> <span class="quoted"><span class="quoted">"prod.is_run <span class="free">r</span> <span class="main">⟷</span> 
      igba.is_run <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span> 
    <span class="main">∧</span> sa.is_run <span class="main">(</span>snd <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> igba.L <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sa.L <span class="main">(</span>snd <span class="main">(</span><span class="free">r</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span><span class="main">=</span><span class="var">?R</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">unfolding</span></span> igba.is_run_def sa.is_run_def prod.is_run_def
    <span class="keyword1"><span class="command">unfolding</span></span> prod_def ipath_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split_asm <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_prod_fst_sndI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Automata-prod_acc"><span class="command">lemma</span></span> prod_acc<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>snd <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> sa.V"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"prod.is_acc <span class="free">r</span> <span class="main">⟷</span> igba.is_acc <span class="main">(</span>fst <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prod.acc <span class="main">(</span><span class="free">r</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> igba.acc <span class="main">(</span>fst <span class="main">(</span><span class="free">r</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> prod_fields
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UNIV_I comp_apply imageI snd_conv subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">=</span> this
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod.is_acc_def igba.is_acc_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_fields<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Automata-gsp_correct1"><span class="command">lemma</span></span> gsp_correct1<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"prod.is_acc_run <span class="free">r</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sa.is_run <span class="main">(</span>snd <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>sa.L <span class="keyword1">o</span> snd <span class="keyword1">o</span> <span class="free">r</span> <span class="main">∈</span> igba.lang<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"prod.is_run <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> PA<span class="main">:</span> <span class="quoted"><span class="quoted">"prod.is_acc <span class="free">r</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> prod.is_acc_run_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> PRR<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">r</span> <span class="main">⊆</span> prod.V"</span></span> <span class="keyword1"><span class="command">using</span></span> prod.run_reachable prod.reachable_V PR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> RSR<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="main">(</span>snd <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span> <span class="main">⊆</span> sa.V"</span></span> <span class="keyword1"><span class="command">using</span></span> PRR <span class="keyword1"><span class="command">unfolding</span></span> prod_fields <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> PR PA
      <span class="keyword1"><span class="command">unfolding</span></span> igba.is_acc_run_def
        igba.lang_def igba.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_run prod_acc<span class="main"><span class="main">[</span></span><span class="operator">OF</span> RSR<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  
  <span class="keyword1" id="Automata-gsp_correct2"><span class="command">lemma</span></span> gsp_correct2<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"sa.is_run <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"sa.L <span class="keyword1">o</span> <span class="free">r</span> <span class="main">∈</span> igba.lang"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">r'</span><span class="main">.</span> <span class="free">r</span> <span class="main">=</span> snd <span class="keyword1">o</span> <span class="bound">r'</span> <span class="main">∧</span> prod.is_acc_run <span class="bound">r'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> fst <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r</span>"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">r</span> <span class="bound">r'</span><span class="main">.</span> snd <span class="keyword1">o</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">r</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">r'</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="bound">r'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> prod.is_acc_run_def 
        igba.lang_def igba.accept_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> igba.is_acc_run_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> prod_run<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> ra<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="improper">ra</span> <span class="bound">i</span><span class="main">,</span> <span class="free">r</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> exI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> prod_acc<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> order_trans<span class="main">[</span><span class="operator">OF</span> sa.run_reachable sa.reachable_V<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Lasso">
<div class="head">
<h1>Theory Lasso</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Lassos›</span></span>
<span class="comment1">(* Author: Peter Lammich *)</span>
<span class="keyword1"><span class="command">theory</span></span> Lasso
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Automata.html">Automata</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">record</span></span> <span class="tfree">'v</span> lasso <span class="main">=</span> 
    lasso_reach <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> list"</span></span>
    lasso_va <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span>"</span></span>
    lasso_cysfx <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> list"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lasso_v0</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> lasso_reach <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">|</span> <span class="main">(</span><span class="bound">v0</span><span class="main">#</span><span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">v0</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">lasso_cycle</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lasso_cycle</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">=</span> lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> lasso_cysfx <span class="free"><span class="bound"><span class="entity">L</span></span></span>"</span></span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lasso_of_prpl</span> <span class="free"><span class="bound"><span class="entity">prpl</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">prpl</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">pr</span><span class="main">,</span><span class="bound">pl</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">⦇</span>
    lasso_reach <span class="main">=</span> <span class="bound">pr</span><span class="main">,</span>
    lasso_va <span class="main">=</span> hd <span class="bound">pl</span><span class="main">,</span>
    lasso_cysfx <span class="main">=</span> tl <span class="bound">pl</span> <span class="main">⦈</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">prpl_of_lasso</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="main">(</span>lasso_reach <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">,</span> lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">#</span> lasso_cysfx <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>

  <span class="keyword1" id="Lasso-prpl_of_lasso_simps"><span class="command">lemma</span></span> prpl_of_lasso_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"fst <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">=</span> lasso_reach <span class="free">L</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">=</span> lasso_va <span class="free">L</span> <span class="main">#</span> lasso_cysfx <span class="free">L</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> prpl_of_lasso_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Lasso-lasso_of_prpl_simps"><span class="command">lemma</span></span> lasso_of_prpl_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"lasso_reach <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">prpl</span>"</span></span>
    <span class="quoted"><span class="quoted">"snd <span class="free">prpl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> lasso_cycle <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">prpl</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_of_prpl_def lasso_cycle_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_of_lasso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'q</span> lasso <span class="main">⇒</span> <span class="tfree">'q</span> word"</span></span>
    <span class="comment1">― ‹Run described by a lasso›</span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">run_of_lasso</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> lasso_reach <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">⌢</span> <span class="main">(</span>lasso_cycle <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>

  <span class="keyword1" id="Lasso-run_of_lasso_of_prpl"><span class="command">lemma</span></span> run_of_lasso_of_prpl<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">pl</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> run_of_lasso <span class="main">(</span>lasso_of_prpl <span class="main">(</span><span class="free">pr</span><span class="main">,</span> <span class="free">pl</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">pr</span> <span class="main">⌢</span> <span class="free">pl</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> run_of_lasso_def lasso_of_prpl_def lasso_cycle_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">map_lasso</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> <span class="main">⦇</span>
    lasso_reach <span class="main">=</span> map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>lasso_reach <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">,</span>
    lasso_va <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">,</span>
    lasso_cysfx <span class="main">=</span> map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>lasso_cysfx <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>
  <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="Lasso-map_lasso_simps"><span class="command">lemma</span></span> map_lasso_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"lasso_reach <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>lasso_reach <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lasso_va <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>lasso_va <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lasso_cysfx <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>lasso_cysfx <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lasso_v0 <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>lasso_v0 <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lasso_cycle <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> map_lasso_def lasso_v0_def lasso_cycle_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  
  <span class="keyword1" id="Lasso-map_lasso_run"><span class="command">lemma</span></span> map_lasso_run<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"run_of_lasso <span class="main">(</span>map_lasso <span class="free">f</span> <span class="free">L</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="keyword1">o</span> <span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_lasso_def run_of_lasso_def conc_def iter_def
      lasso_cycle_def lasso_v0_def fun_eq_iff not_less nth_Cons'
      nz_le_conv_less<span class="main">)</span>


  <span class="keyword1"><span class="command">context</span></span> graph <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lasso_pre</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> lasso <span class="main">⇒</span> bool"</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso_pre</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> 
        lasso_v0 <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">∈</span> V0
      <span class="main">∧</span> path E <span class="main">(</span>lasso_v0 <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">(</span>lasso_reach <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">(</span>lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> 
      <span class="main">∧</span> path E <span class="main">(</span>lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">(</span>lasso_cycle <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span> <span class="main">(</span>lasso_va <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span>"</span></span>
    
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso_prpl_pre</span> <span class="free"><span class="bound"><span class="entity">prpl</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">prpl</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">pr</span><span class="main">,</span> <span class="bound">pl</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">∃</span><span class="bound">v0</span> <span class="bound">va</span><span class="main">.</span>
      <span class="bound">v0</span><span class="main">∈</span>V0 
      <span class="main">∧</span> <span class="bound">pl</span> <span class="main">≠</span> <span class="main">[]</span>
      <span class="main">∧</span> path E <span class="bound">v0</span> <span class="bound">pr</span> <span class="bound">va</span>
      <span class="main">∧</span> path E <span class="bound">va</span> <span class="bound">pl</span> <span class="bound">va</span>"</span></span>

    <span class="keyword1" id="Lasso-is_lasso_pre_prpl_of_lasso"><span class="command">lemma</span></span> is_lasso_pre_prpl_of_lasso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl_pre <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> is_lasso_pre <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_pre_def prpl_of_lasso_def is_lasso_prpl_pre_def
      <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def lasso_cycle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  
    <span class="keyword1" id="Lasso-is_lasso_prpl_pre_conv"><span class="command">lemma</span></span> is_lasso_prpl_pre_conv<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl_pre <span class="free">prpl</span> 
      <span class="main">⟷</span> <span class="main">(</span>snd <span class="free">prpl</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> is_lasso_pre <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_pre_def lasso_of_prpl_def is_lasso_prpl_pre_def
      <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def lasso_cycle_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">prpl</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rename_tac</span> a b<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Lasso-is_lasso_pre_empty"><span class="command">lemma</span></span> is_lasso_pre_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"V0 <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">¬</span>is_lasso_pre <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_pre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


    <span class="keyword1" id="Lasso-run_of_lasso_pre"><span class="command">lemma</span></span> run_of_lasso_pre<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_lasso_pre <span class="free">L</span>"</span></span>  
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_run <span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"run_of_lasso <span class="free">L</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_pre_def is_run_def run_of_lasso_def 
        lasso_cycle_def lasso_v0_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ipath_conc_conv ipath_iter_conv path_cons_conv conc_fst 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">context</span></span> gb_graph <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lasso</span>
      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Q</span> lasso <span class="main">⇒</span> bool"</span></span> 
      <span class="comment1">― ‹Predicate that defines a lasso›</span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> 
        is_lasso_pre <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> <span class="main">(</span>set <span class="main">(</span>lasso_cycle <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso_prpl</span> <span class="free"><span class="bound"><span class="entity">prpl</span></span></span> <span class="main">≡</span> 
      is_lasso_prpl_pre <span class="free"><span class="bound"><span class="entity">prpl</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">prpl</span></span></span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  

    <span class="keyword1" id="Lasso-is_lasso_prpl_of_lasso"><span class="command">lemma</span></span> is_lasso_prpl_of_lasso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> is_lasso <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def
      <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def lasso_cycle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1" id="Lasso-is_lasso_prpl_conv"><span class="command">lemma</span></span> is_lasso_prpl_conv<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="free">prpl</span> <span class="main">⟷</span> <span class="main">(</span>snd <span class="free">prpl</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> is_lasso <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def is_lasso_prpl_pre_conv
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    
    <span class="keyword1" id="Lasso-is_lasso_empty"><span class="command">lemma</span></span> is_lasso_empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"V0 <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">¬</span>is_lasso <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Lasso-lasso_accepted"><span class="command">lemma</span></span> lasso_accepted<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"is_lasso <span class="free">L</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">pr</span></span>"</span> <span class="skolem"><span class="skolem">va</span></span> <span class="skolem"><span class="skolem">pls</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
        <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">L</span> <span class="main">=</span> <span class="main">⦇</span>lasso_reach <span class="main">=</span> <span class="skolem">pr</span><span class="main">,</span>lasso_va <span class="main">=</span> <span class="skolem">va</span><span class="main">,</span>lasso_cysfx <span class="main">=</span> <span class="skolem">pls</span><span class="main">⦈</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">L</span></span><span class="main">)</span>

      <span class="keyword1"><span class="command">from</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"is_run <span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_of_lasso_pre<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> set <span class="main">(</span><span class="skolem">va</span><span class="main">#</span><span class="skolem">pls</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_lasso_def lasso_cycle_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> L <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> 
        <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_of_lasso_pre<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"is_acc_run <span class="main">(</span>run_of_lasso <span class="free">L</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_acc_run_def is_acc_def run_of_lasso_def 
          lasso_cycle_def lasso_v0_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> limit_inter_INF<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Lasso-lasso_prpl_acc_run"><span class="command">lemma</span></span> lasso_prpl_acc_run<span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span><span class="free">pr</span><span class="main">,</span> <span class="free">pl</span><span class="main">)</span> <span class="main">⟹</span> is_acc_run <span class="main">(</span><span class="free">pr</span> <span class="main">⌢</span> iter <span class="free">pl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_lasso_prpl_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> lasso_accepted<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_of_lasso_of_prpl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>
  
  <span class="keyword1"><span class="command">context</span></span> gb_graph
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1" id="Lasso-accepted_lasso"><span class="command">lemma</span></span> accepted_lasso<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> V0<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"is_acc_run <span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">L</span><span class="main">.</span> is_lasso <span class="bound">L</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> 
        RUN<span class="main">:</span> <span class="quoted"><span class="quoted">"is_run <span class="free">r</span>"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> limit <span class="free">r</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_acc_run_limit_alt<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> RUN <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">0</span> <span class="main">∈</span> V0"</span></span> <span class="keyword2"><span class="keyword">and</span></span> RUN'<span class="main">:</span> <span class="quoted"><span class="quoted">"ipath E <span class="free">r</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_run_def<span class="main">)</span>

      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Choose a node that is visited infinitely often›</span></span>
      <span class="keyword1"><span class="command">from</span></span> RUN <span class="keyword1"><span class="command">have</span></span> RAN_REACH<span class="main">:</span> <span class="quoted"><span class="quoted">"range <span class="free">r</span> <span class="main">⊆</span> E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span>V0"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_run_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ipath_to_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>range <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">∈</span>limit <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> limit_nonempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> U_REACH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">∈</span>E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span><span class="main">``</span>V0"</span></span> <span class="keyword1"><span class="command">using</span></span> RAN_REACH limit_in_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="quoted">"<span class="skolem"><span class="skolem">pr</span></span>"</span> <span class="keyword2"><span class="keyword">where</span></span> PR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span><span class="main">∈</span>V0"</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">v0</span> <span class="skolem">pr</span> <span class="skolem">u</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> rtrancl_is_path<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">txt</span></span> <span class="quoted"><span class="plain_text">‹Build a path from <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span> to <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>u›</span></span></span></span>, that contains nodes from
        each acceptance set›</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">pl</span><span class="main">.</span> <span class="bound">pl</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> path E <span class="skolem">u</span> <span class="bound">pl</span> <span class="skolem">u</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> set <span class="bound">pl</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> finite_F ACC
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> empty
        <span class="keyword1"><span class="command">from</span></span> run_limit_two_connectedI<span class="main">[</span><span class="operator">OF</span> RUN' <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span><span class="main">]</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="skolem">p</span> <span class="skolem">u</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trancl_is_path<span class="main">)</span> 
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">A</span> <span class="skolem">F</span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> insert.IH insert.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pl</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
          <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pl</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="skolem">pl</span> <span class="skolem">u</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A'</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> set <span class="skolem">pl</span> <span class="main">∩</span> <span class="bound">A'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> insert.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> VACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>limit <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> run_limit_two_connectedI<span class="main">[</span><span class="operator">OF</span> RUN' <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span><span class="main">]</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p1</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> P1<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="skolem">p1</span> <span class="skolem">v</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trancl_is_path<span class="main">)</span> 

        <span class="keyword1"><span class="command">from</span></span> run_limit_two_connectedI<span class="main">[</span><span class="operator">OF</span> RUN' <span class="quoted"><span class="quoted">‹<span class="skolem">v</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">u</span><span class="main">∈</span>limit <span class="free">r</span>›</span></span><span class="main">]</span> 
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p2</span><span class="main">≠</span><span class="main">[]</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> P2<span class="main">:</span> <span class="quoted"><span class="quoted">"path E <span class="skolem">v</span> <span class="skolem">p2</span> <span class="skolem">u</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> trancl_is_path<span class="main">)</span> 

        <span class="keyword1"><span class="command">note</span></span> P <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> P1 <span class="keyword1"><span class="command">also</span></span> <span class="main">(</span>path_conc<span class="main">)</span> <span class="keyword1"><span class="command">note</span></span> P2 <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>path_conc<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="main">(</span><span class="skolem">pl</span><span class="main">@</span><span class="skolem">p1</span><span class="main">@</span><span class="skolem">p2</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> P2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">p1</span><span class="main">@</span><span class="skolem">p2</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_cons_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> ACC VACC <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A'</span><span class="main">∈</span>insert <span class="skolem">A</span> <span class="skolem">F</span><span class="main">.</span> set <span class="main">(</span><span class="skolem">pl</span><span class="main">@</span><span class="skolem">p1</span><span class="main">@</span><span class="skolem">p2</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A'</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pl</span><span class="main">@</span><span class="skolem">p1</span><span class="main">@</span><span class="skolem">p2</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pl</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pl</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="skolem">pl</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> set <span class="skolem">pl</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"path E <span class="skolem">u</span> <span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">pls</span><span class="main">)</span> <span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>F<span class="main">.</span> set <span class="main">(</span><span class="skolem">u</span><span class="main">#</span><span class="skolem">pls</span><span class="main">)</span> <span class="main">∩</span> <span class="bound">A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pl</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> 
          exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">⦇</span>lasso_reach <span class="main">=</span> <span class="skolem">pr</span><span class="main">,</span>lasso_va <span class="main">=</span> <span class="skolem">u</span><span class="main">,</span>lasso_cysfx <span class="main">=</span> <span class="skolem">pls</span><span class="main">⦈</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def lasso_v0_def lasso_cycle_def is_lasso_pre_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">pr</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword2"><span class="keyword">end</span></span>
  

  <span class="keyword1"><span class="command">context</span></span> b_graph
  <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lasso</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> 
      is_lasso_pre <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">∧</span> <span class="main">(</span>set <span class="main">(</span>lasso_cycle <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> F <span class="main">≠</span> <span class="main">{}</span>"</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_lasso_prpl</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso_prpl</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span> 
      is_lasso_prpl_pre <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">∧</span> <span class="main">(</span>set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> F <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    
    <span class="keyword1" id="Lasso-is_lasso_pre_ext"><span class="command">lemma</span></span> is_lasso_pre_ext<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"gbg.is_lasso_pre <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_lasso_pre"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gbg.is_lasso_pre_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_lasso_pre_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> to_gbg_ext_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Lasso-is_lasso_gbg"><span class="command">lemma</span></span> is_lasso_gbg<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"gbg.is_lasso <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_lasso"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_lasso_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def lasso_cycle_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">lemmas</span></span> lasso_accepted <span class="main">=</span> gbg.lasso_accepted<span class="main">[</span><span class="operator">unfolded</span> to_gbg_alt is_lasso_gbg<span class="main">]</span>
    <span class="keyword1"><span class="command">lemmas</span></span> accepted_lasso <span class="main">=</span> gbg.accepted_lasso<span class="main">[</span><span class="operator">unfolded</span> to_gbg_alt is_lasso_gbg<span class="main">]</span>

    <span class="keyword1" id="Lasso-is_lasso_prpl_of_lasso"><span class="command">lemma</span></span> is_lasso_prpl_of_lasso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> is_lasso <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def
      <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def lasso_cycle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1" id="Lasso-is_lasso_prpl_conv"><span class="command">lemma</span></span> is_lasso_prpl_conv<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="free">prpl</span> <span class="main">⟷</span> <span class="main">(</span>snd <span class="free">prpl</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> is_lasso <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def is_lasso_prpl_pre_conv
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Lasso-lasso_prpl_acc_run"><span class="command">lemma</span></span> lasso_prpl_acc_run<span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span><span class="free">pr</span><span class="main">,</span> <span class="free">pl</span><span class="main">)</span> <span class="main">⟹</span> is_acc_run <span class="main">(</span><span class="free">pr</span> <span class="main">⌢</span> iter <span class="free">pl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_lasso_prpl_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> lasso_accepted<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_of_lasso_of_prpl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1"><span class="command">context</span></span> igb_graph <span class="keyword2"><span class="keyword">begin</span></span>
    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span>  
      is_lasso_pre <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="main">(</span>lasso_cycle <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>acc <span class="bound">q</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">is_lasso_prpl</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="main">≡</span>  
      is_lasso_prpl_pre <span class="free"><span class="bound"><span class="entity">L</span></span></span>
      <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span>num_acc<span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">L</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span>acc <span class="bound">q</span><span class="main">)</span>"</span></span>

    <span class="keyword1" id="Lasso-is_lasso_prpl_of_lasso"><span class="command">lemma</span></span> is_lasso_prpl_of_lasso<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span>prpl_of_lasso <span class="free">L</span><span class="main">)</span> <span class="main">⟷</span> is_lasso <span class="free">L</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def
      <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def lasso_cycle_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
    <span class="keyword1" id="Lasso-is_lasso_prpl_conv"><span class="command">lemma</span></span> is_lasso_prpl_conv<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="free">prpl</span> <span class="main">⟷</span> <span class="main">(</span>snd <span class="free">prpl</span><span class="main">≠</span><span class="main">[]</span> <span class="main">∧</span> is_lasso <span class="main">(</span>lasso_of_prpl <span class="free">prpl</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_prpl_def is_lasso_prpl_pre_conv
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Lasso-is_lasso_pre_ext"><span class="command">lemma</span></span> is_lasso_pre_ext<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
      <span class="quoted"><span class="quoted">"gbg.is_lasso_pre <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_lasso_pre"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> gbg.is_lasso_pre_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> is_lasso_pre_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> to_gbg_ext_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Lasso-is_lasso_gbg"><span class="command">lemma</span></span> is_lasso_gbg<span class="main">:</span> <span class="quoted"><span class="quoted">"gbg.is_lasso <span class="free">T</span> <span class="free">m</span> <span class="main">=</span> is_lasso"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> gbg.is_lasso_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> to_gbg_ext_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fo_rule</span> arg_cong <span class="main"><span class="keyword3">|</span></span> <span class="operator">intro</span> ext<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F_def accn_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1"><span class="command">lemmas</span></span> lasso_accepted <span class="main">=</span> gbg.lasso_accepted<span class="main">[</span><span class="operator">unfolded</span> to_gbg_alt is_lasso_gbg<span class="main">]</span>
    <span class="keyword1"><span class="command">lemmas</span></span> accepted_lasso <span class="main">=</span> gbg.accepted_lasso<span class="main">[</span><span class="operator">unfolded</span> to_gbg_alt is_lasso_gbg<span class="main">]</span>

    <span class="keyword1" id="Lasso-lasso_prpl_acc_run"><span class="command">lemma</span></span> lasso_prpl_acc_run<span class="main">:</span>
      <span class="quoted"><span class="quoted">"is_lasso_prpl <span class="main">(</span><span class="free">pr</span><span class="main">,</span> <span class="free">pl</span><span class="main">)</span> <span class="main">⟹</span> is_acc_run <span class="main">(</span><span class="free">pr</span> <span class="main">⌢</span> iter <span class="free">pl</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_lasso_prpl_conv<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> lasso_accepted<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_of_lasso_of_prpl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Lasso-degen_lasso_sound"><span class="command">lemma</span></span> degen_lasso_sound<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"degen.is_lasso <span class="free">T</span> <span class="free">m</span> <span class="free">L</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_lasso <span class="main">(</span>map_lasso fst <span class="free">L</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        
      <span class="keyword1"><span class="command">from</span></span> A <span class="keyword1"><span class="command">have</span></span> 
        V0<span class="main">:</span> <span class="quoted"><span class="quoted">"lasso_v0 <span class="free">L</span> <span class="main">∈</span> degen.V0 <span class="free">T</span> <span class="free">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        REACH<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> 
                 <span class="main">(</span>lasso_v0 <span class="free">L</span><span class="main">)</span> <span class="main">(</span>lasso_reach <span class="free">L</span><span class="main">)</span> <span class="main">(</span>lasso_va <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        LOOP<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> 
                  <span class="main">(</span>lasso_va <span class="free">L</span><span class="main">)</span> <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span> <span class="main">(</span>lasso_va <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        ACC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>set <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> degen.F <span class="free">T</span> <span class="free">m</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> degen.is_lasso_def degen.is_lasso_pre_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">&lt;</span>num_acc"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>set <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">∈</span> local.acc <span class="main">(</span>fst <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> snd <span class="bound">q</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ACC <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">∈</span>set <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span><span class="main">∈</span>acc <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">with</span></span> LOOP <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pl'</span></span> <span class="keyword2"><span class="keyword">where</span></span> SPL<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>lasso_cycle <span class="free">L</span><span class="main">)</span> <span class="main">=</span> set <span class="skolem">pl'</span>"</span></span> 
            <span class="keyword2"><span class="keyword">and</span></span> PS<span class="main">:</span> <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span> <span class="skolem">pl'</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> path_loop_shift<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> SPL <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pl'</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lasso_cycle_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pl''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pl'</span><span class="main">=</span><span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span><span class="main">#</span><span class="skolem">pl''</span>"</span></span> 
            <span class="keyword1"><span class="command">using</span></span> PS <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pl'</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q2</span></span> <span class="skolem"><span class="skolem">pl'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
            <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">pl''</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q2</span><span class="main">,</span><span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc<span class="main">)</span><span class="main">#</span><span class="skolem">pl'''</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> PS <span class="quoted"><span class="quoted">‹<span class="skolem">i</span><span class="main">∈</span>acc <span class="skolem">q</span>›</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> num_acc›</span></span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">pl''</span></span><span class="main">)</span> 
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
              <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps degeneralize_ext_def 
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
          <span class="keyword1"><span class="command">from</span></span> PS <span class="keyword1"><span class="command">have</span></span> 
            <span class="quoted"><span class="quoted">"path <span class="main">(</span>degen.E <span class="free">T</span> <span class="free">m</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q2</span><span class="main">,</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="skolem">pl''</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Suc <span class="skolem">i</span> <span class="main">&lt;</span> num_acc›</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> path_simps<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> degen_visit_acc<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qa</span></span> 
            <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qa</span><span class="main">,</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">∈</span>set <span class="skolem">pl''</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">∈</span> acc <span class="skolem">qa</span>"</span></span> 
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bexI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">qa</span><span class="main">,</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SPL<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this

      <span class="keyword1"><span class="command">from</span></span> degen_V0_sound<span class="main">[</span><span class="operator">OF</span> V0<span class="main">]</span> 
        degen_path_sound<span class="main">[</span><span class="operator">OF</span> REACH<span class="main">]</span> 
        degen_path_sound<span class="main">[</span><span class="operator">OF</span> LOOP<span class="main">]</span> aux
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> is_lasso_def is_lasso_pre_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword2"><span class="keyword">end</span></span>


  <span class="keyword1"><span class="command">definition</span></span> lasso_rel_ext_internal_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="free">lasso_rel_ext</span> <span class="bound">Re</span> <span class="bound">R</span> <span class="main">≡</span> <span class="main">{</span>
    <span class="main">(</span><span class="main">⦇</span> lasso_reach <span class="main">=</span> <span class="bound">r'</span><span class="main">,</span> lasso_va <span class="main">=</span> <span class="bound">va'</span><span class="main">,</span> lasso_cysfx <span class="main">=</span> <span class="bound">cysfx'</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m'</span> <span class="main">⦈</span><span class="main">,</span> 
     <span class="main">⦇</span> lasso_reach <span class="main">=</span> <span class="bound">r</span><span class="main">,</span> lasso_va <span class="main">=</span> <span class="bound">va</span><span class="main">,</span> lasso_cysfx <span class="main">=</span> <span class="bound">cysfx</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">|</span>
      <span class="bound">r'</span> <span class="bound">r</span> <span class="bound">va'</span> <span class="bound">va</span> <span class="bound">cysfx'</span> <span class="bound">cysfx</span> <span class="bound">m'</span> <span class="bound">m</span><span class="main">.</span> 
      <span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel 
    <span class="main">∧</span> <span class="main">(</span><span class="bound">va'</span><span class="main">,</span><span class="bound">va</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span>
    <span class="main">∧</span> <span class="main">(</span><span class="bound">cysfx'</span><span class="main">,</span> <span class="bound">cysfx</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel
    <span class="main">∧</span> <span class="main">(</span><span class="bound">m'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">Re</span>
    <span class="main">}</span>"</span></span>


  <span class="keyword1" id="Lasso-lasso_rel_ext_def"><span class="command">lemma</span></span> lasso_rel_ext_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">=</span> <span class="main">{</span>
    <span class="main">(</span><span class="main">⦇</span> lasso_reach <span class="main">=</span> <span class="bound">r'</span><span class="main">,</span> lasso_va <span class="main">=</span> <span class="bound">va'</span><span class="main">,</span> lasso_cysfx <span class="main">=</span> <span class="bound">cysfx'</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m'</span> <span class="main">⦈</span><span class="main">,</span> 
     <span class="main">⦇</span> lasso_reach <span class="main">=</span> <span class="bound">r</span><span class="main">,</span> lasso_va <span class="main">=</span> <span class="bound">va</span><span class="main">,</span> lasso_cysfx <span class="main">=</span> <span class="bound">cysfx</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> <span class="main">|</span>
      <span class="bound">r'</span> <span class="bound">r</span> <span class="bound">va'</span> <span class="bound">va</span> <span class="bound">cysfx'</span> <span class="bound">cysfx</span> <span class="bound">m'</span> <span class="bound">m</span><span class="main">.</span> 
      <span class="main">(</span><span class="bound">r'</span><span class="main">,</span><span class="bound">r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel 
    <span class="main">∧</span> <span class="main">(</span><span class="bound">va'</span><span class="main">,</span><span class="bound">va</span><span class="main">)</span><span class="main">∈</span><span class="bound">R</span>
    <span class="main">∧</span> <span class="main">(</span><span class="bound">cysfx'</span><span class="main">,</span> <span class="bound">cysfx</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel
    <span class="main">∧</span> <span class="main">(</span><span class="bound">m'</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">Re</span>
    <span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_rel_ext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Lasso-lasso_rel_ext_sv"><span class="command">lemma</span></span> lasso_rel_ext_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span> single_valued <span class="bound">Re</span><span class="main">;</span> single_valued <span class="bound">R</span> <span class="main">⟧</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_rel_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD list_rel_sv<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> single_valuedD<span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Lasso-lasso_rel_ext_id"><span class="command">lemma</span></span> lasso_rel_ext_id<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">Re</span><span class="main">=</span>Id<span class="main">;</span> <span class="bound">R</span><span class="main">=</span>Id <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">=</span> Id"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_rel_ext_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lasso.surjective<span class="main">)</span>

  <span class="keyword1"><span class="command">consts</span></span> i_lasso_ext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">lasso_rel_ext</span> <span class="quoted">i_lasso_ext</span><span class="main">]</span>

  <span class="keyword1"><span class="command">find_consts</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> lasso_scheme"</span></span>
  <span class="keyword1"><span class="command">term</span></span> <span class="quoted">lasso_reach_update</span>

  <span class="keyword1" id="Lasso-lasso_param"><span class="command">lemma</span></span> lasso_param<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_reach<span class="main">,</span> lasso_reach<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_va<span class="main">,</span> lasso_va<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="bound">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_cysfx<span class="main">,</span> lasso_cysfx<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_ext<span class="main">,</span> lasso_ext<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="bound">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="bound">Re</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_reach_update<span class="main">,</span> lasso_reach_update<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_va_update<span class="main">,</span> lasso_va_update<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span><span class="bound">R</span><span class="main">→</span><span class="bound">R</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_cysfx_update<span class="main">,</span> lasso_cysfx_update<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso.more_update<span class="main">,</span> lasso.more_update<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span><span class="bound">Re</span><span class="main">→</span><span class="bound">Re</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_rel_ext_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>


  <span class="keyword1" id="Lasso-lasso_param2"><span class="command">lemma</span></span> lasso_param2<span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_v0<span class="main">,</span> lasso_v0<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="bound">R</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>lasso_cycle<span class="main">,</span> lasso_cycle<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Re</span> <span class="bound">R</span><span class="main">.</span> <span class="main">(</span>map_lasso<span class="main">,</span> map_lasso<span class="main">)</span> 
      <span class="main">∈</span> <span class="main">(</span><span class="bound">R</span><span class="main">→</span><span class="free">R'</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Re</span><span class="main">,</span><span class="bound">R</span><span class="main">⟩</span>lasso_rel_ext <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R'</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_v0_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> lasso_cycle_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> map_lasso_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span><span class="main"><span class="keyword3">+</span></span>


  <span class="keyword1" id="Lasso-lasso_of_prpl_param"><span class="command">lemma</span></span> lasso_of_prpl_param<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel<span class="main">;</span> snd <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> 
    <span class="main">⟹</span> <span class="main">(</span>lasso_of_prpl <span class="free">l'</span><span class="main">,</span> lasso_of_prpl <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_of_prpl_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">l'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">ba</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1" id="Lasso-lasso_of_prpl_autoref"><span class="command">lemma</span></span> lasso_of_prpl_autoref<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>snd <span class="free">l</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l'</span><span class="main">,</span><span class="free">l</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lasso_of_prpl <span class="free">l'</span><span class="main">,</span> 
      <span class="main">(</span><span class="keyword1">OP</span> lasso_of_prpl 
        <span class="main">:::</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>lasso_rel_ext<span class="main">)</span><span class="main">$</span><span class="free">l</span><span class="main">)</span> 
      <span class="main">∈</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>lasso_rel_ext"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lasso_of_prpl_param<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>




  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Implementing runs by lassos›</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> lasso_run_rel_def_internal<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">lasso_run_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> br run_of_lasso <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span>nat_rel <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1" id="Lasso-lasso_run_rel_def"><span class="command">lemma</span></span> lasso_run_rel_def<span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>lasso_run_rel <span class="main">=</span> br run_of_lasso <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span>nat_rel <span class="main">→</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_run_rel_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Lasso-lasso_run_rel_sv"><span class="command">lemma</span></span> lasso_run_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>lasso_run_rel<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_run_rel_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

  <span class="keyword1"><span class="command">consts</span></span> i_run <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>

  <span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">lasso_run_rel</span> <span class="quoted">i_run</span><span class="main">]</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_map_run</span> <span class="main">≡</span> <span class="keyword1">(o)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(o)</span> <span class="main">≡</span> op_map_run"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword1" id="Lasso-map_lasso_run_refine"><span class="command">lemma</span></span> map_lasso_run_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_lasso<span class="main">,</span>op_map_run<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span><span class="main">→</span><span class="free">R'</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>lasso_run_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R'</span><span class="main">⟩</span>lasso_run_rel"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> lasso_run_rel_def op_map_run_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">f'</span> <span class="skolem">l</span> <span class="skolem">r</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">f'</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> br run_of_lasso <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span>nat_rel <span class="main">→</span> <span class="free">R</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span><span class="main">,</span><span class="skolem">r</span><span class="main">)</span><span class="main">∈</span>nat_rel <span class="main">→</span> <span class="free">R</span>"</span></span> 
      <span class="keyword2"><span class="keyword">and</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> run_of_lasso <span class="skolem">l</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>
    
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>map_lasso <span class="skolem">f</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">f</span> <span class="keyword1">o</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">∈</span> br run_of_lasso <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> br_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="keyword1">o</span> <span class="skolem">r'</span><span class="main">,</span> <span class="skolem">f'</span> <span class="keyword1">o</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> nat_rel <span class="main">→</span> <span class="free">R'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">parametricity</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="main">(</span>relcompI<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> 
      <span class="quoted"><span class="quoted">"<span class="main">(</span>map_lasso <span class="skolem">f</span> <span class="skolem">l</span><span class="main">,</span> <span class="skolem">f'</span> <span class="keyword1">o</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">∈</span> br run_of_lasso <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="keyword1">O</span> <span class="main">(</span>nat_rel <span class="main">→</span> <span class="free">R'</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Simulation">
<div class="head">
<h1>Theory Simulation</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simulation›</span></span>
<span class="keyword1"><span class="command">theory</span></span> Simulation
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Automata.html">Automata</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1" id="Simulation-finite_ImageI"><span class="command">lemma</span></span> finite_ImageI<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>  
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> finite <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="bound">a</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">R</span><span class="main">``</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">note</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">``</span><span class="free">A</span> <span class="main">=</span> <span class="main">⋃</span><span class="main">{</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">:</span><span class="free">A</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="main">{</span><span class="free">R</span><span class="main">``</span><span class="main">{</span><span class="bound">a</span><span class="main">}</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">:</span><span class="free">A</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_Union<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>


  <span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simulation›</span></span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Relations›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_br_α</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">the_br_invar</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> Domain <span class="free"><span class="bound"><span class="entity">R</span></span></span>"</span></span>

  <span class="keyword1" id="Simulation-the_br"><span class="command">lemma</span></span> the_br<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>  
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"br <span class="main">(</span>the_br_α <span class="free">R</span><span class="main">)</span> <span class="main">(</span>the_br_invar <span class="free">R</span><span class="main">)</span> <span class="main">=</span> <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> build_rel_def the_br_α_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> assms someI_ex single_valuedD<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1" id="Simulation-the_br_br"><span class="command">lemma</span></span> the_br_br<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="free">x</span> <span class="main">⟹</span> the_br_α <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
    <span class="quoted"><span class="quoted">"the_br_invar <span class="main">(</span>br <span class="free">α</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> the_br_α_def build_rel_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation between Runs›</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">run_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> word <span class="main">×</span> <span class="tfree">'b</span> word<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">run_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">ra</span><span class="main">,</span> <span class="bound">rb</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">ra</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">rb</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Simulation-run_rel_converse"><span class="command">lemma</span></span> run_rel_converse<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span><span class="main">,</span> <span class="free">rb</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">rb</span><span class="main">,</span> <span class="free">ra</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="free">R</span>"</span></span>  
    <span class="keyword1"><span class="command">unfolding</span></span> run_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Simulation-run_rel_single_valued"><span class="command">lemma</span></span> run_rel_single_valued<span class="main">:</span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span> 
    <span class="main">⟹</span> <span class="main">(</span><span class="free">ra</span><span class="main">,</span> <span class="free">rb</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="free">R</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> the_br_invar <span class="free">R</span> <span class="main">(</span><span class="free">ra</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">rb</span> <span class="main">=</span> the_br_α <span class="free">R</span> <span class="keyword1">o</span> <span class="free">ra</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> run_rel_def the_br_α_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> single_valuedD someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> DomainE someI_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Simulation›</span></span>
  <span class="keyword1"><span class="command">locale</span></span> simulation <span class="main">=</span>
    a<span class="main">:</span> graph <span class="quoted"><span class="free">A</span></span> <span class="main">+</span>
    b<span class="main">:</span> graph <span class="quoted"><span class="free">B</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> nodes_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> a.V <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">∈</span> b.V"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> init_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a0</span> <span class="main">∈</span> a.V0 <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b0</span><span class="main">.</span> <span class="bound">b0</span> <span class="main">∈</span> b.V0 <span class="main">∧</span> <span class="main">(</span><span class="free">a0</span><span class="main">,</span> <span class="bound">b0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> step_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">a'</span><span class="main">)</span> <span class="main">∈</span> a.E <span class="main">⟹</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">∈</span> b.E <span class="main">∧</span> <span class="main">(</span><span class="free">a'</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Simulation-simulation_this"><span class="command">lemma</span></span> simulation_this<span class="main">:</span> <span class="quoted"><span class="quoted">"simulation <span class="free">R</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1" id="Simulation-run_sim"><span class="command">lemma</span></span> run_sim<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> arun<span class="main">:</span> <span class="quoted"><span class="quoted">"a.is_run <span class="free">ra</span>"</span></span>
      <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">rb</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="free">rb</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span><span class="main">,</span> <span class="free">rb</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="free">R</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> arun <span class="keyword1"><span class="command">have</span></span> ainit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ra</span> <span class="main">0</span> <span class="main">∈</span> a.V0"</span></span> 
        <span class="keyword2"><span class="keyword">and</span></span> astep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="free">ra</span> <span class="bound">i</span><span class="main">,</span> <span class="free">ra</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> a.E"</span></span>
        <span class="keyword1"><span class="command">using</span></span> a.run_V0 a.run_ipath ipathD <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">from</span></span> init_sim <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rb0</span></span> <span class="keyword2"><span class="keyword">where</span></span> rel0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rb0</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> binit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rb0</span> <span class="main">∈</span> b.V0"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ainit<span class="main">)</span>
  
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rb</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">=</span> rec_nat <span class="skolem">rb0</span> <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">rbi</span><span class="main">.</span> <span class="keyword1">SOME</span> <span class="bound">rbsi</span><span class="main">.</span> <span class="main">(</span><span class="bound">rbi</span><span class="main">,</span> <span class="bound">rbsi</span><span class="main">)</span> <span class="main">∈</span> b.E <span class="main">∧</span> <span class="main">(</span><span class="free">ra</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">rbsi</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
      
      <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
        <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">rb0</span>"</span></span> 
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">rb</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">rbsi</span><span class="main">.</span> <span class="main">(</span><span class="skolem">rb</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">rbsi</span><span class="main">)</span> <span class="main">∈</span> b.E <span class="main">∧</span> <span class="main">(</span><span class="free">ra</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">,</span> <span class="bound">rbsi</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> rb_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rb</span> <span class="skolem">i</span><span class="main">,</span> <span class="skolem">rb</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> b.E <span class="main">∧</span> <span class="main">(</span><span class="free">ra</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="skolem">rb</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> 0
          <span class="keyword1"><span class="command">from</span></span> step_sim astep rel0 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rb1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rb</span> <span class="main">0</span><span class="main">,</span> <span class="skolem">rb1</span><span class="main">)</span> <span class="main">∈</span> b.E"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">rb1</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> step_sim astep <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rbss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">rb</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">,</span> <span class="skolem">rbss</span><span class="main">)</span> <span class="main">∈</span> b.E"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">rbss</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> someI<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this
      
      <span class="keyword1"><span class="command">from</span></span> aux binit <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="skolem">rb</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> b.is_run_def ipath_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> aux rel0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span><span class="main">,</span> <span class="skolem">rb</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> run_rel_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">i</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">rule</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Simulation-stuck_sim"><span class="command">lemma</span></span> stuck_sim<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">∉</span> Domain b.E"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∉</span> Domain a.E"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> step_sim<span class="main">)</span>

    <span class="keyword1" id="Simulation-run_Domain"><span class="command">lemma</span></span> run_Domain<span class="main">:</span> <span class="quoted"><span class="quoted">"a.is_run <span class="free">r</span> <span class="main">⟹</span> <span class="free">r</span> <span class="free">i</span> <span class="main">∈</span> Domain <span class="free">R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> run_sim<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def<span class="main">)</span>

    <span class="keyword1" id="Simulation-br_run_sim"><span class="command">lemma</span></span> br_run_sim<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> br <span class="free">α</span> <span class="free">I</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"a.is_run <span class="free">r</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="main">(</span><span class="free">α</span> <span class="keyword1">o</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> run_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def build_rel_def a.is_run_def b.is_run_def ipath_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Simulation-is_reachable_sim"><span class="command">lemma</span></span> is_reachable_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> a.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> a.V0 <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="bound">b</span> <span class="main">∈</span> b.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> b.V0"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rtrancl_induct<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> ImageI init_sim rtrancl.rtrancl_refl<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> rtrancl_image_advance step_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Simulation-reachable_sim"><span class="command">lemma</span></span> reachable_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"a.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> a.V0 <span class="main">⊆</span> <span class="free">R</span><span class="main">¯</span> <span class="main">``</span> b.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> b.V0"</span></span>
      <span class="keyword1"><span class="command">using</span></span> is_reachable_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1" id="Simulation-reachable_finite_sim"><span class="command">lemma</span></span> reachable_finite_sim<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>b.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> b.V0<span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> b.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> b.V0 <span class="main">⟹</span> finite <span class="main">(</span><span class="free">R</span><span class="main">¯</span> <span class="main">``</span> <span class="main">{</span><span class="bound">b</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>a.E<span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">``</span> a.V0<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_subset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reachable_sim<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> finite_ImageI<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fact</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>  

  <span class="keyword1" id="Simulation-simulation_trans"><span class="command">lemma</span></span> simulation_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simulation <span class="free">R1</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simulation <span class="free">R2</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"simulation <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> s1<span class="main">:</span> simulation <span class="quoted"><span class="free">R1</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> s2<span class="main">:</span> simulation <span class="quoted"><span class="free">R2</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> s1.nodes_sim s2.nodes_sim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> s1.init_sim s2.init_sim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">using</span></span> s1.step_sim s2.step_sim <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> simulation_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"simulation Id <span class="free">G</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">locale</span></span> lsimulation <span class="main">=</span> 
    a<span class="main">:</span> sa <span class="quoted"><span class="free">A</span></span> <span class="main">+</span>
    b<span class="main">:</span> sa <span class="quoted"><span class="free">B</span></span> <span class="main">+</span>
    simulation <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> sa_rec_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> sa_rec_scheme"</span></span>
    <span class="main">+</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> labeling_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> a.L <span class="free">a</span> <span class="main">=</span> b.L <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Simulation-lsimulation_this"><span class="command">lemma</span></span> lsimulation_this<span class="main">:</span> <span class="quoted"><span class="quoted">"lsimulation <span class="free">R</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1" id="Simulation-run_rel_consistent"><span class="command">lemma</span></span> run_rel_consistent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ra</span><span class="main">,</span> <span class="free">rb</span><span class="main">)</span> <span class="main">∈</span> run_rel <span class="free">R</span> <span class="main">⟹</span> a.L <span class="keyword1">o</span> <span class="free">ra</span> <span class="main">=</span> b.L <span class="keyword1">o</span> <span class="free">rb</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> labeling_consistent <span class="keyword1"><span class="command">unfolding</span></span> run_rel_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1" id="Simulation-accept_sim"><span class="command">lemma</span></span> accept_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"a.accept <span class="free">w</span> <span class="main">⟹</span> b.accept <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> a.accept_def b.accept_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> run_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_consistent<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="Simulation-lsimulation_trans"><span class="command">lemma</span></span> lsimulation_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lsimulation <span class="free">R1</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lsimulation <span class="free">R2</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lsimulation <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> s1<span class="main">:</span> lsimulation <span class="quoted"><span class="free">R1</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> s2<span class="main">:</span> lsimulation <span class="quoted"><span class="free">R2</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> simulation <span class="quoted"><span class="quoted">"<span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span>
      <span class="keyword1"><span class="command">using</span></span> simulation_trans s1.simulation_this s2.simulation_this <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> s1.labeling_consistent s2.labeling_consistent 
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sa<span class="main">)</span> lsimulation_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lsimulation Id <span class="free">G</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>


  <span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Bisimulation›</span></span>

  <span class="keyword1"><span class="command">locale</span></span> bisimulation <span class="main">=</span> 
    a<span class="main">:</span> graph <span class="quoted"><span class="free">A</span></span> <span class="main">+</span>
    b<span class="main">:</span> graph <span class="quoted"><span class="free">B</span></span> <span class="main">+</span>
    s1<span class="main">:</span> simulation <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="main">+</span>
    s2<span class="main">:</span> simulation <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Simulation-bisimulation_this"><span class="command">lemma</span></span> bisimulation_this<span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">R</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1" id="Simulation-converse"><span class="command">lemma</span></span> converse<span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation <span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span> <span class="free">B</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">interpret</span></span> simulation <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R</span><span class="main">¯</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="operator">unfold_locales</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Simulation-br_run_conv"><span class="command">lemma</span></span> br_run_conv<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> br <span class="free">α</span> <span class="free">I</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="free">rb</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ra</span><span class="main">.</span> <span class="free">rb</span><span class="main">=</span><span class="free">α</span> <span class="keyword1">o</span> <span class="bound">ra</span> <span class="main">∧</span> a.is_run <span class="bound">ra</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s2.run_sim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> 
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def build_rel_def<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s1.br_run_sim<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Simulation-bri_run_conv"><span class="command">lemma</span></span> bri_run_conv<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span>br <span class="free">γ</span> <span class="free">I</span><span class="main">)</span><span class="main">¯</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"a.is_run <span class="free">ra</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">rb</span><span class="main">.</span> <span class="free">ra</span><span class="main">=</span><span class="free">γ</span> <span class="keyword1">o</span> <span class="bound">rb</span> <span class="main">∧</span> b.is_run <span class="bound">rb</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s1.run_sim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def build_rel_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s2.run_sim<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_rel_def build_rel_def<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> fun_comp_eq_conv<span class="main">)</span>
  
    <span class="keyword1" id="Simulation-inj_map_run_eq"><span class="command">lemma</span></span> inj_map_run_eq<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">α</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="keyword1">o</span> <span class="free">r1</span> <span class="main">=</span> <span class="free">α</span> <span class="keyword1">o</span> <span class="free">r2</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="main">=</span> <span class="free">r2</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">from</span></span> E <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">(</span><span class="free">r1</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">α</span> <span class="main">(</span><span class="free">r2</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> comp_def<span class="main">)</span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹inj <span class="free">α</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">r1</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">r2</span> <span class="skolem">i</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> injD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>

    <span class="keyword1" id="Simulation-br_inj_run_conv"><span class="command">lemma</span></span> br_inj_run_conv<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="free">α</span>"</span></span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> br <span class="free">α</span> <span class="free">I</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="main">(</span><span class="free">α</span> <span class="keyword1">o</span> <span class="free">ra</span><span class="main">)</span> <span class="main">⟷</span> a.is_run <span class="free">ra</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> br_run_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> inj_map_run_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Simulation-single_valued_run_conv"><span class="command">lemma</span></span> single_valued_run_conv<span class="main">:</span>
      <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"single_valued <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"b.is_run <span class="free">rb</span> 
        <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ra</span><span class="main">.</span> <span class="free">rb</span><span class="main">=</span>the_br_α <span class="free">R</span> <span class="keyword1">o</span> <span class="bound">ra</span> <span class="main">∧</span> a.is_run <span class="bound">ra</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s2.run_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_rel_single_valued<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> s1.run_sim<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> run_rel_single_valued<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

    <span class="keyword1" id="Simulation-stuck_bisim"><span class="command">lemma</span></span> stuck_bisim<span class="main">:</span> 
      <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> Domain a.E <span class="main">⟷</span> <span class="free">b</span> <span class="main">∈</span> Domain b.E"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s1.stuck_sim<span class="main">[</span><span class="operator">OF</span> A<span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> s2.stuck_sim<span class="main">[</span><span class="operator">OF</span> A<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> converseI<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="main"><span class="main"><span class="main">_</span></span></span> <span class="quoted"><span class="free">R</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="Simulation-bisimulation_trans"><span class="command">lemma</span></span> bisimulation_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">R1</span> <span class="free">A</span> <span class="free">B</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">R2</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bisimulation <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> s1<span class="main">:</span> bisimulation <span class="quoted"><span class="free">R1</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> s2<span class="main">:</span> bisimulation <span class="quoted"><span class="free">R2</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> t1<span class="main">:</span> simulation <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span>
      <span class="keyword1"><span class="command">using</span></span> simulation_trans s1.s1.simulation_this s2.s1.simulation_this <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword1"><span class="command">interpret</span></span> t2<span class="main">:</span> simulation <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">A</span></span>
      <span class="keyword1"><span class="command">using</span></span> simulation_trans s2.s2.simulation_this s1.s2.simulation_this
      <span class="keyword1"><span class="command">unfolding</span></span> converse_relcomp
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> bisimulation_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation Id <span class="free">G</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">locale</span></span> lbisimulation <span class="main">=</span> 
    a<span class="main">:</span> sa <span class="quoted"><span class="free">A</span></span> <span class="main">+</span>
    b<span class="main">:</span> sa <span class="quoted"><span class="free">B</span></span> <span class="main">+</span>
    s1<span class="main">:</span> lsimulation <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="main">+</span>
    s2<span class="main">:</span> lsimulation <span class="quoted"><span class="quoted">"<span class="free">R</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="main">+</span>
    bisimulation <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> sa_rec_scheme"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> sa_rec_scheme"</span></span>
  <span class="keyword2"><span class="keyword">begin</span></span>

    <span class="keyword1" id="Simulation-lbisimulation_this"><span class="command">lemma</span></span> lbisimulation_this<span class="main">:</span> <span class="quoted"><span class="quoted">"lbisimulation <span class="free">R</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

    <span class="keyword1" id="Simulation-accept_bisim"><span class="command">lemma</span></span> accept_bisim<span class="main">:</span> <span class="quoted"><span class="quoted">"a.accept <span class="main">=</span> b.accept"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> s1.accept_sim s2.accept_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword2"><span class="keyword">end</span></span>

  <span class="keyword1" id="Simulation-lbisimulation_trans"><span class="command">lemma</span></span> lbisimulation_trans<span class="main">[</span><span class="operator">trans</span><span class="main">]</span><span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lbisimulation <span class="free">R1</span> <span class="free">A</span> <span class="free">B</span>"</span></span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"lbisimulation <span class="free">R2</span> <span class="free">B</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"lbisimulation <span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span> <span class="free">A</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> s1<span class="main">:</span> lbisimulation <span class="quoted"><span class="free">R1</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">interpret</span></span> s2<span class="main">:</span> lbisimulation <span class="quoted"><span class="free">R2</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

    <span class="keyword1"><span class="command">from</span></span> lsimulation_trans<span class="main">[</span><span class="operator">OF</span> s1.s1.lsimulation_this s2.s1.lsimulation_this<span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> t1<span class="main">:</span> lsimulation <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword1"><span class="command">from</span></span> lsimulation_trans<span class="main">[</span><span class="operator">OF</span> s2.s2.lsimulation_this s1.s2.lsimulation_this<span class="main">,</span> <span class="operator">folded</span> converse_relcomp<span class="main">]</span>
    <span class="keyword1"><span class="command">interpret</span></span> t2<span class="main">:</span> lsimulation <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">R1</span> <span class="keyword1">O</span> <span class="free">R2</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">A</span></span> <span class="keyword1"><span class="command">.</span></span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sa<span class="main">)</span> lbisimulation_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"lbisimulation Id <span class="free">G</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Step_Conv">
<div class="head">
<h1>Theory Step_Conv</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Step_Conv
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="comment1">(* Different ways of representing transitions, 
    and functions to convert between them:

    rel :: ('a × 'b) set
    pred :: 'a ⇒ 'b ⇒ bool
    succ :: 'a ⇒ 'b set
  *)</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_of_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_of_succ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred_of_rel</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred_of_succ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_of_rel</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_of_pred</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span> <span class="bound">b</span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Step_Conv-rps_expand"><span class="command">lemma</span></span> rps_expand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span>rel_of_pred <span class="free">p</span> <span class="main">⟷</span> <span class="free">p</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span>rel_of_succ <span class="free">s</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">s</span> <span class="free">a</span>"</span></span>

    <span class="quoted"><span class="quoted">"pred_of_rel <span class="free">r</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_succ <span class="free">s</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">s</span> <span class="free">a</span>"</span></span>

    <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span>succ_of_rel <span class="free">r</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span>succ_of_pred <span class="free">p</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">p</span> <span class="free">a</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_pred_def pred_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_succ_def succ_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> pred_of_succ_def succ_of_pred_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Step_Conv-rps_conv"><span class="command">lemma</span></span> rps_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_of_pred <span class="main">(</span>pred_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"rel_of_pred <span class="main">(</span>pred_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> rel_of_succ <span class="free">s</span>"</span></span>

    <span class="quoted"><span class="quoted">"rel_of_succ <span class="main">(</span>succ_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">r</span>"</span></span>
    <span class="quoted"><span class="quoted">"rel_of_succ <span class="main">(</span>succ_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> rel_of_pred <span class="free">p</span>"</span></span>

    <span class="quoted"><span class="quoted">"pred_of_rel <span class="main">(</span>rel_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_rel <span class="main">(</span>rel_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> pred_of_succ <span class="free">s</span>"</span></span>

    <span class="quoted"><span class="quoted">"pred_of_succ <span class="main">(</span>succ_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_succ <span class="main">(</span>succ_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pred_of_rel <span class="free">r</span>"</span></span>

    <span class="quoted"><span class="quoted">"succ_of_rel <span class="main">(</span>rel_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"succ_of_rel <span class="main">(</span>rel_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> succ_of_pred <span class="free">p</span>"</span></span>

    <span class="quoted"><span class="quoted">"succ_of_pred <span class="main">(</span>pred_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"succ_of_pred <span class="main">(</span>pred_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> succ_of_rel <span class="free">r</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_pred_def pred_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_succ_def succ_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> pred_of_succ_def succ_of_pred_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="comment1">(* Lifting transitions from option monad to option×option *)</span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">m2r_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span> option<span class="main">)</span> set <span class="main">⇒</span> <span class="tfree">'a</span> option rel"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2r_rel</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span>Some <span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">|</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">m2r_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2r_pred</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">≡</span> <span class="main">λ</span>None <span class="main">⇒</span> <span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> False <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">a</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">m2r_succ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2r_succ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">λ</span>None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">a</span>"</span></span>

  <span class="keyword1" id="Step_Conv-m2r_expand"><span class="command">lemma</span></span> m2r_expand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span>m2r_rel <span class="free">r</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a'</span><span class="main">.</span> <span class="free">a</span><span class="main">=</span>Some <span class="bound">a'</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a'</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"m2r_pred <span class="free">p</span> <span class="free">a</span> <span class="free">b</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a'</span><span class="main">.</span> <span class="free">a</span><span class="main">=</span>Some <span class="bound">a'</span> <span class="main">∧</span> <span class="free">p</span> <span class="bound">a'</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span>m2r_succ <span class="free">s</span> <span class="free">a</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a'</span><span class="main">.</span> <span class="free">a</span><span class="main">=</span>Some <span class="bound">a'</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">∈</span> <span class="free">s</span> <span class="bound">a'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> m2r_rel_def m2r_succ_def m2r_pred_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

  <span class="keyword1" id="Step_Conv-m2r_conv"><span class="command">lemma</span></span> m2r_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"m2r_rel <span class="main">(</span>rel_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> rel_of_succ <span class="main">(</span>m2r_succ <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"m2r_rel <span class="main">(</span>rel_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> rel_of_pred <span class="main">(</span>m2r_pred <span class="free">p</span><span class="main">)</span>"</span></span>

    <span class="quoted"><span class="quoted">"m2r_pred <span class="main">(</span>pred_of_succ <span class="free">s</span><span class="main">)</span> <span class="main">=</span> pred_of_succ <span class="main">(</span>m2r_succ <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"m2r_pred <span class="main">(</span>pred_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> pred_of_rel <span class="main">(</span>m2r_rel <span class="free">r</span><span class="main">)</span>"</span></span>

    <span class="quoted"><span class="quoted">"m2r_succ <span class="main">(</span>succ_of_pred <span class="free">p</span><span class="main">)</span> <span class="main">=</span> succ_of_pred <span class="main">(</span>m2r_pred <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"m2r_succ <span class="main">(</span>succ_of_rel <span class="free">r</span><span class="main">)</span> <span class="main">=</span> succ_of_rel <span class="main">(</span>m2r_rel <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_pred_def pred_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_succ_def succ_of_rel_def
    <span class="keyword1"><span class="command">unfolding</span></span> pred_of_succ_def succ_of_pred_def
    <span class="keyword1"><span class="command">unfolding</span></span> m2r_rel_def m2r_succ_def m2r_pred_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>


  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rel_of_enex</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">en</span><span class="main">,</span> <span class="bound">ex</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="keyword1">in</span> <span class="main">{</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">ex</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">)</span> <span class="main">|</span><span class="bound">s</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="bound">en</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pred_of_enex</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span> <span class="bound">s'</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">en</span><span class="main">,</span><span class="bound">ex</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="keyword1">in</span> <span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="bound">en</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="bound">ex</span> <span class="bound">a</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_of_enex</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">en</span><span class="main">,</span><span class="bound">ex</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">enex</span></span></span> <span class="keyword1">in</span> <span class="main">{</span><span class="bound">s'</span><span class="main">.</span> <span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="bound">en</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">s'</span><span class="main">=</span><span class="bound">ex</span> <span class="bound">a</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
  
  <span class="keyword1" id="Step_Conv-x_of_enex_expand"><span class="command">lemma</span></span> x_of_enex_expand<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="free">s'</span><span class="main">)</span> <span class="main">∈</span> rel_of_enex <span class="main">(</span><span class="free">en</span><span class="main">,</span> <span class="free">ex</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">en</span> <span class="free">s</span><span class="main">.</span> <span class="free">s'</span> <span class="main">=</span> <span class="free">ex</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_enex <span class="main">(</span><span class="free">en</span><span class="main">,</span><span class="free">ex</span><span class="main">)</span> <span class="free">s</span> <span class="free">s'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">en</span> <span class="free">s</span><span class="main">.</span> <span class="free">s'</span><span class="main">=</span><span class="free">ex</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">s'</span><span class="main">∈</span>succ_of_enex <span class="main">(</span><span class="free">en</span><span class="main">,</span><span class="free">ex</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">en</span> <span class="free">s</span><span class="main">.</span> <span class="free">s'</span><span class="main">=</span><span class="free">ex</span> <span class="bound">a</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_enex_def pred_of_enex_def succ_of_enex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1" id="Step_Conv-x_of_enex_conv"><span class="command">lemma</span></span> x_of_enex_conv<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"rel_of_pred <span class="main">(</span>pred_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> rel_of_enex <span class="free">enex</span>"</span></span>
    <span class="quoted"><span class="quoted">"rel_of_succ <span class="main">(</span>succ_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> rel_of_enex <span class="free">enex</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_rel <span class="main">(</span>rel_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> pred_of_enex <span class="free">enex</span>"</span></span>
    <span class="quoted"><span class="quoted">"pred_of_succ <span class="main">(</span>succ_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> pred_of_enex <span class="free">enex</span>"</span></span>
    <span class="quoted"><span class="quoted">"succ_of_rel <span class="main">(</span>rel_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> succ_of_enex <span class="free">enex</span>"</span></span>
    <span class="quoted"><span class="quoted">"succ_of_pred <span class="main">(</span>pred_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> succ_of_enex <span class="free">enex</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_enex_def pred_of_enex_def succ_of_enex_def 
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_pred_def rel_of_succ_def
    <span class="keyword1"><span class="command">unfolding</span></span> pred_of_rel_def pred_of_succ_def
    <span class="keyword1"><span class="command">unfolding</span></span> succ_of_rel_def succ_of_pred_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stuttering_Extension">
<div class="head">
<h1>Theory Stuttering_Extension</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Stuttering_Extension
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Simulation.html">Simulation</a> <a href="Step_Conv.html">Step_Conv</a>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_extend_edges</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set <span class="main">⇒</span> <span class="tfree">'v</span> digraph <span class="main">⇒</span> <span class="tfree">'v</span> digraph"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stutter_extend_edges</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∉</span> Domain <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_edgesI_edge"><span class="command">lemma</span></span> stutter_extend_edgesI_edge<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> stutter_extend_edges <span class="free">V</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Stuttering_Extension-stutter_extend_edgesI_stutter"><span class="command">lemma</span></span> stutter_extend_edgesI_stutter<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> Domain <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> stutter_extend_edges <span class="free">V</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1" id="Stuttering_Extension-stutter_extend_edgesE"><span class="command">lemma</span></span> stutter_extend_edgesE<span class="main">:</span>
    <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> stutter_extend_edges <span class="free">V</span> <span class="free">E</span>"</span></span>
    <span class="keyword2"><span class="keyword">obtains</span></span> <span class="main">(</span>edge<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span>"</span></span> <span class="main">|</span> <span class="main">(</span>stutter<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">∉</span> Domain <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_wf"><span class="command">lemma</span></span> stutter_extend_wf<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">×</span> <span class="free">V</span> <span class="main">⟹</span> stutter_extend_edges <span class="free">V</span> <span class="free">E</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">×</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_edges_rtrancl"><span class="command">lemma</span></span> stutter_extend_edges_rtrancl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>stutter_extend_edges <span class="free">V</span> <span class="free">E</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">=</span> <span class="free">E</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> in_rtrancl_UnI <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> rtrancl_induct<span class="main">)</span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_domain"><span class="command">lemma</span></span> stutter_extend_domain<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">⊆</span> Domain <span class="main">(</span>stutter_extend_edges <span class="free">V</span> <span class="free">E</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_edges_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_extend</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> graph_rec_scheme"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">stutter_extend</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span>
    <span class="main">⦇</span>
      g_V <span class="main">=</span> g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span>
      g_E <span class="main">=</span> stutter_extend_edges <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">,</span>
      <span class="main">…</span> <span class="main">=</span> graph_rec.more <span class="free"><span class="bound"><span class="entity">G</span></span></span>
    <span class="main">⦈</span>"</span></span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_simps"><span class="command">lemma</span></span> stutter_extend_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"g_V <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span> <span class="main">=</span> g_V <span class="free">G</span>"</span></span>
    <span class="quoted"><span class="quoted">"g_E <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span> <span class="main">=</span> stutter_extend_edges <span class="main">(</span>g_V <span class="free">G</span><span class="main">)</span> <span class="main">(</span>g_E <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"g_V0 <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span> <span class="main">=</span> g_V0 <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1" id="Stuttering_Extension-stutter_extend_simps_sa"><span class="command">lemma</span></span> stutter_extend_simps_sa<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"sa_L <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span> <span class="main">=</span> sa_L <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> graph_rec.select_convs<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> sa_rec.select_convs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sa_rec.surjective<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> graph<span class="main">)</span> stutter_extend_graph<span class="main">:</span> <span class="quoted"><span class="quoted">"graph <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> V0_ss E_ss <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stutter_extend_wf<span class="main">)</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> sa<span class="main">)</span> stutter_extend_sa<span class="main">:</span> <span class="quoted"><span class="quoted">"sa <span class="main">(</span>stutter_extend <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> graph <span class="quoted"><span class="quoted">"stutter_extend <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> stutter_extend_graph <span class="keyword1"><span class="command">by</span></span> <span class="operator">this</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bisimulation<span class="main">)</span> stutter_extend<span class="main">:</span> <span class="quoted"><span class="quoted">"bisimulation <span class="free">R</span> <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span> <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> ea<span class="main">:</span> graph <span class="quoted"><span class="quoted">"stutter_extend <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> a.stutter_extend_graph<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> eb<span class="main">:</span> graph <span class="quoted"><span class="quoted">"stutter_extend <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> b.stutter_extend_graph<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> g_V <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> g_V <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1.nodes_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> g_V0 <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> g_V0 <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s1.init_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">a'</span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">a'</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">b'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a'</span><span class="main">,</span> <span class="bound">b'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> s1.nodes_sim s1.step_sim s2.stuck_sim 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stutter_extend_edgesI_edge stutter_extend_edgesI_stutter
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stutter_extend_edgesE<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> g_V <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> g_V <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s2.nodes_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> g_V0 <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> g_V0 <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s2.init_sim <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="skolem">b'</span> <span class="skolem">a</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">b'</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">a'</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">∈</span> g_E <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">b'</span><span class="main">,</span> <span class="bound">a'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">¯</span>"</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">using</span></span> s2.nodes_sim s2.step_sim s1.stuck_sim
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> stutter_extend_edgesI_edge stutter_extend_edgesI_stutter
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> stutter_extend_edgesE<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> lbisimulation<span class="main">)</span> lstutter_extend<span class="main">:</span> <span class="quoted"><span class="quoted">"lbisimulation <span class="free">R</span> <span class="main">(</span>stutter_extend <span class="free">A</span><span class="main">)</span> <span class="main">(</span>stutter_extend <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">interpret</span></span> se<span class="main">:</span> bisimulation <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="quoted">"stutter_extend <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"stutter_extend <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> stutter_extend<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> s1.labeling_consistent<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_extend_en</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">stutter_extend_en</span> <span class="free"><span class="bound"><span class="entity">en</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">as</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">en</span></span></span> <span class="bound">s</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">as</span><span class="main">=</span><span class="main">{}</span> <span class="keyword1">then</span> <span class="main">{</span>None<span class="main">}</span> <span class="keyword1">else</span> Some<span class="main">`</span><span class="bound">as</span>"</span></span>
  
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity">stutter_extend_ex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">stutter_extend_ex</span> <span class="free"><span class="bound"><span class="entity">ex</span></span></span> <span class="main">≡</span> <span class="main">λ</span>None <span class="main">⇒</span> id <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">ex</span></span></span> <span class="bound">a</span>"</span></span>

  <span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">stutter_extend_enex</span> 
    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'s</span><span class="main">⇒</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'a</span> option set<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'s</span> <span class="main">⇒</span> <span class="tfree">'s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">stutter_extend_enex</span> <span class="main">≡</span> map_prod stutter_extend_en stutter_extend_ex"</span></span>
  
  <span class="keyword1" id="Stuttering_Extension-stutter_extend_pred_of_enex_conv"><span class="command">lemma</span></span> stutter_extend_pred_of_enex_conv<span class="main">:</span>
    <span class="quoted"><span class="quoted">"stutter_extend_edges UNIV <span class="main">(</span>rel_of_enex <span class="free">enex</span><span class="main">)</span> <span class="main">=</span> rel_of_enex <span class="main">(</span>stutter_extend_enex <span class="free">enex</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_of_enex_def stutter_extend_edges_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stutter_extend_en_def stutter_extend_ex_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  
  <span class="keyword1" id="Stuttering_Extension-stutter_extend_en_Some_eq"><span class="command">lemma</span></span> stutter_extend_en_Some_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"Some <span class="free">a</span> <span class="main">∈</span> stutter_extend_en <span class="free">en</span> <span class="free">gc</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">en</span> <span class="free">gc</span>"</span></span>
    <span class="quoted"><span class="quoted">"stutter_extend_ex <span class="free">ex</span> <span class="main">(</span>Some <span class="free">a</span><span class="main">)</span> <span class="free">gc</span> <span class="main">=</span> <span class="free">ex</span> <span class="free">a</span> <span class="free">gc</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_en_def stutter_extend_ex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
  <span class="keyword1" id="Stuttering_Extension-stutter_extend_ex_None_eq"><span class="command">lemma</span></span> stutter_extend_ex_None_eq<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"stutter_extend_ex <span class="free">ex</span> None <span class="main">=</span> id"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> stutter_extend_ex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Digraph_Impl">
<div class="head">
<h1>Theory Digraph_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementing Graphs›</span></span>
<span class="comment1">(* Author: Peter Lammich *)</span>
<span class="keyword1"><span class="command">theory</span></span> Digraph_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Digraph.html">Digraph</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Directed Graphs by Successor Function›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> slg <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">slg_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> slg <span class="main">×</span> <span class="tfree">'b</span> digraph<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  slg_rel_def_internal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">slg_rel</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">≡</span> 
  <span class="main">(</span><span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">→</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">⟩</span>list_set_rel<span class="main">)</span> <span class="keyword1">O</span> br <span class="main">(</span><span class="main">λ</span><span class="bound">succs</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">succs</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Impl-slg_rel_def"><span class="command">lemma</span></span> slg_rel_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">=</span> 
  <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel<span class="main">)</span> <span class="keyword1">O</span> br <span class="main">(</span><span class="main">λ</span><span class="bound">succs</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">succs</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> slg_rel_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Digraph_Impl-slg_rel_sv"><span class="command">lemma</span></span> slg_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">R</span><span class="main">;</span> Range <span class="free">R</span> <span class="main">=</span> UNIV<span class="main">⟧</span> <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> slg_rel_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">tagged_solver</span><span class="main">)</span>

<span class="keyword1"><span class="command">consts</span></span> i_slg <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface"</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">slg_rel</span> <span class="quoted">i_slg</span><span class="main">]</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_slg_succs</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">``</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"op_slg_succs <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">≡</span> op_slg_succs<span class="main">$</span><span class="free">E</span><span class="main">$</span><span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Digraph_Impl-refine_slg_succs"><span class="command">lemma</span></span> refine_slg_succs<span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">succs</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">succs</span> <span class="bound">v</span><span class="main">,</span>op_slg_succs<span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel<span class="main">→</span><span class="free">R</span><span class="main">→</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> fun_relI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> slg_rel_def br_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">E_of_succ</span> <span class="free"><span class="bound"><span class="entity">succ</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">succ</span></span></span> <span class="bound">u</span> <span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">succ_of_E</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">{</span><span class="bound">v</span> <span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">E</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Impl-E_of_succ_of_E"><span class="command">lemma</span></span> E_of_succ_of_E<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"E_of_succ <span class="main">(</span>succ_of_E <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> E_of_succ_def succ_of_E_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Impl-succ_of_E_of_succ"><span class="command">lemma</span></span> succ_of_E_of_succ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"succ_of_E <span class="main">(</span>E_of_succ <span class="free">E</span><span class="main">)</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> E_of_succ_def succ_of_E_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"E_of_succ <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"succ_of_E <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">I</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Digraph_Impl-E_of_succ_refine"><span class="command">lemma</span></span> E_of_succ_refine<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">,</span> E_of_succ<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel<span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">,</span> succ_of_E<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> E_of_succ_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> succ_of_E_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> slg_rel_def br_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">clarsimp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fun_relD<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Restricting Edges›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_graph_restrict</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set <span class="main">⇒</span> <span class="tfree">'v</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_graph_restrict</span> <span class="free"><span class="bound"><span class="entity">Vl</span></span></span> <span class="free"><span class="bound"><span class="entity">Vr</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">Vl</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">Vr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_graph_restrict_left</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_graph_restrict_left</span> <span class="free"><span class="bound"><span class="entity">Vl</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">Vl</span></span></span> <span class="main">×</span> UNIV"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">op_graph_restrict_right</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'v</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'v</span> <span class="main">×</span> <span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_graph_restrict_right</span> <span class="free"><span class="bound"><span class="entity">Vr</span></span></span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">E</span></span></span> <span class="main">∩</span> UNIV <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">Vr</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Vl</span> <span class="main">×</span> <span class="free">Vr</span><span class="main">)</span> <span class="main">≡</span> op_graph_restrict <span class="free">Vl</span> <span class="free">Vr</span> <span class="free">E</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∩</span> <span class="main">(</span><span class="free">Vl</span> <span class="main">×</span> UNIV<span class="main">)</span> <span class="main">≡</span> op_graph_restrict_left <span class="free">Vl</span> <span class="free">E</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="free">Vr</span><span class="main">)</span> <span class="main">≡</span> op_graph_restrict_right <span class="free">Vr</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Digraph_Impl-graph_restrict_aimpl"><span class="command">lemma</span></span> graph_restrict_aimpl<span class="main">:</span> <span class="quoted"><span class="quoted">"op_graph_restrict <span class="free">Vl</span> <span class="free">Vr</span> <span class="free">E</span> <span class="main">=</span> 
  E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span><span class="main">∈</span><span class="free">Vl</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">Vr</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def succ_of_E_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1" id="Digraph_Impl-graph_restrict_left_aimpl"><span class="command">lemma</span></span> graph_restrict_left_aimpl<span class="main">:</span> <span class="quoted"><span class="quoted">"op_graph_restrict_left <span class="free">Vl</span> <span class="free">E</span> <span class="main">=</span> 
  E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">v</span><span class="main">∈</span><span class="free">Vl</span> <span class="keyword1">then</span> <span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def succ_of_E_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1" id="Digraph_Impl-graph_restrict_right_aimpl"><span class="command">lemma</span></span> graph_restrict_right_aimpl<span class="main">:</span> <span class="quoted"><span class="quoted">"op_graph_restrict_right <span class="free">Vr</span> <span class="free">E</span> <span class="main">=</span> 
  E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">E</span><span class="main">``</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">Vr</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def succ_of_E_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> graph_restrict_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rsl</span> <span class="free">Rsr</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsl</span></span> <span class="quoted">i_set</span><span class="main">]</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsr</span></span> <span class="quoted">i_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">meml</span><span class="main">,</span> <span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsl</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">memr</span><span class="main">,</span> <span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsr</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> op_graph_restrict<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsl</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsr</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> graph_restrict_aimpl<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> graph_restrict_left_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rsl</span> <span class="free">Rsr</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsl</span></span> <span class="quoted">i_set</span><span class="main">]</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsr</span></span> <span class="quoted">i_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">meml</span><span class="main">,</span> <span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsl</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> op_graph_restrict_left<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsl</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> graph_restrict_left_aimpl<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> graph_restrict_right_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rsl</span> <span class="free">Rsr</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsl</span></span> <span class="quoted">i_set</span><span class="main">]</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Rsr</span></span> <span class="quoted">i_set</span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">memr</span><span class="main">,</span> <span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsr</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> op_graph_restrict_right<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span><span class="free">Rsr</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> graph_restrict_right_aimpl<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span> <span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">graph_restrict_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> graph_restrict_impl_aux
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">graph_restrict_left_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> graph_restrict_left_impl_aux
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">graph_restrict_right_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> graph_restrict_right_impl_aux

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
    <span class="quoted"><span class="quoted">"op_graph_restrict <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg"</span></span>
    <span class="quoted"><span class="quoted">"op_graph_restrict_right <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg"</span></span>
    <span class="quoted"><span class="quoted">"op_graph_restrict_left <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules_raw</span><span class="main">]</span> <span class="main">=</span> 
  graph_restrict_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D GEN_OP_D<span class="main">]</span>
  graph_restrict_left_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D<span class="main">]</span>
  graph_restrict_right_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="main">(</span><span class="bound">E</span><span class="main">::</span>nat digraph<span class="main">)</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">E</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Impl-graph_minus_aimpl"><span class="command">lemma</span></span> graph_minus_aimpl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E1</span> <span class="free">E2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E1</span><span class="main">-</span><span class="free">E2</span> <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">E1</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="main">-</span> <span class="free">E2</span><span class="main">``</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> graph_minus_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> <span class="main">(-)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> graph_minus_aimpl<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> graph_minus_impl_aux<span class="main">[</span><span class="operator">OF</span> GEN_OP_D<span class="main">]</span>


<span class="keyword1" id="Digraph_Impl-graph_minus_set_aimpl"><span class="command">lemma</span></span> graph_minus_set_aimpl<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">E1</span> <span class="free">E2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">E1</span><span class="main">-</span><span class="free">E2</span> <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span><span class="main">∈</span><span class="free">E1</span><span class="main">``</span><span class="main">{</span><span class="bound">u</span><span class="main">}</span><span class="main">.</span> <span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">∉</span><span class="free">E2</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> graph_minus_set_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span><span class="main">(=)</span><span class="main">)</span><span class="main">∈</span><span class="free">R</span><span class="main">→</span><span class="free">R</span><span class="main">→</span>bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">mem</span><span class="main">,</span><span class="main">(∈)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">R</span><span class="main">⟩</span><span class="free">Rs</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> <span class="main">(-)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span><span class="free">R</span><span class="main">⟩</span><span class="free">Rs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> graph_minus_set_aimpl<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">,</span></span><span class="quasi_keyword">trace</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span> <span class="main"><span class="main">(</span></span><span class="keyword2"><span class="keyword"><span class="quasi_keyword">overloaded</span></span></span><span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="main">=</span> graph_minus_set_impl_aux<span class="main">[</span><span class="operator">OF</span> GEN_OP_D GEN_OP_D<span class="main">]</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Rooted Graphs›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Operation Identification Setup›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_g_ext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_frg</span> <span class="main">≡</span> <span class="main">⟨</span>i_unit<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Digraph_Impl-g_type"><span class="command">lemma</span></span> g_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"g_V <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="quoted"><span class="quoted">"g_E <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg"</span></span>
  <span class="quoted"><span class="quoted">"g_V0 <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="quoted"><span class="quoted">"graph_rec_ext
    <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_slg <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">iE</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">I</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Generic Implementation›</span></span>
<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">)</span> gen_g_impl <span class="main">=</span>
  gi_V <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'vi</span></span></span>
  gi_E <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'ei</span></span></span>
  gi_V0 <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'v0i</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_g_impl_rel_ext_internal_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="free">gen_g_impl_rel_ext</span> <span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span>
  <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>gen_g_impl_ext <span class="bound">Vi</span> <span class="bound">Ei</span> <span class="bound">V0i</span> <span class="bound">mi</span><span class="main">,</span> graph_rec_ext <span class="bound">V</span> <span class="bound">E</span> <span class="bound">V0</span> <span class="bound">m</span><span class="main">)</span> 
      <span class="main">|</span> <span class="bound">Vi</span> <span class="bound">Ei</span> <span class="bound">V0i</span> <span class="bound">mi</span> <span class="bound">V</span> <span class="bound">E</span> <span class="bound">V0</span> <span class="bound">m</span><span class="main">.</span> 
        <span class="main">(</span><span class="bound">Vi</span><span class="main">,</span><span class="bound">V</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rv</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Ei</span><span class="main">,</span><span class="bound">E</span><span class="main">)</span><span class="main">∈</span><span class="bound">Re</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">V0i</span><span class="main">,</span><span class="bound">V0</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rv0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rm</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1" id="Digraph_Impl-gen_g_impl_rel_ext_def"><span class="command">lemma</span></span> gen_g_impl_rel_ext_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext
  <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>gen_g_impl_ext <span class="bound">Vi</span> <span class="bound">Ei</span> <span class="bound">V0i</span> <span class="bound">mi</span><span class="main">,</span> graph_rec_ext <span class="bound">V</span> <span class="bound">E</span> <span class="bound">V0</span> <span class="bound">m</span><span class="main">)</span> 
      <span class="main">|</span> <span class="bound">Vi</span> <span class="bound">Ei</span> <span class="bound">V0i</span> <span class="bound">mi</span> <span class="bound">V</span> <span class="bound">E</span> <span class="bound">V0</span> <span class="bound">m</span><span class="main">.</span> 
        <span class="main">(</span><span class="bound">Vi</span><span class="main">,</span><span class="bound">V</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rv</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">Ei</span><span class="main">,</span><span class="bound">E</span><span class="main">)</span><span class="main">∈</span><span class="bound">Re</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">V0i</span><span class="main">,</span><span class="bound">V0</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rv0</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="bound">Rm</span>
    <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_g_impl_rel_ext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Digraph_Impl-gen_g_impl_rel_sv"><span class="command">lemma</span></span> gen_g_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">⟦</span>single_valued <span class="bound">Rv</span><span class="main">;</span> single_valued <span class="bound">Re</span><span class="main">;</span> single_valued <span class="bound">Rv0</span><span class="main">;</span> single_valued <span class="bound">Rm</span> <span class="main">⟧</span> <span class="main">⟹</span> 
  single_valued <span class="main">(</span><span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> single_valuedI 
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> single_valuedD slg_rel_sv list_set_rel_sv<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="Digraph_Impl-gen_g_refine"><span class="command">lemma</span></span> gen_g_refine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">(</span>gi_V<span class="main">,</span>g_V<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext <span class="main">→</span> <span class="bound">Rv</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">(</span>gi_E<span class="main">,</span>g_E<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext <span class="main">→</span> <span class="bound">Re</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">(</span>gi_V0<span class="main">,</span>g_V0<span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext <span class="main">→</span> <span class="bound">Rv0</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Rm</span> <span class="bound">Rv</span> <span class="bound">Re</span> <span class="bound">Rv0</span><span class="main">.</span> <span class="main">(</span>gen_g_impl_ext<span class="main">,</span> graph_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="bound">Rv</span> <span class="main">→</span> <span class="bound">Re</span> <span class="main">→</span> <span class="bound">Rv0</span> <span class="main">→</span> <span class="bound">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="bound">Rm</span><span class="main">,</span><span class="bound">Rv</span><span class="main">,</span><span class="bound">Re</span><span class="main">,</span><span class="bound">Rv0</span><span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with list-set for Nodes›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> frgv_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> list<span class="main">,</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> list<span class="main">,</span> <span class="tfree">'v</span> list<span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> gen_g_impl_scheme"</span></span>

<span class="keyword1"><span class="command">definition</span></span> frgv_impl_rel_ext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">frgv_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>list_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>

<span class="keyword1" id="Digraph_Impl-frgv_impl_rel_ext_def"><span class="command">lemma</span></span> frgv_impl_rel_ext_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>frgv_impl_rel_ext
  <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frgv_impl_rel_ext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"REL_INTF frgv_impl_rel_ext i_g_ext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REL_INTFI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rv</span><span class="main">;</span> Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>frgv_impl_rel_ext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> frgv_impl_rel_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_g_refine<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
  Rv <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>list_set_rel"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> Re <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>slg_rel"</span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> <span class="var">?Rv0.0</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>list_set_rel"</span></span></span></span></span>
  <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main">,</span> <span class="operator">folded</span> frgv_impl_rel_ext_def<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with Cfun for Nodes›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This implementation allows for the universal node set.›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> g_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span> <span class="main">⇒</span> bool<span class="main">,</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'v</span> list<span class="main">,</span> <span class="tfree">'v</span> list<span class="main">,</span> <span class="tfree">'m</span><span class="main">)</span> gen_g_impl_scheme"</span></span>

<span class="keyword1"><span class="command">definition</span></span> g_impl_rel_ext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">g_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>fun_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>

<span class="keyword1" id="Digraph_Impl-g_impl_rel_ext_def"><span class="command">lemma</span></span> g_impl_rel_ext_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext
  <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_impl_rel_ext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"REL_INTF g_impl_rel_ext i_g_ext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> REL_INTFI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rv</span><span class="main">;</span> Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_impl_rel_ext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">param</span><span class="main">,</span> <span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_g_refine<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> 
  Rv <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>fun_set_rel"</span></span></span></span></span> 
  <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> Re <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>slg_rel"</span></span></span></span></span> 
  <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span></span></span> <span class="var">?Rv0.0</span> <span class="main"><span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main"><span class="main">⟨</span></span></span></span><span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">⟩</span></span></span></span>list_set_rel"</span></span></span></span></span> 
  <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">for</span></span></span></span></span></span> <span class="free"><span class="free"><span class="free"><span class="free">Rv</span></span></span></span><span class="main">,</span> <span class="operator">folded</span> g_impl_rel_ext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gi_V_update<span class="main">,</span> g_V_update<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span> <span class="main">→</span>
  <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_impl_rel_ext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> tagged_fun_relD_both<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gi_E_update<span class="main">,</span> g_E_update<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel<span class="main">)</span> <span class="main">→</span>
  <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_impl_rel_ext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> tagged_fun_relD_both<span class="main">)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>gi_V0_update<span class="main">,</span> g_V0_update<span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">)</span> <span class="main">→</span>
  <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> g_impl_rel_ext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> tagged_fun_relD_both<span class="main">)</span>

<span class="comment1">(* HACK: The homgeneity rule heuristics erronously creates a homogeneity rule that
    equalizes Rv and Rv0, out of the frv-implementation, which happens to be the
    first. This declaration counters the undesired effects caused by this. *)</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_hom</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"CONSTRAINT graph_rec_ext <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span><span class="free">Rvs</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span><span class="free">Res</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span><span class="free">Rv0s</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span><span class="free">Rg</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span><span class="main">.</span> g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span><span class="main">λ</span><span class="bound">V0</span> <span class="bound">E</span><span class="main">.</span>
   <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span> <span class="main">⦈</span>  <span class="main">)</span>
  <span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>g_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span><span class="main">λ</span><span class="bound">V</span> <span class="bound">V0</span> <span class="bound">E</span><span class="main">.</span>
   <span class="main">⦇</span> g_V <span class="main">=</span> <span class="bound">V</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span> <span class="main">⦈</span>  <span class="main">)</span>
  <span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> <span class="main">⟨</span>unit_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Renaming›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_inv_into_map</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> 
  <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">then</span> Some <span class="main">(</span>the_inv_into <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>

<span class="keyword1" id="Digraph_Impl-the_inv_into_map_None"><span class="command">lemma</span></span> the_inv_into_map_None<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_inv_into_map <span class="free">V</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="free">x</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_inv_into_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Impl-the_inv_into_map_Some'"><span class="command">lemma</span></span> the_inv_into_map_Some'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_inv_into_map <span class="free">V</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">V</span> <span class="main">∧</span> <span class="free">y</span><span class="main">=</span>the_inv_into <span class="free">V</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_inv_into_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Digraph_Impl-the_inv_into_map_Some"><span class="command">lemma</span></span> the_inv_into_map_Some<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">V</span> <span class="main">⟹</span> the_inv_into_map <span class="free">V</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span><span class="main">∈</span><span class="free">V</span> <span class="main">∧</span> <span class="free">x</span><span class="main">=</span><span class="free">f</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_map_Some' the_inv_into_f_f<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_inv_into_map_impl</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> 
  FOREACH <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">m</span><span class="main">.</span> RETURN <span class="main">(</span><span class="bound">m</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">↦</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> Map.empty"</span></span>

<span class="keyword1" id="Digraph_Impl-the_inv_into_map_impl_correct"><span class="command">lemma</span></span> the_inv_into_map_impl_correct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"the_inv_into_map_impl <span class="free">V</span> <span class="free">f</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> the_inv_into_map <span class="free">V</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_inv_into_map_impl_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> 
    FOREACH_rule<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> I<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">it</span> <span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">=</span>the_inv_into_map <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="bound">it</span><span class="main">)</span> <span class="free">f</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="dynamic"><span class="dynamic">refine_vcg</span></span>
  <span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">vc_solve</span> 
    <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> the_inv_into_map_def<span class="main"><span class="main">[</span></span><span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> it_step_insert_iff 
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> allI impI conjI<span class="main">)</span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> the_inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> the_inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>

  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> the_inv_into_f_f<span class="main"><span class="main">[</span></span><span class="operator">OF</span> subset_inj_on<span class="main"><span class="main">[</span></span><span class="operator">OF</span> INJ<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> the_inv_into_map_code_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vti</span> <span class="main">×</span> <span class="tfree">'vt</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">Rv'</span> <span class="free">eq</span> <span class="free">bhc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'vti</span><span class="main">)</span> <span class="main">(</span><span class="free">def_size</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Vi</span><span class="main">,</span><span class="free">V</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>RETURN <span class="var">?c</span><span class="main">,</span> the_inv_into_map_impl <span class="free">V</span> <span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv'</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>ahm_rel <span class="free">bhc</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_inv_into_map_impl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref_monadic</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">plain</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">the_inv_into_map_code</span> <span class="keyword2"><span class="keyword">uses</span></span> the_inv_into_map_code_aux
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">the_inv_into_map_code</span></span> <span class="keyword2"><span class="keyword">checking</span></span> SML

<span class="keyword1"><span class="command">thm</span></span> the_inv_into_map_code.refine

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Digraph_Impl-autoref_the_inv_into_map"><span class="command">lemma</span></span> autoref_the_inv_into_map<span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vti</span> <span class="main">×</span> <span class="tfree">'vt</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_bounded_hashcode <span class="free">Rv'</span> <span class="free">eq</span> <span class="free">bhc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_GEN_ALGO <span class="main">(</span>is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'vti</span><span class="main">)</span> <span class="free">def_size</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> INJ<span class="main">:</span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>inj_on <span class="free">f</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Vi</span><span class="main">,</span><span class="free">V</span><span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">fi</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">∈</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rv'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the_inv_into_map_code <span class="free">eq</span> <span class="free">bhc</span> <span class="free">def_size</span> <span class="free">Vi</span> <span class="free">fi</span><span class="main">,</span> 
    <span class="main">(</span><span class="keyword1">OP</span> the_inv_into_map 
      <span class="main">:::</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">(</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rv'</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rv'</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>Impl_Array_Hash_Map.ahm_rel <span class="free">bhc</span><span class="main">)</span>
    <span class="main">$</span><span class="free">V</span><span class="main">$</span><span class="free">f</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv'</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>Impl_Array_Hash_Map.ahm_rel <span class="free">bhc</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> V <span class="keyword1"><span class="command">have</span></span> FIN<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list_set_rel_range <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">note</span></span> the_inv_into_map_code.refine<span class="main">[</span>
    <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-2<span class="main"><span class="main">,</span></span>4-5<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">THEN</span> nres_relD 
  <span class="main">]</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">note</span></span> the_inv_into_map_impl_correct<span class="main">[</span><span class="operator">OF</span> FIN INJ<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> <span class="dynamic"><span class="dynamic">autoref_tag_defs</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the_inv_into_map_code <span class="free">eq</span> <span class="free">bhc</span> <span class="free">def_size</span> <span class="free">Vi</span> <span class="free">fi</span><span class="main">,</span> the_inv_into_map <span class="free">V</span> <span class="free">f</span><span class="main">)</span>
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv'</span><span class="main">,</span> <span class="free">Rv</span><span class="main">⟩</span>Impl_Array_Hash_Map.ahm_rel <span class="free">bhc</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">refine_pw_simps</span></span> pw_le_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="keyword1">do</span> <span class="main">{</span> 
  <span class="keyword1">let</span> <span class="bound">s</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">,</span><span class="numeral">3</span><span class="main">::</span>nat<span class="main">}</span><span class="main">;</span> 
  <span class="comment1">⌦‹ASSERT (inj_on Suc s);›</span>
  RETURN <span class="main">(</span>the_inv_into_map <span class="bound">s</span> Suc<span class="main">)</span> <span class="main">}</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fr_rename_ext_aimpl</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> <span class="keyword1">do</span> <span class="main">{</span>
    ASSERT <span class="main">(</span>inj_on <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    ASSERT <span class="main">(</span>inj_on <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">;</span>
    <span class="keyword1">let</span> <span class="bound">fi_map</span> <span class="main">=</span> the_inv_into_map <span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">;</span>
    <span class="bound">e</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="bound">fi_map</span> <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">;</span>
    RETURN <span class="main">⦇</span>
      g_V <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="main">(</span>g_V <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
      g_E <span class="main">=</span> <span class="main">(</span>E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">fi_map</span> <span class="bound">v</span> <span class="keyword1">of</span>
          Some <span class="bound">u</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">`</span> <span class="main">(</span>succ_of_E <span class="main">(</span>g_E <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span> <span class="bound">u</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      g_V0 <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span>g_V0 <span class="free"><span class="bound"><span class="entity">G</span></span></span><span class="main">)</span><span class="main">,</span>
      <span class="main">…</span> <span class="main">=</span> <span class="bound">e</span>
    <span class="main">⦈</span>
  <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> g_rename_precond <span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fi_map</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span>V <span class="keyword1">then</span> Some <span class="main">(</span>fi <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1" id="Digraph_Impl-fi_map_alt"><span class="command">lemma</span></span> fi_map_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"fi_map <span class="main">=</span> the_inv_into_map V <span class="free">f</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fi_map_def the_inv_into_map_def fi_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
  <span class="keyword1" id="Digraph_Impl-fi_map_Some"><span class="command">lemma</span></span> fi_map_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fi_map <span class="free">u</span> <span class="main">=</span> Some <span class="free">v</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">u</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span>V <span class="main">∧</span> fi <span class="free">u</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fi_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1" id="Digraph_Impl-fi_map_None"><span class="command">lemma</span></span> fi_map_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fi_map <span class="free">u</span> <span class="main">=</span> None<span class="main">)</span> <span class="main">⟷</span> <span class="free">u</span><span class="main">∉</span><span class="free">f</span><span class="main">`</span>V"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fi_map_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>

  <span class="keyword1" id="Digraph_Impl-rename_E_aimpl_alt"><span class="command">lemma</span></span> rename_E_aimpl_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"rename_E <span class="free">f</span> E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">case</span> fi_map <span class="bound">v</span> <span class="keyword1">of</span>
    Some <span class="bound">u</span> <span class="main">⇒</span> <span class="free">f</span> <span class="main">`</span> <span class="main">(</span>succ_of_E E <span class="bound">u</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> E_of_succ_def succ_of_E_def
    <span class="keyword1"><span class="command">using</span></span> E_ss
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> 
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fi_f f_fi fi_map_Some fi_map_None 
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm option.splits<span class="main">)</span>


  <span class="keyword1" id="Digraph_Impl-frv_rename_ext_aimpl_alt"><span class="command">lemma</span></span> frv_rename_ext_aimpl_alt<span class="main">:</span> 
    <span class="keyword2"><span class="keyword">assumes</span></span> ECNV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ecnv'</span> fi_map <span class="free">G</span> <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fr_rename_ext_aimpl <span class="free">ecnv'</span> <span class="free">f</span> <span class="free">G</span> 
      <span class="main">≤</span> SPEC <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> fr_rename_ext <span class="free">ecnv</span> <span class="free">f</span> <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">(*have [simp]: "⦇ g_E =
             E_of_succ
              (λv. case the_inv_into_map V f v of None ⇒ {}
                 | Some u ⇒ f ` succ_of_E (g_E G) u),
            g_V0 = f ` g_V0 G, … = ecnv Gv⦈
      = frv_G (frv_rename_ext ecnv f Gv)"
      unfolding frv_rename_ext_def 
      by (auto simp: rename_E_aimpl_alt fi_map_alt)

    have [simp]: "⦇frv_V = f ` V, frv_G = frv_G Gv'⦈ = Gv'"
      unfolding frv_rename_ext_def
      by simp*)</span>

    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> fr_rename_ext_def fr_rename_ext_aimpl_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">refine_rcg</span> 
        order_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ECNV<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> fi_map_alt<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span> 
        <span class="dynamic"><span class="dynamic">refine_vcg</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> subset_inj_on<span class="main">[</span><span class="operator">OF</span> _ V0_ss<span class="main">]</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> INJ <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rename_E_aimpl_alt fi_map_alt<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">term</span></span> <span class="quoted"><span class="free">frv_rename_ext_aimpl</span></span>
<span class="keyword1"><span class="command">schematic_goal</span></span> fr_rename_ext_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Rv'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vti</span> <span class="main">×</span> <span class="tfree">'vt</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">eq</span><span class="main">,</span> <span class="main">(=)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Rv'</span> <span class="main">→</span> <span class="free">Rv'</span> <span class="main">→</span> bool_rel"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">Rv'</span> <span class="free">eq</span> <span class="free">bhc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'vti</span><span class="main">)</span> <span class="free">def_size</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span>fr_rename_ext_aimpl<span class="main">)</span> <span class="main">∈</span> 
    <span class="main">(</span><span class="main">(</span><span class="main">⟨</span><span class="free">Rv'</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>ahm_rel <span class="free">bhc</span><span class="main">)</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>frgv_impl_rel_ext <span class="main">→</span> <span class="main">⟨</span><span class="free">Re'</span><span class="main">⟩</span>nres_rel<span class="main">)</span> <span class="main">→</span>   
    <span class="main">(</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rv'</span><span class="main">)</span> <span class="main">→</span>
    <span class="main">⟨</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>frgv_impl_rel_ext <span class="main">→</span> 
    <span class="main">⟨</span><span class="main">⟨</span><span class="free">Re'</span><span class="main">,</span><span class="free">Rv'</span><span class="main">⟩</span>frgv_impl_rel_ext<span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fr_rename_ext_aimpl_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">fr_rename_ext_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> fr_rename_ext_impl_aux

<span class="keyword1"><span class="command">thm</span></span> fr_rename_ext_impl.refine<span class="main">[</span><span class="operator">OF</span> GEN_OP_D SIDE_GEN_ALGO_D SIDE_GEN_ALGO_D<span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Graphs from Lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">succ_of_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat<span class="main">×</span>nat<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">succ_of_list</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≡</span> <span class="keyword1">let</span>
    <span class="bound">m</span> <span class="main">=</span> fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="bound">g</span><span class="main">.</span> 
          <span class="keyword1">case</span> <span class="bound">g</span> <span class="bound">u</span> <span class="keyword1">of</span> 
            None <span class="main">⇒</span> <span class="bound">g</span><span class="main">(</span><span class="bound">u</span><span class="main">↦</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">)</span>
          <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">g</span><span class="main">(</span><span class="bound">u</span><span class="main">↦</span>insert <span class="bound">v</span> <span class="bound">s</span><span class="main">)</span>
        <span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> Map.empty
  <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">m</span> <span class="bound">u</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">{}</span> <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
    
<span class="keyword1" id="Digraph_Impl-succ_of_list_correct_aux"><span class="command">lemma</span></span> succ_of_list_correct_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span>succ_of_list <span class="free">l</span><span class="main">,</span> set <span class="free">l</span><span class="main">)</span> <span class="main">∈</span> br <span class="main">(</span><span class="main">λ</span><span class="bound">succs</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="bound">succs</span> <span class="bound">u</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>

  <span class="keyword1"><span class="command">term</span></span> <span class="quoted">the_default</span>

  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">u</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span> <span class="bound">g</span><span class="main">.</span> 
            <span class="keyword1">case</span> <span class="bound">g</span> <span class="bound">u</span> <span class="keyword1">of</span> 
              None <span class="main">⇒</span> <span class="bound">g</span><span class="main">(</span><span class="bound">u</span><span class="main">↦</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">)</span>
            <span class="main">|</span> Some <span class="bound">s</span> <span class="main">⇒</span> <span class="bound">g</span><span class="main">(</span><span class="bound">u</span><span class="main">↦</span>insert <span class="bound">v</span> <span class="bound">s</span><span class="main">)</span>
          <span class="main">)</span> <span class="free">l</span> <span class="skolem">m</span> 
      <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">u</span><span class="main">.</span> <span class="keyword1">let</span> <span class="bound">s</span><span class="main">=</span>set <span class="free">l</span> <span class="main">``</span> <span class="main">{</span><span class="bound">u</span><span class="main">}</span> <span class="keyword1">in</span> 
          <span class="keyword1">if</span> <span class="bound">s</span><span class="main">=</span><span class="main">{}</span> <span class="keyword1">then</span> <span class="skolem">m</span> <span class="bound">u</span> <span class="keyword1">else</span> Some <span class="main">(</span>the_default <span class="main">{}</span> <span class="main">(</span><span class="skolem">m</span> <span class="bound">u</span><span class="main">)</span> <span class="main">∪</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> 
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.split if_split 
        <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def Image_def
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">}</span></span> <span class="keyword1"><span class="command">note</span></span> aux<span class="main">=</span>this
  
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> succ_of_list_def aux
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> br_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> succ_of_list_impl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> 
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nat<span class="main">⇀</span>nat set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>nat_rel<span class="main">,</span><span class="free">R</span><span class="main">⟩</span>iam_map_rel"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">for</span></span></span> <span class="free">R</span><span class="main">]</span>
    ty_REL<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="tfree">'a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> R<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">⟨</span>nat_rel<span class="main">⟩</span>list_set_rel"</span></span><span class="main">]</span>

  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?f</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span>succ_of_list<span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> succ_of_list_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">succ_of_list_impl</span> <span class="keyword2"><span class="keyword">uses</span></span> succ_of_list_impl
<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">succ_of_list_impl</span></span> <span class="keyword2"><span class="keyword">in</span></span> SML

<span class="keyword1" id="Digraph_Impl-succ_of_list_impl_correct"><span class="command">lemma</span></span> succ_of_list_impl_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>succ_of_list_impl<span class="main">,</span>set<span class="main">)</span> <span class="main">∈</span> Id <span class="main">→</span> <span class="main">⟨</span>Id<span class="main">⟩</span>slg_rel"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command">unfolding</span></span> slg_rel_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">rule</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succ_of_list_impl.refine<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> fun_relD<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> succ_of_list_correct_aux<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Automata_Impl">
<div class="head">
<h1>Theory Automata_Impl</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Implementing Automata›</span></span>
<span class="comment1">(* Author: Peter Lammich *)</span>
<span class="keyword1"><span class="command">theory</span></span> Automata_Impl
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Digraph_Impl.html">Digraph_Impl</a> <a href="Automata.html">Automata</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexed Generalized Buchi Graphs›</span></span>


<span class="keyword1"><span class="command">consts</span></span>
  i_igbg_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_igbg</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_igbg_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Automata_Impl-igbg_type"><span class="command">lemma</span></span> igbg_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"igbg_num_acc <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_igbg <span class="free">Ie</span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_nat"</span></span>
  <span class="quoted"><span class="quoted">"igbg_acc <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_igbg <span class="free">Ie</span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span>i_nat<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="quoted"><span class="quoted">"igb_graph_rec_ext
    <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_nat <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span>i_nat<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_igbg_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'acci</span><span class="main">)</span> gen_igbg_impl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">)</span> gen_g_impl"</span></span> <span class="main">+</span>
  igbgi_num_acc <span class="main">::</span> <span class="quoted">nat</span>
  igbgi_acc <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'acci</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_igbg_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_igbg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Racc</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> igbgi_num_acc <span class="main">=</span> <span class="bound">num_acci</span><span class="main">,</span> igbgi_acc <span class="main">=</span> <span class="bound">acci</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">num_acci</span> <span class="bound">acci</span> <span class="bound">mi</span> <span class="bound">num_acc</span> <span class="bound">acc</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">num_acci</span><span class="main">,</span><span class="bound">num_acc</span><span class="main">)</span><span class="main">∈</span>nat_rel 
  <span class="main">∧</span> <span class="main">(</span><span class="bound">acci</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Racc</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_igbg_impl_rel_eext_def"><span class="command">lemma</span></span> gen_igbg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Racc</span><span class="main">⟩</span>gen_igbg_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> igbgi_num_acc <span class="main">=</span> <span class="bound">num_acci</span><span class="main">,</span> igbgi_acc <span class="main">=</span> <span class="bound">acci</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">num_acci</span> <span class="bound">acci</span> <span class="bound">mi</span> <span class="bound">num_acc</span> <span class="bound">acc</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">num_acci</span><span class="main">,</span><span class="bound">num_acc</span><span class="main">)</span><span class="main">∈</span>nat_rel 
  <span class="main">∧</span> <span class="main">(</span><span class="bound">acci</span><span class="main">,</span><span class="bound">acc</span><span class="main">)</span><span class="main">∈</span><span class="free">Racc</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igbg_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_igbg_impl_rel_sv"><span class="command">lemma</span></span> gen_igbg_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Racc</span><span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Racc</span><span class="main">⟩</span>gen_igbg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igbg_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_igbg_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="main">_</span><span class="main">)</span>igb_graph_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_igbg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Racc</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Racc</span></span></span><span class="main">⟩</span>gen_igbg_impl_rel_eext<span class="main">⟩</span>gen_g_impl_rel_ext "</span></span>

<span class="keyword1" id="Automata_Impl-gen_igbg_refine"><span class="command">lemma</span></span> gen_igbg_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span> <span class="free">Racc</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Racc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>igbgi_num_acc<span class="main">,</span>igbg_num_acc<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_igbg_impl_rel_ext <span class="free">Rm</span> <span class="free">Racc</span> <span class="main">→</span> nat_rel"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>igbgi_acc<span class="main">,</span>igbg_acc<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_igbg_impl_rel_ext <span class="free">Rm</span> <span class="free">Racc</span> <span class="main">→</span> <span class="free">Racc</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_igbg_impl_ext<span class="main">,</span> igb_graph_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> nat_rel <span class="main">→</span> <span class="free">Racc</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Racc</span><span class="main">⟩</span>gen_igbg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igbg_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with bit-set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> igbg_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">igbg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>bs_set_rel<span class="main">⟩</span>gen_igbg_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-igbg_impl_rel_eext_def"><span class="command">lemma</span></span> igbg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>igbg_impl_rel_eext <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>bs_set_rel<span class="main">⟩</span>gen_igbg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> igbg_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">igbg_impl_rel_eext</span> <span class="quoted">i_igbg_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>igbg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> igbg_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-g_tag"><span class="command">lemma</span></span> g_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Automata_Impl-frgv_tag"><span class="command">lemma</span></span> frgv_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>slg_rel<span class="main">,</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Automata_Impl-igbg_bs_tag"><span class="command">lemma</span></span> igbg_bs_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>bs_set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">igbgv_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>igbg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">igbg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>igbg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>g_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> igbgv_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> igbgi_num_acc<span class="main">::</span>nat<span class="main">,</span> igbgi_acc<span class="main">::</span><span class="tfree">'v</span><span class="main">⇒</span>integer<span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> 
    frgv_impl_scheme"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> igbg_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> igbgi_num_acc<span class="main">::</span>nat<span class="main">,</span> igbgi_acc<span class="main">::</span><span class="tfree">'v</span><span class="main">⇒</span>integer<span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> 
    g_impl_scheme"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_igbg_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> igbg_bs_tag<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def igbg_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_igbg_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span> igbg_bs_tag<span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span><span class="operator"><span class="operator"><span class="operator">of</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span></span></span><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def igbg_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>



<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> igbg_num_acc <span class="bound">G</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">1</span><span class="main">∈</span>igbg_acc <span class="bound">G</span> <span class="bound">x</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> 
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>


<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> 
  <span class="main">λ</span><span class="bound">V0</span> <span class="bound">E</span> <span class="bound">num_acc</span> <span class="bound">acc</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>bs_set_rel<span class="main">)</span> 
    <span class="main">→</span> igbg_impl_rel_ext unit_rel <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> 
  <span class="main">λ</span><span class="bound">V0</span> <span class="bound">E</span> <span class="bound">num_acc</span> <span class="bound">acc</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>list_set_rel <span class="main">→</span> <span class="main">⟨</span><span class="free">R</span><span class="main">⟩</span>slg_rel <span class="main">→</span> nat_rel <span class="main">→</span> <span class="main">(</span><span class="free">R</span> <span class="main">→</span> <span class="main">⟨</span>nat_rel<span class="main">⟩</span>bs_set_rel<span class="main">)</span> 
    <span class="main">→</span> igbgv_impl_rel_ext unit_rel <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Indexed Generalized Buchi Automata›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_igba_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_igba</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="free"><span class="bound"><span class="entity">Il</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Il</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_igba_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_igbg_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Automata_Impl-igba_type"><span class="command">lemma</span></span> igba_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"igba_L <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_igba <span class="free">Ie</span> <span class="free">Iv</span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"igba_rec_ext <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="main">,</span><span class="free">Il</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_igba_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'acci</span><span class="main">,</span><span class="tfree">'Li</span><span class="main">)</span> gen_igba_impl <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'acci</span><span class="main">)</span>gen_igbg_impl"</span></span> <span class="main">+</span>
  igbai_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Li</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_igba_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_igba_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span>  <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> igbai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> igba_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_igba_impl_rel_eext_def"><span class="command">lemma</span></span> gen_igba_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_igba_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> igbai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> igba_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igba_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_igba_impl_rel_sv"><span class="command">lemma</span></span> gen_igba_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rl</span><span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_igba_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igba_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_igba_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> igba_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_igba_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
    <span class="main">≡</span> gen_igbg_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>gen_igba_impl_rel_eext<span class="main">)</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_igba_refine"><span class="command">lemma</span></span> gen_igba_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span> <span class="free">Racc</span> <span class="free">Rl</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Racc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rl</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>igbai_L<span class="main">,</span>igba_L<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_igba_impl_rel_ext <span class="free">Rm</span> <span class="free">Rl</span> <span class="free">Racc</span> <span class="main">→</span> <span class="free">Rl</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_igba_impl_ext<span class="main">,</span> igba_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Rl</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_igba_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_igba_impl_rel_eext_def gen_igbg_impl_rel_eext_def
    gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation as function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> igba_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">igba_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">→</span> bool_rel<span class="main">⟩</span>gen_igba_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-igba_impl_rel_eext_def"><span class="command">lemma</span></span> igba_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>igba_impl_rel_eext <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rl</span> <span class="main">→</span> bool_rel<span class="main">⟩</span>gen_igba_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> igba_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">igba_impl_rel_eext</span> <span class="quoted">i_igba_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">;</span> Range <span class="free">Rl</span> <span class="main">=</span> UNIV<span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>igba_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> igba_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-igba_f_tag"><span class="command">lemma</span></span> igba_f_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="free">Rl</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">igbav_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">≡</span> igbgv_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>igba_impl_rel_eext<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">igba_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
  <span class="main">≡</span> igbg_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>igba_impl_rel_eext<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> igbav_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> igbai_L <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'l</span> <span class="main">⇒</span> bool <span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> 
    igbgv_impl_scheme"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> igba_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> igbai_L <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'l</span> <span class="main">⇒</span> bool <span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> 
    igbg_impl_scheme"</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Li</span><span class="main">×</span><span class="tfree">'l</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_igba_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> igbg_bs_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> igba_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rl</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def igbg_impl_rel_eext_def igba_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_igba_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> igbg_bs_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> igba_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rl</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def igbg_impl_rel_eext_def igba_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">autoref_itype</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> igba_L <span class="bound">G</span> <span class="bound">x</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">num_acc</span> <span class="bound">acc</span> <span class="bound">L</span><span class="main">.</span> 
  <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> 
    igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span><span class="main">,</span> igba_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">num_acc</span> <span class="bound">acc</span> <span class="bound">L</span><span class="main">.</span> 
  <span class="main">⦇</span> g_V <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> 
    igbg_num_acc <span class="main">=</span> <span class="bound">num_acc</span><span class="main">,</span> igbg_acc <span class="main">=</span> <span class="bound">acc</span><span class="main">,</span> igba_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generalized Buchi Graphs›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_gbg_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_gbg</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_gbg_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Automata_Impl-gbg_type"><span class="command">lemma</span></span> gbg_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gbg_F <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_gbg <span class="free">Ie</span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="quoted"><span class="quoted">"gb_graph_rec_ext <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_gbg_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'fi</span><span class="main">)</span> gen_gbg_impl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">)</span> gen_g_impl"</span></span> <span class="main">+</span>
  gbgi_F <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'fi</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_gbg_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_gbg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rf</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> gbgi_F <span class="main">=</span> <span class="bound">Fi</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> gbg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Fi</span> <span class="bound">mi</span> <span class="bound">F</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Fi</span><span class="main">,</span><span class="bound">F</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rf</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_gbg_impl_rel_eext_def"><span class="command">lemma</span></span> gen_gbg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_gbg_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> gbgi_F <span class="main">=</span> <span class="bound">Fi</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> gbg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Fi</span> <span class="bound">mi</span> <span class="bound">F</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Fi</span><span class="main">,</span><span class="bound">F</span><span class="main">)</span><span class="main">∈</span><span class="free">Rf</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gbg_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_gbg_impl_rel_sv"><span class="command">lemma</span></span> gen_gbg_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rf</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_gbg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gbg_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_gbg_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> gb_graph_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_gbg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rf</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Rf</span></span></span><span class="main">⟩</span>gen_gbg_impl_rel_eext<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>

<span class="keyword1" id="Automata_Impl-gen_gbg_refine"><span class="command">lemma</span></span> gen_gbg_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span> <span class="free">Rf</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rf</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gbgi_F<span class="main">,</span>gbg_F<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_gbg_impl_rel_ext <span class="free">Rm</span> <span class="free">Rf</span> <span class="main">→</span> <span class="free">Rf</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_gbg_impl_ext<span class="main">,</span> gb_graph_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Rf</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_gbg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gbg_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with list of lists›</span></span>

<span class="keyword1"><span class="command">definition</span></span> gbg_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gbg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_gbg_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-gbg_impl_rel_eext_def"><span class="command">lemma</span></span> gbg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>gbg_impl_rel_eext 
    <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>list_set_rel<span class="main">⟩</span>gen_gbg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gbg_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">gbg_impl_rel_eext</span> <span class="quoted">i_gbg_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rv</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>gbg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gbg_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-gbg_ls_tag"><span class="command">lemma</span></span> gbg_ls_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="main">⟨</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>list_set_rel<span class="main">⟩</span>list_set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gbgv_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>gbg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gbg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>gbg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>g_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_gbg_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gbg_ls_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def gbg_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_gbg_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gbg_ls_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def gbg_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> gbg_F <span class="bound">G</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> 
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> gbg_F <span class="main">=</span> <span class="bound">F</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> gbg_F <span class="main">=</span> insert <span class="main">{}</span> <span class="bound">F</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> it_to_sorted_list <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="main">{</span><span class="main">1</span><span class="main">,</span><span class="numeral">2</span><span class="main">::</span>nat<span class="main">}</span> <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹GBAs›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_gba_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_gba</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="free"><span class="bound"><span class="entity">Il</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Il</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_gba_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_gbg_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>
<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Automata_Impl-gba_type"><span class="command">lemma</span></span> gba_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"gba_L <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_gba <span class="free">Ie</span> <span class="free">Iv</span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"gba_rec_ext <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> i_bool<span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="main">,</span><span class="free">Il</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_gba_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'acci</span><span class="main">,</span><span class="tfree">'Li</span><span class="main">)</span> gen_gba_impl <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'acci</span><span class="main">)</span>gen_gbg_impl"</span></span> <span class="main">+</span>
  gbai_L <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'Li</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_gba_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_gba_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span>  <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> gbai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> gba_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_gba_impl_rel_eext_def"><span class="command">lemma</span></span> gen_gba_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_gba_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> gbai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> gba_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gba_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_gba_impl_rel_sv"><span class="command">lemma</span></span> gen_gba_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rl</span><span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_gba_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gba_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_gba_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> gba_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_gba_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
    <span class="main">≡</span> gen_gbg_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>gen_gba_impl_rel_eext<span class="main">)</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_gba_refine"><span class="command">lemma</span></span> gen_gba_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span> <span class="free">Racc</span> <span class="free">Rl</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Racc</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rl</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gbai_L<span class="main">,</span>gba_L<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_gba_impl_rel_ext <span class="free">Rm</span> <span class="free">Rl</span> <span class="free">Racc</span> <span class="main">→</span> <span class="free">Rl</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_gba_impl_ext<span class="main">,</span> gba_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Rl</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_gba_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_gba_impl_rel_eext_def gen_gbg_impl_rel_eext_def
    gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation as function›</span></span>
<span class="keyword1"><span class="command">definition</span></span> gba_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gba_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="main">→</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">→</span> bool_rel<span class="main">⟩</span>gen_gba_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-gba_impl_rel_eext_def"><span class="command">lemma</span></span> gba_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gba_impl_rel_eext <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Rl</span> <span class="main">→</span> bool_rel<span class="main">⟩</span>gen_gba_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gba_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">gba_impl_rel_eext</span> <span class="quoted">i_gba_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">;</span> single_valued <span class="free">Rm</span><span class="main">;</span> Range <span class="free">Rl</span> <span class="main">=</span> UNIV<span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gba_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gba_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-gba_f_tag"><span class="command">lemma</span></span> gba_f_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span> <span class="main">→</span> <span class="free">Rl</span> <span class="main">→</span> bool_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gbav_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">≡</span> gbgv_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>gba_impl_rel_eext<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gba_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
  <span class="main">≡</span> gbg_impl_rel_ext <span class="main">(</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>gba_impl_rel_eext<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'Li</span><span class="main">×</span><span class="tfree">'l</span><span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_gba_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gbg_ls_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gba_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rl</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def gbg_impl_rel_eext_def gba_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_gba_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gbg_ls_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> gba_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rl</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def gbg_impl_rel_eext_def gba_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">autoref_itype</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> gba_L <span class="bound">G</span> <span class="bound">x</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span> <span class="bound">L</span><span class="main">.</span> 
  <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> 
    gbg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> gba_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span> <span class="bound">L</span><span class="main">.</span> 
  <span class="main">⦇</span> g_V <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> 
    gbg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> gba_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span>
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Buchi Graphs›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_bg_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_bg</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_bg_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1" id="Automata_Impl-bg_type"><span class="command">lemma</span></span> bg_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bg_F <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_bg <span class="free">Ie</span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set"</span></span>
  <span class="quoted"><span class="quoted">"gb_graph_rec_ext <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="main">⟨</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set<span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_set <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_bg_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'fi</span><span class="main">)</span> gen_bg_impl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">)</span> gen_g_impl"</span></span> <span class="main">+</span>
  bgi_F <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'fi</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_bg_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_bg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rf</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> bgi_F <span class="main">=</span> <span class="bound">Fi</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> bg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Fi</span> <span class="bound">mi</span> <span class="bound">F</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Fi</span><span class="main">,</span><span class="bound">F</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rf</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_bg_impl_rel_eext_def"><span class="command">lemma</span></span> gen_bg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_bg_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> bgi_F <span class="main">=</span> <span class="bound">Fi</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> bg_F <span class="main">=</span> <span class="bound">F</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Fi</span> <span class="bound">mi</span> <span class="bound">F</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Fi</span><span class="main">,</span><span class="bound">F</span><span class="main">)</span><span class="main">∈</span><span class="free">Rf</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_bg_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_bg_impl_rel_sv"><span class="command">lemma</span></span> gen_bg_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rf</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_bg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_bg_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_bg_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> b_graph_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_bg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rf</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Rf</span></span></span><span class="main">⟩</span>gen_bg_impl_rel_eext<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>

<span class="keyword1" id="Automata_Impl-gen_bg_refine"><span class="command">lemma</span></span> gen_bg_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span> <span class="free">Rf</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rf</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>bgi_F<span class="main">,</span>bg_F<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_bg_impl_rel_ext <span class="free">Rm</span> <span class="free">Rf</span> <span class="main">→</span> <span class="free">Rf</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_bg_impl_ext<span class="main">,</span> b_graph_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Rf</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_bg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_bg_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with Characteristic Functions›</span></span>

<span class="keyword1"><span class="command">definition</span></span> bg_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">bg_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>fun_set_rel<span class="main">⟩</span>gen_bg_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-bg_impl_rel_eext_def"><span class="command">lemma</span></span> bg_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>bg_impl_rel_eext 
    <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel<span class="main">⟩</span>gen_bg_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bg_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">bg_impl_rel_eext</span> <span class="quoted">i_bg_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rv</span><span class="main">;</span> Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">⟩</span>bg_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bg_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-bg_fs_tag"><span class="command">lemma</span></span> bg_fs_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="main">⟨</span><span class="free">Rv</span><span class="main">⟩</span>fun_set_rel<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bgv_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>bg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">bg_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>bg_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>g_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_bg_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> bg_fs_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def bg_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_bg_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> bg_fs_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def bg_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> bg_F <span class="bound">G</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> 
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> bg_F <span class="main">=</span> <span class="bound">F</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">F</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> bg_F <span class="main">=</span> <span class="bound">F</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹System Automata›</span></span>

<span class="keyword1"><span class="command">consts</span></span>
  i_sa_eext <span class="main">::</span> <span class="quoted"><span class="quoted">"interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface <span class="main">⇒</span> interface"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">i_sa</span> <span class="free"><span class="bound"><span class="entity">Ie</span></span></span> <span class="free"><span class="bound"><span class="entity">Iv</span></span></span> <span class="free"><span class="bound"><span class="entity">Il</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Ie</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Il</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_sa_eext<span class="main">,</span><span class="free"><span class="bound"><span class="entity">Iv</span></span></span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_g_ext"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">term</span></span> <span class="quoted">sa_L</span>
<span class="keyword1" id="Automata_Impl-sa_type"><span class="command">lemma</span></span> sa_type<span class="main">[</span><span class="operator">autoref_itype</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sa_L <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> i_sa <span class="free">Ie</span> <span class="free">Iv</span> <span class="free">Il</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span>"</span></span>
  <span class="quoted"><span class="quoted">"sa_rec_ext <span class="keyword1">::<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">(</span><span class="free">Iv</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Il</span><span class="main">)</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="free">Ie</span> <span class="keyword1">→<span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟨</span><span class="free">Ie</span><span class="main">,</span><span class="free">Iv</span><span class="main">,</span><span class="free">Il</span><span class="keyword1">⟩<span class="hidden">⇩</span><sub>i</sub></span>i_sa_eext"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">,</span><span class="tfree">'li</span><span class="main">)</span> gen_sa_impl <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">,</span><span class="tfree">'ei</span><span class="main">,</span><span class="tfree">'v0i</span><span class="main">)</span> gen_g_impl"</span></span> <span class="main">+</span>
  sai_L <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'li</span></span></span>

<span class="keyword1"><span class="command">definition</span></span> gen_sa_impl_rel_eext_def_internal<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">gen_sa_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> <span class="main">≡</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> sai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> sa_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span>
  <span class="main">}</span>"</span></span>

<span class="keyword1" id="Automata_Impl-gen_sa_impl_rel_eext_def"><span class="command">lemma</span></span> gen_sa_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_sa_impl_rel_eext <span class="main">=</span> <span class="main">{</span> <span class="main">(</span>
  <span class="main">⦇</span> sai_L <span class="main">=</span> <span class="bound">Li</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">mi</span> <span class="main">⦈</span><span class="main">,</span> 
  <span class="main">⦇</span> sa_L <span class="main">=</span> <span class="bound">L</span><span class="main">,</span> <span class="main">…</span><span class="main">=</span><span class="bound">m</span> <span class="main">⦈</span><span class="main">)</span> 
  <span class="main">|</span> <span class="bound">Li</span> <span class="bound">mi</span> <span class="bound">L</span> <span class="bound">m</span><span class="main">.</span> 
    <span class="main">(</span><span class="bound">Li</span><span class="main">,</span><span class="bound">L</span><span class="main">)</span><span class="main">∈</span><span class="free">Rl</span>
  <span class="main">∧</span> <span class="main">(</span><span class="bound">mi</span><span class="main">,</span><span class="bound">m</span><span class="main">)</span><span class="main">∈</span><span class="free">Rm</span>
  <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def_internal relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Automata_Impl-gen_sa_impl_rel_sv"><span class="command">lemma</span></span> gen_sa_impl_rel_sv<span class="main">[</span><span class="operator">relator_props</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rf</span><span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rf</span><span class="main">⟩</span>gen_sa_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> single_valuedD<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gen_sa_impl_rel_ext</span> 
  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> sa_rec_scheme<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">gen_sa_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rf</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">Rf</span></span></span><span class="main">⟩</span>gen_sa_impl_rel_eext<span class="main">⟩</span>gen_g_impl_rel_ext"</span></span>

<span class="keyword1" id="Automata_Impl-gen_sa_refine"><span class="command">lemma</span></span> gen_sa_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="free">Re</span> <span class="free">Rv0</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rl</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>sai_L<span class="main">,</span>sa_L<span class="main">)</span> 
    <span class="main">∈</span> <span class="main">⟨</span><span class="free">Rv</span><span class="main">,</span><span class="free">Re</span><span class="main">,</span><span class="free">Rv0</span><span class="main">⟩</span>gen_sa_impl_rel_ext <span class="free">Rm</span> <span class="free">Rl</span> <span class="main">→</span> <span class="free">Rl</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>gen_sa_impl_ext<span class="main">,</span> sa_rec_ext<span class="main">)</span> 
    <span class="main">∈</span> <span class="free">Rl</span> <span class="main">→</span> <span class="free">Rm</span> <span class="main">→</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>gen_sa_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gen_sa_impl_rel_eext_def gen_g_impl_rel_ext_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Implementation with Function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> sa_impl_rel_eext_internal_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">sa_impl_rel_eext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span>
  <span class="main">≡</span> <span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">→</span><span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>gen_sa_impl_rel_eext"</span></span>

<span class="keyword1" id="Automata_Impl-sa_impl_rel_eext_def"><span class="command">lemma</span></span> sa_impl_rel_eext_def<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>sa_impl_rel_eext 
    <span class="main">≡</span> <span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span> <span class="free">Rv</span><span class="main">→</span><span class="free">Rl</span><span class="main">⟩</span>gen_sa_impl_rel_eext"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sa_impl_rel_eext_internal_def relAPP_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rel_intf</span><span class="main">]</span> <span class="main">=</span> REL_INTFI<span class="main">[</span><span class="operator">of</span> <span class="quoted">sa_impl_rel_eext</span> <span class="quoted">i_sa_eext</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">relator_props</span><span class="main">,</span> <span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>single_valued <span class="free">Rm</span><span class="main">;</span> single_valued <span class="free">Rl</span><span class="main">;</span> Range <span class="free">Rv</span> <span class="main">=</span> UNIV<span class="main">⟧</span> 
  <span class="main">⟹</span> single_valued <span class="main">(</span><span class="main">⟨</span><span class="free">Rm</span><span class="main">,</span><span class="free">Rv</span><span class="main">,</span><span class="free">Rl</span><span class="main">⟩</span>sa_impl_rel_eext<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sa_impl_rel_eext_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">tagged_solver</span>

<span class="keyword1" id="Automata_Impl-sa_f_tag"><span class="command">lemma</span></span> sa_f_tag<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">TERM</span> <span class="main">(</span><span class="free">Rv</span><span class="main">→</span><span class="free">Rl</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sav_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>sa_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>frgv_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">sa_impl_rel_ext</span> <span class="free"><span class="bound"><span class="entity">Rm</span></span></span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span> 
  <span class="main">≡</span> <span class="main">⟨</span><span class="main">⟨</span><span class="free"><span class="bound"><span class="entity">Rm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rl</span></span></span><span class="main">⟩</span>sa_impl_rel_eext<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">Rv</span></span></span><span class="main">⟩</span>g_impl_rel_ext"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sav_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> sai_L <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'l</span> <span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> frgv_impl_scheme"</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'v</span><span class="main">,</span><span class="tfree">'l</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sa_impl_scheme <span class="main">=</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'v</span><span class="main">,</span> <span class="main">⦇</span> sai_L <span class="main">::</span> <span class="tfree">'v</span> <span class="main">⇒</span> <span class="tfree">'l</span> <span class="main">,</span> <span class="main">…</span><span class="main">::</span><span class="tfree">'m</span>  <span class="main">⦈</span><span class="main">)</span> g_impl_scheme"</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'vi</span><span class="main">×</span><span class="tfree">'v</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_sa_refine<span class="main">[</span>
  <span class="operator">OF</span> frgv_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> sa_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> frgv_impl_rel_ext_def sa_impl_rel_eext_def<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> gen_sa_refine<span class="main">[</span>
  <span class="operator">OF</span> g_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span> sa_f_tag<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">of</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">Rv</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">,</span> 
  <span class="operator">folded</span> g_impl_rel_ext_def sa_impl_rel_eext_def<span class="main">]</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> 
    <span class="main">λ</span><span class="bound">G</span> <span class="bound">x</span> <span class="bound">l</span><span class="main">.</span> <span class="keyword1">if</span> sa_L <span class="bound">G</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">l</span> <span class="keyword1">then</span> <span class="main">(</span>g_E <span class="bound">G</span> <span class="main">``</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span> 
  <span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">L</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> <span class="main">{}</span><span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> sa_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> 
  <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="operator">autoref_tyrel</span><span class="main">]</span> <span class="main">=</span> TYRELI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Id <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span><span class="main">]</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> <span class="main">λ</span><span class="bound">E</span> <span class="main">(</span><span class="bound">V0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span> <span class="bound">L</span><span class="main">.</span> 
    <span class="main">⦇</span> g_V <span class="main">=</span> UNIV<span class="main">,</span> g_E <span class="main">=</span> <span class="bound">E</span><span class="main">,</span> g_V0 <span class="main">=</span> <span class="bound">V0</span><span class="main">,</span> sa_L <span class="main">=</span> <span class="bound">L</span> <span class="main">⦈</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Index Conversion›</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> gbg_to_idx_ext_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'qi</span> <span class="main">×</span> <span class="tfree">'q</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">Rv</span> <span class="free">eq</span> <span class="free">bhc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'qi</span><span class="main">)</span> <span class="main">(</span><span class="free">def_size</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> gbg_to_idx_ext <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> gb_graph_rec_scheme <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">(</span>gbgv_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Ri</span><span class="main">)</span> 
    <span class="main">→</span> gbgv_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> 
    <span class="main">→</span> <span class="main">⟨</span>igbgv_impl_rel_ext <span class="free">Ri</span> <span class="free">Rv</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gbg_to_idx_ext_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> F_to_idx_impl_def mk_acc_impl_def
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">gbg_to_idx_ext_impl</span> 
  <span class="keyword2"><span class="keyword">for</span></span> eq bhc def_size <span class="keyword2"><span class="keyword">uses</span></span> gbg_to_idx_ext_impl_aux

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> 
  gbg_to_idx_ext_impl.refine<span class="main">[</span> 
  <span class="operator">OF</span> SIDE_GEN_ALGO_D SIDE_GEN_ALGO_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> gbg_to_idx_ext_code_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> gbg_to_idx_ext_impl <span class="free">eq</span> <span class="free">bhc</span> <span class="free">def_size</span> <span class="free">ecnv</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gbg_to_idx_ext_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">gbg_to_idx_ext_code</span> 
  <span class="keyword2"><span class="keyword">for</span></span> eq bhc ecnv G <span class="keyword2"><span class="keyword">uses</span></span> gbg_to_idx_ext_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> gbg_to_idx_ext_code.refine

<span class="keyword1"><span class="command">term</span></span> <span class="quoted">ahm_rel</span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"gba_to_idx_ext <span class="free">ecnv</span> <span class="main">≡</span> <span class="keyword1">OP</span> gba_to_idx_ext <span class="main">$</span> <span class="free">ecnv</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> gba_to_idx_ext_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Rv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'qi</span> <span class="main">×</span> <span class="tfree">'q</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_bounded_hashcode <span class="free">Rv</span> <span class="free">eq</span> <span class="free">bhc</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_ga_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_valid_def_hm_size <span class="keyword1">TYPE</span><span class="main">(</span><span class="tfree">'qi</span><span class="main">)</span> <span class="main">(</span><span class="free">def_size</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> gba_to_idx_ext <span class="main">::</span> <span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'q</span><span class="main">,</span> <span class="tfree">'l</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span> gba_rec_scheme <span class="main">⇒</span> <span class="main">_</span><span class="main">)</span>
   <span class="main">∈</span> <span class="main">(</span>gbav_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="free">Rl</span><span class="main">→</span><span class="free">Ri</span><span class="main">)</span> 
    <span class="main">→</span> gbav_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="free">Rl</span> 
    <span class="main">→</span> <span class="main">⟨</span>igbav_impl_rel_ext <span class="free">Ri</span> <span class="free">Rv</span> <span class="free">Rl</span><span class="main">⟩</span>nres_rel"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ti_Lcnv_def<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">gba_to_idx_ext_impl</span> <span class="keyword2"><span class="keyword">for</span></span> eq bhc <span class="keyword2"><span class="keyword">uses</span></span> gba_to_idx_ext_impl_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span> <span class="main">=</span> 
  gba_to_idx_ext_impl.refine<span class="main">[</span><span class="operator">OF</span> SIDE_GEN_ALGO_D SIDE_GEN_ALGO_D<span class="main">]</span>

<span class="keyword1"><span class="command">schematic_goal</span></span> gba_to_idx_ext_code_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"RETURN <span class="var">?c</span> <span class="main">≤</span> gba_to_idx_ext_impl <span class="free">eq</span> <span class="free">bhc</span> <span class="free">def_size</span> <span class="free">ecnv</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> gba_to_idx_ext_impl_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">refine_transfer</span><span class="main">)</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">gba_to_idx_ext_code</span> <span class="keyword2"><span class="keyword">for</span></span> ecnv G <span class="keyword2"><span class="keyword">uses</span></span> gba_to_idx_ext_code_aux
<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">[</span><span class="operator">refine_transfer</span><span class="main">]</span> <span class="main">=</span> gba_to_idx_ext_code.refine

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Degeneralization›</span></span>

<span class="keyword1"><span class="command">context</span></span> igb_graph <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Automata_Impl-degen_impl_aux_alt"><span class="command">lemma</span></span> degen_impl_aux_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"degeneralize_ext <span class="free">ecnv</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">if</span> num_acc <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">⦇</span>
        g_V <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">q</span><span class="main">∈</span>V<span class="main">)</span><span class="main">,</span>
        g_E<span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">`</span>succ_of_E E <span class="bound">q</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">,</span>
        g_V0 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">`</span>V0<span class="main">,</span> 
        bg_F <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="bound">q</span><span class="main">∈</span>V<span class="main">)</span><span class="main">,</span>
        <span class="main">…</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>
      <span class="main">⦈</span>
      <span class="keyword1">else</span> <span class="main">⦇</span>
        g_V <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">&lt;</span>num_acc <span class="main">∧</span> <span class="bound">q</span><span class="main">∈</span>V<span class="main">)</span><span class="main">,</span>
        g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">i</span><span class="main">)</span><span class="main">.</span> 
          <span class="keyword1">if</span> <span class="bound">i</span><span class="main">&lt;</span>num_acc <span class="keyword1">then</span>
            <span class="keyword1">let</span>
              <span class="bound">i'</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> acc <span class="bound">q</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">mod</span> num_acc <span class="keyword1">else</span> <span class="bound">i</span>
            <span class="keyword1">in</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="bound">i'</span><span class="main">)</span><span class="main">)</span><span class="main">`</span>succ_of_E E <span class="bound">q</span>
          <span class="keyword1">else</span> <span class="main">{}</span>
        <span class="main">)</span><span class="main">,</span>
        g_V0 <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q'</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span><span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">`</span>V0<span class="main">,</span>
        bg_F <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">=</span><span class="main">0</span> <span class="main">∧</span> <span class="main">0</span><span class="main">∈</span>acc <span class="bound">q</span><span class="main">)</span><span class="main">,</span>
        <span class="main">…</span> <span class="main">=</span> <span class="free">ecnv</span> <span class="free">G</span>
      <span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> degeneralize_ext_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"num_acc <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def succ_of_E_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> E_of_succ_def succ_of_E_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> degeneralize_ext_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span> <span class="free">Rv</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">∈</span> igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> degeneralize_ext<span class="main">)</span> 
  <span class="main">∈</span> <span class="main">(</span>igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Re'</span><span class="main">)</span> <span class="main">→</span> bg_impl_rel_ext <span class="free">Re'</span> <span class="main">(</span><span class="free">Rv</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> degen_impl_aux_alt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">autoref_trace_failed_id</span><span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">op_igb_graph_degeneralize_ext</span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span> <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="main">≡</span> igb_graph.degeneralize_ext <span class="free"><span class="bound"><span class="entity">G</span></span></span> <span class="free"><span class="bound"><span class="entity">ecnv</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"igb_graph.degeneralize_ext <span class="main">≡</span> <span class="main">λ</span><span class="bound">G</span> <span class="bound">ecnv</span><span class="main">.</span> op_igb_graph_degeneralize_ext <span class="bound">ecnv</span> <span class="bound">G</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> igb_graph.degeneralize_ext_impl_aux<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">degeneralize_ext_impl</span>
  <span class="keyword2"><span class="keyword">uses</span></span> igb_graph.degeneralize_ext_impl_aux<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span> degeneralize_ext_impl.refine

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>igb_graph <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CNVR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ecnvi</span><span class="main">,</span><span class="free">ecnv</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Re'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> GR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>degeneralize_ext_impl <span class="free">Gi</span> <span class="free">ecnvi</span><span class="main">,</span> 
    <span class="main">(</span><span class="keyword1">OP</span> op_igb_graph_degeneralize_ext 
       <span class="main">:::</span> <span class="main">(</span>igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> <span class="main">→</span> <span class="free">Re'</span><span class="main">)</span> <span class="main">→</span> igbg_impl_rel_ext <span class="free">Re</span> <span class="free">Rv</span> 
        <span class="main">→</span> bg_impl_rel_ext <span class="free">Re'</span> <span class="main">(</span><span class="free">Rv</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span> <span class="main">)</span><span class="main">$</span><span class="free">ecnv</span><span class="main">$</span><span class="free">G</span> <span class="main">)</span> 
  <span class="main">∈</span> bg_impl_rel_ext <span class="free">Re'</span> <span class="main">(</span><span class="free">Rv</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> nat_rel<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> degeneralize_ext_impl.refine<span class="main">[</span><span class="operator">OF</span> A GR CNVR<span class="main">]</span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
<span class="keyword1"><span class="command">thm</span></span> <span class="dynamic"><span class="dynamic">autoref_itype</span></span><span class="main">(</span>1<span class="main">)</span>

<span class="keyword1"><span class="command">schematic_goal</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"igb_graph <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>igbg_impl_rel_ext unit_rel nat_rel"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span> igb_graph.degeneralize_ext <span class="free">G</span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="main">()</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product Construction›</span></span>

<span class="keyword1"><span class="command">context</span></span> igba_sys_prod_precond <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Automata_Impl-prod_impl_aux_alt"><span class="command">lemma</span></span> prod_impl_aux_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prod <span class="main">=</span> <span class="main">(</span><span class="main">⦇</span>
    g_V <span class="main">=</span> Collect <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> igba.V <span class="main">∧</span> <span class="bound">s</span> <span class="main">∈</span> sa.V<span class="main">)</span><span class="main">,</span>
    g_E <span class="main">=</span> E_of_succ <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> 
      <span class="keyword1">if</span> igba.L <span class="bound">q</span> <span class="main">(</span>sa.L <span class="bound">s</span><span class="main">)</span> <span class="keyword1">then</span>     
        succ_of_E <span class="main">(</span>igba.E<span class="main">)</span> <span class="bound">q</span> <span class="main">×</span> succ_of_E sa.E <span class="bound">s</span>
      <span class="keyword1">else</span>
        <span class="main">{}</span>
    <span class="main">)</span><span class="main">,</span>
    g_V0 <span class="main">=</span> igba.V0 <span class="main">×</span> sa.V0<span class="main">,</span>
    igbg_num_acc <span class="main">=</span> igba.num_acc<span class="main">,</span>
    igbg_acc <span class="main">=</span> <span class="main">λ</span><span class="main">(</span><span class="bound">q</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">s</span><span class="main">∈</span>sa.V <span class="keyword1">then</span> igba.acc <span class="bound">q</span> <span class="keyword1">else</span> <span class="main">{}</span>
  <span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_def
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> succ_of_E_def E_of_succ_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span> prod_impl_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span>
  <span class="comment1">(*assumes [autoref_rules]: "(eqq,(=)) ∈ Rq → Rq → bool_rel"
  assumes [autoref_rules]: "(eqs,(=)) ∈ Rs → Rs → bool_rel"*)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span> <span class="main">∈</span> igba_impl_rel_ext <span class="free">Re</span> <span class="free">Rq</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Si</span><span class="main">,</span><span class="free">S</span><span class="main">)</span> <span class="main">∈</span> sa_impl_rel_ext <span class="free">Re2</span> <span class="free">Rs</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">,</span> prod<span class="main">)</span> <span class="main">∈</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> prod_impl_aux_alt<span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">op_igba_sys_prod</span> <span class="main">≡</span> igba_sys_prod_precond.prod"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_op_pat</span><span class="main">]</span><span class="main">:</span> 
  <span class="quoted"><span class="quoted">"igba_sys_prod_precond.prod <span class="main">≡</span> op_igba_sys_prod"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">thm</span></span> igba_sys_prod_precond.prod_impl_aux<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>
<span class="keyword1"><span class="command">concrete_definition</span></span> <span class="entity">igba_sys_prod_impl</span>
  <span class="keyword2"><span class="keyword">uses</span></span> igba_sys_prod_precond.prod_impl_aux<span class="main">[</span><span class="operator">param_fo</span><span class="main">]</span>

<span class="keyword1"><span class="command">thm</span></span> igba_sys_prod_impl.refine

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span> <span class="keyword1"><span class="command">interpretation</span></span> autoref_syn <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Re</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>igba <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SIDE_PRECOND <span class="main">(</span>sa <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> GR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>igba_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> SR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Si</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">∈</span>sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>igba_sys_prod_impl <span class="free">Gi</span> <span class="free">Si</span><span class="main">,</span> 
    <span class="main">(</span><span class="keyword1">OP</span> op_igba_sys_prod 
       <span class="main">:::</span>  igba_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span>
        <span class="main">→</span> sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>
        <span class="main">→</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span> <span class="main">)</span><span class="main">$</span><span class="free">G</span><span class="main">$</span><span class="free">S</span> <span class="main">)</span> 
  <span class="main">∈</span> igbg_impl_rel_ext unit_rel <span class="main">(</span><span class="free">Rq</span> <span class="keyword1">×<span class="hidden">⇩</span><sub>r</sub></span> <span class="free">Rs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">interpret</span></span> igba<span class="main">:</span> igba <span class="quoted"><span class="free">G</span></span> <span class="main">+</span> sa<span class="main">:</span> sa <span class="quoted"><span class="free">S</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"igba_sys_prod_precond <span class="free">G</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">using</span></span> igba_sys_prod_impl.refine<span class="main">[</span><span class="operator">OF</span> A GR SR<span class="main">]</span>
    <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">schematic_goal</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"igba <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"sa <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Gi</span><span class="main">,</span><span class="free">G</span><span class="main">)</span><span class="main">∈</span>igba_impl_rel_ext unit_rel <span class="free">Rq</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="main">[</span><span class="operator">autoref_rules</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Si</span><span class="main">,</span><span class="free">S</span><span class="main">)</span><span class="main">∈</span>sa_impl_rel_ext unit_rel <span class="free">Rs</span> <span class="free">Rl</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?c</span><span class="main">::</span><span class="tvar">?'c</span><span class="main">,</span>igba_sys_prod_precond.prod <span class="free">G</span> <span class="free">S</span><span class="main">)</span><span class="main">∈</span><span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">autoref</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">keep_goal</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="All_Of_CAVA_Automata">
<div class="head">
<h1>Theory All_Of_CAVA_Automata</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> All_Of_CAVA_Automata
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Digraph.html">Digraph</a> <a href="Automata.html">Automata</a> <a href="Lasso.html">Lasso</a> <a href="Simulation.html">Simulation</a> <a href="Stuttering_Extension.html">Stuttering_Extension</a> <a href="Digraph_Impl.html">Digraph_Impl</a> <a href="Automata_Impl.html">Automata_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>