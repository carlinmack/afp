<div id="Common">
<div class="head">
<h1>Theory Common</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Common"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Common
  <span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Going_To_Filter.html">HOL-Library.Going_To_Filter</a>"</span>
  <span class="quoted">"<a href="../Akra_Bazzi/Akra_Bazzi_Method.html">Akra_Bazzi.Akra_Bazzi_Method</a>"</span>
  <span class="quoted">"<a href="../Akra_Bazzi/Akra_Bazzi_Approximation.html">Akra_Bazzi.Akra_Bazzi_Approximation</a>"</span>
  <span class="quoted">"<a href="../../HOL/HOL-Library/Code_Target_Numeral.html">HOL-Library.Code_Target_Numeral</a>"</span>
  <span class="quoted">"<a href="../Root_Balanced_Tree/Time_Monad.html">Root_Balanced_Tree.Time_Monad</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> point <span class="main">=</span> <span class="quoted"><span class="quoted">"int <span class="main">*</span> int"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Auxiliary Functions and Lemmas"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Time Monad"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_distrib_bind<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>bind_tm <span class="free">tm</span> <span class="free">f</span><span class="main">)</span> <span class="main">=</span> time <span class="free">tm</span> <span class="main">+</span> time <span class="main">(</span><span class="free">f</span> <span class="main">(</span>val <span class="free">tm</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bind_tm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> time_simps <span class="main">=</span> time_distrib_bind tick_def

<span class="keyword1"><span class="command">lemma</span></span> bind_tm_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> val <span class="free">n</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bind_tm <span class="free">m</span> <span class="free">f</span> <span class="main">=</span> bind_tm <span class="free">n</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> bind_tm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tm.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Landau Auxiliary"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The following lemma expresses a procedure for deriving complexity properties of
  the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">O[</span></span><span class="free"><span class="free">m</span></span> <span class="keyword1"><span class="keyword1">going_to</span></span> at_top <span class="keyword1"><span class="keyword1">within</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">](</span></span><span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> is a (timing) function on same data domain (e.g. lists),
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>m›</span></span></span></span> is a measure function on that data domain (e.g. length),
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t'›</span></span></span></span> is a function on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>A›</span></span></span></span> is the set of valid inputs for the data domain.
  One needs to show that
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>t›</span></span></span></span> is bounded by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">m</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for valid inputs
    <span class="antiquoted"><span class="antiquoted">▪</span></span> <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t'</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">O(</span></span><span class="free"><span class="free">f</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  to conclude the overall property <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span><span class="quoted"><span class="quoted">"<span class="free"><span class="free">t</span></span> <span class="main"><span class="main">∈</span></span> <span class="keyword1"><span class="keyword1">O[</span></span><span class="free"><span class="free">m</span></span> <span class="keyword1"><span class="keyword1">going_to</span></span> at_top <span class="keyword1"><span class="keyword1">within</span></span> <span class="free"><span class="free">A</span></span><span class="main"><span class="main">](</span></span><span class="free"><span class="free">f</span></span> <span class="keyword1"><span class="keyword1">o</span></span> <span class="free"><span class="free">m</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bigo_measure_trans<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">t</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span><span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">t</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t'</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="free">f</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="free">t</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">m</span> <span class="keyword1">going_to</span> at_top <span class="keyword1">within</span> <span class="free">A</span><span class="main">](</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="free">t'</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> order_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">m</span> <span class="keyword1">going_to</span> at_top <span class="keyword1">within</span> <span class="free">A</span><span class="main">](</span><span class="free">t'</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span><span class="main">(</span><span class="operator">rule</span> bigoI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> c<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="main"><span class="quoted"><span class="main">1</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> assms 0
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eventually_inf_principal going_to_within_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">o</span> <span class="free">m</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">m</span> <span class="keyword1">going_to</span> at_top<span class="main">](</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> o_def going_to_def
    <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> landau_o.big.filtercomap<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="keyword1">o</span> <span class="free">m</span> <span class="main">∈</span> <span class="keyword1">O[</span><span class="free">m</span> <span class="keyword1">going_to</span> at_top <span class="keyword1">within</span> <span class="free">A</span><span class="main">](</span><span class="free">f</span> <span class="keyword1">o</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> landau_o.big.filter_mono<span class="main">[</span><span class="operator">OF</span> _2<span class="main">]</span> going_to_mono<span class="main">[</span><span class="operator">OF</span> _subset_UNIV<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">rule</span> landau_o.big_trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 1 3<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> const_1_bigo_n_ln_n<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">n</span><span class="main">::</span>nat<span class="main">)</span><span class="main">.</span> <span class="main">1</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">N</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound"><span class="bound">n</span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≥</span> <span class="bound">N</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound"><span class="bound">n</span></span><span class="main">::</span>nat<span class="main">)</span> <span class="main">≥</span> <span class="numeral">3</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">*</span> ln <span class="bound">x</span><span class="main">)</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">⟶</span> <span class="main">1</span> <span class="main">≤</span> real <span class="skolem">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> real <span class="skolem">n</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> ln <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span>"</span></span> 
          <span class="keyword1"><span class="command">using</span></span> ln_ln_nonneg' <span class="quoted"><span class="quoted">‹<span class="numeral">3</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> real <span class="skolem">n</span> <span class="main">*</span> ln <span class="main">(</span>real <span class="skolem">n</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> order_trans<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Miscellaneous Lemmas"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_take_drop_i_le_j<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span>take <span class="free">j</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>drop <span class="free">i</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> set_take_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons diff_le_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">x</span> <span class="main">(</span>set <span class="main">(</span>take <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>drop <span class="skolem">i</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>drop <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False Cons.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_Cons'<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> set_take_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_take_drop_i_le_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_take_drop<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_wrt_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"take <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_hd_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>hd <span class="free">xs</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_hd_less_take<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_hd_less in_set_takeD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_take_less_hd_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sorted_wrt_take_drop assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_hd_drop_less_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">f</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_drop sorted_wrt_hd_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> length_filter_P_impl_Q<span class="main">:</span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span>filter <span class="free">Q</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_Un<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">⟹</span> set <span class="main">(</span>filter <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">}</span> <span class="main">∪</span> <span class="main">{</span> <span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> UnI1 insert_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> UnI2 insert_iff<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> length<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">length_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length_tm</span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">length_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=1</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">l</span> <span class="main">&lt;-</span> <span class="free">length_tm</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      return <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">l</span><span class="main">)</span>
    <span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_eq_val_length_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> time_length_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">length_it'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">length_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">length_it'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">length_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">length_it</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> length_it' <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> length_conv_length_it'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">acc</span> <span class="main">=</span> length_it' <span class="free">acc</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_it'.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_conv_length_it<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length_it <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> length_it_def <span class="keyword1"><span class="command">using</span></span> length_conv_length_it' add_0_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> rev<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">rev_it'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">rev_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">rev_it'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rev_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rev_it</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> rev_it' <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rev_conv_rev_it'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">@</span> <span class="free">acc</span> <span class="main">=</span> rev_it' <span class="free">acc</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_it'.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> rev_conv_rev_it<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">=</span> rev_it <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> rev_it_def <span class="keyword1"><span class="command">using</span></span> rev_conv_rev_it' append_Nil2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> take<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">take_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">take_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">take_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=1</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
       <span class="main">0</span> <span class="main">⇒</span> return <span class="main">[]</span>
     <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">ys</span> <span class="main">&lt;-</span> <span class="free">take_tm</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
         return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
       <span class="main">}</span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> take_eq_val_take_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>take_tm <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> take <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_take_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>take_tm <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> min <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> filter<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filter_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_tm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">filter_tm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=1</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
       <span class="keyword1">do</span> <span class="main">{</span>
         <span class="bound">ys</span> <span class="main">&lt;-</span> <span class="free">filter_tm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
         return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">ys</span><span class="main">)</span>
       <span class="main">}</span>
     <span class="keyword1">else</span>
       <span class="free">filter_tm</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter_eq_val_filter_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>filter_tm <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> filter <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> time_filter_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>filter_tm <span class="free">P</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filter_it'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">filter_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span>
      <span class="free">filter_it'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">filter_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">filter_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filter_it</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> filter_it' <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> filter_conv_filter_it'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="free">acc</span> <span class="main">@</span> filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> filter_it' <span class="free">acc</span> <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> filter_it'.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> filter_conv_filter_it<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"filter <span class="free">P</span> <span class="free">xs</span> <span class="main">=</span> filter_it <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> filter_it_def <span class="keyword1"><span class="command">using</span></span> filter_conv_filter_it' append_Nil rev.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>split_at›</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_at_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_at_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_at_tm</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      <span class="main">0</span> <span class="main">⇒</span> return <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">&lt;-</span> <span class="free">split_at_tm</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">,</span> <span class="bound">ys'</span><span class="main">)</span>
      <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_at</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_at</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> 
      <span class="main">0</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> 
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs'</span><span class="main">,</span> <span class="bound">ys'</span><span class="main">)</span> <span class="main">=</span> <span class="free">split_at</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
        <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">,</span> <span class="bound">ys'</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_at_eq_val_split_at_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>split_at_tm <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> split_at <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_at_take_drop_conv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_at <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>take <span class="free">n</span> <span class="free">xs</span><span class="main">,</span> drop <span class="free">n</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_split_at_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>split_at_tm <span class="free">n</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> min <span class="free">n</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">split_at_it'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_at_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">split_at_it'</span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span>
      <span class="main">0</span> <span class="main">⇒</span> <span class="main">(</span>rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="main">|</span> Suc <span class="bound">m</span> <span class="main">⇒</span> <span class="free">split_at_it'</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">split_at_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> list <span class="main">*</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">split_at_it</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> split_at_it' <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_at_conv_split_at_it'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> split_at <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ts'</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span> <span class="main">=</span> split_at_it' <span class="free">acc</span> <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">acc</span> <span class="main">@</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">ts'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="main">=</span> <span class="free">ds'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> split_at_it'.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits nat.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_at_conv_split_at_it_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> split_at <span class="free">n</span> <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ts'</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span> <span class="main">=</span> split_at_it <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">ts'</span><span class="main">,</span> <span class="free">ds'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> split_at_it_def 
  <span class="keyword1"><span class="command">using</span></span> split_at_conv_split_at_it' rev.simps<span class="main">(</span>1<span class="main">)</span> append_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split_at_conv_split_at_it<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"split_at <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> split_at_it <span class="free">n</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> split_at_conv_split_at_it_prod surj_pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">declare</span></span> split_at_tm.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> split_at.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword">del</span></span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Mergesort"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proof"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_fst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_fst</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sorted_snd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sorted_snd</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">tl</span> <span class="main">&lt;-</span> <span class="free">merge_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="bound">tl</span><span class="main">)</span>
      <span class="main">}</span>
    <span class="keyword1">else</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">tl</span> <span class="main">&lt;-</span> <span class="free">merge_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">;</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="bound">tl</span><span class="main">)</span>
      <span class="main">}</span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=1</span> return <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
      <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
  <span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_eq_val_merge_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>merge_tm <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> set_merge<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">xs</span> <span class="main">∩</span> set <span class="free">ys</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_merge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="free">P</span> <span class="main">(</span>merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⟷</span> sorted_wrt <span class="free">P</span> <span class="free">xs</span> <span class="main">∧</span> sorted_wrt <span class="free">P</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_merge<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">mergesort_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">n</span> <span class="main">&lt;-</span> length_tm <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>l</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>r</sub></span><span class="main">)</span> <span class="main">&lt;-</span> split_at_tm <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      <span class="bound">l</span> <span class="main">&lt;-</span> <span class="free">mergesort_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs<span class="hidden">⇩</span><sub>l</sub></span><span class="main">;</span>
      <span class="bound">r</span> <span class="main">&lt;-</span> <span class="free">mergesort_tm</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">xs<span class="hidden">⇩</span><sub>r</sub></span><span class="main">;</span>
      merge_tm <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span> <span class="bound">r</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">mergesort_tm</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mergesort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span> 
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">div</span> <span class="numeral">2</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="bound">r</span><span class="main">)</span> <span class="main">=</span> split_at <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    merge <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free">mergesort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">l</span><span class="main">)</span> <span class="main">(</span><span class="free">mergesort</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">r</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> mergesort_eq_val_mergesort_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>mergesort_tm <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> mergesort <span class="free">f</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm merge_eq_val_merge_tm <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_wrt_mergesort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">(</span>mergesort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv sorted_merge<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_mergesort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>mergesort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_merge split_at_take_drop_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> list.simps<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> set_take_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> length_mergesort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="main">(</span>mergesort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_merge split_at_take_drop_conv<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> distinct_mergesort<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="main">(</span>mergesort <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span>length <span class="var">?xs'</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="var">?xs'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> split_at_take_drop_conv distinct_take distinct_drop lr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.sel<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>mergesort <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>mergesort <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> lr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">l</span> <span class="main">∩</span> set <span class="skolem">r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> split_at_take_drop_conv lr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id distinct_append prod.sel<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lr_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> distinct_merge set_mergesort <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> mergesort <span class="main">=</span> sorted_wrt_mergesort set_mergesort length_mergesort distinct_mergesort

<span class="keyword1"><span class="command">lemma</span></span> sorted_fst_take_less_hd_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> fst <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_take_less_hd_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">]</span> sorted_fst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> sorted_fst_hd_drop_less_drop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span>hd <span class="main">(</span>drop <span class="free">n</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_wrt_hd_drop_less_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> fst <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">]</span> sorted_fst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Time Complexity Proof"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_merge_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>merge_tm <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">+</span> length <span class="free">ys</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_tm.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">mergesort_recurrence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergesort_recurrence</span> <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mergesort_recurrence</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">mergesort_recurrence</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free">mergesort_recurrence</span> <span class="main">(</span>nat <span class="main">⌊</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> 
    <span class="free">mergesort_recurrence</span> <span class="main">(</span>nat <span class="main">⌈</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">akra_bazzi_termination</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> mergesort_recurrence_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> mergesort_recurrence <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort_recurrence.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> One_nat_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_mergesort_conv_mergesort_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mergesort_tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> mergesort_recurrence.simps<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">f</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs'</span><span class="main">)</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> lr_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">=</span> mergesort <span class="skolem">f</span> <span class="skolem">l</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">=</span> mergesort <span class="skolem">f</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> xs_def n_def lr_def l'_def r'_def

  <span class="keyword1"><span class="command">have</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="main">(</span>length <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.IH"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="main">(</span>length <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.IH"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">r</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌈</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IHL IHR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">l</span> <span class="main">+</span> length <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>merge_tm <span class="skolem">f</span> <span class="skolem">l'</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_merge_tm defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_mergesort<span class="main">)</span>
  
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>split_at_tm <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> 
          time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>merge_tm <span class="skolem">f</span> <span class="skolem">l'</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_simps length_eq_val_length_tm  mergesort_eq_val_mergesort_tm 
                                  split_at_eq_val_split_at_tm 
                        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm <span class="skolem">f</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_length_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> time_split_at_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> n_def <span class="quoted"><span class="quoted">‹time <span class="main">(</span>merge_tm <span class="skolem">f</span> <span class="skolem">l'</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">4</span> <span class="main">+</span> <span class="numeral">3</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="skolem">n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> mergesort_recurrence <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> mergesort_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mergesort_recurrence <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">master_theorem</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> time_mergesort_tm_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> time <span class="main">(</span>mergesort_tm <span class="free">f</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span>length <span class="keyword1">going_to</span> at_top<span class="main">](</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> length<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> time <span class="main">(</span>mergesort_tm <span class="free">f</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>mergesort_recurrence <span class="keyword1">o</span> length<span class="main">)</span> <span class="bound">xs</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">using</span></span> time_mergesort_conv_mergesort_recurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo_measure_trans<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bigthetaD1 mergesort_recurrence<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Code Export"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_xs_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge <span class="free">f</span> <span class="free">xs</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_it'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> rev <span class="free"><span class="bound"><span class="entity">acc</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">[]</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">acc</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span>
      <span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="free">merge_it'</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">acc</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">merge_it</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_it</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> merge_it' <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> merge_conv_merge_it'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="free">acc</span> <span class="main">@</span> merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> merge_it' <span class="free">f</span> <span class="free">acc</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">acc</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> merge_it'.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> merge_conv_merge_it<span class="main">[</span><span class="operator">code_unfold</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span> <span class="main">=</span> merge_it <span class="free">f</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> merge_it_def <span class="keyword1"><span class="command">using</span></span> merge_conv_merge_it' rev.simps<span class="main">(</span>1<span class="main">)</span> append_Nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Minimal Distance"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sparse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"real <span class="main">⇒</span> point set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sparse</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">.</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sparse_identity<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="free">δ</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="main">(</span>set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_commute sparse_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sparse_update<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_commute sparse_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sparse_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sparse <span class="free">Δ</span> <span class="free">P</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">≤</span> <span class="free">Δ</span> <span class="main">⟹</span> sparse <span class="free">δ</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Distance"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dist_transform<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">point</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">δ</span> <span class="main">⟷</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="free">p</span> <span class="main">∧</span> fst <span class="free">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">(</span>real_of_int <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def dist_real_def prod.case_eq_if<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">dist_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> point <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">dist_code</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> fst <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dist_eq_sqrt_dist_code<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">point</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> sqrt <span class="main">(</span>dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_prod_def dist_real_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> 

<span class="keyword1"><span class="command">lemma</span></span> dist_eq_dist_code_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">point</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟷</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_eq_sqrt_dist_code real_sqrt_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> dist_eq_dist_code_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">point</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">⟷</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>3</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_eq_sqrt_dist_code real_sqrt_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>

<span class="keyword1"><span class="command">lemma</span></span> dist_eq_dist_code_abs_lt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">point</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> <span class="free">c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_eq_sqrt_dist_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_less_of_int_power_cancel_iff real_sqrt_abs real_sqrt_less_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dist_eq_dist_code_abs_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">point</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="main">¦</span><span class="free">c</span><span class="main">¦</span> <span class="main">⟷</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">c</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dist_eq_sqrt_dist_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_power_le_of_int_cancel_iff real_sqrt_abs real_sqrt_le_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dist_fst_abs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">point</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">¦</span>fst <span class="free">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">¦</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">(</span>real_of_int <span class="main">(</span>fst <span class="free">p</span><span class="main">)</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_prod_def dist_real_def prod.case_eq_if<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> dist_code.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Brute Force Closest Pair Algorithm"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proof"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_bf_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> point list <span class="main">⇒</span> point tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_tm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_tm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_tm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;-</span> <span class="free">find_closest_bf_tm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        return <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
      <span class="keyword1">else</span>
        return <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_bf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> point list <span class="main">⇒</span> point"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">find_closest_bf</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
    <span class="keyword1">else</span>
      <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_eq_val_find_closest_bf_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>find_closest_bf_tm <span class="free">p</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> find_closest_bf <span class="free">p</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> find_closest_bf <span class="free">p</span> <span class="free">ps</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_dist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p</span> <span class="main">(</span>find_closest_bf <span class="free">p</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_bf_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_tm</span> <span class="main">[]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_tm</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_tm</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">::</span>point<span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">::</span>point<span class="main">)</span> <span class="main">&lt;-</span> <span class="free">closest_pair_bf_tm</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;-</span> find_closest_bf_tm <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        return <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
      <span class="keyword1">else</span>
        return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_bf</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_bf</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> 
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_eq_val_closest_pair_bf_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_bf_tm <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf.induct<span class="main">)</span> 
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def find_closest_bf_eq_val_find_closest_bf_tm <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_c0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span> <span class="main">⟹</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def find_closest_bf_set <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_c1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span> <span class="main">⟹</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> c<span class="hidden">⇩</span><sub>0</sub>_def p<span class="hidden">⇩</span><sub>1</sub>_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_set defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_c0_ne_c1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> distinct <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span> <span class="main">⟹</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> c<span class="hidden">⇩</span><sub>0</sub>_def p<span class="hidden">⇩</span><sub>1</sub>_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_set <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> defs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_pos_if_in_set list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>3<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> closest_pair_bf_c0_c1 <span class="main">=</span> closest_pair_bf_c0 closest_pair_bf_c1 closest_pair_bf_c0_ne_c1

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> c<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> c<span class="hidden">⇩</span><sub>0</sub>_def p<span class="hidden">⇩</span><sub>1</sub>_def
  <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 4 c<span class="hidden">⇩</span><sub>0</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> <span class="main">(</span>dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_dist defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sparse_identity IH <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="quoted">"4.prems"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sparse_update<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> IH * defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"4.prems"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> dist_commute sparse_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Time Complexity Proof"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_find_closest_bf_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>find_closest_bf_tm <span class="free">p</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf_tm.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_bf_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_bf_tm <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">ps</span> <span class="main">*</span> length <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf_tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_bf_tm <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>find_closest_bf_tm <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="var">?ps</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_find_closest_bf_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="var">?ps</span> <span class="main">+</span> length <span class="var">?ps</span> <span class="main">*</span> length <span class="var">?ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">*</span> length <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Code Export"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_bf_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>dist_code <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_bf_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">find_closest_bf_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dist_code <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_code_dist_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="free">p</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">p</span> <span class="free">c</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf_code.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_code_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> find_closest_bf <span class="free">p</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="free">p</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_bf.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="skolem">p</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>0</sub>_def δ<span class="hidden">⇩</span><sub>1</sub>_def
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">&lt;</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_code_dist_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">p</span></span><span class="main">]</span>
          dist_eq_dist_code_lt defs
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> * defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest_bf_code.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_bf_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_code</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_code</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_code</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>dist_code <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_bf_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_bf_code</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">δ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">≤</span> <span class="bound">δ<span class="hidden">⇩</span><sub>p</sub></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> 
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_code_dist_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="free">ps</span> <span class="main">⟹</span> <span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub></span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>p</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>c</sub>_def δ<span class="hidden">⇩</span><sub>p</sub>_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> dist_code <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub></span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_code_dist_eq defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_bf_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_bf_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>3</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub>'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>c</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="var">?ps</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>p</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>c</sub>_def δ<span class="hidden">⇩</span><sub>p</sub>_def
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_code_eq defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs closest_pair_bf_code_dist_eq<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs find_closest_bf_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>c</sub>'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_eq_dist_code_le<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"4.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> defs A B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Geometry"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Band Filter"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> set_band_filter_aux<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> set <span class="free">ps'</span>"</span></span>
              <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> set <span class="free">ps'</span>"</span></span>
              <span class="main">|</span> <span class="main">(</span>C<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> A
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_fst_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> B
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>5<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_fst_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> C
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">∨</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">,</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_fst_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> less_le_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> set_band_filter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps'</span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∨</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∉</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∨</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∉</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>6<span class="main">,</span>7<span class="main">)</span> sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">consider</span></span> <span class="main">(</span>A<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="main">|</span> <span class="main">(</span>B<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∧</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">case</span></span> A
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> set_band_filter_aux assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> B
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> dist_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> set_band_filter_aux assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> assms<span class="main">(</span>5<span class="main">,</span>8<span class="main">,</span>9<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"2D-Boxes and Points"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> cbox_2D<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> mem_cbox_2D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y</span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">∈</span> cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> cbox_top_un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">y<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∪</span> cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>2</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cbox_right_un<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">::</span> <span class="quoted">real</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">x<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∪</span> cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>2</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cbox_max_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">∈</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">∈</span> cbox <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> sqrt <span class="main">(</span><span class="main">(</span>dist <span class="free">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>dist <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_Pair_Pair <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> sqrt <span class="main">(</span><span class="free">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="main">(</span>dist <span class="free">y<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">y<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> X power_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> sqrt <span class="main">(</span><span class="free">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">+</span> <span class="free">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Y power_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sqrt <span class="numeral">2</span> <span class="main">*</span> sqrt <span class="main">(</span><span class="free">δ</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> real_sqrt_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Pigeonhole Argument"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_le_1_if_pairwise_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">S</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> card <span class="free">S</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> card <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∧</span> card <span class="skolem">T</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">T</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_2_iff'<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> * assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Int_if_either_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">∨</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free">T</span> <span class="main">∨</span> <span class="bound">y</span> <span class="main">∉</span> <span class="free">T</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="free">T</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">∩</span> <span class="free">T</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> card_le_1_if_pairwise_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="free">T</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">∉</span> <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> card_Int_Un_le_Sum_card_Int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">S</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"card <span class="free">S</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="main">{</span> <span class="skolem">B</span> <span class="main">}</span> <span class="main">∪</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">T</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∉</span> <span class="skolem">T</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> card_Suc_eq Suc_eq_plus1 insert_is_Un<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="skolem">S</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="main">(</span><span class="main">{</span> <span class="skolem">B</span> <span class="main">}</span> <span class="main">∪</span> <span class="skolem">T</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">⋃</span><span class="skolem">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_le inf_sup_distrib1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="skolem">T</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">B</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="bound">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc.prems * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pigeonhole<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">T</span> <span class="main">&lt;</span> card <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="bound">X</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> card_Int_if_either_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">T</span> <span class="main">&lt;</span> card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">T</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Int_absorb2 assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="main">∑</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">T</span><span class="main">.</span> card <span class="main">(</span><span class="free">S</span> <span class="main">∩</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> card_Int_Un_le_Sum_card_Int <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> card <span class="free">T</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * sum_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Delta Sparse Points within a Square"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_points_square<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">ps</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">}</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> cbox_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">ps</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_eq_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> card_le_1_if_pairwise_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> δ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="free">ps</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS</span></span> <span class="keyword2"><span class="keyword">where</span></span> PS_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">,</span> real_of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>real_of_int <span class="bound">x</span><span class="main">,</span> real_of_int <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="skolem">PS</span> <span class="main">≤</span> <span class="numeral">4</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A PS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ll</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span> <span class="free">x</span> <span class="main">,</span>  <span class="free">y</span> <span class="main">)</span> <span class="main">(</span><span class="var">?x'</span>   <span class="main">,</span> <span class="var">?y'</span>   <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lu</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span> <span class="free">x</span> <span class="main">,</span> <span class="var">?y'</span><span class="main">)</span> <span class="main">(</span><span class="var">?x'</span>   <span class="main">,</span>  <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rl</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="var">?x'</span><span class="main">,</span>  <span class="free">y</span> <span class="main">)</span> <span class="main">(</span> <span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="var">?y'</span>   <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ru</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="var">?y'</span><span class="main">)</span> <span class="main">(</span> <span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span>  <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sq</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="var">?ll</span><span class="main">,</span> <span class="var">?lu</span><span class="main">,</span> <span class="var">?rl</span><span class="main">,</span> <span class="var">?ru</span> <span class="main">}</span>"</span></span>

    <span class="keyword1"><span class="command">have</span></span> card_le_4<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?sq</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_insert_le_m1<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ll</span> <span class="main">∪</span> <span class="var">?lu</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_top_un assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> <span class="var">?rl</span> <span class="main">∪</span> <span class="var">?ru</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_top_un assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">∪</span> cbox <span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_right_un assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ll</span> <span class="main">∪</span> <span class="var">?lu</span> <span class="main">∪</span> <span class="var">?rl</span> <span class="main">∪</span> <span class="var">?ru</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PS</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="main">(</span><span class="var">?sq</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?sq</span> <span class="main">&lt;</span> card <span class="skolem">PS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * card_insert_le_m1 card_le_4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="var">?sq</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">PS</span><span class="main">.</span> <span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="skolem">PS</span><span class="main">.</span> <span class="main">∃</span><span class="bound">S</span> <span class="main">∈</span> <span class="var">?sq</span><span class="main">.</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="bound">S</span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pigeonhole<span class="main">[</span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?sq</span></span></span> <span class="quoted"><span class="skolem">PS</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> #<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">PS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="skolem">PS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="var">?sq</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> LL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="var">?ll</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="var">?ll</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_max_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="var">?y'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> LU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="var">?lu</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="var">?lu</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_max_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="var">?y'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="var"><span class="quoted"><span class="var">?y'</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> RL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="var">?rl</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="var">?rl</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_max_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="var">?y'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> RU<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="var">?ru</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="var">?ru</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cbox_max_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?x'</span><span class="main">,</span> <span class="var">?y'</span><span class="main">)</span>"</span></span> <span class="var"><span class="quoted"><span class="var">?x'</span></span></span> <span class="var"><span class="quoted"><span class="var">?y'</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> <span class="free">y</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span><span class="main">]</span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">.</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> sqrt <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span><span class="free">δ</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> # LL LU RL RU <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="main">(</span>sqrt <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> # <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>sqrt <span class="numeral">2</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">*</span> <span class="free">δ</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sqrt2_less_2 δ <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> # sparse_def PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</div><div id="Closest_Pair">
<div class="head">
<h1>Theory Closest_Pair</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Closest Pair Algorithm"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Closest_Pair
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Common.html">Common</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Formalization of a slightly optimized divide-and-conquer algorithm solving the Closest Pair Problem
  based on the presentation of Cormen \emph{et al.} \cite{Introduction-to-Algorithms:2009}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proof"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine Step"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> real <span class="main">⇒</span> point list <span class="main">⇒</span> point tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_tm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_tm</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_tm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
      return <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
    <span class="keyword1">else</span>
      <span class="keyword1">do</span> <span class="main">{</span>
        <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;-</span> <span class="free">find_closest_tm</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
        <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
          return <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
        <span class="keyword1">else</span>
          return <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>
      <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> real <span class="main">⇒</span> point list <span class="main">⇒</span> point"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span>
      <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">find_closest</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span>
      <span class="keyword1">else</span>
        <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_eq_val_find_closest_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>find_closest_tm <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p</span> <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p</span> <span class="main">(</span>find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free">p</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">δ</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p</span> <span class="main">(</span>min <span class="skolem">δ</span> <span class="main">(</span>dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">¬</span> <span class="skolem">δ</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> snd <span class="skolem">p</span> <span class="main">≤</span> snd <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_snd_def <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">≤</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_snd_def <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">≤</span> dist <span class="main">(</span>snd <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_real_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> <span class="skolem">δ</span> <span class="main">≤</span> dist <span class="skolem">p</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> dist_snd_le order_trans
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p</span> <span class="bound">q</span> <span class="main">&lt;</span> min <span class="skolem">δ</span> <span class="main">(</span>dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> A p<span class="hidden">⇩</span><sub>1</sub>_def sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p</span> <span class="bound">q</span> <span class="main">&lt;</span> min <span class="skolem">δ</span> <span class="main">(</span>dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">&lt;</span> <span class="skolem">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> dist <span class="skolem">p</span> <span class="bound">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def find_closest_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def A C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;-</span> find_closest_tm <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        <span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
      <span class="keyword1">else</span>
        <span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_eq_val_find_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def find_closest_eq_val_find_closest_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> p<span class="hidden">⇩</span><sub>1</sub>_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_c0_ne_c1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> distinct <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distinct.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> find_closest_set length_pos_if_in_set list.set_intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> A False p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_dist_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> False p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span> <span class="main">&lt;</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def find_closest_dist <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A<span class="main">(</span>2<span class="main">)</span> p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> A<span class="main">(</span>2<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C'_def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A sparse_identity order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span> <span class="main">&lt;</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> find_closest_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">]</span> p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def B <span class="quoted">"3.prems"</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C'_def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A sparse_identity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sparse_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ps'</span> <span class="main">&lt;-</span> filter_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      find_closest_pair_tm <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    find_closest_pair <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_eq_val_combine_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>combine_tm <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_eq_val_filter_tm find_closest_pair_eq_val_find_closest_pair_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def C_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_def find_closest_pair_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span><span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> C'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_c0_ne_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def C_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs find_closest_pair_c0_ne_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">ps'</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def C_def
  <span class="keyword1"><span class="command">have</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def dist_transform <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ps<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> C'_def sparse_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> ps<span class="hidden">⇩</span><sub>R</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>6<span class="main">)</span> C'_def sparse_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def assms<span class="main">(</span>1<span class="main">)</span> sorted_snd_def sorted_wrt_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_pair_dist C_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_band_filter ps' ps<span class="hidden">⇩</span><sub>L</sub> ps<span class="hidden">⇩</span><sub>R</sub> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sparse_def * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_less<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> EQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> combine.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> combine_tm.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">×</span> point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec_tm</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">n</span> <span class="main">&lt;-</span> length_tm <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">ys</span> <span class="main">&lt;-</span> mergesort_tm snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          <span class="bound">p</span> <span class="main">&lt;-</span> closest_pair_bf_tm <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          return <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">&lt;-</span> split_at_tm <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">&lt;-</span> <span class="free">closest_pair_rec_tm</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">&lt;-</span> <span class="free">closest_pair_rec_tm</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">;</span>
          <span class="bound">ys</span> <span class="main">&lt;-</span> merge_tm snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">&lt;-</span> combine_tm <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">;</span>
          return <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
       <span class="main">}</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec_tm</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
      <span class="main">(</span>mergesort snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> closest_pair_bf <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closest_pair_rec <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair_rec.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_eq_val_closest_pair_rec_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> n_def xs_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> defs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm mergesort_eq_val_mergesort_tm
                     closest_pair_bf_eq_val_closest_pair_bf_tm closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
          <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> asm defs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closest_pair_rec.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> closest_pair_rec_tm.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def length_eq_val_length_tm merge_eq_val_merge_tm
                         split_at_eq_val_split_at_tm combine_eq_val_combine_tm
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_set_length_sorted_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> sorted_snd <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> sorted_snd_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mergesort closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSP<span class="hidden">⇩</span><sub>L</sub>_def YSP<span class="hidden">⇩</span><sub>R</sub>_def YS_def P_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
              <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
              <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_take_drop split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> SET<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_merge IH<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">+</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> LENGTH<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> length_merge defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> SORTED<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> defs sorted_snd_def sorted_merge<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> SET LENGTH SORTED <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mergesort closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSP<span class="hidden">⇩</span><sub>L</sub>_def YSP<span class="hidden">⇩</span><sub>R</sub>_def YS_def P_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∩</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv set_take_disj_set_drop_if_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_set_length_sorted_snd defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∩</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> DISTINCT<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_merge IH defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> DISTINCT <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_c0_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> closest_pair_bf_c0_c1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IHL1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHL2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_at_take_drop_conv in_set_takeD fst_conv defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IHR1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHR2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_at_take_drop_conv in_set_dropD snd_conv defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> YS<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_distinct * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_set IHL2 IHR2 YS defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_c0_ne_c1 IHL1<span class="main">(</span>1<span class="main">)</span> IHR1<span class="main">(</span>1<span class="main">)</span> YS defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> closest_pair_bf_dist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> XSLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> take <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> drop <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_fst_def sorted_wrt_take<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 closest_pair_rec_set_length_sorted_snd closest_pair_rec_c0_c1
              YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_fst_def sorted_wrt_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 closest_pair_rec_set_length_sorted_snd closest_pair_rec_c0_c1
              YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_distinct * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR L_def L<span class="main">(</span>2<span class="main">)</span> sorted_fst_take_less_hd_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="skolem">L</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR L_def R<span class="main">(</span>2<span class="main">)</span> sorted_fst_hd_drop_less_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS</span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_merge defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> defs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_dist IHL IHR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="main">[]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">xs</span> <span class="main">&lt;-</span> mergesort_tm fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;-</span> closest_pair_rec_tm <span class="bound">xs</span><span class="main">;</span>
      return <span class="bound">p</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_eq_val_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_tm <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps mergesort_tm.simps
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closest_pair_rec_eq_val_closest_pair_rec_tm mergesort_eq_val_mergesort_tm
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> closest_pair <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="free">ps</span><span class="main">)</span> <span class="keyword1">in</span> <span class="bound">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_c0_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms closest_pair_rec_c0_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closest_pair_simps mergesort <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms sorted_fst_def closest_pair_rec_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span> closest_pair_rec_c0_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> closest_pair_simps mergesort <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Time Complexity Proof"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Core Argument"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> core_argument<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">point</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="bound">q</span> <span class="main">∧</span> fst <span class="bound">q</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">q</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">7</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PS</span> <span class="main">=</span> <span class="free">p</span> <span class="main">#</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set <span class="skolem">PS</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">LSQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">LSQ</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">LSQPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">LSQPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RSQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RSQ</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p</span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RSQPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RSQPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> PS_def R_def RPS_def LSQ_def LSQPS_def RSQ_def RSQPS_def

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">LSQ</span> <span class="main">∪</span> <span class="skolem">RSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs cbox_right_un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RSQ_def LSQ_def assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RSQ_def LSQ_def assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RPS</span> <span class="main">=</span> <span class="skolem">LSQPS</span> <span class="main">∪</span> <span class="skolem">RSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LSQPS_def RSQPS_def PS_def RPS_def assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">LSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> LSQPS_def sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> CLSQPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">LSQPS</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_points_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">LSQPS</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p</span>"</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> LSQ_def LSQPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">RSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> RSQPS_def sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> CRSQPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">RSQPS</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_points_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">RSQPS</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p</span>"</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> RSQ_def RSQPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> CRPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">RPS</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CLSQPS CRSQPS card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">LSQPS</span></span> <span class="quoted"><span class="skolem">RSQPS</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">RPS</span> <span class="main">=</span> <span class="skolem">LSQPS</span> <span class="main">∪</span> <span class="skolem">RSQPS</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">RPS</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> CPS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="skolem">PS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p</span> <span class="main">≤</span> snd <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">q</span> <span class="main">≤</span> snd <span class="free">p</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> PS_def sorted_snd_def * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">q</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CPS assms<span class="main">(</span>5<span class="main">)</span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R_def mem_cbox_2D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">q</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p</span> <span class="main">+</span> <span class="free">δ</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="skolem">RPS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CPS RPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">RPS</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> RPS_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CRPS card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">RPS</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">p</span> <span class="main">#</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> PS_def distinct_card <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine Step"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t_find_closest</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> real <span class="main">⇒</span> point list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_find_closest</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">t_find_closest</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">t_find_closest</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">then</span> <span class="main">0</span>
    <span class="keyword1">else</span> <span class="free">t_find_closest</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_find_closest_eq_time_find_closest_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"t_find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span> <span class="main">=</span> time <span class="main">(</span>find_closest_tm <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> t_find_closest.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_find_closest_mono<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">δ'</span> <span class="main">≤</span> <span class="free">δ</span> <span class="main">⟹</span> t_find_closest <span class="free">p</span> <span class="free">δ'</span> <span class="free">ps</span> <span class="main">≤</span> t_find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> t_find_closest.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def min_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_find_closest_cnt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"t_find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="free">p</span> <span class="main">≤</span> <span class="free">δ</span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> t_find_closest.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">δ</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_find_closest <span class="skolem">p</span> <span class="skolem">δ</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> t_find_closest <span class="skolem">p</span> <span class="main">(</span>min <span class="skolem">δ</span> <span class="main">(</span>dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="skolem">p</span> <span class="main">≤</span> min <span class="skolem">δ</span> <span class="main">(</span>dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> add_le_cancel_left length_filter_P_impl_Q min.bounded_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> length <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> snd <span class="bound">q</span> <span class="main">-</span> snd <span class="skolem">p</span> <span class="main">≤</span> <span class="skolem">δ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">corollary</span></span> t_find_closest_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">δ</span> <span class="main">::</span> <span class="quoted">real</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">p</span> <span class="main">::</span> <span class="quoted">point</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">l</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">&lt;</span> fst <span class="bound">p'</span> <span class="main">∧</span> fst <span class="bound">p'</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms core_argument<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="quoted"><span class="free">l</span></span><span class="main">]</span> t_find_closest_cnt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t_find_closest_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_find_closest_pair</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">t_find_closest_pair</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">t_find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    t_find_closest <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="free">t_find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">t_find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_find_closest_pair_eq_time_find_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span> <span class="main">=</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> t_find_closest_pair.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps find_closest_eq_val_find_closest_tm t_find_closest_eq_time_find_closest_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_find_closest_pair_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">Δ</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">Δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">Δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">≤</span> <span class="free">Δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">*</span> length <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> t_find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">-</span> <span class="main">{</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">-</span> <span class="main">{</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def PS<span class="hidden">⇩</span><sub>L</sub>_def PS<span class="hidden">⇩</span><sub>R</sub>_def
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">,</span>10<span class="main">)</span> zero_le_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"t_find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">Δ</span> <span class="var">?ps</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_find_closest_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"t_find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>10<span class="main"><span class="main">)</span></span> order_trans t_find_closest_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="var">?ps</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="var">?ps</span> <span class="main">=</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="var">?ps</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">Δ</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> <span class="free">Δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.prems"</span><span class="main">(</span>6<span class="main">,</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="free">Δ</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">Δ</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.prems"</span><span class="main">(</span>8<span class="main">,</span>9<span class="main">)</span> sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">*</span> length <span class="var">?ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">,</span>10<span class="main">)</span> defs<span class="main">(</span>1<span class="main">)</span> B C D E F <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">1</span> <span class="main">+</span> t_find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span> <span class="main">+</span> t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">*</span> length <span class="var">?ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">,</span>10<span class="main">)</span> defs<span class="main">(</span>1<span class="main">)</span> B C D E F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">=</span>
                   <span class="main">1</span> <span class="main">+</span> t_find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span> <span class="main">+</span> t_find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">t_combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_combine</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    time <span class="main">(</span>filter_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">+</span> t_find_closest_pair <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_combine_eq_time_combine_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"t_combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span> <span class="main">=</span> time <span class="main">(</span>combine_tm <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine_tm.simps time_simps t_find_closest_pair_eq_time_find_closest_pair_tm filter_eq_val_filter_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_combine_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"t_combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span> <span class="main">≤</span> <span class="numeral">10</span> <span class="main">*</span> length <span class="free">ps</span> <span class="main">+</span> <span class="numeral">3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="var">?P</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="hidden">⇩</span><sub>L</sub>'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> <span class="var">?P</span> <span class="bound">p</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps<span class="hidden">⇩</span><sub>R</sub>'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="var">?P</span> <span class="bound">p</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> c_def ps'_def ps<span class="hidden">⇩</span><sub>L</sub>'_def ps<span class="hidden">⇩</span><sub>R</sub>'_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">,</span>7<span class="main">)</span> sparse_mono c_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps<span class="hidden">⇩</span><sub>L</sub>'_def ps<span class="hidden">⇩</span><sub>R</sub>'_def sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def assms<span class="main">(</span>2<span class="main">)</span> sorted_snd_def sorted_wrt_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps'</span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">∪</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> defs<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> filter_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps'</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def dist_transform <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> ps<span class="hidden">⇩</span><sub>L</sub>'_def ps<span class="hidden">⇩</span><sub>R</sub>'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">*</span> length <span class="skolem">ps'</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> t_find_closest_pair_bound <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps'</span> <span class="main">≤</span> length <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span> <span class="main">≤</span> <span class="numeral">9</span> <span class="main">*</span> length <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span> <span class="main">=</span>
        <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>filter_tm <span class="var">?P</span> <span class="free">ps</span><span class="main">)</span> <span class="main">+</span> t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="free">ps</span> <span class="main">+</span> t_find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_filter_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> t_combine.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_tm_simps_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm snd <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps length_eq_val_length_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_tm_simps_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>split_at_tm <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> val <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    time <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>split_at_tm <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span>
    time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> t_combine <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closest_pair_rec_tm.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_simps length_eq_val_length_tm t_combine_eq_time_combine_tm
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_recurrence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">⟹</span> <span class="free">closest_pair_recurrence</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> mergesort_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">closest_pair_recurrence</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">13</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span>
    <span class="free">closest_pair_recurrence</span> <span class="main">(</span>nat <span class="main">⌊</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span> <span class="free">closest_pair_recurrence</span> <span class="main">(</span>nat <span class="main">⌈</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">akra_bazzi_termination</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_recurrence_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> closest_pair_recurrence <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_recurrence.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_conv_closest_pair_recurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm snd <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_tm_simps_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closest_pair_recurrence <span class="var">?n</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">+</span> mergesort_recurrence <span class="var">?n</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?n</span>"</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm snd <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="var">?n</span>"</span></span>
                  <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_bf_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_length_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> time_mergesort_conv_mergesort_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted">snd</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> time_closest_pair_bf_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>split_at_tm <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> CP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> CP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> val <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>combine_tm <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS_def CP<span class="hidden">⇩</span><sub>L</sub>_def CP<span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> XSLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> take <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> drop <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv split_at_eq_val_split_at_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="var">?n</span> <span class="main">-</span> <span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs closest_pair_rec_set_length_sorted_snd closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">+</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> XSLR <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> sorted_fst_def sorted_wrt_take <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> XSLR <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> sorted_fst_def sorted_wrt_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def length_eq_val_length_tm <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_distinct
            closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR <span class="quoted"><span class="quoted">‹length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">ps</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> length <span class="skolem">ps</span> <span class="keyword1">div</span> <span class="numeral">2</span>›</span></span>
            CP<span class="hidden">⇩</span><sub>L</sub>_def sorted_fst_take_less_hd_drop closest_pair_rec_set_length_sorted_snd
            closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> XSLR CP<span class="hidden">⇩</span><sub>R</sub>_def sorted_fst_hd_drop_less_drop
            closest_pair_rec_set_length_sorted_snd closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS</span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_merge defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> merge_eq_val_merge_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CP<span class="hidden">⇩</span><sub>L</sub>_def <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span>
            closest_pair_rec_dist closest_pair_rec_set_length_sorted_snd
            closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CP<span class="hidden">⇩</span><sub>R</sub>_def <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span>
            closest_pair_rec_dist closest_pair_rec_set_length_sorted_snd
            closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> combine_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"t_combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">10</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> t_combine_bound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">YS</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>split_at_tm <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span>
              time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span>
              t_combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_tm_simps_2<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> defs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">13</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_merge_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> L combine_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_length_tm time_split_at_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">13</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">+</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span>
              closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHL IHR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair_recurrence <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">master_theorem</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> time_closest_pair_rec_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span>length <span class="keyword1">going_to</span> at_top <span class="keyword1">within</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> distinct <span class="bound">ps</span> <span class="main">∧</span> sorted_fst <span class="bound">ps</span> <span class="main">}</span><span class="main">](</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> length<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> distinct <span class="bound">ps</span> <span class="main">∧</span> sorted_fst <span class="bound">ps</span> <span class="main">}</span> <span class="main">⟹</span>
           time <span class="main">(</span>closest_pair_rec_tm <span class="bound">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>closest_pair_recurrence <span class="keyword1">o</span> length<span class="main">)</span> <span class="bound">ps</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_conv_closest_pair_recurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo_measure_trans<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> bigthetaD1<span class="main">[</span><span class="operator">OF</span> closest_pair_recurrence<span class="main">]</span> of_nat_0_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closest_pair_time</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_time</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> closest_pair_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_conv_closest_pair_recurrence<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_tm <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> closest_pair_time <span class="main">(</span>length <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">unfolding</span></span> closest_pair_time_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> val <span class="main">(</span>mergesort_tm fst <span class="var">?ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def mergesort<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> <span class="quoted">"3.prems"</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">fst</span><span class="main">]</span> mergesort<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> mergesort<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span>
          sorted_fst_def mergesort_eq_val_mergesort_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_tm <span class="var">?ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm fst <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mergesort_tm.simps closest_pair_rec_tm.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_mergesort_conv_mergesort_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> closest_pair_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_conv_closest_pair_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> closest_pair_time<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair_time <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closest_pair_time_def
  <span class="keyword1"><span class="command">using</span></span> mergesort_recurrence closest_pair_recurrence sum_in_bigo<span class="main">(</span>1<span class="main">)</span> const_1_bigo_n_ln_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> time_closest_pair_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ps</span><span class="main">.</span> time <span class="main">(</span>closest_pair_tm <span class="bound">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span>length <span class="keyword1">going_to</span> at_top <span class="keyword1">within</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> distinct <span class="bound">ps</span> <span class="main">}</span><span class="main">](</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> length<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">∈</span> <span class="main">{</span> <span class="bound">ps</span><span class="main">.</span> distinct <span class="bound">ps</span> <span class="main">}</span> <span class="main">⟹</span>
           time <span class="main">(</span>closest_pair_tm <span class="bound">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>closest_pair_time <span class="keyword1">o</span> length<span class="main">)</span> <span class="bound">ps</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">using</span></span> time_closest_pair_conv_closest_pair_recurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo_measure_trans<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> closest_pair_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Code Export"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine Step"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_code</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>dist_code <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dist_code <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">-</span> snd <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">find_closest_code</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> <span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> <span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="main">(</span><span class="bound">δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_code_dist_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>c</sub></span><span class="main">,</span> <span class="free">c</span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">δ<span class="hidden">⇩</span><sub>c</sub></span> <span class="main">=</span> dist_code <span class="free">p</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>c</sub></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">δ</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> <span class="main">(</span>snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ</span> <span class="main">≤</span> <span class="main">(</span>snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dist_code <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="skolem">p</span> <span class="main">(</span>min <span class="skolem">δ</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>0</sub>_def δ<span class="hidden">⇩</span><sub>1</sub>_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> dist_code <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> A defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ'</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p</span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> find_closest <span class="free">p</span> <span class="free">δ</span> <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>c</sub>'</span><span class="main">,</span> <span class="free">c'</span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="free">p</span> <span class="free">δ'</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">=</span> <span class="free">c'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">c</span></span> <span class="quoted"><span class="free">δ<span class="hidden">⇩</span><sub>c</sub>'</span></span> <span class="quoted"><span class="free">c'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">p</span> <span class="skolem">δ</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>0</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p</span> <span class="main">(</span>min <span class="skolem">δ</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="skolem">p</span> <span class="main">(</span>min <span class="skolem">δ'</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>0</sub>_def δ<span class="hidden">⇩</span><sub>1</sub>_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">≤</span> <span class="main">(</span>snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> dist_eq_dist_code_abs_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ'</span> <span class="main">≤</span> <span class="main">(</span>snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> dist_eq_dist_code_abs_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">-</span> snd <span class="skolem">p</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">δ</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">δ</span> <span class="main">⟷</span> min <span class="skolem">δ'</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">δ'</span>"</span></span> <span class="quoted"><span class="quoted">"min <span class="skolem">δ</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">⟷</span> min <span class="skolem">δ'</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> defs<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> dist_eq_dist_code_le min.commute min_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> <span class="quoted">"3.IH"</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> defs * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> find_closest_code_dist_eq defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> dist <span class="skolem">p</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟷</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> dist_eq_dist_code_le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> B<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> * A B defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ'</span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> <span class="bound">δ'</span> <span class="keyword1">then</span>
      <span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="bound">δ'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">=</span> dist_code <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">δ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">δ</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> <span class="skolem">δ'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ'_def Δ'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> True δ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="skolem">Δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ'_def Δ'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> A False δ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="skolem">Δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ'</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Δ'</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Δ'</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>p</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">δ</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">δ'</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> δ<span class="hidden">⇩</span><sub>p</sub>_def find_closest_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> A B dist_eq_dist_code_le<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>p</sub>_def Δ<span class="hidden">⇩</span><sub>i</sub>_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> True defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> True <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> C <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> A B dist_eq_dist_code_le<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>p</sub>_def Δ<span class="hidden">⇩</span><sub>i</sub>_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> sorted_snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> A B False defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> False <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> C <span class="quoted">"3.prems"</span><span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="bound">δ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    find_closest_pair_code <span class="main">(</span><span class="bound">δ</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_closest_pair_code_dist_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">&lt;</span> <span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">ps''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ps''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="skolem">ps''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> Δ<span class="hidden">⇩</span><sub>i</sub>_def ps'_def Δ_def
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> dist_eq_dist_code_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¦</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">¦</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟷</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_eq_dist_code_abs_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> of_int_abs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> <span class="skolem">ps''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def dist_fst_abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> ps'_def sorted_snd_def sorted_wrt_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * find_closest_pair_code_eq Δ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">*</span> int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec_code</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
      <span class="main">(</span>mergesort snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> closest_pair_bf_code <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>

      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec_code</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec_code</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>

      <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine_code <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">l</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec_code</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closest_pair_rec_code <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine_code <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">l</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> combine.simps combine_code.simps closest_pair_rec_code.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> closest_pair_bf_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_code_dist_eq IHL IHR C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_ys_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> mergesort snd <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> mergesort snd <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="skolem"><span class="skolem">YS'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YS_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS'</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHL IHR YS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> closest_pair_bf_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="skolem"><span class="skolem">YS'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YS_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS'</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_set_length_sorted_snd YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">(</span>1<span class="main">)</span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_merge sorted_snd_def YS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> closest_pair_rec_ys_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> closest_pair_rec_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_code_eq IHL IHR C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="main">(</span>mergesort fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_code_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair <span class="free">ps</span> <span class="main">=</span> closest_pair_code <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys'</span><span class="main">,</span> <span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_mergesort<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">closest_pair_code</span></span> <span class="keyword2"><span class="keyword">in</span></span> OCaml
  <span class="keyword2"><span class="keyword">module_name</span></span> Verified

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Closest_Pair_Alternative">
<div class="head">
<h1>Theory Closest_Pair_Alternative</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Closest Pair Algorithm 2"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Closest_Pair_Alternative
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Common.html">Common</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹
  Formalization of a divide-and-conquer algorithm solving the Closest Pair Problem
  based on the presentation of Cormen \emph{et al.} \cite{Introduction-to-Algorithms:2009}.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Functional Correctness Proof"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Core Argument"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> core_argument<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">PS</span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> set <span class="skolem">PS</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">R</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">LSQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">LSQ</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span> <span class="main">-</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">LSQPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">LSQPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RSQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RSQ</span> <span class="main">=</span> cbox <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">l</span> <span class="main">+</span> <span class="free">δ</span><span class="main">,</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">RSQPS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RSQPS</span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span> <span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> PS_def R_def RPS_def LSQ_def LSQPS_def RSQ_def RSQPS_def

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="skolem">LSQ</span> <span class="main">∪</span> <span class="skolem">RSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs cbox_right_un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RSQ_def LSQ_def assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">LSQ</span> <span class="main">⟶</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">RSQ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RSQ_def LSQ_def assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RPS</span> <span class="main">=</span> <span class="skolem">LSQPS</span> <span class="main">∪</span> <span class="skolem">RSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> LSQPS_def RSQPS_def PS_def RPS_def assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">LSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> LSQPS_def sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> CLSQPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">LSQPS</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_points_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">LSQPS</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> LSQ_def LSQPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">RSQPS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> RSQPS_def sparse_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> CRSQPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">RSQPS</span> <span class="main">≤</span> <span class="numeral">4</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> max_points_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">RSQPS</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="free">δ</span></span><span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> RSQ_def RSQPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> CRPS<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="skolem">RPS</span> <span class="main">≤</span> <span class="numeral">8</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CLSQPS CRSQPS card_Un_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">LSQPS</span></span> <span class="quoted"><span class="skolem">RSQPS</span></span><span class="main">]</span> <span class="quoted"><span class="quoted">‹<span class="skolem">RPS</span> <span class="main">=</span> <span class="skolem">LSQPS</span> <span class="main">∪</span> <span class="skolem">RSQPS</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">RPS</span> <span class="main">⊆</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">RPS</span> <span class="main">⊆</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set <span class="skolem">PS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">RPS</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span>drop <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_wrt_take_drop<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="skolem">PS</span></span> <span class="quoted"><span class="numeral">8</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> sorted_snd_def PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p'</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">p'</span> <span class="main">≤</span> snd <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> append_take_drop_id set_append Un_iff *<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">p</span> <span class="main">≤</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">p</span> <span class="main">∈</span> <span class="skolem">R</span>›</span></span> R_def mem_cbox_2D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> prod.case_eq_if<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> snd <span class="bound">p</span> <span class="main">≤</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sorted_wrt_hd_less_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="numeral">8</span></span><span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span> sorted_snd_def PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> in_set_takeD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> R_def mem_cbox_2D <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">RPS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RPS_def set_take_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> NINE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span> <span class="skolem">p</span> <span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">RPS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">8</span> <span class="main">≤</span> length <span class="skolem">PS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> nat_le_linear <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">8</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span> <span class="skolem">p</span> <span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span> <span class="skolem">p</span> <span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span> <span class="skolem">p</span> <span class="main">}</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span>set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> *<span class="main">(</span>3<span class="main">)</span> card_Un_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span> <span class="skolem">p</span> <span class="main">}</span> <span class="main">∪</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">9</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">8</span>›</span></span> distinct_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="numeral">8</span> <span class="skolem">PS</span>"</span></span><span class="main">]</span> distinct_take<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">PS</span></span><span class="main">]</span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">RPS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> RPS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">9</span> <span class="main">≤</span> card <span class="skolem">RPS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> NINE card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> CRPS <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="main">(</span>snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">)</span> <span class="main">(</span>snd <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>11<span class="main">)</span> dist_snd_le le_less_trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> prod.case_eq_if snd_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dist_real_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sorted_snd_def assms<span class="main">(</span>2<span class="main">,</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_cbox_2D<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">+</span> <span class="free">δ</span>"</span></span><span class="main">]</span> defs
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹snd <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≤</span> snd <span class="free">p<span class="hidden">⇩</span><sub>1</sub></span>›</span></span> prod.case_eq_if<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">PS</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PS_def assms<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> RPS_def <span class="quoted"><span class="quoted">‹<span class="skolem">RPS</span> <span class="main">⊆</span> set <span class="main">(</span>take <span class="numeral">8</span> <span class="skolem">PS</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>10<span class="main">)</span> PS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine step"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_bf_dist_take_7<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">ps</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> dual_order.strict_trans2 find_closest_bf_dist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">ps</span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> find_closest_bf_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">ps</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> core_argument<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="quoted">"find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">ps</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_dist <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>find_closest_bf <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="free">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_dist order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=1</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=1</span> return <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ps'</span> <span class="main">&lt;-</span> take_tm <span class="numeral">7</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;-</span> find_closest_bf_tm <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">ps'</span><span class="main">;</span>
      <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
        <span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
      <span class="keyword1">else</span>
        <span class="free">find_closest_pair_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">≤</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="keyword1">then</span>
      <span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">find_closest_pair</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_eq_val_find_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def find_closest_bf_eq_val_find_closest_bf_tm take_eq_val_take_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span><span class="main">]</span> in_set_takeD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> p<span class="hidden">⇩</span><sub>1</sub>_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_c0_ne_c1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟹</span> distinct <span class="free">ps</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span> <span class="main">⟹</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span><span class="main">]</span> in_set_takeD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> A False p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_dist_mono<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span> True p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> p<span class="hidden">⇩</span><sub>1</sub>_def C'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span> False p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> <span class="free">δ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparse_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">uu</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sparse_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> length_greater_0_conv length_pos_if_in_set set_ConsD<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">-</span> <span class="main">{</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">ps<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">-</span> <span class="main">{</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_snd <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> <span class="free">δ</span> <span class="main">≤</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> <span class="free">δ</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
              <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="free">δ</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1-9<span class="main">)</span> sparse_def sorted_snd_def PS<span class="hidden">⇩</span><sub>L</sub>_def PS<span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> p<span class="hidden">⇩</span><sub>1</sub>_def find_closest_bf_dist_take_7 <span class="quoted">"3.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> <span class="free">δ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> C2<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">,</span>10<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A C2 sparse_identity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def <span class="quoted">"3.prems"</span><span class="main">(</span>11<span class="main">)</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">)</span> assms B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A sparse_identity order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def <span class="quoted">"3.prems"</span><span class="main">(</span>11<span class="main">)</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span><span class="bound">p</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">.</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">δ</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
      <span class="keyword3"><span class="command">assume</span></span> C2<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">,</span>10<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>10<span class="main">)</span> C1 sparse_identity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def <span class="quoted">"3.prems"</span><span class="main">(</span>11<span class="main">)</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> C2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">,</span>10<span class="main">)</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>10<span class="main">)</span> C1 C2 sparse_identity<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> def <span class="quoted">"3.prems"</span><span class="main">(</span>11<span class="main">)</span> C2 p<span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> find_closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_tm</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">ps'</span> <span class="main">&lt;-</span> filter_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      find_closest_pair_tm <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> dist <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    find_closest_pair <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_eq_val_combine_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>combine_tm <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> filter_eq_val_filter_tm find_closest_pair_eq_val_find_closest_pair_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def C_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_def find_closest_pair_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">)</span><span class="main">∨</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> C'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_c0_ne_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≠</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def C_def
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs find_closest_pair_c0_ne_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quoted"><span class="skolem">ps'</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms defs <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ps</span> <span class="main">=</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="free">l</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> PS<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{</span> <span class="bound"><span class="bound">p</span></span> <span class="main">∈</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> C'_def ps'_def PS<span class="hidden">⇩</span><sub>L</sub>_def PS<span class="hidden">⇩</span><sub>R</sub>_def C_def
  <span class="keyword1"><span class="command">have</span></span> EQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> ps'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">&lt;</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">&lt;</span> <span class="free">l</span> <span class="main">+</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def dist_transform <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ps<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">,</span>8<span class="main">)</span> C'_def sparse_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> PS<span class="hidden">⇩</span><sub>L</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PS<span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sparse_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ps<span class="hidden">⇩</span><sub>R</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="free">ps<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">,</span>7<span class="main">)</span> C'_def sparse_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">hence</span></span> PS<span class="hidden">⇩</span><sub>R</sub><span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PS<span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sparse_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def assms<span class="main">(</span>2<span class="main">)</span> sorted_snd_def sorted_wrt_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def assms<span class="main">(</span>1<span class="main">)</span> distinct_filter <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">ps'</span> <span class="main">=</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> <span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def PS<span class="hidden">⇩</span><sub>L</sub>_def PS<span class="hidden">⇩</span><sub>R</sub>_def assms<span class="main">(</span>3<span class="main">)</span> filter_Un <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">ps'</span><span class="main">.</span> <span class="free">l</span> <span class="main">-</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">≤</span> fst <span class="bound">p</span> <span class="main">∧</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">+</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_pair_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps'</span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">PS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span><span class="main">]</span> C_def PS<span class="hidden">⇩</span><sub>L</sub> PS<span class="hidden">⇩</span><sub>R</sub>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> PS<span class="hidden">⇩</span><sub>L</sub>_def PS<span class="hidden">⇩</span><sub>R</sub>_def assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_band_filter ps' ps<span class="hidden">⇩</span><sub>L</sub> ps<span class="hidden">⇩</span><sub>R</sub> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C_def find_closest_pair_dist_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="main">∀</span><span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span><span class="main">.</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∧</span> dist <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">⟶</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span> <span class="main">∧</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sparse_def * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> not_less<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> EQ <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> combine.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>
<span class="keyword1"><span class="command">declare</span></span> combine_tm.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main">]</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">×</span> point <span class="main">×</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec_tm</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">n</span> <span class="main">&lt;-</span> length_tm <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
      <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="bound">ys</span> <span class="main">&lt;-</span> mergesort_tm snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          <span class="bound">p</span> <span class="main">&lt;-</span> closest_pair_bf_tm <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          return <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span>
        <span class="main">}</span>
      <span class="keyword1">else</span>
        <span class="keyword1">do</span> <span class="main">{</span>
          <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">&lt;-</span> split_at_tm <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">&lt;-</span> <span class="free">closest_pair_rec_tm</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">&lt;-</span> <span class="free">closest_pair_rec_tm</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">;</span>
          <span class="bound">ys</span> <span class="main">&lt;-</span> merge_tm snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">;</span>
          <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">&lt;-</span> combine_tm <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">;</span>
          return <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>
       <span class="main">}</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec_tm</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm split_at_eq_val_split_at_tm<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
      <span class="main">(</span>mergesort snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> closest_pair_bf <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> split_at_take_drop_conv <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closest_pair_rec <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="bound">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair_rec.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_eq_val_closest_pair_rec_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> xs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> n_def xs_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> defs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_eq_val_length_tm mergesort_eq_val_mergesort_tm
                     closest_pair_bf_eq_val_closest_pair_bf_tm closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> asm defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
          <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> asm defs
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closest_pair_rec.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> closest_pair_rec_tm.simps<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps
               <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def length_eq_val_length_tm merge_eq_val_merge_tm
                         split_at_eq_val_split_at_tm combine_eq_val_combine_tm
               <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_set_length_sorted_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ys</span> <span class="main">=</span> set <span class="free">xs</span> <span class="main">∧</span> length <span class="free">ys</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">∧</span> sorted_snd <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> sorted_snd_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mergesort closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSP<span class="hidden">⇩</span><sub>L</sub>_def YSP<span class="hidden">⇩</span><sub>R</sub>_def YS_def P_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
              <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
              <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_take_drop split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> SET<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_merge IH<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">+</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> LENGTH<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> length_merge defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> SORTED<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IH<span class="main">(</span>5<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> defs sorted_snd_def sorted_merge<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> SET LENGTH SORTED <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mergesort closest_pair_rec.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">P</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> combine <span class="skolem">P<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">P<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSP<span class="hidden">⇩</span><sub>L</sub>_def YSP<span class="hidden">⇩</span><sub>R</sub>_def YS_def P_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∩</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv set_take_disj_set_drop_if_distinct<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_set_length_sorted_snd defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∩</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> DISTINCT<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_merge IH defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">P</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> DISTINCT <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_c0_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> closest_pair_bf_c0_c1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IHL1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHL2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_at_take_drop_conv in_set_takeD fst_conv defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> IHR1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHR2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_at_take_drop_conv in_set_dropD snd_conv defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> YS<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_distinct * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_set IHL2 IHR2 YS defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_c0_ne_c1 IHL1<span class="main">(</span>1<span class="main">)</span> IHR1<span class="main">(</span>1<span class="main">)</span> YS defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>4<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> closest_pair_bf_dist <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> XSLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> take <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> drop <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> XSLR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_fst_def sorted_wrt_take<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 closest_pair_rec_set_length_sorted_snd closest_pair_rec_c0_c1
              YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"sorted_fst <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> XSLR <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_fst_def sorted_wrt_drop<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
                       <span class="quoted"><span class="quoted">"set <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 closest_pair_rec_set_length_sorted_snd closest_pair_rec_c0_c1
              YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">argo</span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">xs</span> <span class="main">=</span> set <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="skolem">YS</span>"</span></span> <span class="quoted"><span class="quoted">"sorted_snd <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_distinct * <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">≤</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> XSLR L_def L<span class="main">(</span>2<span class="main">)</span> sorted_fst_take_less_hd_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">.</span> <span class="skolem">L</span> <span class="main">≤</span> fst <span class="bound">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> XSLR L_def R<span class="main">(</span>2<span class="main">)</span> sorted_fst_hd_drop_less_drop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">YS</span> <span class="main">=</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">∪</span> set <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_merge defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> defs<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_dist IHL IHR <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>4<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_tm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span> tm"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="main">[]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=1</span> return undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_tm</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=1</span> <span class="main">(</span>
    <span class="keyword1">do</span> <span class="main">{</span>
      <span class="bound">xs</span> <span class="main">&lt;-</span> mergesort_tm fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;-</span> closest_pair_rec_tm <span class="bound">xs</span><span class="main">;</span>
      return <span class="bound">p</span>
    <span class="main">}</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_eq_val_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"val <span class="main">(</span>closest_pair_tm <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps mergesort_tm.simps
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> closest_pair_rec_eq_val_closest_pair_rec_tm mergesort_eq_val_mergesort_tm
           <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_simps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span> <span class="main">⟹</span> closest_pair <span class="free">ps</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="free">ps</span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_c0_c1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">∈</span> set <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">≠</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms closest_pair_rec_c0_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mergesort closest_pair_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sparse <span class="main">(</span>dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span>set <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms closest_pair_rec_dist<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span> closest_pair_rec_c0_c1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"mergesort fst <span class="free">ps</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_fst_def mergesort closest_pair_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Time Complexity Proof"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine Step"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_find_closest_pair_tm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">17</span> <span class="main">*</span> length <span class="free">ps</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair_tm.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?p<span class="hidden">⇩</span><sub>1</sub></span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>find_closest_bf_tm <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">7</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> take_eq_val_take_tm<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">cases</span>
    <span class="keyword3"><span class="command">assume</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span>
           time <span class="main">(</span>find_closest_bf_tm <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">17</span> <span class="main">+</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_take_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">7</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> time_find_closest_bf_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span>"</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">17</span> <span class="main">+</span> <span class="numeral">17</span> <span class="main">*</span> <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span><span class="main">(</span>1<span class="main">)</span> C1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">17</span> <span class="main">*</span> length <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> C1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="var">?p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span>
           time <span class="main">(</span>find_closest_bf_tm <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="var">?p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">17</span> <span class="main">+</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="var">?p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="var">?ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_take_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">7</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> time_find_closest_bf_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="quoted">"val <span class="main">(</span>take_tm <span class="numeral">7</span> <span class="var">?ps</span><span class="main">)</span>"</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">17</span> <span class="main">+</span> <span class="numeral">17</span> <span class="main">*</span> <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.IH"</span><span class="main">(</span>2<span class="main">)</span> C1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">17</span> <span class="main">*</span> length <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">#</span> <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_combine_tm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>combine_tm <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">18</span> <span class="main">*</span> length <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> c_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> val <span class="main">(</span>filter_tm <span class="var">?P</span> <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> c_def ps'_def
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>combine_tm <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>filter_tm <span class="var">?P</span> <span class="free">ps</span><span class="main">)</span> <span class="main">+</span>
        time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine_tm.simps Let_def time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">+</span> length <span class="free">ps</span> <span class="main">+</span> time <span class="main">(</span>find_closest_pair_tm <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="skolem">ps'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_filter_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">+</span> length <span class="free">ps</span> <span class="main">+</span> <span class="numeral">17</span> <span class="main">*</span> length <span class="skolem">ps'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> defs time_find_closest_pair_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">18</span> <span class="main">*</span> length <span class="free">ps</span>"</span></span>
     <span class="keyword1"><span class="command">unfolding</span></span> ps'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> filter_eq_val_filter_tm<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_tm_simps_1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm snd <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps length_eq_val_length_tm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_tm_simps_2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>split_at_tm <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> val <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    time <span class="main">(</span>length_tm <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>split_at_tm <span class="main">(</span>length <span class="free">xs</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span>
    time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>combine_tm <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> closest_pair_rec_tm.simps<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps
           <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_simps length_eq_val_length_tm
              <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_recurrence</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">⟹</span> <span class="free">closest_pair_recurrence</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> mergesort_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="numeral">3</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="free">closest_pair_recurrence</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">21</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free">closest_pair_recurrence</span> <span class="main">(</span>nat <span class="main">⌊</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span>
    <span class="free">closest_pair_recurrence</span> <span class="main">(</span>nat <span class="main">⌈</span>real <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">akra_bazzi_termination</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_recurrence_nonneg<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> closest_pair_recurrence <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> closest_pair_recurrence.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_rec_conv_closest_pair_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="free">ps</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm snd <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_bf_tm <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_tm_simps_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"closest_pair_recurrence <span class="var">?n</span> <span class="main">=</span> <span class="numeral">3</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">+</span> mergesort_recurrence <span class="var">?n</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?n</span>"</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>mergesort_tm snd <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> mergesort_recurrence <span class="var">?n</span>"</span></span>
                  <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_bf_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_length_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> time_mergesort_conv_mergesort_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted">snd</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> time_closest_pair_bf_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>split_at_tm <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> CP<span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> CP<span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> val <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>combine_tm <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS_def CP<span class="hidden">⇩</span><sub>L</sub>_def CP<span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> XSLR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> take <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> drop <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv split_at_eq_val_split_at_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="var">?n</span> <span class="main">-</span> <span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs closest_pair_rec_set_length_sorted_snd closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">+</span> length <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">ps</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False XSLR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">≤</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> val <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def length_eq_val_length_tm <span class="quasi_keyword">split</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ps</span> <span class="main">=</span> length <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_set_length_sorted_snd closest_pair_rec_eq_val_closest_pair_rec_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> combine_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>combine_tm <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span><span class="main">)</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="main">+</span> <span class="numeral">18</span> <span class="main">*</span> <span class="var">?n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_combine_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>length_tm <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>split_at_tm <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">ps</span><span class="main">)</span> <span class="main">+</span>
              time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>merge_tm <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">+</span>
              time <span class="main">(</span>combine_tm <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span> <span class="skolem">YS</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_tm_simps_2<span class="main">[</span><span class="operator">OF</span> False<span class="main">]</span> defs
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> closest_pair_rec_tm.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">21</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> time_merge_tm<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="quoted"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span><span class="main">]</span> L combine_bound <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_length_tm time_split_at_tm<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="numeral">7</span> <span class="main">+</span> <span class="numeral">21</span> <span class="main">*</span> <span class="var">?n</span> <span class="main">+</span> closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌊</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌋</span><span class="main">)</span> <span class="main">+</span>
              closest_pair_recurrence <span class="main">(</span>nat <span class="main">⌈</span>real <span class="var">?n</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHL IHR <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> closest_pair_recurrence <span class="main">(</span>length <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> closest_pair_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair_recurrence <span class="main">∈</span> <span class="keyword1">Θ(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">master_theorem</span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> time_closest_pair_rec_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> time <span class="main">(</span>closest_pair_rec_tm <span class="bound">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span>length <span class="keyword1">going_to</span> at_top<span class="main">](</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> length<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> time <span class="main">(</span>closest_pair_rec_tm <span class="bound">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>closest_pair_recurrence <span class="keyword1">o</span> length<span class="main">)</span> <span class="bound">ps</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_conv_closest_pair_recurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo_measure_trans<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> bigthetaD1<span class="main">[</span><span class="operator">OF</span> closest_pair_recurrence<span class="main">]</span> of_nat_0_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closest_pair_time</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> real"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_time</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> closest_pair_recurrence <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> time_closest_pair_conv_closest_pair_recurrence<span class="main">:</span>
  <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_tm <span class="free">ps</span><span class="main">)</span> <span class="main">≤</span> closest_pair_time <span class="main">(</span>length <span class="free">ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closest_pair_time_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> val <span class="main">(</span>mergesort_tm fst <span class="var">?ps</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> length <span class="var">?ps</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def mergesort<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> mergesort_eq_val_mergesort_tm <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"time <span class="main">(</span>closest_pair_tm <span class="var">?ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> time <span class="main">(</span>mergesort_tm fst <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> xs_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mergesort_tm.simps closest_pair_rec_tm.simps <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> time_simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> time <span class="main">(</span>closest_pair_rec_tm <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_mergesort_conv_mergesort_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="var"><span class="quoted"><span class="var">?ps</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> mergesort_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span> <span class="main">+</span> closest_pair_recurrence <span class="main">(</span>length <span class="var">?ps</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> time_closest_pair_rec_conv_closest_pair_recurrence<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> time_simps<span class="main">)</span>

<span class="keyword1"><span class="command">corollary</span></span> closest_pair_time<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair_time <span class="main">∈</span> <span class="keyword1">O(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> closest_pair_time_def
  <span class="keyword1"><span class="command">using</span></span> mergesort_recurrence closest_pair_recurrence sum_in_bigo<span class="main">(</span>1<span class="main">)</span> const_1_bigo_n_ln_n <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">corollary</span></span> time_closest_pair_bigo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">ps</span><span class="main">.</span> time <span class="main">(</span>closest_pair_tm <span class="bound">ps</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="keyword1">O[</span>length <span class="keyword1">going_to</span> at_top<span class="main">](</span><span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">*</span> ln <span class="bound">n</span><span class="main">)</span> <span class="keyword1">o</span> length<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> time <span class="main">(</span>closest_pair_tm <span class="bound">ps</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>closest_pair_time <span class="keyword1">o</span> length<span class="main">)</span> <span class="bound">ps</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> comp_def <span class="keyword1"><span class="command">using</span></span> time_closest_pair_conv_closest_pair_recurrence <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bigo_measure_trans<span class="main">[</span><span class="operator">OF</span> 0<span class="main">]</span> closest_pair_time <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Code Export"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Combine Step"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">find_closest_pair_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ'</span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ</span></span></span> <span class="main">≤</span> <span class="bound">δ'</span> <span class="keyword1">then</span>
      <span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c<span class="hidden">⇩</span><sub>1</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
    <span class="keyword1">else</span>
      <span class="free">find_closest_pair_code</span> <span class="main">(</span><span class="bound">δ'</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub></span></span></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Δ</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="main">=</span> dist_code <span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Δ</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair_code.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">δ</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_code_dist_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> <span class="skolem">δ'</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ'_def Δ'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">)</span> True δ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="skolem">Δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs True <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases4<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ'_def Δ'_def
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">δ'</span></span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> A False δ'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> <span class="skolem">Δ'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs False <span class="quoted">"3.prems"</span><span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> find_closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> find_closest_pair_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ'</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Δ'</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">Δ'</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> find_closest_pair.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span></span> <span class="skolem"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> δ<span class="hidden">⇩</span><sub>p</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> find_closest_bf <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_bf_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">(</span>take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> find_closest_bf_code_dist_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"take <span class="numeral">7</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> δ<span class="hidden">⇩</span><sub>p</sub>_def find_closest_bf_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ</span> <span class="main">≤</span> dist <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> A B dist_eq_dist_code_le<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>p</sub>_def Δ<span class="hidden">⇩</span><sub>i</sub>_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.hyps"</span><span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> <span class="quoted">"3.prems"</span> True defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> True <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> C <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">δ'</span> <span class="main">≤</span> <span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"3.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> A B dist_eq_dist_code_le<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">δ<span class="hidden">⇩</span><sub>p</sub>'</span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">p<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">p<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">#</span> <span class="skolem">ps</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> δ<span class="hidden">⇩</span><sub>p</sub>_def Δ<span class="hidden">⇩</span><sub>i</sub>_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">∧</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"3.prems"</span> <span class="quoted">"3.hyps"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">p<span class="hidden">⇩</span><sub>1</sub></span></span><span class="main">]</span> A B False defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> False <span class="quoted">"3.prems"</span><span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ'</span> <span class="main">=</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> C <span class="quoted">"3.prems"</span><span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span> <span class="main">⇒</span> int <span class="main">⇒</span> point list <span class="main">⇒</span> <span class="main">(</span>int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">combine_code</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">δ</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">δ<span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="bound">δ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">in</span>
    find_closest_pair_code <span class="main">(</span><span class="bound">δ</span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="bound">ps'</span>
  <span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> combine_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> find_closest_pair_code_dist_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> combine_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">=</span> dist_code <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="free">l</span> <span class="free">ps</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> dist <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">&lt;</span> <span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free">δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="free">p<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ps'</span></span> <span class="skolem"><span class="skolem">ps''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ps'_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> dist <span class="bound">p</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> snd <span class="bound">p</span><span class="main">)</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="free">ps</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">ps''</span> <span class="main">=</span> filter <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="free">ps</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Δ_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> find_closest_pair <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span><span class="main">)</span> <span class="skolem">ps'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> find_closest_pair_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span><span class="main">)</span> <span class="skolem">ps''</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> Δ<span class="hidden">⇩</span><sub>i</sub>_def ps'_def Δ_def
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Δ<span class="hidden">⇩</span><sub>i</sub>_def assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> dist_eq_dist_code_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span><span class="main">.</span> <span class="main">¦</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">¦</span> <span class="main">&lt;</span> dist <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>i</sub></span> <span class="main">⟷</span> <span class="main">(</span>fst <span class="bound">p</span> <span class="main">-</span> <span class="free">l</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>2</sup></span> <span class="main">&lt;</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>i</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dist_eq_dist_code_abs_lt <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> of_int_abs<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps'</span> <span class="main">=</span> <span class="skolem">ps''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ps'_def dist_fst_abs <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> * find_closest_pair_code_eq Δ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> defs<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> combine.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> defs<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod.inject<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Divide and Conquer Algorithm"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">closest_pair_rec_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point list <span class="main">*</span> int <span class="main">*</span> point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_rec_code</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">≤</span> <span class="numeral">3</span> <span class="keyword1">then</span>
      <span class="main">(</span>mergesort snd <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> closest_pair_bf_code <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="bound">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>

      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec_code</span> <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> <span class="free">closest_pair_rec_code</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>

      <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine_code <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">l</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">closest_pair_rec_code</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"Wellfounded.measure <span class="main">(</span><span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> length <span class="bound">xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
     <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_simps<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="free">n</span> <span class="main">≤</span> <span class="numeral">3</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"closest_pair_rec_code <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="bound">xs<span class="hidden">⇩</span><sub>L</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="bound">xs<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">ys</span> <span class="main">=</span> merge snd <span class="bound">ys<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">ys<span class="hidden">⇩</span><sub>R</sub></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> combine_code <span class="bound">p<span class="hidden">⇩</span><sub>L</sub></span> <span class="bound">p<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">l</span> <span class="bound">ys</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> combine.simps combine_code.simps closest_pair_rec_code.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_dist_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">δ</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ</span> <span class="main">=</span> dist_code <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">δ</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> closest_pair_bf_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Δ</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">Δ</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_code_dist_eq IHL IHR C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_ys_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">ys'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> mergesort snd <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys'</span> <span class="main">=</span> mergesort snd <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="skolem"><span class="skolem">YS'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YS_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS'</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> IHL IHR YS_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_rec_code_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">ys'</span><span class="main">,</span> <span class="free">δ'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span> <span class="main">∧</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="quoted"><span class="free">ys'</span></span> <span class="quoted"><span class="free">δ'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="quoted"><span class="free">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="numeral">3</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_bf <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> closest_pair_rec.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_bf_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>3<span class="main">)</span> closest_pair_rec_code.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> closest_pair_bf_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="keyword2"><span class="keyword">where</span></span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> split_at <span class="main">(</span><span class="var">?n</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> fst <span class="main">(</span>hd <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span>"</span></span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span></span> <span class="skolem"><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">YS</span></span> <span class="skolem"><span class="skolem">YS'</span></span> <span class="keyword2"><span class="keyword">where</span></span> YS_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub></span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">YS'</span> <span class="main">=</span> merge <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> snd <span class="bound">p</span><span class="main">)</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">YS<span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">Δ'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> combine <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span><span class="main">)</span> <span class="main">(</span><span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> combine_code <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span><span class="main">)</span> <span class="skolem">L</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> prod.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">note</span></span> defs <span class="main">=</span> XS<span class="hidden">⇩</span><sub>L</sub><span class="hidden">⇩</span><sub>R</sub>_def L_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>_def YSC<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>_def YS_def C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_at_take_drop_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> IHR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span> defs <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span><span class="main"><span class="keyword3">+</span></span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">YS</span> <span class="main">=</span> <span class="skolem">YS'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> closest_pair_rec_ys_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>L</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>L</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>L</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Δ<span class="hidden">⇩</span><sub>R</sub>'</span> <span class="main">=</span> dist_code <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>R</sub>'</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>R</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> defs <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>L</sub></span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">&lt;</span> length <span class="skolem">XS<span class="hidden">⇩</span><sub>R</sub></span>›</span></span> closest_pair_rec_code_dist_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> combine_code_eq IHL IHR C<span class="hidden">⇩</span><sub>0</sub><span class="hidden">⇩</span><sub>1</sub>_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">,</span>5<span class="main">,</span>7<span class="main">,</span>9<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">YS'</span><span class="main">,</span> <span class="skolem">Δ'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">C<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False closest_pair_rec_code_simps defs<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>6<span class="main">,</span>8<span class="main">,</span>10<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">declare</span></span> closest_pair.simps <span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">add</span></span></span><span class="main">]</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">closest_pair_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"point list <span class="main">⇒</span> <span class="main">(</span>point <span class="main">*</span> point<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="main">[]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="main">[</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">]</span> <span class="main">=</span> undefined"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">closest_pair_code</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="main">(</span>mergesort fst <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="bound">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> closest_pair_code_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"closest_pair <span class="free">ps</span> <span class="main">=</span> closest_pair_code <span class="free">ps</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ps</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> induct_list012<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span></span> <span class="skolem"><span class="skolem">ys'</span></span> <span class="skolem"><span class="skolem">δ'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span></span> <span class="skolem"><span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span><span class="main">)</span> <span class="main">=</span> closest_pair_rec <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ys'</span><span class="main">,</span> <span class="skolem">δ'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span><span class="main">,</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span><span class="main">)</span> <span class="main">=</span> closest_pair_rec_code <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> length <span class="main">(</span>mergesort fst <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_mergesort<span class="main">[</span><span class="operator">of</span> <span class="quoted">fst</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>0</sub>'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="skolem">c<span class="hidden">⇩</span><sub>1</sub>'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closest_pair_rec_code_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">closest_pair_code</span></span> <span class="keyword2"><span class="keyword">in</span></span> OCaml
  <span class="keyword2"><span class="keyword">module_name</span></span> Verified

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>