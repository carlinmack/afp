<div id="Decreasing_Diagrams">
<div class="head">
<h1>Theory Decreasing_Diagrams</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Formalization of Decreasing Diagrams
    Author:      Harald Zankl  &lt;Harald.Zankl at uibk.ac.at&gt;, 2012
    Maintainer:  Harald Zankl  &lt;Harald.Zankl at uibk.ac.at&gt;, 2013
*)</span>

<span class="comment1">(*
Copyright 2012 Harald Zankl

This formalization is free software: you can redistribute it and/or modify it under
the terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later version.

This formalization is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with the formalization. If not, see &lt;http://www.gnu.org/licenses/&gt;.
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Decreasing Diagrams"</span></span>


<span class="keyword1"><span class="command">theory</span></span> Decreasing_Diagrams <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span> <span class="quoted">"<a href="../Abstract-Rewriting/Abstract_Rewriting.html">Abstract-Rewriting.Abstract_Rewriting</a>"</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span>  <span class="quoted"><span class="plain_text">‹Valley Version›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section follows~\cite{vO94}.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Appendix›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹interaction of multisets with sets›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diff</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">diff</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">intersect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">intersect</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> filter_mset <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">M</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
 diff      <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">-s</span>"</span> 800<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
 intersect <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">∩s</span>"</span> 800<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> count_diff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> count <span class="free">M</span> <span class="free">a</span> <span class="main">*</span> of_bool <span class="main">(</span><span class="free">a</span> <span class="main">∉</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_diff <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">M</span> <span class="main">-</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_eq_singleton_imp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{#</span><span class="free">a</span><span class="main">#}</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">(</span>set_mset <span class="free">M</span> <span class="main">-</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diff_def filter_mset_eq_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> count_intersect <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"count <span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span> <span class="free">A</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> count <span class="free">M</span> <span class="free">a</span> <span class="main">*</span> of_bool <span class="main">(</span><span class="free">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> set_mset_intersect <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> set_mset <span class="free">M</span> <span class="main">∩</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> intersect_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_from_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span><span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> diff_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> <span class="main">{}</span> <span class="main">=</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> submultiset_implies_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> set_mset <span class="free">N</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms mset_subset_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_implies_remove_empty<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_empty_implies_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_mset <span class="free">M</span>"</span></span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set_mset <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemmaA_3_8<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">N</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> lemmaA_3_9<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="free">T</span> <span class="main">=</span> <span class="free">M</span> <span class="keyword1">-s</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lemma</span></span> lemmaA_3_10<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span> <span class="free">S</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def intersect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">lemma</span></span> lemmaA_3_11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">T</span><span class="main">)</span> <span class="keyword1">∩s</span> <span class="free">S</span> <span class="main">=</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span> <span class="free">S</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def intersect_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Multisets›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition 2.5(1)›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ds</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dm</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">M</span></span></span> <span class="main">=</span> ds <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>set_mset <span class="free"><span class="bound"><span class="entity">M</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">dl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">dl</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> ds <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
 ds <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↓s</span>"</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
 dm <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↓m</span>"</span> 900<span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
 dl <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">↓l</span>"</span> 900<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹missing but useful›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ds_ds_subseteq_ds<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ds <span class="free">r</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem t trans_def <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹from PhD thesis of van Oostrom›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ds_monotone<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="free">S</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> subset_imp_ds_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="free">S</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">T</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms ds_monotone ds_ds_subseteq_ds <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition 2.5(2)›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹strict order (mult) is used from Multiset.thy›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mult_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mult_eq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span>mult1 <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mul</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mul</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">.</span><span class="main">∃</span><span class="bound">I</span> <span class="bound">J</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">K</span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">J</span> <span class="main">∧</span> set_mset <span class="bound">K</span> <span class="main">⊆</span> dm <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">J</span> <span class="main">∧</span> <span class="bound">J</span> <span class="main">≠</span> <span class="main">{#}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mul_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> multiset rel"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mul_eq</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">M</span><span class="main">,</span><span class="bound">N</span><span class="main">)</span><span class="main">.</span><span class="main">∃</span><span class="bound">I</span> <span class="bound">J</span> <span class="bound">K</span><span class="main">.</span> <span class="bound">M</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">K</span> <span class="main">∧</span> <span class="bound">N</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">J</span> <span class="main">∧</span> set_mset <span class="bound">K</span> <span class="main">⊆</span> dm <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">J</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> in_mul_eqI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">I</span> <span class="main">+</span> <span class="free">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">I</span> <span class="main">+</span> <span class="free">J</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">K</span> <span class="main">⊆</span> <span class="free">r</span> <span class="keyword1">↓m</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mul_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> downset_intro<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set_mset <span class="free">K</span><span class="main">.</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span>set_mset <span class="free">J</span><span class="main">.</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set_mset <span class="free">K</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> downset_elim<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">J</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">∈</span>set_mset <span class="free">K</span><span class="main">.</span><span class="main">∃</span><span class="bound">j</span><span class="main">∈</span>set_mset <span class="free">J</span><span class="main">.</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span> set_mset <span class="free">K</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">∈</span>set_mset <span class="free">J</span><span class="main">.</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span><span class="bound">j</span><span class="main">)</span><span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹to closure-free representation›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mult_eq_implies_one_or_zero_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">I</span> <span class="bound">J</span> <span class="bound">K</span><span class="main">.</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">J</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">K</span> <span class="main">∧</span> set_mset <span class="bound">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="bound">J</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">r</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> downset_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms rtrancl_eq_or_trancl <span class="keyword1"><span class="command">unfolding</span></span> mult_eq_def mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">N</span> <span class="main">+</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#}</span> <span class="main">∧</span> set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span><span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹from closure-free representation›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> one_step_implies_mult_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">J</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">+</span><span class="free">K</span><span class="main">,</span><span class="free">I</span><span class="main">+</span><span class="free">J</span><span class="main">)</span><span class="main">∈</span>mult_eq <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">K</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms downset_elim <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv emptyE<span class="main">)</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">unfolding</span></span> mult_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> h<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_mset_eq_empty_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">+</span><span class="free">K</span><span class="main">,</span><span class="free">I</span><span class="main">+</span><span class="free">J</span><span class="main">)</span><span class="main">∈</span> mult <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_mset_eq_empty_iff assms one_step_implies_mult downset_elim
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_eq_def mult_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_is_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult <span class="free">r</span> <span class="main">=</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mult <span class="free">r</span> <span class="main">⊆</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">r</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_implies_one_step<span class="main">[</span><span class="operator">OF</span> assms A<span class="main">]</span> downset_intro <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mul <span class="free">r</span> <span class="main">⊆</span> mult <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> one_step_implies_mult assms downset_elim <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_eq_is_mul_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mult_eq <span class="free">r</span> <span class="main">=</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mult_eq <span class="free">r</span> <span class="main">⊆</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">N</span> <span class="skolem">M</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult_eq <span class="free">r</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">N</span><span class="main">,</span><span class="skolem">M</span><span class="main">)</span> <span class="main">∈</span> mult <span class="free">r</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mult_is_mul<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> mul_def mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A rtranclD <span class="keyword1"><span class="command">unfolding</span></span> mult_def mult_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">+</span> <span class="main">{#}</span> <span class="main">∧</span> <span class="skolem">N</span> <span class="main">=</span> <span class="skolem">N</span> <span class="main">+</span> <span class="main">{#}</span> <span class="main">∧</span> set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mul_eq <span class="free">r</span> <span class="main">⊆</span> mult_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> one_step_implies_mult_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mul_eq <span class="free">r</span> <span class="main">=</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mul_eq <span class="free">r</span> <span class="main">⊆</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">N</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
   <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">K</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True 1 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 2 3 <span class="keyword1"><span class="command">unfolding</span></span> mul_def mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mul_eq <span class="free">r</span> <span class="main">⊇</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">M</span> <span class="skolem">N</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>=</sup></span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
   <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">N</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">N</span> <span class="main">=</span> <span class="skolem">M</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">M</span><span class="main">,</span><span class="skolem">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_def mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹useful properties on multisets›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mul_eq_reflexive<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mul_eq_trans<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult_eq_is_mul_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mult_eq_def
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mul_eq_singleton<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span> <span class="main">∨</span> set_mset <span class="free">M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">α</span><span class="main">#}</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 3 True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 union_is_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 union_is_single <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 i 3 <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mul_and_mul_eq_imp_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult_is_mul<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mult_eq_is_mul_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mult_def mult_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mul_eq_and_mul_imp_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mult_is_mul<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mult_eq_is_mul_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> mult_def mult_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> wf_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> mult_is_mul<span class="main">[</span><span class="operator">symmetric</span><span class="main">,</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> wf_mult<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> remove_is_empty_imp_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> remove_empty_implies_subset<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">+</span><span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">=</span><span class="main">{#}</span><span class="main">+</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">α</span><span class="main">#}</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_1_set<span class="main">:</span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> <span class="free">T</span><span class="main">)</span> <span class="main">=</span> ds <span class="free">r</span> <span class="free">S</span> <span class="main">∪</span> ds <span class="free">r</span> <span class="free">T</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> set_mset_union ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_1_list<span class="main">:</span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span> <span class="main">=</span> dl <span class="free">r</span> <span class="free">σ</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">τ</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> dl_def ds_def set_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_1_multiset<span class="main">:</span> <span class="quoted"><span class="quoted">"dm <span class="free">r</span> <span class="main">(</span><span class="free">M</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">=</span> dm <span class="free">r</span> <span class="free">M</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="free">N</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> dm_def set_mset_union ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_1_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dm <span class="free">r</span> <span class="free">M</span><span class="main">)</span> <span class="main">-</span> ds <span class="free">r</span> <span class="free">S</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> diff_def dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹missing but useful›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> dl_monotone<span class="main">:</span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6.2›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_2_a<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span><span class="main">=</span><span class="free">M</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mset_subset_eq_exists_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mul_eq_not_equal_imp_elt<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span><span class="main">∈</span>mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span>set_mset <span class="free">M</span> <span class="main">-</span> set_mset <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">∈</span>set_mset <span class="free">N</span><span class="main">.</span><span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F3<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> downset_elim<span class="main">[</span><span class="operator">OF</span> F3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_2_b<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dm <span class="free">r</span> <span class="free">M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> F2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>set_mset <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">z</span> <span class="main">∈</span> set_mset <span class="free">N</span><span class="main">.</span> <span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">∈</span><span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>set_mset <span class="free">N</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> F3 <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_not_equal_imp_elt assms F2 F3 trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6.3›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> ds_trans_contrapos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ds_def trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> dm_max_elt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="free">M</span> <span class="main">⟹</span> <span class="main">∃</span> <span class="bound">y</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="free">M</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">M</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">p</span> <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>dm <span class="free">r</span> <span class="skolem">P</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> i t <span class="keyword1"><span class="command">have</span></span> not_mem_dm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def irrefl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="skolem">P</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> relp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mem <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="skolem">P</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> relp t ds_trans_contrapos False <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
     <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_mem_dm relp <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set_mset <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∉</span> dm <span class="free">r</span> <span class="skolem">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span>"</span></span><span class="main">)</span>
     <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> rely<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">hence</span></span> relp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">p</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rely t key trans_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
     <span class="keyword1"><span class="command">have</span></span> not_memp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> set_mset <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rely key <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">have</span></span> memp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> set_mset <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> dm <span class="free">r</span> <span class="skolem">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_trans_contrapos<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> key<span class="main">(</span>2<span class="main">)</span> rely <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∉</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">P</span> <span class="main">+</span> <span class="main">{#</span><span class="skolem">p</span><span class="main">#}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> not_mem_dm <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
     <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> relp <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
     <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> key <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dm_subset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dm <span class="free">r</span> <span class="free">M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="free">M</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms dm_max_elt <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> dm_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"dm <span class="free">r</span> <span class="free">M</span> <span class="main">=</span> dm <span class="free">r</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="free">M</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> dm_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I'</span> <span class="bound">J'</span> <span class="bound">K'</span> <span class="main">.</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">I'</span> <span class="main">+</span> <span class="bound">J'</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="bound">I'</span> <span class="main">+</span> <span class="bound">K'</span> <span class="main">∧</span> <span class="bound">J'</span> <span class="main">∩#</span> <span class="bound">K'</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">∧</span> set_mset <span class="bound">K'</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="bound">J'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">r</span> <span class="keyword1">↓m</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">↓m</span> <span class="skolem">J</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span> <span class="main">∪</span> <span class="skolem">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">J</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="skolem">J</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">clarsimp</span> <span class="main">(</span><span class="operator">metis</span> Multiset.count_diff add.left_neutral add_diff_cancel_left' mem_Collect_eq not_gr0 set_mset_def<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> 1 2 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_union_cancelL subset_mset.inf_le2 multiset_diff_union_assoc multiset_inter_commute union_commute union_lcomm<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_subset_eq_self diff_union_cancelL 2 multiset_diff_union_assoc multiset_inter_commute multiset_inter_def union_assoc<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">K</span><span class="main">-</span><span class="main">(</span><span class="skolem">J</span><span class="main">∩#</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span><span class="main">-</span><span class="main">(</span><span class="skolem">J</span><span class="main">∩#</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">K</span><span class="main">-</span><span class="main">(</span><span class="skolem">J</span><span class="main">∩#</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 3
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Multiset.diff_subset_eq_self mset_subset_eqD subset_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="skolem">J</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dm_eq<span class="main">[</span><span class="operator">OF</span> i t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">-</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_monotone<span class="main">[</span><span class="operator">OF</span> key<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span><span class="main">-</span><span class="main">(</span><span class="skolem">J</span><span class="main">∩#</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">∩#</span> <span class="main">(</span><span class="skolem">K</span><span class="main">-</span><span class="main">(</span><span class="skolem">J</span><span class="main">∩#</span><span class="skolem">K</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> multiset_eqI<span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*  (* initial proof by Bertram Felgenhauer *)
lemma lemma2_6_3_step:
assumes t:"trans r" and i:"irrefl r" and P:"set_mset K ⊆ dm r J" shows "set_mset (K-(J∩#K)) ⊆ dm r (J-(J∩#K))" proof
 fix k assume K: "k ∈ set_mset (K - (J∩#K))" show "k ∈ dm r (J - (J∩#K))" proof -
  have k: "k ∈# K" using K by simp
  have step: "k ∈ dm r (J-K)" proof -
   {
   fix P have "P ≤ K ⟹ k ∈ dm r (J-P)" using k proof (induct P arbitrary:k rule:multiset_induct)
    case empty thus ?case using P by auto
   next
    case (add Q q)
    have h1: "q ∈# K" and h2: "Q ≤ K" using mset_subset_eq_insertD[OF add(2)] by auto
    obtain j where mem1: "j∈set_mset (J - Q)" and rel1: "(k, j) ∈ r" using add(1)[OF h2 add(3)] unfolding dm_def ds_def by auto
    show ?case proof (cases "j ∈# J - (Q + {#q#})")
     case True thus ?thesis using rel1 unfolding dm_def ds_def by force
    next
     case False hence eq: "q = j" using mem1 by (cases "q = j") auto
     obtain j2 where mem2: "j2∈set_mset (J - Q)" and rel2: "(j, j2) ∈ r" using eq add(1)[OF h2 h1] unfolding dm_def ds_def by auto
     have rel: "(k,j2) ∈ r" using transD[OF assms(1) rel1 rel2] by auto
     have "j2 ≠ q" using rel2 eq i irrefl_def by fast
     thus ?thesis using rel mem2 unfolding dm_def ds_def by (cases "j2=k") auto
    qed
   qed
   }
   thus ?thesis by auto
  qed
  have eq: "J - K = J - (J ∩# K)" by (rule multiset_eqI) auto
  show ?thesis using step unfolding eq dm_def ds_def by auto
 qed
qed

lemma lemma2_6_3: assumes t: "trans r" and i: "irrefl r" and "(M,N) ∈ mul_eq r"
shows "∃ I J K. N = I + J ∧ M = I + K ∧ J∩#K = {#} ∧ set_mset K ⊆ dm r J" proof -
 from assms(1,3)
 obtain I J K where f1:"N = I + J" and f2:"M = I + K" and f3:"set_mset K ⊆ dm r J" unfolding mul_eq_def by fast
 hence "N = (I + (J ∩# K)) + (J - (J ∩# K))"
  by (metis diff_union_cancelL inf_le2 multiset_diff_union_assoc multiset_inter_commute union_commute union_lcomm)
 moreover have "M = (I + (J ∩# K)) + (K - (J ∩# K))"
  by (metis diff_le_self diff_union_cancelL f1 f2 f3 multiset_diff_union_assoc multiset_inter_commute multiset_inter_def union_assoc)
 moreover have "(J-(J∩#K)) ∩# (K-(J∩#K)) = {#}" by (rule multiset_eqI) auto
 ultimately show ?thesis using lemma2_6_3_step[OF t i f3] by auto
qed
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6.4›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_4<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">{#}</span> <span class="main">+</span> <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_5_a<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">,</span> <span class="free">N</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">best</span>
 <span class="keyword1"><span class="command">from</span></span> a b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="skolem">I</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">+</span> <span class="skolem">K</span> <span class="keyword1">-s</span> <span class="free">S</span>"</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">=</span> <span class="skolem">I</span> <span class="keyword1">-s</span> <span class="free">S</span> <span class="main">+</span> <span class="skolem">J</span> <span class="keyword1">-s</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lemmaA_3_8<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">K</span><span class="keyword1">-s</span><span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span><span class="keyword1">-s</span><span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">K</span><span class="keyword1">-s</span><span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> set_mset <span class="main">(</span><span class="skolem">K</span><span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset<span class="main">(</span><span class="skolem">K</span><span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span>dm <span class="free">r</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>dm <span class="free">r</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_1_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_mul_eqI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_5_a'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="free">S</span><span class="main">,</span> <span class="free">N</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lemma2_6_5_a<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> ds_ds_subseteq_ds<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6.6›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_6_a<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span><span class="free">Q</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">+</span><span class="free">N</span><span class="main">=</span><span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="skolem">I</span><span class="main">)</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">+</span><span class="free">M</span><span class="main">=</span><span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="skolem">I</span><span class="main">)</span><span class="main">+</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_left_one<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I</span> <span class="bound">J</span> <span class="bound">K</span><span class="main">.</span> add_mset <span class="free">q</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">J</span> <span class="main">∧</span> add_mset <span class="free">q</span>  <span class="free">M</span> <span class="main">=</span> <span class="bound">I</span> <span class="main">+</span> <span class="bound">K</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">J</span><span class="main">∩#</span><span class="bound">K</span><span class="main">=</span><span class="main">{#}</span><span class="main">)</span> <span class="main">∧</span> set_mset <span class="bound">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="bound">J</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I2</span> <span class="bound">J</span> <span class="bound">K</span><span class="main">.</span> <span class="free">N</span> <span class="main">=</span> <span class="bound">I2</span> <span class="main">+</span> <span class="bound">J</span> <span class="main">∧</span> <span class="free">M</span> <span class="main">=</span> <span class="bound">I2</span> <span class="main">+</span> <span class="bound">K</span> <span class="main">∧</span> set_mset <span class="bound">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="bound">J</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">q</span><span class="main">#}</span> <span class="main">+</span> <span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="free">q</span><span class="main">#}</span> <span class="main">+</span> <span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span> <span class="main">=</span> <span class="main">{#}</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈#</span><span class="skolem">I</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈#</span> <span class="skolem">I</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈#</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnE multi_member_this set_mset_union<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">∈#</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnE multi_member_this set_mset_union<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">q</span> <span class="main">∈#</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">∩#</span> <span class="skolem">K</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I2</span><span class="main">.</span> <span class="skolem">I</span> <span class="main">=</span> add_mset <span class="free">q</span> <span class="bound">I2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> multi_member_split union_commute<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">I2</span><span class="main">.</span> add_mset <span class="free">q</span> <span class="free">N</span> <span class="main">=</span> <span class="main">(</span>add_mset <span class="free">q</span> <span class="bound">I2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">J</span> <span class="main">∧</span> add_mset <span class="free">q</span> <span class="free">M</span> <span class="main">=</span> <span class="main">(</span>add_mset <span class="free">q</span> <span class="bound">I2</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A B <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_6_b_one <span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_mset <span class="free">q</span> <span class="free">M</span><span class="main">,</span> add_mset <span class="free">q</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> add_left_one<span class="main">[</span><span class="operator">OF</span> lemma2_6_3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_6_b' <span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span> <span class="main">+</span> <span class="free">M</span><span class="main">,</span> <span class="free">Q</span> <span class="main">+</span> <span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">N</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>add <span class="skolem">q</span> <span class="skolem">Q</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> union_assoc <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_b_one<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_mset_add_mset_left<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_9<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="free">M</span><span class="main">,</span><span class="free">Q</span><span class="main">+</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> F1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span><span class="keyword2"><span class="keyword">and</span></span> F3<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F4<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">+</span><span class="free">N</span><span class="main">=</span><span class="free">Q</span><span class="main">+</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">+</span><span class="free">M</span><span class="main">=</span><span class="free">Q</span><span class="main">+</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">K</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> F1 F2 union_commute union_lcomm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> F3 F4 <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2.6.7›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_7_a<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">Q</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">N</span> <span class="main">-</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">N</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span><span class="main">=</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset<span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="skolem">K</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms lemma2_6_1_diff <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">+</span><span class="main">(</span><span class="free">Q</span><span class="main">+</span><span class="skolem">K</span><span class="main">)</span><span class="main">,</span><span class="skolem">I</span><span class="main">+</span><span class="skolem">J</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> A B C union_assoc union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹missing?; similar to lemma\_2.6.2?›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_8<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">T</span><span class="main">,</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">T</span><span class="main">)</span> <span class="main">⊆#</span> <span class="main">(</span><span class="free">M</span> <span class="keyword1">-s</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_absorb2 Un_commute lemmaA_3_10 lemmaA_3_9 mset_subset_eq_add_right<span class="main">)</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_2_a<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lexicographic maximum measure›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Def 3.1: lexicographic maximum measure›</span></span>
<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lexmax</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> multiset"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">lexmax</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lexmax</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">)</span> <span class="main">=</span>  <span class="main">{#</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">lexmax</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">-s</span> ds <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span>
 lexmax <span class="main">(</span><span class="quoted">"_<span class="keyword1">|</span>_<span class="keyword1">|</span>"</span> <span class="main">[</span>1000<span class="main">]</span> 1000<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexmax_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">|</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lexmax.simps diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3.2›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3.2(1)›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma3_2_1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">↓m</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">=</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">α</span> <span class="skolem">σ</span><span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="skolem">σ</span><span class="main">|</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="skolem">σ</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⊆</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Cons<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> diff_def dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">⊆</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
   <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> dm <span class="free">r</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> A Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False ds_ds_subseteq_ds<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mem lemma2_6_1_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_multiset lexmax.simps dl_def dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3.2(2)›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma3_2_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">|</span> <span class="main">=</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def ds_def lexmax.simps <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> diff_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">α</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="main">(</span><span class="skolem">α</span><span class="main">#</span><span class="skolem">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="main">(</span><span class="skolem">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="skolem">σ</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">{#</span><span class="skolem">α</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="skolem">σ</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_8 <span class="keyword1"><span class="command">unfolding</span></span> union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="skolem">α</span><span class="main">#</span><span class="skolem">σ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="skolem">α</span><span class="main">#</span><span class="skolem">σ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="main">(</span><span class="skolem">α</span><span class="main">#</span><span class="skolem">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_9 dl_def dm_def lemma2_6_1_set<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Definition 3.3›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">τ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">σ'</span></span></span> <span class="free"><span class="bound"><span class="entity">τ'</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">τ'</span></span></span><span class="main">|</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">|</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free"><span class="bound"><span class="entity">r</span></span></span>
                 <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">@</span><span class="free"><span class="bound"><span class="entity">σ'</span></span></span><span class="main">|</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">τ</span></span></span><span class="main">|</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> D_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> D_def lemma3_2_2 <span class="keyword1"><span class="command">using</span></span> union_commute lemma2_6_6_b' <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> D_def lemma3_2_2 <span class="keyword1"><span class="command">using</span></span> union_commute lemma2_6_6_b' <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> D_inv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
                                                <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> D_def lemma3_2_2 <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> D<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span>  <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>
                        <span class="main">∧</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms D_eq D_inv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mirror_D<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">σ</span> <span class="free">τ</span> <span class="free">τ'</span> <span class="free">σ'</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms D <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proposition 3.4›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LD_1'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LD_1'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">=</span>
 <span class="main">(</span>set <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="main">⊆</span> ds <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">}</span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">⊆</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">}</span> <span class="main">∧</span> set <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">⊆</span> ds <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LD'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>
  <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LD'</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="free"><span class="bound"><span class="entity">τ1</span></span></span> <span class="free"><span class="bound"><span class="entity">τ2</span></span></span> <span class="free"><span class="bound"><span class="entity">τ3</span></span></span> <span class="main">=</span> <span class="main">(</span>LD_1' <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">∧</span> LD_1' <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">τ1</span></span></span> <span class="free"><span class="bound"><span class="entity">τ2</span></span></span> <span class="free"><span class="bound"><span class="entity">τ3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹auxiliary properties on multisets›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexmax_le_multiset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">⊆#</span> mset <span class="free">σ</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lexmax.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">τ</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="skolem">τ</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">s</span><span class="main">}</span> <span class="main">⊆#</span> mset <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemmaA_3_10 mset_subset_eq_add_right subset_mset.order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> split<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LD_1' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="free">σ1</span> <span class="free">σ2</span> <span class="free">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ2</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free">σ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span>  LD_1'_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">σ2</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> proposition3_4_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LD_1' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="free">σ1</span> <span class="free">σ2</span> <span class="free">σ3</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ1</span><span class="main">@</span><span class="free">σ2</span><span class="main">@</span><span class="free">σ3</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="main">(</span>dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span><span class="main">)</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">σ1</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LD'_def LD_1'_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> submultiset_implies_subset<span class="main">[</span><span class="operator">OF</span> lexmax_le_multiset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> one<span class="main">:</span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="free">σ1</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_implies_remove_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="free">σ3</span> <span class="main">⊆</span> dl <span class="free">r</span> <span class="free">σ2</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">σ1</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">⊆</span> <span class="var">?r</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LD'_def LD_1'_def dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ3</span><span class="main">)</span> <span class="main">⊆</span> <span class="var">?r</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> submultiset_implies_subset<span class="main">[</span><span class="operator">OF</span> lexmax_le_multiset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> pre3<span class="main">:</span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="free">σ3</span> <span class="keyword1">-s</span> <span class="var">?r</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_implies_remove_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">σ2</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> two<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ2</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pre3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ3</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ2</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> True dl_def lemmaA_3_9 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> three<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ3</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ2</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span><span class="main">,</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove_is_empty_imp_mul <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> three <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 lexmax_singleton lemmaA_3_8 one two mul_def mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ2</span> <span class="main">=</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> split<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> two<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ2</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span><span class="main">,</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_8<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> empty_subsetI<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> eq lexmax.simps diff_from_empty lemmaA_3_9 diff_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> pre3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="free">σ3</span> <span class="keyword1">-s</span> <span class="main">(</span><span class="main">(</span>dl <span class="free">r</span> <span class="free">σ2</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">σ1</span> <span class="main">∪</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq lemmaA_3_9 <span class="keyword1"><span class="command">using</span></span> Un_assoc Un_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> three<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ3</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ2</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ1</span><span class="main">)</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">β</span><span class="main">#}</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Un_absorb <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_9 eq dm_def dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 lexmax_singleton lemmaA_3_8 one three <span class="keyword1"><span class="command">using</span></span> two <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proposition3_4<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LD' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="free">σ1</span> <span class="free">σ2</span> <span class="free">σ3</span> <span class="free">τ1</span> <span class="free">τ2</span> <span class="free">τ3</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">[</span><span class="free">β</span><span class="main">]</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">(</span><span class="free">σ1</span><span class="main">@</span><span class="free">σ2</span><span class="main">@</span><span class="free">σ3</span><span class="main">)</span> <span class="main">(</span><span class="free">τ1</span><span class="main">@</span><span class="free">τ2</span><span class="main">@</span><span class="free">τ3</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> proposition3_4_step<span class="main">[</span><span class="operator">OF</span> t i<span class="main">]</span> ld <span class="keyword1"><span class="command">unfolding</span></span> LD'_def D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> dl_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(*reverse direction*)</span>

<span class="keyword1"><span class="command">lemma</span></span> lexmax_decompose<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">σ3</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span><span class="main">=</span><span class="bound">σ1</span><span class="main">@</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">@</span><span class="bound">σ3</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="bound">σ1</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">β</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span><span class="main">=</span><span class="skolem">β</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ3</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span><span class="main">#</span><span class="skolem">as</span> <span class="main">=</span> <span class="skolem">σ1</span><span class="main">@</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">@</span><span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span><span class="skolem">as</span><span class="main">|</span><span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span><span class="skolem">as</span><span class="main">|</span> <span class="main">∧</span> <span class="free">α</span> <span class="main">∉</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">=</span> <span class="skolem">σ1</span> <span class="main">@</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">β</span><span class="main">#</span><span class="skolem">as</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β</span><span class="main">#</span><span class="skolem">σ1</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="main">(</span><span class="skolem">β</span><span class="main">#</span><span class="skolem">σ1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x w <span class="keyword1"><span class="command">unfolding</span></span> dm_def dl_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexmax_elt<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">σ</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> set_mset <span class="free">r</span><span class="main">|</span><span class="skolem">as</span><span class="main">|</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True
   <span class="keyword1"><span class="command">from</span></span> Cons True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> set_mset <span class="free">r</span><span class="main">|</span><span class="skolem">as</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> transD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> s <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">unfolding</span></span> lexmax.simps diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">unfolding</span></span> diff_def dm_def ds_def lexmax.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lexmax_set<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">⊆</span> <span class="free">r</span> <span class="keyword1">↓s</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="free">σ</span> <span class="main">⊆</span> <span class="free">r</span> <span class="keyword1">↓s</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">σ</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">from</span></span> lexmax_elt<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> A False<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">r</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">∈</span> set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> rel assms transD <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> drop_left_mult_eq<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">+</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">N</span><span class="main">,</span><span class="free">M</span><span class="main">+</span><span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">N</span><span class="main">,</span><span class="main">{#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_b'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{#}</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span> <span class="main">∧</span> <span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span> <span class="main">∧</span> set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹generalized to lists›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> proposition3_4_inv_lists<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">β</span><span class="main">,</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="main">=</span> <span class="bound">σ1</span><span class="main">@</span><span class="bound">σ2</span><span class="main">@</span><span class="bound">σ3</span><span class="main">)</span> <span class="main">∧</span> set <span class="bound">σ1</span> <span class="main">⊆</span> dl <span class="free">r</span> <span class="free">β</span> <span class="main">∧</span> length <span class="bound">σ2</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="bound">σ2</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span> set <span class="bound">σ3</span> <span class="main">⊆</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">α</span><span class="main">#</span><span class="free">β</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈#</span> <span class="var">?M</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ3</span></span> <span class="keyword2"><span class="keyword">where</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span><span class="main">=</span><span class="skolem">σ1</span><span class="main">@</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">@</span><span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> alpha<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lexmax_decompose <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="skolem">σ1</span><span class="main">|</span><span class="keyword1">-s</span>dl <span class="free">r</span> <span class="free">β</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="main">[</span><span class="free">α</span><span class="main">]</span><span class="main">|</span><span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="skolem">σ1</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="skolem">σ3</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="skolem">σ1</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">β</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M1</span> <span class="main">+</span> <span class="var">?M2</span> <span class="main">+</span> <span class="var">?M3</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> k <span class="keyword1"><span class="command">unfolding</span></span> sigma lemma3_2_2 lemmaA_3_8 lemmaA_3_9 LD_1'_def union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> True <span class="keyword1"><span class="command">have</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">α</span> <span class="main">∉</span> dl <span class="free">r</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M2</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lexmax_singleton diff_def <span class="keyword1"><span class="command">using</span></span> alpha <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M1</span><span class="main">+</span><span class="var">?M3</span> <span class="main">+</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">,</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dec union_assoc union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M1</span><span class="main">+</span><span class="var">?M3</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> drop_left_mult_eq assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="skolem">σ1</span><span class="main">|</span><span class="keyword1">-s</span>dl <span class="free">r</span> <span class="free">β</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span><span class="skolem">σ1</span><span class="main">|</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove_empty_implies_subset <span class="keyword1"><span class="command">unfolding</span></span> dl_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> sigma1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">σ1</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lexmax_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> sigma2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> sub<span class="main">:</span><span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="skolem">σ1</span> <span class="main">⊆</span> dl <span class="free">r</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_imp_ds_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> sigma1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> sub2<span class="main">:</span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="skolem">σ1</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">β</span> <span class="main">=</span> dl <span class="free">r</span> <span class="free">β</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="var">?M3</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span><span class="skolem">σ3</span><span class="main">|</span><span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Un_assoc sub2 <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span><span class="skolem">σ3</span><span class="main">|</span><span class="keyword1">-s</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_set<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span><span class="skolem">σ3</span><span class="main">|</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> remove_empty_implies_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> sigma3<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">σ3</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lexmax_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sigma sigma1 sigma2 sigma3 <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def append_Cons append_Nil sigma2<span class="main">)</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?M</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_singleton<span class="main">[</span><span class="operator">OF</span> k<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> diff_eq_singleton_imp<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def dm_def dl_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="free">σ</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">}</span> <span class="main">∪</span> <span class="main">(</span>set <span class="free">β</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lexmax_set<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil bot_least empty_set le0 length_0_conv<span class="main">)</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> proposition3_4_inv_step<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="main">[</span><span class="free">β</span><span class="main">]</span><span class="main">,</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?M</span><span class="main">,</span><span class="main">_</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="free">σ</span> <span class="main">=</span> <span class="bound">σ1</span><span class="main">@</span><span class="bound">σ2</span><span class="main">@</span><span class="bound">σ3</span><span class="main">)</span> <span class="main">∧</span> LD_1' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> proposition3_4_inv_lists<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> LD_1'_def dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> proposition3_4_inv<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">[</span><span class="free">β</span><span class="main">]</span> <span class="main">[</span><span class="free">α</span><span class="main">]</span> <span class="free">σ</span> <span class="free">τ</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span> <span class="bound">τ1</span> <span class="bound">τ2</span> <span class="bound">τ3</span><span class="main">.</span> <span class="main">(</span><span class="free">σ</span> <span class="main">=</span> <span class="bound">σ1</span><span class="main">@</span><span class="bound">σ2</span><span class="main">@</span><span class="bound">σ3</span> <span class="main">∧</span> <span class="free">τ</span> <span class="main">=</span> <span class="bound">τ1</span><span class="main">@</span><span class="bound">τ2</span><span class="main">@</span><span class="bound">τ3</span> <span class="main">∧</span> LD' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span> <span class="bound">τ1</span> <span class="bound">τ2</span> <span class="bound">τ3</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> proposition3_4_inv_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> D_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lexmax_singleton LD'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3.5›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">υ</span> <span class="free">σ'</span> <span class="free">σ''</span> <span class="free">υ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span> <span class="main">@</span> <span class="free">υ</span> <span class="main">@</span> <span class="free">σ''</span><span class="main">)</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span> <span class="main">@</span> <span class="free">υ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span> <span class="main">@</span> <span class="free">υ</span> <span class="main">@</span> <span class="free">σ''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span> <span class="main">@</span> <span class="free">υ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ''</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> append_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ''</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">υ</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lemma2_6_1_list lemmaA_3_9 Un_commute<span class="main">)</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> t lemma2_6_5_a'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t D_eq<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">σ</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> t D_eq<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_trans<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> claim1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">|</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">υ'</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∩s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">τ</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?F</span><span class="main">+</span><span class="var">?H</span><span class="main">,</span><span class="var">?G</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?F</span><span class="main">,</span><span class="var">?G</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?H</span> <span class="main">⊆</span> <span class="main">(</span>dm <span class="free">r</span> <span class="var">?G</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span>dm <span class="free">r</span> <span class="var">?F</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span> <span class="main">⊆</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="var">?H</span> <span class="main">=</span> set_mset <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">∩s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_11 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">⊆</span> <span class="main">(</span>dl <span class="free">r</span> <span class="free">τ</span> <span class="main">-</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def intersect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">(</span>dl <span class="free">r</span> <span class="free">σ</span> <span class="main">∪</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">-</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_multiset lemma3_2_1<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_7_a<span class="main">[</span><span class="operator">OF</span> t 2 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step3<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="keyword1">↓l</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">(</span><span class="free">r</span> <span class="keyword1">↓m</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span> <span class="main">=</span> dm <span class="free">r</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">σ'</span><span class="main">)</span> <span class="main">=</span> dm <span class="free">r</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_list lemma3_2_1<span class="main">[</span><span class="operator">OF</span> t<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> lemma2_6_1_multiset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> lemma2_6_2_b<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> lemma3_2_1<span class="main">[</span><span class="operator">OF</span> t<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> D_def a b<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> claim2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">υ'</span><span class="main">|</span> <span class="keyword1">-s</span>  <span class="free">r</span> <span class="keyword1">↓l</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">τ</span><span class="main">,</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">υ'</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">σ'</span><span class="main">)</span> <span class="keyword1">-s</span> <span class="free">r</span> <span class="keyword1">↓l</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_9 append_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lemma2_6_1_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_8<span class="main">[</span><span class="operator">OF</span> t dl_monotone<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dm <span class="free">r</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_8<span class="main">[</span><span class="operator">OF</span> t step3<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ'</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_1<span class="main">[</span><span class="operator">OF</span> t<span class="main">,</span><span class="operator">symmetric</span><span class="main">]</span> lemma2_6_1_multiset lemmaA_3_9<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_trans<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">υ</span> <span class="free">σ'</span> <span class="free">σ''</span> <span class="free">υ'</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="main">(</span><span class="free">σ</span> <span class="main">@</span> <span class="free">τ'</span> <span class="main">@</span> <span class="free">υ'</span><span class="main">)</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> 0<span class="main">:</span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">@</span><span class="free">υ'</span><span class="main">)</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> append_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">∩s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lemmaA_3_10 <span class="keyword1"><span class="command">unfolding</span></span> union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="free">σ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">@</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> assms claim1 lemma2_6_6_a union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="free">σ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">σ'</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> claim2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?R</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="free">σ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">υ</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> lemma2_6_5_a'<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> D_eq<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span>4<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="free">σ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> union_assoc lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_trans<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">υ</span> <span class="free">σ'</span> <span class="free">σ''</span> <span class="free">υ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">)</span> <span class="free">σ</span> <span class="free">σ''</span> <span class="main">(</span><span class="free">τ'</span><span class="main">@</span><span class="free">υ'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">unfolding</span></span> D_def append_assoc <span class="keyword1"><span class="command">using</span></span> assms lemma3_5_1 lemma3_5_2 union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> step2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">τ</span><span class="main">=</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">M</span> <span class="keyword1">∩s</span>dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> intersect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma2_6_4<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3.6›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> lemma3_6<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">υ</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">@</span><span class="free">υ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?L</span><span class="main">,</span><span class="var">?R</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">υ</span><span class="main">)</span> <span class="keyword1">∩s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">υ</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_10<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">υ</span><span class="main">)</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R2</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> lemma2_6_9<span class="main">[</span><span class="operator">OF</span> t step2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t ne<span class="main"><span class="main">]</span></span><span class="main">]</span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R2</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">σ'</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> lemmaA_3_8 union_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lexmax <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">@</span><span class="free">σ'</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">…</span><span class="main">,</span>lexmax <span class="free">r</span> <span class="free">σ</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="free">τ</span> <span class="main">+</span> <span class="main">(</span>lexmax <span class="free">r</span> <span class="free">υ</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">,</span><span class="var">?R5</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> D_def <span class="keyword1"><span class="command">using</span></span> lemma2_6_6_a<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?R5</span> <span class="main">=</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_and_mul_eq_imp_mul t <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_6_v<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="free">τ</span> <span class="free">σ</span> <span class="free">σ'</span> <span class="free">τ'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ'</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">υ</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">@</span><span class="free">υ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms lemma3_6 mirror_D <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Labeled Rewriting›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Theorem 3.7›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="main">(</span><span class="tfree">'b</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span>list<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">seq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ars</span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq</span> <span class="free">ars</span>"</span></span>
     <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">seq</span> <span class="free">ars</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lst</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> snd <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> fst <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="keyword1">else</span> snd <span class="main">(</span>last <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹results on seqs›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> seq_tail1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">lars</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">lars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span>fst <span class="free">x</span><span class="main">,</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">lars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> lst <span class="main">(</span>snd <span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span><span class="main">∈</span> seq <span class="free">lars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span>fst <span class="free">x</span><span class="main">,</span>snd <span class="free">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">lars</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> lst <span class="main">(</span>snd <span class="free">x</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seq_chop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">@</span><span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> k<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">#</span><span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="free">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_tail1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> append.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> seq_tail1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> k<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span><span class="main">,</span><span class="free">ts</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_tail1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> append.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seq_concat_helper<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss2</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">ss2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span> <span class="main">∧</span> <span class="main">(</span>lst <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst <span class="free">ss2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ss2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mem<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span>fst <span class="skolem">x</span><span class="main">,</span>snd <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> seq_tail1<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons seq.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mem<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seq_concat<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss2</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="free">ss1</span> <span class="main">=</span> fst <span class="free">ss2</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst <span class="free">ss2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_concat_helper assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst <span class="free">ss2</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms surjective_pairing seq_concat_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹diagrams›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">diagram</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">diagram</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">in</span> <span class="main">{</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">∧</span>
   fst <span class="bound">σ</span> <span class="main">=</span> fst <span class="bound">τ</span> <span class="main">∧</span> lst <span class="bound">σ</span> <span class="main">=</span> fst <span class="bound">τ'</span> <span class="main">∧</span> lst <span class="bound">τ</span> <span class="main">=</span> fst <span class="bound">σ'</span> <span class="main">∧</span> lst <span class="bound">σ'</span> <span class="main">=</span> lst <span class="bound">τ'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">labels</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">labels</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> map fst <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">D2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">D2</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">in</span> D <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>labels <span class="bound">τ</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ'</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_d<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">υ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="free">υ'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">τ</span><span class="main">,</span>snd <span class="free">τ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="main">(</span>fst <span class="free">τ'</span><span class="main">)</span><span class="main">,</span>snd <span class="free">τ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> tau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> upsilon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">υ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> o<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="free">τ</span> <span class="main">=</span> fst <span class="free">υ</span>"</span></span>
            <span class="keyword2"><span class="keyword">and</span></span> tau'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">τ'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> upsilon'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">υ'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="free">τ'</span> <span class="main">=</span> fst <span class="free">υ'</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms seq_concat<span class="main">[</span><span class="operator">OF</span> tau' upsilon' l<span class="main">]</span> seq_concat<span class="main">[</span><span class="operator">OF</span> tau upsilon o<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_d_v<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">τ'</span><span class="main">,</span><span class="free">υ</span><span class="main">,</span><span class="free">υ'</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span>snd <span class="free">σ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ'</span><span class="main">,</span>snd <span class="free">σ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">τ</span><span class="main">,</span><span class="free">τ'</span><span class="main">,</span><span class="free">σ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">υ</span><span class="main">,</span><span class="free">τ'</span><span class="main">,</span><span class="free">τ''</span><span class="main">,</span><span class="free">υ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5_d<span class="main">[</span><span class="operator">OF</span> d1 d2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5'<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">υ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="free">υ'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">τ</span><span class="main">,</span>snd <span class="free">τ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="main">(</span>fst <span class="free">τ'</span><span class="main">)</span><span class="main">,</span>snd <span class="free">τ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms lemma3_5<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5'_v<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">τ'</span><span class="main">,</span><span class="free">υ</span><span class="main">,</span><span class="free">υ'</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span> <span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span>snd <span class="free">σ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ'</span><span class="main">,</span>snd <span class="free">σ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> D1<span class="main">:</span><span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">τ</span><span class="main">,</span><span class="free">τ'</span><span class="main">,</span><span class="free">σ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> D2<span class="main">:</span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">υ</span><span class="main">,</span><span class="free">τ'</span><span class="main">,</span><span class="free">τ''</span><span class="main">,</span><span class="free">υ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> D2_def <span class="keyword1"><span class="command">using</span></span> mirror_D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> D1 D2<span class="main">]</span> mirror_D<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> trivial_diagram<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>lst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms seq.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> diagram_def Let_def lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> trivial_D2<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>lst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> D2_def D_def labels_def <span class="keyword1"><span class="command">using</span></span> mul_eq_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="comment1">(* lift to combined concept *)</span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">DD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">DD</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span>diagram <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">∧</span> D2 <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_DD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">υ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="free">υ'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">τ</span><span class="main">,</span>snd <span class="free">τ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ''</span><span class="main">,</span><span class="main">(</span>fst <span class="free">τ'</span><span class="main">)</span><span class="main">,</span>snd <span class="free">τ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lemma3_5_d lemma3_5'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> lemma3_5_DD_v<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ'</span><span class="main">,</span><span class="free">υ</span><span class="main">,</span><span class="free">υ'</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span> <span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span>snd <span class="free">σ</span><span class="main">@</span>snd <span class="free">υ</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ'</span><span class="main">,</span>snd <span class="free">σ'</span><span class="main">@</span>snd <span class="free">υ'</span><span class="main">)</span><span class="main">,</span><span class="free">τ''</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lemma3_5_d_v lemma3_5'_v <span class="keyword1"><span class="command">unfolding</span></span> DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> trivial_DD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="main">(</span>fst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span>lst <span class="free">σ</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms trivial_diagram trivial_D2 <span class="keyword1"><span class="command">unfolding</span></span> DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> mirror_DD<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">σ</span><span class="main">,</span><span class="free">τ</span><span class="main">,</span><span class="free">τ'</span><span class="main">,</span><span class="free">σ'</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms mirror_D <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹well-foundedness of rel r›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">measure</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="tfree">'b</span> multiset"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">measure</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span>labels <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">|</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">|</span>labels <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">)</span><span class="main">|</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq<span class="main">)</span> rel"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pex</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">P1</span><span class="main">,</span><span class="bound">P2</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>measure <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">P1</span><span class="main">,</span>measure <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">P2</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wfi<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">relr</span> <span class="main">=</span> pex <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wf <span class="main">(</span><span class="free">relr</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> wf <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SN <span class="main">(</span><span class="main">(</span><span class="free">relr</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> SN_iff_wf converse_converse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">,</span> <span class="skolem">s</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">relr</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_def SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> fact<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">s</span> <span class="bound">i</span><span class="main">)</span><span class="main">,</span> measure <span class="free">r</span> <span class="main">(</span><span class="skolem">s</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main">¯</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> pex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> SN <span class="main">(</span><span class="main">(</span>mul <span class="free">r</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chain_imp_not_SN_on<span class="main">[</span><span class="operator">OF</span> fact<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> SN_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> SN_iff_wf converse_converse <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wf<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>pex <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_mul<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> wfi <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹main result›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">peak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">peak</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span> <span class="main">{</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">∧</span> fst <span class="bound">τ</span> <span class="main">=</span> fst <span class="bound">σ</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">local_peak</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">local_peak</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">τ</span><span class="main">,</span><span class="bound">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">in</span> peak <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="bound">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">∧</span> length <span class="main">(</span>snd <span class="bound">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹proof of Theorem 3.7›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> LD_imp_D<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>local_peak <span class="free">ars</span> <span class="bound">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">P</span><span class="main">,</span>snd <span class="bound">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">P</span><span class="main">,</span>snd <span class="free">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> acyclic_irrefl trancl_id wf_acyclic <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>pex <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>wf_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> decompose<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tau<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sigma<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> tau_s<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sigma_s<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">τ</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> mirror_DD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i trivial_DD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sigma<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_s sigma_s Nil surjective_pairing <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">β_step</span> <span class="skolem">υ_step</span><span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> tau_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">υ_step</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> tau_s surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">hence</span></span> tau2<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">υ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tau <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> trivial_DD<span class="main">[</span><span class="operator">OF</span> tau<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_s sigma_s Nil surjective_pairing <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">α_step</span> <span class="skolem">ρ_step</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sigma_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">ρ_step</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> sigma_s surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> sigma2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">ρ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sigma <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> alpha<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">ρ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ρ</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> sigma2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> beta<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> upsilon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">υ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?υ</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> tau2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_peak <span class="free">ars</span> <span class="main">(</span><span class="var">?β</span><span class="main">,</span><span class="var">?α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alpha beta <span class="keyword1"><span class="command">unfolding</span></span> local_peak_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span><span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?β</span><span class="main">,</span><span class="var">?α</span><span class="main">,</span><span class="skolem">κ</span><span class="main">,</span><span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> kappa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">κ</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> P_IH1<span class="main">:</span> <span class="quoted"><span class="quoted">" peak <span class="free">ars</span> <span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> upsilon kappa D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> beta_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="var">?β</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">(</span>labels <span class="var">?β</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?α</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">κ</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> x1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="var">?α</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_6<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> beta_ne dec<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def decompose labels_def tau_dec <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="main">(</span><span class="var">?α</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?l</span><span class="main">,</span><span class="var">?r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command">unfolding</span></span> sigma_dec labels_def snd_conv list.map lexmax.simps diff_from_empty
     <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lemma2_6_2_a<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command">unfolding</span></span> sigma_s pex_def measure_def decompose <span class="keyword1"><span class="command">using</span></span> mul_and_mul_eq_imp_mul<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ'</span></span> <span class="skolem"><span class="skolem">υ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">,</span><span class="skolem">κ'</span><span class="main">,</span><span class="skolem">υ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ P_IH1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> decompose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> kappa'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">κ'</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> upsilon'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">υ'</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tau'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">μ</span><span class="main">,</span>snd <span class="skolem">μ</span><span class="main">@</span><span class="main">(</span>snd <span class="skolem">υ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?τ'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mu upsilon'<span class="main">]</span> D IH1 <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> DIH1<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="var">?α</span><span class="main">,</span><span class="skolem">κ'</span><span class="main">,</span><span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5_DD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i D IH1<span class="main">]</span> tau_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> dec_dih1<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?α</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">κ'</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DIH1 <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> P_IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tau' rho D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> alpha_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="var">?α</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">)</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_6_v<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i alpha_ne dec_dih1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def decompose labels_def sigma_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ'</span></span> <span class="skolem"><span class="skolem">τ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">,</span><span class="skolem">ρ'</span><span class="main">,</span><span class="skolem">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ P_IH2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5_DD_v<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i DIH1 IH2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv sigma_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹CR with unlabeling›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">unlabel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'a</span> rel"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">unlabel</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_imp_seq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span> <span class="main">∈</span> seq <span class="free">ars</span><span class="main">.</span> fst <span class="bound">ss</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> lst <span class="bound">ss</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> step<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> unlabel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ss</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?ss</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?ss</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ss <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> steps_imp_seq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ss</span> <span class="main">∈</span> seq <span class="free">ars</span><span class="main">.</span> fst <span class="bound">ss</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> lst <span class="bound">ss</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^^</span><span class="skolem">n</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">ars</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="skolem">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fst_eqD snd_conv lst_def eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="skolem">ars</span><span class="main">)</span><span class="main">^^</span><span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="skolem">ars</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> seq <span class="skolem">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss2<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">ss</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> ts1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> seq <span class="skolem">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ts3<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">ss</span> <span class="main">=</span> fst <span class="skolem">ts</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> Suc steps step_imp_seq<span class="main">[</span><span class="operator">OF</span> step<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">[</span><span class="operator">OF</span> ss1 ts1 eq<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ss2 ts3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> step_imp_unlabeled_step<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> unlabel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_imp_steps<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">ss</span> <span class="main">=</span> <span class="free">a</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="free">ss</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms surjective_pairing <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="skolem">ls</span><span class="main">)</span> <span class="main">∈</span> seq <span class="main">(</span><span class="free">ars</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="skolem">ls</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fst<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span>fst <span class="skolem">x</span><span class="main">,</span>snd <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons seq_tail1<span class="main">(</span>2<span class="main">)</span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons seq_tail1<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> step_imp_unlabeled_step<span class="main">[</span><span class="operator">OF</span> fst<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seq_vs_steps<span class="main">:</span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ss</span><span class="main">.</span> fst <span class="bound">ss</span> <span class="main">=</span> <span class="free">a</span> <span class="main">∧</span> lst <span class="bound">ss</span> <span class="main">=</span> <span class="free">b</span> <span class="main">∧</span> <span class="bound">ss</span> <span class="main">∈</span> seq <span class="free">ars</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> seq_imp_steps steps_imp_seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> D_imp_CR<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>peak <span class="free">ars</span> <span class="bound">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">P</span><span class="main">,</span>snd <span class="bound">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CR <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main">^*</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>unlabel <span class="free">ars</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>↓</sup></span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss1</span></span> <span class="skolem"><span class="skolem">ss2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">" peak <span class="free">ars</span> <span class="main">(</span><span class="skolem">ss1</span><span class="main">,</span><span class="skolem">ss2</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">ss1</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">ss2</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span>
   <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command">using</span></span> A B <span class="keyword1"><span class="command">unfolding</span></span> seq_vs_steps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss3</span></span> <span class="skolem"><span class="skolem">ss4</span></span> <span class="keyword2"><span class="keyword">where</span></span> dia<span class="main">:</span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="skolem">ss1</span><span class="main">,</span><span class="skolem">ss2</span><span class="main">,</span><span class="skolem">ss3</span><span class="main">,</span><span class="skolem">ss4</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> dia <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss3</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss4</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> ss3_1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ss3</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss3_2<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">ss3</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss4_1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ss4</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ss4_2<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="skolem">ss4</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> b c <span class="keyword1"><span class="command">unfolding</span></span> diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> seq_imp_steps<span class="main">[</span><span class="operator">OF</span> ss3 ss3_1 ss3_2<span class="main">]</span> seq_imp_steps<span class="main">[</span><span class="operator">OF</span> ss4 ss4_1 ss4_2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LD</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> rel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">lrs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> unlabel <span class="bound">lrs</span><span class="main">)</span> <span class="main">∧</span> trans <span class="bound">r</span> <span class="main">∧</span> wf <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>local_peak <span class="bound">lrs</span> <span class="bound">P</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> <span class="main">(</span>DD <span class="bound">lrs</span> <span class="bound">r</span> <span class="main">(</span>fst <span class="bound">P</span><span class="main">,</span>snd <span class="bound">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LD <span class="free">L</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CR <span class="free">ars</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms LD_imp_D D_imp_CR <span class="keyword1"><span class="command">unfolding</span></span> LD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Application: Newman's Lemma›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> measure<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> lab_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">lrs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">(</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">#</span> <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">lrs</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">α</span></span> <span class="quoted"><span class="free">t</span></span> <span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> trans_converse trans_trancl<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span> x <span class="keyword1"><span class="command">have</span></span> s0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">α</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">lrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> cs<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">u</span><span class="main">)</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems seq_tail1<span class="main">(</span>1<span class="main">)</span> snd_conv fst_conv seq_tail1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cs<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> key<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">β</span><span class="main">}</span> <span class="main">⊆</span> ds <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s0 cs seq_tail1<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> cs<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_def lab_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ih subset_imp_ds_subset<span class="main">[</span><span class="operator">OF</span> t key<span class="main">]</span> key <span class="keyword1"><span class="command">unfolding</span></span> x labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> newman<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"WCR <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"SN <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CR <span class="free">ars</span>"</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span>  <span class="main">{</span><span class="bound">a</span> <span class="main">.</span> <span class="main">∃</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">lrs</span></span> <span class="keyword2"><span class="keyword">where</span></span> lab_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">lrs</span>  <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">c</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">c</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

 <span class="keyword1"><span class="command">have</span></span> lab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ars</span> <span class="main">=</span> unlabel <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> unlabel_def lab_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> trans_converse trans_trancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_trancl trancl_converse <span class="keyword1"><span class="command">unfolding</span></span> SN_iff_wf <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">have</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">P</span><span class="main">.</span> <span class="main">(</span>local_peak <span class="skolem">lrs</span> <span class="bound">P</span> <span class="main">--&gt;</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="skolem">lrs</span> <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">P</span><span class="main">,</span>snd <span class="bound">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">P</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"local_peak <span class="skolem">lrs</span> <span class="skolem">P</span> <span class="main">--&gt;</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="skolem">lrs</span> <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">P</span><span class="main">,</span>snd <span class="skolem">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
   <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"local_peak <span class="skolem">lrs</span> <span class="skolem">P</span>"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="skolem">lrs</span> <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">P</span><span class="main">,</span>snd <span class="skolem">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?DD</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> lab_eq <span class="keyword1"><span class="command">have</span></span> lab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ars</span> <span class="main">=</span> unlabel <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> unlabel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">σ</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="skolem">lrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l1<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="skolem">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l2<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>snd <span class="skolem">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">σ</span><span class="main">)</span>"</span></span>
     <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ</span> <span class="main">=</span> fst <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> local_peak_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> l1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">τ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> tau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> alb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv insert_subset seq_tail1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">β</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alb <span class="keyword1"><span class="command">unfolding</span></span> lab_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> l2 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">σ</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv p prod.collapse tau<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> alc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ts <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_conv insert_subset seq_tail1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> snd_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> ac<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> a_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">α</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alb <span class="keyword1"><span class="command">unfolding</span></span> lab_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> tau sigma <span class="keyword1"><span class="command">have</span></span> fl<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∧</span> fst <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">∧</span> lst <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">∧</span> lst <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> ab ac <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span><span class="main">^*</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">c</span><span class="main">,</span><span class="skolem">d</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span><span class="main">^*</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">τ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> sigma'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> seq <span class="skolem">lrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sigma'1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span>
                           <span class="keyword2"><span class="keyword">and</span></span>  tau'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">τ'</span> <span class="main">∈</span> seq <span class="skolem">lrs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">c</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">d</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> steps_imp_seq <span class="keyword1"><span class="command">unfolding</span></span> lab <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> d<span class="main">:</span><span class="quoted"><span class="quoted">"diagram <span class="skolem">lrs</span> <span class="main">(</span>fst <span class="skolem">P</span><span class="main">,</span> snd <span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> P A ts fl <span class="keyword1"><span class="command">unfolding</span></span> local_peak_def peak_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span><span class="main">#</span> snd <span class="skolem">σ'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> seq.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> alb<span class="main">]</span> sigma' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> vv<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> measure<span class="main">[</span><span class="operator">OF</span> lab_eq s1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">σ'</span> <span class="main">=</span> <span class="skolem">b</span>›</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="main">(</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span><span class="main">#</span> snd <span class="skolem">τ'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="skolem">lrs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">c</span>›</span></span> seq.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> alc<span class="main">]</span> tau' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> ww<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">τ'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">{</span><span class="skolem">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> measure<span class="main">[</span><span class="operator">OF</span> lab_eq<span class="main">]</span> s2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹fst <span class="skolem">τ'</span> <span class="main">=</span> <span class="skolem">c</span>›</span></span> surjective_pairing<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SN_imp_acyclic acyclic_converse acyclic_irrefl assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> trancl_converse<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> vv ww <span class="keyword1"><span class="command">have</span></span> ld<span class="main">:</span> <span class="quoted"><span class="quoted">"LD' <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="skolem">β</span> <span class="skolem">α</span> <span class="main">(</span>labels <span class="skolem">σ'</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">(</span>labels <span class="skolem">τ'</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LD'_def LD_1'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span>labels <span class="main">(</span>fst <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels <span class="main">(</span>snd <span class="skolem">P</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">σ'</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proposition3_4<span class="main">[</span><span class="operator">OF</span> t i ld<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P sigma tau lst_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> d D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"DD <span class="skolem">lrs</span> <span class="main">(</span><span class="main">(</span><span class="free">ars</span><span class="main">^+</span><span class="main">)</span><span class="main">¯</span><span class="main">)</span> <span class="main">(</span>fst <span class="skolem">P</span><span class="main">,</span> snd <span class="skolem">P</span><span class="main">,</span> <span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LD <span class="skolem">L</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lab t w ps <span class="keyword1"><span class="command">unfolding</span></span> LD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sound <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conversion Version›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section follows~\cite{vO08a}.›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹auxiliary results on multisets›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> mul_eq_add_right<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">M</span><span class="main">+</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="free">M</span> <span class="main">+</span> <span class="main">{#}</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">{#}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mul_add_right<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">+</span><span class="free">P</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">+</span> <span class="free">P</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">+</span> <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="skolem">J</span> <span class="main">∪</span> set_mset <span class="free">P</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">+</span><span class="free">P</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def lemma2_6_1_set <span class="keyword1"><span class="command">using</span></span> union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="main">(</span><span class="skolem">J</span><span class="main">+</span><span class="free">P</span> <span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mul_eq_and_ds_imp_ds<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">N</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> k1<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="skolem">I</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">J</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="skolem">J</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> subset_imp_ds_subset<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> k1 a c <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lemma2_6_2_set<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="free">S</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> leq_imp_subseteq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">⊆#</span> <span class="free">N</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">M</span> <span class="main">⊆</span> set_mset <span class="free">N</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms mset_subset_eqD <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mul_add_mul_eq_imp_mul<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="free">N</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">P</span><span class="main">,</span><span class="free">Q</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">+</span><span class="free">P</span><span class="main">,</span><span class="free">N</span><span class="main">+</span><span class="free">Q</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="skolem"><span class="skolem">K</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">K</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">+</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I2</span></span> <span class="skolem"><span class="skolem">J2</span></span> <span class="skolem"><span class="skolem">K2</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">=</span> <span class="skolem">I2</span> <span class="main">+</span> <span class="skolem">K2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> <span class="skolem">I2</span> <span class="main">+</span> <span class="skolem">J2</span>"</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="skolem">K2</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="skolem">J2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">+</span> <span class="free">P</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">+</span> <span class="skolem">I2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">K</span> <span class="main">+</span> <span class="skolem">K2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b union_commute union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">N</span> <span class="main">+</span> <span class="free">Q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">I</span> <span class="main">+</span> <span class="skolem">I2</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">+</span> <span class="skolem">J2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a b union_commute union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="skolem">K</span> <span class="main">+</span> <span class="skolem">K2</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">(</span><span class="skolem">J</span> <span class="main">+</span> <span class="skolem">J2</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">unfolding</span></span> lemma2_6_1_multiset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">unfolding</span></span> mul_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹labeled conversion›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="main">(</span><span class="main">(</span>bool <span class="main">×</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> list<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">ars</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> <span class="free">conv</span> <span class="free">ars</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">conv</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">(</span>True<span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">conv</span> <span class="free">ars</span>"</span></span>
    <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">conv</span> <span class="free">ars</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="main">(</span>False<span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">conv</span> <span class="free">ars</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">labels_conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">labels_conv</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">measure_conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="tfree">'b</span> multiset"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">measure_conv</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> lexmax <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>labels_conv <span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lst_conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lst_conv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
 <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lst_conv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">d</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lst_conv</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">ss</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">local_diagram1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">local_diagram1</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">=</span>
  <span class="main">(</span>local_peak <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">σ1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ2</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">∧</span> lst <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="main">∧</span> lst <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">∧</span> lst <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LDD1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LDD1</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">=</span>  <span class="main">(</span>local_diagram1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">∧</span>
  LD_1' <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">σ1</span></span></span><span class="main">)</span> <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">σ2</span></span></span><span class="main">)</span> <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LDD</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LDD</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">β</span><span class="main">,</span><span class="bound">α</span><span class="main">,</span><span class="bound">σ1</span><span class="main">,</span><span class="bound">σ2</span><span class="main">,</span><span class="bound">σ3</span><span class="main">,</span><span class="bound">τ1</span><span class="main">,</span><span class="bound">τ2</span><span class="main">,</span><span class="bound">τ3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">d</span></span></span> <span class="keyword1">in</span> LDD1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">β</span> <span class="bound">α</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span> <span class="main">∧</span> LDD1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">α</span> <span class="bound">β</span> <span class="bound">τ1</span> <span class="bound">τ2</span> <span class="bound">τ3</span> <span class="main">∧</span> lst <span class="bound">σ3</span> <span class="main">=</span> lst <span class="bound">τ3</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">local_triangle1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">local_triangle1</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">=</span>
  <span class="main">(</span>local_peak <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">∈</span> seq <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">∧</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">σ1</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">}</span> <span class="main">⊆</span> conv <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">∧</span> lst <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="main">∧</span> lst_conv <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">∧</span> lst <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LT1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LT1</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">=</span> <span class="main">(</span>local_triangle1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">σ1</span></span></span> <span class="free"><span class="bound"><span class="entity">σ2</span></span></span> <span class="free"><span class="bound"><span class="entity">σ3</span></span></span> <span class="main">∧</span>
  LD_1' <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">α</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels_conv <span class="free"><span class="bound"><span class="entity">σ1</span></span></span><span class="main">)</span> <span class="main">(</span>labels <span class="free"><span class="bound"><span class="entity">σ2</span></span></span><span class="main">)</span> <span class="main">(</span>labels_conv <span class="free"><span class="bound"><span class="entity">σ3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LT</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars <span class="main">⇒</span> <span class="tfree">'b</span> rel <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> seq <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LT</span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">β</span><span class="main">,</span><span class="bound">α</span><span class="main">,</span><span class="bound">σ1</span><span class="main">,</span><span class="bound">σ2</span><span class="main">,</span><span class="bound">σ3</span><span class="main">,</span><span class="bound">τ1</span><span class="main">,</span><span class="bound">τ2</span><span class="main">,</span><span class="bound">τ3</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">in</span> LT1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">β</span> <span class="bound">α</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span> <span class="main">∧</span> LT1 <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="bound">α</span> <span class="bound">β</span> <span class="bound">τ1</span> <span class="bound">τ2</span> <span class="bound">τ3</span> <span class="main">∧</span> lst_conv <span class="bound">σ3</span> <span class="main">=</span> lst_conv <span class="bound">τ3</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_tail1<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">(</span><span class="free">d</span><span class="main">,</span><span class="free">α</span><span class="main">,</span><span class="free">t</span><span class="main">)</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="free">t</span><span class="main">,</span><span class="free">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_conv.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_chop<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss1</span><span class="main">@</span><span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss1</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss1</span><span class="main">)</span><span class="main">,</span><span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss1</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> conv.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_tail1<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">using</span></span> Cons conv.intros d1 d2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss1</span><span class="main">)</span><span class="main">,</span><span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss1</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> conv.intros <span class="keyword1"><span class="command">unfolding</span></span> last.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="main">(</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">ts</span> <span class="main">@</span> <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_tail1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec last.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_concat_helper<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss2</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">ss2</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span> <span class="main">∧</span> <span class="main">(</span>lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ls</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="free">ss2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ls</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">ss2</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prod_cases3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">hence</span></span> tl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> d2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lst<span class="main">:</span><span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">ss2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conv_tail1 Cons<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">xs</span><span class="main">@</span>snd <span class="skolem">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lst<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">xs</span><span class="main">@</span>snd <span class="skolem">ss2</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="skolem">ss2</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tl Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> lst<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> conv.intros d1 d2 <span class="keyword1"><span class="command">unfolding</span></span> dec lst_conv.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_concat<span class="main">:</span>
 <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss2</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="free">ss1</span> <span class="main">=</span> fst <span class="free">ss2</span>"</span></span>
 <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst_conv <span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="free">ss2</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat_helper assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst_conv <span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="free">ss2</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> assms surjective_pairing conv_concat_helper <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_concat_labels<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss1</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss2</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">ss1</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">ss2</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="main">(</span>fst <span class="free">ss1</span><span class="main">,</span>snd <span class="free">ss1</span><span class="main">@</span>snd <span class="free">ss2</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">∪</span> <span class="free">T</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> labels_conv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> seq_decompose<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">=</span> <span class="free">σ1'</span><span class="main">@</span><span class="free">σ2'</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="bound">σ1</span><span class="main">,</span><span class="bound">σ2</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span> <span class="main">∧</span> <span class="free">σ</span> <span class="main">=</span> <span class="main">(</span>fst <span class="bound">σ1</span><span class="main">,</span>snd <span class="bound">σ1</span><span class="main">@</span>snd <span class="bound">σ2</span><span class="main">)</span> <span class="main">∧</span> lst <span class="bound">σ1</span> <span class="main">=</span> fst <span class="bound">σ2</span> <span class="main">∧</span> lst <span class="bound">σ2</span> <span class="main">=</span> lst <span class="free">σ</span> <span class="main">∧</span> labels <span class="bound">σ1</span> <span class="main">=</span> <span class="free">σ1'</span> <span class="main">∧</span> labels <span class="bound">σ2</span> <span class="main">=</span> <span class="free">σ2'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> σ_dec <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="free">σ1'</span></span> <span class="quoted"><span class="free">σ2'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_tail1<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> steps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append_Cons append_Nil seq_chop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">x</span><span class="main">#</span>labels <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ1'</span><span class="main">@</span><span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def snd_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1'</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True
   <span class="keyword1"><span class="command">from</span></span> a True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ2'_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2'</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">#</span><span class="skolem">ls</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y1<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y2<span class="main">:</span><span class="quoted"><span class="quoted">"labels <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ1</span><span class="main">,</span> snd <span class="skolem">σ1</span> <span class="main">@</span> snd <span class="skolem">σ2</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ1</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span>
    <span class="quoted"><span class="quoted">"labels <span class="skolem">σ1</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ2</span> <span class="main">=</span> <span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x y2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> c<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">σ1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

   <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">=</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surjective_pairing<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">σ1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> snd <span class="skolem">σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih 1 <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2</span> <span class="main">=</span> <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x 1 2 3 surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">#</span> snd <span class="skolem">σ2</span><span class="main">)</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span>  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?σ1</span><span class="main">,</span><span class="var">?σ2</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>1<span class="main">)</span> seq_concat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> steps _ l<span class="main">]</span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="var">?σ1</span><span class="main">,</span> snd <span class="var">?σ1</span> <span class="main">@</span> snd <span class="var">?σ2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m 2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ1</span> <span class="main">=</span> fst <span class="var">?σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> m <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ2</span> <span class="main">=</span> lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">using</span></span> 2 3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="var">?σ2</span> <span class="main">=</span> <span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih y1 <span class="keyword1"><span class="command">unfolding</span></span> σ2'_dec labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">from</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="skolem"><span class="skolem">ls</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1'_dec<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ1'</span> <span class="main">=</span> <span class="skolem">l</span><span class="main">#</span><span class="skolem">ls</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> list.exhaust <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> y1<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y2<span class="main">:</span><span class="quoted"><span class="quoted">"labels <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ls</span> <span class="main">@</span> <span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ2</span></span> <span class="keyword2"><span class="keyword">where</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ1</span><span class="main">,</span> snd <span class="skolem">σ1</span> <span class="main">@</span> snd <span class="skolem">σ2</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"lst <span class="skolem">σ1</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ2</span> <span class="main">=</span> lst <span class="main">(</span>snd <span class="skolem">x</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ1</span> <span class="main">=</span> <span class="skolem">ls</span>"</span></span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ2</span> <span class="main">=</span> <span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span>  Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x y2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">#</span> snd <span class="skolem">σ1</span><span class="main">)</span><span class="main">,</span><span class="skolem">σ2</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?σ1</span><span class="main">,</span><span class="main">_</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> steps<span class="main">]</span> ih <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="var">?σ1</span><span class="main">,</span>snd <span class="var">?σ1</span><span class="main">@</span>snd <span class="skolem">σ2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ1</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ2</span> <span class="main">=</span> lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="var">?σ1</span> <span class="main">=</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih σ1'_dec y1 <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ2</span> <span class="main">=</span> <span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> seq_imp_conv<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">step</span><span class="main">.</span> <span class="main">(</span>True<span class="main">,</span><span class="bound">step</span><span class="main">)</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span> <span class="main">∧</span>
       lst_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">step</span><span class="main">.</span><span class="main">(</span>True<span class="main">,</span><span class="bound">step</span><span class="main">)</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> lst <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span> <span class="main">∧</span>
       labels <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">ss</span><span class="main">)</span> <span class="main">=</span> labels_conv <span class="main">(</span><span class="free">s</span><span class="main">,</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">step</span><span class="main">.</span><span class="main">(</span>True<span class="main">,</span><span class="bound">step</span><span class="main">)</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct <span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> lst_def labels_def labels_conv_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> conv.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t'_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_tail1<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span>2<span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> y1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span> map <span class="main">(</span>Pair True<span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       y2<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span> map <span class="main">(</span>Pair True<span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       y3<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> labels_conv <span class="main">(</span>snd <span class="skolem">t'</span><span class="main">,</span> map <span class="main">(</span>Pair True<span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span>True<span class="main">,</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">#</span>map <span class="main">(</span>Pair True<span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> step y1 conv.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> map <span class="main">(</span>Pair True<span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y2 <span class="keyword1"><span class="command">unfolding</span></span> list.map lst_def lst_conv.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> labels_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span>map <span class="main">(</span>Pair True<span class="main">)</span> <span class="main">(</span><span class="main">(</span>fst <span class="skolem">t'</span><span class="main">,</span>snd <span class="skolem">t'</span><span class="main">)</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y3 <span class="keyword1"><span class="command">unfolding</span></span> list.map labels_def labels_conv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">conv_mirror</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> conv"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">conv_mirror</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ss</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="keyword1">in</span> <span class="keyword1">case</span> <span class="bound">ss</span> <span class="keyword1">of</span>
             <span class="main">[]</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">ss</span><span class="main">)</span>
         <span class="main">|</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span> <span class="main">⇒</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">d</span><span class="main">,</span><span class="bound">α</span><span class="main">,</span><span class="bound">t</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="keyword1">in</span>
                   <span class="main">(</span>fst <span class="main">(</span><span class="free">conv_mirror</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>snd <span class="main">(</span><span class="free">conv_mirror</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span><span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="main">(</span><span class="main">¬</span><span class="bound">d</span><span class="main">,</span><span class="bound">α</span><span class="main">,</span><span class="bound">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_mirror<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"conv_mirror <span class="free">σ</span> <span class="main">∈</span> conv <span class="free">ars</span> <span class="main">∧</span>
      set <span class="main">(</span>labels_conv <span class="main">(</span>conv_mirror <span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>labels_conv <span class="free">σ</span><span class="main">)</span> <span class="main">∧</span>
      fst <span class="free">σ</span> <span class="main">=</span> lst_conv <span class="main">(</span>conv_mirror <span class="free">σ</span><span class="main">)</span> <span class="main">∧</span>
      lst_conv <span class="free">σ</span> <span class="main">=</span> fst <span class="main">(</span>conv_mirror <span class="free">σ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> σ_dec <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> conv.intros  conv_mirror.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> prod_cases3<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">d</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> 4<span class="main">:</span><span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t'</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> conv_tail1 <span class="keyword1"><span class="command">unfolding</span></span> t'_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="main">¬</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">α</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 2 3 conv.intros<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ conv.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> conv.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ conv.intros<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conv_mirror <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t'</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat<span class="main">[</span><span class="operator">OF</span> _ r <span class="main">]</span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> t'_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="main">(</span>conv_mirror <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>labels_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> labels_conv_def t'_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="main">(</span>conv_mirror <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t'_dec Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> conv_concat<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ r<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>conv_mirror <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> t'_dec 4 Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DD_subset_helper<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">@</span><span class="free">σ'</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> d<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">)</span> <span class="main">,</span> <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> assm<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span><span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> tau<span class="main">:</span><span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> subset_imp_ds_subset<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_and_ds_imp_ds<span class="main">[</span><span class="operator">OF</span> t d assm<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span><span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tau <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t dl_def dm_def le_sup_iff lemma3_2_1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> DD_subset_ds<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> DD<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> d1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ</span> <span class="main">@</span> labels <span class="free">σ'</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">τ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def D_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> d2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span> <span class="main">@</span> labels <span class="free">τ'</span><span class="main">|</span><span class="main">,</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def D_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> DD_subset_helper<span class="main">[</span><span class="operator">OF</span> t d1<span class="main">]</span> DD_subset_helper<span class="main">[</span><span class="operator">OF</span> t d2<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conv_imp_valley<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">@</span><span class="free">ρ_step</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">@</span><span class="free">υ_step</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span> <span class="main">⟹</span> peak <span class="free">ars</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">,</span> <span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">δ1</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="free">δ1</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span><span class="main">{#</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ</span> <span class="bound">τ</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span> <span class="main">∧</span> fst <span class="bound">σ</span> <span class="main">=</span> fst <span class="free">δ1</span> <span class="main">∧</span> fst <span class="bound">τ</span> <span class="main">=</span> lst_conv <span class="free">δ1</span> <span class="main">∧</span> lst <span class="bound">σ</span> <span class="main">=</span> lst <span class="bound">τ</span> <span class="main">∧</span> set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="bound">σ</span><span class="main">,</span><span class="bound">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> sigma1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ1</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> sigma1 <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>list.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">d</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">d</span><span class="main">,</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">hence</span></span> dic<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">β</span><span class="main">}</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec measure_conv_def labels_conv_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> one<span class="main">:</span><span class="quoted"><span class="quoted">"ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span> "</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">using</span></span> subset_imp_ds_subset<span class="main">[</span><span class="operator">OF</span> t dic<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span><span class="main">)</span>  <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> measure_conv_def labels_conv_def dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span> <span class="main">∪</span> ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> set_mset_def diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ts2<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dic one <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">using</span></span> conv_tail1<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ts ts2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="keyword2"><span class="keyword">where</span></span>
   ih<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">σ'</span><span class="main">,</span> <span class="skolem">τ</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span> <span class="main">∧</span> fst <span class="skolem">σ'</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span> fst <span class="skolem">τ</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">∧</span> lst <span class="skolem">σ'</span> <span class="main">=</span> lst <span class="skolem">τ</span> <span class="main">∧</span> set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> diff<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span>map fst <span class="main">(</span>snd <span class="skolem">σ'</span><span class="main">)</span><span class="main">|</span><span class="keyword1">-s</span>ds <span class="free">r</span> <span class="main">{</span><span class="skolem">β</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈#</span> <span class="free">r</span><span class="main">|</span>map fst <span class="main">(</span>snd <span class="skolem">σ'</span><span class="main">)</span><span class="main">|</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">d</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">hence</span></span> step<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_tail1<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">t</span><span class="main">)</span><span class="main">#</span> snd <span class="skolem">σ'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> step<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> ih<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="var">?σ</span><span class="main">,</span><span class="skolem">τ</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?σ</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">unfolding</span></span> dec lst_conv.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ</span> <span class="main">=</span> lst <span class="skolem">τ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="main">(</span><span class="skolem">β</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">#</span> snd <span class="skolem">σ'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>›</span></span> fst_conv ih seq_tail1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> snd_conv surjective_pairing<span class="main">)</span>
   <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="var">?σ</span><span class="main">,</span><span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff ih dic <span class="keyword1"><span class="command">unfolding</span></span> measure_def labels_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">hence</span></span> step<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_tail1<span class="main">(</span>3<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq.intros <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span><span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">σ'</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="var">?y</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq.intros <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> mp<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="var">?y</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih dic <span class="keyword1"><span class="command">unfolding</span></span> measure_def labels_def dm_def
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
   <span class="keyword1"><span class="command">hence</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="main">≠</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dec dic <span class="keyword1"><span class="command">unfolding</span></span> dm_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>measure <span class="free">r</span> <span class="var">?y</span><span class="main">,</span><span class="free">M</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mp <span class="keyword1"><span class="command">unfolding</span></span> dm_def mul_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0<span class="main">)</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span>fst <span class="free">α_step</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">,</span>measure <span class="free">r</span> <span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>2<span class="main">)</span> measure_def labels_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">unfolding</span></span> union_lcomm union_assoc<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>  <span class="keyword1"><span class="command">using</span></span> mul_eq_add_right<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> M<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{#</span>fst <span class="free">α_step</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> union_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">M</span><span class="main">,</span>measure <span class="free">r</span> <span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> mul_eq_trans t <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> w<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?y</span><span class="main">,</span><span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> assms<span class="main">(</span>1<span class="main">)</span> pex_def <span class="keyword1"><span class="command">using</span></span> mul_and_mul_eq_imp_mul<span class="main">[</span><span class="operator">OF</span> t x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ''</span></span> <span class="skolem"><span class="skolem">τ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> DD<span class="main">:</span><span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="skolem">t</span><span class="main">,</span><span class="main">[</span><span class="main">(</span><span class="skolem">β</span><span class="main">,</span><span class="skolem">s</span><span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">σ''</span><span class="main">,</span><span class="skolem">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> w p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> sigma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">σ''</span> <span class="main">=</span> fst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">t'</span> <span class="main">#</span> <span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ''</span> <span class="main">=</span> lst <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> tau''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">τ</span> <span class="main">=</span> fst <span class="skolem">τ''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD  <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> tau<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">τ</span><span class="main">,</span>snd <span class="skolem">τ</span> <span class="main">@</span> snd <span class="skolem">τ''</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?τ'''</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">τ''</span> <span class="main">=</span> lst <span class="main">(</span>fst <span class="skolem">τ</span><span class="main">,</span>snd <span class="skolem">τ</span><span class="main">@</span> snd <span class="skolem">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">[</span><span class="operator">OF</span> _ tau'' eq<span class="main">]</span> ih <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> tau2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?τ'''</span> <span class="main">=</span> lst_conv <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t'</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ''</span> <span class="main">=</span> lst <span class="var">?τ'''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD ih <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def dec lst_conv.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">σ''</span><span class="main">,</span><span class="skolem">τ''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>set_mset <span class="free">M</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD_subset_ds<span class="main">[</span><span class="operator">OF</span> t DD mp<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="skolem">σ''</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>labels <span class="skolem">τ</span><span class="main">|</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="skolem">τ''</span><span class="main">|</span> <span class="keyword1">-s</span> <span class="main">(</span>dl <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ih <span class="keyword1"><span class="command">unfolding</span></span> measure_def dm_def diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword1"><span class="command">hence</span></span> fin<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">σ''</span><span class="main">,</span><span class="var">?τ'''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="free">M</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> measure_def labels_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> lemma3_2_2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> sigma tau tau2 fin <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> labels_multiset<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span><span class="main">,</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span>  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="free">σ</span>"</span></span><span class="main">)</span>
 <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">=</span> <span class="main">{#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> mul_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">=</span> <span class="skolem">a</span><span class="main">#</span><span class="skolem">as</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> neq_Nil_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">hence</span></span> leq<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">=</span> <span class="main">{#</span><span class="free">α</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> leq lexmax.simps diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_reflexive <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> decreasing_imp_local_decreasing<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> DD<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ'</span><span class="main">,</span><span class="free">τ'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span><span class="main">=</span><span class="main">(</span>fst <span class="bound">σ1</span><span class="main">,</span>snd <span class="bound">σ1</span><span class="main">@</span>snd <span class="bound">σ2</span><span class="main">@</span>snd <span class="bound">σ3</span><span class="main">)</span> <span class="main">∧</span> lst <span class="bound">σ1</span><span class="main">=</span>fst <span class="bound">σ2</span> <span class="main">∧</span> lst <span class="bound">σ2</span> <span class="main">=</span> fst <span class="bound">σ3</span> <span class="main">∧</span> lst <span class="bound">σ3</span> <span class="main">=</span> lst <span class="free">σ'</span>
                 <span class="main">∧</span> LD_1' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="main">(</span>labels <span class="bound">σ1</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ2</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ3</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">τ'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">,</span><span class="free">β</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3</span><span class="main">.</span> <span class="main">(</span><span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="bound">σ1</span><span class="main">,</span>snd <span class="bound">σ1</span><span class="main">@</span>snd <span class="bound">σ2</span><span class="main">@</span>snd <span class="bound">σ3</span><span class="main">)</span> <span class="main">∧</span>
         lst <span class="bound">σ1</span> <span class="main">=</span> fst <span class="bound">σ2</span> <span class="main">∧</span> lst <span class="bound">σ2</span> <span class="main">=</span> fst <span class="bound">σ3</span> <span class="main">∧</span> lst <span class="bound">σ3</span> <span class="main">=</span> lst <span class="free">σ'</span> <span class="main">∧</span> LD_1' <span class="free">r</span> <span class="free">β</span> <span class="free">α</span> <span class="main">(</span>labels <span class="bound">σ1</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ2</span><span class="main">)</span> <span class="main">(</span>labels <span class="bound">σ3</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> DD <span class="keyword1"><span class="command">have</span></span> σ'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> DD <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">using</span></span> D_eq<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> t i<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span>ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"dl <span class="free">r</span> <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ds_ds_subseteq_ds<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span><span class="main">,</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_def lemma2_6_8 mul_eq_trans t<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">σ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">[</span><span class="free">β</span><span class="main">]</span><span class="main">,</span><span class="main">{#</span><span class="free">α</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> labels_multiset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">using</span></span> mul_eq_trans<span class="main">[</span><span class="operator">OF</span> t x<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">σ2'</span></span> <span class="skolem"><span class="skolem">σ3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span><span class="quoted"><span class="quoted">"labels <span class="free">σ'</span> <span class="main">=</span> <span class="skolem">σ1'</span><span class="main">@</span><span class="main">(</span><span class="skolem">σ2'</span><span class="main">@</span><span class="skolem">σ3'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ1'l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">σ1'</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   σ2'l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">σ2'</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="skolem">σ2'</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ3'l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">σ3'</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">α</span><span class="main">,</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> proposition3_4_inv_lists<span class="main">[</span><span class="operator">OF</span> t i x<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ23</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ1</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ23<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ23</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf1<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ1</span> <span class="main">=</span> fst <span class="skolem">σ23</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf1b<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="free">σ'</span> <span class="main">=</span> lst <span class="skolem">σ23</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   σ'_eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ1</span><span class="main">,</span>snd <span class="skolem">σ1</span><span class="main">@</span>snd <span class="skolem">σ23</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ1l<span class="main">:</span><span class="quoted"><span class="quoted">"labels <span class="skolem">σ1</span> <span class="main">=</span> <span class="skolem">σ1'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> l2<span class="main">:</span><span class="quoted"><span class="quoted">"labels <span class="skolem">σ23</span> <span class="main">=</span> <span class="skolem">σ2'</span><span class="main">@</span><span class="skolem">σ3'</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> seq_decompose<span class="main">[</span><span class="operator">OF</span> σ' l<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ2</span></span> <span class="skolem"><span class="skolem">σ3</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ2</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ3<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ3</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf2<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="skolem">σ2</span> <span class="main">=</span> fst <span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> lf2b<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="skolem">σ23</span> <span class="main">=</span> lst <span class="skolem">σ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   σ23_eq<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ23</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ2</span><span class="main">,</span>snd <span class="skolem">σ2</span><span class="main">@</span>snd <span class="skolem">σ3</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ2l<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ2</span> <span class="main">=</span> <span class="skolem">σ2'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ3l<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="skolem">σ3</span> <span class="main">=</span> <span class="skolem">σ3'</span>"</span></span>
   <span class="keyword1"><span class="command">using</span></span> seq_decompose<span class="main">[</span><span class="operator">OF</span> σ23 l2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">σ'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ1</span><span class="main">,</span> snd <span class="skolem">σ1</span> <span class="main">@</span> snd <span class="skolem">σ2</span> <span class="main">@</span> snd <span class="skolem">σ3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1 σ2 σ3 σ'_eq σ23_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ1</span> <span class="main">=</span> fst <span class="skolem">σ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lf1 σ23_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ2</span> <span class="main">=</span> fst <span class="skolem">σ3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lf2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ3</span> <span class="main">=</span> lst <span class="free">σ'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lf1b lf2b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1l σ1'l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="skolem">σ2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="skolem">σ2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">α</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ2l σ2'l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">α</span><span class="main">,</span> <span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ3l σ3'l <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> LD_1'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">τ'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">(</span><span class="main">{</span><span class="free">α</span><span class="main">,</span><span class="free">β</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ'</span><span class="main">|</span> <span class="keyword1">-s</span> dl <span class="free">r</span> <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span><span class="main">,</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ</span><span class="main">|</span> <span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD D_eq<span class="main">[</span><span class="operator">OF</span> t i<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="free">r</span><span class="main">|</span>labels <span class="free">τ</span><span class="main">|</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> leq_imp_subseteq<span class="main">[</span><span class="operator">OF</span> lexmax_le_multiset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t<span class="main"><span class="main">]</span></span><span class="main">]</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ'</span><span class="main">|</span><span class="keyword1">-s</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_and_ds_imp_ds<span class="main">[</span><span class="operator">OF</span> t x y<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> dl_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ'</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">β</span><span class="main">}</span> <span class="main">∪</span> ds <span class="free">r</span> <span class="main">(</span>set <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> diff_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">τ'</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span><span class="free">α</span><span class="main">,</span><span class="free">β</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ds_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lexmax_set<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> local_decreasing_extended_imp_decreasing<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LT1 <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="free">γ1</span> <span class="free">γ2</span> <span class="free">γ3</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">@</span><span class="free">υ_step</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">@</span><span class="free">ρ_step</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span> <span class="main">⟹</span> peak <span class="free">ars</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">,</span> <span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ1</span> <span class="bound">σ2</span> <span class="bound">σ3'</span> <span class="bound">γ1'''</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="bound">σ1</span><span class="main">,</span><span class="bound">σ2</span><span class="main">,</span><span class="bound">σ3'</span><span class="main">,</span><span class="bound">γ1'''</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span> <span class="main">∧</span>
  set <span class="main">(</span>labels <span class="bound">σ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span> length <span class="main">(</span>labels <span class="bound">σ2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="bound">σ2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="bound">σ3'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
  set <span class="main">(</span>labels <span class="bound">γ1'''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span>
  snd <span class="free">β_step</span> <span class="main">=</span> fst <span class="bound">σ1</span> <span class="main">∧</span> lst <span class="bound">σ1</span> <span class="main">=</span> fst <span class="bound">σ2</span> <span class="main">∧</span> lst <span class="bound">σ2</span> <span class="main">=</span> fst <span class="bound">σ3'</span> <span class="main">∧</span> lst <span class="bound">σ3'</span> <span class="main">=</span> lst <span class="bound">γ1'''</span> <span class="main">∧</span> fst <span class="bound">γ1'''</span> <span class="main">=</span> fst <span class="free">γ3</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms labels_multiset <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="free">γ2</span><span class="main">|</span><span class="main">,</span><span class="main">{#</span>fst <span class="free">α_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LT1_def local_triangle1_def LD_1'_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> γ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ1</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ3</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ2_l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">γ2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> γ2_s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="free">γ2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ3_s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">γ3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">γ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LT_def LD'_def LT1_def LD_1'_def labels_def local_triangle1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="free">γ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_conv_def <span class="keyword1"><span class="command">using</span></span> lexmax_le_multiset<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> set_mset_mset submultiset_implies_subset subset_trans<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> γ1_s<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="free">γ1</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">,</span> <span class="main">{#</span>fst <span class="free">β_step</span><span class="main">,</span> fst <span class="free">α_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_add_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{#</span><span class="main">_</span><span class="main">#}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ1'</span></span> <span class="skolem"><span class="skolem">γ1''</span></span> <span class="keyword2"><span class="keyword">where</span></span> γ1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ1'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ1''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ1''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eqx<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">γ1'</span> <span class="main">=</span> fst <span class="free">γ1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"fst <span class="skolem">γ1''</span> <span class="main">=</span> lst_conv <span class="free">γ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ1'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">γ1'</span> <span class="main">=</span> lst <span class="skolem">γ1''</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> m2<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">γ1'</span><span class="main">,</span><span class="skolem">γ1''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> conv_imp_valley<span class="main">[</span><span class="operator">OF</span> t IH γ1 γ1_s x<span class="main">]</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
 <span class="keyword1"><span class="command">hence</span></span> Q<span class="main">:</span><span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="main">(</span><span class="skolem">γ1''</span><span class="main">,</span><span class="free">γ2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="var">?Q</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LT_def LD'_def LT1_def local_triangle1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> m2 <span class="keyword1"><span class="command">have</span></span>  γ1's<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">γ1'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ1''s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">γ1''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def dm_def <span class="keyword1"><span class="command">using</span></span> lexmax_set<span class="main">[</span><span class="operator">OF</span> t<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> m2 <span class="keyword1"><span class="command">have</span></span> τ1'_m<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="skolem">γ1''</span><span class="main">|</span><span class="main">,</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_def mul_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dm_def empty_neutral<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_mset_single add_mset_not_empty<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="skolem">γ1''</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">γ2</span><span class="main">|</span><span class="main">,</span><span class="main">{#</span>fst <span class="free">α_step</span><span class="main">#}</span><span class="main">+</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_add_mul_eq_imp_mul<span class="main">[</span><span class="operator">OF</span> τ1'_m s2<span class="main">]</span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">r</span><span class="main">|</span>labels <span class="skolem">γ1''</span><span class="main">|</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>labels <span class="free">γ2</span><span class="main">|</span><span class="main">,</span> <span class="main">{#</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">#}</span> <span class="main">+</span> <span class="main">(</span><span class="free">r</span><span class="main">|</span>map fst <span class="free">ρ_step</span><span class="main">|</span><span class="keyword1">-s</span>ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">+</span> <span class="free">r</span><span class="main">|</span>map fst <span class="free">υ_step</span><span class="main">|</span><span class="keyword1">-s</span>ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_add_right<span class="main">[</span><span class="operator">OF</span> y<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> q<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?Q</span><span class="main">,</span><span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def labels_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> union_assoc union_commute union_lcomm<span class="main">)</span>
 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ1'''</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> DD<span class="main">:</span><span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">γ1''</span><span class="main">,</span><span class="free">γ2</span><span class="main">,</span><span class="skolem">σ'</span><span class="main">,</span><span class="skolem">γ1'''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> IH<span class="main">[</span><span class="operator">OF</span> q Q<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> DD <span class="keyword1"><span class="command">have</span></span> σ'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ1'''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">γ1'''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> decreasing_imp_local_decreasing<span class="main">[</span><span class="operator">OF</span> t i DD γ1''s γ2_l γ2_s<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1'</span></span> <span class="skolem"><span class="skolem">σ2'</span></span> <span class="skolem"><span class="skolem">σ3'</span></span> <span class="keyword2"><span class="keyword">where</span></span> σ'_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ'</span> <span class="main">=</span> <span class="main">(</span>fst <span class="skolem">σ1'</span><span class="main">,</span> snd <span class="skolem">σ1'</span> <span class="main">@</span> snd <span class="skolem">σ2'</span> <span class="main">@</span> snd <span class="skolem">σ3'</span><span class="main">)</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ1'</span> <span class="main">=</span> fst <span class="skolem">σ2'</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ2'</span> <span class="main">=</span> fst <span class="skolem">σ3'</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ3'</span> <span class="main">=</span> lst <span class="skolem">σ'</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> σ1s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ1'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ2l<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="skolem">σ2'</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ2's<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ2'</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ3'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> σ3's<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ3'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ1'''s<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">γ1'''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LD_1'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command">have</span></span> σ'_ds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">σ1'</span><span class="main">,</span> snd <span class="skolem">σ1'</span> <span class="main">@</span> snd <span class="skolem">σ2'</span> <span class="main">@</span> snd <span class="skolem">σ3'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ' σ'_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> σ1'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ1'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tmp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">σ2'</span><span class="main">,</span>snd <span class="skolem">σ2'</span><span class="main">@</span>snd <span class="skolem">σ3'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> σ'_ds<span class="main">]</span> surjective_pairing eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> σ2'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ2'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ3'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ3'</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> tmp<span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> surjective_pairing eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="skolem">γ1'</span> <span class="main">=</span> fst <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD γ1'_eq <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> σ'_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">have</span></span> σ1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">γ1'</span><span class="main">,</span>snd <span class="skolem">γ1'</span><span class="main">@</span>snd <span class="skolem">σ1'</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ1</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> eq0<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="main">(</span>fst <span class="skolem">γ1'</span><span class="main">,</span> snd <span class="skolem">γ1'</span> <span class="main">@</span> snd <span class="skolem">σ1'</span><span class="main">)</span> <span class="main">=</span> lst <span class="skolem">σ1'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">[</span><span class="operator">OF</span> γ1' σ1' eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="var">?σ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> σ1s γ1's <span class="keyword1"><span class="command">unfolding</span></span> labels_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">β_step</span> <span class="main">=</span> fst <span class="var">?σ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> LT1_def local_triangle1_def lst_def σ'_dec eqx <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ1</span> <span class="main">=</span> fst <span class="skolem">σ2'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq0 eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ3'</span> <span class="main">=</span> lst <span class="skolem">γ1'''</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> eq1 <span class="keyword1"><span class="command">using</span></span> DD <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">γ1'''</span> <span class="main">=</span> fst <span class="free">γ3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DD assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def LT1_def local_triangle1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> σ2' σ2's σ3' σ3's  γ1''' γ1'''s eq1 surjective_pairing σ2l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LDD_imp_DD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"LDD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="free">σ1</span><span class="main">,</span><span class="free">σ2</span><span class="main">,</span><span class="free">σ3</span><span class="main">,</span><span class="free">τ1</span><span class="main">,</span><span class="free">τ2</span><span class="main">,</span><span class="free">τ3</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def local_peak_def <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">α</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">α</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_butlast_last_id butlast_conv_take diff_self_eq_0 length_0_conv take_0 zero_neq_one<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> σl<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="free">σ</span> <span class="main">=</span> <span class="main">[</span>hd <span class="main">(</span>labels <span class="free">σ</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>  <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def local_peak_def <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="keyword2"><span class="keyword">where</span></span> l<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="free">τ</span> <span class="main">=</span> <span class="main">[</span><span class="skolem">β</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil append_butlast_last_id butlast_conv_take diff_self_eq_0 length_0_conv take_0 zero_neq_one<span class="main">)</span>
 <span class="keyword1"><span class="command">hence</span></span> τl<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="free">τ</span> <span class="main">=</span> <span class="main">[</span>hd <span class="main">(</span>labels <span class="free">τ</span><span class="main">)</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> σ'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">σ1</span><span class="main">,</span>snd <span class="free">σ1</span><span class="main">@</span>snd <span class="free">σ2</span><span class="main">@</span>snd <span class="free">σ3</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> τ'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="free">τ1</span><span class="main">,</span>snd <span class="free">τ1</span><span class="main">@</span>snd <span class="free">τ2</span><span class="main">@</span>snd <span class="free">τ3</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?τ'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def local_peak_def peak_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD seq_concat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_eqD<span class="main">)</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fst_eqD seq_concat<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_eqD<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> sigmas<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?σ'</span> <span class="main">=</span> fst <span class="free">σ1</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?σ'</span> <span class="main">=</span> lst <span class="free">σ3</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def local_peak_def peak_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> σ' append_assoc seq_chop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> seq_concat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> seq_concat_helper<span class="main">)</span>
 <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> taus<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="var">?τ'</span> <span class="main">=</span> fst <span class="free">τ1</span>"</span></span> <span class="quoted"><span class="quoted">"lst <span class="var">?τ'</span> <span class="main">=</span> lst <span class="free">τ3</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def local_peak_def peak_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> τ' append_assoc seq_chop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> seq_concat<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> seq_concat_helper<span class="main">)</span>
 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"diagram <span class="free">ars</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="var">?σ'</span><span class="main">,</span><span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def diagram_def local_peak_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> sigmas taus σ' τ' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D2 <span class="free">r</span> <span class="main">(</span><span class="free">τ</span><span class="main">,</span><span class="free">σ</span><span class="main">,</span><span class="var">?σ'</span><span class="main">,</span><span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms proposition3_4<span class="main">[</span><span class="operator">OF</span> t i<span class="main">]</span> σl τl <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def D2_def LD'_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LT_imp_DD<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> i<span class="main">:</span><span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> IH<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span> <span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">@</span><span class="free">υ_step</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">@</span><span class="free">ρ_step</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span> <span class="main">⟹</span> peak <span class="free">ars</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">,</span> <span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="var">?P</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword2"><span class="keyword">and</span></span> LT<span class="main">:</span> <span class="quoted"><span class="quoted">"LT <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="free">γ1</span><span class="main">,</span><span class="free">γ2</span><span class="main">,</span><span class="free">γ3</span><span class="main">,</span><span class="free">δ1</span><span class="main">,</span><span class="free">δ2</span><span class="main">,</span><span class="free">δ3</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">κ</span> <span class="bound">μ</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="bound">κ</span><span class="main">,</span><span class="bound">μ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> LT <span class="keyword1"><span class="command">have</span></span> LTa<span class="main">:</span> <span class="quoted"><span class="quoted">"LT1 <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="free">γ1</span> <span class="free">γ2</span> <span class="free">γ3</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> LTb<span class="main">:</span> <span class="quoted"><span class="quoted">"LT1 <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="free">δ1</span> <span class="free">δ2</span> <span class="free">δ3</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> LT_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> local_decreasing_extended_imp_decreasing<span class="main">[</span><span class="operator">OF</span> LTa t i IH<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ1</span></span> <span class="skolem"><span class="skolem">σ2</span></span> <span class="skolem"><span class="skolem">σ3'</span></span> <span class="skolem"><span class="skolem">γ1'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> sigmas<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">σ2</span><span class="main">,</span><span class="skolem">σ3'</span><span class="main">,</span><span class="skolem">γ1'''</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    onetwo1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span> length <span class="main">(</span>labels <span class="skolem">σ2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="skolem">σ2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">∧</span>
    set <span class="main">(</span>labels <span class="skolem">σ3'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="skolem">γ1'''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span>
     snd <span class="free">β_step</span> <span class="main">=</span> fst <span class="skolem">σ1</span> <span class="main">∧</span> lst <span class="skolem">σ1</span> <span class="main">=</span> fst <span class="skolem">σ2</span> <span class="main">∧</span> lst <span class="skolem">σ2</span> <span class="main">=</span> fst <span class="skolem">σ3'</span> <span class="main">∧</span> lst <span class="skolem">σ3'</span> <span class="main">=</span> lst <span class="skolem">γ1'''</span> <span class="main">∧</span> fst <span class="skolem">γ1'''</span> <span class="main">=</span> fst <span class="free">γ3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> ih2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">!!</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">α_step</span><span class="main">]</span> <span class="main">@</span> <span class="free">ρ_step</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span> <span class="main">@</span> <span class="free">υ_step</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span> <span class="main">⟹</span> peak <span class="free">ars</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">y</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">,</span> <span class="bound">σ'</span><span class="main">,</span> <span class="bound">τ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> IH <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> union_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> local_decreasing_extended_imp_decreasing<span class="main">[</span><span class="operator">OF</span> LTb t i ih2<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ1</span></span> <span class="skolem"><span class="skolem">τ2</span></span> <span class="skolem"><span class="skolem">τ3'</span></span> <span class="skolem"><span class="skolem">δ1'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> taus<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">τ1</span><span class="main">,</span><span class="skolem">τ2</span><span class="main">,</span><span class="skolem">τ3'</span><span class="main">,</span><span class="skolem">δ1'''</span><span class="main">}</span> <span class="main">⊆</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    onetwo2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">τ1</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">∧</span> length <span class="main">(</span>labels <span class="skolem">τ2</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="skolem">τ2</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">}</span> <span class="main">∧</span>
    set <span class="main">(</span>labels <span class="skolem">τ3'</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">,</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">∧</span> set <span class="main">(</span>labels <span class="skolem">δ1'''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">,</span>fst <span class="free">α_step</span><span class="main">}</span> <span class="main">∧</span>
     snd <span class="free">α_step</span> <span class="main">=</span> fst <span class="skolem">τ1</span> <span class="main">∧</span> lst <span class="skolem">τ1</span> <span class="main">=</span> fst <span class="skolem">τ2</span> <span class="main">∧</span> lst <span class="skolem">τ2</span> <span class="main">=</span> fst <span class="skolem">τ3'</span> <span class="main">∧</span> lst <span class="skolem">τ3'</span> <span class="main">=</span> lst <span class="skolem">δ1'''</span> <span class="main">∧</span> fst <span class="skolem">δ1'''</span> <span class="main">=</span> fst <span class="free">δ3</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> γ3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">γ3</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> γ3m<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">γ3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         δ3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">δ3</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c2</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span> δ3m<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">δ3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">,</span>fst <span class="free">α_step</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
         eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="free">γ3</span> <span class="main">=</span> lst_conv <span class="free">δ3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LT <span class="keyword1"><span class="command">unfolding</span></span> LT_def LT1_def local_triangle1_def LD_1'_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> δ3m<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="free">δ3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="comment1">(*concat*)</span>
    <span class="keyword1"><span class="command">have</span></span> δ1'''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">δ1'''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> taus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> γ1'''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">γ1'''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sigmas <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">δ1'''</span><span class="main">,</span>map <span class="main">(</span>Pair True<span class="main">)</span> <span class="main">(</span>snd <span class="skolem">δ1'''</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c0</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> seq_imp_conv δ1''' surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> c11<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">δ1'''</span> <span class="main">=</span> lst_conv <span class="var">?c0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> seq_imp_conv δ1''' surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> c1l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c0</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">,</span>fst <span class="free">α_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> onetwo2 seq_imp_conv δ1''' surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> c1l<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c0</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> c1<span class="main">:</span> <span class="quoted"><span class="quoted">"conv_mirror <span class="var">?c0</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c1</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
             <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="main">(</span>conv_mirror <span class="var">?c0</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
             <span class="quoted"><span class="quoted">"fst <span class="main">(</span>conv_mirror <span class="var">?c0</span><span class="main">)</span> <span class="main">=</span> lst <span class="skolem">τ3'</span>"</span></span>
             <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span>conv_mirror <span class="var">?c0</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">δ3</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> conv_mirror<span class="main">[</span><span class="operator">OF</span> c1<span class="main">]</span> c11 c1l c1 onetwo2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>


    <span class="keyword1"><span class="command">have</span></span> c2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c2</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
             <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c2</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
             <span class="quoted"><span class="quoted">"fst <span class="var">?c2</span> <span class="main">=</span> fst <span class="free">δ3</span>"</span></span>
             <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c2</span> <span class="main">=</span> lst_conv <span class="free">γ3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> δ3 eq δ3m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"conv_mirror <span class="free">γ3</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c3</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="main">(</span>conv_mirror <span class="free">γ3</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>labels_conv <span class="free">γ3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_mirror<span class="main">[</span><span class="operator">OF</span> γ3<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> c3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c3</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
              <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c3</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
              <span class="quoted"><span class="quoted">"fst <span class="var">?c3</span> <span class="main">=</span> lst_conv <span class="free">δ3</span>"</span></span>
              <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c3</span> <span class="main">=</span> fst <span class="skolem">γ1'''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_mirror<span class="main">[</span><span class="operator">OF</span> γ3<span class="main">]</span> eq onetwo1 γ3m <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> c4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">γ1'''</span><span class="main">,</span>map <span class="main">(</span>Pair True<span class="main">)</span> <span class="main">(</span>snd <span class="skolem">γ1'''</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c4</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="main">(</span>fst <span class="skolem">γ1'''</span><span class="main">,</span>map <span class="main">(</span>Pair True<span class="main">)</span> <span class="main">(</span>snd <span class="skolem">γ1'''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>labels <span class="skolem">γ1'''</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> seq_imp_conv γ1''' surjective_pairing <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">using</span></span> seq_imp_conv γ1''' surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> c4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c4</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span>
             <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c4</span> <span class="main">=</span> lst <span class="skolem">γ1'''</span>"</span></span>
             <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c4</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span>  seq_imp_conv γ1''' surjective_pairing <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">using</span></span> seq_imp_conv γ1''' surjective_pairing <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">using</span></span> c4<span class="main">(</span>2<span class="main">)</span> onetwo1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c1</span> <span class="main">=</span> fst <span class="var">?c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c12<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?c1</span><span class="main">,</span>snd <span class="var">?c1</span><span class="main">@</span>snd <span class="var">?c2</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c12</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="var">?c1</span><span class="main">,</span>snd <span class="var">?c1</span><span class="main">@</span>snd <span class="var">?c2</span><span class="main">)</span> <span class="main">=</span> fst <span class="var">?c1</span>"</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span>fst <span class="var">?c1</span><span class="main">,</span>snd <span class="var">?c1</span><span class="main">@</span>snd <span class="var">?c2</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="var">?c2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat<span class="main">[</span><span class="operator">OF</span> c1<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> c2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c12</span> <span class="main">=</span> fst <span class="var">?c3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c12 c3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c123<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?c12</span><span class="main">,</span>snd <span class="var">?c12</span><span class="main">@</span>snd <span class="var">?c3</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c123</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="var">?c12</span><span class="main">,</span>snd <span class="var">?c12</span><span class="main">@</span>snd <span class="var">?c3</span><span class="main">)</span> <span class="main">=</span> fst <span class="var">?c12</span>"</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span>fst <span class="var">?c12</span><span class="main">,</span>snd <span class="var">?c12</span><span class="main">@</span>snd <span class="var">?c3</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="var">?c3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat<span class="main">[</span><span class="operator">OF</span> c12<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> c3<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c123</span> <span class="main">=</span> fst <span class="var">?c4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> c123 c2 c4 onetwo1 onetwo2 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">using</span></span> c3<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> c1234<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?c123</span><span class="main">,</span>snd <span class="var">?c123</span><span class="main">@</span>snd <span class="var">?c4</span><span class="main">)</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c1234</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"fst <span class="main">(</span>fst <span class="var">?c123</span><span class="main">,</span>snd <span class="var">?c123</span><span class="main">@</span>snd <span class="var">?c4</span><span class="main">)</span> <span class="main">=</span> fst <span class="var">?c123</span>"</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="main">(</span>fst <span class="var">?c123</span><span class="main">,</span>snd <span class="var">?c123</span><span class="main">@</span>snd <span class="var">?c4</span><span class="main">)</span> <span class="main">=</span> lst_conv <span class="var">?c4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat<span class="main">[</span><span class="operator">OF</span> c123<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> c4<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> c1234<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?c1234</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c1234</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="quoted"><span class="quoted">"fst <span class="main">(</span><span class="var">?c1234</span><span class="main">)</span> <span class="main">=</span> lst <span class="skolem">τ3'</span>"</span></span> <span class="quoted"><span class="quoted">"lst_conv <span class="var">?c1234</span> <span class="main">=</span> lst <span class="skolem">σ3'</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">using</span></span> c1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span> <span class="keyword1"><span class="command">using</span></span> c4<span class="main">(</span>2<span class="main">)</span> onetwo1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

    <span class="keyword1"><span class="command">have</span></span> c12l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c12</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat_labels<span class="main">[</span><span class="operator">OF</span> c1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> c2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> c1 c2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c123l<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c123</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat_labels<span class="main">[</span><span class="operator">OF</span> c12<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> c3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> c12l c3 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> c1234l<span class="main">:</span><span class="quoted"><span class="quoted">"set <span class="main">(</span>labels_conv <span class="var">?c1234</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> conv_concat_labels<span class="main">[</span><span class="operator">OF</span> c123<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> c4<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> c123l c4 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span><span class="free">r</span><span class="main">|</span>labels_conv <span class="var">?c1234</span><span class="main">|</span> <span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> submultiset_implies_subset<span class="main">[</span><span class="operator">OF</span> lexmax_le_multiset<span class="main"><span class="main">[</span></span><span class="operator">OF</span> t<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="var">?c1234</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span>fst <span class="free">β_step</span><span class="main">,</span> fst <span class="free">α_step</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> measure_conv_def dm_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="var">?c1234</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">#}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> c1234 m <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ</span></span> <span class="keyword2"><span class="keyword">where</span></span> ρ<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">ρ</span> <span class="main">∈</span> conv <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ρm<span class="main">:</span><span class="quoted"><span class="quoted">"set_mset <span class="main">(</span>measure_conv <span class="free">r</span> <span class="skolem">ρ</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span> fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">#}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">ρ</span> <span class="main">=</span> lst <span class="skolem">τ3'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"lst_conv <span class="skolem">ρ</span> <span class="main">=</span> lst <span class="skolem">σ3'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">{#</span>fst <span class="free">α_step</span><span class="main">,</span>fst <span class="free">β_step</span><span class="main">#}</span><span class="main">,</span><span class="main">{#</span>fst <span class="free">β_step</span><span class="main">,</span>fst <span class="free">α_step</span><span class="main">#}</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mul_eq_reflexive add_mset_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">from</span></span> conv_imp_valley<span class="main">[</span><span class="operator">OF</span> t IH ρ ρm M<span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">τ3''</span></span> <span class="skolem"><span class="skolem">σ3''</span></span> <span class="keyword2"><span class="keyword">where</span></span>
     τ3''<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">τ3''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ3''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ3''</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span><span class="quoted"><span class="quoted">"fst <span class="skolem">τ3''</span> <span class="main">=</span> fst <span class="skolem">ρ</span> <span class="main">∧</span> fst <span class="skolem">σ3''</span> <span class="main">=</span> lst_conv <span class="skolem">ρ</span> <span class="main">∧</span> lst <span class="skolem">τ3''</span> <span class="main">=</span> lst <span class="skolem">σ3''</span> <span class="main">∧</span>
    set_mset <span class="main">(</span>measure <span class="free">r</span> <span class="main">(</span><span class="skolem">τ3''</span><span class="main">,</span> <span class="skolem">σ3''</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> dm <span class="free">r</span> <span class="main">{#</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">#}</span>"</span></span>  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">σ3''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">α_step</span><span class="main">,</span> fst <span class="free">β_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> dm_def measure_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> insert_commute lexmax_set subsetD t<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>labels <span class="skolem">τ3''</span><span class="main">)</span> <span class="main">⊆</span> ds <span class="free">r</span> <span class="main">{</span>fst <span class="free">β_step</span><span class="main">,</span> fst <span class="free">α_step</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq <span class="keyword1"><span class="command">unfolding</span></span> dm_def measure_def <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> insert_commute lexmax_set subsetD t<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> σ1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">σ1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> τ1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> fst <span class="skolem">τ1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> onetwo1 onetwo2 surjective_pairing <span class="keyword1"><span class="command">unfolding</span></span> lst_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> eqn<span class="main">:</span> <span class="quoted"><span class="quoted">" lst <span class="skolem">τ3''</span> <span class="main">=</span> lst <span class="skolem">σ3''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> σ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">σ3'</span> <span class="main">=</span> fst <span class="skolem">σ3''</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> τ_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"lst <span class="skolem">τ3'</span> <span class="main">=</span> fst <span class="skolem">τ3''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eq eq1 eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> σ3'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">σ3'</span><span class="main">,</span>snd <span class="skolem">σ3'</span><span class="main">@</span>snd <span class="skolem">σ3''</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?σ3</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">[</span><span class="operator">OF</span> _ σ3'' σ_eq<span class="main">]</span> sigmas <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> τ3'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">τ3'</span><span class="main">,</span>snd <span class="skolem">τ3'</span><span class="main">@</span>snd <span class="skolem">τ3''</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?τ3</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">[</span><span class="operator">OF</span> _ τ3'' τ_eq<span class="main">]</span> taus <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?σ3</span> <span class="main">=</span> lst <span class="skolem">σ2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"fst <span class="var">?τ3</span> <span class="main">=</span> lst <span class="skolem">τ2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> onetwo1 onetwo2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> lst<span class="main">:</span><span class="quoted"><span class="quoted">"lst <span class="var">?σ3</span> <span class="main">=</span> lst <span class="var">?τ3</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> eqn σ3'' σ3' σ_eq τ3'' τ_eq τ3' seq_chop<span class="main">(</span>1<span class="main">)</span> seq_concat<span class="main">(</span>2<span class="main">)</span> surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_diagram1 <span class="free">ars</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="skolem">σ1</span> <span class="skolem">σ2</span> <span class="main">(</span>fst <span class="skolem">σ3'</span><span class="main">,</span> snd <span class="skolem">σ3'</span> <span class="main">@</span> snd <span class="skolem">σ3''</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> sigmas σ3' onetwo1 σ1_eq LT <span class="keyword1"><span class="command">unfolding</span></span> local_diagram1_def  LT_def LT1_def local_triangle1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"local_diagram1 <span class="free">ars</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span> <span class="skolem">τ1</span> <span class="skolem">τ2</span> <span class="main">(</span>fst <span class="skolem">τ3'</span><span class="main">,</span>snd <span class="skolem">τ3'</span><span class="main">@</span>snd <span class="skolem">τ3''</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> taus τ3' onetwo2 τ1_eq LT <span class="keyword1"><span class="command">unfolding</span></span> local_diagram1_def LT_def LT1_def local_triangle1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LD_1' <span class="free">r</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">σ1</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">σ2</span><span class="main">)</span> <span class="main">(</span>labels <span class="main">(</span>fst <span class="skolem">σ3'</span><span class="main">,</span> snd <span class="skolem">σ3'</span> <span class="main">@</span> snd <span class="skolem">σ3''</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> onetwo1 s1 <span class="keyword1"><span class="command">unfolding</span></span> LD_1'_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LD_1' <span class="free">r</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>labels <span class="main">(</span><span class="free">s</span><span class="main">,</span> <span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">τ1</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">τ2</span><span class="main">)</span> <span class="main">(</span>labels <span class="main">(</span>fst <span class="skolem">τ3'</span><span class="main">,</span> snd <span class="skolem">τ3'</span> <span class="main">@</span> snd <span class="skolem">τ3''</span><span class="main">)</span><span class="main">)</span>"</span></span>
     <span class="keyword1"><span class="command">using</span></span> onetwo2 s2 <span class="keyword1"><span class="command">unfolding</span></span> LD_1'_def labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> LDD<span class="main">:</span> <span class="quoted"><span class="quoted">"LDD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">[</span><span class="free">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">σ1</span><span class="main">,</span><span class="skolem">σ2</span><span class="main">,</span><span class="var">?σ3</span><span class="main">,</span><span class="skolem">τ1</span><span class="main">,</span><span class="skolem">τ2</span><span class="main">,</span><span class="var">?τ3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lst <span class="keyword1"><span class="command">unfolding</span></span> LDD_def LDD1_def local_diagram1_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> LDD_imp_DD<span class="main">[</span><span class="operator">OF</span> t i LDD<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> LT_imp_D<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> t<span class="main">:</span><span class="quoted"><span class="quoted">"trans <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf <span class="free">r</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>local_peak <span class="free">ars</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">γ1</span> <span class="bound">γ2</span> <span class="bound">γ3</span> <span class="bound">δ1</span> <span class="bound">δ2</span> <span class="bound">δ3</span><span class="main">.</span> LT <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">,</span>snd <span class="bound">p</span><span class="main">,</span><span class="bound">γ1</span><span class="main">,</span><span class="bound">γ2</span><span class="main">,</span><span class="bound">γ3</span><span class="main">,</span><span class="bound">δ1</span><span class="main">,</span><span class="bound">δ2</span><span class="main">,</span><span class="bound">δ3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="free">P</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span> <span class="bound">σ'</span> <span class="bound">τ'</span><span class="main">.</span> DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span>fst <span class="free">P</span><span class="main">,</span>snd <span class="free">P</span><span class="main">,</span><span class="bound">σ'</span><span class="main">,</span><span class="bound">τ'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
 <span class="keyword1"><span class="command">have</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"irrefl <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> acyclic_irrefl trancl_id wf_acyclic <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>pex <span class="free">r</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>wf_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">P</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">τ</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> decompose<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> tau<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sigma<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span>
   <span class="keyword2"><span class="keyword">and</span></span> tau_s<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">τ</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sigma_s<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">τ</span>"</span></span><span class="main">)</span>
   <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> mirror_DD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i trivial_DD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sigma<span class="main"><span class="main">]</span></span><span class="main">]</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_s sigma_s Nil surjective_pairing <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">next</span></span>
   <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">β_step</span> <span class="skolem">υ_step</span><span class="main">)</span>
   <span class="keyword1"><span class="command">hence</span></span> tau_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">τ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">υ_step</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> tau_s surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">hence</span></span> tau2<span class="main">:</span><span class="quoted"><span class="quoted">" <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">υ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tau <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">σ</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> trivial_DD<span class="main">[</span><span class="operator">OF</span> tau<span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> tau_s sigma_s Nil surjective_pairing <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv DD_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
   <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">α_step</span> <span class="skolem">ρ_step</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sigma_dec<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">σ</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">ρ_step</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">using</span></span> sigma_s surjective_pairing <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">hence</span></span> sigma2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">ρ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sigma <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> alpha<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?α</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">ρ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ρ</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> sigma2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> alpha'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span>fst <span class="skolem">α_step</span><span class="main">,</span> snd <span class="skolem">α_step</span><span class="main">)</span> <span class="main">∈</span> <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> seq_tail1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> beta<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?β</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
     <span class="keyword2"><span class="keyword">and</span></span> upsilon<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lst <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">)</span><span class="main">,</span><span class="skolem">υ_step</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?υ</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_chop<span class="main">[</span><span class="operator">OF</span> tau2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> lp<span class="main">:</span><span class="quoted"><span class="quoted">"local_peak <span class="free">ars</span> <span class="main">(</span><span class="var">?β</span><span class="main">,</span><span class="var">?α</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> alpha beta <span class="keyword1"><span class="command">unfolding</span></span> local_peak_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

   <span class="comment1">(* difference begin*)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">γ1</span></span> <span class="skolem"><span class="skolem">γ2</span></span> <span class="skolem"><span class="skolem">γ3</span></span> <span class="skolem"><span class="skolem">δ1</span></span> <span class="skolem"><span class="skolem">δ2</span></span> <span class="skolem"><span class="skolem">δ3</span></span> <span class="keyword2"><span class="keyword">where</span></span> LT<span class="main">:</span> <span class="quoted"><span class="quoted">"LT <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?β</span><span class="main">,</span> <span class="var">?α</span><span class="main">,</span> <span class="skolem">γ1</span><span class="main">,</span> <span class="skolem">γ2</span><span class="main">,</span> <span class="skolem">γ3</span><span class="main">,</span> <span class="skolem">δ1</span><span class="main">,</span> <span class="skolem">δ2</span><span class="main">,</span> <span class="skolem">δ3</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">β_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">υ_step</span><span class="main">)</span><span class="main">,</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="main">[</span><span class="skolem">α_step</span><span class="main">]</span><span class="main">@</span><span class="skolem">ρ_step</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">P</span> <span class="main">=</span> <span class="var">?P</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> decompose <span class="keyword1"><span class="command">unfolding</span></span> tau_dec sigma_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ</span></span> <span class="skolem"><span class="skolem">μ</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span><span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?β</span><span class="main">,</span><span class="var">?α</span><span class="main">,</span><span class="skolem">κ</span><span class="main">,</span><span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> LT_imp_DD<span class="main">[</span><span class="operator">OF</span> t i 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> LT<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="comment1">(*difference end*)</span>

    <span class="keyword1"><span class="command">hence</span></span> kappa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">κ</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> mu<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">μ</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> P_IH1<span class="main">:</span> <span class="quoted"><span class="quoted">" peak <span class="free">ars</span> <span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> upsilon kappa D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> beta_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="var">?β</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> dec<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">(</span>labels <span class="var">?β</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?α</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">κ</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">μ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> x1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="var">?α</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_6<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> beta_ne dec<span class="main">]</span>
     <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def decompose labels_def tau_dec <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_mset_commute<span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> union_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="main">(</span><span class="var">?α</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">+</span> lexmax <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">σ</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> mul_eq <span class="free">r</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?l</span><span class="main">,</span><span class="var">?r</span><span class="main">)</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> sigma_dec labels_def snd_conv list.map lexmax.simps diff_from_empty <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lemma2_6_2_a t<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">)</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x1 <span class="keyword1"><span class="command">unfolding</span></span> sigma_s pex_def measure_def decompose <span class="keyword1"><span class="command">using</span></span> mul_and_mul_eq_imp_mul<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">κ'</span></span> <span class="skolem"><span class="skolem">υ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH1<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?υ</span><span class="main">,</span><span class="skolem">κ</span><span class="main">,</span><span class="skolem">κ'</span><span class="main">,</span><span class="skolem">υ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ P_IH1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> decompose <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> kappa'<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">κ'</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> upsilon'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">υ'</span><span class="main">∈</span>seq <span class="free">ars</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tau'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="skolem">μ</span><span class="main">,</span>snd <span class="skolem">μ</span><span class="main">@</span><span class="main">(</span>snd <span class="skolem">υ'</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> seq <span class="free">ars</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?τ'</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword1"><span class="command">using</span></span> seq_concat<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mu upsilon'<span class="main">]</span> D IH1 <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> DIH1<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="skolem">τ</span><span class="main">,</span><span class="var">?α</span><span class="main">,</span><span class="skolem">κ'</span><span class="main">,</span><span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5_DD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i D IH1<span class="main">]</span> tau_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> dec_dih1<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">r</span> <span class="main">(</span>labels <span class="skolem">τ</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?α</span><span class="main">)</span> <span class="main">(</span>labels <span class="skolem">κ'</span><span class="main">)</span> <span class="main">(</span>labels <span class="var">?τ'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> DIH1 <span class="keyword1"><span class="command">unfolding</span></span> DD_def D2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword1"><span class="command">have</span></span> P_IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"peak <span class="free">ars</span> <span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> tau' rho D <span class="keyword1"><span class="command">unfolding</span></span> DD_def diagram_def peak_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> alpha_ne<span class="main">:</span> <span class="quoted"><span class="quoted">"labels <span class="var">?α</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> labels_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">)</span><span class="main">,</span><span class="skolem">P</span><span class="main">)</span> <span class="main">∈</span> pex <span class="free">r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_6_v<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i alpha_ne dec_dih1<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> pex_def measure_def decompose labels_def sigma_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ρ'</span></span> <span class="skolem"><span class="skolem">τ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> IH2<span class="main">:</span> <span class="quoted"><span class="quoted">"DD <span class="free">ars</span> <span class="free">r</span> <span class="main">(</span><span class="var">?τ'</span><span class="main">,</span><span class="var">?ρ</span><span class="main">,</span><span class="skolem">ρ'</span><span class="main">,</span><span class="skolem">τ''</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ P_IH2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lemma3_5_DD_v<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i DIH1 IH2<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> decompose fst_conv snd_conv sigma_dec <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
   <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
 <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">LD_conv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="tfree">'a</span> rel <span class="main">⇒</span> bool"</span></span>
 <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LD_conv</span> <span class="free"><span class="bound"><span class="entity">L</span></span></span> <span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span> <span class="main">(</span><span class="bound">r</span><span class="main">::</span> <span class="main">(</span><span class="tfree">'b</span> rel<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="bound">lrs</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> lars<span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ars</span></span></span> <span class="main">=</span> unlabel <span class="bound">lrs</span><span class="main">)</span> <span class="main">∧</span> trans <span class="bound">r</span> <span class="main">∧</span> wf <span class="bound">r</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span>local_peak <span class="bound">lrs</span> <span class="bound">p</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">γ1</span> <span class="bound">γ2</span> <span class="bound">γ3</span> <span class="bound">δ1</span> <span class="bound">δ2</span> <span class="bound">δ3</span><span class="main">.</span> LT <span class="bound">lrs</span> <span class="bound">r</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">,</span>snd <span class="bound">p</span><span class="main">,</span><span class="bound">γ1</span><span class="main">,</span><span class="bound">γ2</span><span class="main">,</span><span class="bound">γ3</span><span class="main">,</span><span class="bound">δ1</span><span class="main">,</span><span class="bound">δ2</span><span class="main">,</span><span class="bound">δ3</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sound_conv<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"LD_conv <span class="free">L</span> <span class="free">ars</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"CR <span class="free">ars</span>"</span></span>
 <span class="keyword1"><span class="command">using</span></span> assms LT_imp_D D_imp_CR <span class="keyword1"><span class="command">unfolding</span></span> LD_conv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> D
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> seq
<span class="keyword1"><span class="command">hide_const</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> measure

<span class="keyword1"><span class="command">hide_fact</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">open</span></span><span class="main">)</span> split

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>