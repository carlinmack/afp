<div id="Signatures">
<div class="head">
<h1>Theory Signatures</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Signatures for Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Signatures›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Signatures
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../../HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Default notation in Isabelle/HOL is occasionally different from
established notation in the relation/algebra community. We use the
latter where possible.
›</span></span>

<span class="keyword1"><span class="command">notation</span></span>
  times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Some classes in our algebraic hierarchy are most naturally defined as
subclasses of two (or more) superclasses that impose different
restrictions on the same parameter(s).

Alas, in Isabelle/HOL, a class cannot have multiple superclasses that
independently declare the same parameter(s). One workaround, which
motivated the following syntactic classes, is to shift the parameter
declaration to a common superclass.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> star_op <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">star</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>⋆</sup></span></span></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> omega_op <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">omega</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span></span></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>

<span class="comment1">(*
class residual_r_op =
  fixes residual_r :: "'a ⇒ 'a ⇒ 'a" (infixr "→" 60)

class residual_l_op =
  fixes residual_l :: "'a ⇒ 'a ⇒ 'a" (infixl "←" 60)
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We define a type class that combines addition and the definition of
order in, e.g., semilattices. This class makes the definition of
various other type classes more slick.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> plus_ord <span class="main">=</span> plus <span class="main">+</span> ord <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> less_eq_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> less_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Dioid">
<div class="head">
<h1>Theory Dioid</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      From Semilattices to Dioids
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Dioids›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Dioid
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Signatures.html">Signatures</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Join Semilattices›</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Join semilattices can be axiomatised order-theoretically or
algebraically. A join semilattice (or upper semilattice) is either a
poset in which every pair of elements has a join (or least upper
bound), or a set endowed with an associative, commutative, idempotent
binary operation. It is well known that the order-theoretic definition
induces the algebraic one and vice versa. We start from the algebraic
axiomatisation because it is easily expandable to dioids, using
Isabelle's type class mechanism.

In Isabelle/HOL, a type class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> semilattice_sup<span class="antiquote"><span class="antiquote">}</span></span></span></span> is available.
Alas, we cannot use this type class because we need the symbol~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+›</span></span></span></span> for the join operation in the dioid expansion and subclass
proofs in Isabelle/HOL require the two type classes involved to have
the same fixed signature.

Using {\em add\_assoc} as a name for the first assumption in class
{\em join\_semilattice} would lead to name clashes: we will later
define classes that inherit from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> semigroup_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which
provides its own assumption {\em add\_assoc}, and prove that these are
subclasses of {\em join\_semilattice}. Hence the primed name.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> join_semilattice <span class="main">=</span> plus_ord <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_assoc' <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> add_comm <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> add_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_left_comm <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.add_assoc' local.add_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> add_left_idem <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> add_assoc' <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⟷</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of the order is
hidden in class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> plus_ord<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

We show some simple order-based properties of semilattices. The
first one states that every semilattice is a partial order.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> order
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">¬</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.add_comm local.less_def local.less_eq_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.less_eq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assoc' less_eq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">x</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.add_comm local.less_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that joins are least upper bounds.›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> join<span class="main">:</span> semilattice_sup <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span> local.less_eq_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove that joins are isotone (order preserving).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join.sup_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The next lemma links the definition of order as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⟷</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  with a perhaps more conventional one known, e.g., from arithmetics.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> order_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* join_semilattice *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Join Semilattices with an Additive Unit›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now expand join semilattices by an additive unit~$0$. Is
the least element with respect to the order, and therefore often
denoted by~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>⊥›</span></span></span></span>. Semilattices with a least element are often
called \emph{bounded}.›</span></span>

<span class="keyword1"><span class="command">class</span></span> join_semilattice_zero <span class="main">=</span> join_semilattice <span class="main">+</span> zero <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_zero_l <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> comm_monoid_add
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc'<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_comm<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> join<span class="main">:</span> bounded_semilattice_sup_bot <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="quoted"><span class="main">0</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.order_prop<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> no_trivial_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.add_0_right local.join.sup_left_idem<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* join_semilattice_zero *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Near Semirings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\emph{Near semirings} (also called seminearrings) are
generalisations of near rings to the semiring case. They have been
studied, for instance, in G.~Pilz's book~\cite{pilz83nearrings} on
near rings. According to his definition, a near semiring consists of
an additive and a multiplicative semigroup that interact via a single
distributivity law (left or right). The additive semigroup is not
required to be commutative. The definition is influenced by partial
transformation semigroups.

We only consider near semirings in which addition is commutative, and
in which the right distributivity law holds. We call such near
semirings \emph{abelian}.›</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_near_semiring <span class="main">=</span> ab_semigroup_add <span class="main">+</span> semigroup_mult <span class="main">+</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> distrib_right' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring<span class="main">)</span> ab_near_semiring
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> distrib_right<span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> ab_pre_semiring <span class="main">=</span> ab_near_semiring <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subdistl_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Variants of Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A \emph{near dioid} is an abelian near semiring in which
addition is idempotent. This generalises the notion of (additively)
idempotent semirings by dropping one distributivity law. Near dioids
are a starting point for process algebras.

By modelling variants of dioids as variants of semirings in which
addition is idempotent we follow the tradition of
Birkhoff~\cite{birkhoff67lattices}, but deviate from the definitions
in Gondran and Minoux's book~\cite{gondran10graphs}.›</span></span>

<span class="keyword1"><span class="command">class</span></span> near_dioid <span class="main">=</span> ab_near_semiring <span class="main">+</span> plus_ord <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_idem' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Since addition is idempotent, the additive (commutative)
semigroup reduct of a near dioid is a semilattice. Near dioids are
therefore ordered by the semilattice order.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> join_semilattice
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute add.left_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It follows that multiplication is right-isotone (but not
necessarily left-isotone).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_isor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "3-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma states that, in every near dioid, left
isotonicity and left subdistributivity are equivalent.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_isol_equiv_subdistl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.join.sup_absorb2 local.join.sup_ge1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma is relevant to propositional Hoare logic.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dual_order.trans mult_isor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* near_dioid *)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now make multiplication in near dioids left isotone, which
is equivalent to left subdistributivity, as we have seen. The
corresponding structures form the basis of probabilistic Kleene
algebras~\cite{mciverweber05pka} and game
algebras~\cite{venema03gamealgebra}. We are not aware that these
structures have a special name, so we baptise them \emph{pre-dioids}.

We do not explicitly define pre-semirings since we have no application
for them.›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_dioid <span class="main">=</span> near_dioid <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subdistl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now, obviously, left isotonicity follows from left subdistributivity.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> subdistl_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.mult_isol_equiv_subdistl local.subdistl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subclass</span></span> ab_pre_semiring
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.join.sup_absorb2 local.subdistl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_isol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdistl_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mult_isol_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> local.dual_order.trans local.mult_isor mult_isol<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mult_double_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mult_isor mult_isol<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas are relevant to propositional Hoare logic.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.order_trans mult_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> phl_seq<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">r</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">q</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">r</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> mult_isor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> order_prop order_trans subdistl mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_cond<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms mult_assoc phl_seq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b join.sup_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_export1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult_isor<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> mult_assoc phl_seq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_export2<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> mult_isor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> dual_order.trans order_prop subdistl mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* pre_dioid *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By adding a full left distributivity law we obtain semirings
(which are already available in Isabelle/HOL as <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> semiring<span class="antiquote"><span class="antiquote">}</span></span></span></span>)
from near semirings, and dioids from near dioids. Dioids are therefore
idempotent semirings.›</span></span>

<span class="keyword1"><span class="command">class</span></span> dioid <span class="main">=</span> near_dioid <span class="main">+</span> semiring

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid<span class="main">)</span> pre_dioid
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Families of Nearsemirings with a Multiplicative Unit›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Multiplicative units are important, for instance, for defining
an operation of finite iteration or Kleene star on dioids. We do not
introduce left and right units separately since we have no application
for this.›</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_near_semiring_one <span class="main">=</span> ab_near_semiring <span class="main">+</span> one <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mult_onel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mult_oner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">=</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> monoid_mult
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* ab_near_semiring_one *)</span>

<span class="keyword1"><span class="command">class</span></span> ab_pre_semiring_one <span class="main">=</span> ab_near_semiring_one <span class="main">+</span> ab_pre_semiring

<span class="keyword1"><span class="command">class</span></span> near_dioid_one <span class="main">=</span> near_dioid <span class="main">+</span> ab_near_semiring_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma is relevant to propositional Hoare logic.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For near dioids with one, it would be sufficient to require
$1+1=1$. This implies <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span><span class="main"><span class="main">+</span></span><span class="free"><span class="free">x</span></span><span class="main"><span class="main">=</span></span><span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> for arbitray~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> (but that
would lead to annoying redundant proof obligations in mutual
subclasses of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> near_dioid_one<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> near_dioid<span class="antiquote"><span class="antiquote">}</span></span></span></span> later).
›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_dioid_one <span class="main">=</span> pre_dioid <span class="main">+</span> near_dioid_one

<span class="keyword1"><span class="command">class</span></span> dioid_one <span class="main">=</span> dioid <span class="main">+</span> near_dioid_one

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one<span class="main">)</span> pre_dioid_one <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Families of Nearsemirings with Additive Units›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We now axiomatise an additive unit~$0$ for nearsemirings. The zero is
usually required to satisfy annihilation properties with respect to
multiplication. Due to applications we distinguish a zero which is
only a left annihilator from one that is also a right annihilator.
More briefly, we call zero either a left unit or a unit.

Semirings and dioids with a right zero only can be obtained from those
with a left unit by duality.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_near_semiring_one_zerol <span class="main">=</span> ab_near_semiring_one <span class="main">+</span> zero <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_zerol <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Note that we do not require~$0 \neq 1$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> add_zeror <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> add_commute<span class="main">)</span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* ab_near_semiring_one_zerol *)</span>

<span class="keyword1"><span class="command">class</span></span> ab_pre_semiring_one_zerol <span class="main">=</span> ab_near_semiring_one_zerol <span class="main">+</span> ab_pre_semiring

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma shows that there is no point defining pre-semirings separately from dioids.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subdistl_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* ab_pre_semiring_one_zerol *)</span>

<span class="keyword1"><span class="command">class</span></span> near_dioid_one_zerol <span class="main">=</span> near_dioid_one <span class="main">+</span> ab_near_semiring_one_zerol

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> near_dioid_one_zerol<span class="main">)</span> join_semilattice_zero
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">class</span></span> pre_dioid_one_zerol <span class="main">=</span> pre_dioid_one <span class="main">+</span> ab_near_semiring_one_zerol

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_dioid_one_zerol<span class="main">)</span> near_dioid_one_zerol <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">class</span></span> semiring_one_zerol <span class="main">=</span> semiring <span class="main">+</span> ab_near_semiring_one_zerol

<span class="keyword1"><span class="command">class</span></span> dioid_one_zerol <span class="main">=</span> dioid_one <span class="main">+</span> ab_near_semiring_one_zerol

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zerol<span class="main">)</span> pre_dioid_one_zerol <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now make zero also a right annihilator.›</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_near_semiring_one_zero <span class="main">=</span> ab_near_semiring_one_zerol <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> annir <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">class</span></span> semiring_one_zero <span class="main">=</span> semiring <span class="main">+</span> ab_near_semiring_one_zero

<span class="keyword1"><span class="command">class</span></span> near_dioid_one_zero <span class="main">=</span> near_dioid_one_zerol <span class="main">+</span> ab_near_semiring_one_zero

<span class="keyword1"><span class="command">class</span></span> pre_dioid_one_zero <span class="main">=</span> pre_dioid_one_zerol <span class="main">+</span> ab_near_semiring_one_zero

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_dioid_one_zero<span class="main">)</span> near_dioid_one_zero <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">class</span></span> dioid_one_zero <span class="main">=</span> dioid_one_zerol <span class="main">+</span> ab_near_semiring_one_zero

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zero<span class="main">)</span> pre_dioid_one_zero <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zero<span class="main">)</span> semiring_one_zero <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Duality by Opposition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Swapping the order of multiplication in a semiring (or dioid) gives
another semiring (or dioid), called its \emph{dual} or
\emph{opposite}.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> times<span class="main">)</span> <span class="entity">opp_mult</span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊙</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">⊙</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring_1<span class="main">)</span> dual_semiring_1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"class.semiring_1 <span class="main">1</span> <span class="main">(⊙)</span> <span class="main">(+)</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opp_mult_def mult.assoc distrib_right distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zero<span class="main">)</span> dual_dioid_one_zero<span class="main">:</span>
  <span class="quoted"><span class="quoted">"class.dioid_one_zero <span class="main">(+)</span> <span class="main">(⊙)</span> <span class="main">1</span> <span class="main">0</span> <span class="main">(≤)</span> <span class="main">(&lt;)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> opp_mult_def mult.assoc distrib_right distrib_left<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Selective Near Semirings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we briefly sketch a generalisation of the
notion of \emph{dioid}. Some important models, e.g. max-plus and
min-plus semirings, have that property.›</span></span>

<span class="keyword1"><span class="command">class</span></span> selective_near_semiring <span class="main">=</span> ab_near_semiring <span class="main">+</span> plus_ord <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> select<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> select_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.select<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It follows immediately that every selective near semiring is a near dioid.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> near_dioid
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> select<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Moreover, the order in a selective near semiring is obviously linear.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> linorder
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> add.commute join.sup.orderI select<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(*selective_near_semiring*)</span>

<span class="keyword1"><span class="command">class</span></span> selective_semiring <span class="main">=</span> selective_near_semiring <span class="main">+</span> semiring_one_zero

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> dioid_one_zero <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* selective_semiring *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Dioid_Models">
<div class="head">
<h1>Theory Dioid_Models</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Models of Dioids
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models of Dioids›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Dioid_Models
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Dioid.html">Dioid</a> <a href="../../HOL/HOL/Real.html">HOL.Real</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we consider some well known models of
dioids. These so far include the powerset dioid over a monoid,
languages, binary relations, sets of traces, sets paths (in a graph),
as well as the min-plus and the max-plus semirings. Most of these
models are taken from an article about Kleene algebras with
domain~\cite{desharnaismoellerstruth06kad}.

The advantage of formally linking these models with the abstract
axiomatisations of dioids is that all abstract theorems are
automatically available in all models. It therefore makes sense to
establish models for the strongest possible axiomatisations (whereas
theorems should be proved for the weakest ones).›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Powerset Dioid over a Monoid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We assume a multiplicative monoid and define the usual complex
product on sets of elements. We formalise the well known result that
this lifting induces a dioid.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">monoid_mult</span><span class="main">)</span> <span class="quoted">monoid_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> one_set_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> c_prod_def<span class="main">:</span> <span class="comment1">― ‹the complex product›</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">u</span> <span class="main">*</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
     <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">Y</span> <span class="main">⋅</span> <span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">⋅</span> <span class="skolem">Z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_prod_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> mult.assoc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⋅</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_set_def c_prod_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_set_def c_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">monoid_mult</span><span class="main">)</span> <span class="quoted">dioid_one_zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> zero_set_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> plus_set_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">Z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_assoc plus_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_commute plus_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">Z</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">⋅</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_set_def c_prod_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⋅</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_set_def c_prod_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_set_def c_prod_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_set_def zero_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⋅</span> <span class="skolem">X</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_prod_def zero_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> c_prod_def zero_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟷</span> <span class="skolem">X</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_set_def subset_Un_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊂</span> <span class="skolem">Y</span> <span class="main">⟷</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">∧</span> <span class="skolem">X</span> <span class="main">≠</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> psubset_eq<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_absorb plus_set_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">Y</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_set_def c_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Language Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Language dioids arise as special cases of the monoidal lifting
because sets of words form free monoids. Moreover, monoids of words
are isomorphic to monoids of lists under append.

To show that languages form dioids it therefore suffices to show that
sets of lists closed under append and multiplication with the empty
word form a (multiplicative) monoid. Isabelle then does the rest of the work
automatically. Infix~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>@›</span></span></span></span> denotes word
concatenation.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> list <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">monoid_mult</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> times_list_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> one_list_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> <span class="main">[]</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">*</span> <span class="skolem">ys</span> <span class="main">*</span> <span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">xs</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">*</span> <span class="skolem">zs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_list_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_list_def times_list_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_list_def times_list_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Languages as sets of lists have already been formalised in
Isabelle in various places. We can now obtain much of their algebra
for free.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> lan <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> lan_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> lan"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that binary relations under union, relational
composition, the identity relation, the empty relation and set
inclusion form dioids. Due to the well developed relation library of
Isabelle this is entirely trivial.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_monoid<span class="main">:</span> monoid_mult <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trace Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Traces have been considered, for instance, by
Kozen~\cite{kozen00hoare} in the context of Kleene algebras with
tests. Intuitively, a trace is an execution sequence of a labelled
transition system from some state to some other state, in which state
labels and action labels alternate, and which begin and end with a
state label.

Traces generalise words: words can be obtained from traces by
forgetting state labels. Similarly, sets of traces generalise
languages.

In this section we show that sets of traces under union, an
appropriately defined notion of complex product, the set of all traces
of length zero, the empty set of traces and set inclusion form a
dioid.

We first define the notion of trace and the product of traces, which
has been called \emph{fusion product} by Kozen.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'p</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace <span class="main">⇒</span> <span class="tfree">'p</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">first</span> <span class="main">=</span> fst"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> first_conv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"first <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> first_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace <span class="main">⇒</span> <span class="tfree">'p</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">last</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">last</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>List.last <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> last_append <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">list</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span> <span class="main">⟹</span>
    last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">list</span><span class="main">.</span> <span class="main">⟦</span><span class="free">xs</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">;</span> <span class="free">ys</span> <span class="main">=</span> <span class="main">[]</span><span class="main">⟧</span>
      <span class="main">⟹</span> last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">list</span> <span class="bound">aa</span> <span class="bound">lista</span><span class="main">.</span> <span class="main">⟦</span><span class="free">xs</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">list</span><span class="main">;</span> <span class="free">ys</span> <span class="main">=</span> <span class="bound">aa</span> <span class="main">#</span> <span class="bound">lista</span><span class="main">⟧</span>
      <span class="main">⟹</span> last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> last <span class="main">(</span>last <span class="main">(</span><span class="free">p</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The fusion product is a partial operation. It is undefined if
the last element of the first trace and the first element of the
second trace are different. If these elements are the same, then the
fusion product removes the first element from the second trace and
appends the resulting object to the first trace.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_fusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_fusion</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> last <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> first <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">@</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="keyword1">else</span> undefined"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that the first element and the last element of a
trace are a left and right unit for that trace and prove some other
auxiliary lemmas.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_fusion_leftneutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"t_fusion <span class="main">(</span>first <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_fusion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fusion_rightneutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"t_fusion <span class="free">x</span> <span class="main">(</span>last <span class="free">x</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_fusion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> first_t_fusion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">x</span> <span class="main">=</span> first <span class="free">y</span> <span class="main">⟹</span> first <span class="main">(</span>t_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> first <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_def t_fusion_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> last_t_fusion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="free">x</span> <span class="main">=</span> first <span class="free">y</span> <span class="main">⟹</span> last <span class="main">(</span>t_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> last <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> first_def t_fusion_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that fusion of traces is associative.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_fusion_assoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> last <span class="free">x</span> <span class="main">=</span> first <span class="free">y</span><span class="main">;</span> last <span class="free">y</span> <span class="main">=</span> first <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> t_fusion <span class="free">x</span> <span class="main">(</span>t_fusion <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> t_fusion <span class="main">(</span>t_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_fusion_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets of Traces›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now lift the fusion product to a complex product on sets of
traces. This operation is total.›</span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">{</span>t_fusion <span class="bound">u</span> <span class="bound">v</span><span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> last <span class="bound">u</span> <span class="main">=</span> first <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the empty set of traces and the set of traces
of length zero as the multiplicative unit of the trace dioid.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_zero</span> <span class="main">≡</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_one</span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">p</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now provide elimination rules for trace products.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_prod_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">X</span><span class="main">⋅</span><span class="free">Y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> t_fusion <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> last <span class="bound">u</span> <span class="main">=</span> first <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> t_prod_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> t_prod_intro <span class="main">[</span><span class="operator">simp</span><span class="main">,</span> <span class="operator">intro</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">u</span> <span class="main">∈</span> <span class="free">X</span><span class="main">;</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">;</span> last <span class="free">u</span> <span class="main">=</span> first <span class="free">v</span> <span class="main">⟧</span> <span class="main">⟹</span> t_fusion <span class="free">u</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span><span class="main">⋅</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> t_prod_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_prod_elim <span class="main">[</span><span class="operator">elim</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">X</span><span class="main">⋅</span><span class="free">Y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> t_fusion <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> last <span class="bound">u</span> <span class="main">=</span> first <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> t_prod_iff<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we prove the interpretation statement that sets of traces
under union and the complex product based on trace fusion together
with the empty set of traces and the set of traces of length one forms
a dioid.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> trace_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted">t_prod</span> <span class="quoted">t_one</span> <span class="quoted">t_zero</span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_prod_def t_one_def t_zero_def t_fusion_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> last_append<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> last_append append_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  t_prod <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Path Diod›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next model we consider are sets of paths in a graph. We
consider two variants, one that contains the empty path and one that
doesn't. The former leads to more difficult proofs and a more involved
specification of the complex product. We start with paths that include
the empty path. In this setting, a path is a list of nodes.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Path Models with the Empty Path›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> path <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Path fusion is defined similarly to trace
fusion. Mathematically it should be a partial operation. The fusion of
two empty paths yields the empty path; the fusion between a non-empty
path and an empty one is undefined; the fusion of two non-empty paths
appends the tail of the second path to the first one.

We need to use a total alternative and make sure that undefined paths
do not contribute to the complex product.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">p_fusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path <span class="main">⇒</span> <span class="tfree">'a</span> path <span class="main">⇒</span> <span class="tfree">'a</span> path"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p_fusion</span> <span class="main">[]</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">p_fusion</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">p_fusion</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_fusion_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"p_fusion <span class="free">ps</span> <span class="main">(</span>p_fusion <span class="free">qs</span> <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> p_fusion <span class="main">(</span>p_fusion <span class="free">ps</span> <span class="free">qs</span><span class="main">)</span> <span class="free">rs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.elims p_fusion.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">qs</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq_Nil_conv p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_fusion.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ps</span><span class="main">.</span> <span class="main">(</span><span class="main">[]</span> <span class="main">=</span> <span class="bound">ps</span> <span class="main">∨</span> hd <span class="bound">ps</span> <span class="main">#</span> tl <span class="bound">ps</span> <span class="main">=</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">qs</span><span class="main">.</span> <span class="bound">q</span> <span class="main">#</span> <span class="bound">qs</span> <span class="main">≠</span> <span class="bound">ps</span><span class="main">)</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">≠</span> <span class="bound">ps</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> list.collapse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ps</span> <span class="bound">q</span> <span class="bound">qs</span><span class="main">.</span> p_fusion <span class="bound">ps</span> <span class="main">(</span><span class="bound">q</span> <span class="main">#</span> <span class="bound">qs</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ps</span> <span class="main">@</span> <span class="bound">qs</span> <span class="main">∨</span> <span class="main">[]</span> <span class="main">=</span> <span class="bound">ps</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> Cons_eq_appendI append_eq_appendI p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This lemma overapproximates the real situation, but it holds
in all cases where path fusion should be defined.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_fusion_last<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"List.last <span class="free">ps</span> <span class="main">=</span> hd <span class="free">qs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">qs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"List.last <span class="main">(</span>p_fusion <span class="free">ps</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> List.last <span class="free">qs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> List.last.simps List.last_append append_Nil2 assms list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq_Nil_conv p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> p_fusion_hd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> hd <span class="main">(</span>p_fusion <span class="free">ps</span> <span class="free">qs</span><span class="main">)</span> <span class="main">=</span> hd <span class="free">ps</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> append_Cons list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> nonempty_p_fusion<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">ps</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">⟧</span> <span class="main">⟹</span> p_fusion <span class="free">ps</span> <span class="free">qs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> list.exhaust append_Cons p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define a condition that filters out undefined paths in
the complex product.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">p_filter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path <span class="main">⇒</span> <span class="tfree">'a</span> path <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">p_filter</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">qs</span></span></span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span> <span class="main">(</span>List.last <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> hd <span class="free"><span class="bound"><span class="entity">qs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path set <span class="main">⇒</span> <span class="tfree">'a</span> path set <span class="main">⇒</span> <span class="tfree">'a</span> path set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main"><span class="free">⋅</span></span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">rs</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">ps</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> <span class="main">∃</span><span class="bound">qs</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span><span class="main">.</span> <span class="bound">rs</span> <span class="main">=</span> p_fusion <span class="bound">ps</span> <span class="bound">qs</span> <span class="main">∧</span> p_filter <span class="bound">ps</span> <span class="bound">qs</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_prod_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">qs</span> <span class="bound">rs</span><span class="main">.</span> <span class="free">ps</span> <span class="main">=</span> p_fusion <span class="bound">qs</span> <span class="bound">rs</span> <span class="main">∧</span> <span class="bound">qs</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">rs</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> p_filter <span class="bound">qs</span> <span class="bound">rs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> p_prod_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Due to the complexity of the filter condition, proving
properties of complex products can be tedious.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_prod_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Y</span> <span class="main">⋅</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">⟷</span> <span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Y</span> <span class="main">⋅</span> <span class="free">Z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> nonempty_p_fusion p_prod_iff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_prod_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> mono_tags<span class="main"><span class="main">)</span></span> nonempty_p_fusion p_fusion_assoc p_fusion_hd p_fusion_last<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define the multiplicative unit of the path dioid as the
set of all paths of length one, including the empty path, and show the
unit laws with respect to the path product.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p_one</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">p</span> <span class="main">.</span> <span class="main">∃</span><span class="bound">q</span><span class="main">::</span><span class="tfree">'a</span><span class="main">.</span> <span class="bound">p</span> <span class="main">=</span> <span class="main">[</span><span class="bound">q</span><span class="main">]</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_prod_onel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"p_one <span class="main">⋅</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> p_one <span class="main">⋅</span> <span class="free">X</span> <span class="main">⟷</span> <span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_one_def p_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> nonempty_p_fusion not_Cons_self<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_one_def p_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Cons append_Nil list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> neq_Nil_conv p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Cons_eq_appendI list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> last_ConsL list.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> self_append_conv2<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_prod_oner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⋅</span> p_one <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> p_one <span class="main">⟷</span> <span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_one_def p_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> nonempty_p_fusion not_Cons_self2<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_one_def p_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> append_Nil2 neq_Nil_conv p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> p_fusion.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> self_append_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show distributivity laws at the powerset level.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_prod_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">Z</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">Y</span> <span class="main">∪</span> <span class="free">Z</span><span class="main">)</span> <span class="main">⟷</span> <span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">∪</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_prod_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">lemma</span></span> p_prod_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">=</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">⋅</span> <span class="free">Z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span> <span class="main">∈</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">⟷</span> <span class="skolem">ps</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Z</span> <span class="main">∪</span> <span class="free">Y</span> <span class="main">⋅</span> <span class="free">Z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ps</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_prod_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we show that sets of paths under union, the complex
product, the unit set and the empty set form a dioid.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> path_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted">p_one</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path set"</span></span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> p_prod_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> p_prod_distr<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"p_one <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> p_prod_onel<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> p_one <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> p_prod_oner<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv p_prod_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> all_not_in_conv p_prod_iff<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⊂</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> p_prod_distl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  p_prod <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Path Models without the Empty Path›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now build a model of paths that does not include the empty
path and therefore leads to a simpler complex product.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> ppath <span class="main">=</span> Node <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="main">|</span> Cons <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pp_first</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pp_first</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>   <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pp_first</span> <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pp_last</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pp_last</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>    <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pp_last</span> <span class="main">(</span>Cons <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">pp_last</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The path fusion product (although we define it as a total
funcion) should only be applied when the last element of the first
argument is equal to the first element of the second argument.›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">pp_fusion</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath <span class="main">⇒</span> <span class="tfree">'a</span> ppath <span class="main">⇒</span> <span class="tfree">'a</span> ppath"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pp_fusion</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pp_fusion</span> <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span><span class="free">pp_fusion</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now go through the same steps as for traces and paths
before, showing that the first and last element of a trace a left or
right unit for that trace and that the fusion product on traces is
associative.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pp_fusion_leftneutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pp_fusion <span class="main">(</span>Node <span class="main">(</span>pp_first <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_fusion_rightneutral <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pp_fusion <span class="free">x</span> <span class="main">(</span>Node <span class="main">(</span>pp_last <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_first_pp_fusion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pp_last <span class="free">x</span> <span class="main">=</span> pp_first <span class="free">y</span> <span class="main">⟹</span> pp_first <span class="main">(</span>pp_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> pp_first <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_last_pp_fusion <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"pp_last <span class="free">x</span> <span class="main">=</span> pp_first <span class="free">y</span> <span class="main">⟹</span> pp_last <span class="main">(</span>pp_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> pp_last <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_fusion_assoc <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pp_last <span class="free">x</span> <span class="main">=</span> pp_first <span class="free">y</span><span class="main">;</span> pp_last <span class="free">y</span> <span class="main">=</span> pp_first <span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span> pp_fusion <span class="free">x</span> <span class="main">(</span>pp_fusion <span class="free">y</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> pp_fusion <span class="main">(</span>pp_fusion <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now lift the path fusion product to a complex product on
sets of paths. This operation is total.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pp_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath set <span class="main">⇒</span> <span class="tfree">'a</span> ppath set <span class="main">⇒</span> <span class="tfree">'a</span> ppath set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="free">⋅</span></span><span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">=</span> <span class="main">{</span>pp_fusion <span class="bound">u</span> <span class="bound">v</span><span class="main">|</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span> pp_last <span class="bound">u</span> <span class="main">=</span> pp_first <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the set of paths of length one as the
multiplicative unit of the path dioid.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pp_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pp_one</span> <span class="main">≡</span> range Node"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We again provide an
elimination rule.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pp_prod_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">X</span><span class="main">⋅</span><span class="free">Y</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">w</span> <span class="main">=</span> pp_fusion <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">u</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">∧</span> pp_last <span class="bound">u</span> <span class="main">=</span> pp_first <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold</span> pp_prod_def<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">interpretation</span></span> ppath_dioid<span class="main">:</span> dioid_one_zero <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted">pp_one</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath set"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∪</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pp_first_pp_fusion pp_fusion_assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pp_last_pp_fusion<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pp_one <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_one_def pp_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pp_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pp_last.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> pp_one <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_one_def pp_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> pp_first.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> pp_fusion_rightneutral rangeI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">{}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊂</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">no_notation</span></span>
  pp_prod <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Distributive Lattice Dioid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A bounded distributive lattice is a distributive lattice with
a least and a greatest element. Using Isabelle's lattice theory file
we define a bounded distributive lattice as an axiomatic type class
and show, using a sublocale statement, that every bounded distributive
lattice is a dioid with one and zero.›</span></span>

<span class="keyword1"><span class="command">class</span></span> bounded_distributive_lattice <span class="main">=</span> bounded_lattice <span class="main">+</span> distrib_lattice

<span class="keyword1"><span class="command">sublocale</span></span> bounded_distributive_lattice <span class="main">⊆</span> dioid_one_zero <span class="quoted">sup</span> <span class="quoted">inf</span> <span class="quoted">top</span> <span class="quoted">bot</span> <span class="quoted">less_eq</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="main">(</span>sup <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> sup <span class="skolem">x</span> <span class="main">(</span>sup <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sup_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> sup <span class="skolem">y</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sup.commute<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> inf <span class="skolem">x</span> <span class="main">(</span>inf <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> inf.commute inf.left_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="main">(</span>sup <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> sup <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">(</span>inf <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> inf_sup_distrib2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf top <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="skolem">x</span> top <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup bot <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf bot <span class="skolem">x</span> <span class="main">=</span> bot"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="skolem">x</span> bot <span class="main">=</span> bot"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sup <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> le_iff_sup<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="skolem">x</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inf <span class="skolem">x</span> <span class="main">(</span>sup <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> sup <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> inf_sup_distrib1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Boolean Dioid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we show that the booleans form a dioid,
because the booleans form a bounded distributive lattice.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> bool <span class="main">::</span> <span class="quoted">bounded_distributive_lattice</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">interpretation</span></span> boolean_dioid<span class="main">:</span> dioid_one_zero <span class="quoted">sup</span> <span class="quoted">inf</span> <span class="quoted">True</span> <span class="quoted">False</span> <span class="quoted">less_eq</span> <span class="quoted">less</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_bool_def sup_bool_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Max-Plus Dioid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following dioids have important applications in
combinatorial optimisations, control theory, algorithm design and
computer networks.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A definition of reals extended with~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+∞›</span></span></span></span> {\em
and}~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-∞›</span></span></span></span> may be found in {\em
HOL/Library/Extended\_Real.thy}. Alas, we require separate extensions
with either~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>+∞›</span></span></span></span> or~<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>-∞›</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The carrier set of the max-plus semiring is the set of real
numbers extended by minus infinity. The operation of addition is
maximum, the operation of multiplication is addition, the additive
unit is minus infinity and the multiplicative unit is zero.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> mreal <span class="main">=</span> mreal <span class="quoted">real</span> <span class="main">|</span> MInfty  <span class="comment1">― ‹minus infinity›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mreal_max</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mreal_max</span> <span class="main">(</span>mreal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>mreal <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> mreal <span class="main">(</span>max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mreal_max</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> MInfty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mreal_max</span> MInfty <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mreal_max_simp_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mreal_max MInfty <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mreal_plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mreal_plus</span> <span class="main">(</span>mreal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>mreal <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> mreal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mreal_plus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> MInfty"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that the max plus-semiring satisfies the axioms of
selective semirings, from which it follows that it satisfies the dioid
axioms.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> mreal <span class="main">::</span> <span class="quoted">selective_semiring</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> zero_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> MInfty"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> one_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> mreal <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> plus_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> mreal_max <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> times_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> mreal_plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_eq_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>mreal<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_mreal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>mreal<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">mreal</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def times_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_mreal_def times_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_mreal_def times_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def zero_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_mreal_def zero_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_mreal_def zero_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_mreal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> linorder_le_cases max.absorb_iff2 max.absorb1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_mreal_def times_mreal_def<span class="main">)</span>     <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Min-Plus Dioid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The min-plus dioid is also known as {\em tropical
semiring}. Here we need to add a positive infinity to the real
numbers. The procedere follows that of max-plus semirings.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> preal <span class="main">=</span> preal <span class="quoted">real</span> <span class="main">|</span> PInfty  <span class="comment1">― ‹plus infinity›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">preal_min</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preal_min</span> <span class="main">(</span>preal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>preal <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> preal <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preal_min</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> PInfty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preal_min</span> PInfty <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> preal_min_simp_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"preal_min PInfty <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">preal_plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">preal_plus</span> <span class="main">(</span>preal <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>preal <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> preal <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">preal_plus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> PInfty"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> preal <span class="main">::</span> <span class="quoted">selective_semiring</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> zero_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> PInfty"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> one_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> preal <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> plus_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> preal_min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> times_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> preal_plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_eq_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>preal<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_preal_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>preal<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">preal</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def times_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_preal_def times_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_preal_def times_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def zero_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_preal_def zero_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_preal_def zero_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_preal_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
     <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> linorder_le_cases min.absorb2 min.absorb_iff1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_preal_def times_preal_def<span class="main">)</span>   <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Variants of min-plus and max-plus semirings can easily be
obtained. Here we formalise the min-plus semiring over the natural
numbers as an example.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> pnat <span class="main">=</span> pnat <span class="quoted">nat</span> <span class="main">|</span> PInfty  <span class="comment1">― ‹plus infinity›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnat_min</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnat_min</span> <span class="main">(</span>pnat <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>pnat <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> pnat <span class="main">(</span>min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnat_min</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> PInfty <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnat_min</span> PInfty <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pnat_min_simp_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnat_min PInfty <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pnat_plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pnat_plus</span> <span class="main">(</span>pnat <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>pnat <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> pnat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pnat_plus</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> PInfty"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> pnat <span class="main">::</span> <span class="quoted">selective_semiring</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> zero_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> PInfty"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> one_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> pnat <span class="main">0</span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> plus_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> pnat_min <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> times_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> pnat_plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_eq_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>pnat<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> less_pnat_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">::</span>pnat<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> zero_pnat_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">::</span>pnat<span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_pnat_def plus_pnat_def one_pnat_def<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">pnat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def times_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_pnat_def times_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_pnat_def times_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def zero_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_pnat_def zero_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_pnat_def zero_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> linorder_le_cases min.absorb2 min.absorb_iff1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_pnat_def times_pnat_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Matrix">
<div class="head">
<h1>Theory Matrix</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Matrix Model of Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Matrices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Matrix
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/Word.html">HOL-Library.Word</a>"</span> <a href="Dioid.html">Dioid</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we formalise a perhaps more natural version of
matrices of fixed dimension ($m \times n$-matrices). It is well known
that such matrices over a Kleene algebra form a Kleene
algebra~\cite{conway71regular}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Type Definition›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> atMost <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len<span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">declare</span></span> Rep_atMost_inject <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemma</span></span> UNIV_atMost<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'a</span> atMost set<span class="main">)</span> <span class="main">=</span> Abs_atMost <span class="main">`</span> <span class="main">{..&lt;</span><span class="keyword1">LENGTH</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len<span class="main">)</span><span class="main">}</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Abs_atMost_induct<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> finite_UNIV_atMost <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>len<span class="main">)</span> atMost set<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> UNIV_atMost<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Our matrix type is similar to \mbox{<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>'a^'n^'m›</span></span></span></span>} from
{\em HOL/Multivariate\_Analysis/Finite\_Cartesian\_Product.thy}, but
(i)~we explicitly define a type constructor for matrices and square
matrices, and (ii)~in the definition of operations, e.g., matrix
multiplication, we impose weaker sort requirements on the element
type.›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">notes</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">typedef_overloaded</span><span class="main">]</span><span class="main">]</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix <span class="main">=</span> Matrix <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> atMost <span class="main">⇒</span> <span class="tfree">'n</span> atMost <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix <span class="main">=</span> SqMatrix <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> atMost <span class="main">⇒</span> <span class="tfree">'m</span> atMost <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sqmatrix_of_matrix</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqmatrix_of_matrix</span> <span class="main">(</span>Matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> SqMatrix <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">matrix_of_sqmatrix</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matrix_of_sqmatrix</span> <span class="main">(</span>SqMatrix <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">=</span> Matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹0 and 1›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">zero</span><span class="main">,</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> zero_matrix_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> Matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted">zero</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> zero_sqmatrix_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≡</span> SqMatrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Tricky sort issues: compare <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">one_matrix</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> with <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span>
<span class="quoted"><span class="free"><span class="quoted"><span class="free">one_sqmatrix</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> \dots›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> matrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>zero<span class="main">,</span>one<span class="main">}</span>"</span></span><span class="main">,</span><span class="quoted">len</span><span class="main">,</span><span class="quoted">len</span><span class="main">)</span> <span class="quoted">one</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> one_matrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> Matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> Rep_atMost <span class="bound">i</span> <span class="main">=</span> Rep_atMost <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>zero<span class="main">,</span>one<span class="main">}</span>"</span></span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">one</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> one_sqmatrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≡</span> SqMatrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Matrix Addition›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">matrix_plus</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matrix_plus</span> <span class="main">(</span>Matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>Matrix <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> Matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">plus</span><span class="main">,</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> plus_matrix_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> matrix_plus <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_matrix_def' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"Matrix <span class="free">A</span> <span class="main">+</span> Matrix <span class="free">B</span> <span class="main">=</span> Matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted">plus</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> plus_sqmatrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> sqmatrix_of_matrix <span class="main">(</span>matrix_of_sqmatrix <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> matrix_of_sqmatrix <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> plus_sqmatrix_def' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"SqMatrix <span class="free">A</span> <span class="main">+</span> SqMatrix <span class="free">B</span> <span class="main">=</span> SqMatrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="bound">j</span> <span class="main">+</span> <span class="free">B</span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_0_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ab_semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_add_left_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ab_semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> matrix_add_assoc matrix_add_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_add_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_add_0_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="free">A</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_add_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ab_semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_add_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span> <span class="main">+</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_add_left_commute <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>ab_semigroup_add<span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">B</span> <span class="main">+</span> <span class="main">(</span><span class="free">A</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sqmatrix_add_commute sqmatrix_add_assoc<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Order (via Addition)›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> matrix <span class="main">::</span> <span class="main">(</span><span class="quoted">plus</span><span class="main">,</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus_ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_eq_matrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_matrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span> <span class="main">⟷</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_matrix_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&lt;</span> <span class="skolem">B</span> <span class="main">⟷</span> <span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_matrix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted">plus</span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus_ord</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_eq_sqmatrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> less_sqmatrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> sqmatrix"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span> <span class="main">⟷</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_sqmatrix_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">&lt;</span> <span class="skolem">B</span> <span class="main">⟷</span> <span class="skolem">A</span> <span class="main">≤</span> <span class="skolem">B</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">≠</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_sqmatrix_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Matrix Multiplication›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">matrix_times</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>times<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'k</span><span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matrix_times</span> <span class="main">(</span>Matrix <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span> <span class="main">(</span>Matrix <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span> <span class="main">=</span> Matrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="bound">k</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k</span> atMost set<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> matrix_times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span>"</span> 70<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted"><span class="quoted">"<span class="main">{</span>comm_monoid_add<span class="main">,</span>times<span class="main">}</span>"</span></span><span class="main">,</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">times</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> times_sqmatrix_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> sqmatrix_of_matrix <span class="main">(</span>matrix_of_sqmatrix <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> matrix_of_sqmatrix <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> times_sqmatrix_def' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"SqMatrix <span class="free">A</span> <span class="main">*</span> SqMatrix <span class="free">B</span> <span class="main">=</span> SqMatrix <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> sum <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">A</span> <span class="bound">i</span> <span class="bound">k</span> <span class="main">*</span> <span class="free">B</span> <span class="bound">k</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k</span> atMost set<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_0_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_delta_r_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">j</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_delta_r_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">j</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">*</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">j</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_1_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">,</span><span class="tfree">'n</span><span class="main">::</span>len<span class="main">)</span> matrix<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">1</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_delta_l_0 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_delta_l_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> finite <span class="free">S</span><span class="main">;</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">k</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">f</span> <span class="bound">k</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">S</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_1_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">,</span><span class="tfree">'n</span><span class="main">::</span>len<span class="main">)</span> matrix<span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_matrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>semiring_0<span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">)</span> matrix<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right sum_distrib_left mult.assoc<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.swap<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_distrib_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>semiring<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">::</span>len<span class="main">)</span> matrix<span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> matrix_mult_distrib_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>semiring<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">,</span><span class="tfree">'n</span><span class="main">::</span>len<span class="main">)</span> matrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span> <span class="main">+</span> <span class="free">B</span> <span class="keyword1">*<span class="hidden">⇩</span><sub>M</sub></span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_0_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_0_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_1_right <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_1_left <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_sqmatrix_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>semiring_0<span class="main">,</span>monoid_mult<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">*</span> <span class="free">B</span> <span class="main">*</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">*</span> <span class="free">C</span><span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distrib_right sum_distrib_left mult.assoc<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> sum.swap<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> refl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_distrib_left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>semiring<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">B</span> <span class="main">+</span> <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">B</span> <span class="main">+</span> <span class="free">A</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left sum.distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sqmatrix_mult_distrib_right<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">A</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>semiring<span class="main">}</span><span class="main">,</span><span class="tfree">'m</span><span class="main">::</span>len<span class="main">)</span> sqmatrix<span class="main">)</span> <span class="main">+</span> <span class="free">B</span><span class="main">)</span> <span class="main">*</span> <span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">*</span> <span class="free">C</span> <span class="main">+</span> <span class="free">B</span> <span class="main">*</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">B</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">C</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_right sum.distrib<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Square-Matrix Model of Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following subclass proofs are necessary to connect parts
of our algebraic hierarchy to the hierarchy found in the Isabelle/HOL
library.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ab_near_semiring_one_zerol<span class="main">)</span> comm_monoid_add
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> add_zerol<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semiring_one_zero<span class="main">)</span> semiring_0
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> annil<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> annir<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ab_near_semiring_one<span class="main">)</span> monoid_mult <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> sqmatrix <span class="main">::</span> <span class="main">(</span><span class="quoted">dioid_one_zero</span><span class="main">,</span><span class="quoted">len</span><span class="main">)</span> <span class="quoted">dioid_one_zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">C</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> sqmatrix"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">+</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_add_assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">B</span> <span class="main">+</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_add_commute<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">*</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">*</span> <span class="skolem">C</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">*</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_distrib_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_1_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_1_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_add_0_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_0_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_0_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">+</span> <span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">+</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">*</span> <span class="skolem">B</span> <span class="main">+</span> <span class="skolem">A</span> <span class="main">*</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> sqmatrix_mult_distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleene Star for Matrices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We currently do not implement the Kleene star of matrices,
since this is complicated.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Conway">
<div class="head">
<h1>Theory Conway</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Conway Algebra
   Author:     Alasdair Armstrong, Victor B. F. Gomes, Georg Struth
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Conway Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Conway
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Dioid.html">Dioid</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a weak regular algebra which can serve as a common basis for Kleene algebra and demonic reginement algebra.
  It is closely related to an axiomatisation given by Conway~\cite{conway71regular}. 
›</span></span>

<span class="keyword1"><span class="command">class</span></span> dagger_op <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">dagger</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>†</sup></span></span></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Near Conway Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> near_conway_base <span class="main">=</span> near_dioid_one <span class="main">+</span> dagger_op <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dagger_denest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> dagger_prod_unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldl_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_prod_unfold mult_1_left mult_1_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldr_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_prod_unfold mult_1_right mult_1_left<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldl_distr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_right' mult_1_left dagger_unfoldl_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_unfoldr_distr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_unfoldr_eq distrib_right' mult_1_left mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dagger_unfoldl local.join.sup.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_plus_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dagger_refl local.join.sup_absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_1l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dagger_unfoldl local.join.sup.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> star_1r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dagger_unfoldr local.join.sup.bounded_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_unfoldl_distr local.join.sup.boundedE star_1r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_trans_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_unfoldr_eq local.dagger_denest local.join.sup.idem mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_subdist<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_unfoldr_distr local.dagger_denest local.order_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_subdist_var<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dagger_subdist local.join.sup_commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_iso <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_def dagger_subdist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_plus_one dagger_subdist dagger_trans_eq dagger_unfoldr_distr local.dagger_denest local.distrib_right' local.eq_iff  local.join.sup_commute local.less_eq_def  local.mult_onel mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_rtc1_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.dagger_ext local.dagger_refl local.join.sup_absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick refutes the next lemmas.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect = genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span><span class="quoted"><span class="plain_text">‹Pre-Conway Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_conway_base <span class="main">=</span> near_conway_base <span class="main">+</span> pre_dioid_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_subdist_var_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.dagger_subdist_var local.mult_isol_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_subdist_var_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> dagger_subdist_var_3 local.dagger_ext local.mult_isol_var local.order.trans<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_sum_unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.dagger_denest local.dagger_unfoldl_distr mult_assoc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conway Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> conway_base <span class="main">=</span> pre_conway_base <span class="main">+</span> dioid_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> troeger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_sum_unfold local.distrib_right'<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute local.distrib_left mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide_var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.dagger_unfoldl_distr local.dagger_unfoldr_eq local.distrib_left local.eq_iff local.mult_1_right mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide_var1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.dagger_unfoldl_distr local.dagger_unfoldr_eq local.distrib_left local.mult_1_right mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.dagger_prod_unfold local.distrib_right' local.mult_onel<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.distrib_left local.mult_1_right mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conway Algebras with  Zero›</span></span>

<span class="keyword1"><span class="command">class</span></span> near_conway_base_zerol <span class="main">=</span> near_conway_base <span class="main">+</span> near_dioid_one_zerol

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil dagger_unfoldl_eq mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_dagger <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0_right annil dagger_annil<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_conway_base_zerol <span class="main">=</span> near_conway_base_zerol <span class="main">+</span> pre_dioid

<span class="keyword1"><span class="command">class</span></span> conway_base_zerol <span class="main">=</span> pre_conway_base_zerol <span class="main">+</span> dioid

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_conway_base_zerol<span class="main">)</span> pre_conway_base <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> conway_base_zerol<span class="main">)</span> conway_base <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">context</span></span> conway_base_zerol
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span> 

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conway Algebras with Simulation›</span></span>

<span class="keyword1"><span class="command">class</span></span> near_conway <span class="main">=</span> near_conway_base <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dagger_simr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_refl dagger_simr mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick refutes the next lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We say that $y$ preserves $x$ if $x \cdot y \cdot x = x \cdot y$ and $!x \cdot y \cdot !x = !x \cdot y$. This definition is taken
  from Solin~\cite{Solin11}. It is useful for program transformation.
›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> preservation1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.join.le_supI1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.dagger_simr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> near_conway_zerol <span class="main">=</span> near_conway <span class="main">+</span> near_dioid_one_zerol

<span class="keyword1"><span class="command">class</span></span> pre_conway <span class="main">=</span> near_conway <span class="main">+</span> pre_dioid_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> pre_conway_base <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_slide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute dagger_prod_unfold join.sup_least mult_1_right mult.assoc subdistl dagger_slide_var dagger_unfoldl_distr antisym<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_denest2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_denest dagger_slide<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preservation2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dagger_slide local.dagger_iso local.mult_isol<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> preservation1_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.dagger_simr local.eq_iff preservation2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_conway_zerol <span class="main">=</span> near_conway_zerol <span class="main">+</span> pre_dioid_one_zerol

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> pre_conway <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> conway <span class="main">=</span> pre_conway <span class="main">+</span> dioid_one

<span class="keyword1"><span class="command">class</span></span> conway_zerol <span class="main">=</span> pre_conway <span class="main">+</span> dioid_one_zerol

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> conway_base <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick refutes the next lemmas.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> <span class="main">1</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dagger_denest_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(* nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>†</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kleene_Algebra">
<div class="head">
<h1>Theory Kleene_Algebra</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kleene_Algebra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Conway.html">Conway</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Near Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Extending the hierarchy developed in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Dioid.html"></a><a href="Dioid.html">Kleene_Algebra.Dioid</a><span class="antiquote"><span class="antiquote">}</span></span></span></span> we now
add an operation of Kleene star, finite iteration, or reflexive
transitive closure to variants of Dioids. Since a multiplicative unit
is needed for defining the star we only consider variants with~$1$;
$0$ can be added separately. We consider the left star induction axiom
and the right star induction axiom independently since in some
applications, e.g., Salomaa's axioms, probabilistic Kleene algebras,
or completeness proofs with respect to the equational theoy of regular
expressions and regular languages, the right star induction axiom is
not needed or not valid.

We start with near dioids, then consider pre-dioids and finally
dioids. It turns out that many of the known laws of Kleene algebras
hold already in these more general settings. In fact, all our
equational theorems have been proved within left Kleene algebras, as
expected.

Although most of the proofs in this file could be fully automated by
Sledgehammer and Metis, we display step-wise proofs as they would
appear in a text book. First, this file may then be useful as a
reference manual on Kleene algebra. Second, it is better protected
against changes in the underlying theories and supports easy
translation of proofs into other settings.›</span></span>

<span class="keyword1"><span class="command">class</span></span> left_near_kleene_algebra <span class="main">=</span> near_dioid_one <span class="main">+</span> star_op <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> star_unfoldl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> star_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we prove two immediate consequences of the unfold
axiom. The first one states that starred elements are reflexive.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_ref <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> star_unfoldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Reflexivity of starred elements implies, by definition of the
order, that~$1$ is an additive unit for starred elements.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_plus_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_eq_def star_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> star_1l <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> star_unfoldl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that starred elements are transitive.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_trans_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span> <span class="comment1">― ‹this splits an equation into two inequalities›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isor star_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now derive variants of the star induction axiom.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_var_equiv <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_var<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff mult_1_left mult_isor star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor star_1l<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_var_eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff star_inductl_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_var_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isor star_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyp eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_one<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> star_inductl <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductl_eq<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove two facts related to~$1$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_subid<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_oner star_inductl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_one <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_subid<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove a subdistributivity property for the star (which
is equivalent to isotonicity of star).›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_subdist<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_1l<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation order_trans star_inductl_star <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_subdist_var<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> join.sup_commute star_subdist <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> star_iso <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_def star_subdist<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove some more simple properties.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_invol <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_trans_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_star<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> star_inductl_var_equiv<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_star<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_star<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following facts express inductive conditions that are used
to show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">x</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">y</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the greatest term that can be built
from~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> prod_star_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assm mult_isor<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation order.trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_star_closure<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_invol<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_closed_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_plus_one star_trans_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* left_near_kleene_algebra *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Pre-Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> left_pre_kleene_algebra <span class="main">=</span> left_near_kleene_algebra <span class="main">+</span> pre_dioid_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first prove that the star operation is extensive.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_ext <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_oner mult_isol star_ref<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_trans star_1l<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove a right star unfold law.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_1r <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_unfoldr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove a simulation law for the star.  It is
instrumental in proving further properties.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_sim1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span>  <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_isol mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.sup_least mult_isol mult_oner star_ref<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is used in omega algebras to prove, for
instance, Bachmair and Dershowitz's separation of termination
theorem~\cite{bachmair86commutation}. The property at the left-hand
side of the equivalence is known as \emph{quasicommutation}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> quasicomm_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟷</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> star_sim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mult_isor order_trans star_ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_slide1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc star_sim1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_slide_var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_sim1<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that the (left) star unfold axiom can be strengthened to an equality.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_unfoldl_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_unfoldl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> join.sup_mono eq_refl mult_isol star_unfoldl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we relate the star and the reflexive transitive closure
operation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc1_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join.sup.absorb2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.eq_iff local.star_inductl_one<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.star_closed_unfold <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl star_plus_one star_rtc2 star_trans_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.le_sup_iff mult_isol_var star_trans_eq star_rtc2<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_rtc_least_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_rtc_least<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are again related to closure conditions›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_subdist_var_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> join.sup.boundedE star_ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_subdist_var_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> join.sup.boundedE prod_star_closure star_ext<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_subdist_var_3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_star_closure star_iso<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove variants of sum-elimination laws under a star.
These are also known a denesting laws or as sum-star laws.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.sup.bounded_iff mult_1_right mult_isol_var mult_onel star_ref star_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_subdist_var_3<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_star_closure star_inductl_star<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_sum_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isol_var mult_oner star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isol_var mult_onel star_1l star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_oner star_inductl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_isol_var star_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute star_denest<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_subdist<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prod_star_closure <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_4 <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_comm star_denest<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_5 <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_denest_var_4<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>


<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_6 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_7 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans mult_1_left mult_isor star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isor star_1l <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc star_inductl_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_8 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_denest_var_9 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> star_denest_var_7 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following statements are well known from term
rewriting. They are all variants of the Church-Rosser theorem in
Kleene algebra~\cite{struth06churchrosser}. But first we prove a law
relating two confluence properties.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> confluence_var <span class="main">[</span><span class="operator">iff</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟷</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> star_sim1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mult_isor order_trans star_ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> church_rosser <span class="main">[</span><span class="operator">intro</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isol mult_isor mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans mult_1_right mult_isol star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> church_rosser_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> church_rosser_to_confluence<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_comm eq_iff star_subdist_var_3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> church_rosser_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> church_rosser_to_confluence eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> confluence_to_local_confluence<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> mult_isol_var order_trans star_ext<span class="main">)</span>


<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] *)</span> <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
More variations could easily be proved. The last counterexample shows
that Newman's lemma needs a wellfoundedness assumption. This is well
known.
›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas relate the reflexive transitive closure and
the transitive closure.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_id_star1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">" <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isor <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_id_star2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order.antisym mult_isol mult_oner star_1r<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
<span class="comment1">(* nitpick [expect=genuine] *)</span> 
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* left_pre_kleene_algebra *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> left_kleene_algebra <span class="main">=</span> left_pre_kleene_algebra <span class="main">+</span> dioid_one

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In left Kleene algebras the non-fact <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">prop</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">z</span></span> <span class="main"><span class="main">+</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">⟹</span></span> <span class="free"><span class="free">z</span></span> <span class="main"><span class="main">⋅</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is a good challenge for counterexample generators. A model of left
Kleene algebras in which the right star induction law does not hold
has been given by Kozen~\cite{kozen90kleene}.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that the right unfold law becomes an equality.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_unfoldr_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_unfoldr<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distrib_left distrib_right mult_1_left mult_1_right mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following more complex unfold law has been used as an
axiom, called prodstar, by Conway~\cite{conway71regular}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_prod_unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.sup_mono mult_isor order_refl star_slide1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span>  <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.sup_mono eq_refl mult.assoc mult_isol star_slide1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The slide laws, which have previously been inequalities, now
become equations.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_slide <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_slide_var <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_onel mult_oner star_slide<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_sum_unfold_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_denest star_denest_var_3 star_denest_var_4 star_plus_one star_slide<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following law shows how starred sums can be unfolded.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_sum_unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following property appears in process algebra.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> troeger<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> distrib_right star_sum_unfold<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_commute distrib_left mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following properties are related to a property from
propositional dynamic logic which has been attributed to Albert
Meyer~\cite{harelkozentiuryn00dynamic}. Here we prove it as a theorem
of Kleene algebra.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_star_closure<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_star<span class="main">)</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> meyer_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span>  <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join.sup_mono star_1l <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span>  <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join.sup_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> join.sup.coboundedI1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductl_one mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod_star_closure star_square<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma says that transitive elements are equal to
their transitive closure.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_inductl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isol mult_oner star_ref star_slide_var eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> tc_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> tc<span class="main">)</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next fact has been used by Boffa~\cite{boffa90remarque} to
axiomatise the equational theory of regular expressions.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> boffa_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> tc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> boffa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> boffa_var<span class="main">)</span>

<span class="comment1">(*
text {*
For the following two lemmas, Isabelle could neither find a
counterexample nor a proof automatically.
*}

lemma "z ⋅ x ≤ y ⋅ z ⟹ z ⋅ x<span class="hidden">⇧</span><sup>⋆</sup> ≤ y<span class="hidden">⇧</span><sup>⋆</sup> ⋅ z"
  -- "unfortunately, no counterexample found"
oops

lemma star_sim3: "z ⋅ x = y ⋅ z ⟹ z ⋅ x<span class="hidden">⇧</span><sup>⋆</sup> = y<span class="hidden">⇧</span><sup>⋆</sup> ⋅ z"
  -- "we conjecture that this is not provable"
oops
*)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* left_kleene_algebra *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Kleene Algebras with Zero›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
There are applications where only a left zero is assumed, for instance
in the context of total correctness and for demonic refinement
algebras~\cite{vonwright04refinement}.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> left_kleene_algebra_zerol <span class="main">=</span> left_kleene_algebra <span class="main">+</span> dioid_one_zerol
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> conway<span class="main">:</span> near_conway_base_zerol <span class="quoted">star</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.star_slide<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> local.conway.zero_dagger<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In principle,~$1$ could therefore be defined from~$0$ in this setting.
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* left_kleene_algebra_zerol *)</span>


<span class="keyword1"><span class="command">class</span></span> left_kleene_algebra_zero <span class="main">=</span> left_kleene_algebra_zerol <span class="main">+</span> dioid_one_zero


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Pre-Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Pre-Kleene algebras are essentially probabilistic Kleene
algebras~\cite{mciverweber05pka}.  They have a weaker right star
unfold axiom. We are still looking for theorems that could be proved
in this setting.›</span></span>

<span class="keyword1"><span class="command">class</span></span> pre_kleene_algebra <span class="main">=</span> left_pre_kleene_algebra <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weak_star_unfoldr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> kleene_algebra_zerol <span class="main">=</span> left_kleene_algebra_zerol <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> star_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isol mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mult_isor star_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> conway<span class="main">:</span> pre_conway <span class="quoted">star</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_sim2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductr_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductr_var_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> order_trans mult_isol star_ext star_inductr_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_sim3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff star_sim1 star_sim2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_sim4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span>  <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> star_sim1 star_sim2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> star_inductr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductr_var_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> star_inductr_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_inductr_var_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_onel star_one star_sim3<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> bubble_sort<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> star_sim4<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> independence1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_right mult_onel star_unfoldr_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0_left add.commute join.sup_ge1 eq_iff star_inductl_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> independence2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil mult_onel star_sim3 star_zero<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lazycomm_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="var">?t</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?t</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="var">?t</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="var">?t</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> hyp join.sup.coboundedI2 join.sup_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="var">?t</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eq_refl join.sup_least join.sup_mono mult_isol prod_star_closure star_subdist_var_1 mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">+</span> <span class="main">(</span><span class="var">?t</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="var">?t</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> dual_order.trans mult_isol star_ext <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> arden_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">v</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_comm eq_iff star_inductl_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_refl mult_onel<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, here come the Kleene algebras \`a~la
Kozen~\cite{kozen94complete}. We only prove quasi-identities in this
section. Since left Kleene algebras are complete with respect to the
equational theory of regular expressions and regular languages, all
identities hold already without the right star induction axiom.›</span></span>

<span class="keyword1"><span class="command">class</span></span> kleene_algebra <span class="main">=</span> left_kleene_algebra_zero <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> star_inductr'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> kleene_algebra_zerol 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_inductr'<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> conway_zerol<span class="main">:</span> conway <span class="quoted">star</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The next lemma shows that opposites of Kleene algebras (i.e., Kleene
algebras with the order of multiplication swapped) are again Kleene
algebras.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dual_kleene_algebra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"class.kleene_algebra <span class="main">(+)</span> <span class="main">(⊙)</span> <span class="main">1</span> <span class="main">0</span> <span class="main">(≤)</span> <span class="main">(&lt;)</span> star"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⊙</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">⊙</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc opp_mult_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⊙</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⊙</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> opp_mult_def distrib_left<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⊙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_oner opp_mult_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊙</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_onel opp_mult_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> add_zerol<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⊙</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annir opp_mult_def<span class="main">)</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊙</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil opp_mult_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> add_idem<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊙</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_right opp_mult_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊙</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⊙</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor opp_mult_def order_prop<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> opp_mult_def order_refl star_slide_var star_unfoldl_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⊙</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⊙</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> opp_mult_def star_inductr<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⊙</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">z</span> <span class="main">⊙</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> opp_mult_def star_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* kleene_algebra *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We finish with some properties on (multiplicatively)
commutative Kleene algebras. A chapter in Conway's
book~\cite{conway71regular} is devoted to this topic.›</span></span>

<span class="keyword1"><span class="command">class</span></span> commutative_kleene_algebra <span class="main">=</span> kleene_algebra <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> mult_comm <span class="main">[</span><span class="operator">ac_simps</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> conway_c3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> church_rosser mult_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> conway_c4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> conway_c3 star_denest_var star_prod_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cka_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> conway_c3 star_invol star_iso star_subdist_var_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> cka_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> conway_c3 mult_comm star_denest_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conway_c4_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> conway_c3 star_invol<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conway_c2_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor star_1r mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> conway_c2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cka_1 conway_c3 prod_star_closure star_ext star_sum_var<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distrib_left mult_comm mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_iso mult_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conway_c2_var join.sup_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> dual_order.trans join.sup_ge2 mult_1_left mult_isor star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc star_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* commutative_kleene_algebra *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Kleene_Algebra_Models">
<div class="head">
<h1>Theory Kleene_Algebra_Models</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Models of Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models of Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Kleene_Algebra_Models
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleene_Algebra.html">Kleene_Algebra</a> <a href="Dioid_Models.html">Dioid_Models</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that most of the models considered for dioids are
also Kleene algebras. Some of the dioid models cannot be expanded, for
instance max-plus and min-plus semirings, but we do not formalise this
fact. We also currently do not show that formal powerseries and
matrices form Kleene algebras.

The interpretation proofs for some of the following models are quite
similar. One could, perhaps, abstract out common reasoning in the
future.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary Lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first prove two induction-style statements for dioids that
are useful for establishing the full induction laws. In the future
these will live in a theory file on finite sums for Kleene
algebras.›</span></span>

<span class="keyword1"><span class="command">context</span></span> dioid_one_zero
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_inductl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> mult.assoc mult_isol order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_inductr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">n</span><span class="main">)</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">case</span></span> Suc
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc power_Suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc power_commutes<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult_isor<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">^</span> Suc <span class="skolem">n</span> <span class="main">≤</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* dioid_one_zero *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Powerset Kleene Algebra over a Monoid›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that the powerset dioid forms a Kleene
algebra. The Kleene star is defined as in language theory.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Un_0_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">0</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> not0_implies_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">monoid_mult</span><span class="main">)</span> <span class="quoted">kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> star_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> star_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">^</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_elim c_prod_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="main">^</span> <span class="bound">n</span> <span class="main">⋅</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_elim c_prod_def<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⊆</span> <span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">(</span><span class="skolem">X</span> <span class="main">^</span> <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">^</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_def c_prod_def plus_set_def one_set_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="skolem">X</span> <span class="main">^</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_0_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">X</span> <span class="main">⋅</span> <span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_contr SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> hyp dioid_one_zero_class.power_inductl<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">+</span> <span class="skolem">Y</span> <span class="main">⋅</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">⋅</span> <span class="skolem">X</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_contl SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">meson</span> dioid_one_zero_class.power_inductr hyp<span class="main">)</span> 
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Language Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now specialise this fact to languages.›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> lan_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> lan"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">star</span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Regular Languages›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹{\ldots} and further to regular languages. For the sake of
simplicity we just copy in the axiomatisation of regular expressions
by Krauss and Nipkow~\cite{krauss12regular}.›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> rexp <span class="main">=</span>
  Zero
<span class="main">|</span> One
<span class="main">|</span> Atom <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
<span class="main">|</span> Plus <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>
<span class="main">|</span> Times <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>
<span class="main">|</span> Star <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The interpretation map that induces regular languages as the
images of regular expressions in the set of languages has also been
adapted from there.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">lang</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rexp <span class="main">⇒</span> <span class="tfree">'a</span> lan"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lang</span> Zero <span class="main">=</span> <span class="main">0</span>"</span></span>  <span class="comment1">― ‹{}›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> One <span class="main">=</span> <span class="main">1</span>"</span></span>  <span class="comment1">― ‹{[]}›</span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Atom <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lang</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">lang</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> reg_lan <span class="main">=</span> <span class="quoted"><span class="quoted">"range lang <span class="main">::</span> <span class="tfree">'a</span> lan set"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_reg_lan

<span class="keyword1"><span class="command">instantiation</span></span> reg_lan <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">star_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">star</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> image_iff lang.simps<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="main">0</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lang.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">one_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="main">1</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> lang.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">less_eq</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan <span class="main">⇒</span> bool"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">less</span> <span class="keyword1"><span class="command">.</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">plus</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> image_iff lang.simps<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_reg_lan</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan <span class="main">⇒</span> <span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">times</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>hide_lams<span class="main"><span class="main">,</span></span> no_types<span class="main"><span class="main">)</span></span> image_iff lang.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rangeI<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> reg_lan"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> join_semilattice_class.add_assoc'<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> join_semilattice_class.add_comm<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> semigroup_mult_class.mult.assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> semiring_class.distrib_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> monoid_mult_class.mult_1_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> monoid_mult_class.mult_1_right<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> join_semilattice_zero_class.add_zero_l<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> ab_near_semiring_one_zerol_class.annil<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> ab_near_semiring_one_zero_class.annir<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> plus_ord_class.less_eq_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="skolem">x</span> <span class="main">≠</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> plus_ord_class.less_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> join_semilattice_class.add_idem<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> semiring_class.distrib_left<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> pre_dioid_class.subdistl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> star_unfoldl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> star_inductl<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">metis</span> star_inductr<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>  <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">interpretation</span></span> reg_lan_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(+)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⋅)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span><span class="main">::</span><span class="tfree">'a</span> reg_lan"</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="quoted">star</span> <span class="keyword1"><span class="command">..</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now show that binary relations form Kleene algebras. While
we could have used the reflexive transitive closure operation as the
Kleene star, we prefer the equivalent definition of the star as the
sum of powers. This essentially allows us to copy previous proofs.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> power_is_relpow<span class="main">:</span> <span class="quoted"><span class="quoted">"rel_dioid.power <span class="free">X</span> <span class="free">n</span> <span class="main">=</span> <span class="free">X</span> <span class="main">^^</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_dioid.power_0 relpow.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_dioid.power_Suc2 relpow.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> rel_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_is_relpow rtrancl_is_UN_relpow<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="keyword1">O</span> <span class="free">Y</span><span class="main">^*</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="free">X</span> <span class="keyword1">O</span> rel_dioid.power <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_star_def relcomp_UNION_distrib<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> rel_star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">^*</span> <span class="keyword1">O</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>rel_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="keyword1">O</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> rel_star_def relcomp_UNION_distrib2<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Id <span class="main">∪</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl r_comp_rtrancl_eq rtrancl_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_star_contr<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> SUP_le_iff rel_dioid.power_inductl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">y</span> <span class="keyword1">O</span> <span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">O</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="main">⊆</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> rel_star_contl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> SUP_le_iff rel_dioid.power_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Trace Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Again, the proof that sets of traces form Kleene algebras
follows the same schema.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">t_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'p</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">)</span> trace set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">t_star</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> trace_dioid.power <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> t_star_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> t_star <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> trace_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"t_prod <span class="free">X</span> <span class="main">(</span>t_star <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> t_prod <span class="free">X</span> <span class="main">(</span>trace_dioid.power <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_star_elim t_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> t_star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"t_prod <span class="main">(</span>t_star <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> t_prod <span class="main">(</span>trace_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_star_elim t_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> trace_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted">t_prod</span> <span class="quoted">t_one</span> <span class="quoted">t_zero</span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">t_star</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> trace set"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"t_one <span class="main">∪</span> t_prod <span class="skolem">X</span> <span class="main">(</span>t_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> t_star <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"t_one <span class="main">∪</span> t_prod <span class="skolem">X</span> <span class="main">(</span>t_star <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>trace_dioid.power <span class="skolem">X</span> <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> trace_dioid.power <span class="skolem">X</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> t_star_def t_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> trace_dioid.power <span class="skolem">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_0_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> t_star <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> t_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> t_prod <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> t_prod <span class="main">(</span>t_star <span class="skolem">X</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV t_star_contr SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> trace_dioid.power_inductl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> t_prod <span class="skolem">Y</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> t_prod <span class="skolem">Z</span> <span class="main">(</span>t_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV t_star_contl SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> trace_dioid.power_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Path Kleene Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We start with paths that include the empty path.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">p_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path set <span class="main">⇒</span> <span class="tfree">'a</span> path set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">p_star</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> path_dioid.power <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_star_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> p_star <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> path_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> p_star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"p_prod <span class="free">X</span> <span class="main">(</span>p_star <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> p_prod <span class="free">X</span> <span class="main">(</span>path_dioid.power <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_prod_def p_star_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_star_elim<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_star_elim<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> p_star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"p_prod <span class="main">(</span>p_star <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> p_prod <span class="main">(</span>path_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_prod_def p_star_elim<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_fusion.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> p_star_elim<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> p_star_elim<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">interpretation</span></span> path_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted">p_prod</span> <span class="quoted">p_one</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">p_star</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> path set"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"p_one <span class="main">∪</span> p_prod <span class="skolem">X</span> <span class="main">(</span>p_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> p_star <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"p_one <span class="main">∪</span> p_prod <span class="skolem">X</span> <span class="main">(</span>p_star <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>path_dioid.power <span class="skolem">X</span> <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> path_dioid.power <span class="skolem">X</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p_star_def p_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> path_dioid.power <span class="skolem">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_0_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> p_star <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> p_prod <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> p_prod <span class="main">(</span>p_star <span class="skolem">X</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV p_star_contr SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> path_dioid.power_inductl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> p_prod <span class="skolem">Y</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> p_prod <span class="skolem">Z</span> <span class="main">(</span>p_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV p_star_contl SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> path_dioid.power_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now consider a notion of paths that does not include the
empty path.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pp_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath set <span class="main">⇒</span> <span class="tfree">'a</span> ppath set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pp_star</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> ppath_dioid.power <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pp_star_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pp_star <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="free">x</span> <span class="main">∈</span> ppath_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_star_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_star_contl<span class="main">:</span> <span class="quoted"><span class="quoted">"pp_prod <span class="free">X</span> <span class="main">(</span>pp_star <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> pp_prod <span class="free">X</span> <span class="main">(</span>ppath_dioid.power <span class="free">Y</span> <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def pp_star_elim<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pp_star_contr<span class="main">:</span> <span class="quoted"><span class="quoted">"pp_prod <span class="main">(</span>pp_star <span class="free">X</span><span class="main">)</span> <span class="free">Y</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> pp_prod <span class="main">(</span>ppath_dioid.power <span class="free">X</span> <span class="bound">n</span><span class="main">)</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_prod_def pp_star_elim<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> ppath_kleene_algebra<span class="main">:</span> kleene_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted">pp_prod</span> <span class="quoted">pp_one</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">pp_star</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">Z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> ppath set"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"pp_one <span class="main">∪</span> pp_prod <span class="skolem">X</span> <span class="main">(</span>pp_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> pp_star <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pp_one <span class="main">∪</span> pp_prod <span class="skolem">X</span> <span class="main">(</span>pp_star <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>ppath_dioid.power <span class="skolem">X</span> <span class="main">0</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> ppath_dioid.power <span class="skolem">X</span> <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pp_star_def pp_prod_def<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">n</span><span class="main">.</span> ppath_dioid.power <span class="skolem">X</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_0_Suc<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> pp_star <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> pp_star_def<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> pp_prod <span class="skolem">X</span> <span class="skolem">Y</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> pp_prod <span class="main">(</span>pp_star <span class="skolem">X</span><span class="main">)</span> <span class="skolem">Z</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV pp_star_contr SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ppath_dioid.power_inductl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">∪</span> pp_prod <span class="skolem">Y</span> <span class="skolem">X</span> <span class="main">⊆</span> <span class="skolem">Y</span> <span class="main">⟹</span> pp_prod <span class="skolem">Z</span> <span class="main">(</span>pp_star <span class="skolem">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> ball_UNIV pp_star_contl SUP_le_iff<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> ppath_dioid.power_inductr<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Distributive Lattice Kleene Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the case of bounded distributive lattices, the star maps
all elements to to the maximal element.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> bounded_distributive_lattice<span class="main">)</span> <span class="entity">bdl_star</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bdl_star</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> top"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> bounded_distributive_lattice <span class="main">⊆</span> kleene_algebra <span class="quoted">sup</span> <span class="quoted">inf</span> <span class="quoted">top</span> <span class="quoted">bot</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">bdl_star</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup top <span class="main">(</span>inf <span class="skolem">x</span> <span class="main">(</span>bdl_star <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> bdl_star <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdl_star_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="skolem">z</span> <span class="main">(</span>inf <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> inf <span class="main">(</span>bdl_star <span class="skolem">x</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdl_star_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="skolem">z</span> <span class="main">(</span>inf <span class="skolem">y</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> inf <span class="skolem">z</span> <span class="main">(</span>bdl_star <span class="skolem">x</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdl_star_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Min-Plus Kleene Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹One cannot define a Kleene star for max-plus and min-plus
algebras that range over the real numbers. Here we define the star for
a min-plus algebra restricted to natural numbers and~$+\infty$. The
resulting Kleene algebra is commutative. Similar variants can be
obtained for max-plus algebras and other algebras ranging over the
positive or negative integers.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> pnat <span class="main">::</span> <span class="quoted">commutative_kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">star_pnat</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≡</span> <span class="main">(</span><span class="main">1</span><span class="main">::</span>pnat<span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted">pnat</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_pnat_def zero_pnat_top<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">z</span> <span class="main">⋅</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_pnat_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⋅</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">⋅</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> times_pnat_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">y</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Omega_Algebra">
<div class="head">
<h1>Theory Omega_Algebra</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Omega Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Omega Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Omega_Algebra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleene_Algebra.html">Kleene_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\emph{Omega algebras}~\cite{cohen00omega} extend Kleene algebras by an
$\omega$-operation that axiomatizes infinite iteration (just like the
Kleene star axiomatizes finite iteration).
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Left Omega Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In this section we consider \emph{left omega algebras}, i.e., omega
algebras based on left Kleene algebras. Surprisingly, we are still
looking for statements mentioning~$\omega$ that are true in omega
algebras, but do not already hold in left omega algebras.
›</span></span>

<span class="keyword1"><span class="command">class</span></span> left_omega_algebra <span class="main">=</span> left_kleene_algebra_zero <span class="main">+</span> omega_op <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> omega_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> omega_coinduct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we prove some variants of the coinduction axiom.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_coinduct_var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.omega_coinduct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span>  omega_coinduct_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_zero_l annir omega_coinduct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_coinduct_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.omega_coinduct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_coinduct_eq_var1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_coinduct_var1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  omega_coinduct_eq_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_coinduct_var2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "2-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "3-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "2-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we strengthen the unfold law to an equation.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_unfold_eq <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mult_isol local.omega_unfold mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc omega_coinduct_var2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> omega_unfold<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_unfold_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.omega_coinduct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "4-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now prove subdistributivity and isotonicity of omega.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_subdist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> omega_coinduct_var2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_eq_def omega_subdist<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_subdist_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_iso<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> zero_omega <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil omega_unfold_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is another variant of omega unfold›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_omega_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.star_inductl_var_eq2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma says that~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">1</span></span><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is the maximal element
of omega algebra. We therefore baptise it~$\top$.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> max_element<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">1</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_coinduct_eq_var2<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">top</span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊤</span></span> <span class="main">=</span> <span class="main">1</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_omega_3 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_iso top_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.order.antisym max_element top_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemma is strange since it is counterintuitive
that one should be able to append something after an infinite
iteration.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc omega_coinduct_var2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="comment1">(*nitpick [expect=genuine] -- "2-element counterexample"*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_sup_id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.eq_iff local.mult_isol omega_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_top <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">⊤</span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> max_element omega_sup_id top_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> supid_omega<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.order.antisym max_element omega_iso top_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">⊤</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "4-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove a simulation law for the omega operation›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_simulation<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> hyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> hyp local.mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc omega_coinduct_var2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "4-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>  <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "2-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>  <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "4-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove transitivity of omega elements.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_omega<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> omega_1 omega_unfold_eq<span class="main">)</span>

<span class="comment1">(*
lemma "x<span class="hidden">⇧</span><sup>ω</sup> ⋅ x<span class="hidden">⇧</span><sup>ω</sup> = x<span class="hidden">⇧</span><sup>ω</sup>"
nitpick -- "no proof, no counterexample"

lemma "(x<span class="hidden">⇧</span><sup>ω</sup>)<span class="hidden">⇧</span><sup>ω</sup> = x<span class="hidden">⇧</span><sup>ω</sup>"
nitpick -- "no proof, no counterexample"
*)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are axioms of Wagner's complete axiomatisation
for omega-regular languages~\cite{Wagner77omega}, but in a slightly
different setting.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc omega_unfold_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.star_slide_var mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation omega_coinduct_eq_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
   <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc omega_coinduct_eq_var2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_2_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc omega_simulation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wagner_2_var<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_isol wagner_2_var<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This identity is called~(A8) in Wagner's paper.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_3<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms local.join.sup_commute omega_coinduct_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms local.join.sup_commute local.star_inductl_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_subdist<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This identity is called~(R4) in Wagner's paper.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_1_var <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.star_slide_var<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_omega_4 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">⊤</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_sup_id<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> star_omega_5 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> omega_1<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_sup_id<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next law shows how omegas below a sum can be unfolded.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_sum_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_right omega_unfold_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc wagner_3<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The next two lemmas apply induction and coinduction to this law.
›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_sum_unfold_coind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_coinduct_eq omega_sum_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_sum_unfold_ind<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.star_inductl_eq omega_sum_unfold<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_1_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.join.le_sup_iff local.join.sup.cobounded1 local.mult_isol_var local.star_subdist_var omega_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wagner_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> wagner_1_var_gen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute mult_isol wagner_1_gen<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.mult_isor local.star_subdist <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation order_trans star_omega_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma is a variant of the denest law for the star at
the level of omega.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_denest <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> omega_sum_unfold_coind<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span>  <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wagner_1_var_gen<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> omega_sum_unfold_ind<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wagner_1_var_gen<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemma yields a separation theorem for infinite
iteration in the presence of a quasicommutation property. A
nondeterministic loop over~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> can be refined into
separate infinite loops over~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">y</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_sum_refine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms local.quasicomm_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute omega_sum_unfold<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a local.join.sup_mono local.mult_isol_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.eq_refl local.join.sup_commute mult_assoc star_omega_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute local.omega_coinduct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.join.sup.cobounded2 local.join.sup.mono local.mult_isol_var local.star_subdist omega_iso omega_subdist <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.join.sup_idem star_omega_1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following theorem by Bachmair and
Dershowitz~\cite{bachmair86commutation} is a corollary.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bachmair_dershowitz<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">y</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute assms local.annir local.join.le_bot local.no_trivial_inverse omega_subdist omega_sum_refine<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The next lemmas consider an abstract variant of the empty word
property from language theory and match it with the absence of
infinite iteration~\cite{struth12regeq}.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zero<span class="main">)</span> <span class="entity">ewp</span>
<span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ewp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">¬</span><span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ewp_super_id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> ewp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ewp_def mult_oner<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟷</span> ewp <span class="free">x</span>"</span></span>
  <span class="comment1">(* nitpick [expect=genuine] -- "3-element counterexample" *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next facts relate the absence of the empty word property
with the absence of infinite iteration.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ewp_neg_and_omega<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ewp <span class="free">x</span> <span class="main">⟷</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ewp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ewp_def<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.join.le_bot local.omega_coinduct_var2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ewp <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> ewp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ewp_alt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_comm less_eq_def omega_coinduct omega_unfold_eq order_prop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ewp_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">+</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annir antisym ewp_alt1 join.bot_least<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹So we have obtained a condition for Arden's lemma in omega
algebra.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_super_id1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="main">1</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ewp_neg_and_omega ewp_super_id1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_super_id2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≠</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span><span class="main">(</span><span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> omega_super_id1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next lemmas are abstract versions of Arden's lemma from
language theory.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ardens_lemma_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.omega_coinduct_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> local.eq_iff local.star_inductl_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ardens_lemma<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ewp <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ardens_lemma_var ewp_neg_and_omega<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ardens_lemma_equiv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ewp <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ardens_lemma_var assms ewp_neg_and_omega local.conway.dagger_unfoldl_distr mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ardens_lemma_var_equiv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ardens_lemma_equiv ewp_neg_and_omega<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arden_conv1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">¬</span> ewp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_zero_l annir ewp_neg_and_omega omega_unfold_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> arden_conv2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arden_conv1 ewp_neg_and_omega <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> arden_var3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x</span><span class="keyword1"><span class="hidden">⇧</span><sup>ω</sup></span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arden_conv2 ardens_lemma_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Omega Algebras›</span></span>

<span class="keyword1"><span class="command">class</span></span> omega_algebra <span class="main">=</span> kleene_algebra <span class="main">+</span> left_omega_algebra

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Omega_Algebra_Models">
<div class="head">
<h1>Theory Omega_Algebra_Models</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models of Omega Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Omega_Algebra_Models
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Omega_Algebra.html">Omega_Algebra</a> <a href="Kleene_Algebra_Models.html">Kleene_Algebra_Models</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The trace, path and language model are not really interesting
in this setting.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relation Omega Algebras›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the relational model, the omega of a relation relates all
those elements in the domain of the relation, from which an infinite
chain starts, with all other elements; all other elements are not
related to anything~\cite{hofnerstruth10nontermination}. Thus, the
omega of a relation is most naturally defined coinductively.›</span></span>

<span class="keyword1"><span class="command">coinductive_set</span></span> <span class="entity">omega</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'a</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">;</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">omega</span> <span class="free">R</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">omega</span> <span class="free">R</span>"</span></span>

<span class="comment1">(* FIXME: The equivalent, but perhaps more elegant point-free version
  "x ∈ R O omega R ⟹ x ∈ omega R"
fails due to missing monotonicity lemmas. *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Isabelle automatically derives a case rule and a coinduction
theorem for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> omega<span class="antiquote"><span class="antiquote">}</span></span></span></span>. We prove slightly more elegant
variants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> omega_cases<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> omega <span class="free">R</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> omega <span class="free">R</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> omega.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_coinduct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="main">(</span><span class="free">X</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">∈</span> omega <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> omega <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> omega.coinduct<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> omega_weak_coinduct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="free">X</span> <span class="bound">x</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">X</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> omega <span class="free">R</span>"</span></span> 
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> omega.coinduct<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_omega_algebra<span class="main">:</span> omega_algebra <span class="quoted"><span class="quoted">"<span class="main">(∪)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(O)</span>"</span></span> <span class="quoted">Id</span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊆)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(⊂)</span>"</span></span> <span class="quoted">rtrancl</span> <span class="quoted">omega</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"omega <span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">x</span> <span class="keyword1">O</span> omega <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> omega_cases<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> rel"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊆</span> <span class="skolem">z</span> <span class="main">∪</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> omega <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> omega_weak_coinduct<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">a</span></span> <span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">.</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∈</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword1"><span class="keyword1">O</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">a</span></span><span class="main"><span class="main">,</span></span><span class="bound"><span class="bound">b</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">∉</span></span> <span class="skolem"><span class="skolem">x</span></span><span class="main"><span class="main"><span class="hidden">⇧</span><sup>*</sup></span></span> <span class="keyword1"><span class="keyword1">O</span></span> <span class="skolem"><span class="skolem">z</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="quoted">"1"</span> <span class="quoted">"2"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">c</span>
      <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"*"</span> <span class="quoted">"1"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1"</span> <span class="quoted">"2"</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> relcomp.cases relcomp.intros converse_rtrancl_into_rtrancl<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">x</span> <span class="keyword1">O</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="skolem">c</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊆</span> omega <span class="skolem">x</span> <span class="main">∪</span> <span class="skolem">x</span><span class="main"><span class="hidden">⇧</span><sup>*</sup></span> <span class="keyword1">O</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="DRA">
<div class="head">
<h1>Theory DRA</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Demonic refinement algebra
   Author:     Alasdair Armstrong, Victor B. F. Gomes, Georg Struth
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Demonic Refinement Algebras›</span></span>

<span class="keyword1"><span class="command">theory</span></span> DRA
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleene_Algebra.html">Kleene_Algebra</a> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A demonic refinement algebra *DRA)~\cite{vonwright04refinement} is a Kleene algebra without right annihilation plus 
  an operation for possibly infinite iteration.
›</span></span>
<span class="keyword1"><span class="command">class</span></span> dra <span class="main">=</span> kleene_algebra_zerol <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">strong_iteration</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1"><span class="keyword1"><span class="keyword1"><span class="hidden">⇧</span><sup>∞</sup></span></span></span>"</span> <span class="main">[</span>101<span class="main">]</span> 100<span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> iteration_unfoldl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span> <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>∞</sup></span></span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> coinduction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> isolation <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>∞</sup></span></span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">⇧</span><sup>∞</sup></span></span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹$\top$ is an abort statement, defined as an infinite skip. It is the maximal element of any DRA.›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">top_elem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊤</span></span> <span class="main">≡</span> <span class="main">1</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Simple/basic lemmas about the iteration operator›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.iteration_unfoldl local.order_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_1l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> local.iteration_unfoldl local.join.sup.cobounded2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> top_ref<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">⊤</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> local.coinduction <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> it_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iteration_refl local.mult_isol <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> local.isolation local.join.sup.coboundedI1 local.star_ext<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> it_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> top_mult_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.coinduction local.order.antisym top_ref<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> top_add_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊤</span> <span class="main">+</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.join.sup.absorb1 top_ref<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> top_elim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.mult_isol top_ref<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldl_distl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_left mult.assoc mult_oner iteration_unfoldl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldl_distr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_right' mult_1_left iteration_unfoldl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldl' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_unfoldl_distl local.distrib_right<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assoc iteration_unfoldl_distr local.eq_refl local.iteration_unfoldl local.subdistl_eq mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.coinduction mult_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span>  <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> local.coinduction <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_induct<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> local.distrib_left local.iteration_unfoldl local.mult_oner<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.coinduction<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_ref_star<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.star_inductl_one<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_subdist<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assoc' distrib_right' mult_oner coinduction join.sup_ge1 iteration_unfoldl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iteration_subdist local.order_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
 
<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_0_left annil eq_refl isolation mult.assoc iteration_idem iteration_unfoldl iteration_unfoldl_distr star_denest star_one star_prod_unfold star_slide tc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldr_distl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_left mult.assoc mult_oner iteration_unfoldr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldr_distr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y</span> <span class="main">+</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_unfoldl_distr iteration_unfoldr_distl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_unfold_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_unfoldl_distr iteration_unfoldr_distl<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> iteration_unfoldr' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> distrib_left mult.assoc iteration_unfoldr_distr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_double <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_iso iteration_refl local.eq_iff top_ref<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_iteration <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_iso local.eq_iff top_ref<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_star <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> iteration_idem iteration_refl local.star_inductr_var_eq2 local.sup_id_star1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_star2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> it_ext iteration_induct iteration_star local.bubble_sort local.join.sup.absorb1<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> iteration_star local.star_denest_var_4 mult_assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">)</span></span> iteration_star local.star_denest_var_4 local.star_denest_var_8<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_zero <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_zeror annil iteration_unfoldl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil iteration_unfoldl mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_subdenest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute iteration_idem iteration_subdist local.mult_isol_var<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> sup_id_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">⊤</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> local.eq_iff local.mult_isol_var top_ref <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_top <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">⊤</span> <span class="main">=</span> <span class="main">⊤</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_refl sup_id_top<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we prove some simulation laws for data refinement.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sim<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">z</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">+</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms add.commute add_iso mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.coinduction mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick gives a counterexample to the dual simulation law.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next, we prove some sliding laws.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_slide_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_sim mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_prod_unfold <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> iteration_slide_var local.join.sup_mono local.mult_isor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span>  <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">1</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_sim local.eq_refl local.join.sup.mono local.mult_isol mult_assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_slide<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_prod_unfold iteration_unfoldl_distr distrib_left mult_1_right mult.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> star_iteration_slide <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_star2 local.conway.dagger_unfoldl_distr local.join.sup.orderE local.mult_isor local.star_invol local.star_subdist local.star_trans_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following laws are called denesting laws.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sub_denest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute distrib_right' iteration_unfoldl<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assoc' join.sup_least join.sup_ge1 join.sup_ge2 coinduction<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_iso mult.assoc mult_isol add.commute coinduction mult_oner mult_isol<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> local.order_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_denest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute iteration_unfoldl_distr add_assoc' add.commute iteration_unfoldl order_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute iteration_sub_denest order.antisym coinduction distrib_right' iteration_sub_denest mult.assoc mult_oner order.antisym<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
<span class="comment1">(*
end

sublocale dra ⊆ conway_zerol strong_iteration 
  apply (unfold_locales)
  apply (simp add: iteration_denest iteration_slide)
  apply simp
  by (simp add: iteration_sim)


context dra
begin
*)</span>
<span class="keyword1"><span class="command">lemma</span></span> iteration_denest2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute iteration_denest iteration_slide iteration_unfoldl_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> isolation mult.assoc distrib_right' annil mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.assoc distrib_left mult_1_right add_0_left mult_1_right<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute iteration_denest iteration_slide mult.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_denest3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iteration_iso iteration_ref_star local.mult_isor<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_denest iteration_slide local.join.sup_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_denest2 local.join.sup_commute<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.coinduction<span class="main">)</span> 
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we prove separation laws for reasoning about distributed systems in the context of action systems.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span><span class="main">⋅</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_sim1 add.commute mult_isol order_trans star_subdist<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor mult.assoc iteration_star2 join.sup.mono eq_refl<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_denest2 add.commute coinduction add.commute less_eq_def iteration_subdenest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sim2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute iteration_sep iteration_subdenest<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sep2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span> 
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_isor iteration_sim star_denest_var_2 star_sim1 star_slide_var star_trans_eq tc_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_refl mult.assoc iteration_star2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor mult_onel star_ref<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> antisym iteration_denest3 iteration_subdenest order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sep3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_sim1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_iso mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc iteration_denest2 iteration_star2 add.commute coinduction<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute less_eq_def iteration_subdenest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_sep4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor star_1l mult_oner order_trans star_plus_one subdistl<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> join.bot_least assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> independence1 mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> distrib_left mult.assoc add_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_ref join.sup.mono eq_refl mult_1_left mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>  <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_iso<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add_idem' add.left_commute distrib_right<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> star_ref join.sup.mono eq_refl mult_1_left mult_isor iteration_iso<span class="main">)</span>  
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_commute calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> iteration_sep2 local.add_left_comm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">z</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> iteration_sep mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="free">z</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute mult.assoc iteration_denest3<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute add.left_commute less_eq_def iteration_subdenest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we prove some blocking laws.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick refutes the next lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="comment1">(*nitpick*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">lemma</span></span> iteration_idep<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_zeror annil iteration_unfoldl_distl<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick refutes the next lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">+</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span> <span class="free">x</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
<span class="comment1">(*nitpick [expect=genuine]*)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹At the end of this file, we consider a data refinement example from von Wright~\cite{Wright02}.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> data_refinement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">e'</span> <span class="main">≤</span> <span class="free">e</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">a'</span> <span class="main">≤</span> <span class="free">a</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">z</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">=</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e'</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> star_inductr_var<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">a'</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="main">(</span><span class="free">a</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mult.assoc mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span>  <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_isol order_trans iteration_sim mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">+</span> <span class="free">b</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e'</span> <span class="main">≤</span> <span class="free">s'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> eq_refl iteration_denest mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="free">z</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_isol mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">e'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">a'</span> <span class="main">⋅</span> <span class="free">b</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">≤</span>  <span class="free">a</span><span class="main"><span class="hidden">⇧</span><sup>∞</sup></span> <span class="main">⋅</span> <span class="free">z</span>›</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult.assoc mult_isol mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mult.assoc mult_isol mult.assoc mult_isol order_trans<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PHL_KA">
<div class="head">
<h1>Theory PHL_KA</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Generalised Hoare Logic for Kleene Algebra
   Author:     Georg Struth
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Propositional Hoare Logic for Conway and Kleene Algebra›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PHL_KA
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Kleene_Algebra.html">Kleene_Algebra</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(**********************************************************)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This is a minimalist Hoare logic developed in the context of pre-dioids. In near-dioids, the sequencing rule would not be derivable.
 Iteration is modelled by a function that needs to satisfy a simulation law. 

The main assumtions on pre-dioid elements needed to derive the Hoare rules are preservation properties; an additional distributivity propery is needed
for the conditional rule. 

This Hoare logic can be instantated in various ways. It covers notions of 
finite and possibly infinite iteration. In this theory, it it specialised to Conway and Kleene algebras.›</span></span>

<span class="keyword1"><span class="command">class</span></span> it_pre_dioid <span class="main">=</span> pre_dioid_one <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">it</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> it_simr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">it</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">it</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> phl_while<span class="main">:</span>  
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="main">(</span>it <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span>  <span class="main">≤</span> it <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> mult.assoc phl_export1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> it <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> it <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> it_simr mult.assoc<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> phl_export2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define a Hoare triple to make the format of the rules more explicit.›</span></span>

<span class="keyword1"><span class="command">context</span></span> pre_dioid_one
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> near_dioid<span class="main">)</span> <span class="entity">ht</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>_<span class="keyword1">⦃</span>_<span class="keyword1">⦄</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">⦃</span></span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main"><span class="free">⦄</span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span> 

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_skip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span> <span class="main">1</span> <span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  
<span class="keyword1"><span class="command">lemma</span></span> ht_phl_cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">w</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_cons1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_cons2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">w</span><span class="main">⦄</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_cons2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">p</span><span class="main">⦄</span> <span class="free">x</span> <span class="main">⦃</span><span class="free">r</span><span class="main">⦄</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">r</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">q</span><span class="main">⦄</span> <span class="main">⟹</span> <span class="main">⦃</span><span class="free">p</span><span class="main">⦄</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">q</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_seq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_cond<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span> <span class="main">≤</span> <span class="free">v</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span> 
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">≤</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">u</span> <span class="main">⋅</span> <span class="bound">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">v</span><span class="main">⦄</span> <span class="free">x</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">u</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span>"</span></span> 
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">u</span><span class="main">⦄</span> <span class="main">(</span><span class="free">v</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">+</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_cond<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span>  ht_phl_export1<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">⦄</span> <span class="free">z</span> <span class="main">⦃</span><span class="free">w</span><span class="main">⦄</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⦃</span><span class="free">w</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_export1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_export2<span class="main">:</span> 
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⦃</span><span class="free">z</span><span class="main">⦄</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">x</span><span class="main">⦄</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⦃</span><span class="free">z</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_export2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> it_pre_dioid <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ht_phl_while<span class="main">:</span>  
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⋅</span> <span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span>"</span></span>
<span class="keyword2"><span class="keyword">and</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">p</span> <span class="main">⋅</span> <span class="free">s</span><span class="main">⦄</span> <span class="free">x</span> <span class="main">⦃</span><span class="free">p</span><span class="main">⦄</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⦃</span><span class="free">p</span><span class="main">⦄</span> it <span class="main">(</span><span class="free">s</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">w</span> <span class="main">⦃</span><span class="free">p</span> <span class="main">⋅</span> <span class="free">w</span><span class="main">⦄</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> phl_while<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> pre_conway <span class="main">&lt;</span> phl<span class="main">:</span> it_pre_dioid <span class="keyword2"><span class="keyword">where</span></span> it <span class="main">=</span> <span class="quoted">dagger</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.dagger_simr<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> kleene_algebra <span class="main">&lt;</span> phl<span class="main">:</span> it_pre_dioid <span class="keyword2"><span class="keyword">where</span></span> it <span class="main">=</span> <span class="quoted">star</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PHL_DRA">
<div class="head">
<h1>Theory PHL_DRA</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      General Hoare Logic for Demonic Refinement Algebra
   Author:     Georg Struth
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Propositional Hoare Logic for Demonic Refinement Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section the generic iteration operator is instantiated to the strong iteration operator of 
demonic refinement algebra that models possibly infinite iteration.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PHL_DRA
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="DRA.html">DRA</a> <a href="PHL_KA.html">PHL_KA</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> dra <span class="main">&lt;</span> total_phl<span class="main">:</span> it_pre_dioid <span class="keyword2"><span class="keyword">where</span></span> it <span class="main">=</span> <span class="quoted">strong_iteration</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> local.iteration_sim<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Finite_Suprema">
<div class="head">
<h1>Theory Finite_Suprema</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Finite Suprema
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite Suprema›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Finite_Suprema
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Dioid.html">Dioid</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This file contains an adaptation of Isabelle's library for
finite sums to the case of (join) semilattices and dioids. In this
setting, addition is idempotent; finite sums are finite suprema.

We add some basic properties of finite suprema for (join) semilattices
and dioids.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Lemmas›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fun_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">a</span> <span class="main">|</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> fset_to_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cart_flip_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">|</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> cart_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">B</span> <span class="main">×</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> cart_flip_aux fset_to_im<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fprod_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Suprema in Semilattices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The first lemma shows that, in the context of semilattices,
finite sums satisfy the defining property of finite suprema.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="free">A</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">z</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">{}</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="main">{}</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xnF<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> <span class="skolem">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="skolem">F</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">∑</span><span class="skolem">F</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finF sum.insert xnF<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">∑</span><span class="skolem">F</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>lifting<span class="main"><span class="main">)</span></span> indhyp<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This immediately implies some variants.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_less_eqI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero<span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">atomize</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">full</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> finite_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_less_eqE<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> sum <span class="free">f</span> <span class="free">A</span> <span class="main">≤</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">;</span> finite <span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero<span class="main">)</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> rev_mp<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">erule</span> finite_induct<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_image_sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_sup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">a</span> <span class="main">|</span> <span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im assms sum_fun_image_sup<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_intro<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∃</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≤</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∑</span><span class="free">A</span> <span class="main">≤</span> <span class="main">∑</span><span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms order_refl order_trans sum_sup<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we prove an additivity property for suprema.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_union<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="free">A</span> <span class="main">+</span> <span class="main">∑</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∑</span><span class="free">A</span> <span class="main">+</span> <span class="main">∑</span><span class="free">B</span> <span class="main">≤</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_sup<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It follows that the sum (supremum) of a two-element set is the
join of its elements.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_bin<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero<span class="main">)</span><span class="main">,</span><span class="free">y</span><span class="main">}</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> insert_is_Un<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> sum_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that finite suprema are order preserving.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟶</span> <span class="main">∑</span> <span class="free">A</span> <span class="main">≤</span> <span class="main">∑</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms finite_subset order_refl rev_subsetD sum_sup<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following lemmas state unfold properties for suprema and
finite sets. They are subtly different from the non-idempotent case,
where additional side conditions are required.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_insert <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">+</span> <span class="main">∑</span><span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">+</span> <span class="main">∑</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> insert_is_Un assms finite.emptyI finite.insertI sum_union<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span> <span class="main">+</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we show that set comprehensions with nested suprema can
be flattened.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten1_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">z</span> <span class="main">⟷</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms finite_cartesian_product sum_fun_image_sup<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> flatten2_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∑</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">×</span> <span class="free">B</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> flatten1_im assms cart_flip<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_flatten1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">B</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_to_im assms flatten1_im<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset_to_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_flatten2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fset_to_im assms flatten2_im<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> fset_to_im<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show another additivity property for suprema.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_sum<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">∑</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span><span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">+</span> <span class="main">∑</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_fun_image_sup<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The last lemma of this section prepares the distributivity
  laws that hold for dioids. It states that a strict additive function
  distributes over finite suprema, which is a continuity property in
  the finite.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fstrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fadd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">+</span> <span class="free">f</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fstrict image_empty sum.empty<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span>  <span class="skolem">F</span> <span class="main">::</span><span class="quoted"><span class="quoted">" <span class="tfree">'a</span> set"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> finF<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">F</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> indhyp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="skolem">F</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">∑</span><span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum_insert finF<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fadd<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> indhyp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finF sum_fun_insert<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">(</span><span class="main">∑</span><span class="main">(</span>insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> insert <span class="skolem">x</span> <span class="skolem">F</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite Suprema in Dioids›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this section we mainly prove variants of distributivity laws.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_distl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_fun_add assms annir distrib_left Collect_mem_eq fun_im<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span> <span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">∑</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_fun_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> annil<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> distrib_right<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq fun_im<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_distl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Y</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms fun_im image_image sum_distl<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_fun_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms fun_im image_image sum_distr<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_distl_flat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>dioid_one_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="main">∑</span><span class="free">Y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms sum_distl sum_flatten1<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_distr_flat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">Y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">(</span><span class="main">∑</span><span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> assms sum_distr sum_flatten2<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_sum_distl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">X</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distl assms fset_to_im<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_flatten1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_sum_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="bound">y</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero<span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="main">∑</span><span class="free">X</span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distr assms fset_to_im<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_flatten2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_sum_distl_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> finite <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">h</span> <span class="bound">x</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_fun_distl assms fset_to_im<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_sum_distr_fun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> finite <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">h</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span><span class="main">)</span> <span class="main">`</span> <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="free">h</span> <span class="bound">y</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_fun_distr assms fset_to_im<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_dist<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="free">A</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="free">A</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="free">B</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="main">∑</span><span class="free">B</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">B</span><span class="main">}</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sum_flatten1 assms finite_cartesian_product<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> dioid_sum_prod_var<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span> <span class="main">(</span><span class="free">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms sum_dist fprod_aux<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> dioid_sum_prod<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">A</span> <span class="main">::</span> <span class="tfree">'a</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="main">{</span><span class="free">g</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms dioid_sum_prod_var fset_to_im<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> insert <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sum.insert sum_fun_insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_interval_cong<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">⋀</span> <span class="bound">i</span><span class="main">.</span> <span class="main">⟦</span> <span class="free">m</span> <span class="main">≤</span> <span class="bound">i</span><span class="main">;</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">Q</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">P</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">Q</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sum_interval_distl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost sum_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost fset_to_im image_image sum_fun_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span> <span class="bound">i</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fset_to_im image_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost sum_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sum_interval_distr<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost sum_image<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation finite_atLeastAtMost finite_imageI fset_to_im sum_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sum.cong<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">i</span><span class="main">=</span><span class="free">m</span><span class="main">..</span><span class="free">n</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span><span class="main">(</span><span class="bound">i</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> finite_atLeastAtMost sum_image<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are interesting theorems for finite sums in Kleene
algebras; we leave them for future consideration.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Formal_Power_Series">
<div class="head">
<h1>Theory Formal_Power_Series</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Formal Power Series Model of Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Formal Power Series›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Formal_Power_Series
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Finite_Suprema.html">Finite_Suprema</a> <a href="Kleene_Algebra.html">Kleene_Algebra</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Type of Formal Power Series›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Formal powerseries are functions from a free monoid into a
dioid. They have applications in formal language theory, e.g.,
weighted automata. As usual, we represent elements of a free monoid
by lists.

This theory generalises Amine Chaieb's development of formal power
series as functions from natural numbers, which may be found in {\em
HOL/Library/Formal\_Power\_Series.thy}.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fps <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">.</span> True<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> fps_nth Abs_fps
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is often convenient to reason about functions, and transfer
results to formal power series.›</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_fps

<span class="keyword1"><span class="command">declare</span></span> fps_nth_inverse <span class="main">[</span><span class="operator">simp</span><span class="main">]</span>

<span class="keyword1"><span class="command">notation</span></span> fps_nth <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">$</span>"</span> 75<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_fps_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">p</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">q</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_nth_inject <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> fun_eq_iff<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="free">p</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">q</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_eq<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_nth_Abs_fps <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_fps <span class="free">f</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_fps_inverse<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of the Basic Elements~0 and~1 and the Basic
Operations of Addition and Multiplication›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The zero formal power series maps all elements of the monoid
(all lists) to zero.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">zero</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">zero_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_zero_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> zero_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The unit formal power series maps the monoidal unit (the empty
list) to one and all other elements to zero.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted"><span class="quoted">"<span class="main">{</span>one<span class="main">,</span>zero<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">one</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">one_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">[]</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_one_nth_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">$</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> one_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_one_nth_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">$</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> one_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Addition of formal power series is the usual pointwise
addition of functions.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">plus</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">plus_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="bound">n</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_add_nth <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">+</span> <span class="free">g</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> <span class="free">n</span> <span class="main">+</span> <span class="free">g</span> <span class="main">$</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This directly shows that formal power series form a
semilattice with zero.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_add_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>semigroup_add<span class="main">)</span> fps<span class="main">)</span> <span class="main">+</span> <span class="free">g</span><span class="main">)</span> <span class="main">+</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">+</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_add_comm <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>ab_semigroup_add<span class="main">)</span> fps<span class="main">)</span> <span class="main">+</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="main">+</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_add_idem <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>join_semilattice<span class="main">)</span> fps<span class="main">)</span> <span class="main">+</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_zerol <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>monoid_add<span class="main">)</span> fps<span class="main">)</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_zeror <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>monoid_add<span class="main">)</span> fps<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> plus_fps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The product of formal power series is convolution. The product
of two formal powerseries at a list is obtained by splitting the list
into all possible prefix/suffix pairs, taking the product of the first
series applied to the first coordinate and the second series applied
to the second coordinate of each pair, and then adding the results.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted"><span class="quoted">"<span class="main">{</span>comm_monoid_add<span class="main">,</span>times<span class="main">}</span>"</span></span><span class="main">)</span> <span class="quoted">times</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> Abs_fps <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∑</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">$</span> <span class="bound">y</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">$</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">n</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call the set of all prefix/suffix splittings of a
list~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> the \emph{splitset} of~<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">splitset</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splitset</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">q</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Altenatively, splitsets can be defined recursively, which
yields convenient simplification rules in Isabelle.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">splitset_fun</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">splitset_fun</span> <span class="main">[]</span>       <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">splitset_fun</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span>apfst <span class="main">(</span>Cons <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free">splitset_fun</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_consl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"splitset <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> insert <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>apfst <span class="main">(</span>Cons <span class="free">x</span><span class="main">)</span> <span class="main">`</span> splitset <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_def splitset_def<span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_eq_splitset_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"splitset <span class="free">xs</span> <span class="main">=</span> splitset_fun <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_consl<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definition of multiplication is now more precise.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_mult_var<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> splitset <span class="free">n</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def splitset_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_mult_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">$</span> <span class="free">n</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="free">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> splitset <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_mem_eq fps_mult_var fun_im<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we show that splitsets are finite and non-empty.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_fun_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>splitset_fun <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>splitset <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_eq_splitset_fun<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> split_append_finite <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">q</span><span class="main">)</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fold</span> splitset_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">fact</span> splitset_finite<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_fun_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splitset_fun <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_nonempty <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"splitset <span class="free">xs</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_eq_splitset_fun<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now proceed with proving algebraic properties of formal
power series.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_annil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def sum.neutral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_annir <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>comm_monoid_add<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ext times_fps_def sum.neutral<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_distl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>join_semilattice_zero<span class="main">,</span>semiring<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">+</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ext fps_mult_image distrib_left sum_fun_sum<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fps_distr<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>join_semilattice_zero<span class="main">,</span>semiring<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">+</span> <span class="free">g</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_ext fps_mult_image distrib_right sum_fun_sum<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The multiplicative unit laws are surprisingly tedious. For the
proof of the left unit law we use the recursive definition, which we
could as well have based on splitlists instead of splitsets.

However, a right unit law cannot simply be obtained along the lines of
this proofs. The reason is that an alternative recursive definition
that produces a unit with coordinates flipped would be needed. But
this is difficult to obtain without snoc lists. We therefore prove the
right unit law more directly by using properties of suprema.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_onel <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>join_semilattice_zero<span class="main">,</span>monoid_mult<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">1</span> <span class="main">*</span> <span class="free">f</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">n</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_image splitset_eq_splitset_fun image_comp one_fps_def comp_def image_constant_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_oner <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span><span class="main">{</span>join_semilattice_zero<span class="main">,</span>monoid_mult<span class="main">,</span>mult_zero<span class="main">}</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="main">∈</span> splitset <span class="skolem">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="main">1</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_image sum_fun_image_sup<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="skolem">n</span> <span class="main">=</span> <span class="bound">a</span> <span class="main">@</span> <span class="bound">b</span> <span class="main">⟶</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">a</span> <span class="main">*</span> <span class="main">1</span> <span class="main">$</span> <span class="bound">b</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> splitset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">*</span> <span class="main">1</span> <span class="main">$</span> <span class="main">[]</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_fps_def<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="free">f</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="main">1</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="free">f</span> <span class="main">$</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we prove associativity of convolution. This requires
splitting lists into three parts and rearranging these parts in two
different ways into splitsets. This rearrangement is captured by the
following technical lemma.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> splitset_rearrange<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>join_semilattice_zero"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">(</span>fst <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> splitset <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> splitset <span class="free">x</span><span class="main">}</span> <span class="main">=</span>
         <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="main">(</span>fst <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> splitset <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> splitset <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span> <span class="bound">q</span> <span class="bound">r</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">q</span> <span class="main">@</span> <span class="bound">r</span> <span class="main">⟶</span> <span class="free">F</span> <span class="bound">p</span> <span class="bound">q</span> <span class="bound">r</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_image_sup splitset_finite<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="var">?rhs</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_image_sup splitset_finite<span class="main">)</span>
         <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> splitset_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> fps_mult_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>type<span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> fps<span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> splitset <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> splitset <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_image sum_sum_distl_fun mult.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="main">$</span> <span class="main">(</span>fst <span class="bound">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">q</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span> <span class="main">$</span> <span class="main">(</span>snd <span class="bound">p</span><span class="main">)</span> <span class="main">|</span> <span class="bound">q</span><span class="main">.</span> <span class="bound">q</span> <span class="main">∈</span> splitset <span class="main">(</span>fst <span class="bound">p</span><span class="main">)</span><span class="main">}</span> <span class="main">|</span> <span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> splitset <span class="skolem">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> splitset_rearrange<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="main">(</span><span class="free">g</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">*</span> <span class="free">h</span><span class="main">)</span> <span class="main">$</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fps_mult_image sum_sum_distr_fun mult.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Dioid Model of Formal Power Series›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We can now show that formal power series with suitably
defined operations form a dioid. Many of the underlying properties
already hold in weaker settings, where the target algebra is a
semilattice or semiring. We currently ignore this fact.›</span></span>

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> dioid_one_zero<span class="main">)</span> mult_zero
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> annil<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> annir<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">dioid_one_zero</span><span class="main">)</span> <span class="quoted">dioid_one_zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_eq_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_fps</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> fps<span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> fps"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">+</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_add_assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_add_comm<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">*</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> fps_mult_assoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">h</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">*</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">*</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_distr<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">*</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_onel<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">*</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_oner<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_zeror<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">*</span> <span class="skolem">f</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_annil<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">*</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_annir<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">⟷</span> <span class="skolem">f</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> less_eq_fps_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">&lt;</span> <span class="skolem">g</span> <span class="main">⟷</span> <span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">∧</span> <span class="skolem">f</span> <span class="main">≠</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> less_fps_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">=</span> <span class="skolem">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_add_idem<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">+</span> <span class="skolem">h</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fact</span> fps_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword1"><span class="command">lemma</span></span> expand_fps_less_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> fps<span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">f</span> <span class="main">$</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">g</span> <span class="main">$</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_eq less_eq_def less_eq_fps_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Kleene Algebra Model of Formal Power Series›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There are two approaches to define the Kleene star. The first
one defines the star for a certain kind of (so-called proper) formal
power series into a semiring or dioid. The second one, which is more
interesting in the context of our algebraic hierarchy, shows that
formal power series into a Kleene algebra form a Kleene algebra. We
have only formalised the latter approach.›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Sum_splitlist_nonempty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">[]</span> <span class="free">xs</span><span class="main">)</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>join_semilattice_zero<span class="main">)</span> <span class="main">+</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">=</span> <span class="main">[]</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">f</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">|</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="bound">zs</span> <span class="main">∧</span> <span class="bound">ys</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.insert<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> left_kleene_algebra<span class="main">)</span> add_star_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add.commute mult_onel star2 star_one troeger<span class="main">)</span>

<span class="keyword1"><span class="command">declare</span></span> rev_conj_cong<span class="main">[</span><span class="operator">fundef_cong</span><span class="main">]</span>
  <span class="comment1">― ‹required for the function package to prove termination of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">star_fps_rep</span></span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">star_fps_rep</span> <span class="keyword2"><span class="keyword">where</span></span>
  star_fps_rep_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">star_fps_rep</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
<span class="main">|</span> star_fps_rep_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">star_fps_rep</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free">star_fps_rep</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> fps <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span><span class="quoted">kleene_algebra</span><span class="main">)</span> <span class="quoted">kleene_algebra</span>
<span class="keyword2"><span class="keyword">begin</span></span>

  <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We first define the star on functions, where we can use
  Isabelle's package for recursive functions, before lifting the
  definition to the type of formal power series.

  This definition of the star is from an unpublished manuscript by
  Esik and Kuich.›</span></span>

  <span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">star_fps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fps <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> fps"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">star_fps_rep</span> <span class="keyword1"><span class="command">..</span></span>

  <span class="keyword1"><span class="command">lemma</span></span> star_fps_Nil <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_fps_def<span class="main">)</span>

  <span class="keyword1"><span class="command">lemma</span></span> star_fps_Cons <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">$</span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="main">$</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">x</span> <span class="main">#</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">@</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> star_fps_def<span class="main">)</span>

  <span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">h</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> fps"</span></span>  
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">=</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> fps_ext<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">n</span></span><span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_star_eq mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> Sum_splitlist_nonempty<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_star_eq join.sup_commute<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> order_refl<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">⟶</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">f</span> <span class="main">$</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">v</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_less_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">u</span> <span class="main">@</span> <span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_less_eqE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="main">[]</span><span class="main">)</span> <span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">v</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">v</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">$</span> <span class="main">[]</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">$</span> <span class="improper">v</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="improper">v</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> star_inductl_var<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_less_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_less_eq times_fps_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">y</span></span>"</span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span><span class="main">)</span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"2"</span> <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc sum_distr<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">$</span> <span class="main">(</span><span class="improper">a</span> <span class="main">#</span> <span class="improper">list</span> <span class="main">@</span> <span class="improper">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> <span class="quoted">"2"</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mult_isol<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> sum_less_eqI<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">za</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv length_append less_not_refl2 add.commute not_less_eq trans_less_add1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> z<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">$</span> <span class="improper">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> mult_isol<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1"</span> append_Cons append_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">+</span> <span class="skolem">f</span> <span class="main">⋅</span> <span class="skolem">g</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">⟹</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">⋅</span> <span class="skolem">h</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distrib_left join.sup.bounded_iff less_eq_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">⟶</span> <span class="skolem">g</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
      <span class="comment1">― ‹this property is dual to the previous one; the proof is slightly different›</span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">$</span> <span class="bound">v</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="main">(</span><span class="bound">u</span> <span class="main">@</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_less_eq<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">u</span> <span class="main">@</span> <span class="improper">v</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fps_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_less_eqE<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword1"><span class="command">hence</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">u</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="main">(</span><span class="skolem">f</span> <span class="main">$</span> <span class="main">[]</span><span class="main">)</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">u</span>"</span></span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subgoal_tac</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">$</span> <span class="improper">u</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">$</span> <span class="main">[]</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="improper">u</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> star_inductr_var<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_Nil2<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_Collect<span class="main">]</span><span class="main">]</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_less_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> expand_fps_less_eq times_fps_def<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> P<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="skolem">g</span> <span class="main">$</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="improper">z</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">$</span> <span class="main">(</span><span class="bound">y</span> <span class="main">@</span> <span class="improper">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">y</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> allE<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">prefer</span></span></span></span> 2
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct_tac</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="improper"><span class="improper">z</span></span>"</span></span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="quoted">"<span class="improper">xs</span>"</span></span><span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span><span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sum_less_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum_distl<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">$</span> <span class="improper">x</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">$</span> <span class="improper">yb</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="improper">z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"2"</span> mult.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> mult_isor<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule_tac</span> y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">$</span> <span class="main">(</span><span class="improper">x</span> <span class="main">@</span> <span class="improper">yb</span><span class="main">)</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">$</span> <span class="improper">z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> order_trans<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1"</span> mult_isor<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule_tac</span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="improper">z</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> spec<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> mp<span class="main">)</span>
           <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_eq_Cons_conv length_append less_not_refl2 add.commute not_less_eq trans_less_add1<span class="main">)</span>
          <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append_assoc<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">⋅</span> <span class="skolem">f</span> <span class="main">≤</span> <span class="skolem">g</span> <span class="main">⟹</span> <span class="skolem">h</span> <span class="main">⋅</span> <span class="skolem">f</span><span class="main"><span class="hidden">⇧</span><sup>⋆</sup></span> <span class="main">≤</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> distrib_right' join.sup.bounded_iff order_prop<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* instantiation *)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Inf_Matrix">
<div class="head">
<h1>Theory Inf_Matrix</h1>
</div>
<pre class="source"><span class="comment1">(* Title:      Infinite Matrix Model of Kleene Algebra
   Author:     Alasdair Armstrong, Georg Struth, Tjark Weber
   Maintainer: Georg Struth &lt;g.struth at sheffield.ac.uk&gt;
               Tjark Weber &lt;tjark.weber at it.uu.se&gt;
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Infinite Matrices›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Inf_Matrix
<span class="keyword2"><span class="keyword">imports</span></span> <a href="Finite_Suprema.html">Finite_Suprema</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Matrices are functions from two index sets into some suitable
algebra. We consider arbitrary index sets, not necessarily the
positive natural numbers up to some bounds; our coefficient algebra is
a dioid. Our only restriction is that summation in the product of
matrices is over a finite index set. This follows essentially Droste
and Kuich's introductory article in the Handbook of Weighted Automata~\cite{weightedautomata09}.

Under these assumptions we show that dioids are closed under matrix
formation. Our proofs are similar to those for formal power series,
but simpler.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_one</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">ε</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">ε</span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_zero</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">δ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">δ</span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">j</span> <span class="bound">i</span><span class="main">.</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⊕</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>  <span class="main">≡</span> <span class="main">λ</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">i</span> <span class="bound">j</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_add_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊕</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊕</span> <span class="free">h</span> <span class="main">=</span>  <span class="free">f</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊕</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_add_def join.sup_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_add_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊕</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⊕</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_add_def join.sup_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_add_idem<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊕</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_add_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_zerol<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊕</span> <span class="keyword1">δ</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_add_def mat_zero_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_zeror<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">δ</span> <span class="main">⊕</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_add_def mat_zero_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_mult</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'k</span><span class="main">::</span>finite<span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊗</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>  <span class="main">≡</span> <span class="main">∑</span> <span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">k</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">|</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_annil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">δ</span> <span class="main">⊗</span> <span class="free">f</span> <span class="main">=</span> <span class="keyword1">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_zero_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_annir<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊗</span> <span class="keyword1">δ</span>  <span class="main">=</span> <span class="keyword1">δ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_zero_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊕</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊕</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>  <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_add_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_left<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">+</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_sum finite_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊕</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊕</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">h</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⊕</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>  <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">i</span> <span class="bound">k</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_add_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> distrib_right<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">+</span> <span class="main">∑</span><span class="main">{</span><span class="free">g</span> <span class="skolem">i</span> <span class="bound">k</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_sum finite_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⊕</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_add_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> logic_aux1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="free">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">i</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="free">i</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> logic_aux2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">k</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">i</span> <span class="free">j</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> mat_onel<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">ε</span> <span class="main">⊗</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ε</span> <span class="main">⊗</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_one_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq logic_aux1<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">=</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">+</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">≠</span> <span class="bound">k</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">ε</span> <span class="main">⊗</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_oner<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊗</span> <span class="keyword1">ε</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">k</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mat_mult_def mat_one_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Collect_disj_eq logic_aux2<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">=</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">+</span> <span class="main">∑</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">k</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span> <span class="main">≠</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sum_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="keyword1">ε</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sum.neutral<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_rearrange<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">F</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'k1</span> <span class="main">⇒</span> <span class="tfree">'k2</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fUNk1<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k1</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fUNk2<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k2</span> set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="free">i</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="free">j</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k2</span> set<span class="main">)</span><span class="main">}</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> <span class="main">(</span>UNIV<span class="main">::</span><span class="tfree">'k1</span> set<span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="free">i</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="free">j</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?lhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="free">i</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="free">j</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rhs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">F</span> <span class="free">i</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="free">j</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k1</span> <span class="bound">k2</span><span class="main">.</span> <span class="free">F</span> <span class="free">i</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="free">j</span> <span class="main">≤</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_image_sup fUNk1 fUNk2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">≤</span> <span class="skolem">z</span> <span class="main">⟷</span> <span class="var">?rhs</span> <span class="main">≤</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_image_sup fUNk1 fUNk2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> eq_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mat_mult_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">h</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k1</span> <span class="main">⋅</span> <span class="main">∑</span><span class="main">{</span><span class="free">g</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k2</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k1</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k2</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_distl finite_UNIV mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k1</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">k1</span> <span class="bound">k2</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k2</span> <span class="skolem">j</span><span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mat_rearrange<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">∑</span><span class="main">{</span><span class="main">∑</span><span class="main">{</span><span class="free">f</span> <span class="skolem">i</span> <span class="bound">k1</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">k1</span> <span class="bound">k2</span> <span class="main">|</span><span class="bound">k1</span><span class="main">.</span> <span class="bound">k1</span> <span class="main">∈</span> UNIV<span class="main">}</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">k2</span> <span class="skolem">j</span> <span class="main">|</span><span class="bound">k2</span><span class="main">.</span> <span class="bound">k2</span> <span class="main">∈</span> UNIV<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> fset_to_im sum_fun_distr finite_UNIV<span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span>  <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">⊗</span> <span class="free">g</span><span class="main">)</span> <span class="main">⊗</span> <span class="free">h</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">j</span> "</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> mat_mult_def<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_less_eq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mat_less_eq</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>   <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">⊕</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>  <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mat_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">::</span>dioid_one_zero<span class="main">)</span> matrix <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> matrix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mat_less</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>  <span class="main">=</span> <span class="main">(</span>mat_less_eq <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> matrix_dioid<span class="main">:</span> dioid_one_zero  <span class="quoted">mat_add</span> <span class="quoted">mat_mult</span> <span class="quoted">mat_one</span> <span class="quoted">mat_zero</span> <span class="quoted">mat_less_eq</span> <span class="quoted">mat_less</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="main">(</span><span class="operator">metis</span> mat_add_assoc mat_add_comm mat_mult_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mat_distr mat_onel mat_oner mat_zeror mat_annil mat_annir mat_less_eq_def mat_less_def mat_add_idem mat_distl<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹As in the case of formal power series we currently do not
implement the Kleene star of matrices, since this is complicated.›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>